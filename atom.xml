<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="http://blog.cjhe.top/atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN">
  <id>http://blog.cjhe.top/</id>
  <title>个人博客</title>
  <subtitle>何小进童鞋的个人博客</subtitle>
  <updated>2024-08-02T03:15:52.732Z</updated>
  <generator>@vuepress/plugin-feed</generator>
  <link rel="self" href="http://blog.cjhe.top/atom.xml"/>
  <link rel="alternate" href="http://blog.cjhe.top/"/>
  <category term="编程语言"/>
  <category term="数据存储"/>
  <category term="devops"/>
  <category term="转载"/>
  <category term="算法"/>
  <category term="设计模式"/>
  <category term="中间件"/>
  <category term="工具"/>
  <category term="编程框架"/>
  <category term="网络"/>
  <category term="项目规范"/>
  <contributor>
    <name>heroku</name>
  </contributor>
  <contributor>
    <name>Dave Cheney</name>
  </contributor>
  <contributor>
    <name>Rob Pike</name>
  </contributor>
  <entry>
    <title type="text">Docker环境go如何设置maxprocs</title>
    <id>http://blog.cjhe.top/language/go/advance/gomaxprocs.html</id>
    <link href="http://blog.cjhe.top/language/go/advance/gomaxprocs.html"/>
    <updated>2024-07-12T03:25:46.000Z</updated>
    <summary type="text">提示
Go语言使用GMP调度模型，其中P的数量通过GOMAXPROXS设置，默认是机器的CPU核数。


注意
但是由于Docker通过Cgroups做资源限制，存在的诟病：应用程序在容器里读取到的CPU核数是宿主机上的数据而非实际容器分配的数据。


警告
而通常我们在Kubernetes集群使用的宿主机通常是100+核，容器分配的资源是2c4g，这...</summary>
    <content type="html"><![CDATA[<!-- more -->
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>Go语言使用GMP调度模型，其中P的数量通过<code>GOMAXPROXS</code>设置，默认是机器的CPU核数。</p>
</div>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>但是由于Docker通过Cgroups做资源限制，存在的诟病：应用程序在容器里读取到的CPU核数是宿主机上的数据而非实际容器分配的数据。</p>
</div>
<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>而通常我们在Kubernetes集群使用的宿主机通常是100+核，容器分配的资源是2c4g，这就导致Go调度器会根据宿主机的核数设置P的数量，这会因为P数量过多导致不必要的资源争抢，反而降低性能。</p>
</div>
<h2>实验</h2>
<p>为此我们准备一个简单的Go程序和Dockerfile，进行实验验证。</p>
<p>Go程序只打印容器的GOMAXPROCS，其中<code>runtime.GOMAXPROCS(0)</code>，当传值为0时，返回当前的GOMAXPROCS值。</p>
<p>Dockerfile内容如下：</p>
<div class="language-docker" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> golang:1.21-alpine <span class="token keyword">AS</span> builder</span>

<span class="token instruction"><span class="token keyword">ENV</span> GO111MODULE=on</span>
<span class="token instruction"><span class="token keyword">ENV</span> GOPROXY=https://goproxy.cn,direct</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /backend</span>

<span class="token instruction"><span class="token keyword">COPY</span> . /backend</span>

<span class="token instruction"><span class="token keyword">RUN</span> go mod tidy &amp;&amp; go build -o app</span>

<span class="token instruction"><span class="token keyword">FROM</span> alpine:latest</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /backend/app /app/app</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"./app"</span>]</span>
</code></pre></div><h3>未设置maxprocs的场景</h3>
<p>Go程序如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"runtime"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"maxprocs"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>构建镜像:</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> build <span class="token parameter variable">-t</span> cpu-test:v0.1.0 <span class="token builtin class-name">.</span>
</code></pre></div><p>运行镜像:</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--cpus</span><span class="token operator">=</span><span class="token number">1.0</span>  cpu-test:v0.1.0
</code></pre></div><p>这里通过<code>--cpus=1.0</code>限制容器的CPU核数为1。</p>
<p>执行结果：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>maxprocs 20
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>我的本机逻辑处理器有20个，所以结果为20</p>
</div>
<h3>设置maxprocs场景</h3>
<p>这里使用uber公司开源的库来修改maxprocs，Go程序如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"runtime"</span>

	<span class="token boolean">_</span> <span class="token string">"go.uber.org/automaxprocs"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"maxprocs"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>构建镜像:</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> build <span class="token parameter variable">-t</span> cpu-test:v0.1.1 <span class="token builtin class-name">.</span>
</code></pre></div><p>运行镜像：</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--cpus</span><span class="token operator">=</span><span class="token number">1.0</span>  cpu-test:v0.1.1
</code></pre></div><p>执行结果：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>2024/07/11 09:06:55 maxprocs: Updating GOMAXPROCS=1: determined from CPU quota
maxprocs 1
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>我们看到maxprocs已经设置为我们限制的核数，由于引入的<code>automaxprocs</code>库进行初始化，因此多打印了一段信息。</p>
</div>
<h2>参考文献</h2>
<ul>
<li><a href="https://github.com/uber-go/automaxprocs" target="_blank" rel="noopener noreferrer">https://github.com/uber-go/automaxprocs</a></li>
<li><a href="https://blog.csdn.net/NUCEMLS/article/details/132528994" target="_blank" rel="noopener noreferrer">docker容器环境go程序的GOMAXPROCS问题</a></li>
</ul>
]]></content>
    <category term="编程语言"/>
    <published>2024-07-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言内存对齐</title>
    <id>http://blog.cjhe.top/language/go/advance/memory-alignment.html</id>
    <link href="http://blog.cjhe.top/language/go/advance/memory-alignment.html"/>
    <updated>2024-08-02T03:14:38.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>合理的排列数据成员的顺序，使得整个结构体的空间占用最小化。</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>合理的排列数据成员的顺序，使得整个结构体的空间占用最小化。</p>
</blockquote>
<!-- more -->
<h2>什么是内存对齐</h2>
<p>内存对齐是指数据在内存中存储的方式，以优化处理器访问。处理器一次访问一定数量的连续字节（称为“字”），通常为 4 字节或 8 字节。硬件会将内存的读写对齐到数据总线的宽度，从而可以降低硬件实现的复杂度，又可以提升传输的效率。</p>
<h2>为什么有内存对齐</h2>
<ul>
<li>有些CPU可以访问任意地址上的任意数据，而有些CPU只能在特定地址访问数据，因此不同硬件平台具有差异性，这样的代码就不具有移植性，如果在编译时，将分配的内存进行对齐，这就具有平台可以移植性了</li>
<li>CPU每次寻址都是要消费时间的，并且CPU 访问内存时，并不是逐个字节访问，而是以字长（word size）为单位访问，所以数据结构应该尽可能地在自然边界上对齐，如果访问未对齐的内存，处理器需要做两次内存访问，而对齐的内存访问仅需要一次访问，内存对齐后可以提升性能。</li>
</ul>
<h2>对齐规则</h2>
<p>Go语言内存对齐规则参考两方面因素：</p>
<ul>
<li>数据类型自身的大小。如果是复合类型，会参考最大成员的大小</li>
<li>硬件平台机器字长（32位/64位）</li>
</ul>
<p>| 类型 | 32位平台大小 | 32位平台对齐边界 | 64位平台大小 | 64位平台对齐边界 |
|</p>
]]></content>
    <category term="编程语言"/>
    <published>2024-06-22T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go命令</title>
    <id>http://blog.cjhe.top/language/go/base/command.html</id>
    <link href="http://blog.cjhe.top/language/go/base/command.html"/>
    <updated>2024-06-20T09:04:51.000Z</updated>
    <summary type="text">我们可以执行go -h或者go --help查看Go语言命令。
Go语言命令包含了一整套工具链，包括：文档、代码检查、格式化、编译、测试、依赖管理、包管理等。
go bug
go bug命令用于生成一个bug报告模板。该命令会收集你的Go环境和系统的信息，并打开默认浏览器在Go的官方Github创建新的issue。
go build
go build命...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>我们可以执行<code>go -h</code>或者<code>go --help</code>查看Go语言命令。</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go <span class="token parameter variable">-h</span>
</code></pre></div><div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>Go is a tool for managing Go source code.

Usage:

        go &lt;command&gt; [arguments]

The commands are:

        bug         start a bug report
        build       compile packages and dependencies
        clean       remove object files and cached files
        doc         show documentation for package or symbol
        env         print Go environment information
        fix         update packages to use new APIs
        fmt         gofmt (reformat) package sources
        generate    generate Go files by processing source
        get         add dependencies to current module and install them
        install     compile and install packages and dependencies
        list        list packages or modules
        mod         module maintenance
        work        workspace maintenance
        run         compile and run Go program
        test        test packages
        tool        run specified go tool
        version     print Go version
        vet         report likely mistakes in packages
</code></pre></div><p>Go语言命令包含了一整套工具链，包括：文档、代码检查、格式化、编译、测试、依赖管理、包管理等。</p>
<h2>go bug</h2>
<p><code>go bug</code>命令用于生成一个bug报告模板。该命令会收集你的Go环境和系统的信息，并打开默认浏览器在Go的官方Github创建新的issue。</p>
<h2>go build</h2>
<p><code>go build</code>命令用于编译我们指定的源码文件或代码包以及它们的依赖包。</p>
<h3>用法</h3>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go build <span class="token punctuation">[</span>-o output<span class="token punctuation">]</span> <span class="token punctuation">[</span>build flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>packages<span class="token punctuation">]</span>
</code></pre></div><p>-o 用于指定输出二进制文件名称，例如：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>go build -o app-user main.go
</code></pre></div><h2>go clean</h2>
<p><code>go clean</code>会删除掉执行其它命令时产生的一些文件和目录，包括：</p>
<ol>
<li>
<p>在使用<code>go build</code>命令时在当前代码包下生成的与包名同名或者与Go源码文件同名的可执行文件。在Windows下，则是与包名同名或者Go源码文件同名且带有“.exe”后缀的文件。</p>
</li>
<li>
<p>在执行<code>go test</code>命令并加入<code>-c</code>标记时在当前代码包下生成的以包名加“.test”后缀为名的文件。在Windows下，则是以包名加“.test.exe”后缀为名的文件。我们会在后面专门介绍<code>go test</code>命令。</p>
</li>
<li>
<p>如果执行<code>go clean</code>命令时带有标记<code>-i</code>，则会同时删除安装当前代码包时所产生的结果文件。如果当前代码包中只包含库源码文件，则结果文件指的就是在工作区的pkg目录的相应目录下的归档文件。如果当前代码包中只包含一个命令源码文件，则结果文件指的就是在工作区的bin目录下的可执行文件。</p>
</li>
<li>
<p>还有一些目录和文件是在编译Go或C源码文件时留在相应目录中的。包括：“_obj”和“_test”目录，名称为“_testmain.go”、“test.out”、“build.out”或“a.out”的文件，名称以“.5”、“.6”、“.8”、“.a”、“.o”或“.so”为后缀的文件。这些目录和文件是在执行<code>go build</code>命令时生成在临时目录中的。如果你忘记了这个临时目录是怎么回事儿，可以再回顾一下前面关于<code>go build</code>命令的介绍。临时目录的名称以<code>go-build</code>为前缀。</p>
</li>
<li>
<p>如果执行<code>go clean</code>命令时带有标记<code>-r</code>，则还包括当前代码包的所有依赖包的上述目录和文件。</p>
</li>
</ol>
<h2>go doc</h2>
<p><code>go doc</code>命令用于查看Go语言的文档。</p>
<p>比如：查看sync.Map文档，可以使用以下命令：</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go doc sync.Map
</code></pre></div><p>输出结果如下：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>package sync // import "sync"

type Map struct {
        // Has unexported fields.
}
    Map is like a Go map[any]any but is safe for concurrent use by multiple
    goroutines without additional locking or coordination. Loads, stores,
    and deletes run in amortized constant time.

    The Map type is specialized. Most code should use a plain Go map instead,
    with separate locking or coordination, for better type safety and to make it
    easier to maintain other invariants along with the map content.

    The Map type is optimized for two common use cases: (1) when the entry for
    a given key is only ever written once but read many times, as in caches
    that only grow, or (2) when multiple goroutines read, write, and overwrite
    entries for disjoint sets of keys. In these two cases, use of a Map may
    significantly reduce lock contention compared to a Go map paired with a
    separate Mutex or RWMutex.

    The zero Map is empty and ready for use. A Map must not be copied after
    first use.

    In the terminology of the Go memory model, Map arranges that a write
    operation “synchronizes before” any read operation that observes the effect
    of the write, where read and write operations are defined as follows. Load,
    LoadAndDelete, LoadOrStore, Swap, CompareAndSwap, and CompareAndDelete
    are read operations; Delete, LoadAndDelete, Store, and Swap are write
    operations; LoadOrStore is a write operation when it returns loaded set to
    false; CompareAndSwap is a write operation when it returns swapped set to
    true; and CompareAndDelete is a write operation when it returns deleted set
    to true.

func (m *Map) CompareAndDelete(key, old any) (deleted bool)
func (m *Map) CompareAndSwap(key, old, new any) bool
func (m *Map) Delete(key any)
func (m *Map) Load(key any) (value any, ok bool)
func (m *Map) LoadAndDelete(key any) (value any, loaded bool)
func (m *Map) LoadOrStore(key, value any) (actual any, loaded bool)
func (m *Map) Range(f func(key, value any) bool)
func (m *Map) Store(key, value any)
func (m *Map) Swap(key, value any) (previous any, loaded bool)
</code></pre></div><h2>go env</h2>
<p><code>go env</code>用于打印Go语言的环境信息。</p>
<p><strong>Go111Module</strong></p>
<p>Go111Module是Go语言的模块管理功能的开关。它的值可以是off、on或auto。</p>
<p><strong>GOARCH</strong></p>
<p>GOARCH是Go语言的目标架构，例如amd64、386等。</p>
<p><strong>GOBIN</strong></p>
<p>GOBIN是Go语言的可执行文件的输出路径，默认情况下为$GOPATH/bin。</p>
<p><strong>GOCACHE</strong></p>
<p>GOCACHE是Go语言的缓存目录，默认情况下为$HOME/.cache/go-build。</p>
<p><strong>GOENV</strong></p>
<p>GOENV的值是Go语言的环境变量文件。</p>
<p><strong>GOEXE</strong></p>
<p>GOEXE的值会被作为可执行文件的后缀。它的值与GOOS的值存在一定关系，即只有GOOS的值为“windows”时GOEXE的值才会是“.exe”，否则其值就为空字符串“”。这与在各个操作系统下的可执行文件的默认后缀是一致的。</p>
<p><strong>GOFLAGS</strong></p>
<p>GOFLAGS的值是Go语言的编译器参数。</p>
<p><strong>GOHOSTARCH</strong></p>
<p>GOHOSTARCH的值是Go语言的编译环境的目标架构。</p>
<p><strong>GOHOSTOS</strong></p>
<p>GOHOSTOS的值是Go语言的编译环境的目标操作系统。</p>
<p><strong>GOINSECURE</strong></p>
<p>GOINSECURE的值是Go语言的内部安全机制的开关。它的值可以是off、on或auto。</p>
<p><strong>GOMODCACHE</strong></p>
<p>GOMODCACHE的值是Go语言的模块缓存目录，默认情况下为$GOPATH/pkg/mod。</p>
<p><strong>GONOPROXY</strong></p>
<p>GONOPROXY的值是Go语言的私有代理的包路径。</p>
<p><strong>GONOSUMER</strong></p>
<p>GONOSUMER的值是Go语言的私有校验和数据库的包路径。</p>
<p><strong>GOOS</strong></p>
<p>GOOS是Go语言的目标操作系统，例如linux、windows等。</p>
<p><strong>GOPATH</strong></p>
<p>GOPATH是Go语言的工作区目录的绝对路径。我们需要显式的设置环境变量GOPATH。如果有多个工作区，那么多个工作区的绝对路径之间需要用分隔符分隔。在windows操作系统下，这个分隔符为“;”。在其它操作系统下，这个分隔符为“:”。注意，GOPATH的值不能与GOROOT的值相同。</p>
<p><strong>GOPRIVATE</strong></p>
<p>GOPRIVATE的值是Go语言的私有模块的包路径。</p>
<p><strong>GOPROXY</strong></p>
<p>GOPROXY的值是Go语言的代理服务器的地址。</p>
<p><strong>GOROOT</strong></p>
<p>GOROOT的值是Go语言的安装目录的绝对路径。</p>
<p><strong>GOSUMDB</strong></p>
<p>GOSUMDB的值是Go语言的校验和数据库的地址。</p>
<p><strong>GOTMPDIR</strong></p>
<p>GOTMPDIR的值是Go语言的临时文件的输出路径，默认情况下为$GOPATH/pkg/mod。</p>
<p><strong>GOTOOLCHAIN</strong></p>
<p>GOTOOLCHAIN允许您指定要使用的特定工具链版本。</p>
<p><strong>GOTOOLDIR</strong></p>
<p>GOTOOLDIR的值是Go语言的工具目录的绝对路径。</p>
<p><strong>GOVCS</strong></p>
<p>GOVCS的值是Go语言的版本控制系统。</p>
<p><strong>GOVERSION</strong></p>
<p>GOVERSION的值是Go语言的版本号。</p>
<p><strong>GCCGO</strong></p>
<p>GCCGO的值是Go语言的编译器参数。</p>
<p><strong>GOAMD64</strong></p>
<p>GOAMD64的值是Go语言的编译器参数。</p>
<h2>go fix</h2>
<p><code>go fix</code>命令用于自动修复Go代码中的错误。</p>
<h3>语法</h3>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go fix <span class="token punctuation">[</span>build flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>packages<span class="token punctuation">]</span>
</code></pre></div><h3>选项</h3>
<ul>
<li><code>-n</code>：只打印将要进行的修复操作，而不实际执行。</li>
<li><code>-v</code>：打印出每个被修复的文件名。</li>
</ul>
<h2>go fmt</h2>
<p><code>go fmt</code>用于格式化Go代码。</p>
<h3>语法</h3>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go <span class="token function">fmt</span> <span class="token punctuation">[</span>-n<span class="token punctuation">]</span> <span class="token punctuation">[</span>-x<span class="token punctuation">]</span> <span class="token punctuation">[</span>packages<span class="token punctuation">]</span>
</code></pre></div><h3>选项</h3>
<ul>
<li><code>-n</code>: 打印格式化后的代码，但不实际写入文件。</li>
<li><code>-x</code>: 打印格式化后的代码，并添加行号和缩进。</li>
</ul>
<h2>go generate</h2>
<h2>go get</h2>
<p><code>go get</code>可以根据要求和实际情况从互联网上下载或更新指定的代码包及其依赖包，并对它们进行编译和安装</p>
<h2>go install</h2>
<p><code>go install</code>用于编译并安装指定的代码包及它们的依赖包。</p>
<h2>go list</h2>
<p><code>go list</code>命令的作用是列出指定的代码包的信息。</p>
<h2>go mod</h2>
<h2>go run</h2>
<p><code>go run</code>命令用于编译并运行Go程序。</p>
<h2>go test</h2>
<p><code>go test</code>命令用于对Go语言编写的程序进行测试。</p>
<h2>go tool</h2>
<h2>go version</h2>
<p><code>go version</code>命令用于打印当前系统Go语言的版本信息。</p>
<h3>语法</h3>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go version
</code></pre></div><p>输出结果：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>go version go1.22.2 windows/amd64
</code></pre></div><h2>go vet</h2>
<p><code>go vet</code>命令用于检查Go代码中的错误和潜在的性能问题。</p>
<h3>语法</h3>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go vet <span class="token punctuation">[</span>-n<span class="token punctuation">]</span> <span class="token punctuation">[</span>-x<span class="token punctuation">]</span> <span class="token punctuation">[</span>build flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>packages<span class="token punctuation">]</span>
</code></pre></div><h3>选项</h3>
<ul>
<li><code>-n</code>：打印出需要检查的包名，但不执行检查。</li>
<li><code>-x</code>：打印出需要检查的包名和文件名，但不执行检查。</li>
</ul>
]]></content>
    <category term="编程语言"/>
    <published>2024-06-14T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言文章</title>
    <id>http://blog.cjhe.top/language/go/recommend/article.html</id>
    <link href="http://blog.cjhe.top/language/go/recommend/article.html"/>
    <updated>2024-06-12T01:26:48.000Z</updated>
    <summary type="text">Go语言规范
Uber公司Go语言编码规范
Go代码评审常见错误清单
Go包规范
稀土掘进-如何写出优雅的Golang代码
稀土掘进-Go语言实践：编写可维护的程序的建议
Go官方代码审查</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>Go语言规范</h2>
<p><a href="https://github.com/xxjwxc/uber_go_guide_cn" target="_blank" rel="noopener noreferrer">Uber公司Go语言编码规范</a></p>
<p><a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener noreferrer">Go代码评审常见错误清单</a></p>
<p><a href="https://rakyll.org/style-packages/" target="_blank" rel="noopener noreferrer">Go包规范</a></p>
<p>稀土掘进-如何写出优雅的Golang代码<a href="https://juejin.cn/post/6844903976509390856" target="_blank" rel="noopener noreferrer"></a></p>
<p>稀土掘进-Go语言实践：编写可维护的程序的建议<a href="https://juejin.cn/post/6844904035611328520" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go官方代码审查<a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener noreferrer"></a></p>
]]></content>
    <category term="编程语言"/>
    <published>2024-06-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言社区</title>
    <id>http://blog.cjhe.top/language/go/recommend/community.html</id>
    <link href="http://blog.cjhe.top/language/go/recommend/community.html"/>
    <updated>2024-06-12T01:26:48.000Z</updated>
    <summary type="text">Go社区</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>Go社区</h2>
]]></content>
    <category term="编程语言"/>
    <published>2024-06-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言练习</title>
    <id>http://blog.cjhe.top/language/go/recommend/example.html</id>
    <link href="http://blog.cjhe.top/language/go/recommend/example.html"/>
    <updated>2024-06-12T01:26:48.000Z</updated>
    <summary type="text">Go练习</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>Go练习</h2>
]]></content>
    <category term="编程语言"/>
    <published>2024-04-16T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go测试</title>
    <id>http://blog.cjhe.top/language/go/test/</id>
    <link href="http://blog.cjhe.top/language/go/test/"/>
    <updated>2024-06-11T13:34:41.000Z</updated>
    <category term="编程语言"/>
    <published>2024-06-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言MySQL测试</title>
    <id>http://blog.cjhe.top/language/go/test/mysql-test.html</id>
    <link href="http://blog.cjhe.top/language/go/test/mysql-test.html"/>
    <updated>2024-06-12T01:26:48.000Z</updated>
    <summary type="text">Go项目中经常使用MySQL作为存储，一般写测试会建立真实连接进行测试，但带来的问题有很多：

依赖测试数据，如果数据库中某个数据变更导致测试用例失败
依赖数据库环境，如果无法连通将导致测试失败

因此，优秀的项目会杜绝这些问题。本文介绍Go语言的sql/driver的mock库。
安装mock库
官网用例
业务SQL函数
  
相关信息
record...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>Go项目中经常使用MySQL作为存储，一般写测试会建立真实连接进行测试，但带来的问题有很多：</p>
<ul>
<li>依赖测试数据，如果数据库中某个数据变更导致测试用例失败</li>
<li>依赖数据库环境，如果无法连通将导致测试失败</li>
</ul>
<p>因此，优秀的项目会杜绝这些问题。本文介绍Go语言的<code>sql/driver</code>的mock库。</p>
<h2>安装mock库</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>go get github.com/DATA-DOG/go-sqlmock
</code></pre></div><h2>官网用例</h2>
<h3>业务SQL函数</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"database/sql"</span>

	<span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> productID <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"UPDATE products SET views = views + 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO product_viewers (user_id, product_id) VALUES (?, ?)"</span><span class="token punctuation">,</span> userID<span class="token punctuation">,</span> productID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container info">
<p class="hint-container-title">相关信息</p>
<p><code>recordStats</code> 函数负责记录用户浏览产品信息，包括：</p>
<ul>
<li>更新商品的 views 个数+1</li>
<li>插入一条用户浏览商品数据到 product_viewers 表</li>
</ul>
<p>以上两个操作在同一个事物中执行</p>
</div>
<h3>成功的测试用例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestShouldUpdateStats</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"an error '%s' was not expected when opening a stub database connection"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	mock<span class="token punctuation">.</span><span class="token function">ExpectBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">"UPDATE products"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnResult</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">NewResult</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO product_viewers"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnResult</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">NewResult</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// now we execute our method</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error was not expected while updating stats: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// we make sure that all expectations were met</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"there were unfulfilled expectations: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container info">
<p class="hint-container-title">相关信息</p>
<p>其中：</p>
<ul>
<li>8-11行为我们期望执行的SQL语句，包括返回值。</li>
<li>19行检验是否符合我们的期望。</li>
</ul>
</div>
<h3>失败的测试用例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestShouldRollbackStatUpdatesOnFailure</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"an error '%s' was not expected when opening a stub database connection"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	mock<span class="token punctuation">.</span><span class="token function">ExpectBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">"UPDATE products"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnResult</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">NewResult</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO product_viewers"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WillReturnError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"some error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// now we execute our method</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"was expecting an error, but there was none"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// we make sure that all expectations were met</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"there were unfulfilled expectations: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container info">
<p class="hint-container-title">相关信息</p>
<p>其中</p>
<ul>
<li>第10行模拟执行插入失败错误，第13行期望事务回滚。</li>
<li>第16行按照预期肯定返回错误</li>
<li>第19行则检验是否符合我们的预期</li>
</ul>
</div>
<h2>小试牛刀</h2>
<h3>业务dao层</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> UserDao <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewUserDao</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>UserDao <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>UserDao<span class="token punctuation">{</span>db<span class="token punctuation">:</span> db<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>dao <span class="token operator">*</span>UserDao<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> options <span class="token operator">...</span>store<span class="token punctuation">.</span>Option<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	user <span class="token operator">:=</span> model<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span>
	query <span class="token operator">:=</span> dao<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>model<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> option <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span>
		option<span class="token punctuation">.</span><span class="token punctuation">(</span>Option<span class="token punctuation">)</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> query<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>dao层使用gorm ORM框架，但不妨碍我们采用go-sqlmock进行测试</p>
<h3>测试用例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestUserDao_Get</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">QueryMatcherOption</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span>QueryMatcherEqual<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"an error '%s' was not expected when opening a stub database connection"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>DriverName<span class="token punctuation">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span> Conn<span class="token punctuation">:</span> db<span class="token punctuation">,</span> SkipInitializeWithVersion<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	dao <span class="token operator">:=</span> <span class="token function">NewUserDao</span><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span>

	<span class="token punctuation">{</span> <span class="token comment">//根据name查询用户</span>
		rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span>
		mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM `sys_user` WHERE name = ? ORDER BY `sys_user`.`id` LIMIT ?"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
		user<span class="token punctuation">,</span> err <span class="token operator">:=</span> dao<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NewOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithUserName</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"there were unfulfilled expectations: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span> <span class="token comment">//根据id查询用户</span>
		rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span>
		mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM `sys_user` WHERE id = ? ORDER BY `sys_user`.`id` LIMIT ?"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
		user<span class="token punctuation">,</span> err <span class="token operator">:=</span> dao<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NewOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"there were unfulfilled expectations: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container info">
<p class="hint-container-title">相关信息</p>
<p>其中：</p>
<ul>
<li>第2行我们使用了严格的匹配方式，即<code>sqlmock.QueryMatcherEqual</code>，即要求SQL语句完全一致，否则会报错SQL不是期望所得。</li>
<li>由于使用了GORM框架，所以第7行需要初始化gdb，但是由于GORM初始化会执行<code>SELECT VERSION()</code>，所以我们需要通过<code>SkipInitializeWithVersion</code>跳过初始化。</li>
</ul>
</div>
<p>遇见的一些问题：</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token punctuation">{</span> <span class="token comment">//根据name查询用户</span>
		rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span>
		mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM `sys_user` WHERE name = ? ORDER BY `sys_user`.`id` LIMIT 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
		user<span class="token punctuation">,</span> err <span class="token operator">:=</span> dao<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NewOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithUserName</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"there were unfulfilled expectations: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>第3行，我们通过直接写死<code>LIMIT 1</code>而不是<code>LIMIT ?</code>来限制查询结果，但实际执行时，会报错SQL不是期望所得，导致测试用例不通过。因此需要特别注意，需要通过传参的方式。</p>
</div>
<h2>个人观点</h2>
<p>go-sqlmock通过定义我们期望的SQL语句，然后通过模拟执行，来达到测试的目的。但我们通常使用相关的ORM框架，如GORM，已经不再写SQL语句，框架会自动帮助我们补充完整。因此对于一般肉眼可以审查的代码，我觉得使用go-sqlmock进行测试意义不大。</p>
<p>如果有非常复杂的SQL语句，或者ORM框架无法满足需求，尤其是一些业务逻辑下沉到dao层，那么使用go-sqlmock进行测试是值得的。</p>
<h2>参考文献</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/unit-test-2/" target="_blank" rel="noopener noreferrer">李文周</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/693058578" target="_blank" rel="noopener noreferrer">知乎</a></li>
</ul>
]]></content>
    <category term="编程语言"/>
    <published>2024-06-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Nacos</title>
    <id>http://blog.cjhe.top/database/nacos/</id>
    <link href="http://blog.cjhe.top/database/nacos/"/>
    <updated>2024-05-29T08:27:34.000Z</updated>
    <content type="html"><![CDATA[<!-- more -->
]]></content>
    <category term="数据存储"/>
    <published>2024-05-29T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Nacos监控</title>
    <id>http://blog.cjhe.top/database/nacos/nacos-monitor.html</id>
    <link href="http://blog.cjhe.top/database/nacos/nacos-monitor.html"/>
    <updated>2024-05-29T08:27:34.000Z</updated>
    <summary type="text">Nacos支持Prometheus metrics，接口地址：/nacos/actuator/prometheus。 但是需要配置去开启该接口
修改配置
将Nacos配置文文件：application.properties中下行注释取消
重启Nacos
验证指标
nacos-metricsnacos-metrics
配置面板
nacos-grafana...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>Nacos支持Prometheus metrics，接口地址：/nacos/actuator/prometheus。 但是需要配置去开启该接口</p>
<h2>修改配置</h2>
<p>将Nacos配置文文件：application.properties中下行注释取消</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>management.endpoints.web.exposure.include=*
</code></pre></div><h2>重启Nacos</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sh</span> bin/shutdown.sh
<span class="token function">sh</span> bin/startup.sh <span class="token parameter variable">-m</span> standalone
</code></pre></div><h2>验证指标</h2>
<figure><figcaption>nacos-metrics</figcaption></figure>
<h2>配置面板</h2>
<figure><figcaption>nacos-grafana</figcaption></figure>
]]></content>
    <category term="数据存储"/>
    <published>2024-05-29T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言sync.Map底层原理</title>
    <id>http://blog.cjhe.top/language/go/advance/sync-map.html</id>
    <link href="http://blog.cjhe.top/language/go/advance/sync-map.html"/>
    <updated>2024-05-27T09:37:28.000Z</updated>
    <summary type="text">Go 语言原生的map是非并发安全的，在并发场景下，使用map可能会导致数据竞争和panic。为了解决这个问题，Go 语言提供了sync.Map，它是一个并发安全的map。在本文中，我们将深入探讨sync.Map的底层实现原理，以便更好地理解它的并发安全特性。

基本用法
sync.Map提供了丰富的API，用于对map的查询、存储、遍历、删除等操作。...</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>Go 语言原生的map是非并发安全的，在并发场景下，使用map可能会导致数据竞争和panic。为了解决这个问题，Go 语言提供了sync.Map，它是一个并发安全的map。在本文中，我们将深入探讨sync.Map的底层实现原理，以便更好地理解它的并发安全特性。</p>
</blockquote>
<h2>基本用法</h2>
<p>sync.Map提供了丰富的API，用于对map的查询、存储、遍历、删除等操作。</p>
<h3>存储</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 存储</span>
	m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">)</span>
	m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">)</span>
</code></pre></div><h3>查询</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 查询</span>
	one<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key 1 not found"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3>遍历</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 遍历</span>
	m<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value any<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key:"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">"value:"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>Range参数传递的是一个函数，该函数的返回值是一个bool类型，表示是否继续遍历。</p>
<ul>
<li>如果是true，则继续遍历。</li>
<li>如果是false，则不继续遍历。</li>
</ul>
</div>
<h3>删除</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 删除</span>
	m<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
	one<span class="token punctuation">,</span> ok <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key 1 not found"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3>查询并设置默认值</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 查询，不存在的情况下存储默认值</span>
	two<span class="token punctuation">,</span> loaded <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">LoadOrStore</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"three:"</span><span class="token punctuation">,</span> two<span class="token punctuation">,</span> <span class="token string">"loaded:"</span><span class="token punctuation">,</span> loaded<span class="token punctuation">)</span>
	three<span class="token punctuation">,</span> loaded <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">LoadOrStore</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"three:"</span><span class="token punctuation">,</span> three<span class="token punctuation">,</span> <span class="token string">"loaded:"</span><span class="token punctuation">,</span> loaded<span class="token punctuation">)</span>
</code></pre></div><h3>查询并删除</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 查询并删除</span>
	three<span class="token punctuation">,</span> loaded <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">LoadAndDelete</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"three:"</span><span class="token punctuation">,</span> three<span class="token punctuation">,</span> <span class="token string">"loaded:"</span><span class="token punctuation">,</span> loaded<span class="token punctuation">)</span>
	four<span class="token punctuation">,</span> loaded <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">LoadAndDelete</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"four:"</span><span class="token punctuation">,</span> four<span class="token punctuation">,</span> <span class="token string">"loaded:"</span><span class="token punctuation">,</span> loaded<span class="token punctuation">)</span>
</code></pre></div><h3>交换</h3>
<p>其实就是更新</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 交换</span>
	two<span class="token punctuation">,</span> loaded <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"double"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"two:"</span><span class="token punctuation">,</span> two<span class="token punctuation">,</span> <span class="token string">"loaded:"</span><span class="token punctuation">,</span> loaded<span class="token punctuation">)</span>
	two<span class="token punctuation">,</span> ok <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>two<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
</code></pre></div><h3>指定旧值交换</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	<span class="token comment">// 交换，仅当旧值相同时才进行交换</span>
	result <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"double"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
	result <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"double"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</code></pre></div><p>相比较Swap方法，CompareAndSwap方法多了一个参数，该参数用于指定旧值。仅当旧值与指定的旧值相同时，才会进行交换操作。</p>
<h2>底层原理</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Map <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu Mutex
	read atomic<span class="token punctuation">.</span>Pointer<span class="token punctuation">[</span>readOnly<span class="token punctuation">]</span>
	dirty <span class="token keyword">map</span><span class="token punctuation">[</span>any<span class="token punctuation">]</span><span class="token operator">*</span>entry
	misses <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中：</p>
<ul>
<li><strong>mu</strong>：用于保护<code>dirty</code>的互斥锁。</li>
<li><strong>read</strong>：只读的map，使用原子操作，因此可以无锁的并发访问，其底层则对应<code>readOnly</code>。</li>
<li><strong>dirty</strong>：可写的map。</li>
<li><strong>misses</strong>：从read读取miss次数。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> readOnly <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	m       <span class="token keyword">map</span><span class="token punctuation">[</span>any<span class="token punctuation">]</span><span class="token operator">*</span>entry
	amended <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> entry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	p atomic<span class="token punctuation">.</span>Pointer<span class="token punctuation">[</span>any<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>readOnly.amended</code>表示<code>dirty</code>中是否存在<code>read</code>中不存在的key。</p>
<h3>sync.Map的查询过程</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> <span class="token punctuation">(</span>value any<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	read <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
		m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		read <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		e<span class="token punctuation">,</span> ok <span class="token operator">=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
			e<span class="token punctuation">,</span> ok <span class="token operator">=</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
			m<span class="token punctuation">.</span><span class="token function">missLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看到，sync.Map的查询过程如下：</p>
<ol>
<li>首先尝试从<code>read</code>读取。</li>
<li>加锁，再次从<code>read</code>中二次检查。</li>
<li>如果<code>read</code>中没有找到，并且<code>dirty</code>中存在该key，则从<code>dirty</code>中读取。</li>
<li>如果<code>read</code>和<code>dirty</code>都没有找到，返回nil。</li>
</ol>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<ul>
<li>
<p>第6行，进行二次检查。因为可能有其他线程已经在read添加了对应的key，需要double check，二次检查在sync包中经常会看到，我们也会在单例设计模式借鉴该方法。</p>
</li>
<li>
<p>我们也看到<code>read.amended</code>字段存在的价值，必要的数据冗余会带来复杂读的降低，值得学习。</p>
</li>
<li>
<p>我们可以看到如果可以从<code>read</code>查询到数据，整个过程是可以不用加锁的。</p>
</li>
</ul>
</div>
<p>这里需要关注<code>missLocked</code>方法，该方法用于记录miss次数。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">missLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m<span class="token punctuation">.</span>misses<span class="token operator">++</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>misses <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readOnly<span class="token punctuation">{</span>m<span class="token punctuation">:</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">}</span><span class="token punctuation">)</span>
	m<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">nil</span>
	m<span class="token punctuation">.</span>misses <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>我们看到如果从<code>read</code>中查不到数据的<code>miss</code>次数如果超过了<code>dirty</code>的长度，就会将<code>dirty</code>提升为<code>read</code>。</p>
</div>
<h3>sync.Map的存储过程</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Store</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其底层调用的是Swap方法，我们继续跟进</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value any<span class="token punctuation">)</span> <span class="token punctuation">(</span>previous any<span class="token punctuation">,</span> loaded <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	read <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">trySwap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	read <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> e<span class="token punctuation">.</span><span class="token function">unexpungeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> e
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> v <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">swapLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> v <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			loaded <span class="token operator">=</span> <span class="token boolean">true</span>
			previous <span class="token operator">=</span> <span class="token operator">*</span>v
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> v <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">swapLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> v <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			loaded <span class="token operator">=</span> <span class="token boolean">true</span>
			previous <span class="token operator">=</span> <span class="token operator">*</span>v
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
			m<span class="token punctuation">.</span><span class="token function">dirtyLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readOnly<span class="token punctuation">{</span>m<span class="token punctuation">:</span> read<span class="token punctuation">.</span>m<span class="token punctuation">,</span> amended<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> previous<span class="token punctuation">,</span> loaded
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，sync.Map的存储过程如下：</p>
<ol>
<li>首先尝试从<code>read</code>读取。</li>
<li>如果<code>read</code>中找到了，则直接更新。由于<code>read</code>和<code>dirty</code>相同的key引用了同一个<code>entry</code>，因此对<code>read</code>的修改，<code>dirty</code>也会生效。因此可以直接退出。</li>
<li>如果<code>read</code>中找不到，double check read。</li>
<li>如果<code>dirty</code>找到，则直接更新。</li>
<li>如果<code>read</code>和<code>dirty</code>均找不到，直接存储在dirty中。</li>
</ol>
<p>这里需要关注一下<code>dirtyLocked</code>方法</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">dirtyLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>dirty <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	read <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	m<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>any<span class="token punctuation">]</span><span class="token operator">*</span>entry<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>read<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> read<span class="token punctuation">.</span>m <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">tryExpungeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> e
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container note">
<p class="hint-container-title">注</p>
<p>该方法如何发现<code>dirty</code>为nil，则将<code>read</code>拷贝至<code>dirty</code>中</p>
</div>
<h3>sync.Map的删除过程</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m<span class="token punctuation">.</span><span class="token function">LoadAndDelete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其底层调用了LoadAndDelete方法，我们继续跟进</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">LoadAndDelete</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> <span class="token punctuation">(</span>value any<span class="token punctuation">,</span> loaded <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	read <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
		m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		read <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		e<span class="token punctuation">,</span> ok <span class="token operator">=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
			e<span class="token punctuation">,</span> ok <span class="token operator">=</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirty<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
			m<span class="token punctuation">.</span><span class="token function">missLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，sync.Map的删除过程如下：</p>
<ol>
<li>首先尝试从<code>read</code>读取，如果<code>read</code>中找到了，则直接删除。</li>
<li>如果<code>read</code>中找不到，并且存在key在dirty中，double check read。</li>
<li>如果<code>dirty</code>找到，则直接删除。如果<code>read</code>中找到了，则直接删除。</li>
<li>如果<code>read</code>和<code>dirty</code>均找不到，直接返回。</li>
</ol>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>第16行，由于<code>read</code>和<code>dirty</code>相同的key引用了同一个<code>entry</code>，因此对<code>read</code>的修改，<code>dirty</code>也会生效。</p>
</div>
<h3>sync.Map的遍历过程</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Range</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value any<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	read <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
		m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		read <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">loadReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
			read <span class="token operator">=</span> readOnly<span class="token punctuation">{</span>m<span class="token punctuation">:</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">}</span>
			copyRead <span class="token operator">:=</span> read
			m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>copyRead<span class="token punctuation">)</span>
			m<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">nil</span>
			m<span class="token punctuation">.</span>misses <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> k<span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> read<span class="token punctuation">.</span>m <span class="token punctuation">{</span>
		v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">f</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container note">
<p class="hint-container-title">注</p>
<p>我们注意到，7-11行，会将dirty复制到read中，并且将dirty置为nil。</p>
</div>
<h2>参考文献</h2>
<ul>
<li><a href="https://juejin.cn/post/7156957188840226829" target="_blank" rel="noopener noreferrer">深入理解 Go sync.map</a></li>
<li><a href="https://www.cnblogs.com/qcrao-2018/p/12833787.html" target="_blank" rel="noopener noreferrer">深度解密 Go 语言之 sync.map</a></li>
<li><a href="https://blog.baiguiren.com/2023/01/17/golang/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20go%20sync.Map%20-%20%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener noreferrer">深入理解 go sync.Map - 基本原理</a></li>
<li><a href="https://blog.baiguiren.com/2023/01/18/golang/go%20sync.Map%20%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/" target="_blank" rel="noopener noreferrer">go sync.Map 设计与实现</a></li>
</ul>
]]></content>
    <category term="编程语言"/>
    <published>2024-05-27T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go如何禁止拷贝</title>
    <id>http://blog.cjhe.top/language/go/advance/no-copy.html</id>
    <link href="http://blog.cjhe.top/language/go/advance/no-copy.html"/>
    <updated>2024-05-24T08:13:08.000Z</updated>
    <summary type="text">禁止拷贝的目的是不让用户对对象进行拷贝，比如：sync.WaitGroup

那么Go语言是如何禁止拷贝的呢？
WaitGroup为何禁止拷贝
还是以sync.WaitGroup为例，我们来看一下它的源码：
我们可以看到，sync.WaitGroup结构体中有一个noCopy的匿名结构体，并且实现了Lock和Unlock方法。通过内嵌了noCopy，s...</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>禁止拷贝的目的是不让用户对对象进行拷贝，比如：sync.WaitGroup</p>
</blockquote>
<p>那么Go语言是如何禁止拷贝的呢？</p>
<h2>WaitGroup为何禁止拷贝</h2>
<p>还是以sync.WaitGroup为例，我们来看一下它的源码：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> WaitGroup <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    noCopy noCopy
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// noCopy may be added to structs which must not be copied</span>
<span class="token comment">// after the first use.</span>
<span class="token comment">//</span>
<span class="token comment">// See https://golang.org/issues/8005#issuecomment-190753527</span>
<span class="token comment">// for details.</span>
<span class="token comment">//</span>
<span class="token comment">// Note that it must not be embedded, due to the Lock and Unlock methods.</span>
<span class="token keyword">type</span> noCopy <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// Lock is a no-op used by -copylocks checker from `go vet`.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，<code>sync.WaitGroup</code>结构体中有一个<code>noCopy</code>的匿名结构体，并且实现了<code>Lock</code>和<code>Unlock</code>方法。通过内嵌了<code>noCopy</code>，sync.WaitGroup就禁止了拷贝。</p>
<p>其实原理很简单，就是通过<code>go vet</code>检查，如果发现结构体中包含<code>noCopy</code>，就会提示禁止拷贝。</p>
<h2>自己实现禁止拷贝</h2>
<p>那么我们定义自己的结构体，验证是否能够禁止拷贝</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Demo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Demo<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Demo<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Copy</span><span class="token punctuation">(</span>d Demo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d <span class="token operator">:=</span> Demo<span class="token punctuation">{</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%+v"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token function">Copy</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	d2 <span class="token operator">:=</span> d
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%+v"</span><span class="token punctuation">,</span> d2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>$ go run main.go
{}{}
</code></pre></div></details>
<p>运行结果依然是正常的，但是我们通过<code>go vet</code>检查一下：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>$ go vet .\main.go
# command-line-arguments
# [command-line-arguments]
.\main.go:11:13: Copy passes lock by value: command-line-arguments.Demo
.\main.go:16:20: call of fmt.Printf copies lock value: command-line-arguments.Demo
.\main.go:17:7: call of Copy copies lock value: command-line-arguments.Demo
.\main.go:18:8: assignment copies lock value to d2: command-line-arguments.Demo
.\main.go:19:20: call of fmt.Printf copies lock value: command-line-arguments.Demo
</code></pre></div><p>我们看到go vet提示了5个command-line-arguments.noCopy问题：</p>
<ul>
<li>第11行，定义Copy函数传参，本质是对象拷贝；</li>
<li>第16行，fmt.Printf函数调用，本质是对象拷贝；</li>
<li>第17行，Copy函数调用，本质是对象拷贝；</li>
<li>第18行，d赋值给d2，也是拷贝；</li>
<li>第19行，fmt.Printf函数调用，本质是参数拷贝。</li>
</ul>
<h2>总结</h2>
<p>要想禁止拷贝，可以定义一个结构体，只需实现<code>Lock</code>方法和<code>Unlock</code>方法，如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Demo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Demo<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Demo<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>或者类似<code>sync.WaitGroup</code>内嵌<code>noCopy</code>结构体。推荐使用该方式！</p>
<p>要想检测自己是否拷贝了禁止拷贝的结构体，可以使用<code>go vet</code>命令，该命令会检测出<code>noCopy</code>结构体的问题。</p>
]]></content>
    <category term="编程语言"/>
    <published>2024-05-24T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Minio</title>
    <id>http://blog.cjhe.top/database/minio/</id>
    <link href="http://blog.cjhe.top/database/minio/"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <content type="html"><![CDATA[<!-- more -->
]]></content>
    <category term="数据存储"/>
    <published>2024-05-20T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">MongoDB</title>
    <id>http://blog.cjhe.top/database/mongodb/</id>
    <link href="http://blog.cjhe.top/database/mongodb/"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <content type="html"><![CDATA[<!-- more -->
]]></content>
    <category term="数据存储"/>
    <published>2024-05-20T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">使用Makefile和Helm-Dashobard两步实现k8s服务多环境更新</title>
    <id>http://blog.cjhe.top/devops/k8s/makefile-deploy.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/makefile-deploy.html"/>
    <updated>2024-05-12T13:19:14.000Z</updated>
    <summary type="html"><![CDATA[<h2>背景</h2>
<p>在开发过程中，我们经常需要频繁的更新k8s服务，如果每次更新都需要手动执行一系列的命令，那将会非常繁琐。因此，我们需要一种自动化的方式来更新k8s服务。</p>
<h2>解决方案</h2>
<p>使用Makefile来定义更新k8s服务的流程，并使用自动化工具（如git、docker等）来执行Makefile中的命令。这样，每次更新服务时，只需要执行一条命令即可完成更新操作。</p>
]]></summary>
    <content type="html"><![CDATA[<h2>背景</h2>
<p>在开发过程中，我们经常需要频繁的更新k8s服务，如果每次更新都需要手动执行一系列的命令，那将会非常繁琐。因此，我们需要一种自动化的方式来更新k8s服务。</p>
<h2>解决方案</h2>
<p>使用Makefile来定义更新k8s服务的流程，并使用自动化工具（如git、docker等）来执行Makefile中的命令。这样，每次更新服务时，只需要执行一条命令即可完成更新操作。</p>
<!-- more -->
<h2>具体实现</h2>
<h3>定义基础的变量</h3>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span>hhm-disposal
<span class="token assign-left variable">DOCKER_HARBOR</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:8760
GIT_VERSION <span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>shell <span class="token function">git</span> describe <span class="token parameter variable">--tags</span><span class="token variable">)</span></span>
envs <span class="token operator">=</span> prod pre
</code></pre></div><ul>
<li>DOCKER_HARBOR是镜像仓库docker hub的地址</li>
<li>envs是多个环境，因为我们在k8s环境部署多个环境，如生产环境、预发布环境等</li>
<li>GIT_VERSION是当前git仓库的版本号</li>
</ul>
<h3>docker build</h3>
<p>构建本地镜像</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>docker-build:
	docker build -t $(DOCKER_HARBOR)/idata/$(APP_NAME):$(GIT_VERSION) .
</code></pre></div><h3>docker push</h3>
<p>推送本地镜像至docker hub</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>docker-push:
	docker push $(DOCKER_HARBOR)/idata/$(APP_NAME):$(GIT_VERSION)
</code></pre></div><h3>helm package</h3>
<p>helm打包本地chart包，由于我们要基于一个docker镜像部署在不同的环境，因此这里会有多个环境的chart包</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>helm-package:
	@for env in $(envs);\
		do echo 'helm package' $$env;\
		cp deployments/disposal/env/$$env/values.yaml deployments/disposal/values.yaml;\
		cp deployments/disposal/env/$$env/Chart.yaml deployments/disposal/Chart.yaml;\
		cp config/config.$$env.toml deployments/disposal/config/config.local.toml;\
		helm lint --strict deployments/disposal;\
		helm package deployments/disposal --version $(GIT_VERSION) --app-version $(GIT_VERSION);\
	done
</code></pre></div><h3>helm push</h3>
<p>helm推送chart包至chart仓库</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>helm-push: 
	@for env in $(envs);\
		do echo 'helm push' $$env;\
		helm cm-push disposal-$$env-$(GIT_VERSION).tgz hhm;\
	dones
</code></pre></div><h3>helm clean</h3>
<p>清理本地的chart包文件</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>helm-clean: 
	@for env in $(envs);\
		do echo 'helm clean' $$env;\
		rm -rf disposal-$$env-$(GIT_VERSION).tgz;\
	done
</code></pre></div><h3>串通以上命令</h3>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>k8s: docker-build docker-push helm-package helm-push helm-clean
</code></pre></div><p>这样我们只需要执行<code>make k8s</code>就可以将这些繁杂的命令串通起来。</p>
<h2>两步完成k8s服务更新</h2>
<p>第一步：通过Makefile的<code>make k8s</code>实现镜像的构建、镜像的推送、chart包的构建、chart包的推送；
第二步：通过helm-dashboard进行服务的更新；</p>
<h2>沉淀的Makefile脚本</h2>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>APP_NAME=hhm-disposal
DOCKER_HARBOR=127.0.0.1:8760
GIT_VERSION = $(shell git describe --tags)
envs = prod pre

version:
	@echo $(GIT_VERSION)

k8s: docker-build docker-push helm-package helm-push helm-clean

lint:
	golangci-lint run ./...

build:
	GOOS=linux go build 

clean:
	go clean

swagger:
	swag init

docker-build:
	docker build -t $(DOCKER_HARBOR)/idata/$(APP_NAME):$(GIT_VERSION) .

docker-push:
	docker push $(DOCKER_HARBOR)/idata/$(APP_NAME):$(GIT_VERSION)

helm-package:
	@for env in $(envs);\
		do echo 'helm package' $$env;\
		cp deployments/disposal/env/$$env/values.yaml deployments/disposal/values.yaml;\
		cp deployments/disposal/env/$$env/Chart.yaml deployments/disposal/Chart.yaml;\
		cp config/config.$$env.toml deployments/disposal/config/config.local.toml;\
		helm lint --strict deployments/disposal;\
		helm package deployments/disposal --version $(GIT_VERSION) --app-version $(GIT_VERSION);\
	done

helm-push: 
	@for env in $(envs);\
		do echo 'helm push' $$env;\
		helm cm-push disposal-$$env-$(GIT_VERSION).tgz hhm;\
	done

helm-clean: 
	@for env in $(envs);\
		do echo 'helm clean' $$env;\
		rm -rf disposal-$$env-$(GIT_VERSION).tgz;\
	done
</code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-05-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Helm仓库chartmuseum简介</title>
    <id>http://blog.cjhe.top/devops/k8s/chartmuseum.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/chartmuseum.html"/>
    <updated>2024-05-12T13:18:25.000Z</updated>
    <summary type="html"><![CDATA[<p>chartmuseum是Helm的chart仓库，它支持多种存储后端，如本地文件系统、Amazon S3、Google Cloud Storage、Openstack Swift、Azure Blob Storage、Minio等。</p>
]]></summary>
    <content type="html"><![CDATA[<p>chartmuseum是Helm的chart仓库，它支持多种存储后端，如本地文件系统、Amazon S3、Google Cloud Storage、Openstack Swift、Azure Blob Storage、Minio等。</p>
<!-- more -->
<h2>chartmuseum 部署</h2>
<p>这里采用docker部署</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">STORAGE</span><span class="token operator">=</span>local <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">STORAGE_LOCAL_ROOTDIR</span><span class="token operator">=</span>/charts <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/charts:/charts <span class="token punctuation">\</span>
  ghcr.io/helm/chartmuseum:v0.16.1
</code></pre></div><h2>helm 配置</h2>
<h3>安装依赖</h3>
<p>配合该仓库需要在我们安装的helm基础上，安装相关插件 helm-push (https://github.com/chartmuseum/helm-push)</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>helm plugin <span class="token function">install</span> https://github.com/chartmuseum/helm-push
</code></pre></div><h3>配置环境</h3>
<p>将私有仓库加入本地</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>helm repo <span class="token function">add</span> hhm http://127.0.0.1:8080
helm repo update
</code></pre></div><h2>推送 chart</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>helm cm-push disposal-v1.0.6.tgz hhm
</code></pre></div><h2>验证版本</h2>
<p>我们通过helm-dashboard查看chart包是否已更新</p>
<figure><figcaption>chartmuseum</figcaption></figure>
]]></content>
    <category term="devops"/>
    <published>2024-05-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">十二要素应用原则</title>
    <id>http://blog.cjhe.top/share/12factors.html</id>
    <link href="http://blog.cjhe.top/share/12factors.html"/>
    <updated>2024-05-11T07:09:37.000Z</updated>
    <summary type="html"><![CDATA[<p>【转】<a href="https://12factor.net/zh_cn/" target="_blank" rel="noopener noreferrer">原文链接</a></p>
]]></summary>
    <content type="html"><![CDATA[<p>【转】<a href="https://12factor.net/zh_cn/" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<h2>简介</h2>
<p>如今，软件通常会作为一种服务来交付，它们被称为网络应用程序，或软件即服务（SaaS）。12-Factor 为构建如下的 SaaS 应用提供了方法论：</p>
<ul>
<li>使用<strong>标准化</strong>流程自动配置，从而使新的开发者花费最少的学习成本加入这个项目。</li>
<li>和操作系统之间尽可能的<strong>划清界限</strong>，在各个系统中提供<strong>最大的可移植性</strong>。</li>
<li>适合<strong>部署</strong>在现代的<strong>云计算平台</strong>，从而在服务器和系统管理方面节省资源。</li>
<li>将开发环境和生产环境的<strong>差异降至最低</strong>，并使用<strong>持续交付</strong>实施敏捷开发。</li>
<li>可以在工具、架构和开发流程不发生明显变化的前提下实现<strong>扩展</strong>。</li>
</ul>
<p>这套理论适用于任意语言和后端服务（数据库、消息队列、缓存等）开发的应用程序。</p>
<h2>背景</h2>
<p>本文的贡献者参与过数以百计的应用程序的开发和部署，并通过 <a href="http://www.heroku.com/" target="_blank" rel="noopener noreferrer">Heroku</a> 平台间接见证了数十万应用程序的开发，运作以及扩展的过程。</p>
<p>本文综合了我们关于 SaaS 应用几乎所有的经验和智慧，是开发此类应用的理想实践标准，并特别关注于应用程序如何保持良性成长，开发者之间如何进行有效的代码协作，以及如何 <a href="http://blog.heroku.com/archives/2011/6/28/the_new_heroku_4_erosion_resistance_explicit_contracts/" target="_blank" rel="noopener noreferrer">避免软件污染</a> 。</p>
<p>我们的初衷是分享在现代软件开发过程中发现的一些系统性问题，并加深对这些问题的认识。我们提供了讨论这些问题时所需的共享词汇，同时使用相关术语给出一套针对这些问题的广义解决方案。本文格式的灵感来自于 Martin Fowler 的书籍： <em><a href="http://books.google.com/books/about/Patterns_of_enterprise_application_archi.html?id=FyWZt5DdvFkC" target="_blank" rel="noopener noreferrer">Patterns of Enterprise Application Architecture</a></em> ， <em><a href="http://books.google.com/books/about/Refactoring.html?id=1MsETFPD3I0C" target="_blank" rel="noopener noreferrer">Refactoring</a></em> 。</p>
<h2>读者应该是那些人？</h2>
<p>任何 SaaS 应用的开发人员。部署和管理此类应用的运维工程师。</p>
<figure><figcaption>12-factors</figcaption></figure>
<h2>I. 基准代码</h2>
<h3>一份基准代码（<em>Codebase</em>），多份部署（<em>deploy</em>）</h3>
<p>12-Factor应用(译者注：应该是说一个使用本文概念来设计的应用，下同)通常会使用版本控制系统加以管理，如<a href="http://git-scm.com/" target="_blank" rel="noopener noreferrer">Git</a>, <a href="https://www.mercurial-scm.org/" target="_blank" rel="noopener noreferrer">Mercurial</a>, <a href="http://subversion.apache.org/" target="_blank" rel="noopener noreferrer">Subversion</a>。一份用来跟踪代码所有修订版本的数据库被称作 <em>代码库</em>（code repository, code repo, repo）。</p>
<p>在类似 SVN 这样的集中式版本控制系统中，<em>基准代码</em> 就是指控制系统中的这一份代码库；而在 Git 那样的分布式版本控制系统中，<em>基准代码</em> 则是指最上游的那份代码库。</p>
<figure><figcaption>一份代码库对应多份部署</figcaption></figure>
<p>基准代码和应用之间总是保持一一对应的关系：</p>
<ul>
<li>一旦有多个基准代码，就不能称为一个应用，而是一个分布式系统。分布式系统中的每一个组件都是一个应用，每一个应用可以分别使用 12-Factor 进行开发。</li>
<li>多个应用共享一份基准代码是有悖于 12-Factor 原则的。解决方案是将共享的代码拆分为独立的类库，然后使用 <a href="./dependencies">依赖管理</a> 策略去加载它们。</li>
</ul>
<p>尽管每个应用只对应一份基准代码，但可以同时存在多份部署。每份 <em>部署</em> 相当于运行了一个应用的实例。通常会有一个生产环境，一个或多个预发布环境。此外，每个开发人员都会在自己本地环境运行一个应用实例，这些都相当于一份部署。</p>
<p>所有部署的基准代码相同，但每份部署可以使用其不同的版本。比如，开发人员可能有一些提交还没有同步至预发布环境；预发布环境也有一些提交没有同步至生产环境。但它们都共享一份基准代码，我们就认为它们只是相同应用的不同部署而已。</p>
<h2>II. 依赖</h2>
<h3>显式声明依赖关系（ <em>dependency</em> ）</h3>
<p>大多数编程语言都会提供一个打包系统，用来为各个类库提供打包服务，就像 Perl 的 <a href="http://www.cpan.org/" target="_blank" rel="noopener noreferrer">CPAN</a> 或是 Ruby 的 <a href="http://rubygems.org/" target="_blank" rel="noopener noreferrer">Rubygems</a> 。通过打包系统安装的类库可以是系统级的（称之为 "site packages"），或仅供某个应用程序使用，部署在相应的目录中（称之为 "vendoring" 或 "bundling"）。</p>
<p><strong>12-Factor规则下的应用程序不会隐式依赖系统级的类库。</strong> 它一定通过 <em>依赖清单</em> ，确切地声明所有依赖项。此外，在运行过程中通过 <em>依赖隔离</em> 工具来确保程序不会调用系统中存在但清单中未声明的依赖项。这一做法会统一应用到生产和开发环境。</p>
<p>例如， Ruby 的 <a href="https://bundler.io/" target="_blank" rel="noopener noreferrer">Bundler</a> 使用 <code>Gemfile</code> 作为依赖项声明清单，使用 <code>bundle exec</code> 来进行依赖隔离。Python 中则可分别使用两种工具 -- <a href="http://www.pip-installer.org/en/latest/" target="_blank" rel="noopener noreferrer">Pip</a> 用作依赖声明， <a href="http://www.virtualenv.org/en/latest/" target="_blank" rel="noopener noreferrer">Virtualenv</a> 用作依赖隔离。甚至 C 语言也有类似工具， <a href="http://www.gnu.org/s/autoconf/" target="_blank" rel="noopener noreferrer">Autoconf</a> 用作依赖声明，静态链接库用作依赖隔离。无论用什么工具，依赖声明和依赖隔离必须一起使用，否则无法满足 12-Factor 规范。</p>
<p>显式声明依赖的优点之一是为新进开发者简化了环境配置流程。新进开发者可以检出应用程序的基准代码，安装编程语言环境和它对应的依赖管理工具，只需通过一个 <em>构建命令</em> 来安装所有的依赖项，即可开始工作。例如，Ruby/Bundler 下使用 <code>bundle install</code>，而 Clojure/<a href="https://github.com/technomancy/leiningen#readme" target="_blank" rel="noopener noreferrer">Leiningen</a> 则是 <code>lein deps</code>。</p>
<p>12-Factor 应用同样不会隐式依赖某些系统工具，如 ImageMagick 或是<code>curl</code>。即使这些工具存在于几乎所有系统，但终究无法保证所有未来的系统都能支持应用顺利运行，或是能够和应用兼容。如果应用必须使用到某些系统工具，那么这些工具应该被包含在应用之中。</p>
<h2>III. 配置</h2>
<h3>在环境中存储配置</h3>
<p>通常，应用的 <em>配置</em> 在不同 <a href="./codebase">部署</a> (预发布、生产环境、开发环境等等)间会有很大差异。这其中包括：</p>
<ul>
<li>数据库，Memcached，以及其他 <a href="./backing-services">后端服务</a> 的配置</li>
<li>第三方服务的证书，如 Amazon S3、Twitter 等</li>
<li>每份部署特有的配置，如域名等</li>
</ul>
<p>有些应用在代码中使用常量保存配置，这与 12-Factor 所要求的<strong>代码和配置严格分离</strong>显然大相径庭。配置文件在各部署间存在大幅差异，代码却完全一致。</p>
<p>判断一个应用是否正确地将配置排除在代码之外，一个简单的方法是看该应用的基准代码是否可以立刻开源，而不用担心会暴露任何敏感的信息。</p>
<p>需要指出的是，这里定义的"配置"并<strong>不</strong>包括应用的内部配置，比如 Rails 的 <code>config/routes.rb</code>，或是使用 <a href="http://spring.io/" target="_blank" rel="noopener noreferrer">Spring</a> 时 <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html" target="_blank" rel="noopener noreferrer">代码模块间的依赖注入关系</a> 。这类配置在不同部署间不存在差异，所以应该写入代码。</p>
<p>另外一个解决方法是使用配置文件，但不把它们纳入版本控制系统，就像 Rails 的 <code>config/database.yml</code> 。这相对于在代码中使用常量已经是长足进步，但仍然有缺点：总是会不小心将配置文件签入了代码库；配置文件的可能会分散在不同的目录，并有着不同的格式，这让找出一个地方来统一管理所有配置变的不太现实。更糟的是，这些格式通常是语言或框架特定的。</p>
<p><strong>12-Factor推荐将应用的配置存储于 <em>环境变量</em> 中</strong>（ <em>env vars</em>, <em>env</em> ）。环境变量可以非常方便地在不同的部署间做修改，却不动一行代码；与配置文件不同，不小心把它们签入代码库的概率微乎其微；与一些传统的解决配置问题的机制（比如 Java 的属性配置文件）相比，环境变量与语言和系统无关。</p>
<p>配置管理的另一个方面是分组。有时应用会将配置按照特定部署进行分组（或叫做“环境”），例如Rails中的 <code>development</code>,<code>test</code>, 和 <code>production</code> 环境。这种方法无法轻易扩展：更多部署意味着更多新的环境，例如 <code>staging</code> 或 <code>qa</code> 。 随着项目的不断深入，开发人员可能还会添加他们自己的环境，比如 <code>joes-staging</code> ，这将导致各种配置组合的激增，从而给管理部署增加了很多不确定因素。</p>
<p>12-Factor 应用中，环境变量的粒度要足够小，且相对独立。它们永远也不会组合成一个所谓的“环境”，而是独立存在于每个部署之中。当应用程序不断扩展，需要更多种类的部署时，这种配置管理方式能够做到平滑过渡。</p>
<h2>IV. 后端服务</h2>
<h3>把后端服务(<em>backing services</em>)当作附加资源</h3>
<p><em>后端服务</em>是指程序运行所需要的通过网络调用的各种服务，如数据库（<a href="http://dev.mysql.com/" target="_blank" rel="noopener noreferrer">MySQL</a>，<a href="http://couchdb.apache.org/" target="_blank" rel="noopener noreferrer">CouchDB</a>），消息/队列系统（<a href="http://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a>，<a href="https://beanstalkd.github.io" target="_blank" rel="noopener noreferrer">Beanstalkd</a>），SMTP 邮件发送服务（<a href="http://www.postfix.org/" target="_blank" rel="noopener noreferrer"> Postfix</a>），以及缓存系统（<a href="http://memcached.org/" target="_blank" rel="noopener noreferrer">Memcached</a>）。</p>
<p>类似数据库的后端服务，通常由部署应用程序的系统管理员一起管理。除了本地服务之外，应用程序有可能使用了第三方发布和管理的服务。示例包括 SMTP（例如 <a href="http://postmarkapp.com/" target="_blank" rel="noopener noreferrer">Postmark</a>），数据收集服务（例如 <a href="http://newrelic.com/" target="_blank" rel="noopener noreferrer">New Relic</a> 或 <a href="http://www.loggly.com/" target="_blank" rel="noopener noreferrer">Loggly</a>），数据存储服务（如 <a href="http://http://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a>），以及使用 API 访问的服务（例如 <a href="http://dev.twitter.com/" target="_blank" rel="noopener noreferrer">Twitter</a>, <a href="https://developers.google.com/maps/" target="_blank" rel="noopener noreferrer">Google Maps</a>, <a href="http://www.last.fm/api" target="_blank" rel="noopener noreferrer">Last.fm</a>）。</p>
<p><strong>12-Factor 应用不会区别对待本地或第三方服务。</strong> 对应用程序而言，两种都是附加资源，通过一个 url 或是其他存储在 <a href="./config">配置</a> 中的服务定位/服务证书来获取数据。12-Factor 应用的任意 <a href="./codebase">部署</a> ，都应该可以在不进行任何代码改动的情况下，将本地 MySQL 数据库换成第三方服务（例如 <a href="http://aws.amazon.com/rds/" target="_blank" rel="noopener noreferrer">Amazon RDS</a>）。类似的，本地 SMTP 服务应该也可以和第三方 SMTP 服务（例如 Postmark ）互换。上述 2 个例子中，仅需修改配置中的资源地址。</p>
<p>每个不同的后端服务是一份 <em>资源</em> 。例如，一个 MySQL 数据库是一个资源，两个 MySQL 数据库（用来数据分区）就被当作是 2 个不同的资源。12-Factor 应用将这些数据库都视作 <em>附加资源</em> ，这些资源和它们附属的部署保持松耦合。</p>

<p>部署可以按需加载或卸载资源。例如，如果应用的数据库服务由于硬件问题出现异常，管理员可以从最近的备份中恢复一个数据库，卸载当前的数据库，然后加载新的数据库 -- 整个过程都不需要修改代码。</p>
<h2>V. 构建，发布，运行</h2>
<h3>严格分离构建和运行</h3>
<p><a href="./codebase">基准代码</a> 转化为一份部署(非开发环境)需要以下三个阶段：</p>
<ul>
<li><em>构建阶段</em> 是指将代码仓库转化为可执行包的过程。构建时会使用指定版本的代码，获取和打包 <a href="./dependencies">依赖项</a>，编译成二进制文件和资源文件。</li>
<li><em>发布阶段</em> 会将构建的结果和当前部署所需 <a href="./config">配置</a> 相结合，并能够立刻在运行环境中投入使用。</li>
<li><em>运行阶段</em> （或者说“运行时”）是指针对选定的发布版本，在执行环境中启动一系列应用程序 <a href="./processes">进程</a>。</li>
</ul>
<figure><figcaption>代码被构建，然后和配置结合成为发布版本</figcaption></figure>
<p><strong>12-factor 应用严格区分构建，发布，运行这三个步骤。</strong> 举例来说，直接修改处于运行状态的代码是非常不可取的做法，因为这些修改很难再同步回构建步骤。</p>
<p>部署工具通常都提供了发布管理工具，最引人注目的功能是退回至较旧的发布版本。比如， <a href="https://github.com/capistrano/capistrano/wiki" target="_blank" rel="noopener noreferrer">Capistrano</a>  将所有发布版本都存储在一个叫 <code>releases</code> 的子目录中，当前的在线版本只需映射至对应的目录即可。该工具的 <code>rollback</code> 命令可以很容易地实现回退版本的功能。</p>
<p>每一个发布版本必须对应一个唯一的发布 ID，例如可以使用发布时的时间戳（<code>2011-04-06-20:32:17</code>），亦或是一个增长的数字（<code>v100</code>）。发布的版本就像一本只能追加的账本，一旦发布就不可修改，任何的变动都应该产生一个新的发布版本。</p>
<p>新的代码在部署之前，需要开发人员触发构建操作。但是，运行阶段不一定需要人为触发，而是可以自动进行。如服务器重启，或是进程管理器重启了一个崩溃的进程。因此，运行阶段应该保持尽可能少的模块，这样假设半夜发生系统故障而开发人员又捉襟见肘也不会引起太大问题。构建阶段是可以相对复杂一些的，因为错误信息能够立刻展示在开发人员面前，从而得到妥善处理。</p>
<h2>VI. 进程</h2>
<h3>以一个或多个无状态进程运行应用</h3>
<p>运行环境中，应用程序通常是以一个和多个 <em>进程</em> 运行的。</p>
<p>最简单的场景中，代码是一个独立的脚本，运行环境是开发人员自己的笔记本电脑，进程由一条命令行（例如<code>python my_script.py</code>）。另外一个极端情况是，复杂的应用可能会使用很多 <a href="./concurrency">进程类型</a> ，也就是零个或多个进程实例。</p>
<p><strong>12-Factor 应用的进程必须无状态且 <a href="http://en.wikipedia.org/wiki/Shared_nothing_architecture" target="_blank" rel="noopener noreferrer">无共享</a> 。</strong> 任何需要持久化的数据都要存储在 <a href="./backing-services">后端服务</a> 内，比如数据库。</p>
<p>内存区域或磁盘空间可以作为进程在做某种事务型操作时的缓存，例如下载一个很大的文件，对其操作并将结果写入数据库的过程。12-Factor应用根本不用考虑这些缓存的内容是不是可以保留给之后的请求来使用，这是因为应用启动了多种类型的进程，将来的请求多半会由其他进程来服务。即使在只有一个进程的情形下，先前保存的数据（内存或文件系统中）也会因为重启（如代码部署、配置更改、或运行环境将进程调度至另一个物理区域执行）而丢失。</p>
<p>源文件打包工具（<a href="http://documentcloud.github.io/jammit/" target="_blank" rel="noopener noreferrer">Jammit</a>, <a href="http://django-compressor.readthedocs.org/" target="_blank" rel="noopener noreferrer">django-compressor</a>） 使用文件系统来缓存编译过的源文件。12-Factor 应用更倾向于在 <a href="./build-release-run">构建步骤</a> 做此动作——正如 <a href="http://guides.rubyonrails.org/asset_pipeline.html" target="_blank" rel="noopener noreferrer">Rails资源管道</a> ，而不是在运行阶段。</p>
<p>一些互联网系统依赖于 “<a href="http://en.wikipedia.org/wiki/Load_balancing_%28computing%29#Persistence" target="_blank" rel="noopener noreferrer">粘性 session </a>”， 这是指将用户 session 中的数据缓存至某进程的内存中，并将同一用户的后续请求路由到同一个进程。粘性 session 是 12-Factor 极力反对的。Session 中的数据应该保存在诸如 <a href="http://memcached.org/" target="_blank" rel="noopener noreferrer">Memcached</a> 或 <a href="http://redis.io/" target="_blank" rel="noopener noreferrer">Redis</a> 这样的带有过期时间的缓存中。</p>
<h2>VII. 端口绑定</h2>
<h3>通过端口绑定(<em>Port binding</em>)来提供服务</h3>
<p>互联网应用有时会运行于服务器的容器之中。例如 PHP 经常作为 <a href="http://httpd.apache.org/" target="_blank" rel="noopener noreferrer">Apache HTTPD</a> 的一个模块来运行，正如 Java 运行于 <a href="http://tomcat.apache.org/" target="_blank" rel="noopener noreferrer">Tomcat</a> 。</p>
<p><strong>12-Factor 应用完全自我加载</strong> 而不依赖于任何网络服务器就可以创建一个面向网络的服务。互联网应用 <strong>通过端口绑定来提供服务</strong> ，并监听发送至该端口的请求。</p>
<p>本地环境中，开发人员通过类似<code>http://localhost:5000/</code>的地址来访问服务。在线上环境中，请求统一发送至公共域名而后路由至绑定了端口的网络进程。</p>
<p>通常的实现思路是，将网络服务器类库通过 <a href="./dependencies">依赖声明</a> 载入应用。例如，Python 的 <a href="http://www.tornadoweb.org/" target="_blank" rel="noopener noreferrer">Tornado</a>, Ruby 的<a href="http://code.macournoyer.com/thin/" target="_blank" rel="noopener noreferrer">Thin</a> , Java 以及其他基于 JVM 语言的 <a href="http://www.eclipse.org/jetty/" target="_blank" rel="noopener noreferrer">Jetty</a>。完全由 <em>用户端</em> ，确切的说应该是应用的代码，发起请求。和运行环境约定好绑定的端口即可处理这些请求。</p>
<p>HTTP 并不是唯一一个可以由端口绑定提供的服务。其实几乎所有服务器软件都可以通过进程绑定端口来等待请求。例如，使用 <a href="http://xmpp.org/" target="_blank" rel="noopener noreferrer">XMPP</a> 的 <a href="http://www.ejabberd.im/" target="_blank" rel="noopener noreferrer">ejabberd</a>  ， 以及使用 <a href="http://redis.io/topics/protocol" target="_blank" rel="noopener noreferrer">Redis 协议</a> 的 <a href="http://redis.io/" target="_blank" rel="noopener noreferrer">Redis</a> 。</p>
<p>还要指出的是，端口绑定这种方式也意味着一个应用可以成为另外一个应用的 <a href="./backing-services">后端服务</a> ，调用方将服务方提供的相应 URL 当作资源存入 <a href="./config">配置</a> 以备将来调用。</p>
<h2>VIII. 并发</h2>
<h3>通过进程模型进行扩展</h3>
<p>任何计算机程序，一旦启动，就会生成一个或多个进程。互联网应用采用多种进程运行方式。例如，PHP 进程作为 Apache 的子进程存在，随请求按需启动。Java 进程则采取了相反的方式，在程序启动之初 JVM 就提供了一个超级进程储备了大量的系统资源(CPU 和内存)，并通过多线程实现内部的并发管理。上述 2 个例子中，进程是开发人员可以操作的最小单位。</p>
<figure><figcaption>扩展表现为运行中的进程，工作多样性表现为进程类型。</figcaption></figure>
<p>**在 12-factor 应用中，进程是一等公民。**12-Factor 应用的进程主要借鉴于 <a href="https://adam.herokuapp.com/past/2011/5/9/applying_the_unix_process_model_to_web_apps/" target="_blank" rel="noopener noreferrer">unix 守护进程模型</a> 。开发人员可以运用这个模型去设计应用架构，将不同的工作分配给不同的 <em>进程类型</em> 。例如，HTTP 请求可以交给 web 进程来处理，而常驻的后台工作则交由 worker 进程负责。</p>
<p>这并不包括个别较为特殊的进程，例如通过虚拟机的线程处理并发的内部运算，或是使用诸如 <a href="https://github.com/eventmachine/eventmachine" target="_blank" rel="noopener noreferrer">EventMachine</a>, <a href="http://twistedmatrix.com/trac/" target="_blank" rel="noopener noreferrer">Twisted</a>,  <a href="http://nodejs.org/" target="_blank" rel="noopener noreferrer">Node.js</a> 的异步/事件触发模型。但一台独立的虚拟机的扩展有瓶颈（垂直扩展），所以应用程序必须可以在多台物理机器间跨进程工作。</p>
<p>上述进程模型会在系统急需扩展时大放异彩。 <a href="./processes">12-Factor 应用的进程所具备的无共享，水平分区的特性</a> 意味着添加并发会变得简单而稳妥。这些进程的类型以及每个类型中进程的数量就被称作 <em>进程构成</em> 。</p>
<p>12-Factor 应用的进程 <a href="http://dustin.github.com/2010/02/28/running-processes.html" target="_blank" rel="noopener noreferrer">不需要守护进程</a> 或是写入 PID 文件。相反的，应该借助操作系统的进程管理器(例如 <a href="https://www.freedesktop.org/wiki/Software/systemd/" target="_blank" rel="noopener noreferrer">systemd</a> ，分布式的进程管理云平台，或是类似 <a href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html" target="_blank" rel="noopener noreferrer">Foreman</a> 的工具)，来管理 <a href="./logs">输出流</a> ，响应崩溃的进程，以及处理用户触发的重启和关闭超级进程的请求。</p>
<h2>IX. 易处理</h2>
<h3>快速启动和优雅终止可最大化健壮性</h3>
<p>**12-Factor 应用的 <a href="./processes">进程</a> 是 <em>易处理（disposable）<em>的，意思是说它们可以瞬间开启或停止。</em></em> 这有利于快速、弹性的伸缩应用，迅速部署变化的 <a href="./codebase">代码</a> 或 <a href="./config">配置</a> ，稳健的部署应用。</p>
<p>进程应当追求 <strong>最小启动时间</strong> 。 理想状态下，进程从敲下命令到真正启动并等待请求的时间应该只需很短的时间。更少的启动时间提供了更敏捷的 <a href="./build-release-run">发布</a> 以及扩展过程，此外还增加了健壮性，因为进程管理器可以在授权情形下容易的将进程搬到新的物理机器上。</p>
<p>进程 <strong>一旦接收 <a href="http://en.wikipedia.org/wiki/SIGTERM" target="_blank" rel="noopener noreferrer">终止信号（<code>SIGTERM</code>）</a> 就会优雅的终止</strong> 。就网络进程而言，优雅终止是指停止监听服务的端口，即拒绝所有新的请求，并继续执行当前已接收的请求，然后退出。此类型的进程所隐含的要求是HTTP请求大多都很短(不会超过几秒钟)，而在长时间轮询中，客户端在丢失连接后应该马上尝试重连。</p>
<p>对于 worker 进程来说，优雅终止是指将当前任务退回队列。例如，<a href="http://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a> 中，worker 可以发送一个<a href="http://www.rabbitmq.com/amqp-0-9-1-quickref.html#basic.nack" target="_blank" rel="noopener noreferrer"><code>NACK</code></a>信号。 <a href="https://beanstalkd.github.io" target="_blank" rel="noopener noreferrer">Beanstalkd</a> 中，任务终止并退回队列会在worker断开时自动触发。有锁机制的系统诸如 <a href="https://github.com/collectiveidea/delayed_job#readme" target="_blank" rel="noopener noreferrer">Delayed Job</a> 则需要确定释放了系统资源。此类型的进程所隐含的要求是，任务都应该 <a href="http://en.wikipedia.org/wiki/Reentrant_%28subroutine%29" target="_blank" rel="noopener noreferrer">可重复执行</a> ， 这主要由将结果包装进事务或是使重复操作 <a href="http://en.wikipedia.org/wiki/Idempotence" target="_blank" rel="noopener noreferrer">幂等</a> 来实现。</p>
<p>进程还应当<strong>在面对突然死亡时保持健壮</strong>，例如底层硬件故障。虽然这种情况比起优雅终止来说少之又少，但终究有可能发生。一种推荐的方式是使用一个健壮的后端队列，例如 <a href="https://beanstalkd.github.io" target="_blank" rel="noopener noreferrer">Beanstalkd</a> ，它可以在客户端断开或超时后自动退回任务。无论如何，12-Factor 应用都应该可以设计能够应对意外的、不优雅的终结。<a href="http://lwn.net/Articles/191059/" target="_blank" rel="noopener noreferrer">Crash-only design</a> 将这种概念转化为 <a href="http://couchdb.apache.org/docs/overview.html" target="_blank" rel="noopener noreferrer">合乎逻辑的理论</a>。</p>
<h2>X. 开发环境与线上环境等价</h2>
<h3>尽可能的保持开发，预发布，线上环境相同</h3>
<p>从以往经验来看，开发环境（即开发人员的本地 <a href="./codebase">部署</a>）和线上环境（外部用户访问的真实部署）之间存在着很多差异。这些差异表现在以下三个方面：</p>
<ul>
<li><strong>时间差异：</strong> 开发人员正在编写的代码可能需要几天，几周，甚至几个月才会上线。</li>
<li><strong>人员差异：</strong> 开发人员编写代码，运维人员部署代码。</li>
<li><strong>工具差异：</strong> 开发人员或许使用 Nginx，SQLite，OS X，而线上环境使用 Apache，MySQL 以及 Linux。</li>
</ul>
<p><strong>12-Factor 应用想要做到 <a href="http://avc.com/2011/02/continuous-deployment/" target="_blank" rel="noopener noreferrer">持续部署</a> 就必须缩小本地与线上差异。</strong> 再回头看上面所描述的三个差异:</p>
<ul>
<li>缩小时间差异：开发人员可以几小时，甚至几分钟就部署代码。</li>
<li>缩小人员差异：开发人员不只要编写代码，更应该密切参与部署过程以及代码在线上的表现。</li>
<li>缩小工具差异：尽量保证开发环境以及线上环境的一致性。</li>
</ul>
<p>将上述总结变为一个表格如下：</p>
<table>
  <tbody><tr>
    <th></th>
    <th>传统应用</th>
    <th>12-Factor 应用</th>
  </tr>
  <tr>
    <th>每次部署间隔</th>
    <td>数周</td>
    <td>几小时</td>
  </tr>
  <tr>
    <th>开发人员 vs 运维人员</th>
    <td>不同的人</td>
    <td>相同的人</td>
  </tr>
  <tr>
    <th>开发环境 vs 线上环境</th>
    <td>不同</td>
    <td>尽量接近</td>
  </tr>
</tbody></table>
<p><a href="./backing-services">后端服务</a> 是保持开发与线上等价的重要部分，例如数据库，队列系统，以及缓存。许多语言都提供了简化获取后端服务的类库，例如不同类型服务的 <em>适配器</em> 。下列表格提供了一些例子。</p>
<table>
  <tbody><tr>
    <th>类型</th>
    <th>语言</th>
    <th>类库</th>
    <th>适配器</th>
  </tr>
  <tr>
    <td>数据库</td>
    <td>Ruby/Rails</td>
    <td>ActiveRecord</td>
    <td>MySQL, PostgreSQL, SQLite</td>
  </tr>
  <tr>
    <td>队列</td>
    <td>Python/Django</td>
    <td>Celery</td>
    <td>RabbitMQ, Beanstalkd, Redis</td>
  </tr>
  <tr>
    <td>缓存</td>
    <td>Ruby/Rails</td>
    <td>ActiveSupport::Cache</td>
    <td>Memory, filesystem, Memcached</td>
  </tr>
</tbody></table>
<p>开发人员有时会觉得在本地环境中使用轻量的后端服务具有很强的吸引力，而那些更重量级的健壮的后端服务应该使用在生产环境。例如，本地使用 SQLite 线上使用 PostgreSQL；又如本地缓存在进程内存中而线上存入 Memcached。</p>
<p><strong>12-Factor 应用的开发人员应该反对在不同环境间使用不同的后端服务</strong> ，即使适配器已经可以几乎消除使用上的差异。这是因为，不同的后端服务意味着会突然出现的不兼容，从而导致测试、预发布都正常的代码在线上出现问题。这些错误会给持续部署带来阻力。从应用程序的生命周期来看，消除这种阻力需要花费很大的代价。</p>
<p>与此同时，轻量的本地服务也不像以前那样引人注目。借助于<a href="http://mxcl.github.com/homebrew/" target="_blank" rel="noopener noreferrer">Homebrew</a>，<a href="https://help.ubuntu.com/community/AptGet/Howto" target="_blank" rel="noopener noreferrer">apt-get</a>等现代的打包系统，诸如Memcached、PostgreSQL、RabbitMQ 等后端服务的安装与运行也并不复杂。此外，使用类似 <a href="http://www.opscode.com/chef/" target="_blank" rel="noopener noreferrer">Chef</a> 和 <a href="http://docs.puppetlabs.com/" target="_blank" rel="noopener noreferrer">Puppet</a> 的声明式配置工具，结合像 <a href="http://vagrantup.com/" target="_blank" rel="noopener noreferrer">Vagrant</a> 这样轻量的虚拟环境就可以使得开发人员的本地环境与线上环境无限接近。与同步环境和持续部署所带来的益处相比，安装这些系统显然是值得的。</p>
<p>不同后端服务的适配器仍然是有用的，因为它们可以使移植后端服务变得简单。但应用的所有部署，这其中包括开发、预发布以及线上环境，都应该使用同一个后端服务的相同版本。</p>
<h2>XI. 日志</h2>
<h3>把日志当作事件流</h3>
<p><em>日志</em> 使得应用程序运行的动作变得透明。在基于服务器的环境中，日志通常被写在硬盘的一个文件里，但这只是一种输出格式。</p>
<p>日志应该是 <a href="https://adam.herokuapp.com/past/2011/4/1/logs_are_streams_not_files/" target="_blank" rel="noopener noreferrer">事件流</a> 的汇总，将所有运行中进程和后端服务的输出流按照时间顺序收集起来。尽管在回溯问题时可能需要看很多行，日志最原始的格式确实是一个事件一行。日志没有确定开始和结束，但随着应用在运行会持续的增加。</p>
<p><strong>12-factor应用本身从不考虑存储自己的输出流。</strong> 不应该试图去写或者管理日志文件。相反，每一个运行的进程都会直接的标准输出（<code>stdout</code>）事件流。开发环境中，开发人员可以通过这些数据流，实时在终端看到应用的活动。</p>
<p>在预发布或线上部署中，每个进程的输出流由运行环境截获，并将其他输出流整理在一起，然后一并发送给一个或多个最终的处理程序，用于查看或是长期存档。这些存档路径对于应用来说不可见也不可配置，而是完全交给程序的运行环境管理。类似 <a href="https://github.com/heroku/logplex" target="_blank" rel="noopener noreferrer">Logplex</a> 和 <a href="https://github.com/fluent/fluentd" target="_blank" rel="noopener noreferrer">Fluentd</a> 的开源工具可以达到这个目的。</p>
<p>这些事件流可以输出至文件，或者在终端实时观察。最重要的，输出流可以发送到 <a href="http://www.splunk.com/" target="_blank" rel="noopener noreferrer">Splunk</a> 这样的日志索引及分析系统，或 <a href="http://hive.apache.org/" target="_blank" rel="noopener noreferrer">Hadoop/Hive</a> 这样的通用数据存储系统。这些系统为查看应用的历史活动提供了强大而灵活的功能，包括：</p>
<ul>
<li>找出过去一段时间特殊的事件。</li>
<li>图形化一个大规模的趋势，比如每分钟的请求量。</li>
<li>根据用户定义的条件实时触发警报，比如每分钟的报错超过某个警戒线。</li>
</ul>
<h2>XII. 管理进程</h2>
<h3>后台管理任务当作一次性进程运行</h3>
<p><a href="./concurrency">进程构成</a>（process formation）是指用来处理应用的常规业务（比如处理 web 请求）的一组进程。与此不同，开发人员经常希望执行一些管理或维护应用的一次性任务，例如：</p>
<ul>
<li>运行数据移植（Django 中的 <code>manage.py migrate</code>, Rails 中的 <code>rake db:migrate</code>）。</li>
<li>运行一个控制台（也被称为 <a href="http://en.wikipedia.org/wiki/Read-eval-print_loop" target="_blank" rel="noopener noreferrer">REPL</a> shell），来执行一些代码或是针对线上数据库做一些检查。大多数语言都通过解释器提供了一个 REPL 工具（<code>python</code> 或 <code>perl</code>） ，或是其他命令（Ruby 使用 <code>irb</code>, Rails 使用 <code>rails console</code>）。</li>
<li>运行一些提交到代码仓库的一次性脚本。</li>
</ul>
<p>一次性管理进程应该和正常的 <a href="./processes">常驻进程</a> 使用同样的环境。这些管理进程和任何其他的进程一样使用相同的 <a href="./codebase">代码</a> 和 <a href="./config">配置</a> ，基于某个 <a href="./build-release-run">发布版本</a> 运行。后台管理代码应该随其他应用程序代码一起发布，从而避免同步问题。</p>
<p>所有进程类型应该使用同样的 <a href="./dependencies">依赖隔离</a> 技术。例如，如果Ruby的web进程使用了命令 <code>bundle exec thin start</code> ，那么数据库移植应使用 <code>bundle exec rake db:migrate</code> 。同样的，如果一个 Python 程序使用了 Virtualenv，则需要在运行 Tornado Web 服务器和任何 <code>manage.py</code> 管理进程时引入 <code>bin/python</code> 。</p>
<p>12-factor 尤其青睐那些提供了 REPL shell 的语言，因为那会让运行一次性脚本变得简单。在本地部署中，开发人员直接在命令行使用 shell 命令调用一次性管理进程。在线上部署中，开发人员依旧可以使用ssh或是运行环境提供的其他机制来运行这样的进程。</p>
]]></content>
    <author>
      <name>heroku</name>
    </author>
    <category term="转载"/>
    <contributor>
      <name>heroku</name>
    </contributor>
    <published>2024-05-11T00:00:00.000Z</published>
    <rights>Copyright by heroku</rights>
  </entry>
  <entry>
    <title type="text">基于Redis实现消息到期提醒</title>
    <id>http://blog.cjhe.top/database/redis/deadline-message.html</id>
    <link href="http://blog.cjhe.top/database/redis/deadline-message.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>业务上需求，希望实现一个消息到期提醒的功能，比如：提前两个小时发送预警信息、到期发送超期信息等。</p>
<p>实现该功能有很多技术方案，本文探讨：如何通过Redis实现消息到期提醒</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>业务上需求，希望实现一个消息到期提醒的功能，比如：提前两个小时发送预警信息、到期发送超期信息等。</p>
<p>实现该功能有很多技术方案，本文探讨：如何通过Redis实现消息到期提醒</p>
</blockquote>
<!-- more -->
<h2>背景知识</h2>
<p>Redis键空间通知（Keyspace Notifications）是Redis 2.8.0版本引入的一种消息通知机制，用于订阅和发布Redis键空间事件。</p>
<p>本质上：Redis键空间通知通过发布/订阅（pub/sub）模式实现，当某些事件发生时，Redis会自动发布消息，如果有客户端订阅了这些消息，就会收到该消息。</p>
<p>键空间通知会发送两种不同类型的事件消息：</p>
<ul>
<li>keyspace：键空间通知，当键空间中的键被创建、删除、过期、修改等操作时触发。</li>
<li>keyevent：键事件通知，当键空间中的键被创建、删除、过期、修改等操作时触发。</li>
</ul>
<p>例如：对数据库<code>0</code>中名为<code>mykey</code>的键上执行删除操作，将触发两条消息通知，等同于：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>PUBLISH __keyspace@0__:mykey del
PUBLISH __keyevent@0__:del "mykey"
</code></pre></div><p>格式为：<code>__{keyspace|keyevent}@{db}__:{KeyPattern|OpsType}</code>, 其中：</p>
<ul>
<li><code>__keyspace@{db}__:{KeyPattern}</code>：键空间通知前缀，表示该消息是键空间通知消息。</li>
<li><code>__keyevent@{db}__:{OpsType}</code>：键事件通知前缀，表示该消息是键事件通知消息。</li>
<li><code>{db}</code>：数据库编号，表示该消息是哪个数据库的消息。</li>
<li><code>{KeyPattern}</code>：键模式，支持通配符*。</li>
<li><code>{OpsType}</code>:表示操作类型，比如：expired</li>
</ul>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>由于本质上基于消息订阅，因此，当有客户端未订阅该消息或者断开连接期间，消息会丢失。</p>
</div>
<h2>配置修改</h2>
<blockquote>
<p>对于键空间通知，需要修改Redis配置文件，启用键空间通知功能。</p>
</blockquote>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>notify-keyspace-events Kx
</code></pre></div><p>配置含义：</p>
<ul>
<li>K：表示键空间通知，以<code>__keyspace@&lt;db&gt;__</code>前缀发布消息。</li>
<li>E：表示键事件通知，以<code>__keyevent@&lt;db&gt;__</code>前缀发布消息。</li>
<li>g：DEL、EXPIRE、RENAME等类型的事件发生时发布消息。</li>
<li>$：字符串类型键值对发生变化时发布消息。</li>
<li>l：列表类型键值对发生变化时发布消息。</li>
<li>s：集合类型键值对发生变化时发布消息。</li>
<li>h：哈希类型键值对发生变化时发布消息。</li>
<li>z：有序集合类型键值对发生变化时发布消息。</li>
<li>t: 流类型键值对发送变化时发布消息。</li>
<li>x：过期事件：每当有过期键被删除时发送。</li>
<li>e: 驱逐事件：每当有键因为maxmemory政策而被删除时发送。</li>
<li>m: 未命中事件，每当有键没有命中时发送。</li>
<li>A：等价于：g$lshztxed，相当于是all。</li>
</ul>
<p>例如：<code>Kx</code>表示当键过期时触发键空间事件通知。</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; config get notify-keyspace-events
1) "notify-keyspace-events"
2) ""
127.0.0.1:6379&gt; config set notify-keyspace-events Kx
OK
127.0.0.1:6379&gt; config get notify-keyspace-events
1) "notify-keyspace-events"
2) "xK"
127.0.0.1:6379&gt;
</code></pre></div><h2>测试</h2>
<p>开启第一个cli，订阅db0的keyspace消息：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; psubscribe __keyspace@0__:myid#*
Reading messages... (press Ctrl-C to quit)
1) "psubscribe"
2) "__keyspace@0__:myid#*"
3) (integer) 1
</code></pre></div><p>开启第二个cli，触发键过期事件</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; setex myid#123 10 xxx
OK
127.0.0.1:6379&gt;
</code></pre></div><p>再看第一个cli，10秒之后就收到消息：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; psubscribe __keyspace@0__:myid#*
Reading messages... (press Ctrl-C to quit)
1) "psubscribe"
2) "__keyspace@0__:myid#*"
3) (integer) 1
1) "pmessage"
2) "__keyspace@0__:myid#*"
3) "__keyspace@0__:myid#123"
4) "expired"
</code></pre></div><h2>参考文献</h2>
<ul>
<li><a href="https://redis.io/docs/latest/develop/use/keyspace-notifications/" target="_blank" rel="noopener noreferrer">官方文档</a></li>
<li><a href="https://blog.csdn.net/zhizhengguan/article/details/90575438" target="_blank" rel="noopener noreferrer">golang：redis订阅键空间过期消息</a></li>
</ul>
]]></content>
    <category term="数据存储"/>
    <published>2024-05-07T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Redis</title>
    <id>http://blog.cjhe.top/database/redis/</id>
    <link href="http://blog.cjhe.top/database/redis/"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <content type="html"><![CDATA[<!-- more -->
]]></content>
    <category term="数据存储"/>
    <published>2024-05-07T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">算法推荐</title>
    <id>http://blog.cjhe.top/algorithm/recommend.html</id>
    <link href="http://blog.cjhe.top/algorithm/recommend.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">在线书籍

数据结构和算法动态可视化
算法可视化
在线运行代码的算法可视化
数据结构可视化
算法实现</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>在线书籍</h2>
<ul>
<li>数据结构和算法动态可视化<a href="https://visualgo.net/zh" target="_blank" rel="noopener noreferrer"></a></li>
<li>算法可视化<a href="https://www.chrislaux.com/" target="_blank" rel="noopener noreferrer"></a></li>
<li>在线运行代码的算法可视化<a href="https://algorithm-visualizer.org/" target="_blank" rel="noopener noreferrer"></a></li>
<li>数据结构可视化<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" target="_blank" rel="noopener noreferrer"></a></li>
<li>算法实现<a href="https://the-algorithms.com/" target="_blank" rel="noopener noreferrer"></a></li>
</ul>
]]></content>
    <category term="算法"/>
    <published>2023-08-14T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">设计模式推荐</title>
    <id>http://blog.cjhe.top/design-pattern/recommend.html</id>
    <link href="http://blog.cjhe.top/design-pattern/recommend.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">在线书籍</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>在线书籍</h2>
]]></content>
    <category term="设计模式"/>
    <published>2022-09-10T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">中间件推荐</title>
    <id>http://blog.cjhe.top/middleware/recommend.html</id>
    <link href="http://blog.cjhe.top/middleware/recommend.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">在线书籍

Prometheus告警</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>在线书籍</h2>
<ul>
<li>Prometheus告警<a href="https://awesome-prometheus-alerts.grep.to/" target="_blank" rel="noopener noreferrer"></a></li>
</ul>
]]></content>
    <category term="中间件"/>
    <published>2023-08-14T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">转载</title>
    <id>http://blog.cjhe.top/share/</id>
    <link href="http://blog.cjhe.top/share/"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <content type="html"><![CDATA[<!-- more -->
]]></content>
    <category term="转载"/>
    <published>2023-03-04T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">工具推荐</title>
    <id>http://blog.cjhe.top/tools/recommend.html</id>
    <link href="http://blog.cjhe.top/tools/recommend.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">在线书籍

鸟哥的Linux私房菜
TLCL
精彩的Linux命令
命令行的艺术
CURL使用</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>在线书籍</h2>
<ul>
<li>鸟哥的Linux私房菜<a href="http://cn.linux.vbird.org/linux_basic/linux_basic.php" target="_blank" rel="noopener noreferrer"></a></li>
<li>TLCL<a href="http://billie66.github.io/TLCL/book/" target="_blank" rel="noopener noreferrer"></a></li>
<li>精彩的Linux命令<a href="https://www.cnblogs.com/nineep/p/6795650.html" target="_blank" rel="noopener noreferrer"></a></li>
<li>命令行的艺术<a href="https://github.com/jlevy/the-art-of-command-line/blob/master/README-zh.md" target="_blank" rel="noopener noreferrer"></a></li>
<li>CURL使用<a href="https://everything.curl.dev/" target="_blank" rel="noopener noreferrer"></a></li>
</ul>
]]></content>
    <category term="工具"/>
    <published>2023-07-30T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">docker推荐</title>
    <id>http://blog.cjhe.top/devops/docker/recommand.html</id>
    <link href="http://blog.cjhe.top/devops/docker/recommand.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">在线书籍

Docker-从入门到实践
Docker中文文档</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>在线书籍</h2>
<ul>
<li>Docker-从入门到实践<a href="https://www.cntofu.com/book/139/index.html" target="_blank" rel="noopener noreferrer"></a></li>
<li>Docker中文文档<a href="http://www.dockerinfo.net/document" target="_blank" rel="noopener noreferrer"></a></li>
</ul>
]]></content>
    <category term="devops"/>
    <published>2024-03-18T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">k8s推荐</title>
    <id>http://blog.cjhe.top/devops/k8s/recommand.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/recommand.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">在线书籍

从Docker到kubernetes进阶
Kubernetes中文指南</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>在线书籍</h2>
<ul>
<li>从Docker到kubernetes进阶<a href="https://www.qikqiak.com/k8s-book/" target="_blank" rel="noopener noreferrer"></a></li>
<li>Kubernetes中文指南<a href="https://jimmysong.io/kubernetes-handbook/" target="_blank" rel="noopener noreferrer"></a></li>
</ul>
]]></content>
    <category term="devops"/>
    <published>2024-01-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">组件通信</title>
    <id>http://blog.cjhe.top/language/vue/advance/communication.html</id>
    <link href="http://blog.cjhe.top/language/vue/advance/communication.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">组件通信
自定义属性-props

父组件向子组件传递数据

父组件
 子组件
   
注意

单向数据流
子组件不能修改父组件传递的值


自定义事件-$emit

子组件向父组件传递数据

父组件
 子组件
事件总线-$bus

适合任意组件之间的通信，比如：兄弟组件、父子组件等。

事件总线
首先安装mitt
父组件
哥哥组件
弟弟组件
v-mo...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>组件通信</h2>
<h3>自定义属性-props</h3>
<blockquote>
<p>父组件向子组件传递数据</p>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">:msg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>msg<span class="token punctuation">"</span></span> <span class="token attr-name">:count</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>&lt;template&gt;
    &lt;div class="child"&gt;
        &lt;h1&gt;子组件&lt;/h1&gt;
        &lt;h6&gt;msg:{{ props.msg }}&lt;/h6&gt;
        &lt;button @click="handler"&gt;count:{{ count }}&lt;/button&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { defineProps } from 'vue'
let props = defineProps({
    msg: String,
    count: Number,
});

const handler = () =&gt; {
    //props.count += 1; // 这样会报错，因为props是只读的
    console.log(props.count);
};
&lt;/script&gt;
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>单向数据流</li>
<li>子组件不能修改父组件传递的值</li>
</ul>
</div>
<h3>自定义事件-$emit</h3>
<blockquote>
<p>子组件向父组件传递数据</p>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>子组件传递过来的数据：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item in list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ item }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">@my-event</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'子传父的数据'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    list<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$emit('my-event', 'Hello')<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>触发事件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>触发事件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">let</span> $emit <span class="token operator">=</span> <span class="token function">defineEmits</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'my-event'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'my-event'</span><span class="token punctuation">,</span> <span class="token string">'World'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>事件总线-$bus</h3>
<blockquote>
<p>适合任意组件之间的通信，比如：兄弟组件、父子组件等。</p>
</blockquote>
<p>事件总线</p>
<p>首先安装mitt</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> mitt 
</code></pre></div><div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code>import mitt from 'mitt';

const $bus = mitt();

export default $bus;
</code></pre></div><p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>没收玩具<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child1</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child2</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child1 <span class="token keyword">from</span> <span class="token string">'./Child1.vue'</span>
<span class="token keyword">import</span> Child2 <span class="token keyword">from</span> <span class="token string">'./Child2.vue'</span>
<span class="token keyword">import</span> $bus <span class="token keyword">from</span> <span class="token string">'@/bus'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    $bus<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'clear-toy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>哥哥组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>哥哥组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>toy in toys<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ toy }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">v-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>toys.length &gt; 0<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>给弟弟一个玩具<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> $bus <span class="token keyword">from</span> <span class="token string">'@/bus'</span>

<span class="token keyword">let</span> toys <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'BB枪'</span><span class="token punctuation">,</span> <span class="token string">'变形金刚'</span><span class="token punctuation">,</span> <span class="token string">'赛车'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> toy <span class="token operator">=</span> toys<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    $bus<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'send-toy'</span><span class="token punctuation">,</span> toy<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    $bus<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'clear-toy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        toys<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>弟弟组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>弟弟组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>toy in toys<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ toy }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> $bus <span class="token keyword">from</span> <span class="token string">'@/bus'</span>

<span class="token keyword">let</span> toys <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'奥特曼'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    $bus<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'send-toy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">data</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        toys<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    $bus<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'clear-toy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        toys<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>v-model</h3>
<blockquote>
<p>父子组件双向数据同步，相当于：</p>
<ul>
<li>通过props传递modelValue，实现父到子传递数据</li>
<li>通过emit触发update:modelValue，实现子到父传递数据</li>
</ul>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        {{ msg }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>msg<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">:modelValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>msg<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">@update:</span>modelValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>msg = $event<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>msg:{{ props.modelValue }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>改变<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'modelValue'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> $emit <span class="token operator">=</span> <span class="token function">defineEmits</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'update:modelValue'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> msg <span class="token operator">=</span> props<span class="token punctuation">.</span>modelValue <span class="token operator">+</span> <span class="token string">' hello '</span>
    <span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'update:modelValue'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>useAttrs</h3>
<blockquote>
<p>用于传递属性和事件</p>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">:msg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>msg<span class="token punctuation">"</span></span> <span class="token attr-name">:count</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span> <span class="token attr-name">@xxx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">.</span>value<span class="token operator">++</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>msg:{{ $attrs.msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$attrs.onXxx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>count:{{ $attrs.count }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> useAttrs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">let</span> $attrs <span class="token operator">=</span> <span class="token function">useAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">useAttrs和defineProps的区别</p>
<ul>
<li>和使用 defineProps 接收属性时相比，useAttrs 的优先级要低</li>
<li>useAttrs：方法能够接收到所有属性，包括未在组件中声明的属性，但不能够对接收到的属性进行类型校验和默认值设置。</li>
<li>defineProps：方法只能接收到在组件中声明的属性，但能够对接收到的属性进行类型校验和默认值设置，使得组件能够更加健壮。</li>
</ul>
</div>
<h3>ref和$parent</h3>
<blockquote>
<p>ref用于：父-&gt;子
$parent用于：子-&gt;父</p>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span> 工资: {{ money }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>给孩子生活费<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>son<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> money <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token function">defineExpose</span><span class="token punctuation">(</span><span class="token punctuation">{</span> money <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> son <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    money<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token number">100</span>
    son<span class="token punctuation">.</span>value<span class="token punctuation">.</span>money <span class="token operator">+=</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span> 生活费: {{ money }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handle($parent)<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>要生活费<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> money <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token function">defineExpose</span><span class="token punctuation">(</span><span class="token punctuation">{</span> money <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">$parent</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    money<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">100</span>
    $parent<span class="token punctuation">.</span>money <span class="token operator">-=</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>provide和inject</h3>
<blockquote>
<p>常用于祖孙组件之间通信</p>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ count }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GrandChild</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GrandChild</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> GrandChild <span class="token keyword">from</span> <span class="token string">'./GrandChild.vue'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>孙组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grandchild<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>孙组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>count:{{ count }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>状态管理-pinia</h3>
<blockquote>
<p>任意组件之间通信</p>
</blockquote>
<p>store</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code>import { createPinia } from 'pinia';

let store = createPinia();

export default store;
</code></pre></div><p>store modules</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code>import { defineStore } from "pinia";
import { computed, ref } from "vue";

const useCountStore = defineStore('info', () =&gt; {
    const count = ref(0)
    const double = computed(() =&gt; {
        return count.value * 2
    })
    const increment = (num: number) =&gt; {
        count.value += num
    }
    return {
        count, double, increment
    }
});

export default useCountStore;
</code></pre></div><p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>count:{{ count }},double:{{ double }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child1</span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child2</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child1 <span class="token keyword">from</span> <span class="token string">'./Child1.vue'</span>
<span class="token keyword">import</span> Child2 <span class="token keyword">from</span> <span class="token string">'./Child2.vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> useCountStore <span class="token keyword">from</span> <span class="token string">'@/store/modules/count'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeToRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> countStore <span class="token operator">=</span> <span class="token function">useCountStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> double <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>countStore<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件1</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>count:{{ count }},double:{{ double }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> useCountStore <span class="token keyword">from</span> <span class="token string">'@/store/modules/count'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeToRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> countStore <span class="token operator">=</span> <span class="token function">useCountStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> double <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>countStore<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    countStore<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件2</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>count:{{ count }},double:{{ double }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> useCountStore <span class="token keyword">from</span> <span class="token string">'@/store/modules/count'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeToRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> countStore <span class="token operator">=</span> <span class="token function">useCountStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> double <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>countStore<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    countStore<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3>插槽-slot</h3>
<blockquote>
<p>实现父与子之间通信，不仅仅是数据，还可以包含页面结构</p>
</blockquote>
<p>父组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 默认插槽 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>父组件定义的内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 具名插槽 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>header</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>header<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 作用域插槽 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>footer</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ data }<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item in data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{ item }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Child</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./Child.vue'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子组件</p>
<div class="language-vue" data-ext="vue" data-title="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>child<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>子组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>默认插槽<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>==========<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>具名插槽<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>==========<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>作用域插槽<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>footer<span class="token punctuation">"</span></span> <span class="token attr-name">:data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>['a', 'b', 'c']<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>==========<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>]]></content>
    <category term="编程框架"/>
    <published>2024-04-30T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">编程语言&amp;框架</title>
    <id>http://blog.cjhe.top/language/</id>
    <link href="http://blog.cjhe.top/language/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <category term="编程语言"/>
    <category term="编程框架"/>
    <published>2024-04-29T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Vue框架</title>
    <id>http://blog.cjhe.top/language/vue/</id>
    <link href="http://blog.cjhe.top/language/vue/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <category term="编程框架"/>
    <published>2024-04-29T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Vue进阶</title>
    <id>http://blog.cjhe.top/language/vue/advance/</id>
    <link href="http://blog.cjhe.top/language/vue/advance/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <category term="编程框架"/>
    <published>2024-05-05T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Minio监控</title>
    <id>http://blog.cjhe.top/database/minio/minio-monitor.html</id>
    <link href="http://blog.cjhe.top/database/minio/minio-monitor.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="text">Minio监控
运行Minio Client(mc)容器
设置别名
输出结果：
生成 Prometheus 抓取目标配置
输出结果：
我们可以看到是通过bearer_token的方式获取指标，将上面生成的抓取目标配置同步到Prometheus
minio-dashboard
minio-dashboardminio-dashboard
minio常用监...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>Minio监控</h2>
<p>运行Minio Client(mc)容器</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--entrypoint</span><span class="token operator">=</span>/bin/sh minio/mc
</code></pre></div><p>设置别名</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mc</span> <span class="token builtin class-name">alias</span> <span class="token builtin class-name">set</span> minio http://172.100.2.65:9000 minioadmin minioadmin
</code></pre></div><p>输出结果：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>mc: Configuration written to `/root/.mc/config.json`. Please update your access credentials.
mc: Successfully created `/root/.mc/share`.
mc: Initialized share uploads `/root/.mc/share/uploads.json` file.
mc: Initialized share downloads `/root/.mc/share/downloads.json` file.
Added `minio` successfully.
</code></pre></div><p>生成 Prometheus 抓取目标配置</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mc</span> admin prometheus generate minio
</code></pre></div><p>输出结果：</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>scrape_configs:
- job_name: minio-job
  bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoibWluaW9hZG1pbiIsImV4cCI6NDg2NzAyNTgyOX0.QgEjjQvA1ieHhM8sxMxMhYGGOcmsN4dQT1lIcOHGe5Lo4ZTeTsgzKAq65HPBkFQ1RayMzolQ_R2J3aByVe_ZNw
  metrics_path: /minio/v2/metrics/cluster
  scheme: http
  static_configs:
  - targets: <span class="token punctuation">[</span><span class="token string">'172.100.2.65:9000'</span><span class="token punctuation">]</span>
</code></pre></div><p>我们可以看到是通过<code>bearer_token</code>的方式获取指标，将上面生成的抓取目标配置同步到Prometheus</p>
<h2>minio-dashboard</h2>
<figure><figcaption>minio-dashboard</figcaption></figure>
<h2>minio常用监控语句</h2>
<h3>minio集群节点离线</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>minio_cluster_nodes_offline_total &gt; 0
</code></pre></div><h3>minio集群磁盘离线</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>minio_cluster_drive_offline_total &gt; 0
</code></pre></div><h2>参考文献</h2>
<p><a href="https://min.io/docs/minio/linux/operations/monitoring/collect-minio-metrics-using-prometheus.html?ref=docs-redirect" target="_blank" rel="noopener noreferrer">Prometheus官方文档</a></p>
<p><a href="https://www.cnblogs.com/zmh520/p/17771438.html" target="_blank" rel="noopener noreferrer">minio部署及监控</a></p>
]]></content>
    <category term="数据存储"/>
    <published>2024-04-18T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go语言书籍</title>
    <id>http://blog.cjhe.top/language/go/recommend/book.html</id>
    <link href="http://blog.cjhe.top/language/go/recommend/book.html"/>
    <updated>2024-06-12T01:26:48.000Z</updated>
    <summary type="text">Go书籍
Go高级编程
Go语言设计与实现
Go语言四十二章经
Mastering Go
ApacheCN Golang 译文集
Go Patterns
Go语言标准库
Go测试驱动开发
Go练习
Go语言原本
Go语言编程之旅
Go程序员面试
Go的一些书籍地鼠文档
腾讯云开发者社区Go教程腾讯云
go语言190题</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>Go书籍</h2>
<p>Go高级编程<a href="https://books.studygolang.com/advanced-go-programming-book/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言设计与实现<a href="https://draveness.me/golang/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言四十二章经<a href="https://github.com/ffhelicopter/Go42" target="_blank" rel="noopener noreferrer"></a></p>
<p>Mastering Go<a href="https://wskdsgcf.gitbook.io/mastering-go-zh-cn/" target="_blank" rel="noopener noreferrer"></a></p>
<p>ApacheCN Golang 译文集<a href="https://go.apachecn.org/#/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go Patterns<a href="https://hxangel.gitbooks.io/go-patterns/content/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言标准库<a href="https://books.studygolang.com/The-Golang-Standard-Library-by-Example/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go测试驱动开发<a href="https://studygolang.gitbook.io/learn-go-with-tests/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go练习<a href="https://www.practical-go-lessons.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言原本<a href="https://golang.design/under-the-hood/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言编程之旅<a href="https://golang2.eddycjy.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go程序员面试<a href="https://golang.design/go-questions/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go的一些书籍<a href="https://topgoer.cn/" target="_blank" rel="noopener noreferrer">地鼠文档</a></p>
<p>腾讯云开发者社区Go教程<a href="https://cloud.tencent.com/developer/doc/1101" target="_blank" rel="noopener noreferrer">腾讯云</a></p>
<h3>go语言190题</h3>
]]></content>
    <category term="编程语言"/>
    <published>2024-04-16T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">MongoDB监控</title>
    <id>http://blog.cjhe.top/database/mongodb/mongodb-exporter.html</id>
    <link href="http://blog.cjhe.top/database/mongodb/mongodb-exporter.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="text">MongoDB监控
我们通过mongodb-exporter监控mongodb状态
mongodb-exporter部署
注意：

--collect-all，参数用于收集所有指标
--compatible-mode，用于兼容旧的指标，否则部分grafana的dashboard展示不兼容

mongodb-dashboard
mongodb-dashb...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>MongoDB监控</h2>
<p>我们通过mongodb-exporter监控mongodb状态</p>
<h2>mongodb-exporter部署</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9216</span>:9216 <span class="token parameter variable">-p</span> <span class="token number">17001</span>:17001 <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token parameter variable">--name</span><span class="token operator">=</span>mongodb_exporter percona/mongodb_exporter:0.40 <span class="token parameter variable">--mongodb.uri</span><span class="token operator">=</span>mongodb://172.87.7.247:27017/admin?ssl<span class="token operator">=</span>false --collect-all --compatible-mode
</code></pre></div><p>注意：</p>
<ul>
<li>--collect-all，参数用于收集所有指标</li>
<li>--compatible-mode，用于兼容旧的指标，否则部分grafana的dashboard展示不兼容</li>
</ul>
<h2>mongodb-dashboard</h2>
<figure><figcaption>mongodb-dashboard</figcaption></figure>
<h2>mongodb常用监控语句</h2>
<h3>监控数据库是否宕机</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>mongodb_up == 0
</code></pre></div>]]></content>
    <category term="数据存储"/>
    <published>2024-04-16T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go推荐</title>
    <id>http://blog.cjhe.top/language/go/recommend/</id>
    <link href="http://blog.cjhe.top/language/go/recommend/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <category term="编程语言"/>
    <published>2024-04-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Redis监控</title>
    <id>http://blog.cjhe.top/database/redis/redis-exporter.html</id>
    <link href="http://blog.cjhe.top/database/redis/redis-exporter.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="text">Redis监控
我们通过redis-exporter监控redis状态
redis-exporter部署
redis-dashboard
redis-dashboardredis-dashboard
redis常见监控语句
监控Redis是否宕机
Redis连接数过多</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>Redis监控</h2>
<p>我们通过redis-exporter监控redis状态</p>
<h2>redis-exporter部署</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> redis_exporter <span class="token parameter variable">--restart</span> always <span class="token parameter variable">-p</span> <span class="token number">9121</span>:9121 oliver006/redis_exporter <span class="token parameter variable">--redis.addr</span> redis://172.87.7.247:6379
</code></pre></div><h2>redis-dashboard</h2>
<figure><figcaption>redis-dashboard</figcaption></figure>
<h2>redis常见监控语句</h2>
<h3>监控Redis是否宕机</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>redis_up == 0
</code></pre></div><h3>Redis连接数过多</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>redis_connected_clients / redis_config_maxclients * 100 &gt; 90
</code></pre></div>]]></content>
    <category term="数据存储"/>
    <published>2024-04-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">MySQL监控</title>
    <id>http://blog.cjhe.top/database/mysql/mysql-exporter.html</id>
    <link href="http://blog.cjhe.top/database/mysql/mysql-exporter.html"/>
    <updated>2024-05-23T10:17:10.000Z</updated>
    <summary type="text">MySQL监控
我们通过mysqld-exporter去将MySQL相关状态转换成指标，从而进行监控
mysql-exporter部署
其中**.my.cnf**配置数据库连接信息，其内容如下：
[client]
host=your host
port=your port
user=your username
password=your passwor...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>MySQL监控</h2>
<p>我们通过mysqld-exporter去将MySQL相关状态转换成指标，从而进行监控</p>
<h2>mysql-exporter部署</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mysql_exporter <span class="token parameter variable">--restart</span> always <span class="token parameter variable">-p</span> <span class="token number">9104</span>:9104 <span class="token parameter variable">-v</span> ./.my.cnf:/.my.cnf prom/mysqld-exporter
</code></pre></div><p>其中**.my.cnf**配置数据库连接信息，其内容如下：
[client]
host=your host
port=your port
user=your username
password=your password</p>
<h2>mysql-grafana面板</h2>
<figure><figcaption>mysql-dashboard</figcaption></figure>
<h2>mysql常见监控语句</h2>
<h3>监控数据库是否宕机</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>mysql_up == 0
</code></pre></div><h3>监控数据库是否超过最大连接数80%</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>max_over_time(mysql_global_status_threads_connected[1m]) / mysql_global_variables_max_connections * 100 &gt; 80
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>如果超过最大连接数，会报<strong>Too many connections</strong>错误</p>
</div>
<h3>数据库慢查询</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>increase(mysql_global_status_slow_queries[1m]) &gt; 0
</code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-04-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">HTTP协议</title>
    <id>http://blog.cjhe.top/network/application-layer/HTTP.html</id>
    <link href="http://blog.cjhe.top/network/application-layer/HTTP.html"/>
    <updated>2024-04-15T09:57:53.000Z</updated>
    <summary type="text">HTTP协议是目前使用最为广泛的应用层协议

HTTP发展简史

1989 年：蒂姆·伯纳斯-李在 CERN 提出万维网的概念。
1991 年：蒂姆·伯纳斯-李发布 HTTP/0.9，HTTP 协议的第一个版本。
1996 年：HTTP/1.0 发布，引入了状态码、头字段和持久连接等新功能。
1997 年：HTTP/1.1 发布，对 HTTP/1.0 ...</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>HTTP协议是目前使用最为广泛的应用层协议</p>
</blockquote>
<h2>HTTP发展简史</h2>
<ul>
<li><strong>1989 年</strong>：蒂姆·伯纳斯-李在 CERN 提出万维网的概念。</li>
<li><strong>1991 年</strong>：蒂姆·伯纳斯-李发布 HTTP/0.9，HTTP 协议的第一个版本。</li>
<li><strong>1996 年</strong>：HTTP/1.0 发布，引入了状态码、头字段和持久连接等新功能。</li>
<li><strong>1997 年</strong>：HTTP/1.1 发布，对 HTTP/1.0 进行了重大更新，包括管道化请求、分块传输编码和主机头字段。</li>
<li><strong>2015 年</strong>：HTTP/2 发布，对 HTTP/1.1 进行了重大重新设计，重点是提高性能和效率。</li>
<li><strong>2022 年</strong>：HTTP/3 发布，HTTP/2 的最新版本，基于 QUIC 传输协议。</li>
</ul>
<p>HTTP/1.1 仍然是当今互联网上使用最广泛的 HTTP 版本，但 HTTP/2 和 HTTP/3 正在逐渐获得采用。随着时间的推移，预计 HTTP/3 将成为新的标准。</p>
<h2>HTTP方法</h2>
<figure><figcaption>http</figcaption></figure>
<p>HTTP 方法是客户端向服务器发送请求时所使用的动作。最常用的 HTTP 方法包括：</p>
<ul>
<li><strong>GET：</strong> 从服务器获取指定资源。这是最基本的 HTTP 方法，用于检索网页、图像或其他文件。</li>
<li><strong>POST：</strong> 向服务器提交数据以创建资源。通常用于提交表单数据或上传文件。</li>
<li><strong>PUT：</strong> 更新服务器上的现有资源。</li>
<li><strong>DELETE：</strong> 删除服务器上的资源。</li>
<li><strong>HEAD：</strong> 获取资源的元数据（如大小和内容类型），而不实际获取资源内容。</li>
<li><strong>OPTIONS：</strong> 获取服务器支持的 HTTP 方法和功能。</li>
<li><strong>PATCH：</strong> 部分更新服务器上的资源。</li>
</ul>
<p><strong>示例</strong></p>
<p>以下是一些 HTTP 方法的示例：</p>
<ul>
<li><code>GET /index.html HTTP/1.1</code>：从服务器获取 index.html 文件。</li>
<li><code>POST /submit-form HTTP/1.1</code>：向服务器提交表单数据。</li>
<li><code>PUT /users/1 HTTP/1.1</code>：更新服务器上 ID 为 1 的用户。</li>
<li><code>DELETE /files/image.png HTTP/1.1</code>：从服务器删除 image.png 文件。</li>
<li><code>HEAD /about-us HTTP/1.1</code>：获取关于我们页面的元数据。</li>
<li><code>OPTIONS /api/v1 HTTP/1.1</code>：获取 API 的功能信息。</li>
<li><code>PATCH /users/1 HTTP/1.1</code>：部分更新用户个人资料（例如，仅更新姓名）。</li>
</ul>
<h2>HTTP状态码</h2>
<p>TTP 状态码分为五类，每类表示一个不同的响应类别：</p>
<p><strong>1xx 信息响应</strong></p>
<ul>
<li>表示请求已收到并正在处理。</li>
<li>例如：
<ul>
<li>100 继续</li>
<li>101 切换协议</li>
</ul>
</li>
</ul>
<p><strong>2xx 成功响应</strong></p>
<ul>
<li>表示请求已成功处理。</li>
<li>例如：
<ul>
<li>200 OK</li>
<li>201 已创建</li>
<li>204 无内容</li>
</ul>
</li>
</ul>
<p><strong>3xx 重定向</strong></p>
<ul>
<li>表示需要进一步操作才能完成请求。</li>
<li>例如：
<ul>
<li>301 永久重定向</li>
<li>302 临时重定向</li>
<li>308 永久重定向</li>
</ul>
</li>
</ul>
<p><strong>4xx 客户端错误</strong></p>
<ul>
<li>表示客户端请求有误。</li>
<li>例如：
<ul>
<li>400 错误的请求</li>
<li>401 未经授权</li>
<li>404 未找到</li>
</ul>
</li>
</ul>
<p><strong>5xx 服务器错误</strong></p>
<ul>
<li>表示服务器在处理请求时遇到错误。</li>
<li>例如：
<ul>
<li>500 内部服务器错误</li>
<li>502 错误的网关</li>
<li>503 服务不可用</li>
</ul>
</li>
</ul>
<h2>参考链接</h2>
<p><a href="https://mp.weixin.qq.com/s/AuYEWkY9LN6TRrQvU-AaQA" target="_blank" rel="noopener noreferrer">HTTP发放和使用大全</a>
<a href="https://mp.weixin.qq.com/s/Q_BeNgqNWizwVkMkH39e7g" target="_blank" rel="noopener noreferrer">HTTP状态码完整指南</a>
<a href="https://mp.weixin.qq.com/s/VTFC8WEJTnoDzEtKsi48Aw" target="_blank" rel="noopener noreferrer">图解|什么是HTTP简史</a></p>
]]></content>
    <category term="网络"/>
    <published>2024-04-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">应用层协议</title>
    <id>http://blog.cjhe.top/network/application-layer/</id>
    <link href="http://blog.cjhe.top/network/application-layer/"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>本篇介绍计算机网络应用层协议</p>
</blockquote>
<p>常见的应用层协议：</p>
<ul>
<li>HTTP</li>
<li>DNS</li>
<li>Telnet</li>
<li>SSH</li>
<li>FTP</li>
<li>POP3</li>
<li>IMAP</li>
</ul>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>本篇介绍计算机网络应用层协议</p>
</blockquote>
<p>常见的应用层协议：</p>
<ul>
<li>HTTP</li>
<li>DNS</li>
<li>Telnet</li>
<li>SSH</li>
<li>FTP</li>
<li>POP3</li>
<li>IMAP</li>
</ul>
]]></content>
    <category term="网络"/>
    <published>2024-04-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">ICMP协议</title>
    <id>http://blog.cjhe.top/network/internet-layer/ICMP.html</id>
    <link href="http://blog.cjhe.top/network/internet-layer/ICMP.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">ICMP(Internet Control Message Protocol,互联网控制协议)，属于网络层协议。主要用于在IP主机和路由器之间传递控制信息，例如：主机是否可达、路由是否可用等。
ICMP使用IP协议发送信息，它虽然属于网络层协议，但严格来说，它位于IP之上。</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>ICMP(Internet Control Message Protocol,互联网控制协议)，属于网络层协议。主要用于在IP主机和路由器之间传递控制信息，例如：主机是否可达、路由是否可用等。</p>
<p>ICMP使用IP协议发送信息，它虽然属于网络层协议，但严格来说，它位于IP之上。</p>
]]></content>
    <category term="网络"/>
    <published>2023-11-13T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">网络层协议</title>
    <id>http://blog.cjhe.top/network/internet-layer/</id>
    <link href="http://blog.cjhe.top/network/internet-layer/"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>本篇介绍计算机网络网络层协议</p>
</blockquote>
<p>常见的网络层协议：</p>
<ul>
<li>IP</li>
<li>IPv6</li>
<li>ICMP</li>
<li>ARP</li>
</ul>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>本篇介绍计算机网络网络层协议</p>
</blockquote>
<p>常见的网络层协议：</p>
<ul>
<li>IP</li>
<li>IPv6</li>
<li>ICMP</li>
<li>ARP</li>
</ul>
]]></content>
    <category term="网络"/>
    <published>2024-04-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">链路层协议</title>
    <id>http://blog.cjhe.top/network/link-layer/</id>
    <link href="http://blog.cjhe.top/network/link-layer/"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>链路层协议比较偏底层，有机会再介绍</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>链路层协议比较偏底层，有机会再介绍</p>
</blockquote>
]]></content>
    <category term="网络"/>
    <published>2024-04-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">传输层协议</title>
    <id>http://blog.cjhe.top/network/transport-layer/</id>
    <link href="http://blog.cjhe.top/network/transport-layer/"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>本篇介绍计算机网络传输层协议</p>
</blockquote>
<p>常见的传输层协议：</p>
<ul>
<li>TCP</li>
<li>UDP</li>
</ul>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>本篇介绍计算机网络传输层协议</p>
</blockquote>
<p>常见的传输层协议：</p>
<ul>
<li>TCP</li>
<li>UDP</li>
</ul>
]]></content>
    <category term="网络"/>
    <published>2024-04-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">docker</title>
    <id>http://blog.cjhe.top/devops/docker/</id>
    <link href="http://blog.cjhe.top/devops/docker/"/>
    <updated>2024-05-08T06:55:14.000Z</updated>
    <category term="devops"/>
    <published>2024-03-18T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">容器执行报&amp;quot;no such file or directory&amp;quot;问题</title>
    <id>http://blog.cjhe.top/devops/docker/shell-line-break.html</id>
    <link href="http://blog.cjhe.top/devops/docker/shell-line-break.html"/>
    <updated>2024-03-18T11:54:34.000Z</updated>
    <summary type="html"><![CDATA[<p>同事运行docker镜像时，控制台报错"no such file or directory"，但是查看该文件确实存在，本文记录该问题的定位和解决。</p>
]]></summary>
    <content type="html"><![CDATA[<p>同事运行docker镜像时，控制台报错"no such file or directory"，但是查看该文件确实存在，本文记录该问题的定位和解决。</p>
<!-- more -->
<h3>查看镜像使用方式</h3>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>COPY xxx/run.sh /run.sh
<span class="token comment"># RUN命令</span>
RUN chmod 777 /run.sh
<span class="token comment"># 执行命令</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"/run.sh"</span><span class="token punctuation">]</span>
</code></pre></div><p>这里查看dockerfile，采用的是脚本方式启动服务进程，使用方式上并没有什么问题</p>
<h3>根据报错信息查看文件是否存在</h3>
<p>通过新增RUN命令:<code>RUN ls -al</code>,打印当前路径文件的方式确认是有<code>run.sh</code>脚本文件</p>
<h3>检查脚本文件</h3>
<p>对比了服务器的脚本文件和开发使用的脚本文件，仔细观察发现脚本文件唯一不同的是换行符不一样</p>
<ul>
<li>开发使用的是windows系统，换行符为<strong>CRLF</strong>,对应为:<code>\r\n</code></li>
<li>服务器使用的linux系统，换行符为<strong>LF</strong>，对应为:<code>\n</code></li>
</ul>
<h3>关键问题</h3>
<p>脚本第一行</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
</code></pre></div><p>表明使用<code>/bin/bash</code>来解释脚本，但如何后面有windows的换行符导致无法识别，因此会报错：“no such file or directory”</p>
<h3>问题结局</h3>
<p>通过修改<code>run.sh</code>的换行符为<strong>LF</strong>，问题得以解决。</p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>代码提交时，将文件换行符设置为LF格式。</p>
</div>
]]></content>
    <category term="devops"/>
    <published>2024-03-18T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">k8s</title>
    <id>http://blog.cjhe.top/devops/k8s/</id>
    <link href="http://blog.cjhe.top/devops/k8s/"/>
    <updated>2024-05-08T06:55:14.000Z</updated>
    <category term="devops"/>
    <published>2024-03-18T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Helm Dashboard简介</title>
    <id>http://blog.cjhe.top/devops/k8s/helm-dashboard.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/helm-dashboard.html"/>
    <updated>2024-04-25T10:51:45.000Z</updated>
    <summary type="html"><![CDATA[<p>helm-dashboard是helm的可视化界面，可以查看集群内通过helm部署的chart包。好处：不需要登录机器就可以升级、回滚chart包。</p>
]]></summary>
    <content type="html"><![CDATA[<p>helm-dashboard是helm的可视化界面，可以查看集群内通过helm部署的chart包。好处：不需要登录机器就可以升级、回滚chart包。</p>
<!-- more -->
<h2>Helm Dashboard简介</h2>
<h3>常用特性</h3>
<ul>
<li>查看、升级、回滚chart包及其内容</li>
<li>查看各个版本之间的区别</li>
</ul>
<h3>查看已安装的chart包</h3>
<figure><figcaption></figcaption></figure>
<h3>单个chart包的升级、回滚和修改配置</h3>
<figure><figcaption></figcaption></figure>
<h3>比较各个版本之前的区别</h3>
<figure><figcaption></figcaption></figure>
<h3>Helm Dadshboard 魔改</h3>
<p>helm-dashboard依赖的前端静态资源如：</p>
<ul>
<li>https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css</li>
<li>https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/lightfair.min.css</li>
<li>https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css</li>
</ul>
<p>由于国内网络原因，偶尔访问不到，导致页面加载不出来，影响使用。因此需要将这些cdn资源改为本地引用。<a href="https://github.com/Hexiaopi/helm-dashboard/commit/4eb18e1655606cd80ce1eb8001f03eaca6a55dc7" target="_blank" rel="noopener noreferrer">代码修改详见</a></p>
<h3>支持先行版本</h3>
<p>常见的语义化版本格式是：<strong>X.Y.Z</strong>，如：</p>
<ul>
<li>1.0.0</li>
<li>2.0.0</li>
<li>3.0.0</li>
</ul>
<p>但有时候需要支持先行版本，如：</p>
<ul>
<li>1.0.0-alpha.1</li>
<li>1.0.0-beta.2</li>
<li>1.0.0-rc.1</li>
</ul>
<p>helm-dashboard通过语义化版本判断最新版本是哪个，对于先行版本会导致页面报错白屏，因此如果需要支持先行版本，需要在chart包value.yaml增加<code>--devel</code>参数，详见如下：</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">extraArgs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>browser
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>bind=0.0.0.0
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>devel
</code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-03-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">kube-state-metrics k8s 部署</title>
    <id>http://blog.cjhe.top/devops/k8s/kube-state-metrics-k8s-deploy.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/kube-state-metrics-k8s-deploy.html"/>
    <updated>2024-03-18T08:34:44.000Z</updated>
    <summary type="html"><![CDATA[<p>kube-state-metrics用于监控k8s相关指标</p>
]]></summary>
    <content type="html"><![CDATA[<p>kube-state-metrics用于监控k8s相关指标</p>
<!-- more -->
<h2>k8s部署</h2>
<p>1、部署cluster-role</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> configmaps
  <span class="token punctuation">-</span> secrets
  <span class="token punctuation">-</span> nodes
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> services
  <span class="token punctuation">-</span> serviceaccounts
  <span class="token punctuation">-</span> resourcequotas
  <span class="token punctuation">-</span> replicationcontrollers
  <span class="token punctuation">-</span> limitranges
  <span class="token punctuation">-</span> persistentvolumeclaims
  <span class="token punctuation">-</span> persistentvolumes
  <span class="token punctuation">-</span> namespaces
  <span class="token punctuation">-</span> endpoints
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> statefulsets
  <span class="token punctuation">-</span> daemonsets
  <span class="token punctuation">-</span> deployments
  <span class="token punctuation">-</span> replicasets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> batch
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> cronjobs
  <span class="token punctuation">-</span> jobs
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> autoscaling
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> horizontalpodautoscalers
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> authentication.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tokenreviews
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> authorization.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> subjectaccessreviews
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> policy
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> poddisruptionbudgets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> certificates.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> certificatesigningrequests
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> discovery.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> endpointslices
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> storage.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> storageclasses
  <span class="token punctuation">-</span> volumeattachments
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> admissionregistration.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mutatingwebhookconfigurations
  <span class="token punctuation">-</span> validatingwebhookconfigurations
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networkpolicies
  <span class="token punctuation">-</span> ingressclasses
  <span class="token punctuation">-</span> ingresses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> coordination.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> leases
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> rbac.authorization.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> clusterrolebindings
  <span class="token punctuation">-</span> clusterroles
  <span class="token punctuation">-</span> rolebindings
  <span class="token punctuation">-</span> roles
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
</code></pre></div><p>2、部署cluster-role-binding</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div><p>3、部署deployment</p>
<p>👁️ 由于国外网络原因，注意需要修改镜像地址</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token comment">#- image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.10.0</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/bitnami/kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics<span class="token punctuation">:</span>latest
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> telemetry
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
            <span class="token key atrule">drop</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ALL
          <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">65534</span>
          <span class="token key atrule">seccompProfile</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> RuntimeDefault
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
</code></pre></div><p>4、部署service</p>
<p>注意，需要设置annotation，让Prometheus自动发现</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> telemetry
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> telemetry
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
</code></pre></div><p>5、部署service-account</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-01-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">cadvisor k8s 部署</title>
    <id>http://blog.cjhe.top/devops/k8s/cadvisor-k8s-deploy.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/cadvisor-k8s-deploy.html"/>
    <updated>2024-03-18T08:34:44.000Z</updated>
    <summary type="html"><![CDATA[<p>cadvisor 是谷歌公司用来分析运行中的 Docker 容器的资源占用以及性能特性的工具，简单来说是用于监控 Docker 容器。</p>
]]></summary>
    <content type="html"><![CDATA[<p>cadvisor 是谷歌公司用来分析运行中的 Docker 容器的资源占用以及性能特性的工具，简单来说是用于监控 Docker 容器。</p>
<!-- more -->
<h2>k8s部署</h2>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cadvisor
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> cAdvisor
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> cAdvisor
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token comment">#污点容忍,忽略master的NoSchedule</span>
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
          <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cadvisor
        <span class="token key atrule">image</span><span class="token punctuation">:</span> google/cadvisor<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> root
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /rootfs
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /sys
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/containerd
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> root
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /sys
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/containerd
</code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-01-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">node-exporter k8s 部署</title>
    <id>http://blog.cjhe.top/devops/k8s/node-exporter-k8s-deploy.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/node-exporter-k8s-deploy.html"/>
    <updated>2024-03-18T08:34:44.000Z</updated>
    <summary type="html"><![CDATA[<p>node-exporter用于暴露各个节点的指标，由于需要每个节点都部署node-exporter，因此kind选择DaemonSet，它会保障每个节点有一个相同的实例。</p>
]]></summary>
    <content type="html"><![CDATA[<p>node-exporter用于暴露各个节点的指标，由于需要每个节点都部署node-exporter，因此kind选择DaemonSet，它会保障每个节点有一个相同的实例。</p>
<!-- more -->
<h2>k8s部署</h2>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
          <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/node<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>node<span class="token punctuation">-</span>exporter
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>
          <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/proc
          <span class="token key atrule">name</span><span class="token punctuation">:</span> proc
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/sys
          <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host
          <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.procfs=/host/proc
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.sysfs=/host/sys
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.rootfs=/host
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proc
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /proc
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /sys
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-01-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">devops</title>
    <id>http://blog.cjhe.top/devops/</id>
    <link href="http://blog.cjhe.top/devops/"/>
    <updated>2024-04-16T03:31:43.000Z</updated>
    <summary type="html"><![CDATA[<p>这里记录工作中学习到的devops基础知识</p>
]]></summary>
    <content type="html"><![CDATA[<p>这里记录工作中学习到的devops基础知识</p>
]]></content>
    <category term="devops"/>
    <published>2024-01-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Prometheus k8s 部署</title>
    <id>http://blog.cjhe.top/devops/k8s/prometheus-k8s-deploy.html</id>
    <link href="http://blog.cjhe.top/devops/k8s/prometheus-k8s-deploy.html"/>
    <updated>2024-03-18T08:34:44.000Z</updated>
    <summary type="html"><![CDATA[<p>Prometheus是个优秀的监控系统，基于时序数据库，这里记录k8s部署</p>
]]></summary>
    <content type="html"><![CDATA[<p>Prometheus是个优秀的监控系统，基于时序数据库，这里记录k8s部署</p>
<!-- more -->
<h2>k8s部署</h2>
<p>步骤一、创建数据存储</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> /home/data/prometheus
<span class="token function">chmod</span> <span class="token number">777</span> /home/data/prometheus
</code></pre></div><p>步骤二、创建serviceaccount和clusterrolebinding</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>kubectl create serviceaccount monitor <span class="token parameter variable">-n</span> monitor
kubectl create clusterrolebinding monitor-clusterrolebinding <span class="token parameter variable">-n</span> monitor <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>monitor:monitor
</code></pre></div><p>步骤三、创建Prometheus configmap用于存储抓取配置</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code></code></pre></div>]]></content>
    <category term="devops"/>
    <published>2024-01-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">网络</title>
    <id>http://blog.cjhe.top/network/</id>
    <link href="http://blog.cjhe.top/network/"/>
    <updated>2024-04-16T03:31:43.000Z</updated>
    <summary type="html"><![CDATA[<p>这里记录工作中学习到的网络基础知识</p>
]]></summary>
    <content type="html"><![CDATA[<p>这里记录工作中学习到的网络基础知识</p>
]]></content>
    <category term="网络"/>
    <published>2023-09-23T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">三方库</title>
    <id>http://blog.cjhe.top/language/go/third-party/</id>
    <link href="http://blog.cjhe.top/language/go/third-party/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <category term="编程语言"/>
    <published>2023-09-20T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">pflag</title>
    <id>http://blog.cjhe.top/language/go/third-party/pflag.html</id>
    <link href="http://blog.cjhe.top/language/go/third-party/pflag.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">我在标准库中介绍了，对于小型的项目flag能够基本满足需求，但是在某些大型项目或者特殊场景下flag有些力不从心。主要在于：

flag的子命令需要自己解析
flag的短命令需要定义两个变量
不支持一些参数废弃说明，这在更新的工具中对用户有更好的引导作用

因此业界开源的pflag受到广大爱好者的使用，在一些耳熟能详的开源项目里也都在使用pflag，例...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>我在标准库中介绍了<a href="/language/go/standard-library/flag.html" target="_blank">flag使用</a>，对于小型的项目flag能够基本满足需求，但是在某些大型项目或者特殊场景下flag有些力不从心。主要在于：</p>
<ul>
<li>flag的子命令需要自己解析</li>
<li>flag的短命令需要定义两个变量</li>
<li>不支持一些参数废弃说明，这在更新的工具中对用户有更好的引导作用</li>
</ul>
<p>因此业界开源的<a href="https://github.com/spf13/pflag" target="_blank" rel="noopener noreferrer">pflag</a>受到广大爱好者的使用，在一些耳熟能详的开源项目里也都在使用pflag，例如：Kubernetes、Istio、Helm、Docker、Etcd等。</p>
<h2>简单用法</h2>
<h3>支持标准库flag用法</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> flagStrA <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"flag test *string"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagLongStringPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--str-a"</span><span class="token punctuation">,</span> <span class="token string">"stra"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagStrA<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// stra</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>注意是长选项，即参数为<code>--xxx</code></p>
</div>
<h3>支持短选项</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> flagStrB <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"long and short flag test *string"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagShortStringPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-b"</span><span class="token punctuation">,</span> <span class="token string">"strb"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagStrB<span class="token punctuation">)</span>
	<span class="token comment">// OutPut:</span>
	<span class="token comment">// strb</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>支持绑定到已有变量</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> flagStrC <span class="token builtin">string</span>
<span class="token keyword">var</span> flagStrD <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagStrC<span class="token punctuation">,</span> <span class="token string">"str-c"</span><span class="token punctuation">,</span> <span class="token string">"str-c"</span><span class="token punctuation">,</span> <span class="token string">"long flag test string"</span><span class="token punctuation">)</span>
	pflag<span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagStrD<span class="token punctuation">,</span> <span class="token string">"str-d"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"str-d"</span><span class="token punctuation">,</span> <span class="token string">"long and short flag test string"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--str-c"</span><span class="token punctuation">,</span> <span class="token string">"strc"</span><span class="token punctuation">,</span> <span class="token string">"-d"</span><span class="token punctuation">,</span> <span class="token string">"strd"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flagStrC<span class="token punctuation">,</span> flagStrD<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// strc strd</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>标记命令行参数已废弃</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkDeprecated</span><span class="token punctuation">(</span><span class="token string">"badflag"</span><span class="token punctuation">,</span> <span class="token string">"please use --desc instead"</span><span class="token punctuation">)</span>
pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkShorthandDeprecated</span><span class="token punctuation">(</span><span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"please use --str-b instead"</span><span class="token punctuation">)</span>
</code></pre></div><p>打印Usage()</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>Flag --badflag has been deprecated, please use --desc instead
Flag shorthand -b has been deprecated, please use --str-b instead
</code></pre></div><h3>指定了参数却没有传值场景下的默认值改写</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> age <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">IntP</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"Input Your Age"</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NoOptDefVal <span class="token operator">=</span> <span class="token string">"25"</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestFlagDefault</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name      <span class="token builtin">string</span>
		arguments <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
		want      <span class="token builtin">int</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"没传入参数和值"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"传入参数和值"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--age=10"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"传入参数,没传值"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--age"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> test <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">*</span>age <span class="token operator">!=</span> test<span class="token punctuation">.</span>want <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"%s pflag parse want:%d,but got:%d"</span><span class="token punctuation">,</span> test<span class="token punctuation">.</span>name<span class="token punctuation">,</span> test<span class="token punctuation">.</span>want<span class="token punctuation">,</span> <span class="token operator">*</span>age<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>::: notice</p>
<ul>
<li>当输入--age 10，age变量值为：10；</li>
<li>当输入--age，age变量值为：25；</li>
<li>当没输入--age，age变量值为：30；</li>
</ul>
<p>:::</p>
<h3>支持隐藏参数</h3>
<blockquote>
<p>隐藏的参数不会显示在usage/help中</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkHidden</span><span class="token punctuation">(</span><span class="token string">"secretFlag"</span><span class="token punctuation">)</span>
</code></pre></div>]]></content>
    <category term="编程语言"/>
    <published>2023-09-20T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">标准库</title>
    <id>http://blog.cjhe.top/language/go/standard-library/</id>
    <link href="http://blog.cjhe.top/language/go/standard-library/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <category term="编程语言"/>
    <published>2023-09-19T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">flag使用</title>
    <id>http://blog.cjhe.top/language/go/standard-library/flag.html</id>
    <link href="http://blog.cjhe.top/language/go/standard-library/flag.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">flag库实现命令行参数解析

简单用法

flag参数使用语法
-flag    // 破折号，使用默认值
--flag   // 双破折号
-flag=x  // 指定参数值
-flag x  // non-boolean flags only

字符串类型
使用示例
不过由于flag.String()返回的是指针类型的字符串，因此，也可以使用下面...</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>flag库实现命令行参数解析</p>
</blockquote>
<h2>简单用法</h2>
<div class="hint-container tip">
<p class="hint-container-title">flag参数使用语法</p>
<p>-flag    // 破折号，使用默认值
--flag   // 双破折号
-flag=x  // 指定参数值
-flag x  // non-boolean flags only</p>
</div>
<h3>字符串类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example1：flag.String 返回指针类型字符串</span>
<span class="token keyword">var</span> flagStrA <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"flag test *string"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagStringPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-str-a"</span><span class="token punctuation">,</span> <span class="token string">"stra"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagStrA<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// stra</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不过由于flag.String()返回的是指针类型的字符串，因此，也可以使用下面方式定义</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example2：如果期望定义字符串类型，可以通过init函数初始化</span>
<span class="token keyword">var</span> flagStrB <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// flag.StringVar可以绑定已有的变量</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagStrB<span class="token punctuation">,</span> <span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"flag test string"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagStringPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-str-b"</span><span class="token punctuation">,</span> <span class="token string">"strb"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flagStrB<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// strb</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>int类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example3：int类型变量</span>
<span class="token keyword">var</span> flagInt <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"flag test *int"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagIntPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-int"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagInt<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 10</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>Bool类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example3：int类型变量</span>
<span class="token keyword">var</span> flagInt <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"flag test *int"</span><span class="token punctuation">)</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">bool类型可以使用以下字面量</p>
<p>1, 0, t, f, T, F, true, false, TRUE, FALSE, True, False</p>
</div>
<p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleBoolPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-bool=True"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagBool<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意事项</p>
<h4>bool类型不可使用：-flag x形式</h4>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleBoolPointNoticPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-bool"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagBool<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>虽然显示的传入<code>false</code>，但是最终结果是<code>true</code></p>
</div>
<h4>bool类型：-flag形式，认为true</h4>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleBoolPointEmptyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-bool"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagBool<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div></div>
<h3>duration类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example5：duration类型变量</span>
<span class="token keyword">var</span> flagDuration <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Minute<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"flag test *duration"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagDurationPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-duration"</span><span class="token punctuation">,</span> <span class="token string">"1m1s"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagDuration<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1m1s</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>高阶用法</h2>
<p>flag标准库提供了基础的数据类型参数，如下：</p>
<ul>
<li>bool</li>
<li>int</li>
<li>int64</li>
<li>uint</li>
<li>uint64</li>
<li>string</li>
<li>float64</li>
<li>duration</li>
</ul>
<h3>自定义类型</h3>
<p>如果需要自定义类型，需要实现<code>flag.Value</code>接口</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Set</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example6: 自定义类型</span>
<span class="token keyword">type</span> URLValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	URL <span class="token operator">*</span>url<span class="token punctuation">.</span>URL
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v URLValue<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span>URL <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> v<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>URLValue<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> u<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span>URL <span class="token operator">=</span> u
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> u URLValue

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">,</span> <span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"flag test self struct"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleStructPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-url"</span><span class="token punctuation">,</span> <span class="token string">"https://golang.org/pkg/flag/"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// https://golang.org/pkg/flag/</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>子命令</h3>
<p>这里参考网站示例：<a href="https://gobyexample.com/command-line-subcommands" target="_blank" rel="noopener noreferrer">gobyexample</a></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    fooCmd <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span>ExitOnError<span class="token punctuation">)</span>
    fooEnable <span class="token operator">:=</span> fooCmd<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"enable"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"enable"</span><span class="token punctuation">)</span>
    fooName <span class="token operator">:=</span> fooCmd<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span>

    barCmd <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">"bar"</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span>ExitOnError<span class="token punctuation">)</span>
    barLevel <span class="token operator">:=</span> barCmd<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"level"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"expected 'foo' or 'bar' subcommands"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

    <span class="token keyword">case</span> <span class="token string">"foo"</span><span class="token punctuation">:</span>
        fooCmd<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subcommand 'foo'"</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  enable:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>fooEnable<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  name:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>fooName<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  tail:"</span><span class="token punctuation">,</span> fooCmd<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token string">"bar"</span><span class="token punctuation">:</span>
        barCmd<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subcommand 'bar'"</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  level:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>barLevel<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  tail:"</span><span class="token punctuation">,</span> barCmd<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"expected 'foo' or 'bar' subcommands"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./command-line-subcommands foo <span class="token parameter variable">-enable</span> <span class="token parameter variable">-name</span><span class="token operator">=</span>joe a1 a2
</code></pre></div><div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>subcommand 'foo'
  enable: true
  name: joe
  tail: [a1 a2]
</code></pre></div><div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./command-line-subcommands bar <span class="token parameter variable">-level</span> <span class="token number">8</span> a1
</code></pre></div><div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>subcommand 'bar'
  level: 8
  tail: [a1]
</code></pre></div><h2>底层结构</h2>
<p>Flag代表一个标志，例如:<code>--version</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// A Flag represents the state of a flag.</span>
<span class="token keyword">type</span> Flag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name     <span class="token builtin">string</span> <span class="token comment">// name as it appears on command line</span>
	Usage    <span class="token builtin">string</span> <span class="token comment">// help message</span>
	Value    Value  <span class="token comment">// value as set</span>
	DefValue <span class="token builtin">string</span> <span class="token comment">// default value (as text); for usage message</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FlagSet 代表标志的集合，例如：<code>--name</code>、<code>--age</code>...</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> FlagSet <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Usage is the function called when an error occurs while parsing flags.</span>
	<span class="token comment">// The field is a function (not a method) that may be changed to point to</span>
	<span class="token comment">// a custom error handler. What happens after Usage is called depends</span>
	<span class="token comment">// on the ErrorHandling setting; for the command line, this defaults</span>
	<span class="token comment">// to ExitOnError, which exits the program after calling Usage.</span>
	Usage <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	name          <span class="token builtin">string</span>
	parsed        <span class="token builtin">bool</span>
	actual        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag
	formal        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag
	args          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// arguments after flags</span>
	errorHandling ErrorHandling
	output        io<span class="token punctuation">.</span>Writer <span class="token comment">// nil means stderr; use Output() accessor</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FlagSet包含一系列方法：</p>
<ul>
<li>BoolVar(p *bool,name string,value bool,usage string)</li>
<li>Bool(name string,value bool,usage string) *bool</li>
<li>IntVar(p *int,name string,value int,usage string)</li>
<li>Int(name string,value int,usage string) *int</li>
<li>Int64Var(p *int64,name string,value int64,usage string)</li>
<li>Int64(name string,value int64,usage string) *int64</li>
<li>UIntVar(p *uint,name string,value uint,usage string)</li>
<li>UInt(name string,value uint,usage string) *Uint</li>
<li>UInt64Var(p *uint64,name string,value uint64,usage string)</li>
<li>UInt64(name string,value uint64,usage string) *Uint64</li>
<li>StringVar(p *string,name string,value string,usage string)</li>
<li>String(name string,value string,usage string) *string</li>
<li>Float64Var(p *float64,name string,value float64,usage string)</li>
<li>Float64(name string,value float64,usage string) *float64</li>
<li>DurationVar(p *time.Duration,name string,value time.Duration,usage string)</li>
<li>Duration(name string,value time.Duration,usage string) *time.Duration</li>
<li>TextVar(p encoding.TextUnmarshaler,name string,value encoding.TextMarshaler,usage string)</li>
<li>Var(value Value, name string, usage string)</li>
</ul>
<p>而我们常常使用的是flag库中的以下方法，例如：<code>flag.StringVar()</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">StringVar</span><span class="token punctuation">(</span>p <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	CommandLine<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span><span class="token function">newStringValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其本质上是调用<code>CommandLine.Var</code>方法，而CommandLine是FlagSet的一个实例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> CommandLine <span class="token operator">=</span> <span class="token function">NewFlagSet</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ExitOnError<span class="token punctuation">)</span>
</code></pre></div><ul>
<li><code>os.Args[0]</code>：是程序运行时的名称。</li>
<li><code>ExitOnError</code>：是解析参数时遇到错误时退出</li>
</ul>
<p><code>flag.Parse</code>其本质上也是调用CommandLine的解析，如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Ignore errors; CommandLine is set for ExitOnError.</span>
	CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它将<code>os.Args[1:]</code>，即除了程序名称外，其余的参数传给CommandLine进行解析。</p>
<p>最为核心的代码莫过于参数的解析，如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">Parse</span><span class="token punctuation">(</span>arguments <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>parsed <span class="token operator">=</span> <span class="token boolean">true</span>
	f<span class="token punctuation">.</span>args <span class="token operator">=</span> arguments
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		seen<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">parseOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> seen <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> f<span class="token punctuation">.</span>errorHandling <span class="token punctuation">{</span>
		<span class="token keyword">case</span> ContinueOnError<span class="token punctuation">:</span>
			<span class="token keyword">return</span> err
		<span class="token keyword">case</span> ExitOnError<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> ErrHelp <span class="token punctuation">{</span>
				os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> PanicOnError<span class="token punctuation">:</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里循环解析每一个Flag，即：<code>f.parseOne()</code>。</p>
<p>最后总结其中的关系图:</p>
<figure><figcaption>flag</figcaption></figure>
]]></content>
    <category term="编程语言"/>
    <published>2023-09-05T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">recover注意事项</title>
    <id>http://blog.cjhe.top/language/go/base/recover.html</id>
    <link href="http://blog.cjhe.top/language/go/base/recover.html"/>
    <updated>2024-05-20T02:03:42.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>defer结合recover通常用于捕获panic</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>defer结合recover通常用于捕获panic</p>
</blockquote>
<!-- more -->
<h2>正确使用示例</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">PrintRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"some thing"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExamplePrintRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">PrintRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// a</span>
	<span class="token comment">// some thing</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>错误用例：不使用defer</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FailRecoverWithoutDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"some thing"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>不使用defer 方式，将无法捕获异常，程序陷入panic</p>
</div>
<h2>错误用例：recover 在 defer 嵌套函数中</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FailRecoverWithoutLevelDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//recover 在 defer 嵌套函数中</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"some thing"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>defer recover和panic不在同一层级，导致无法捕获异常，程序陷入panic</p>
</div>
<h2>defer recover 再次panic</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>12
</code></pre></div></details>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>21
</code></pre></div></details>
]]></content>
    <category term="编程语言"/>
    <published>2023-08-27T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">package</title>
    <id>http://blog.cjhe.top/language/go/base/package.html</id>
    <link href="http://blog.cjhe.top/language/go/base/package.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="html"><![CDATA[<p>Go语言使用包（package）作为基本单元来组织源码。</p>
]]></summary>
    <content type="html"><![CDATA[<p>Go语言使用包（package）作为基本单元来组织源码。</p>
<!-- more -->
<h2>package的优点</h2>
<h3>编译速度快</h3>
<ul>
<li>Go要求每个源文件在开头显示地列出所有依赖的包，如果引入了未使用的包，Go语言编译器会报错。</li>
<li>Go要求包之间不能存在循环依赖，这样包的依赖关系便形成了一张有向无环图，这样每个包可以单独编译也可并行编译</li>
<li>已编译的Go包不仅记录了该包的信息，还记录了依赖包的信息。只需读取缓存的编译产物即可。</li>
</ul>
<h2>初始化顺序</h2>
<p>Go语言内置函数<code>init()</code>，常用于包级数据初始化以及初始状态的检查工作。</p>
<ul>
<li>一个Go包可以有多个init()函数</li>
<li>init()函数不可显示的调用，否则会编译期间报错</li>
<li>init()只会执行一次</li>
</ul>
<p>Go包引入其他包，初始化时按照一定的次序逐一调用该包的init函数。</p>
<figure><figcaption>package-init</figcaption></figure>
<p>Go语言运行时按照常量-&gt;变量-&gt;init()顺序进行初始化。</p>
]]></content>
    <category term="编程语言"/>
    <published>2023-08-27T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">MQTT协议</title>
    <id>http://blog.cjhe.top/network/application-layer/MQTT.html</id>
    <link href="http://blog.cjhe.top/network/application-layer/MQTT.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">MQTT(Mesage Queuing Telemetry Transport，消息队列遥测传输协议)，是一种基于发布/订阅模式的轻量级通讯协议，该协议构建于TCP/IP协议上。

发展历史

1999年由IBM发明，起初用于原油管道数据采集监控系统，解决卫星与原油管道检测数据的传输问题。
2010 发布MQTT 3.1。
2014年在 OASIS 标...</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>MQTT(Mesage Queuing Telemetry Transport，消息队列遥测传输协议)，是一种基于发布/订阅模式的轻量级通讯协议，该协议构建于TCP/IP协议上。</p>
</blockquote>
<h2>发展历史</h2>
<ul>
<li>1999年由IBM发明，起初用于原油管道数据采集监控系统，解决卫星与原油管道检测数据的传输问题。</li>
<li>2010 发布MQTT 3.1。</li>
<li>2014年在 <strong>OASIS</strong> 标准化组织的推动下于公布了 <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener noreferrer"><code>V3.1.1</code></a> 版本规范。</li>
<li>2019年3月发布了最新的 <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/cs02/mqtt-v5.0-cs02.html" target="_blank" rel="noopener noreferrer"><code>V5.0</code></a> 版本规范。</li>
</ul>
<h2>优点</h2>
<ul>
<li>支持QoS（设备网络环境复杂）</li>
<li>轻量且省带宽（MQTT报文紧凑，可在严重受限的硬件设备和低带宽、高延迟的网络上实现稳定传输）</li>
<li>发布订阅模式，将发布者与订阅者解耦</li>
<li>持续会话感知能力（时刻知道设备是否在线）</li>
</ul>
<h2>通信模式</h2>
<blockquote>
<p>发布/订阅模式(Publish/Subscribe)将发送消息的发布者(Publisher)与接收消息的订阅者(Subscriber)分离，之间的连接关系由代理者(Broker)进行处理。两者不直接进行通信，甚至彼此之前都不知道对方的存在。</p>
</blockquote>
<figure><figcaption>MQTT通信模式</figcaption></figure>
<h3>特点</h3>
<blockquote>
<p>发布/订阅模式的重要特性就是将消息的发布者与订阅者解耦，这种解耦体现在以下三个方面：</p>
<ul>
<li>空间解耦：发布者和订阅者不需要相互了解（例如无须交换IP地址与端口）；</li>
<li>时间解耦：发布者与订阅者的操作不需要同时运行（可下线）；</li>
<li>同步解耦：在发布或者订阅消息的过程当中，发布者和订阅者可以异步进行工作（C/S模式需要客户端或服务端等待）；</li>
</ul>
</blockquote>
<p>Broker通过某种<strong>过滤规则</strong>将Publisher的消息发送给Subscriber，该<strong>过滤规则</strong>就是<strong>Topic</strong></p>
<h2>核心概念</h2>
<h3>主题 Topic</h3>
<blockquote>
<p>MQTT 协议的<strong>主题</strong>（Topic）是指<strong>代理者</strong>用于为<strong>客户端</strong>过滤与路由消息的 <strong>UTF-8 编码字符串</strong></p>
<p>一个<strong>主题</strong>是由一个或者多个<strong>主题级别</strong>（Topic Level）构成，每个主题级别由正斜线 <code>/</code> 进行分隔。</p>
<p>例如：&lt;父级Topic名称&gt;/&lt;二级Topic名称&gt;/&lt;三级Topic名称&gt;</p>
<p>每个<strong>主题</strong>必须至少包含 1 个字符（一个单独的斜杆 <code>/</code> 也是一个有效的主题），并且主题字符串允许存在<strong>空格</strong>。</p>
<p>主题<strong>区分大小写</strong>，<code>home/temperature</code> 与 <code>Home/Temperature</code> 是 2 个不同的<strong>主题</strong>。</p>
<p>主题不需要提前创建，发布者发送消息到某个主题或订阅者订阅某个主题时，Broker就会自动创建</p>
</blockquote>
<h4>通配符</h4>
<ul>
<li>
<p>单级通配符：<code>+</code></p>
<blockquote>
<p>只能匹配一个主题级别</p>
</blockquote>
</li>
</ul>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>  例如：订阅myhome/groundfloor/+/temperature
  myhome/groundfloor/livingroom/temperature		//匹配
  myhome/groundfloor/kitchen/temperature			//匹配
  myhome/groundfloor/kitchen/brightness			//不匹配
  myhome/firstfloor/kitchen/temperature			//不匹配
  myhome/groundfloor/kitchen/fridge/temperature	//不匹配
</code></pre></div><ul>
<li>
<p>多级通配符：<code>#</code></p>
<blockquote>
<p>可以匹配多个主题级别</p>
</blockquote>
</li>
</ul>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>  例如：订阅myhome/groundfloor/#
  myhome/groundfloor/livingroom/temperature		//匹配
  myhome/groundfloor/kitchen/temperature			//匹配
  myhome/groundfloor/kitchen/brightness			//匹配
  myhome/firstfloor/kitchen/temperature			//不匹配
</code></pre></div><ul>
<li>
<p>系统保留主题：<code>$</code></p>
<blockquote>
<p>MQTT系统内部保留，用于代理者内部统计信息</p>
</blockquote>
</li>
</ul>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>  $SYS/broker/clients/disconnected
  $SYS/broker/clients/connected
  $SYS/broker/messages/sent
  $SYS/broker/clients/total
  $SYS/broker/uptime
</code></pre></div><h4>用例</h4>
<p>比如我们用传感器监视家里的卧室、客厅以及厨房的温度、湿度和空气质量，可以设计一下几个主题：</p>
<ul>
<li><code>myhome/bedroom/temperature</code></li>
<li><code>myhome/bedroom/humidity</code></li>
<li><code>myhome/bedroom/airquality</code></li>
<li><code>myhome/livingroom/temperature</code></li>
<li><code>myhome/livingroom/humidity</code></li>
<li><code>myhome/livingroom/airquality</code></li>
<li><code>myhome/kitchen/temperature</code></li>
<li><code>myhome/kitchen/humidity</code></li>
<li><code>myhome/kitchen/airquality</code></li>
</ul>
<p>当我们想获取卧室的所有数据时，可以订阅 <code>myhome/bedroom/+</code> 主题，当我们想获取三个房间的温度数据的时候，可以订阅 <code>myhome/+/temperature</code> 主题，当我们想获取所有的数据的时候，可以订阅 <code>myhome/#</code> 或者 <code>#</code>。</p>
<h4>最佳实践</h4>
<ul>
<li>切勿在主题开头使用正斜杠 <code>/</code>，避免引入一个<strong>零字符</strong>作为不必要的主题级别；</li>
<li>永远不要在主题中使用空格（包括 UTF-8 当中不同类型的空白），从而避免为阅读和调试带来不必要的困扰；</li>
<li>尽量保持主题简短，对于资源有限的物联网设备，每个字节占用的存储空间都非常重要；</li>
<li>仅使用 ASCII 字符，避免使用一些不可打印的字符；</li>
<li>将唯一标识符或者<strong>客户端</strong> ID 嵌入主题，从而方便的识别消息的发送者；</li>
<li>不要轻易直接订阅 <code>#</code>，即不要直接使用<strong>多级通配符</strong>订阅<strong>代理者</strong>上发布的全部消息，避免给<strong>订阅者</strong>带来过大的数据吞吐量；</li>
<li>优化主题层次结构，保持主题命名的长期扩展性；</li>
</ul>
<h3>服务质量 QoS</h3>
<ul>
<li>QoS-0(至多一次)：接收方不会确认收到消息，发送发也不会存储和重新传输消息，消息发布完全依赖底层TCP/IP网络，消息可能会丢失。</li>
<li>QoS-1(至少一次)：发送方会存储消息直至接收方获得确认消息的PUBACK数据包为止，确保消息到达，但可能会出现重复；</li>
<li>QoS-2(只有一次)：确保消息到达且没有重复。</li>
</ul>
<figure><figcaption>MQTT-QoS</figcaption></figure>
<p>http://www.steves-internet-guide.com/mqtt-publish-subscribe/</p>
<ul>
<li>当客户端 A 的发布 QoS 大于客户端 B 的订阅 QoS 时，服务端向客户端 B 转发消息时使用的 QoS 为客户端 B 的订阅 QoS。</li>
<li>当客户端 A 的发布 QoS 小于客户端 B 的订阅 QoS 时，服务端向客户端 B 转发消息时使用的 QoS 为客户端 A 的发布 QoS</li>
</ul>
<h3>消息类型</h3>
<ul>
<li>CONNECT/CONNACK 连接相关</li>
<li>PUBLISH/PUBACK 发布相关</li>
<li>SUBSCRIBE/SUBACK 订阅相关</li>
<li>UNSUBSCRIBE/UNSUBACK 取消订阅相关</li>
<li>PINGREQ/PINGRESP 心跳相关</li>
<li>DISCONNECT 关闭连接</li>
</ul>
<h4>CONNECT</h4>
<figure><img src="http://www.uinio.com/Embedded/MQTT/4.png" alt="MQTT-CONNECT" tabindex="0" loading="lazy"><figcaption>MQTT-CONNECT</figcaption></figure>
<ul>
<li><strong>客户端标识符</strong> <code>clientId</code>：用于标识连接到<strong>代理者</strong>的每个<strong>客户端</strong>，该标识符的取值对于<strong>代理者</strong>与<strong>客户端</strong>而言必须唯一；</li>
<li><strong>清理会话</strong> <code>cleanSession</code>：用于告知<strong>代理者</strong>，当前<strong>客户端</strong>是否需要建立持久会话；
<ul>
<li>当 <code>CleanSession = false</code> 时，<strong>代理者</strong>将存储<strong>客户端</strong>的所有订阅，以及客户端以<strong>服务质量</strong>（QoS）级别 <code>1</code> 或者 <code>2</code> 所订阅的全部遗漏消息；</li>
<li>当 <code>CleanSession = true</code> 时，<strong>代理者</strong>不但不会为<strong>客户端</strong>保存任何消息，还会清除掉来自于之前持久会话的所有消息；</li>
</ul>
</li>
<li><strong>用户名/密码</strong> <code>username</code>/<code>password</code>：用于对<strong>客户端</strong>进行认证与授权，默认为明文传输，实际应用当中应当进行加密处理；</li>
<li><strong>临终遗嘱</strong> <code>lastWill*</code>：属于 MQTT <strong>临终遗嘱</strong>（LWT，Last Will and Testament）特性的一部分，当<strong>客户端</strong>非正常断开连接时，用于发送遗嘱消息通知其它的<strong>客户端</strong>；</li>
<li><strong>保持连接</strong> <code>keepAlive</code>：用于指定<strong>客户端</strong>在连接建立时，与<strong>代理者</strong>通信的时间间隔（以<strong>秒</strong>为单位），即<strong>代理者</strong>与<strong>客户端</strong>在不发送消息的情况下，可以保持连接的最长时间；</li>
</ul>
<h4>CONNACK</h4>
<figure><img src="http://www.uinio.com/Embedded/MQTT/5.png" alt="MQTT-CONNACK" tabindex="0" loading="lazy"><figcaption>MQTT-CONNACK</figcaption></figure>
<ul>
<li>
<p><strong>会话出现标识</strong> <code>sessionPresent</code>：用于告知<strong>客户端</strong>，当前的<strong>代理者</strong>是否已经拥有了一个会话；当<strong>客户端</strong>连接消息的 <code>cleanSession = true</code> 时，由于当前没有可用的会话，所以该项总是为 <code>false</code>；而当<strong>客户端</strong>连接消息的 <code>cleanSession = false</code> 时，此时就会存在两种可能性：</p>
<ul>
<li>如果会话消息对于 <code>clientId</code> 可用，并且<strong>代理者</strong>服务已经缓存了这些会话信息，那么 <code>sessionPresent</code> 为 <code>true</code>；</li>
<li>反之，如果<strong>代理者</strong>没有任何这个 <code>clientId</code> 的会话信息，那么该项就为 <code>false</code>；</li>
</ul>
</li>
<li>
<p><strong>连接返回码</strong> <code>returnCode</code>：用于通知<strong>客户端</strong>当前连接是否成功，具体取值请参考下面表格：</p>
<p>| 返回代码 | 返回码响应                       |
| :</p>
</li>
</ul>
]]></content>
    <category term="网络"/>
    <published>2023-08-26T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">数据存储</title>
    <id>http://blog.cjhe.top/database/</id>
    <link href="http://blog.cjhe.top/database/"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>记录学习数据库的过程</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>记录学习数据库的过程</p>
</blockquote>
]]></content>
    <category term="数据存储"/>
    <published>2023-08-24T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">MySQL</title>
    <id>http://blog.cjhe.top/database/mysql/</id>
    <link href="http://blog.cjhe.top/database/mysql/"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="text">MySQL是一种流行的关系型数据库管理系统，具有以下几个优点：


开源免费: MySQL采用开源许可证，可以免费获得和使用。这使得MySQL成为许多个人开发者、初创公司和中小型企业的首选数据库，可以降低成本并提高灵活性。


可靠性和稳定性: MySQL经过了广泛测试和市场验证，具有良好的稳定性和可靠性。它支持事务处理和ACID（原子性、一致性、隔离...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>MySQL是一种流行的关系型数据库管理系统，具有以下几个优点：</p>
<ul>
<li>
<p>开源免费: MySQL采用开源许可证，可以免费获得和使用。这使得MySQL成为许多个人开发者、初创公司和中小型企业的首选数据库，可以降低成本并提高灵活性。</p>
</li>
<li>
<p>可靠性和稳定性: MySQL经过了广泛测试和市场验证，具有良好的稳定性和可靠性。它支持事务处理和ACID（原子性、一致性、隔离性和持久性）属性，保证数据的一致性和安全。</p>
</li>
<li>
<p>高性能: MySQL具有出色的性能特点，能够处理大规模的并发请求。它为多用户并发操作提供了有效的解决方案，并且优化了处理大量数据的能力。</p>
</li>
<li>
<p>可扩展性: MySQL支持水平和垂直扩展，可以根据需要增加更多的服务器、节点和存储，以应对不断增长的数据需求。它还提供了复制和分片等机制，以实现数据的复制和分布式存储。</p>
</li>
<li>
<p>灵活性: MySQL支持多种操作系统，包括Windows、Linux、macOS等，可以在各种环境中运行。它还支持多种编程语言的驱动程序和API，如Python、Java、PHP等，提供了广泛的开发和集成选项。</p>
</li>
<li>
<p>社区支持和生态系统: MySQL拥有庞大的开发者社区和活跃的生态系统，有许多开源工具、第三方库和插件可供选择。这意味着可以获得丰富的资源和支持，能够更快地解决问题和开发应用。</p>
</li>
</ul>
]]></content>
    <category term="数据存储"/>
    <published>2023-08-24T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">项目规范</title>
    <id>http://blog.cjhe.top/project-standard/</id>
    <link href="http://blog.cjhe.top/project-standard/"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">这里记录平时开发过程中的项目规范，好的规范有助于：


一致性: 项目规范确保团队成员在工作中遵循相同的标准和做法，使得代码、文档、命名等保持一致。这有助于提高代码的可读性和可维护性，减少混乱和错误。


提高效率: 项目规范定义了已经验证过的最佳实践和指导原则，可以减少重复劳动和不必要的思考，提高团队成员的工作效率。规范化的流程和模板也能减少沟通成本...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>这里记录平时开发过程中的项目规范，好的规范有助于：</p>
<ul>
<li>
<p>一致性: 项目规范确保团队成员在工作中遵循相同的标准和做法，使得代码、文档、命名等保持一致。这有助于提高代码的可读性和可维护性，减少混乱和错误。</p>
</li>
<li>
<p>提高效率: 项目规范定义了已经验证过的最佳实践和指导原则，可以减少重复劳动和不必要的思考，提高团队成员的工作效率。规范化的流程和模板也能减少沟通成本，使得团队更高效地协同工作。</p>
</li>
<li>
<p>可维护性: 项目规范通常包括命名约定、代码结构、注释规范等，这些指导可以提高代码的可维护性。当新成员加入或者团队成员变动时，他们能够更快地理解项目的结构和代码，减轻维护负担。</p>
</li>
<li>
<p>质量控制: 项目规范可以确保项目符合良好的软件工程实践和行业标准，从而提高项目的质量。规范化的代码和流程可以减少潜在的 bug 和问题，并且提供了一致的评估标准，有助于提前发现和纠正问题。</p>
</li>
<li>
<p>可扩展性: 通过定义良好的规范并遵循它们，项目可以更容易地进行扩展和维护。合理的架构设计和规范化的开发实践可以使得项目更易于扩展，并且降低了引入新功能、改进和优化的风险。</p>
</li>
</ul>
]]></content>
    <category term="项目规范"/>
    <published>2023-08-23T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go进阶</title>
    <id>http://blog.cjhe.top/language/go/advance/</id>
    <link href="http://blog.cjhe.top/language/go/advance/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>介绍Go语言进阶知识，包括遇到的一些坑和底层原理，进阶知识对于入门童鞋来说可以不用了解，并不会影响日常开发，属于深度探讨</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>介绍Go语言进阶知识，包括遇到的一些坑和底层原理，进阶知识对于入门童鞋来说可以不用了解，并不会影响日常开发，属于深度探讨</p>
</blockquote>
]]></content>
    <category term="编程语言"/>
    <published>2023-08-24T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go基础</title>
    <id>http://blog.cjhe.top/language/go/base/</id>
    <link href="http://blog.cjhe.top/language/go/base/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>介绍Go语言基础知识，也会涉及到底层原理，这些是我认为要掌握的知识。</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>介绍Go语言基础知识，也会涉及到底层原理，这些是我认为要掌握的知识。</p>
</blockquote>
]]></content>
    <category term="编程语言"/>
    <published>2023-08-24T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">转载</title>
    <id>http://blog.cjhe.top/language/go/reprint/</id>
    <link href="http://blog.cjhe.top/language/go/reprint/"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>这里会转载我认为比较好的博文</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>这里会转载我认为比较好的博文</p>
</blockquote>
]]></content>
    <category term="编程语言"/>
    <published>2023-08-24T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">退出模式</title>
    <id>http://blog.cjhe.top/design-pattern/concurrency/exit.html</id>
    <link href="http://blog.cjhe.top/design-pattern/concurrency/exit.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">退出模式
使用关键字go很容易启动goroutine，这样创建的协程和当前协程已经分离，我们并不知道
等待指定协程退出
 
提示
spawn函数创建的新goroutine与调用spawn函数的goroutine（main goroutine）之间通过channel建立了联系。

等待多个协程退出
 
提示
通过sync.WaitGroup，对于每一个协...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>退出模式</h2>
<p>使用关键字<code>go</code>很容易启动goroutine，这样创建的协程和当前协程已经分离，我们并不知道</p>
<h3>等待指定协程退出</h3>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> signal <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"worker is working..."</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> signal <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> signal<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"worker start to work..."</span><span class="token punctuation">)</span>
		<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c <span class="token operator">&lt;-</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"start a worker..."</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>c
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker work done!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>spawn函数创建的新goroutine与调用spawn函数的goroutine（main goroutine）之间通过channel建立了联系。</p>
</div>
<h3>等待多个协程退出</h3>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> signal <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker %d: is working...\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker %d: works done\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> signal <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> signal<span class="token punctuation">)</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker %d: start to work...\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
			<span class="token function">f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c <span class="token operator">&lt;-</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"the group of workers start to work..."</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>c
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"the group of workers work done!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>通过sync.WaitGroup，对于每一个协程处理前进行wg.Add(1)，退出时执行wg.Done()，并等待所有的协程退出wg.Wait()。保障所有的协程都会结束。</p>
</div>
]]></content>
    <category term="设计模式"/>
    <published>2023-08-22T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">扇入/扇出模型</title>
    <id>http://blog.cjhe.top/design-pattern/concurrency/fan-in-fan-out.html</id>
    <link href="http://blog.cjhe.top/design-pattern/concurrency/fan-in-fan-out.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">扇出模式
即多个相同goroutine从同一个channel读取数据并处理
fan-outfan-out
输出结果
我们使用三个协程从一个channel中过滤2的倍数，分别放在三个channel输出。由于Go语言调度不确定性，因此测试结果可能不一致。
扇入模式
从多个channel读取数据并处理，将结果放入一个channel
fan-infan-in
...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>扇出模式</h2>
<p>即多个相同goroutine从同一个channel读取数据并处理</p>
<figure><figcaption>fan-out</figcaption></figure>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestFanOut</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span>
	in <span class="token operator">:=</span> <span class="token function">echo</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span>
	c1 <span class="token operator">:=</span> <span class="token function">odd</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	c2 <span class="token operator">:=</span> <span class="token function">odd</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	c3 <span class="token operator">:=</span> <span class="token function">odd</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"c1"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> c1 <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"c2"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> c2 <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"c3"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> c3 <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>=== RUN   TestFanOut
    fan-in-fan-out_test.go:24: c1
    fan-in-fan-out_test.go:26: 1
    fan-in-fan-out_test.go:26: 7
    fan-in-fan-out_test.go:26: 9
    fan-in-fan-out_test.go:28: c2
    fan-in-fan-out_test.go:30: 3
    fan-in-fan-out_test.go:32: c3
    fan-in-fan-out_test.go:34: 5
</code></pre></div>]]></content>
    <category term="设计模式"/>
    <published>2023-08-22T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">管道模式</title>
    <id>http://blog.cjhe.top/design-pattern/concurrency/pipeline.html</id>
    <link href="http://blog.cjhe.top/design-pattern/concurrency/pipeline.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">管道是Unix/Linux上一种典型的并发程序设计模式，也是Unix崇尚组合设计哲学的具体体现，例如执行：
就可以利用管道机制过滤出当前路径下以&amp;quot;.go&amp;quot;结尾的文件列表。
ls -l的输出作为grep &amp;quot;\.go&amp;quot;的输入很容易将两个功能模块串在一起。
管道模式
pipelinepipeline
Go通常使用channel原语构建管道模式
管道模式使用示...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>管道是Unix/Linux上一种典型的并发程序设计模式，也是Unix崇尚<strong>组合</strong>设计哲学的具体体现，例如执行：</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">ls</span> <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"\.go"</span>
</code></pre></div><p>就可以利用管道机制过滤出当前路径下以".go"结尾的文件列表。</p>
<p><code>ls -l</code>的输出作为<code>grep "\.go"</code>的输入很容易将两个功能模块串在一起。</p>
<h2>管道模式</h2>
<figure><figcaption>pipeline</figcaption></figure>
<p>Go通常使用channel原语构建管道模式</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> concurrency

<span class="token keyword">func</span> <span class="token function">echo</span><span class="token punctuation">(</span>nums <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> nums <span class="token punctuation">{</span>
			out <span class="token operator">&lt;-</span> n
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">square</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
			out <span class="token operator">&lt;-</span> n <span class="token operator">*</span> n
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">odd</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
			<span class="token keyword">if</span> n<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				out <span class="token operator">&lt;-</span> n
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>
</code></pre></div><p>管道模式使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> concurrency

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">func</span> <span class="token function">TestPipeline</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token function">odd</span><span class="token punctuation">(</span><span class="token function">echo</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>=== RUN   TestPipeline
    pipeline_test.go:8: 1
    pipeline_test.go:8: 9
    pipeline_test.go:8: 25
    pipeline_test.go:8: 49
    pipeline_test.go:8: 81
</code></pre></div>]]></content>
    <category term="设计模式"/>
    <published>2023-08-22T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">生产者/消费者模式</title>
    <id>http://blog.cjhe.top/design-pattern/concurrency/producer-consumer.html</id>
    <link href="http://blog.cjhe.top/design-pattern/concurrency/producer-consumer.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="text">生产者/消费者模式是并发编程中常见的模型，该模型主要通过平衡生产者和消费者来提高程序的整体处理数据的能力
生产者/消费者模式
该模型中：生产者生产数据，放到队列中，消费者从队列中取数据。这样生产者和消费者变成异步的两个过程。
producer-consumerproducer-consumer
定义生产者
定义消费者
启动生产者和消费者模型
在这个例子...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p><strong>生产者/消费者</strong>模式是并发编程中常见的模型，该模型主要通过平衡生产者和消费者来提高程序的整体处理数据的能力</p>
<h2>生产者/消费者模式</h2>
<p>该模型中：生产者生产数据，放到队列中，消费者从队列中取数据。这样生产者和消费者变成异步的两个过程。</p>
<figure><figcaption>producer-consumer</figcaption></figure>
<p>定义生产者</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Producer: 生产factor倍数</span>
<span class="token keyword">func</span> <span class="token function">Producer</span><span class="token punctuation">(</span>factor <span class="token builtin">int</span><span class="token punctuation">,</span> out <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		out <span class="token operator">&lt;-</span> i <span class="token operator">*</span> factor
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义消费者</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Consumer: 消费打印队列</span>
<span class="token keyword">func</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启动生产者和消费者模型</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">Producer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">Producer</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</code></pre></div><p>在这个例子中，我们启动：</p>
<ul>
<li>两个生产者，分别生产3的倍数、5的倍数</li>
<li>一个消费者，打印队列中的数据</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-08-22T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">defer注意事项</title>
    <id>http://blog.cjhe.top/language/go/base/defer.html</id>
    <link href="http://blog.cjhe.top/language/go/base/defer.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">defer 语句能够帮助我们确保在函数结束时执行一些必要的操作，比如：关闭文件句柄、释放资源、解锁互斥锁等。defer 关键字只能作用函数或函数调用。
注意事项
执行顺序

注意
defer 语句的执行顺序是按照先进后出（FILO）的，即先进去 defer 语句将最后执行。

执行结果
43210

参数计算时机

注意
defer 语句中的函数参数会...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>defer 语句能够帮助我们确保在函数结束时执行一些必要的操作，比如：<strong>关闭文件句柄</strong>、<strong>释放资源</strong>、<strong>解锁互斥锁</strong>等。defer 关键字只能作用函数或函数调用。</p>
<h2>注意事项</h2>
<h3>执行顺序</h3>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>defer 语句的执行顺序是按照先进后出（FILO）的，即先进去 defer 语句将最后执行。</p>
</div>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>43210</p>
</details>
<h3>参数计算时机</h3>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>defer 语句中的函数参数会在 defer 语句被声明时进行求值，而不是在实际执行时。</p>
</div>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>1</p>
</details>
<h3>遇见os.Exit</h3>
<p>主动调用os.Exit(int)退出进程时，defer将不再被执行</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"some thing..."</span><span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>some thing...
exit status 1
</code></pre></div></details>
<h3>延迟函数体</h3>
<h4>延迟函数体未传参</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>2</p>
</details>
<h4>延迟函数体传参</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>1</p>
</details>
<p>demo3和demo4的唯一区别是执行函数体是否传参，却得到完全不同的结果。</p>
<ul>
<li>demo3没有传参，无法直接计算，但是可以引用</li>
<li>demo4传入参数，可以直接计算</li>
</ul>
<h3>可能会操作并影响返回值</h3>
<h4>函数签名返回具名返回值</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>2</p>
</details>
<p>这是由于return并非原子操作，上面函数等价于</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  i <span class="token operator">:=</span> <span class="token number">1</span>
  result <span class="token operator">=</span> i
  result<span class="token operator">++</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>函数签名返回匿名返回值</h4>
<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>这种情况下defer语句可以引用返回值，但不会改变返回值</p>
</div>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleDeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">DeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里等价于返回了一个<code>anony</code>的匿名变量，如下所示：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>anony <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
  anony <span class="token operator">=</span> i
  i<span class="token operator">++</span>
	<span class="token keyword">return</span> anony
<span class="token punctuation">}</span>
</code></pre></div></details>
<h4>显示return常量也可能会影响返回值</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleDeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">DeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>虽然显示返回0，但由于return不是原子操作。等价于：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result <span class="token operator">=</span> <span class="token number">0</span>
	result<span class="token operator">++</span>
	<span class="token keyword">return</span> 
<span class="token punctuation">}</span>
</code></pre></div></details>
]]></content>
    <category term="编程语言"/>
    <published>2023-08-27T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">Go之禅</title>
    <id>http://blog.cjhe.top/language/go/reprint/zen.html</id>
    <link href="http://blog.cjhe.top/language/go/reprint/zen.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="html"><![CDATA[<blockquote>
<p>Python的核心开发成员之一Tim Peter写下的《The Zen of Python》，成为Python编程和设计的指导原则。Go语言步道师Dave Cheney 2020年发表了名为《The Zen of Go》</p>
</blockquote>
]]></summary>
    <content type="html"><![CDATA[<blockquote>
<p>Python的核心开发成员之一Tim Peter写下的《The Zen of Python》，成为Python编程和设计的指导原则。Go语言步道师Dave Cheney 2020年发表了名为《The Zen of Go》</p>
</blockquote>
<!-- more -->
<h2>译文</h2>
<h3>Each package fulfils a single purpose 每一个package实现单一目标</h3>
<p>A well designed Go package provides a single idea, a set of related behaviours. A good Go package starts by choosing a good name. Think of your package’s name as an elevator pitch to describe what it provides, using just one word.
精心设计的Go软件包只提供单一功能和一系列相关的行为。一个好的Go软件包从选择一个好的名字开始。把你的包的名字想象成一个电梯广告，仅用一个词来描述它所提供的功能。</p>
<h3>Handle errors explicitly 显式处理错误</h3>
<p>Robust programs are composed from pieces that handle the failure cases before they pat themselves on the back. The verbosity of if err != nil { return err } is outweighed by the value of deliberately handling each failure condition at the point at which they occur. Panic and recover are not exceptions, they aren’t intended to be used that way.
健壮的程序是由处理失败case的各个片段组成的。 冗长的<code>if err != nil { return err }</code> 比出了故障再一个个去处理更有价值。Panic和recover也一样。</p>
<h3>Return early rather than nesting deeply 尽早return，不要深陷</h3>
<p>Every time you indent you add another precondition to the programmer’s stack consuming one of the 7 ±2 slots in their short term memory. Avoid control flow that requires deep indentation. Rather than nesting deeply, keep the success path to the left using guard clauses.
每缩进一次，就会在程序员的堆栈中增加一个前提条件，占用其短时记忆中 7 ±2 个插槽中的一个。避免需要深度缩进的控制流。与其深度嵌套，不如使用保护子句将成功路径保持在左侧。</p>
<h3>Leave concurrency to the caller 并发权留给调用者</h3>
<p>Let the caller choose if they want to run your library or function asynchronously, don’t force it on them. If your library uses concurrency it should do so transparently.
让调用者自己选择是否要异步运行你的库或函数，不要强迫他们。如果您的程序库使用并发功能，则应透明地使用。</p>
<h3>Before you launch a goroutine, know when it will stop 在启动goroutine之前，要知道它什么时候会停止</h3>
<p>Goroutines own resources; locks, variables, memory, etc. The sure fire way to free those resources is to stop the owning goroutine.
goroutine 拥有锁、变量、内存等资源。释放这些资源的可靠方法是停止拥有资源的 goroutine。</p>
<h3>Avoid package level state 避免包级状态</h3>
<p>Seek to be explicit, reduce coupling, and spooky action at a distance by providing the dependencies a type needs as fields on that type rather than using package variables.
通过将类型所需的依赖关系作为该类型的字段而不是使用包变量来提供，力求显式化，减少耦合，并实现超距作用。</p>
<h3>Simplicity matters 简单很重要</h3>
<p>Simplicity is not a synonym for unsophisticated. Simple doesn’t mean crude, it means readable and maintainable. When it is possible to choose, defer to the simpler solution.
简单不是容易（不复杂）的同义词。简单并不意味着粗糙，它意味着可读性和可维护性。如果可以选择，请遵循较简单的解决方案。</p>
<h3>Write tests to lock in the behaviour of your package’s API 编写测试以确定包API的行为</h3>
<p>Test first or test later, if you shoot for 100% test coverage or are happy with less, regardless your package’s API is your contract with its users. Tests are the guarantees that those contracts are written in. Make sure you test for the behaviour that users can observe and rely on.
先测试还是后测试，是追求 100% 的测试覆盖率还是满足于较低的测试覆盖率，无论如何，软件包的应用程序接口都是您与用户之间的契约。测试是这些合约的保证。请确保您测试的是用户可以观察和依赖的行为。</p>
<h3>If you think it’s slow, first prove it with a benchmark 如果你觉得慢，先用基准来证明</h3>
<p>So many crimes against maintainability are committed in the name of performance. Optimisation tears down abstractions, exposes internals, and couples tightly. If you’re choosing to shoulder that cost, ensure it is done for good reason.
以性能为名，对可维护性犯下了许多罪行。优化会破坏抽象概念，暴露内部结构，并造成紧密耦合。如果你选择承担这种代价，请确保这样做是有充分理由的。</p>
<h3>Moderation is a virtue 节制是一种美德</h3>
<p>Use goroutines, channels, locks, interfaces, embedding, in moderation.
适度使用goroutines、channels、locks、interfaces、embedded。</p>
<h3>Maintainability counts 可维护性很重要</h3>
<p>Clarity, readability, simplicity, are all aspects of maintainability. Can the thing you worked hard to build be maintained after you’re gone? What can you do today to make it easier for those that come after you?
清晰度、可读性、简洁性都是可维护性的体现。你辛辛苦苦创建的东西在你离开后还能被维护吗？你今天能做些什么来让你的后人更容易地维护它？</p>
<h2>参考文献</h2>
<p><a href="https://the-zen-of-go.netlify.app" target="_blank" rel="noopener noreferrer">简洁版</a>
<a href="https://dave.cheney.net/2020/02/23/the-zen-of-go" target="_blank" rel="noopener noreferrer">完整版</a></p>
]]></content>
    <author>
      <name>Dave Cheney</name>
    </author>
    <category term="编程语言"/>
    <contributor>
      <name>Dave Cheney</name>
    </contributor>
    <published>2023-08-15T00:00:00.000Z</published>
    <rights>Copyright by Dave Cheney</rights>
  </entry>
  <entry>
    <title type="text">Go箴言</title>
    <id>http://blog.cjhe.top/language/go/reprint/proverb.html</id>
    <link href="http://blog.cjhe.top/language/go/reprint/proverb.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="html"><![CDATA[<p>【转】<a href="http://go-proverbs.github.io/" target="_blank" rel="noopener noreferrer">原文链接</a></p>
]]></summary>
    <content type="html"><![CDATA[<p>【转】<a href="http://go-proverbs.github.io/" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<blockquote>
<p>Go 语言之父 Rob Pike 在 2015 年分享的主题《Go Proverbs》</p>
<p>核心理念是：简单、诗意、简洁（Simple, Poetic, Pithy）。</p>
</blockquote>
<h2>译文</h2>
<p>Don't communicate by sharing memory, share memory by communicating.
不要通过共享内存进行通信，通过通信共享内存</p>
<p>Concurrency is not parallelism.
并发不是并行</p>
<p>Channels orchestrate; mutexes serialize.
管道用于协调；互斥锁用于同步</p>
<p>The bigger the interface, the weaker the abstraction.
接口越大，抽象就越弱</p>
<p>Make the zero value useful.
利用好零值</p>
<p>interface{} says nothing.
空接口 interface{} 没有任何类型约束</p>
<p>Gofmt's style is no one's favorite, yet gofmt is everyone's favorite.
Gofmt 的风格不是人们最喜欢的，但 gofmt 是每个人的最爱</p>
<p>A little copying is better than a little dependency.
允许一点点重复比引入一点点依赖更好</p>
<p>Syscall must always be guarded with build tags.
系统调用必须始终使用构建标记进行保护</p>
<p>Cgo must always be guarded with build tags.
必须始终使用构建标记保护 Cgo</p>
<p>Cgo is not Go.
Cgo 不是 Go。</p>
<p>With the unsafe package there are no guarantees.
使用标准库的 unsafe 包，不能保证能如期运行</p>
<p>Clear is better than clever.
清晰比聪明更好</p>
<p>Reflection is never clear.
反射永远不清晰</p>
<p>Errors are values.
错误是值</p>
<p>Don't just check errors, handle them gracefully.
不要只检查错误，还要优雅地处理它们</p>
<p>Design the architecture, name the components, document the details.
设计架构，命名组件，文档记录细节</p>
<p>Documentation is for users.
文档是供用户使用的</p>
<p>Don't panic.
不要使用 panic</p>
<h2>参考文献</h2>
<p><a href="http://go-proverbs.github.io/" target="_blank" rel="noopener noreferrer">原文链接</a>
<a href="https://zhuanlan.zhihu.com/p/514680942" target="_blank" rel="noopener noreferrer">中文译文</a></p>
]]></content>
    <author>
      <name>Rob Pike</name>
    </author>
    <category term="编程语言"/>
    <contributor>
      <name>Rob Pike</name>
    </contributor>
    <published>2023-08-15T00:00:00.000Z</published>
    <rights>Copyright by Rob Pike</rights>
  </entry>
  <entry>
    <title type="text">变更日志</title>
    <id>http://blog.cjhe.top/CHANGELOG.html</id>
    <link href="http://blog.cjhe.top/CHANGELOG.html"/>
    <updated>2024-07-12T03:29:24.000Z</updated>
    <summary type="text">v0.12.3 (2024-07-12)
✨Features

language: 增加Go语言在Docker环境下设置maxprocs


v0.12.2 (2024-06-23)
🐛Bug Fixes

language: 修改Go命令

♻️Code Refactoring

language: Go练习和社区和文章

✨Features

l...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p><a name="v0.12.3"></a></p>
<h2><a class="header-anchor" href="#v0-12-3-2024-07-12"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.12.2...v0.12.3" target="_blank" rel="noopener noreferrer">v0.12.3</a> (2024-07-12)</h2>
<h3>✨Features</h3>
<ul>
<li><strong>language:</strong> 增加Go语言在Docker环境下设置maxprocs</li>
</ul>
<p><a name="v0.12.2"></a></p>
<h2><a class="header-anchor" href="#v0-12-2-2024-06-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.12.1...v0.12.2" target="_blank" rel="noopener noreferrer">v0.12.2</a> (2024-06-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>language:</strong> 修改Go命令</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>language:</strong> Go练习和社区和文章</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>language:</strong> 增加go语言内存对齐</li>
<li><strong>language:</strong> 增加go command</li>
<li><strong>language:</strong> 增加Go测试MySQL</li>
</ul>
<p><a name="v0.12.1"></a></p>
<h2><a class="header-anchor" href="#v0-12-1-2024-05-29"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.12.0...v0.12.1" target="_blank" rel="noopener noreferrer">v0.12.1</a> (2024-05-29)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>language:</strong> 修改Go禁止拷贝</li>
<li><strong>language:</strong> 补充go语言一些示例</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>http链接改为https</li>
<li>调整devops和database内容</li>
<li>顺序调整</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>database:</strong> 增加nacos监控</li>
<li><strong>database:</strong> 增加mysql相关图</li>
<li><strong>go:</strong> 增加Go语言sync.Map底层原理</li>
<li><strong>language:</strong> Go如何禁止拷贝</li>
</ul>
<p><a name="v0.12.0"></a></p>
<h2><a class="header-anchor" href="#v0-12-0-2024-05-12"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.11.4...v0.12.0" target="_blank" rel="noopener noreferrer">v0.12.0</a> (2024-05-12)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>修改个人信息</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整图标</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>devops:</strong> 增加makefile部署k8s应用</li>
<li><strong>devops:</strong> 增加chartmuseum</li>
<li><strong>share:</strong> 增加十二因素应用原则</li>
</ul>
<p><a name="v0.11.4"></a></p>
<h2><a class="header-anchor" href="#v0-11-4-2024-05-07"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.11.3...v0.11.4" target="_blank" rel="noopener noreferrer">v0.11.4</a> (2024-05-07)</h2>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>database:</strong> 调整分布式锁</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>database:</strong> 增加基于Redis实现消息到期提醒</li>
</ul>
<p><a name="v0.11.3"></a></p>
<h2><a class="header-anchor" href="#v0-11-3-2024-05-07"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.11.2...v0.11.3" target="_blank" rel="noopener noreferrer">v0.11.3</a> (2024-05-07)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改icon</li>
<li><strong>language:</strong> vue组件通信增加slot</li>
<li><strong>language:</strong> vue组件通信增加pinia</li>
<li><strong>language:</strong> vue组件通信增加provide和inject</li>
<li><strong>language:</strong> vue组件通信增加ref和$parent</li>
<li><strong>language:</strong> vue组件通信增加useAttrs</li>
<li><strong>language:</strong> vue组件通信增加v-model</li>
</ul>
<p><a name="v0.11.2"></a></p>
<h2><a class="header-anchor" href="#v0-11-2-2024-05-06"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.11.1...v0.11.2" target="_blank" rel="noopener noreferrer">v0.11.2</a> (2024-05-06)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>增加icon</li>
<li>样式调整</li>
<li><strong>devops:</strong> helm-dashboard支持先行版本</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整编程语言</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>language:</strong> vue增加组件通信</li>
</ul>
<p><a name="v0.11.1"></a></p>
<h2><a class="header-anchor" href="#v0-11-1-2024-04-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.11.0...v0.11.1" target="_blank" rel="noopener noreferrer">v0.11.1</a> (2024-04-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>修改作者</li>
<li>修改title</li>
<li><strong>network:</strong> 移动ICMP协议</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>优化changelog</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>devops:</strong> 增加minio监控</li>
<li><strong>devops:</strong> 增加mongodb监控</li>
<li><strong>go-language:</strong> 增加在线书籍</li>
</ul>
<p><a name="v0.11.0"></a></p>
<h2><a class="header-anchor" href="#v0-11-0-2024-04-14"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.10.1...v0.11.0" target="_blank" rel="noopener noreferrer">v0.11.0</a> (2024-04-14)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>修改vuepress icon</li>
<li>修复bug</li>
<li><strong>devops:</strong> 修改helm-dashboard</li>
<li><strong>go-language:</strong> 修改map，增加一些注意事项</li>
<li><strong>go-language:</strong> defer增加遇见os.Exit</li>
<li><strong>go-language:</strong> 修改数据类型</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整devops到k8s子类</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>devops:</strong> 增加redis监控</li>
<li><strong>devops:</strong> 增加mysql监控</li>
<li><strong>devops:</strong> 增加记录docker执行报错问题</li>
<li><strong>devops:</strong> 增加helm-dashboard简介</li>
<li><strong>devops:</strong> 增加kube-state-metrics k8s 部署</li>
<li><strong>devops:</strong> 增加cadvisor k8s部署</li>
<li><strong>devops:</strong> 增加node-exporter k8s部署</li>
<li><strong>devops:</strong> 增加Prometheus k8s部署</li>
<li><strong>go-language:</strong> 增加Go项目脚手架</li>
<li><strong>network:</strong> 增加HTTP协议介绍</li>
</ul>
<p><a name="v0.10.1"></a></p>
<h2><a class="header-anchor" href="#v0-10-1-2023-09-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.10.0...v0.10.1" target="_blank" rel="noopener noreferrer">v0.10.1</a> (2023-09-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> 修改flag标准库，增加底层原理</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整目录顺序</li>
</ul>
<p><a name="v0.10.0"></a></p>
<h2><a class="header-anchor" href="#v0-10-0-2023-09-20"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.9.2...v0.10.0" target="_blank" rel="noopener noreferrer">v0.10.0</a> (2023-09-20)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> 修改第三方库</li>
<li><strong>project-language:</strong> 提交规范增加参考文献</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>go-language:</strong> 增加三方库pflag介绍</li>
</ul>
<p><a name="v0.9.2"></a></p>
<h2><a class="header-anchor" href="#v0-9-2-2023-09-11"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.9.1...v0.9.2" target="_blank" rel="noopener noreferrer">v0.9.2</a> (2023-09-11)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> flag增加子命令</li>
<li><strong>go-language:</strong> 修改flag</li>
</ul>
<h3>✨Features</h3>
<ul>
<li>增加Go语言标准库</li>
</ul>
<p><a name="v0.9.1"></a></p>
<h2><a class="header-anchor" href="#v0-9-1-2023-09-05"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.9.0...v0.9.1" target="_blank" rel="noopener noreferrer">v0.9.1</a> (2023-09-05)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改创建型设计模式</li>
</ul>
<p><a name="v0.9.0"></a></p>
<h2><a class="header-anchor" href="#v0-9-0-2023-09-02"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.8.0...v0.9.0" target="_blank" rel="noopener noreferrer">v0.9.0</a> (2023-09-02)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> 修改Go语言简介</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>go-language:</strong> 增加defer和recover注意事项</li>
<li><strong>go-language:</strong> 增加package介绍</li>
<li><strong>network:</strong> 增加MQTT介绍</li>
</ul>
<p><a name="v0.8.0"></a></p>
<h2><a class="header-anchor" href="#v0-8-0-2023-08-22"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.7.1...v0.8.0" target="_blank" rel="noopener noreferrer">v0.8.0</a> (2023-08-22)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改并发模式</li>
<li><strong>go-language:</strong> 修改Go之禅中模糊的含义</li>
<li><strong>go-language:</strong> 修改slice</li>
<li><strong>middleware:</strong> 修改监控系统至中间件</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>markdown格式优化</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>go-language:</strong> 增加Go之禅</li>
<li><strong>go-language:</strong> 转载Go箴言</li>
</ul>
<p><a name="v0.7.1"></a></p>
<h2><a class="header-anchor" href="#v0-7-1-2023-08-13"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.7.0...v0.7.1" target="_blank" rel="noopener noreferrer">v0.7.1</a> (2023-08-13)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改设计原则</li>
<li><strong>go-language:</strong> 修改Go语言基础</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整函数模式和并发模式</li>
</ul>
<p><a name="v0.7.0"></a></p>
<h2><a class="header-anchor" href="#v0-7-0-2023-08-07"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.6.0...v0.7.0" target="_blank" rel="noopener noreferrer">v0.7.0</a> (2023-08-07)</h2>
<h3>♻️Code Refactoring</h3>
<ul>
<li>侧边栏可折叠</li>
<li>调整目录结构</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>design-pattern:</strong> 增加选项模式</li>
</ul>
<p><a name="v0.6.0"></a></p>
<h2><a class="header-anchor" href="#v0-6-0-2023-08-03"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.5.0...v0.6.0" target="_blank" rel="noopener noreferrer">v0.6.0</a> (2023-08-03)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>修改设计模式</li>
<li>配置页面元数据</li>
<li>自动化部署问题修复</li>
<li>删除临时文件</li>
<li><strong>design-pattern:</strong> 修改设计模式问题</li>
<li><strong>project-stanard:</strong> 修改项目规范一些问题</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整侧边栏和导航栏</li>
<li>调整导航栏和侧边栏</li>
<li><strong>databae:</strong> 优化数据库查询</li>
</ul>
<h3>✨Features</h3>
<ul>
<li>增加变更日志</li>
<li>增加Go语言爱好者周刊友情链接</li>
<li>切换为vuepress-theme-hope</li>
</ul>
<p><a name="v0.5.0"></a></p>
<h2><a class="header-anchor" href="#v0-5-0-2022-05-24"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.4.0...v0.5.0" target="_blank" rel="noopener noreferrer">v0.5.0</a> (2022-05-24)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>database:</strong> 增加事务一致性视图</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>go-language:</strong> 修改操作符</li>
<li><strong>go-language:</strong> 调整数组与切片</li>
<li><strong>go-language:</strong> 字符串调整</li>
<li><strong>go-language:</strong> 数组与切片调整</li>
<li><strong>go-language:</strong> 调整变量、常量及命名规则</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>database:</strong> 增加mysql读过程、写过程和事务</li>
<li><strong>database:</strong> 增加redis大纲</li>
<li><strong>go-language:</strong> 增加break使用说明</li>
<li><strong>go-language:</strong> 增加for-range注意点</li>
<li><strong>go-language:</strong> 增加字符串底层结构</li>
<li><strong>go-language:</strong> 增加map介绍</li>
</ul>
<p><a name="v0.4.0"></a></p>
<h2><a class="header-anchor" href="#v0-4-0-2022-03-27"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.4...v0.4.0" target="_blank" rel="noopener noreferrer">v0.4.0</a> (2022-03-27)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>algorithm:</strong> 增加限流-令牌桶算法</li>
<li><strong>project-standard:</strong> 增加语义化版本工具</li>
<li><strong>project-standard:</strong> 增加语义化版本详细外链</li>
<li><strong>project-standard:</strong> 增加readme.so外链</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>database:</strong> 增加MySQL-表连接</li>
<li><strong>go-language:</strong> 增加一些环境变量说明</li>
<li><strong>tools:</strong> 增加CA证书</li>
</ul>
<p><a name="v0.3.4"></a></p>
<h2><a class="header-anchor" href="#v0-3-4-2022-03-20"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.3...v0.3.4" target="_blank" rel="noopener noreferrer">v0.3.4</a> (2022-03-20)</h2>
<h3>✨Features</h3>
<ul>
<li><strong>algorithm:</strong> 增加限流算法</li>
</ul>
<p><a name="v0.3.3"></a></p>
<h2><a class="header-anchor" href="#v0-3-3-2022-03-03"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.2...v0.3.3" target="_blank" rel="noopener noreferrer">v0.3.3</a> (2022-03-03)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>project-standard:</strong> 项目管理改为项目规范</li>
</ul>
<p><a name="v0.3.2"></a></p>
<h2><a class="header-anchor" href="#v0-3-2-2022-02-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.1...v0.3.2" target="_blank" rel="noopener noreferrer">v0.3.2</a> (2022-02-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>data-structure:</strong> 删除二叉搜索树迭代版本</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整结构和描述</li>
</ul>
<p><a name="v0.3.1"></a></p>
<h2><a class="header-anchor" href="#v0-3-1-2022-02-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.0...v0.3.1" target="_blank" rel="noopener noreferrer">v0.3.1</a> (2022-02-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>data-structure:</strong> 修改二叉搜索树删除节点算法</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>data-structure:</strong> 修改删除最小节点命名</li>
</ul>
<p><a name="v0.3.0"></a></p>
<h2><a class="header-anchor" href="#v0-3-0-2022-02-20"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.2.0...v0.3.0" target="_blank" rel="noopener noreferrer">v0.3.0</a> (2022-02-20)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>data-structure:</strong> 侧边栏修复</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>data-structure:</strong> 增加二叉搜索树</li>
<li><strong>data-structure:</strong> 增加二叉树</li>
</ul>
<p><a name="v0.2.0"></a></p>
<h2><a class="header-anchor" href="#v0-2-0-2022-02-11"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.1.0...v0.2.0" target="_blank" rel="noopener noreferrer">v0.2.0</a> (2022-02-11)</h2>
<h3>✨Features</h3>
<ul>
<li><strong>project-manager:</strong> 增加分支规范</li>
</ul>
<p><a name="v0.1.0"></a></p>
<h2><a class="header-anchor" href="#v0-1-0-2022-02-09"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.0.1...v0.1.0" target="_blank" rel="noopener noreferrer">v0.1.0</a> (2022-02-09)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>project-manager:</strong> 修正目录规范</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>commit:</strong> 增加语义化版本自动生成工具gsemver配置和介绍</li>
<li><strong>commit:</strong> 增加CHANGE LOG自动生产</li>
<li><strong>docs:</strong> 增加变更历史</li>
<li><strong>project-manager:</strong> 增加目录规范</li>
</ul>
<p><a name="v0.0.1"></a></p>
<h2>v0.0.1 (2022-02-03)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>更新侧边栏</li>
<li>update sidebar</li>
<li>project manager</li>
<li><strong>monitor-system:</strong> 统一图片文件夹命名</li>
<li><strong>project-manager:</strong> 更新提交规范</li>
<li><strong>project-manager:</strong> update version</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>go-language:</strong> 调整结构</li>
<li><strong>go-language:</strong> 调整结构</li>
</ul>
<h3>✨Features</h3>
<ul>
<li>增加CHANGE LOG</li>
<li>增加版本规范</li>
<li>项目文档规范</li>
<li>add project manager</li>
<li>add README.md</li>
<li><strong>design-pattern:</strong> add some design pattern</li>
<li><strong>project-manager:</strong> add api standard</li>
<li><strong>project-manager:</strong> add api standard</li>
<li><strong>project-manager:</strong> add commit standard</li>
</ul>
]]></content>
    <published>2024-07-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">工厂模式的比较</title>
    <id>http://blog.cjhe.top/design-pattern/creational/factory-compare.html</id>
    <link href="http://blog.cjhe.top/design-pattern/creational/factory-compare.html"/>
    <updated>2024-05-15T10:01:59.000Z</updated>
    <summary type="text">简单工厂模式、工厂方法模式、抽象工厂模式都可以统称为工厂模式，其中：
简单工厂模式：适用于需要根据客户端的输入来创建对象的场景，但不符合开闭原则，随着产品的增加需要修改工厂类。
工厂方法模式：通过将具体产品的创建延迟到子类中实现，符合开闭原则，每个具体工厂类负责创建一个具体产品。
抽象工厂模式：适用于需要创建一组相关产品对象的场景，每个具体工厂类负责创...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>简单工厂模式、工厂方法模式、抽象工厂模式都可以统称为工厂模式，其中：</p>
<p>简单工厂模式：适用于需要根据客户端的输入来创建对象的场景，但不符合<code>开闭原则</code>，随着产品的增加需要修改工厂类。</p>
<p>工厂方法模式：通过将具体产品的创建延迟到子类中实现，符合<code>开闭原则</code>，每个具体工厂类负责创建一个具体产品。</p>
<p>抽象工厂模式：适用于需要创建一组相关产品对象的场景，每个具体工厂类负责创建一组相关产品。</p>
<p>选择适合的创建型设计模式取决于具体的项目需求和设计考虑，简单工厂模式简单易懂但可扩展性差，工厂方法模式更灵活但需要额外的子类，而抽象工厂模式适用于创建一组相关的产品对象。</p>
]]></content>
    <category term="设计模式"/>
    <published>2023-07-31T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">关于我</title>
    <id>http://blog.cjhe.top/intro.html</id>
    <link href="http://blog.cjhe.top/intro.html"/>
    <updated>2024-05-11T07:09:37.000Z</updated>
    <summary type="text">一枚后端攻城狮，热爱Go、Vue等技术栈。

介绍页
profile-details
profile-language
commit-language
stats
time</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>一枚后端攻城狮，热爱Go、Vue等技术栈。</p>
</blockquote>
<h2>介绍页</h2>
<p><img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/0-profile-details.svg" alt="profile-details" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/1-repos-per-language.svg" alt="profile-language" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/2-most-commit-language.svg" alt="commit-language" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/3-stats.svg" alt="stats" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/4-productive-time.svg" alt="time" loading="lazy"></p>
]]></content>
    <published>2023-07-30T09:20:01.000Z</published>
  </entry>
  <entry>
    <title type="text">幻灯片页</title>
    <id>http://blog.cjhe.top/slides.html</id>
    <link href="http://blog.cjhe.top/slides.html"/>
    <updated>2023-07-30T09:20:01.000Z</updated>
    <summary type="html"><![CDATA[<!-- markdownlint-disable MD024 MD033 MD051 -->
]]></summary>
    <content type="html"><![CDATA[<!-- markdownlint-disable MD024 MD033 MD051 -->
]]></content>
    <published>2023-07-30T09:20:01.000Z</published>
  </entry>
  <entry>
    <title type="text">设计模式</title>
    <id>http://blog.cjhe.top/design-pattern/</id>
    <link href="http://blog.cjhe.top/design-pattern/"/>
    <updated>2024-05-06T08:19:23.000Z</updated>
    <summary type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>面向对象是<strong>武器</strong></p>
<p>设计模式是<strong>招式</strong></p>
<p>设计原则是<strong>心法</strong></p>
<p>以心法为基础，以武器运用招式应对复杂的编程问题</p>
</div>
]]></summary>
    <content type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>面向对象是<strong>武器</strong></p>
<p>设计模式是<strong>招式</strong></p>
<p>设计原则是<strong>心法</strong></p>
<p>以心法为基础，以武器运用招式应对复杂的编程问题</p>
</div>
<!-- more -->
<h2>什么是设计模式</h2>
<p>设计模式最早来源于建筑领域</p>
<blockquote>
<p>克里斯托弗.亚历山大在作品《建筑的永恒之道》中这样说："每个模式都描述了一个在我们的环境中不断出现的问题，然后描述了该问题的解决方案的核心，通过这种方式，我们可以无数次地重用那些已有的成功的解决方案，无须再重复相同的工作。"</p>
</blockquote>
<p>之后四人组（Gang of Four，简称GoF）将模式的概念应用在软件开发设计中，定义如下：</p>
<blockquote>
<p>它是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结。</p>
<p>它描述了在软件设计过程中的一些不断重复发生的问题，以及该问题的解决方案。</p>
</blockquote>
<p>简单来说，就是<strong>解决特定问题的一系列解决方案</strong>，是前辈们的代码设计经验的总结。</p>
<h2>有哪些优点</h2>
<ul>
<li><strong>提高代码复用性</strong>：设计模式的核心目标之一是提供可复用的解决方案。通过使用设计模式，可以将通用的解决方法应用于不同的情况，从而减少代码的冗余和重复编写。</li>
<li><strong>提高代码的可读性和可维护性</strong>：设计模式通过引入一定的结构和规范，使代码更有组织性和可读性。开发人员可以更轻松地理解和维护代码逻辑。</li>
<li><strong>降低代码耦合度</strong>：设计模式通过将系统分解为多个独立的部分，每个部分都有明确定义的职责和接口，从而降低了代码的耦合度。这使得系统更易于扩展、修改和维护。</li>
<li><strong>提高系统的可扩展性和灵活性</strong>：设计模式鼓励使用接口和抽象类进行编程，而不是具体的实现类。这种松耦合的设计使得系统更易于扩展，可以方便地引入新的功能和模块。</li>
<li><strong>提高系统的可测试性</strong>：设计模式将系统分解为多个独立的部分，每个部分都可以独立测试。这样可以更容易地编写和执行单元测试，提高代码的质量和可靠性。</li>
</ul>
<h2>有哪些要素</h2>
<ul>
<li><strong>问题</strong>：问题或称为上下文、场景，指在软件开发中需要解决的某个问题或需求。设计模式通常解决针对特定上下文或场景中出现的问题。</li>
<li><strong>解决方案</strong>：解决方案或称为模型、模式，是指用于解决上述问题的通用方法或最佳实践。设计模式描述了解决某问题的方法或模板，并提供了这些方法的实现细节，使得类似问题可以被解决且易于复用。</li>
<li><strong>效果</strong>：效果或称为结果、贡献，是指使用该模式带来的好处和优点。设计模式提供了可重用、灵活的解决方案，增加可维护性、可扩展性和可重用性。</li>
<li><strong>元素</strong>：元素或称为参与者、角色、类和对象，组成了设计模式的各个部分。这些元素可以是类、对象、接口、方法等等。元素描述了在特定上下文或场景中参与模式实现的各种组件。</li>
</ul>
<h2>具体分类</h2>
<figure><figcaption>分类</figcaption></figure>
]]></content>
    <category term="设计模式"/>
    <published>2022-09-10T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">设计原则</title>
    <id>http://blog.cjhe.top/design-pattern/principle.html</id>
    <link href="http://blog.cjhe.top/design-pattern/principle.html"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="text">设计原则是心法，对于构建高质量的软件系统提供指导和约束，它具有以下作用：

提高代码质量：设计原则强调代码的清晰性、可读性和可维护性。通过遵循设计原则，可以编写出更结构化、更模块化的代码，减少代码重复和冗余。
降低耦合度：设计原则鼓励松散耦合的设计，将系统划分为更小的、相互独立的模块。这样可以减少模块之间的依赖关系，提高系统的灵活性和可扩展性。
促进代...</summary>
    <content type="html"><![CDATA[<!-- more -->
<p>设计原则是心法，对于构建高质量的软件系统提供<strong>指导</strong>和<strong>约束</strong>，它具有以下作用：</p>
<ul>
<li>提高代码质量：设计原则强调代码的清晰性、可读性和可维护性。通过遵循设计原则，可以编写出更结构化、更模块化的代码，减少代码重复和冗余。</li>
<li>降低耦合度：设计原则鼓励松散耦合的设计，将系统划分为更小的、相互独立的模块。这样可以减少模块之间的依赖关系，提高系统的灵活性和可扩展性。</li>
<li>促进代码重用：设计原则推崇封装、继承、多态等面向对象的特性，使得代码更易于重用。通过设计模式和设计原则，可以将通用的解决方案抽象出来，并在不同的场景中重复应用。</li>
<li>简化系统维护：良好的设计原则可以减少系统的耦合和复杂度，使系统更易于理解和维护。当需要对系统进行修改或扩展时，通过遵循设计原则，可以更快速、更安全地进行变更。</li>
<li>提高团队协作效率：设计原则提供了一种通用的设计思维和规范，使整个团队在设计和开发过程中能够更好地进行交流和协作。团队成员可以共同理解和遵循设计原则，降低沟通成本，提高开发效率。</li>
</ul>
<h2>SOLID原则</h2>
<p>SOLID原则是由罗伯特·C·马丁在21世纪早期引入，指代了面向对象编程和面向对象设计的五个基本原则。遵循SOLID原则可以确保我们设计的代码是易维护、易扩展、易阅读的。SOLID原则同样也适用于Go程序设计。具体SOLID编码原则见下表：</p>
<p>| 简写 | 全称                                | 中文描述     |
|</p>
]]></content>
    <category term="设计模式"/>
    <published>2022-10-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">高质量代码</title>
    <id>http://blog.cjhe.top/design-pattern/quantity-code.html</id>
    <link href="http://blog.cjhe.top/design-pattern/quantity-code.html"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>什么样的代码才是高质量的代码❓</p>
</div>
]]></summary>
    <content type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>什么样的代码才是高质量的代码❓</p>
</div>
<!-- more -->
<h2>什么是高质量代码</h2>
<p>代码质量的评价有很强的主观性，描述代码质量的词汇也有很多，比如可读性、可维护性、灵活、优雅、简洁等，这些词汇是从不同的维度去评价代码质量的。它们之间有互相作用，并不是独立的，比如，代码的可读性好、可扩展性好就意味着代码的可维护性好。代码质量高低是一个综合各种因素得到的结论。我们并不能通过单一的维度去评价一段代码的好坏。</p>
<h3>可维护性（maintainability）</h3>
<blockquote>
<p>维护：无外乎就是修改bug、修改老的代码、添加新的代码之类的工作。</p>
</blockquote>
<p><strong>维护代码的时间远远大于编写代码的时间</strong>
其中：</p>
<ul>
<li>代码易维护：在不破坏原有代码设计、不引入新的bug的情况下，能够快速地修改或者添加代码。</li>
<li>代码不易维护：修改或者添加代码需要冒着极大的引入新bug的风险，并且需要花费很长的时间才能完成。</li>
</ul>
<h3>可读性（readability）</h3>
<blockquote>
<p>可读：代码易读易理解</p>
</blockquote>
<p><strong>代码被阅读的次数远远超过被编写的次数</strong>
我们可以从以下方面来评价：</p>
<ol>
<li>代码是否符合编码规范；</li>
<li>命名是否达意；</li>
<li>注释是否详尽；</li>
<li>函数是否长短合适；</li>
<li>模块划分是否清晰；</li>
<li>是否符合高内聚低耦合；</li>
</ol>
<h3>可扩展性（extensibility）</h3>
<blockquote>
<p>可扩展：代码应对未来需求变化的能力</p>
</blockquote>
<p><strong>开闭原则：对修改关闭，对扩展开放</strong>
评判标准：</p>
<ul>
<li>我们在不修改或少量修改原有代码的情况，通过扩展的方式添加新的功能代码；</li>
<li>代码预留了一些功能扩展点，不需要因为添加一个功能而大动干戈，改动大量的原始代码；</li>
</ul>
<h3>灵活性（flexibility）</h3>
<blockquote>
<p>灵活：代码易扩展、易复用或者易用</p>
</blockquote>
<p>举例如下：</p>
<ul>
<li>
<p>易扩展：当我们添加一个新的功能代码的时候，原有的代码已经预留好了扩展点，我们不需要修改原有的代码，只要在扩展点上添加新的代码即可。这个时候，我们除了可以说代码易扩展，还可以说代码写得好灵活。</p>
</li>
<li>
<p>易复用：当我们要实现一个功能的时候，发现原有代码中，已经抽象出了很多底层可以复用的模块、类等代码，我们可以拿来直接使用。这个时候，我们除了可以说代码易复用之外，还可以说代码写得好灵活。</p>
</li>
<li>
<p>易用：当我们使用某组接口的时候，如果这组接口可以应对各种使用场景，满足各种不同的需求，我们除了可以说接口易用之外，还可以说这个接口设计得好灵活或者代码写得好灵活。</p>
</li>
</ul>
<h3>简洁性（simplicity）</h3>
<blockquote>
<p>简洁：代码简单、逻辑清晰</p>
</blockquote>
<p><strong>KISS原则：“Keep it Simple,Stupid”</strong>
怎么评判呢？每个人的标准都不一样，我觉得能够快速理解业务逻辑就是简单的。"思从深而行从简，真正的高手能云淡风轻地用最简单的方法解决最复杂的问题。"</p>
<h3>可复用性（reusability）</h3>
<blockquote>
<p>可复用：尽量减少重复代码的编写，复用已有的代码。</p>
</blockquote>
<p><strong>DRY原则：“Don't Repeat Yourself”</strong>
使用技巧：</p>
<ul>
<li>面向对象特性：继承和多态就是为了提高可复用性；</li>
<li>解耦、高内聚、模块化等思想都能提高代码的可复用性；</li>
<li>单一职责原则与可复用性相关；</li>
</ul>
<h3>可测试性（testability）</h3>
<blockquote>
<p>可测试：能否方便地测试代码逻辑</p>
</blockquote>
<p>评判标准：</p>
<ul>
<li>即便有存储和第三方服务也能测试；</li>
<li>不依赖各个环境；</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2022-11-01T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">分支规范</title>
    <id>http://blog.cjhe.top/project-standard/branch.html</id>
    <link href="http://blog.cjhe.top/project-standard/branch.html"/>
    <updated>2024-05-05T15:52:14.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015122301.png" alt="git-model" tabindex="0" loading="lazy"><figcaption>git-model</figcaption></figure>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>一个好的代码分支应该是怎样的❓</p>
</div>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015122301.png" alt="git-model" tabindex="0" loading="lazy"><figcaption>git-model</figcaption></figure>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>一个好的代码分支应该是怎样的❓</p>
</div>
<!-- more -->
<h2>分支模型</h2>
<p>我们经常使用Git用于管理版本，但如果没有清晰的流程和规范，会导致难以协调和维护。
Vincent Driessen 为了解决这个问题，提出<a href="https://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener noreferrer">A Successful Git Branching Model</a></p>
<figure><figcaption>git-model</figcaption></figure>
<h2>master分支</h2>
<p>这个分支保持最近发布到生产环境的代码。</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>不能在这个分支直接修改</li>
<li>生产环境运行的代码和该分支保持一致</li>
<li>master分支每合并一个hotfix/release分支，都会打一个版本标签</li>
</ul>
</div>
<h2>develop分支</h2>
<p>这个分支是我们的主开发分支</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>feature/release/hotfix都需要合并到该分支</p>
</div>
<h2>feature分支</h2>
<p>这个分支是用来开发新的功能，一旦开发完成，合并到develop分支并进入下一个release</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>分支命名建议：<code>feature/xxx-xxx</code></li>
<li>合并到develop分支需要删除该分支，如果有bug，在对应的release分支进行修复</li>
<li>feature分支合并到develop分支之前先pull一下develop分支，避免冲突</li>
</ul>
</div>
<h2>release分支</h2>
<p>当需要发布一个新的release的时候，基于develop分支创建一个release分支</p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<ul>
<li>分支名建议命名<code>release/xxx-xxx</code></li>
<li>测试人员基于release分支进行测试，如有bug，也在该分支修复，再测试。</li>
<li>完成release分支后需要合并到master和develop分支</li>
</ul>
</div>
<h2>hotfix分支</h2>
<p>当在现网发现bug时，需要创建一个hotfix分支进行修复，完成后合并到master和develop，hotfix的改动会进入下一个release</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>建议命名：<code>hotfix/xxx-xxx</code></li>
<li>只能基于master分支创建hotfix分支</li>
</ul>
</div>
]]></content>
    <category term="项目规范"/>
    <published>2020-02-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">目录规范</title>
    <id>http://blog.cjhe.top/project-standard/directory.html</id>
    <link href="http://blog.cjhe.top/project-standard/directory.html"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>Go语言项目业界公认的目录结构是怎样的❓</p>
</div>
]]></summary>
    <content type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>Go语言项目业界公认的目录结构是怎样的❓</p>
</div>
<!-- more -->
<h2>目录结构</h2>
<blockquote>
<p>可以通过以下维度进行考量：</p>
<ul>
<li>
<p>命名清晰：目录命名需要简洁，清晰的表达出该目录实现的功能，做到一看到该目录名就知道是干嘛的；</p>
</li>
<li>
<p>功能明确：目录的功能必须明确，例如：api目录是接口服务、service目录是业务逻辑；</p>
</li>
<li>
<p>功能齐全：例如测试、构建、脚本、工具、文档等；</p>
</li>
</ul>
</blockquote>
<p>这里参考Go语言公认项目目录<a href="https://github.com/golang-standards/project-layout" target="_blank" rel="noopener noreferrer">project-layout</a>结构如下：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>.
├── api
├── assets
├── build
│   ├── ci
│   └── package
├── cmd
│   └── _your_app_
├── configs
├── deployments
├── docs
├── examples
├── githooks
├── init
├── internal
│   ├── app
│   │   └── _your_app_
│   └── pkg
│       └── _your_private_lib_
├── pkg
│   └── _your_public_lib_
├── scripts
├── test
├── third_party
├── tools
├── vendor
├── web
│   ├── app
│   ├── static
│   └── template
└── website
</code></pre></div><h2>应用目录</h2>
<h3>api目录</h3>
<blockquote>
<p>OpenAPI/Swagger规范、JSON模式文件、协议定义文件</p>
</blockquote>
<h3>cmd目录</h3>
<blockquote>
<p>该项目的主要应用，Go语言以main函数文件作为程序入口。每个应用程序的目录名称应与执行文件的名称相匹配，例如：<code>/cmd/myapp</code></p>
</blockquote>
<h3>examples目录</h3>
<blockquote>
<p>应用程序和公共库的示例</p>
</blockquote>
<h3>internal目录</h3>
<blockquote>
<p>存放私有应用和库代码，如果一些代码，你不希望在其他在其他应用和库中被导入，可以放在internal目录下。而对于私有应用共享的代码可以放在/internal/pkg目录下。
建议internal目录以各个组件的方式进行分层。</p>
</blockquote>
<h3>pkg目录</h3>
<blockquote>
<p>与internal相反，该目录存放可供其他外部应用程序使用的库代码。</p>
</blockquote>
<h3>vendor目录</h3>
<blockquote>
<p>该目录存放项目依赖，可通过<code>go mod vendor</code>创建。</p>
</blockquote>
<p>👀 注意</p>
<p>如果开发的是Go语言库，不要提交vendor依赖包</p>
<h3>test目录</h3>
<blockquote>
<p>其他外部测试应用程序和测试数据。对于更大的项目，有一个数据子目录是有意义的。例如：<code>/test/data</code>或者<code>/test/testdata</code></p>
</blockquote>
<p>👀 注意</p>
<p>Go 也会忽略以“.”开头的目录或文件。或“_”，因此您可以更灵活地命名测试数据目录。</p>
<h3>third_party目录</h3>
<blockquote>
<p>外部帮助工具，分支代码或其他第三方应用。</p>
</blockquote>
<h3>tools目录</h3>
<blockquote>
<p>该项目的支持工具</p>
</blockquote>
<p>👀 注意</p>
<p>这些工具可以从<code>pkg</code>和<code>internal</code>目录导入代码</p>
<h3>web目录</h3>
<blockquote>
<p>前端代码存放目录，用来存放Web静态资源，服务端模块和单页应用（SPAs）</p>
</blockquote>
<h3>assets</h3>
<blockquote>
<p>其他资产，例如：图像、徽标、CSS、JavaScript等</p>
</blockquote>
<h3>website</h3>
<blockquote>
<p>项目网站或者Github页面</p>
</blockquote>
<h2>项目管理目录与文件</h2>
<h3>build目录</h3>
<blockquote>
<p>打包和持续集成</p>
<p>将云 (AMI)、容器 (Docker)、操作系统（deb、rpm、pkg）包配置和脚本放在<code>/build/package</code>目录中。</p>
<p>将CI（travis、circle、drone）配置和脚本放在<code>/build/ci</code>目录中。</p>
</blockquote>
<p>👀 注意</p>
<p>一些 CI 工具（例如 Travis CI）对其配置文件的位置非常挑剔。尝试将配置文件放在/build/ci将它们链接到 CI 工具期望它们的位置的目录中（如果可能）。</p>
<h3>configs目录</h3>
<blockquote>
<p>配置文件，例如这里可以存放confd或consul-template模版文件。</p>
</blockquote>
<h3>deployments目录</h3>
<blockquote>
<p>IaaS、PaaS、系统和容器编排部署配置和模板（docker-compose、kubernetes/helm、mesos、terraform、bosh）。</p>
</blockquote>
<p>👀 注意</p>
<p>在某些存储库（尤其是使用 kubernetes 部署的应用程序）中，此目录称为<code>deploy</code>.</p>
<h3>init目录</h3>
<blockquote>
<p>系统初始化（systemd、upstart、sysv）和进程管理器(runit、supervisord)配置文件，在非容器化部署的项目中会使用到。</p>
</blockquote>
<p>例如：systemd的unit文件，用于管理程序，一般以.service结尾</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.target
Wants=sshd-keygen.target

[Service]
Type=notify
EnvironmentFile=-/etc/crypto-policies/back-ends/opensshserver.config
EnvironmentFile=-/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS $CRYPTO_POLICY
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
</code></pre></div><h3>scripts目录</h3>
<blockquote>
<p>执行各种构建、安装、分析等操作的脚本。这些脚本使根级 Makefile 小而简单</p>
</blockquote>
<p>例如: <a href="https://github.com/hashicorp/terraform/blob/master/Makefile" target="_blank" rel="noopener noreferrer">terraform-website</a>使用了很多scipts目录下的脚本，使得Makefile小但功能强大。</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>WEBSITE_REPO=github.com/hashicorp/terraform-website
VERSION?="0.3.44"
PWD=$$(pwd)
DOCKER_IMAGE="hashicorp/terraform-website:full"
DOCKER_IMAGE_LOCAL="hashicorp-terraform-website-local"
DOCKER_RUN_FLAGS=--interactive \
	--rm \
	--tty \
	--workdir "/website" \
	--volume "$(shell pwd):/website/ext/terraform" \
	--volume "$(shell pwd)/website:/website/preview" \
	--publish "3000:3000" \
	-e "IS_CONTENT_PREVIEW=true" \
	-e "PREVIEW_FROM_REPO=terraform" \
	-e "NAV_DATA_DIRNAME=./preview/data" \
	-e "CONTENT_DIRNAME=./preview/docs" \
	-e "CURRENT_GIT_BRANCH=$$(git rev-parse --abbrev-ref HEAD)"

# generate runs `go generate` to build the dynamically generated
# source files, except the protobuf stubs which are built instead with
# "make protobuf".
generate:
	go generate ./...

# We separate the protobuf generation because most development tasks on
# Terraform do not involve changing protobuf files and protoc is not a
# go-gettable dependency and so getting it installed can be inconvenient.
#
# If you are working on changes to protobuf interfaces, run this Makefile
# target to be sure to regenerate all of the protobuf stubs using the expected
# versions of protoc and the protoc Go plugins.
protobuf:
	go run ./tools/protobuf-compile .

fmtcheck:
	"$(CURDIR)/scripts/gofmtcheck.sh"

importscheck:
	"$(CURDIR)/scripts/goimportscheck.sh"

staticcheck:
	"$(CURDIR)/scripts/staticcheck.sh"

exhaustive:
	"$(CURDIR)/scripts/exhaustive.sh"

# Default: run this if working on the website locally to run in watch mode.
website:
	@echo "==&gt; Downloading latest Docker image..."
	@docker pull ${DOCKER_IMAGE}
	@echo "==&gt; Starting website in Docker..."
	@docker run ${DOCKER_RUN_FLAGS} ${DOCKER_IMAGE} npm start

website/local:
	@echo "==&gt; Starting website in Docker..."
	@docker run ${DOCKER_RUN_FLAGS} ${DOCKER_IMAGE_LOCAL} npm start

.PHONY: website/build-local
website/build-local:
	@echo "==&gt; Building local Docker image"
	@docker build https://github.com/hashicorp/terraform-website.git\#master \
		-t $(DOCKER_IMAGE_LOCAL)

# disallow any parallelism (-j) for Make. This is necessary since some
# commands during the build process create temporary files that collide
# under parallel conditions.
.NOTPARALLEL:

.PHONY: fmtcheck importscheck generate protobuf website website-test staticcheck website/local website/build-local
</code></pre></div><h3>githooks目录</h3>
<blockquote>
<p>Git钩子，比如可以将commit-msg存放在该目录</p>
</blockquote>
<h3>Makefile文件</h3>
<blockquote>
<p>Makefile是一个很优秀的项目管理工具，通常用来执行静态代码检查、单元测试、编译等功能</p>
</blockquote>
<ul>
<li>静态代码检查(lint)：推荐用 golangci-lint。</li>
<li>单元测试(test)：运行 go test ./...。</li>
<li>编译(build)：编译源码，支持不同的平台，不同的 CPU 架构。</li>
<li>镜像打包和发布(image/image.push)：现在的系统比较推荐用 Docker/Kubernetes 进行部署，所以一般也要有镜像构建功能。</li>
<li>清理（clean）:清理临时文件或者编译后的产物。</li>
<li>代码生成（gen）：比如要编译生成 protobuf pb.go 文件。</li>
<li>部署（deploy，可选）：一键部署功能，方便测试。</li>
<li>发布（release）：发布功能，比如：发布到 Docker Hub、github 等。</li>
<li>帮助（help）:告诉 Makefile 有哪些功能，如何执行这些功能。</li>
<li>版权声明（add-copyright）：如果是开源项目，可能需要在每个文件中添加版权头，这可以通过 Makefile 来添加。</li>
<li>API 文档（swagger）：如果使用 swagger 来生成 API 文档，这可以通过 Makefile 来生成。</li>
</ul>
<h2>文档目录与文件</h2>
<h3>docs目录</h3>
<blockquote>
<p>设计和用户文档，除了<code>godoc</code>生成的文档之外</p>
</blockquote>
<ul>
<li>/docs/devel/{en-US,zh-CN}: 存放开发文档、hack文档</li>
<li>/docs/guide/{en-US,zh-CN}: 存放用户手册，安装、quickstart、产品文档等</li>
<li>/docs/image: 存放图片文件</li>
</ul>
<h3>CHANGELOG目录</h3>
<blockquote>
<p>当项目有更新时，为了方便了解当前版本的更新内容或者历史更新内容，需要将更新记录存放到CHANGELOG目录。</p>
</blockquote>
<p>编写CHANGELOG是一个繁琐的工作，我们可以结合<a href="https://github.com/angular/angular/blob/22b96b9/CONTRIBUTING.md#-commit-message-guidelines" target="_blank" rel="noopener noreferrer">Angular规范</a>和<a href="https://github.com/git-chglog/git-chglog" target="_blank" rel="noopener noreferrer">git-chglog工具</a></p>
<h3>CONTRIBUTING.md文件</h3>
<blockquote>
<p>开源项目用于说明如何贡献代码，如何开源协同等。</p>
</blockquote>
<h3>LICENSE文件</h3>
<blockquote>
<p>版权文件，常用的开源协议有：Apache 2.0、MIT、GPL等</p>
</blockquote>
<p>为了声明版权，你可能会需要将LICENSE头添加到源代码文件或者其他文件中，可以尝试使用这个工具自动化实现：<a href="https://github.com/marmotedu/addlicense" target="_blank" rel="noopener noreferrer">addlicense</a></p>
<p>当代码中引用了其他开源代码时，需要在LICENSE中说明对其他源码的引用，可以借助工具来进行检查：<a href="https://github.com/ribice/glice" target="_blank" rel="noopener noreferrer">glice</a></p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>+</code></pre></div>]]></content>
    <category term="项目规范"/>
    <published>2020-02-09T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">版本规范</title>
    <id>http://blog.cjhe.top/project-standard/version.html</id>
    <link href="http://blog.cjhe.top/project-standard/version.html"/>
    <updated>2024-04-15T09:57:53.000Z</updated>
    <summary type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>随着系统功能越来越复杂，依赖的软件包越来越多，如何解决【依赖地狱】问题？</p>
</div>
]]></summary>
    <content type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>随着系统功能越来越复杂，依赖的软件包越来越多，如何解决【依赖地狱】问题？</p>
</div>
<!-- more -->
<h2>语义化版本规范</h2>
<blockquote>
<p>语义化版本规范（SemVer,Semantic Versioning）是Github起草的一个具有指导意义的、统一的版本号表示规范。
它规定了版本号的表示、增加和比较方式，以及不同版本号代表的含义。</p>
</blockquote>
<p>语义化版本格式为：<code>主版本号.次版本号.修订号（X.Y.Z）</code>，其中X、Y和Z为非负整数，且禁止在数字前方补零。
例如：v1.2.3</p>
<p>版本号增加的含义：</p>
<ul>
<li>主版本号（MAJOR）：当做了不兼容的API修改。一般用于大的功能变动(Breaking Change)，影响到之前的功能。</li>
<li>次版本号（MINOR）：当做了向下兼容的功能性新增及修改。一般用于不影响之前逻辑的功能优化，或者新的功能(New Feature)。</li>
<li>修订号（PATCH）：当做了向下兼容的问题修正，一般用于问题修复(Bug Fix)。</li>
</ul>
<figure><figcaption>server</figcaption></figure>
<p>一些经验：</p>
<ul>
<li>建议0.1.0作为第一个开发版本号；</li>
<li>当用于正式环境，它应该达到1.0.0版，0.y.z版本均可视为不稳定版本，仍在持续开发中；</li>
<li>v1.2.3并不是一个语义化的版本号，但是在语义化版本之前增加前缀”v"是用来表示版本号的常用做法；</li>
</ul>
<p>关于语义化版本规范详细内容参考：<a href="https://semver.org/lang/zh-CN/" target="_blank" rel="noopener noreferrer">semver.org</a></p>
<h2>先行版本</h2>
<p>此外我们还会经常遇见先行版本，例如：1.0.0-alpha.0、1.0.0-alpha.1、1.0.0-beta.0、1.0.0-rc.0、1.0.0-rc.1等</p>
<blockquote>
<p>当要发布大版本或者核心的feature时，但又不能保证这个版本的功能100%正常，这个时候就需要通过发布先行版本</p>
</blockquote>
<p>常见的先行版本包括：内测版 、灰度版和RC版本。Semver规范中使用alpha、beta、rc来修饰即将要发布的版本。</p>
<ul>
<li>snapshot:快照，也被称为开发版，处于开发阶段，这个版本的代码禁止用于生产环境；</li>
<li>alpha:内部版本，该版本表示软件在此阶段主要是以实现功能为主，用于软件开发内部交流，一般bug比较多；</li>
<li>beta:公测版本，该版本表示相对alpha版已经改进，但仍然存在一些缺陷，用于专业爱好者大规模使用；</li>
<li>gamma:比较成熟的测试版；</li>
<li>rc:即release candiate，正式版本的候选版本，该版本已经相当成熟，只会修复Bug，不会对软件做任何大的更改；</li>
<li>release:发行版本，适合一般用户使用，不开源的软件，release可能是带有免费使用时间限制的版本；</li>
<li>stable:稳定版，同release；</li>
</ul>
<h2>工具</h2>
<p>另外可以使用一些工具规范版本号：</p>
<ul>
<li><a href="https://github.com/arnaud-deprez/gsemver" target="_blank" rel="noopener noreferrer">gsemver</a>
<ul>
<li>使用<code>gsemver bump</code>命令就可以根据Git历史提交约定生成下一个版本</li>
</ul>
</li>
<li><a href="https://github.com/commitizen/cz-cli" target="_blank" rel="noopener noreferrer">cz-cli</a></li>
</ul>
]]></content>
    <category term="项目规范"/>
    <published>2020-01-25T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">如何不靠运气变得富有</title>
    <id>http://blog.cjhe.top/share/how-to-get-rich-without-getting-lucky.html</id>
    <link href="http://blog.cjhe.top/share/how-to-get-rich-without-getting-lucky.html"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<p>【转】<a href="https://github.com/fat-garage/how-to-get-rich-without-getting-lucky" target="_blank" rel="noopener noreferrer">原文链接</a></p>
]]></summary>
    <content type="html"><![CDATA[<p>【转】<a href="https://github.com/fat-garage/how-to-get-rich-without-getting-lucky" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<p>如何不靠运气变得富有</p>
<blockquote>
<p>Naval 是美国风险投资家，这是他的3小时长播客《如何不靠运气变得富有》的中文翻译，介绍了他的财富观，非常值得一读。</p>
</blockquote>
<h2>瞄一瞄这👇</h2>
<ol>
<li>本文搬运自【胖车库】公众号，译者<a href="https://www.notion.so/918aecdf7acc476f9cbba7836996c3fe" target="_blank" rel="noopener noreferrer">Jessie</a>&amp;<a href="https://github.com/wangmingyue123" target="_blank" rel="noopener noreferrer">明月</a>。胖车库是一个有意思人类的收集计划（开发者、创业者、自由职业者，还有你）和DAO去中心化协作实验室，看看大家都在不同领域做着什么样新的尝试，希望给你未来的可能性提供一些想象力。<strong>杰西和她的朋友们也会在胖车库第一时间更新<a href="https://mp.weixin.qq.com/s/c-yx-WfWcld1Z2tNpYJxlQ" target="_blank" rel="noopener noreferrer">“如何不靠运气变得富有”系列</a></strong>，欢迎大家一起来玩耍 🎤。</li>
</ol>
<figure><img src="https://i.imgur.com/WubW2ud.jpg" alt="胖车库" tabindex="0" loading="lazy"><figcaption>胖车库</figcaption></figure>
<ol start="2">
<li>哈哈哈，😏 其实我还整理出<a href="https://www.notion.so/taosu/Updating-faf1fa3dbcc34e60b443506e76a9c1ab" target="_blank" rel="noopener noreferrer">notion版</a>和<a href="https://cdn.jsdelivr.net/gh/taosue/how-to-get-rich-without-getting-lucky@master/%E5%A6%82%E4%BD%95%E4%B8%8D%E9%9D%A0%E8%BF%90%E6%B0%94%E5%8F%98%E5%BE%97%E5%AF%8C%E6%9C%89(%E4%B8%8A)_Naval%20%EF%BC%88%E8%91%97%EF%BC%89%26Jessie%EF%BC%88%E8%AF%91%EF%BC%89.pdf" target="_blank" rel="noopener noreferrer">PDF版</a>(我就把PDF导进去iPad，在iPad上看书📚)，大家戳戳链接就可以看到了。</li>
</ol>
<h2>第一条：追求财富，而不是金钱或地位</h2>
<p>Nivi：你可能听说过Naval在推特上进行的那一波主题为“如何在不只依靠运气的情况下致富”的推特风暴（tweetstorm）。我们借助这个播客回顾大部分的推文，给Naval一个机会详细聊聊这些话题。他可能会提出一些以前没有发表过的想法。</p>
<p>Naval是AngelList创始人和Epinions的联合创始人。他是一位眼光独到的科技投资人，投出了像Twitter、Uber这样的科技公司。</p>
<p>不只是科技行业的人，各行各业的人都想知道<strong>如何解决他们「钱的问题」</strong>。每个人都隐约地意识到自己想要变得富有，但是他们没有一套好的原则来遵守和践行。</p>
<h3>财富是你睡觉时还能产生收入的资产</h3>
<p>Nivi：财富、金钱和地位有什么区别?</p>
<p>Naval：财富是你渴望的东西，是你睡觉时还在产生收入的财产。举例来说，财富是在夜间还能运行的为其他客户服务的计算机程序。财富是你存在银行里的钱，用于再投资其他资产和业务。</p>
<p>房子是财富的一种形式，因为你可以把它租出去，收得租金，尽管这是一种比经营商业企业更低效的土地使用方式。</p>
<p>我对财富的定义是指那些可以在<strong>你睡觉时依然可以为你赚钱的企业和资产</strong>。</p>
<h3>财富的终极目标是自由</h3>
<p>你渴望财富，是因为它能给你带来自由。也就是说，你不必像白领那样一丝不苟的系领带；你不必早上6点就起床、996挤地铁上下班；你不必把时间浪费在一份没有灵魂，你不喜欢的工作上。</p>
<p><strong>我们创造财富就是为了自由，仅此而已</strong>。而不是去买毛皮大衣，不是去开法拉利，不是去驾驶游艇，也不是去乘坐湾流飞机环游世界。那些东西很快就会变得无聊和愚蠢。它（财富）是关于<strong>你如何成为你自己的事</strong>。</p>
<p>除非你真的想要财富，否则你不会得到它。全世界都想要它，全世界都在为此努力。在某种程度上，它是有竞争力的。这是一个正和博弈，但其中也有竞争因素，因为现在社会上的资源是有限的。为了获得资源去做你想做的，你必须脱颖而出。</p>
<h3>金钱是我们转移财富的方式</h3>
<p>金钱是社会信用，它是一种从别人的时间中获得信用和债务的能力。如果我做对了工作，为社会创造了价值，社会会说：“哦，谢谢你。我们欠你一些东西，将来会补偿你。这是我的借条，我们把它叫做钱吧。”</p>
<p>钱会贬值是因为,</p>
<ul>
<li>人们偷了借据</li>
<li>政府增发货币</li>
<li>人们违背IOU</li>
</ul>
<p>但是金钱试图成为社会的一个可靠的欠条，因为你在为自己的付出而被他人亏欠。我们把这些欠条到处传递，金钱是我们转移财富的方式。</p>
<h3>地位是你在社会等级中的地位</h3>
<p>人生基本上有两大游戏。一个是金钱游戏。钱并不能解决你所有的问题，但它会解决你所有的和钱相关的问题。我想大家都能意识到这一点，所以才想赚钱。同时，在内心深处，许多人认为他们做不到，所以他们不希望任何财富创造发生。他们攻击那些赚钱的企业和企业家们，说他们：“赚钱是罪恶的。你不应该这么做。”但他们实际上在玩另一个游戏，那就是地位游戏。他们试图传递一种信息“我不需要钱，我们不要钱。”</p>
<p>地位指的是你在社会等级中的地位。</p>
<p><strong>财富不是零和游戏</strong>。世界上每个人都可以拥有一所房子，你有房子并不会影响我有房子的能力。如果有什么区别的话，建造的房屋越多，建造房屋就越容易，我们对建造房屋的了解就越多，就会有更多的人拥有房屋。</p>
<p><strong>财富是一个正和游戏</strong>。我们一起创造，努力创造着寄托着我们美好期待的“艺术品”来解释我们正在做的事情。最终，一些全新的东西将被创造出来。这是一个正和游戏。</p>
<p>另一方面，<strong>地位是一个零和游戏</strong>。这是一个非常古老的游戏。我们从原始人部落开始就玩这个游戏了。也就是等级制度。老大是谁？老二是谁？老三是谁？老三打败了老二，老二就必须让位。所以，地位是一个零和游戏。</p>
<h2>第二条：为世界创造更多</h2>
<p><strong>财富不是从别人那里拿走什么，而是为这个世界创造更多</strong></p>
<h3>财富创造带来了世界的丰富</h3>
<p>Naval：有一种观点认为赚钱是邪恶的，这个说法好像起源于“金钱是万恶之源”。人们认为银行家偷走了我们的钱，这在某种程度上是正确的，在世界上的很多地方，有很多偷窃行为一直在发生。</p>
<p>从某种意义上说，世界的历史就是创造者和索取者之间的捕食者/被捕食者关系。有些人走出去创造东西，建造东西，努力创造机会。有些人带着剑、枪，或者经济上我们说税收、裙带资本主义，共产主义等等形式，进行着不同形式的偷窃。即使在自然界，寄生生物也比非寄生生物多。你身上有很多寄生虫，它们靠你生存。好的情况是共生，他们会回馈一些东西。但也有很多只是索取。这就是任何复杂系统的本质。</p>
<p>我关注的是真正的财富创造。这不是仅为了赚钱，不是单纯从别人那里拿东西。</p>
<p>显而易见的是，工作不是有限的，财富也不是有限的。否则，我们还会坐在洞穴里，琢磨着如何瓜分柴火，或者偶尔运气好时捕食到的一些死鹿。</p>
<p>人类文明中的大部分财富，事实上是全部财富，都是被创造出来的。它是从某处产生的。它是由人创造，由科技创造，由生产力创造的。它是通过努力创造出来的。这种被窃取的想法是一种可怕的零和游戏，人们试图获得地位的游戏。</p>
<h3>每个人都可以变得富有</h3>
<p>但现实是，每个人都可以变得富有。我们可以看到，在第一世界国家，基本上每个人都比200年前活着的人富有。200年前，没有人使用抗生素，没有人有汽车，没有人能用电，没有人有iPhone。所有这些都是使我们作为一个物种变得更富有的发明。今天，我宁愿在第一世界国家做一个穷人，也不愿在路易十四的法国做一个富人。这是因为财富的创造。</p>
<p>技术的引擎是科学，其目的是创造丰富性。所以，我认为从根本上来说，每个人都可以变得富有。</p>
<p>我想让你们想象这样一种情形。如果每个人都掌握一个好的软件工程师和一个好的硬件工程师的技能，你可以自己造机器人，开发程序，自己建桥，并为它们编程。假设每个人都知道怎么做。</p>
<p>那你认为20年后的社会会是什么样子？我的猜测是，我们会造出各种各样的机器人、机器、软件和硬件来做任何事情。我们都会生活得非常富足。我们基本上就退休了，因为我们都不用为任何基本的东西工作。我们甚至会有机器人护士，会有机器驱动的医院，会有自动驾驶汽车。我们会有100%自动化的农场，会有清洁能源。那时，我们可以利用技术上的突破来得到我们想要的一切。如果有人还在工作，那么他们是在用工作来表达他们的创造力。</p>
<p>我不认为资本主义是邪恶的。资本主义实际上是好的，它只是被劫持了，被不当的外部成本定价所劫持。它被不正当的收益所劫持，在那里有腐败，或者有垄断。</p>
<h2>第三条：自由市场是人类固有</h2>
<p><strong>我们是唯一跨越基因界限进行合作的动物，因为我们可以在自愿的交换中追踪信用(credit)和债务(debt)</strong></p>
<h3>自由市场是人类社会固有的</h3>
<p>Naval：全面的资本主义(意味着自由市场)是人类社会固有的。资本主义不是我们发明的，甚至不是我们发现的东西。它天然存在于我们的每一次交换中。当你和我交换信息时，你一定想从我这里得到一些信息。如果我们没有良好的信息交流，你会去找别人。所以，交换就是在记录信用和债务，这是我们作为灵活的社会动物与生俱来的本领。</p>
<p>我们是动物王国中唯一跨越种群进行合作（协作）的动物。大多数动物只会成群合作，共同进化，它们血液相连，所以它们有一些共同的兴趣。人类没有这种成群合作的能力，也不需要这么麻烦。就算你是塞尔维亚人，他是波斯人，我是印度人，没有任何血缘关系，但我们仍然可以合作。</p>
<p>什么让我们合作？因为我们可以记录借方和贷方。谁投入了多少工作？谁贡献了多少？这就是自由市场资本主义。因此，我坚信这是人类与生俱来的，我们将为每个人创造越来越多的财富。</p>
<p>每个人都可以变得富有，每个人都可以退休，每个人都可以成功。这只是一个<strong>教育和欲望</strong>的问题。前提是你必须想要它。如果你不想要，没关系，没人强迫你参与游戏。但是不要试图贬低那些积极参与游戏的人。他们没准儿就是那些能让你晚上睡在温暖舒适的床上，让你能更方便的买到全世界的东西，让你能拿着嗡嗡作响的iPhone开心刷抖音的人。因此，这是一场美妙的比赛，值得我们从伦理上、理性上、道德上去挑战一次。它将继续使我们所有人越来越富有，直到我们为任何想要的人创造大量财富。</p>
<h3>太多的索取者而没有足够的创造者将使一个社会陷入毁灭</h3>
<p>Nivi：不只是个人在暗地里鄙视财富，对吧？有些国家、团体和政党公然蔑视财富。至少看起来是这样。</p>
<p>Naval：没错。这些国家、政党和团体正在沦为一场零和博弈。在摧毁财富创造的过程中，他们把每个人都拉低到和他们一样的水平。</p>
<p>这就是为什么美国是一个非常受移民欢迎的国家，因为美国梦。显然，不同的人对财富的定义是不同的。第一世界公民对财富的定义可能是，“我一定要赚到数百万美元。而对于第三世界的贫穷移民来说，当刚进入这个国家的时候，我们只是贫穷的移民，对财富的预期值会更低。它可能只是，“我不需要在我的余生做我不想做的体力劳动。”</p>
<p>但是鄙视它的群体会把整个群体带到和他们一样的水平。如果有太多的索取者，而没有足够的创造者，社会就会分崩离析。你最终会变成一个共产主义国家。看看委内瑞拉就知道，他们不停的忙于获取、分割和重新分配，人们在街上挨饿，每年都因为饥饿而失去几公斤的体重。</p>
<p>另一种思考方式是想象一个有太多寄生虫的有机体。你需要少量的寄生虫来保持健康。你需要很多的共生体。所有细胞中帮助我们呼吸和燃烧氧气的线粒体。这些是帮助我们生存的共生体。没有他们我们无法生存。</p>
<p>但是，对我来说，他们（共生体）是一起创造财富的伙伴，共同创造了人类的身体。但是如果你体内充满了寄生虫，如果你感染了蠕虫，或者病毒，或者细菌，而这些都是单纯的寄生，你就会死亡。所以，任何生物都只能抵抗少量的寄生虫。当寄生元素失去控制时，你就死定了。</p>
<p>我说的还是道德财富创造，不是垄断，也不是裙带资本主义。我说的是自由思想，自由市场。人与人之间的小规模交流是自愿的，不会对他人产生太大的影响。我认为这种财富创造，如果一个社会不尊重它，如果一个群体不尊重它，那么这个社会就会陷入毁灭和黑暗。</p>
<h2>第四条：致富与运气无关</h2>
<h3>致富与运气无关，要掌握致富的技能</h3>
<p>Naval：很明显，我们想要在这一生中不只依靠运气变得富有。很多人认为赚钱是靠运气。它不是，关键是你要成为那种能赚钱的人。比如，假设我输光了所有的财产，你把我随便扔到任何一个说英语的国家的大街上，不出5到10年，我就会再次变得富有（笑）。因为这是一种技能，而且我认为每个人都可以拥有这种技能。在1000个平行宇宙中，你想在其中999个里变得富有。你不想只在靠运气成分的50个里面变得富有对吧？</p>
<p>我们在这讲的运气有四种。这个分类来于一本书，a16z的马克·安德森(Marc Andreessen)在Pmarca.com这个博客中曾经提到过。</p>
<ol>
<li>狗屎运</li>
</ol>
<p>第一种就是狗屎运。你完全无法控制这种走运，俗话说这就是命好。</p>
<ol start="2">
<li>坚持不懈的实干运</li>
</ol>
<p>这种幸运来自于坚持、努力、不停的尝试和行动。当你四处奔波创造了各种各样的机会，这期间你输出了很多能量，你做了很多事情，会有大量的能量交换。</p>
<p>你可能会说，人们只有志趣相投才能聚在一起。那我举另外一个例子，Nenad把他做的很棒的动画视频放到了网上，我在Twitter上看到了它们。从这个意义上说，他通过制作视频创造了自己的运气，直到像我这样的人源源不断找到他。</p>
<ol start="3">
<li>早有预备的运气</li>
</ol>
<p>第三种方法是你变得非常善于发现运气。如果你在某个领域非常精通，你会注意到在那个领域幸运的事件是如何发生的。当其他人没有注意到它的时候，你会变得对运气敏感，这是通过技能、知识和工作经验的积累达成的。</p>
<p>4.独特的人格给你带来的好运</p>
<p>最后一种运气是最奇怪、最艰难的一种，但这就是我们要讨论的。在这里，你建立了一个独特的人格，一个独特的品牌，一个独特的心态，然后好运会找到你。</p>
<p>例如，假设你是世界上最擅长深海潜水的人。大家都知道，你会进行别人都不敢尝试的深海潜水。然后，有人幸运的在海岸外发现了一艘沉没的宝藏船。他们没办法拿到，只能跑来找你求助。也就是说，他们的运气同时变成了你的运气，你会因此得到非常丰厚的报酬。这是一个比较极端的例子。那个找到宝藏的幸运儿们，走的是狗屎运。但他们不得不来找你帮忙把宝藏拿出来，最终你会得到一部分这里面的财富，这不是运气。也就是说，虽然这个好运的起始不是你，但是你能让那些发现好运的人在关键时刻想起你，很明显你可以在其中起到不可替代的作用。这种情况下你既成就了别人，又分享了他人的好运，这就是你为什么要打造自己独特的个性和品牌。</p>
<h3>在1000个平行宇宙中，你想在其中999个里变得富有</h3>
<p>Nivi：你刚刚提到，在1000个平行宇宙中，你可以在其中的999个变得富有？我想有些人看到后会说：“这听起来不太可能，太夸张了吧。”</p>
<p>Naval：不，我不认为这是不可能的。考虑到你的起步条件，我认为你可能得再努力一点。我在印度的时候是个穷孩子，所以如果我能成功，从这个意义上说，任何人都能。很明显，我四肢健全，智力正常，当然我也确实接受了教育。也许有一些前提条件不一样，但如果你在听这个视频或播客，说明你已经掌握了基本的技能，而且有一个功能健全的身体和会思考大脑。</p>
<p>事实上，一路上我其实遇到了很多倒霉事。我赚的第一笔钱，立刻就在股票市场上赔了个精光。我赚的第二笔钱，或者说我应该赚的第二笔钱，基本上都被我的商业伙伴骗走了。这次（成功）已经是第三次了。</p>
<p>即便如此，财富的积累仍处于缓慢而稳定的挣扎之中。我这辈子还没一次性赚过一大笔钱，总是一大堆小事堆积在一起。它更多的是通过持续的构建商业（做创业公司）、寻找投资机会来持续创造财富。这绝对不是一步登天的事。</p>
<h3>财富不是一步登天</h3>
<p>我的个人财富不是在某一年产生的，它是一点点堆积起来的，每一个阶段积累一点。更多的选择，更多的生意，更多的投资，才能撬开更多自己能做的事情。和Nenad的illacertus一样，他在油管上做了一系列视频，没有任何一个视频会在一夜之间让他一夜暴富，这绝对是一个漫长的过程，学习，阅读，创造，这期间会产生复利效应。</p>
<p>我们谈论的是变得富有，这样你就可以退休，你就有更多的自由。退休不是说什么都不做。而是说你不必去任何你不想去的地方，你不必做任何你不想做的事，你想什么时候醒来就什么时候醒来，你想什么时候睡觉就什么时候睡觉，没有老板对你指手画脚。这就是自由。我们谈论的是足够的财富来获得自由。特别是由于互联网的普及，机会到处都是。坦白讲，我有太多的方法来赚钱，我满脑子都是想法，唯一缺的就是时间。创造财富、创造产品、创造企业、创造机会，从社会获得报酬的方式太多了。</p>
<h2>第五条：你必须有点异乎寻常，才能独自走在前沿</h2>
<p>Naval在他的博客中还提到了一些关于第四种运气的有趣例子，但我想让读者了解的一点是，第四种运气其实是来自于你异乎寻常（这里用了eccentric这个词）的行为，所以有时候异乎寻常可能并不是一件坏事。</p>
<p>Naval：没错，因为这个世界非常讲求效率，每个人都在明显的地方挖掘着新奇的、未被发现的东西，这会帮助你建立优势。独自走在前沿可能需要你有点异乎寻常，而且愿意比一般人挖掘得更深，挖掘的更深仅仅因为你感兴趣。</p>
<p>Nivi：对，除了本杰明·迪斯雷利的那句话外，我看过的两句表达这种运气的话，一个是山姆·阿尔特曼（Samuel Altman）说的，“极端的人才能得到极端的结果。”“我认为这句话很好。还有另一个来自斯坦福大学教授杰弗里·普费弗（Jeffrey Pfeffer）的观点，“你不可能既正常又期待异常回报。”</p>
<p>Naval：是的。我喜欢的一句与之完全相反的话是，“玩愚蠢的游戏的人赢愚蠢的奖品。”“很多人花很多时间在社交媒体上，比如你试图在Twitter上提高你的社会地位，但你基本上赢得了愚蠢的、价值不大的社交奖项。</p>
<p>Nivi：我想我从这篇博客文章中得到的最后一个观点是，除了狗屎运，你应该去追求这几种运气（尤其是最后一个），这会让你变得越来越幸运。</p>
<p>Naval：是的，起码能回归均值（笑）。所以，你至少要中和运气，这样才能更好的发挥你自己的才能。</p>
<h2>第六条：出租时间不会让你变得富有</h2>
<h3>出租时间不会让你变得富有，因为你不能非线性地赚钱</h3>
<p>Nivi：接下来你会详细介绍如何致富，以及什么不会有助于致富。第一点是：“出租你的时间不会让你变得富有。<strong>你必须拥有公司的股权，才能获得财务自由。</strong>”</p>
<p>Naval：这可能是最重要的一点。人们似乎认为你可以创造财富，通过工作致富。这可能行不通，原因有很多。最根本的原因是，你的投入和产出相关性太强。几乎在任何有薪水的工作中，即使是像律师或医生这样每小时报酬很高的工作，你仍然在投入时间，你的报酬是按每小时或工作量计价。因此，这意味着当你睡觉的时候，在度假的时候，你没有在创造财富；一旦你退休了，你就没有收入了（退休金另当别论）。也就是说，你不可能得到非线性的收入。</p>
<p>如果你看到一些医生非常富有，那是因为他们成立了公司，开了私人诊所。他们通过私人诊所建立了一个品牌，为他们带来持续的口碑和客户。或者他们制造了某种医疗设备或一个程序，且拥有这些东西的知识产权。</p>
<p>因此，本质上你是在为别人工作，而那个人承担了风险和责任，掌握着知识产权，有品牌。所以，他们不会给你足够的工资，他们会付给你最低工资，让你做他们需要的工作。这可能是一个很高的最低限度，但仍然不是你想象的退休后真正的财富。</p>
<h3>出租时间赚钱意味着你很容易被替代</h3>
<p>最后，你甚至没有为社会创造出那么多原创的东西。正如我所说，这场推特风暴应该被称为“如何创造财富”，只不过“如何致富”是一个更吸引人的标题罢了。因为你现在扮演的是固定的角色，而大多数固定角色的任务是可以教会的。如果他们能像在学校那样被教授，那么最终你将会和一个更年轻的、拥有最新知识的人竞争，这个人注定是要取代你的。</p>
<p>更可能的是，你做的工作最终会被机器人或人工智能取代。它甚至不需要一夜之间取代，它可以一次替换一点。所以，基本上在出租时间的模式下（也就是打工），投入和产出是匹配的，但我不认为这是真正创造财富的方式。</p>
<h3>你必须拥有股权才能获得财务自由</h3>
<p>所以每个真正想要致富的人在某种程度上都拥有一个产品，一个企业，或者某种知识产权。它可以是股票或者期权，这也是为什么很多人选择在早期科技公司工作。这是一个很好的开始方式。</p>
<p>但通常真正的财富是通过创办自己的公司，甚至是通过投资来创造的。投资一家公司或者说入股，其实有很多通往财富的路径并不按照小时计数。</p>
<h3>追求一份投入与产出“不匹配”的工作</h3>
<p>为什么你真的需要追求一份投入和产出“不匹配”的工作或者职业，这将会在之后的推特风暴中提到。拥有高创造力和高影响力的企业往往是那些你可以工作一小时的企业，这一小时可能会产生巨大的影响；或者你做了1000个小时的工作，但是没有效果。</p>
<p>我们拿软件行业为例。一方面，一个伟大的工程师可以创造比特币，创造数十亿美元的价值。另一方面，如果一个工程师一直在错误的方向下功夫，或者做得不够好、不够有创意、深思熟虑等等。就算他辛勤工作整整一年，他们发布的每一段代码最终都不会被使用，他都不会有用户。这是一个投入和产出高度分离的行业的例子，它不是以你投入的时间多少来衡量产出的。</p>
<p>再举一个极端的例子，假设你是世界上最好的伐木工人，如果你不用工具，或用最简单的工具（比如一把斧子或者一把锯子）伐木，你也只会比最差的伐木工人强三倍，因为投入和产出是有很强的相关性的，不会有很大的区别。</p>
<p>因此，你要寻找投入和产出高度不相关的职业。这是另一种可以产生杠杆效应的方式。我说的杠杆并不是指华尔街讲的金融杠杆，这个“杠杆”名声不好。我说的杠杆是指工具，人类擅长使用的工具。计算机是软件工程师使用的工具。对于一个伐木工人，如果有推土机、自动机械轴和锯子，他就会使用这些工具，比那些徒手想要把树连根拔起的人更有影响力。</p>
<p>工具和杠杆是造成投入和产出之间不匹配的原因。一个职业的创造力成分越高，它就越有可能有不匹配的投入和产出。因此，我认为，如果你考虑从事投入和产出高度相关的职业，那在这个过程中，你很难给社会创造财富，也很难为自己创造财富。</p>
<h2>第七条：我们应该升级自己的自由，而不是生活方式</h2>
<p><strong>生活水平远低于其收入水平的人们享受着一种自由，这种自由是那些忙于改善生活方式的人们无法理解的</strong>
Nivi：除了把时间租出去之外，还有其他无助于致富的事情吗?</p>
<p>Naval：有，我之前提到过两条相关的推文。我说的第一个问题是，你的生活方式应该升级，但不应该升级得太快。这句话的大意是说，<strong>生活水平远远低于其收入水平的人享受着一种自由</strong>，而那些忙于提升生活方式的人根本无法体会这种自由。我认为这是非常重要的，不要总是忙于升级你的生活水平。事实上，如果你能在赚越来越多的钱时，保持稳定的生活水平和期望，就不会有太多烦恼。所以，不要总想着住更大的房子，过更奢侈的生活，以及所有类似的贪心。</p>
<h3>世界上最危险的东西是海洛因和月薪</h3>
<p>假设你现在的工资是每小时1000美元，你肯定不是从20美元每小时的月薪立马涨到1000美元，这一定是个漫长职业生涯的积累过程。这里面一个微妙的问题是，你的生活水平会随着你赚的钱越来越多而升级。你会想当然的认为自己赚了钱，就该马上去提升生活水平，但这会使你深陷在工资奴隶的陷阱里。我忘了是谁，可能是纳西姆·塔勒布说的，“<strong>世界上最危险的东西是海洛因和月薪。</strong>”没错，因为它们很容易上瘾。你想要变得富有的方式恰恰是你想要变穷，那时你能做（想做）的事情只有工作，工作，再工作。</p>
<h3>理想的情况是，你的赚钱路径是离散的</h3>
<p>这就是科技产业的运作方式。你十年没赚到钱，然后突然在第11年，你会赚得盆满钵盈。顺便说一下，这就是为什么这些所谓的富人的高边际税率是有缺陷的，因为风险最高，最具创造力的职业一定是，前十年都在赔钱。在冒着巨大的风险时，你会不停的流血，流血，再流血。然后在第11年，或第15年，你可能突然赚到一大笔钱。此时山姆大叔（这里指政府）出现了，说：“嘿，你知道吗，你今年赚了很多钱。因此，你是邪恶的，你必须把一切都交给我们。”因此，它只是摧毁了那些创造性的冒险职业。但理想的情况是，你的致富路径是离散的，循序渐进的。这样你不会期待你的生活水平更新的那么快。一旦你致富之后，你还会选择工作，但你只会在你想做的时候做你想做的事，这才是真正的自由。因此，你会做更多创造性的事情，而减少对钱，对奢侈生活的关注。</p>
<h2>第八条：给社会提供它不知道如何获得的东西</h2>
<p><strong>社会会因为你创造了它想要、却不知道如何大规模获取的东西，而给你丰厚的回报</strong></p>
<h3>给社会它需要的，但不知道如何规模化获取的东西</h3>
<p>Nivi：你不会因为出租时间而发财的。但你说，“你会通过给社会它想要，但不知道如何规模化获取的东西而致富。”</p>
<p>Naval：没错。所以本质上，就像我们之前说的，钱是社会给你的欠条，你在过去做了一些好事，社会会为你创造它想要的东西而付钱。但社会还不知道如何创造这些东西，因为如果已经被创造了，他们就不需要你了。
几乎所有在你家里、工作场所和街道上的东西曾经都是科技产品。有一段时间石油是一种科技产品，这让洛克菲勒很富有；有段时间汽车是科技产品，这使亨利·福特富有。因此，正如丹尼•希利斯(Danny Hillis)所说，技术只是一套还不太管用的东西。一旦某样东西成功了，它就不再是技术了。所以，社会总是想要新事物。</p>
<h3>想清楚你能提供的产品，然后考虑如何扩大规模</h3>
<p>如果你想要变得富有，弄清楚你可以为社会提供哪些它想要、但还不知道如何获取的东西。并且是你感兴趣、在你的能力范围内能提供的东西。想清楚之后，下一步你要考虑如何规模化。因为如果你只造一个，那是不够的。你必须建造成千上万个，上百万个，甚至数十亿个。最好的情况是，每个人都可以有一个。史蒂夫·乔布斯和他的团队当然知道社会需要智能手机。他们口袋里的电脑拥有所有电话功能的100倍，而且使用方便。所以，他们想出了如何建造它，然后他们想出了如何扩展它。他们想出了如何让每个第一世界国家的公民，最终也让每个第三世界国家的公民，都能拥有一个。正因为如此，他们获得了丰厚的回报，苹果是世界上最有价值的公司。</p>
<p>Nivi：我想说的是，企业家的工作是为大众市场带来高端产品。</p>
<p>Naval：它以高端开始。首先，这是一种创造性的行为，<strong>你创造它只是因为你想要它</strong>。你想要它，需要它，所以你知道如何建造它。其实一开始<strong>你是为自己建造它</strong>。然后你要想办法把它带给其他人。然后有一段时间，富人拥有它。比如，富人有私人司机，他们有黑色高档汽车。然后优步（Uber）出现了，它让每个人都有自己的私人司机。现在你甚至可以看到Uber pool正在取代穿梭巴士，因为它更方便。然后scooter共享电动滑板车出现了，市场进一步下沉。所以规模化需要考虑的是，<strong>如何把曾经只是富人拥有的东西给到给每个人</strong>。</p>
<h2>第九条：互联网极大地丰富了职业发展的可能性</h2>
<p><strong>互联网会给你的小众兴趣找到买单的人</strong></p>
<h3>互联网极大扩展了职业发展的可能性</h3>
<p>Nivi：让我们看看下一条推文，这也是我觉得对于你将从事什么工作或者职业非常隐秘和超级有趣的推文。你说：“互联网极大拓宽了职业发展的可能性，但是大多数人目前并没有察觉到。”</p>
<p>Naval：互联网最根本的颠覆性是，它使这个星球上的人们能彼此联系，任何一个人只要你想联系总有方法。不论是给他们发邮件，在Twitter上发送推文，还是在Facebook上发布一点他们能看到的动态，或者建立一个他们能来访问的网站。互联网将每一个人都联系在了一起。因此互联网是一个将各个网络连接起来的工具，这就是它的超能力。因此，工具给你了，你要思考怎么去更好的利用它。你要明白，借助互联网，你就总能为你的产品、你的才能、你的技艺找到观众，不论他们来自哪里。</p>
<p>举个例子，Nenad制作了IIIacertus，试想一下，如果你是在互联网出现之前看到的他的视频，那么他需要怎么做才能让你看到呢？他可能抱着电脑挨家挨户展示给他的邻居们看？或者跑到当地的电影院播放？这都是不可能的，他只有把视频放到互联网上才能达到这个效果。然后在这个世界上又有多少人对它真正的感兴趣呢？或者只是对我们正在讨论的东西感兴趣，真正的吸收？结果会发现只有很少一部分人，所以关键就在能触动<strong>这些人</strong>。</p>
<h3>互联网能让你的小众兴趣找到观众</h3>
<p>互联网最怪异的一点是，它允许各种小众兴趣存在。这就好像养蛇的人、喜欢坐热气球的人、喜欢一人独叶孤舟航游世界的人，亦或是痴迷于微型烹饪的人。就像整个日本的微型烹饪现象一样（哈哈今天刚刚看了一本日本烹饪书叫鸡蛋料理），或者像有一个节目是关于女人帮人收拾家务的节目，对吧？</p>
<p>因此，无论你拥有多么小众化的兴趣，互联网都能提供给你一个很好的平台去把它规模化。当然，这也不是说你所做的就是下一个Facebook，或者你能获得数以十亿计的用户，但是，如果你仅仅想找到5万个和你一样满怀热情的人，互联网中就有这样一群观众等待着你。</p>
<p>这个问题的绝妙之处就在于，我们生活的星球上有70亿的人。人类DNA的组合方式达到了难以想像的程度。每个人都是一个完全不同的个体，你不可能遇到另一个一模一样的你。</p>
<p>这不像你可以说，“恩...，Nivi，离开我的生活吧。这样我可以让Naval进入我的生命中，我就可以有和他同样的感受，得到同样的赞许，有同样的想法。”但事实不是这样的，任何人不是别人的替代品，人与人完全不同的。因此，正是因为每个人有不同的技能、兴趣，才可以在自己独特的事物上发挥创造力。</p>
<p>但是（在互联网）之前这些并不重要，在前互联网时代，如果你住在意大利的一个小渔村，你的渔村并不一定需要完全独特的技能，那么你就必须遵从现实，从事仅有的工作。但是今天，你可以变得完全独特和独立。</p>
<p>互联网可以让你低成本的「走出去」，找到属于自己的观众。然后你通过创建业务、创造产品、积累财富，你通过在互联网上展现独特的你让大众获得快乐。你事业的发展空间就会因互联网而扩大，电子竞技玩家，在Fortnite上赚了数百万美元。YouTube广播公司、 博客、播客，让人们能够创建内容和上传视频。我听说乔·罗根（Joe Rogan），他的播客有20亿次下载，这为他每年带来约1亿美元的收入。</p>
<p>再举一个PewDiePie的例子，前几天，我转发了一条有趣的推文。PewDiePie在新闻媒体中简直就是信任的代名词。这个来自瑞典的小孩，他的热门新闻频道的流量是主流有线网络流量的三倍。而且这仅仅是在他的新闻频道上， 还不算他的娱乐频道。</p>
<p>可以说互联网为各种小众兴趣提供了沃土，但前提是你要擅于将其壮大发展起来。当然，好消息就是每个人生而不同，每个人都有自己擅长的东西。所以要真实做自己。</p>
<h3>通过做自己来规避无意义的竞争</h3>
<p>还有一条值得一提的推文，它没有被收录到这个推文风暴中。那条是“通过做自己来规避无意义的竞争”。事实上，当你在与人竞争时，往往是因为你在复制别人，因为你在努力干着同样的事情。但是其实每个人生而不同，不要总是忙着复制别人。</p>
<p>很明显，人类喜欢模仿，René Girard有一套完整的模仿理论很有趣。大家都觉得模仿简单，但其实模仿远比你做自己要难。所以不要纯模仿，不要纯复制，专注于做自己的事情，当你真正在做自己时，你就会发现没有人能和你竞争，就是这么简单。</p>
<p>因此，你对你自己是谁和你喜欢做什么认识的越深入，你就会面临越少的竞争。也就是说，当你意识到真实做自己没人能和你竞争后，你就能够通过真实性逃离竞争陷阱。但是，这在前互联网时代是没用的建议，而后互联网时代你能将这些变成现实。</p>
<h2>第十条：寻找财富游戏中的长期战友</h2>
<p><em>选择一个你可以和长期伙伴玩长期游戏的行业，所有的回报都来自于多次游戏的复利。</em></p>
<h3>寻找财富游戏中的长期战友</h3>
<p>Nivi：我们来聊聊应该考虑在哪些行业工作？应该做什么样的工作？最好和什么样的人一起工作？这些话题。你说过，“你应该选择的行业是，在这里你有长期战友和你玩长期的游戏。”</p>
<p>Naval：是的，<strong>这是解释为什么硅谷会成功，也是对高信任度社会能够成功的深刻理解</strong>。事实上，生活中所有的收益都来自于复利。无论是在人际关系中，创造财富中，或是在学习中。因此，复利是一种神奇的力量，如果你以1倍的价格开始，然后如果每年增长20%，并且持续30年，你得到的不只是额外的30年乘以20%。它有复利效应，所以它会增长，增长，增长，最后你得到的回报将会不可思议。不管是善意、爱情、人际关系还是金钱。所以，我认为复利是一种非常重要的力量。</p>
<p>为什么致富是一场持久战？长期博弈不仅对复利有利，对信任也有利。如果你看一下囚徒困境类型的游戏，囚徒困境的一个解决方案是以牙还牙，也就是我将对你做你上次对我做过的事，如果你犯了错，我会原谅你。但这只适用于重复的囚徒困境的环境中，换句话说，如果我们重复玩一个游戏多次。</p>
<p>因此，如果你处在这样一种情况下，比如你在硅谷，人们在那里互相做生意。他们彼此了解，相互信任，互相帮助，因为他们知道这个人会在下一场比赛的回合中出现，你迟早会遇到这些人。</p>
<p>当然，这并不总是奏效。也有情况是，有的人在硅谷一举成名，赚到很多钱，但人们会背叛彼此，因为他们只是想，“我要靠这个发财，我不在乎。”所以，所有这些情况都有例外。</p>
<p>但本质上，如果你想成功，你必须与他人合作。你必须知道谁可以信任，谁可以长期信任，和你一起在游戏中走下去。所以「复利效应」和「高度信任的圈子」就是你在游戏中生存的武器，同时也是在游戏的周期结束时，让你获利的主要原因。例如，沃伦巴菲特作为美国股票市场的投资者做得非常好，但他能做到这一点的重要原因是因为美国股市一直保持稳定，并且没有碰到美国政府政局非常差的时期，或者是战争时期。总之底层基础设施没有被破坏。因此，对于他来说，他正在玩一场长期比赛。这种信任来自于美国股市的稳定。</p>
<h3>当你转行时，你是在从零开始</h3>
<p>在硅谷，信任来自于小范围内的人际网络，随着时间的推移，你会发现哪些人是你可以合作的，哪些人是你不能合作的。</p>
<p>如果你不停地更换地点，你就不停地更换团队……假设你从木工行业起步，并在那里建立了一个网络。你努力工作，你试图在木工行业制造产品。然后突然出现了另一个相邻但又不同的行业，但你真的并不了解其中的任何一个人，你想要投身其中，在那里赚钱。如果你持续在工业界跳来跳去——不，实际上我需要打开一系列电动汽车加油站。——这或许有道理。这可能是最好的机会。但是每次你重置时，每次你跳出原来的网络圈时，你都将从零开始。你不知道该相信谁，而且他们也不会很容易相信你。</p>
<p>当然也存在短暂的行业。他们总是进进出出。政治就是一个例子，对吧？在政治上，新人正在当选。你在政治上会看到，有很多老前辈的地方，比如参议院，这里有在这个行业中已经生存很长时间的人，他们都是职业政治家。对于职业政治家有很多不利因素比如腐败。但好处是他们实际上已经完成了彼此的交易，因为他们知道另一个人将在十年之后处于相同的位置，他们将不得不继续与这些老前辈打交道，所以他们最好学会如何合作。众议院每两年都要举行一次大型选举，选出一批新的众议员，由于一直在相互竞争，几乎任何事情都没法完成。“因为我刚来到这里，我不认识你，我不知道你是否会继续在身边，我为什么要和你合作，而不是只是尝试做我认为正确的事情？”</p>
<p>因此选择一个你能长期从事的行业、以及长期伙伴是非常重要的。这些人会表明他们会在你身边存在很久，他们是有道德的，他们的道德信条能从他们的行动上体现出来。</p>
<h3>长期游戏中，每个人都在让彼此更富有</h3>
<p><strong>Nivi：在长期游戏中，似乎每个人都在让彼此更富有。而在短期游戏中，似乎每个人都在让自己更富有</strong>。</p>
<p>Naval：我认为这是一个很棒的形容。在长期游戏中，这是一个正和现象。就好像大家在一起烤一个苹果派，大家都在努力尽可能将它做得越大越好。在短期游戏中，我们是在想方设法分这个派。</p>
<p>现在这不是在为社会主义者辩解，对吗？这些社会主义者不是参与烘焙派的人，他们最后出现，说”我想要一片，或者整个派。“他们出现时是带着枪的。但是我认为一个好的领导者并不能赢得荣誉。一个好的领导者基本上都在努力激励员工，这样团队才能将工作完成。然后，奖励将按照公平原则进行划分，谁贡献了多少（或尽可能接近）并承担了风险，而不是谁拥有最长的刀…谁有最锋利的刀。</p>
<h3>收益来自重复游戏的复利</h3>
<p>Nivi：因此，接下来的两个推文是，“玩迭代游戏。生活中的所有的回报，不论是财富上的，还是人际关系上的，或者是知识上的都来自复利效应。”</p>
<p>Naval：当你与一个相处了十年，二十年，三十年的老友做生意时，你根本不需要信任他，事情也可以做得越来越好。因为在相处过程中摩擦逐渐减弱，你们可以一起做越来越大的事情。</p>
<p>举个极端的例子，最简单的方法是与某人结婚，生孩子然后养孩子，这就是复利（笑）。投资于这些长期的关系，与更随意的关系相比，这些关系最终是无价的。</p>
<p>在健康和健身方面也是如此。 你的身体越健康，保持健康就越容易。 而你的身体恶化的越多，就越难回到正常的水平。</p>
<h2>第十一条： 选择智慧、精力充沛和正直的合作伙伴</h2>
<p><strong>选择高智商、精力充沛、为人正直的伙伴是你不能妥协的三要素</strong></p>
<h3>选择高智商、精力和正直的商业伙伴</h3>
<p>Naval：在挑选同事方面，选择那些高智商、精力充沛、正直的人，这是你不能妥协的三个要素。</p>
<p>你需要和聪明的人共事，至少他们不是在错误的方向上一路向西。你需要与精力充沛的人共事，因为世界上到处都是聪明却懒惰，光想不干的人。在生活中，我们都认识一些非常聪明的人，他们可以不起床，或者动一动手指就完成很多事情。我们也知道有些人精力很旺盛，但并不聪明，他们工作非常非常努力，但有时在朝着错误的方向埋头苦干。smart不是一个贬义词。这并不是说有人聪明，有人愚蠢。我想表达的意思是，每个人在不同的事情上会表现出很聪明的一面。因此，取决于你想做什么，你才可以找到在这方面很聪明的人来帮你。</p>
<p>然后关于精力，很多时候人们对特定的事情没有动力，但对其他事情有动力。例如，有人可能真的没有动力一天都坐在办公室里工作。但他们可能真的有动力去画画，对吧?</p>
<p>嗯，那样的话，他们应该是画家。他们应该把自己的艺术放到网上，试着探索如何以此为基础建立自己的事业，而不是认命了，戴着项圈，去做一份乏味的工作。这一定是一个长期的事情，很多人在兴致勃勃的发布第一个作品后，发现没有立马收获1w+粉丝的关注而对自己大失所望，然后以此为由失去动力就放弃了。我想说的是，<strong>做一件事情的动力终究来自于你自己到底想做什么，觉得什么有意义，而不是为了讨好别人</strong>。</p>
<p>最后一点是正直，正直是最重要的，如果只有另外两个品质，你就选择了一个聪明、勤奋的骗子，他最终会欺骗你。所以，你必须弄清楚这个人是否正直。</p>
<p>我之前说过，你要通过信号判断。信号是他们做什么，而不是他们说什么。当他们认为没有人在看他们时，他们会做一些非语言的事情。</p>
<h3>动机必须是内在的</h3>
<p>Nivi：Sam Altman之前有个有趣的观点，当谈到委任时，他说：“委任的关键在于，让人们做他们<strong>擅长同时是你想让他们做的事情</strong>。”这个道理显而易见，你会和那些自然会做你想让他们做的事情的人合作。</p>
<p>Naval：是的。如果我认为他们不喜欢我想让他们做的事情，我几乎不会创办公司，不会雇人，也不会和别人一起工作。</p>
<p>当我年轻的时候，我常常试着说服别人。但事实证明，你可以说服某人帮你做一件事，但是有时候你不能。你无法让他们保持动力。你可以在一开始就给他们灵感，但除非你是像亨利五世那样的国王，拥有那样的权力指使别人做事情。但如果你想让人们长期保持动力，这种动力必须是内在的。你不能只是创造它，如果他们没有内在的动力，你也不能成为他们的拐杖。所以，你必须确保员工精力充沛，愿意做你希望他们做的事，愿意和你一起工作，一起创造。</p>
<h3>诚信反映在一个人的行为，而不是他说了什么</h3>
<p>解读信号非常非常重要。信号不是人们说什么，而是他们做了什么。因此，注意细微的信号是很重要的。举个例子，比如在公众场合，如果有人对服务员态度非常不好，那么他们对你不好只是时间问题。如果有人压制了一个敌人，并对他们怀恨在心，那么他们把你从朋友重新定义为敌人只是时间问题，你会感受到他们的愤怒。所以，愤怒，愤怒，报复，短视的人在现实生活中的很多互动中都是这样的。人们奇怪地一致，至少身体很诚实。所以，你想找到长期合作的伙伴，你要找的是那些似乎没有理性道德的人。</p>
<p>举个例子，我有一个朋友，他的公司是我投资的，但是公司接近倒闭，他本可以把所有的投资者都鸽了。但他不断地投入越来越多的个人资金，直到公司最终又站起来。在这个过程中，他从未让投资者血本无归。为此我一直很感激他。我说，“哇，你对投资人这么好真是太棒了，你没有坑他们。他觉得被冒犯了。他说：“我这样做不是为了你（投资人），是为了我自己。这关乎我的自尊，是我真正关心的东西。”这种人才是你想要共事的人。</p>
<p>另一个我喜欢的引用，是我另一条相关的推特。我是在别的地方读到它，但是我稍微修改了一下。</p>
<p>“<strong>自尊是你对自己的评价</strong>”。</p>
<p>好人，有道德的人，容易共事的人，可靠的人，往往有很高的自尊，因为他们对自己的声誉非常在意，他们深刻的明白声誉的重要性。</p>
<h2>第十二条：与理性的乐观主义者合作</h2>
<p><strong>不要与愤世嫉俗者和悲观主义者为伴：他们总是以自我为中心</strong></p>
<h3>不要与悲观主义者为伍</h3>
<p>Nivi：最后一条推文。你说：“不要与愤世嫉俗者和悲观主义者为伍。他们总是自以为是。</p>
<p>Naval：是的。本质上，要创造事物，你必须是一个理性的乐观主义者。理性的意思是你必须看清世界的真相。<strong>但你必须对自己的能力保持乐观</strong>，对自己想要完成的使命保持乐观。</p>
<p>我们都知道有些人总是很悲观，他们会否定一切。每个人的生活中都有乐于助人的批判者，对吧？他认为他是在帮忙，但实际上他只是在批评（就像我所说的专业的评论家），而且他对每件事都很失望。这样的人不仅在他的生活中不会成就任何伟大的事情，他们还会阻止周围的人做一些伟大的事情或有大胆的想法。他们往往享受挑刺儿的快感，但从未想过提供更好的解决问题的方案，对，他们就是只说不做。有一句经典的军事台词：“要么当头儿，要么服从，要么滚。”这些人想要第四种选择，他们不想当领导，不想跟随，但又不想让路。他们就是想方设法告诉你为什么这事儿行不通。</p>
<p>我认识的所有真正成功的人都有很强的行动力，<strong>他们只是做事。判断一件事是否可行的最简单方法就是去做</strong>，至少做第一步，第二步，第三步，然后再决定下一步。</p>
<p>因此，如果你想在生活中取得成功，创造财富，或者拥有良好的人际关系，或者保持健康，甚至是快乐，你需要有一种超强的行动力，这样才能获得你想要的。</p>
<h3>与理性的乐观主义者合作</h3>
<p>你要对合理的东西保持乐观。众所周知，没有什么比一个鲁莽的人去追求不值得的东西更糟糕的了。这就是为什么我说“理性”的乐观主义者。你需要在了解所有的陷阱，知道事物不利的一面的情况下，依旧保持乐观。</p>
<p>每个人只在这个星球上活一次，为什么不试着做点大事呢？这就是埃隆·马斯克这种人的牛逼之处，我认为他之所以能激励这么多人，是因为他承担了非常、非常大胆的责任和使命。他为人们树立了一个树立远大理想的榜样。即使是做一些小东西也要花很多功夫。我不认为街角杂货店老板的工作强度比埃隆·马斯克(Elon Musk)低，也不认为他付出的汗水和辛劳比马斯克少，甚至更多。无论是教育水平还是所处环境，不管什么原因，他们没有机会去想那么多，所以影响力就不那么大。因此，最好还是想得远一点。当然还是要理性地，在你的能力范围内保持乐观。</p>
<p>愤世嫉俗者和悲观主义者，他们真正想说的是，这很不幸，但他们基本上是在说，“我放弃了。我想我什么都做不了。所以对我来说，这个世界就像一个没有人能做任何事的世界。”所以他们不理解别人为什么费劲儿地要去做一些事情。</p>
<h3>我们是悲观主义者的后代</h3>
<p>Nivi：也许做一个不理性的乐观主义者或做一个理性的愤世嫉俗者可能更好。</p>
<p>Naval：对于为什么你应该成为一个乐观主义者，有一个完全理性的框架。历史上，如果你回到2000年，5000年，10000年，两个人在丛林中漫步，他们听到了老虎的声音。一个是乐观主义者，说，“哦，它不是朝我们这边来的。另一个说：“我是个悲观主义者，我要离开这里。”悲观的人跑了，活了下来，乐观的人被吃掉了。</p>
<p>我们是悲观主义者的后代，我们天生就是悲观主义者。但现代社会要安全得多，没有老虎在街上游荡，虽然你应该避免彻底破产，但你最终不太可能一无所有。</p>
<p>我想分享的理念是，对于一个人来说，<strong>他的境遇是有下限的，但上限却很难说</strong>（白话说是你很难饿死，但是成功却不可限量）。因此，适应现代社会意味着要克服你的悲观情绪，做出稍微不理性的乐观押注，因为如果你创办下一个SpaceX、特斯拉(Tesla)或优步(Uber)，你可以为社会和自己创造数十亿美元的价值，并改变世界。</p>
<p>“<strong>如果你失败了，有什么大不了的？你损失了几百万美元的投资人（VC）的钱，而他们还有更多钱，这就是他们对你成功的赌注。</strong>”</p>
<p>对过去悲观是有道理的，对今天保持乐观是有意义的，尤其对于这么多受过高等教育且生活在第一世界国家的人，甚至是第三世界国家的人。我反而认为第三世界国家的经济机会要大得多。</p>
<p>当然，你必须注意的一件事就是，不要做任何违法的事情，远离可能会带来灾难性的损失的事。尽可能不做对身体有害的事情，注意你的健康。远离那些会让你失去所有资本和储蓄的事情。</p>
<p>因此，不要孤注一掷。但理性乐观的押注会带来巨大的好处。</p>
<h2>第十三条：用特殊技能（Specific knowledge）武装自己</h2>
<p>Naval：如果你想变得富有，你需要想办法获得“规模化”的收入，而不是仅仅期盼每个月的工资。责任感决定了你的客户为什么选择你，杠杆效应决定了它可以被规模化。为什么大家要付给你钱而不是给别人，这需要<strong>特殊的技能</strong>。这里提到的特殊技能可能是整个推特风暴中最难传达的东西，也是人们可能最困惑的部分。</p>
<p>人们普遍持有一种观点是，任何事情都可以从学校学来，都可以“被传授”，但事实上最有价值的事情不是教来的。但好在任何事情都可以学，大部分情况下你想学的东，要么来源于你的兴趣或DNA，要么是源于你从小养成的一些习惯，这些在之后非常难被“教”会；当然也可能是一些全新的东西，所以没有人知道怎么做；或者在工作培训中也是如此，你在高度复杂的环境中进行各种尝试，在一个特定的领域建立判断。典型的例子就是投资，但也可以是其他方面。可以是开拖拉机的技巧，也可以是预测天气的能力。</p>
<p>因此特殊技能就是你特别关注的技能，尤其是你已经到了20、21、22之后，你几乎就不用去选你需要什么样的特殊技能了。你需要做的就是回顾之前的人生经历中，你建立了什么样的技能是你觉得可以着重被发展的。</p>
<h3>特殊技能无法被训练出来</h3>
<p>特殊技能不是教出来的。如果学校可以教这些东西，那么其他人也可以接受培训，然后我们就可以大规模生产和大规模培训人员。我们甚至可以编程让电脑来做，让机器人来做。如果是这样的话，你就很容易被替代。当有无数的人可以经过培训做这件事的时候，雇主支付给你的只是最低工资，为的就是让你做“这件事”。<strong>你获得的收入=投资培训所产生的回报-培训你的成本</strong>。</p>
<h3>特殊技能与你的兴趣高度相关</h3>
<p>举个例子，一个人拿到了心理学学位后，成为了一名销售人员。如果他已经拥有比较好的销售技巧，那么心理学就可以作为一种杠杆，使他在销售上做得更好。但如果他一直是一个内向的人，从来都不擅长销售，他们试图用心理学来学习销售，他们不会做得很好。因此，你会发现更多的特殊技能是通过认识到你的天赋、你真正的好奇心和你的热情而建立起来的。不是为了最热门的工作去上学，也不是盲目进入投资人认为的最热门的领域创业。</p>
<h3>特殊技能往往处于知识的边缘</h3>
<p>它也是一些刚刚被发现或者很难被发现的东西。因此，如果你不是100%的投入，其他人会比你做得更好。他们不会比你好一点点，他们会比你好很多，因为现在我们正在运营创意领域，非常适用于复利，适用于杠杆。如果你的杠杆率为1000倍，有人在80％的时间都是正确的，而其他人在90％的时间都是正确的，那么90％的时间正确的人将因为市场的杠杆作用和复利获得数百倍的报酬。因此，如果你想确保自己在这方面具有优势，真正具有好奇心非常重要。</p>
<h3>建立特殊技能对你来说就像游戏</h3>
<p>很多时候，它不是你坐下来然后推理的东西，它更多的是通过观察发现的。你几乎不得不回顾自己的生活，看看自己到底擅长什么。例如，我想成为一名科学家，所以我所坚持的价值观都是围绕着「科学家」来建立的。我认为真正的科学家处于人类生产链条的顶端，他们做出了真正的突破和贡献，对人类社会的贡献可能比任何其他阶层的人都要大。当然，我并不是说艺术、政治、工程或商业等贡献小，但如果没有科学，我们仍然会在泥土中挣扎，用棍子打架，每天忙着生火。我的整个价值体系都是围绕着科学家建立的，我想成为一名伟大的科学家。</p>
<p>但当我真正回头看我擅长的东西，以及我最终把时间花在了什么事情上时，我发现更多的是围绕着赚钱，钻研技术，卖东西（思想），解释事情，和人们交谈。所以，我有一些销售技巧，这是一种形式的具体知识；我有一些关于如何赚钱的分析技巧；我对数据足够敏感，有收集数据，整理并分析数据的能力，这也是我的一个特殊技能。当然我也喜欢摆弄技术。所有这些对我来说都像是游戏，但对其他人来说却是工作。</p>
<p>有些人会觉得这些事情很难，他们会说，“好吧，我怎么才能变得善于表达和推销想法呢?”如果你不是很擅长，或者你不是很喜欢，也许这不是你的专长，专注于你真正喜欢的事情。</p>
<p>有点讽刺的是，第一个指出我真正擅长什么的人是我的母亲。她是在厨房里说这些话的，当时我大概15、16岁。当我在和一个朋友说我想成为一名天体物理学家，她说：“不，你更适合去经商。”</p>
<p>我一脸懵逼，“啥？我妈妈不知道她在说什么吧。”</p>
<p><strong>但事实上，妈妈当然知道她在说什么</strong>。她已经注意到，每次我们走在街上，我都会批评当地的披萨店，为什么他们要用特定的配料和特定的方式出售披萨，为什么他们点披萨的过程是这样的，而实际上应该是那样的。因此，她知道我对商业更有好奇心，到后来与我对科学的痴迷结合起来，创造了技术和科技企业，我才发现了真正的自己。因此，你的特殊技能可能是由那些了解你的人观察到的，而且经常是由那些了解你的人观察到的。</p>
<h2>第十四条：特殊技能（specific knowledge）极富创造性或技术性</h2>
<h3>特殊技能能通过课程传授获得</h3>
<p>Naval: 如果说特殊技能可以被传授，那就是在工作中，通过学徒制。这就是为什么最好的企业、最好的职业是学徒或自学的职业，因为这些都是社会还没有弄清楚如何培训以及使其批量自动生产的事情。这方面的经典例子是沃伦·巴菲特从学校毕业后去找了本杰明·格雷厄姆。本杰明·格雷厄姆（Benjamin Graham）是《聪明的投资者》（Intelligent Investor）一书的作者，可以说他将价值投资发展成了一套理论并将其发扬光大。巴菲特去找了本杰明·格雷厄姆，并主动提出<strong>免费</strong>为他工作。</p>
<p>但格雷厄姆说：“你开的价格太高了，免费恰恰是一种高价格。”格雷厄姆说得没错。就像后来1954年时格雷厄姆决定要与巴菲特共事时（给予他学徒机会），巴菲特给他多少钱都不为过。</p>
<h3>特殊的技能具有高度的创造性或者技术性</h3>
<p>特定的技能也往往具有技术性和创造性。它在技术的前沿，艺术的前沿，交流的前沿。再举个例子，在今天，互联网上有一些梗王能够创造出令人难以置信的梗，并将这一想法传播给数百万人。斯科特·亚当斯（Scott Adams）就是一个很好的例子，他通过有说服力的文字和视频做出准确的预测，基本上正在成为世界上最可信的人之一。</p>
<p>这是他多年来积累起来的特殊技能，因为他年轻时就沉迷于催眠，他通过漫画学会了如何沟通，并很早就开始用直播平台Periscope，所以他一直在练习和人对话，他读过所有关于这个话题的书，他将工作融入到生活的点点滴滴。</p>
<p>这是一个在职业生涯中积累了特殊技能的人的例子。它具有高度的创造性，它具有技术性的元素，而且它永远不会被机器自动化所取代。
没有人会把这一点从他身上夺走，因为斯科特·亚当斯（Scott Adams）为了发展自己的品牌也尽心尽力。他积极地创作Dilbert系列卡通画、写书，并懂得借助Periscope直播平台的媒体优势运作。他在这个品牌上拥有巨大的影响力，如果他想在现有的基础上创造更多的财富，他现在积累的东西就他的杠杆。</p>
<h3>特殊的技能特定于个体和情境</h3>
<p>Nivi：我们应该称之为独特的知识还是特殊的技能更贴切？</p>
<p>Naval： 我很小的时候就提出了这个框架，当时特殊的技能就一直伴随着我，我没有尝试改变它是因为我所发现的每一个术语都以不同的方式夸大其词。至少特殊的技能（specific knowledge）这个词没被过度消费，因此我可以赋予他新的含义。独特知识的问题是，是的，也许它是独一无二的，但是如果我从别人那里学到它，它就不再是独一无二的，那么就是我们都知道的东西了。所以，与其说它是独一无二的，不如说它是高度依附于现实的，根据个体的实际情况，根据具体问题存在的，它只能依赖于在这个领域中极度的痴迷、兴趣和所花在这个领域的时间来获得。它不能仅仅从一本书中直接读出，也不能在只在一门课程中获得，也不能被设计成一个算法。</p>
<h3>特殊技能不能刻意获得</h3>
<p>Nivi：说到斯科特·亚当斯，他在博客上发表过一篇文章叫做「努力在2个或以上的领域做到前25%」的文章。在此摘录一段：</p>
<blockquote>
<p>如果你想要一个普通的成功的生活，不需要太多的计划。只要远离麻烦，去上学，申请你可能喜欢的工作。但如果你想要与众不同的东西，你有两条路:</p>
<ol>
<li>成为某方面的最牛逼的人（世界第一梯队）</li>
<li>在两件或两件以上的事情上变得非常优秀(前25%)。</li>
</ol>
<p>第一种策略几乎是不可能的。很少有人能在NBA打球，也很少有人能出一张白金唱片。真的很难，我不建议任何人去尝试。</p>
<p>第二种策略相当简单。每个人都至少有几个领域是他们可以努力进入前25%的。就我而言，我比大多数人画得都好，但我算不上艺术家。我并不比一般的单口相声演员更幽默，虽然我从来没有成功过，但我比大多数人都更幽默。神奇的是，很少有人能画得很好，也很少有人能写笑话。正是这两者的结合，让我的作品变得如此罕见。当你再加上我的商业背景，我突然有了一个很少有漫画家不亲身经历就能理解的话题。</p>
<p>我总是建议年轻人成为优秀的演说家(前25%)。任何人都可以通过练习来做这件事。如果你把这种才能加到其他任何一种才能上，你就会突然成为那些只有一种才能的人的老板。或者在你的工程学位、法律学位、医学学位、科学学位或其他任何学位的基础上再获得一个商学学位。突然之间，你掌握了主动权，或者你正在利用自己的综合知识创办自己的公司。</p>
</blockquote>
<p>因此，不要试图在一件事情上做到最好，这太难了。你需要尝试在三件或更多的事情上做到非常优秀。这是一种获得特殊技能的方式吗？</p>
<p>Naval：我认为最好的方法就是追随自己的内心真正喜欢的事物。在你脑海的某个角落，你会意识到，事实上，这个方面我喜欢，我会留意它的商业方面的可能性。</p>
<p>但我认为，如果你单单为了获得「特殊技能」无病乱投医，或过于以目标为导向地关注钱，那么你不会选择做正确的事情，不会选择你喜欢做的事，所以你不会真正深入进去。根据统计数据，斯科特・亚当斯的观察结果很准。就知识而言，今天有 10,000 个对人类有价值的区域，这 10,000 个区域中排名第一那些位置已经被抢占了。除非你碰巧成为各种领域最痴迷的一万人之一，否则其他人可能会成为这万人中的第一人。</p>
<p>当你开始把3728种一流的销售技巧和很好的写作技巧以及一个非常了解会计和财务的人结合起来，当这个交叉点的需求到来时，你已经通过组合数学从10000扩展到了数百万或数千万。所以，它只是变得没有竞争力。此外，收益在递减。因此，在三四件事上成为前25%要比在某件事上成为世界第一容易得多。</p>
<h3>在你擅长得领域建立自己的特殊技能</h3>
<p>natural是天生的、本来的意思，这里翻译成擅长的。我认为这是一个非常务实的方法。但最重要的是，我认为一个人不要太刻意地开始积累，因为你内心其实是想挑选你最擅长的东西。每个人都有与生俱来的擅长的东西。</p>
<p>我们都很熟悉这句话，一个有天赋的人。“哦，这个人是天生的与人为善的人，这个人就是社交名媛的料，这个人是天生的程序员，这个人是天生的读者。”所以，不管是干什么的料，你都会想着在这方面加倍努力。</p>
<p>因为人类的个性非常复杂，你可能在很多方面都很有天赋。如果把你在这些方面的天赋结合起来，这样你就可以自动地，仅仅通过纯粹的兴趣和享受，在很多事情上，最终达到25%，10%甚至5%的最高水平。</p>
<h2>第十五条：学会销售，学会建造</h2>
<p><strong>如果你两者都能做到，你将势不可挡</strong></p>
<h3>学会销售，学会建造</h3>
<p>Nivi：谈到技能组合，你说过你应该“学会销售（Sale），学会建造（Build），如果你两者都能做到，你将势不可挡。”</p>
<p>Naval：这是一个非常广泛的范畴。其中之一是开发产品，即建造。这很难，而且定义很多元。它可以包括设计，开发，可以包括制造，物流，采购，甚至是设计和完成一整套服务。在每个行业，都有一个建造者的定义。在我们所处的科技行业，就是首席技术官CTO，程序员，软件工程师，硬件工程师。但即使在洗衣行业，也可能是创立洗衣服务的人，让物流准时到达的人，确保所有的衣服在正确的时间出现在正确的地方的人，等等。另一方面是销售。同样，销售也有一个非常宽泛的定义。销售不一定只意味着卖东西给个人，它可以意味着营销，意味着沟通，意味着招聘。它也可以意味着筹集资金，意味着鼓舞人心，意味着做公关，等等。</p>
<h3>硅谷模式：建造者+销售者=最佳拍档</h3>
<p>总的来说，硅谷的创业模式是最好的。最常见的形式是有两个创始人，其中一个擅长销售（Sale），另一个擅长搭建（Build）。举几个经典例子，比如苹果创始人史蒂夫·乔布斯和史蒂夫·沃兹尼亚克；微软的盖茨和艾伦在早期可能有类似的分工；谷歌的拉里和谢尔盖可能稍微有点不同，可能是因为谷歌早期交付的是一个非常技术性的产品——搜索，通过一个简单的UI直达终端用户。</p>
<p>在硅谷，你会看到这种模式反复出现。一个建造者和一个销售者的组合：CTO和CEO的组合。风险投资者和技术投资者几乎心照不宣的尽可能地寻找这种组合，这就是神奇的组合定律。</p>
<h3>如果你两者都能做到，你将势不可挡</h3>
<p>如果一个人可以同时做到这两者，这才是真正的超能力。那时你就是可以创造整个行业的人。马一龙(Elon Musk)就是一个活生生的例子。他不一定是自己造火箭，但他实际上做出了技术上的贡献。他使自己成为最了解这项技术的人，没人会对他说三道四，他也不会说一些自己做不到的事（意思是说到就会做到）。他视时间为朋友，并想尽办法运用它。即使是史蒂夫·乔布斯（Steve Jobs）也拥有足够的产品技能，并且对产品的参与度也很高，实际上他也同时具备这两种能力。拉里·埃里森（Larry Ellison）最初是一名程序员，他编写了Oracle的第一个版本，或者说他深度参与其中。马克·安德森（Marc Andreessen）也属于这一类。他可能对自己的销售技能没有足够的信心，但是他可是写出Netscape Navigator的程序员，或者至少是其中很大的一部分。因此，我认为在任何领域中真正的巨人就是可以「自产自销」的人。</p>
<h3>宁愿教工程师销售，也不愿教营销人员工程？</h3>
<p>我认为你可以从建造技能开始入手，并在你人生的早期尽量掌握一定的建造技能。或者你有足够的时间可以专心地学习销售，而且你正好有一定的天赋和亲和力促使你成为一个好的销售者。这样你做事的效果可以翻番。
现在我们谈到的销售技能可能不同于传统概念中的，卖东西。</p>
<p>举个例子，假设你是一个很棒的工程师，然后人们会说，你需要擅长销售。你可能不擅长上门推销东西，但你可能是一个很好的作家。写作是一种比面对面销售门槛更低的技能，所以你可以培养写作技能，直到你成为一个良好的在线交流者，然后将其运用在你的销售上。另一种情况，你可能是一个很好的建造者，但你不擅长写作，你不喜欢与大众沟通，但你擅长一对一说服，所以你可能会用你的销售技能来招聘或募资，这需要更多一对一方向的努力。</p>
<p>因此，如果你在这两个领域的十字路口，千万不要绝望。因为你不可能成为最好的技术，也不会是最好的销售人员。但神奇的是，我们再回到斯科特·亚当斯（Scott Adams）的技能组合理论，将两个技能是结合将是不可阻挡的。</p>
<p>从长远来看，那些了解潜在需求产品的人，知道如何建造和销售它的人，最能受到顶尖投资者的青睐。如果他们有足够的精力，他们可以突破任何障碍，做成任何事情。</p>
<p>Nivi：如果你只能选一个擅长的，你会选哪一个?</p>
<p>Naval：抛开噪音来说，建造的技能实际上是更好的，因为市场上充斥着太多的骗子和没有任何内核的销售人员。当你刚起步、想要被认可的时候，建造技能会更好。但是之后的建造会很累，因为这是一项专注的工作，很难保持与时俱进，因为总是会有新人出现，有新产品，有更新的工具。</p>
<p>因此，随着时间的推移，销售技巧实际上更容易产生规模效应。比如，如果你在构建产品上享有声誉，这是好的，但当你推出你的新产品时，我将去验证的是产品本身（意思是和建造的名声关系不大）。但是，如果你在大家的眼中是一个值得信赖的生意伙伴，并且你很有说服力，善于沟通，那么这个名声会让很多事变得容易很多。</p>
<p>因此，我认为如果你需要选一个，<strong>你可以从建造开始，然后过渡到销售</strong>。这是一个比较中庸的答案，但我觉得这奏是大实话。</p>
<h2>第十六条：阅读你所热爱的内容 直到你爱上阅读</h2>
<p><strong>你应该可以在图书馆中拿起任何一本书阅读</strong></p>
<h3>阅读你所热爱的内容 直到你爱上阅读</h3>
<p>Nivi：在我们讨论责任、影响力和判断之前，你已经有了一些相关的推特，我会把它们放在持续学习的范畴。这些推文本质上是在说，“没有所谓的商业技能。少读商业杂志和商业课程，学习微观经济学、博弈论、心理学、说服力、伦理学、数学和计算机”。你在Periscope上还发表了另一条评论“你应该可以从容的拿起图书馆里的任何一本书来读。”这一类的最后一条推特是，“阅读比听快，做比看快”。</p>
<p>Naval：是的，这是最重要的一条，因为学习的基础是阅读。我认识的聪明人，他们都经常读书。</p>
<p>问题是，<strong>我读什么？我怎么读</strong>？因为对大多数人来说，这是一场斗争，是一件家务活儿。但是，读书不是目的，重要的是学会如何教育自己，教育自己的方法就是培养对阅读的热爱。我想说的是，“<strong>读你喜欢的内容，直到你爱上阅读</strong>。”就这么简单。</p>
<p>我认识的每一个经常读书的人都“爱”阅读，他们爱读书是因为他们读自己喜欢的书。这有点像第二十二条，阅读是没有门槛的，你可以随时开始，然后不断积累，直到它成为一种习惯。接着，你开始不满足于只涉猎单一的领域。</p>
<p>也就是说，你可以从读小说开始，接着你可以读科幻小说，你可以读非小说，然后你可以读科学，哲学，数学甚至更多。但是重要的是，这个过程是顺其自然非强迫的，读你感兴趣的东西，直到你理解它们。然后你就会自然而然地进入下一步，再下一步。</p>
<h3>阅读某一领域的科学原著</h3>
<p>但是，你会发现在你真正想学的东西中，有太多东西要读。我要提醒的是，即使是阅读也充满了垃圾。实际上有些东西你可以阅读，特别是在早期，<strong>它会以某种方式对你的大脑进行编程</strong>，然后在你阅读的后期，你会根据之前的东西来分辨这些东西是真是假。因此，阅读基础性的东西是很重要的。基础性的东西，是在特定领域最原始（fundamental）书籍，在本质上是经过时间和历史的检验，科学的东西。</p>
<p>比如，与其读一本商业畅销书，不如读亚当·斯密的《国富论》。与其读今天谁写的一本关于生物学或进化论的书，我更愿意读达尔文《物种起源》。与其现在读一本可能非常先进的生物技术方面的书，我只想学习Horace F. Judson的《创世第八天》(The Eighth Day of Creation)。你不必死磕关于宇宙学和尼尔·德格拉斯·泰森和斯蒂芬·霍金一直在说什么的高级书籍，你需要的是拿起理查德·费曼的《费曼讲物理：入门》，从基础物理学开始。</p>
<h3>不要害怕任何书</h3>
<p>如果你基础打的好，特别是数学、物理和科学，那么你就不会害怕任何一本书。我们所有人都有那种坐在教室里学数学的记忆，这一切都是合乎逻辑的，而且都是有意义的，直到有一次，课程进度太快，我们跟不上了。
在那之后，我们被留下来背方程式，记忆概念，却无法从第一原理中推导出它们。在那一刻，我们迷失了，因为除非你是一个专业的数学家，否则你不会记得这些东西。你要记住的是技术，基础。</p>
<p>因此，你必须确保阅读是建立在一个理解的框架上，因为你正在为建摩天大楼打地基，而不只是在反复记忆你不断在丢失的东西。所以基础非常重要。</p>
<p>最后，阅读的终极是当你走进一个图书馆，你上下打量，你不害怕这里的任何一本书。因为你知道你可以把任何一本书从书架上拿下来，你就能阅读它，理解它，你可以接收什么是真的，拒绝什么是假的。你有一套自己的方法论，分辨哪些是逻辑和科学的，而不仅仅是基于大字报和意见（opinions）。</p>
<h3>学习的手段是丰富的，学习的欲望是稀缺的</h3>
<p>互联网的美丽是整个亚历山大图书馆的十倍，并且时刻在你的指尖，为你所用。不是教育手段或学习手段稀缺，相反稀缺的是学习的欲望。所以，你真的要培养欲望。</p>
<p>欲望意味着我不允许这种能力的丧失。孩子们天生就有好奇心。如果你去找一个第一次学语言的小孩，他们总是问：这是什么？那是什么？这是为什么？那是谁？他们总是问问题。</p>
<p>但问题之一是，学校和我们的教育系统，甚至我们培养孩子的方式，都用顺从取代了好奇。<strong>一旦你用顺从取代好奇心，你就会成为一个顺从的工厂工人，而不再是一个创造性的思考者。你需要创造力，你需要有激励自己的大脑去学习你想要的东西的能力</strong>。</p>
<h2>第十七条：数学和逻辑才是一切事物的基础</h2>
<p><strong>数学和逻辑是理解其他一切事物的基础</strong></p>
<h3>终极基础是数学和逻辑</h3>
<p>Naval：最基本的东西是原则性的，可以是算法，是根深蒂固的逻辑理解，你可以从任何角度保护它或攻击它。这就是为什么微观经济学很重要，而宏观经济学就是大量的记忆堆砌，大量的宏观废话。</p>
<p>正如纳西姆•塔勒布(Nassim Taleb)所说，<strong>宏观上的扯淡比微观上的扯淡更容易</strong>。因为宏观经济学是巫术—复杂—科学与政治的结合。如今，你找不到两个宏观经济学家在任何事情上达成一致，不同的政治家会用不同的宏观经济学家来兜售他们各自偏爱的理论。</p>
<p>现在甚至有宏观经济学家在兜售所谓的现代货币理论，大概意思就是，有个讨厌的东西叫做通货膨胀，我们可以印所有我们想要的钱。这就像说，有了无限的能量，我们可以发射火箭进入太空一整天。这简直是一派胡言。现实是，有些人打着“宏观经济学家”的旗号，兜售什么现代货币理论，这只能说明，宏观经济学作为一门“所谓的科学”已经腐败。它现在是政治的一个分支。</p>
<p>因此，你要把重点放在基础上。<strong>最终一切事物的基础是数学和逻辑</strong>。如果你懂逻辑和数学，那么你就有了理解科学方法的基础。一旦你理解了科学方法，你就能理解如何在其他领域和其他你正在阅读的东西中区分真理和谬误。</p>
<h3>速食一百本书毫无意义</h3>
<p>在阅读别人的观点（opinion）时要非常小心，甚至在阅读事实（facts）时也要小心，因为所谓的事实往往只是表面上的(伪科学)观点。你真正需要的是算法（algorithm），是理解（understanding）。最好是慢慢地啃完一本书，然后挣扎、绊倒、倒带，而不是快速地浏览一遍，然后貌似很有成就感：“我已经读了20本书，我已经读了30本书，我已经读了50本这个领域的书...”就像李小龙说的，“我不害怕那些知道一千种踢腿招式的人，我害怕那些练习了一万次出拳或一万踢腿的人。”通过不断重复和运用，不断深入理解逻辑和基础，你才能成为一个聪明的思考者。</p>
<h3>学习讲故事和编程</h3>
<p>Nivi：要为你以后的学习打下基础，我认为你需要两样东西，总结来说。第一，练习说服别人，不断实践怎么讲好一个故事。第二，深入了解一些技术范畴的东西，无论是学习抽象数学，还是读唐纳德·克努斯关于算法的书，或者听费曼关于物理学的讲座。如果你有实际的说服力，对一些复杂的话题有深刻的理解，我认为你的余生将有一个很好的学习基础。</p>
<p>Naval：是的。我把它展开一下。我认为五个最重要的技能是，阅读，写作，算术，然后加上说服的技巧，也就是会讲故事（storytelling）让别人信服。最后，我还要加上计算机编程，因为它是一种应用形式的运算它能让你在任何领域都能自由的建造。如果你擅长电脑，擅长基础数学，擅长写作，擅长说服，如果你喜欢阅读，你就已经为生活做好了准备。</p>
<h2>第十八条：没有被称为“商业”的技能</h2>
<p><strong>避开商学院和杂志</strong></p>
<h3>没有被称为“商业”的实际技能</h3>
<p>Naval：没有所谓商业的实际技能，它太普通了。这就像一种叫做“关联”的技能，定义为“与人相关”。这都不能称作一种技能，它太宽泛了。</p>
<p>我并不想完全贬低商学院传授的东西的价值，他们会传授非常聪明的东西—一些成功的案例/轶事，并称之为“案例分析”（case study）。但它们只是一些趣闻轶事，它们试图通过向你抛出大量数据点来帮助你进行模式匹配，但事实是，在你设身处地思考之前，你永远不能完全理解它们，就像你无法重复打造一个可口可乐一样。但是，你会发现博弈论、心理学、伦理学、数学、计算机和逻辑学中的这些基本概念才会更好地帮到你。这也是我为什么会更专注于基础科学、基础逻辑的原因。我会培养对阅读的热爱，包括阅读那些我们明知道不应该阅读的所谓垃圾。你不必（只）读经典。阅读是你进行自我教育的基础。</p>
<p>着手做比光想要快得多</p>
<p>Nivi：你之前所说的“做比看快”是什么意思呢？</p>
<p>Naval：这涉及到学习曲线的话题，人们总是想方设法的优化自己的学习曲线。尽管我也是一个播客博主，但我不喜欢播客的原因之一是，播客无法让我最快的获取知识和信息。我是一个很好的读者，或者说是一个很快的读者，我能读得很快，但我只能以一定的速度听。我知道人们听的时候都是二倍速，三倍速，但那时每个人听起来都像一只花栗鼠，很难再回头看，抓重点，很难精确定位片段并记笔记，等等。</p>
<p>同样地，很多人认为他们可以通过观察别人做的事情，甚至通过阅读别人做的事情，变得非常熟练。比如刚提到的商学院的案例研究，就是一个非常典型的例子。他们研究其他人的生意，但实际上，你开一个自己的柠檬汽水摊，甚至在街上开一家小杂货店，都会学到比书本上多得多的经营生意的知识。这就是你在工作中要学习的方法，<strong>因为很多微妙的东西在你真正进入这个行业之前是不会真正懂得的</strong>。</p>
<p>例如，现在人人都喜欢研究心理学。你去看看Farnam Street，读读Poor Charlie’s Almanack*，你可以学习所有不同的心理模式。但哪个更重要？你更常应用哪些？在什么情况下哪一个更重要？这其实是最难的部分。比如，我从心理学研究中最大的收获是，委托-代理问题在现实世界中的驱动力太强大了，这本质是一个激励问题。它让我明白，针锋相对的重复囚徒困境是最值得了解的博弈论。在那之后你几乎可以把博弈论理论书束之高阁了。</p>
<p>顺便说一下，<strong>学习博弈论的最好方法是自己设计游戏</strong>，自己亲身体验。虽然我从没读过博弈论的书，但我认为自己非常擅长博弈论实践。我从来没有打开过一本博弈论的书，从未尝试在里面发现任何一个我没想到的结果。原因是我从小玩各种游戏，和各种各样的朋友在游戏中碰到各种各样的实际情况，所以这对我来说只是第二天性。实践会告诉你一切你想知道的答案。</p>
<h3>“执行”迭代的次数决定着你的学习曲线</h3>
<p>执行本身是一件很微妙的事请，它包含着很多东西。比如说，我想学习如何经营一家企业。如果我在每天上班的地方重复做同样的事情，比如说我在街上开了一家零售店，每天的任务就是在货架上摆满食物和酒，我不会学到很多东西，因为我每天只是在不断重复。因此，即使我花了几千个小时，但我也只是花了几千个小时做同样的事情。而如果在这个过程中我进行了数千次迭代，那结果就会不一样了。因此，学习曲线是需要迭代的，而不是重复。</p>
<p>但如果我在商店里每天尝试新的营销实验，我不断地改变库存，不断地改善品牌策略，不断尝试新的讲故事的方法，不断地拓展增大客流量的在线渠道，我试着在不同的时间营业，并且经常有目的地四处走走，和其他店主交谈，拿到他们的书，弄清楚他们是如何经营自己的生意的。<strong>真正影响学习曲线的是迭代次数</strong>。迭代次数越多，收获的就越多，学习速度就越快。而不仅仅是投入的时间长短的问题。</p>
<h3>如果你愿意每天流一点血，你可能在未来的人生路上赢得很多</h3>
<p>虽然世界为我们提供着一次又一次做同样事情的机会，但事实上，如果我们能从零开始寻找新的方法，世界会呈现出不一样的精彩。</p>
<p>第一次尝试新事物是很痛苦的，因为你正徘徊在不确定的领域，很有可能你会失败。因此你只需要不断让自己<strong>适应频繁的小失败（bleed a little）</strong>。</p>
<p>Nassim Taleb也谈到了这一点。他靠做一个基本上依赖黑天鹅的商人的生意发家致富。Nassim Taleb通过每天损失一点点钱来赚钱，然后在一个偶然的时机，当一件被常识定义为不可能发生的事情发生在其他人身上时，他会赚很多钱。</p>
<p>虽然大多数人每天都想一夜暴富，但相应的，他们需要承担爆炸式的风险，做好破产的心理准备。</p>
<p>如果说你在自然界里割伤了，然后每天都在流血，你最终会因失血而死亡，你必须想办法及及时想办法挽救生命。但其实现实生活没那么夸张，我们并不是每天都在流血，流血在这里只是一个比喻，每天让自己损失一点点。</p>
<p>但现实是，大部分人都不这么做，相反他们每天都在追求着小的胜利，这最终会被证明是不合算的。我想说的是，如果你愿意每天都流一点点血，将来你会赢一笔大的。</p>
<p>其实，这就是创业精神，企业家们每天都在流血（bleed a little）。他们不是在赚钱，他们是在赔钱，而且他们总是亚历山大，因为所有的责任都在他们身上，但是当他们赢了，他们就会大赚一笔，所以总体上来看他们会赚得更多。</p>
<h2>第十九条：勇敢承担责任才能获得影响力</h2>
<p><strong>勇敢冒险你就会在社会上获得影响力</strong></p>
<h3>你需要通过责任获得影响力</h3>
<p>Nivi: 我们何不谈谈责任呢，我觉得这很有趣，我估计你对此有自己独特的看法。因此，你的关于责任的第一条推文是，“拥抱责任，以自己的名义承担商业风险。社会将以责任、公平和影响力来回报你。”</p>
<p>Naval: 是啊，所以要想发财，你需要杠杆。杠杆来自于劳动力、资本，也可能是通过代码和媒体。但其中的大多数，比如<strong>劳动力和资本，必须来自于他人的给予</strong>。对于劳动力，必须是有人愿意跟随你；对于资本，必须有人给你钱或资产来让你管理和使用。</p>
<p>所以要得到这些，你必须建立信誉，而且你必须尽可能以自己的名义去做，当然这也是有风险的。所以责任是一把双刃剑。它能让你在事情顺利的时候收获信誉，在事情糟糕的时候承受失败的冲击。</p>
<h3>以自己的名义承担商业风险</h3>
<p>从这个意义上说，那些在各种事物上贴上自己标签的人并不愚蠢，他们只是对自己有信心。也许最终结果是愚蠢的，但如果你看到一个坎耶、奥普拉、特朗普、马斯克或其他类似的人，这些人之所以可以凭借自己的名字致富，是因为他们的名字就是强大的敲门砖。</p>
<p>不管你如何看待特朗普，你必须意识到，这家伙的名字就是世界名片。你为什么要去特朗普赌场？只是因为是特朗普。你为什么要去特朗普大厦？也是因为特朗普。</p>
<p>到了投票的时候，我想很多选民只是进去说“特朗普”，他们认出了这个名字，所以这个名字得到了回报（获得选票）。</p>
<p>奥普拉也是同样的，她把某样东西打上自己的标签，当商品到达人们手中，她的名字就是这些商品的招牌。</p>
<p>这些人在坚持把自己的名字打造成招牌的同时当然也面临着一系列的风险。显然，特朗普现在可能被世界上的一大部分人憎恨着，也同样是因为特朗普式的风格。</p>
<p>把你的名字公之于众，你就会成为一个名人，而名声也有很多缺点。<strong>隐姓埋名、有钱总比穷出名好，但即便是名利双收，也有很多不利因素。你需要在公众的眼皮子底下生活</strong>。</p>
<h3>一个运作良好的团队对每个职位都有明确的责任分工</h3>
<p>责任感是非常重要的，当你正在开发一个产品，或者你在一个团队中工作，或者你在一个企业中工作时，我们就会不断地提醒自己成为一个团队的一员是多么的重要。这的确是非常重要的。</p>
<p>我们在社交方面的很多训练都告诉我们不要强出头。就像中国的一句俗语，枪打出头鸟，别紧张，但是我要说的是，一个真正运作良好的团队规模很小，对每一个不同的部分都有明确的责任分工。</p>
<p>你可以说，“好吧，这个人负责制造产品，这个人负责信息发布，这个人负责筹款，这个人负责定价策略，也可能负责在线广告。“所以如果有人搞砸了，你就知道到底是谁负责。同时，如果事情进展顺利，你也清楚地知道是谁做得很好。</p>
<p>如果你有一个很小的团队，并且你已经清楚地划分了责任，那么你仍然可以保持很高的责任感。问责制在面对结果时显得真的很重要，不然就会出现，如果失败了，每个人都会互相指责，如果成功了，每个人都会站出来争夺功劳。</p>
<p>我们在学校的时候都有过这样的经历，有一个小组作业要做，里面可能有几个人做了很多工作，然后有一些人只是做了很多哗众取宠的工作或者强行给自己做的工作加戏。我们从小就习以为常，但说出来难免会感到不舒服。</p>
<h3>能在公众面前坦然面对失败的人都有很大的能量</h3>
<p>明确责任很重要。没有责任感，你就没有动力；没有责任感，就无法建立信誉。但你要冒险，你冒着失败的风险冒着被羞辱的危险，你冒着以自己名义承受失败的风险。</p>
<p>幸运的是，在现代社会，不再有债务人的监狱，人们也不会因为失去别人的钱而坐牢或被处死，但与生俱来的，我们不会以自己的名义在公共场合失败。那些以自己的名义在公共场合面对失败的人，实际上拥有很大的能量。</p>
<p>例如，我讲一个个人轶事。直到2013年，2014年，我的公众形象完全围绕着创业和投资。直到2014年、2015年左右，我才开始谈论哲学、心理学等等。</p>
<p>这让我有点紧张，因为<strong>我是以自己的名义做的</strong>。肯定有业内人士通过背后悄悄戳我，比如“你在干什么？你要结束你的职业生涯了吗？这太愚蠢了。”</p>
<p>我有点同意了，的确，我冒险了。</p>
<p>当你把你的名字放在那里，你就要冒着某些风险。但同时你也会得到回报，你会得到好处的。</p>
<h2>第三十五条：冷静的头脑，健康的身体，充满爱的家庭</h2>
<p><strong>当你变得富有时，你会发现这些都不是你一直以来追求的</strong></p>
<p>Nivi：最后一条关于长期工作的推特是：“当你最终变得富有时，你会意识到这些并不是你最初想要的。”</p>
<p>Naval：这本身就是一个能谈论很久的话题。首先，我认为这是一个非常聪明的结论，它解放了那些说“致富有什么意义？”的人们的思想武装。有很多人喜欢以德服人，反对创造财富或赚钱的想法。这其实也没错。是的，钱能解决你所有能用钱解决的问题，但钱也不是万能的。</p>
<p><strong>当你赚了一大笔钱后，你首先意识到你仍然是同一个人</strong>。如果你本来快乐，你就还是快乐的。如果你本来不快乐，你就会不快乐。如果你平静、满足、平和，你还是那个人。我认识很多非常富有的人，他们身材非常不好。我也认识很多有钱人，他们的家庭生活很糟糕。我同时也知道很多有钱人，他们内心很混乱。</p>
<h3>平静的头脑，健康的身体和充满爱的家庭必须要经营</h3>
<p>我想到我之前发的另一条推特，也是我最喜欢的一条。它不一定是最有见地的，也不一定是最有用的，这甚至不是我想的最清楚的。但那里面有一个非常确定的事实，它引起了共鸣。</p>
<p>“健康的身体，平静的头脑，充满爱的家庭。这些东西是买不来的，必须要经营才能得到。”</p>
<p>即使你拥有世界上所有的钱，你也不会拥有这三样东西。Jeff Bezos（亚马逊董事长）还得健身，他也得为他的婚姻努力，他的内在精神状态仍然很难不被外部事件所影响。这将取决于他内心的平静与安宁。因此，我认为这三件事——你的身体健康，你的心理健康和你的亲密关系是你必须要培养的。他们能给你带来比任何金钱都多的安宁和幸福。</p>
<h3>关于平静内心状态的实用性建议</h3>
<p>如何才能保持内心平静，这个话题是我一直在研究的。我大概有100条这个方面的推特。在这个话题上，最近经常会遭到至少50种不同形式的攻击。所以我一直在犹豫要不要做，因为我想针对一种非常特殊的人群。</p>
<p>有很多人不相信研究内在状态是有用的，他们太注重外在。没关系，这样也的确没什么问题。这就是“如何致富”推特系列的目的。有很多人认为唯一值得努力的就是<strong>彻底解放(complete liberation)</strong>，就像，你成了佛。他们会怀疑过程中的任何东西，认为它们毫无用处。但事实是绝大多数人没法儿成佛不是吗？</p>
<p><strong>我想创建一个新的推特系列，来为那些想要一个更平静的内在的人们提供实用的建议</strong>。一套理解、分辨半真半假和真理的理论，如果你能正确地吸收它们，这些都是指向你已经拥有的想法和经验的指针；如果你把这些理论慢慢融会贯通，它将帮助你、引导你进入一个更平静的内在状态，这就是我想做的。</p>
<p>健身是另一个大问题，我不是这方面的专家，推特上有很多比我更擅长健身的专业人士。</p>
<h3>很多离婚案例是为了钱，很多争吵是因为内心恐惧</h3>
<p>我认为，一个充满爱的家庭和人际关系实际上是自然而然地从其他事情中脱颖而出的。如果你有一个冷静的头脑，你已经赚了钱，你应该有良好的关系。你没有理由不这样做，很多离婚都是为了钱，不幸的是，这就是现实，有了钱但是丢失了家庭这部分。</p>
<p>很多外在的纷争主要是因为你的内在状态不好。当你内心自然平静的时候，你会选择更少的争斗，你会变得更有爱心而不期待任何回报，这会让你应对外部关系更加得心应手。</p>
<p>Nivi：总结一下，钱能解决你的关于金钱的问题，金钱可以让你在物质世界中获得自由。金钱能给你不去做你不想做的事情的自由。</p>
<p>Naval：是啊。对我来说，金钱的最终目的是让你不必在某个特定的地方的某个特定的时间，做任何你不想做的事情。</p>
<h2>第三十六条：没有什么快速致富的方法</h2>
<p><strong>别相信能快速致富的鬼话，那些人只是想从你身上赚钱而已</strong></p>
<p>Nivi：我们跳过了一条推文，因为我想涵盖所有关于长期话题的推文。我们跳过的那条推特是，“世界上没有快速致富的捷径，如果谁告诉你有，那不过是他想从你这里发财罢了。”</p>
<p>Naval：我们说回有效率的世界。如果有一种简单的致富方式，那就是已经被开发了。有很多人会向你推销如何赚钱的产品，比如他们总是卖给你一些79-95美元的课程或一些有声读物，或研讨会门票。这没什么对错，人们总是需要谋生。他们可能真的有很好的建议，但如果他们给你可行的、高质量的建议，承认这（致富）是一个艰难的旅程，会花很多时间，那么我认为这是现实的。但是，如果他们卖给你一些快速致富的各种线上线下的产品，他们只是想从你身上赚钱，你要掂量一下它的价值。</p>
<h3>我们不放广告，因为我们知道那只会损害信誉</h3>
<p>关于整个推特风暴和这个播客，我想强调的一件事是我们这里没有广告，也不收任何费用。我们不卖任何东西。不是因为我不想赚更多的钱，赚更多的钱总是好的。但是，它会完全破坏企业的信誉。如果我说，“嘿，我知道如何致富，我要把它卖给你。“这就毁了它。</p>
<p>我年轻的时候就开始思考致富的话题，我最喜欢的书之一就是《如何致富》，作者是Felix Dennis，《Maxim》杂志的创始人，一位去世的亿万富翁。他写了很多疯狂的东西，但他对财富的理解真的好。</p>
<p>但每当我读到他或GoDaddy创始人鲍勃·帕森斯或安德鲁·卡内基的作品时，这些已经非常富有的人写的东西，他们显然是在其他领域发家致富的，而不是靠<strong>推销如何致富的方法</strong>。他们不是想从你身上赚钱。他们显然是想赢得一些地位和一些自尊，对吧，你总是要有做某事的动机。但是，至少这是他们没有撒谎的一个更清晰的理由。</p>
<h3>每个创始人都会对他的员工撒谎</h3>
<p>在某种程度上，每个创始人都要对公司的每个员工撒谎。他们必须让员工觉得，你为我工作比做你自己想做的事，为你自己工作（创业）要好。同样作为一个创始人，但对此我总是很难接受。</p>
<p>于是我开始尝试一些保持诚实的方法，我招募了一些有企业家精神的员工，然后告诉他们，“你们可以在这个公司成为企业家，当你们准备好开始自己的事业的那一天，我将支持你们。我永远不会妨碍你创业。但在你想开始一些新东西之前，这里可能是一个好地方，让你学习如何构建一个良好的团队，建立一个好的企业文化，通过打磨自己的技能找到适合的产品市场，见更多更加优秀的人、和他们交流碰撞，直到最终想通自己到底想做什么。因为定位、时机、以及必要的深思熟虑，在开始创业时很重要。”</p>
<p>但我从来不会做一些无谓的监督，告诉员工“你必须在早上8点之前到你的办公桌。”因为我自己就不会在早上8点之前坐在办公桌前，我想要自由。这就像告诉他们你今天很擅长做董事，明天你就会成为副总裁。这种话我自己都不相信。</p>
<h3>任何提供致富建议的人，去想想别的赚钱方式吧</h3>
<p>就好像，你不会想从一个胖子那里学到如何保持健康；也不会想从一个抑郁的人那里学到如何快乐。所以，你不会想从一个穷人那里学习如何致富，也一定不想从一个通过告诉别人如何致富来赚钱的人那里学习如何致富。想想都奇怪不是吗？</p>
<p>Nivi：任何时候，如果你看到有人按照大师的建议致富了，只要记住，在任何随机事件中，如果你持续足够长的时间，如果有足够多的人参与其中，你就会得到想要的结果。</p>
<p>Naval：这里面存在着幸存者偏差，这也是为什么当商业记者和经济学家谈论私营公司时，你可以完全忽视他们的原因。</p>
<p>我不会指名道姓，但当一位著名的经济学家对比特币大加抨击，或者当一名商业记者攻击最新一家即将上市的公司时，这完全是胡说八道。那些人什么都没做，他们只是「专业的评论家」。他们对赚钱一无所知。他们只知道如何通过吐槽和批评来博眼球。你要是不停的被他们洗脑可就太蠢了。</p>
<p>最后我想引用纳西姆·塔勒布*的一句话，我很喜欢他说的话，“如果你想成为一个哲学家，先当国王，再当哲学家。”不是先成为哲学家，再成为国王。”</p>
<p>Nivi：我很高兴你提到了塔勒布，我想请大家记住他成名作的书名《随机骗局》。</p>
<p>Naval：我们在这期播客中有些模糊的原因之一是，我们试图去讨论值得长期遵循的原则，而不仅仅是告诉你昨天中奖的彩票号。</p>
<h2>第三十七条：产品化你自己</h2>
<p><strong>找出你最擅长的，并尽可能多地运用杠杆</strong></p>
<p>Nivi：你用两个词概括了整个推特风暴。“产品化（Productize）你自己。”</p>
<p>Naval：产品化你自己这个概念的意思是：<strong>你自己</strong>是独特的、有责任心的，<strong>产品化</strong>需要独特的技能和杠杆。所以所有这些部分，你可以把它们合并成这两个词。</p>
<p>如果你想要长期致富，你应该问自己：“这是我的真实想法吗？”我在打造的是我自己吗？然后，“我在生产它吗？”我在规模化它吗？我是在用劳动力还是资本，代码还是媒体来衡量？所以这是一个非常方便、简单的记忆方法。</p>
<p>这是什么播客？这是一个叫做Naval的播客。我实际上是在用播客在产品化自己的一部分</p>
<p>Nivi：你要弄清楚你有什么特别擅长的，或者你有什么特别之处，然后尽可能地运用杠杆。在这种情况下你不是在刻意赚钱，赚钱甚至也不是一种技能。你就是在做你自己，探索成千上百种方式找到真正的你。</p>
<h2>找到让你富有、健康和有创造力的爱好</h2>
<p>Naval：赚钱应该取决于你是谁和你喜欢做什么。另一条我特别喜欢的推特是...这不是我说的，是别人发过的。他们说“找三个爱好”。一个能让你赚钱，一个能让你保持健康，一个能让你富有创造力。”</p>
<p>我会稍微改变一下。我会说，找到三个爱好，一个让你赚钱，一个让你健康，一个让你更聪明。就我而言，我的爱好是阅读，赚钱，因为我喜欢与初创公司合作。要么投资，要么集思广益，要么开始行动。我很喜欢创业初期的创意和创造阶段。</p>
<p>至于让你保持健康的爱好，我真的没有。我最喜欢的是瑜伽，但那是我崩溃的地方。我认为，那些早年发现冲浪、游泳、网球或某种他们一生中大部分时间都在做的运动的人是非常幸运的，因为他们发现了一种使他们健康的爱好。</p>
]]></content>
    <category term="转载"/>
    <published>2022-10-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">程序员延寿指南</title>
    <id>http://blog.cjhe.top/share/how-to-live-longer.html</id>
    <link href="http://blog.cjhe.top/share/how-to-live-longer.html"/>
    <updated>2024-05-06T02:44:40.000Z</updated>
    <summary type="html"><![CDATA[<p>【转】<a href="https://github.com/geekan/HowToLiveLonger" target="_blank" rel="noopener noreferrer">原文链接</a></p>
]]></summary>
    <content type="html"><![CDATA[<p>【转】<a href="https://github.com/geekan/HowToLiveLonger" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<h1>程序员延寿指南</h1>

<h2>1. 术语</h2>
<ul>
<li>ACM: All-Cause Mortality / 全因死亡率</li>
</ul>
<h2>2. 目标</h2>
<ul>
<li>稳健地活得更久</li>
</ul>
<h2>3. 关键结果</h2>
<ul>
<li>降低66.67%全因死亡率</li>
<li>增加~20年预期寿命</li>
<li><s>维持多巴胺于中轴</s></li>
</ul>
<h2>4. 分析</h2>
<ul>
<li>主要参考：对ACM的学术文献相对较多，可以作为主要参考</li>
<li>增加寿命与ACM关系非线性：显然增加寿命与ACM关系是非线性函数，这里假设 <code>DeltaLifeSpan=(1/(1+DeltaACM)-1)*10</code>（DeltaACM为ACM变化值；公式欢迎优化）</li>
<li>变量无法简单叠加：显然各个变量之间并不符合独立同分布假设，变量之间的实际影响也并不明确</li>
<li>存在矛盾观点：所有的证据都有文献/研究对应，但注意到：有些文献之间有显著矛盾的观点（如对于碳水摄入比例的矛盾）；有些文献存在较大争议（如认为22点前睡觉会提升43%全因死亡率）</li>
<li>研究仅表达相关：所有文献表明的更多是相关而非因果，在阅读时要考虑文献是否充分证明了因果 —— 如某文献表明了日均&gt;=7000步的人有显著低的全因死亡率。但步数少的人可能包含更多长期病患，如果没有合理的排除这块数据，那此文献调查失真</li>
</ul>
<h2>5. 行动</h2>
<ul>
<li>输入
<ul>
<li>固体：吃白肉（-11%~-3% ACM）、蔬果为主（-26%~-17% ACM），多吃辣（-23% ACM），多吃坚果（-27%~-4% ACM），<em>少吃蛋黄（否则+7% ACM/0.5颗/天）（存在争议）</em>，中量碳水、多吃植物蛋白（-10% ACM），少吃超加工食物（-62%~-18%）</li>
<li>液体：喝咖啡（-22%~-12% ACM），喝牛奶（-17%~-10% ACM），喝茶（-15%~-8% ACM），少喝或不喝甜味饮料（否则每天一杯+7% ACM，+多巴胺），戒酒或每周100g（纯酒精量(g)=饮酒量(ml)×酒精浓度(%)×酒精密度0.8g/ml）内（否则+~50% ACM，无上限）</li>
<li>气体：不吸烟（否则+~50% ACM，-12~-11年寿命）</li>
<li>光照：晒太阳（-~40% ACM）</li>
<li>药物：二甲双胍（糖尿病人相比正常人可以+3年）、复合维生素（-8%癌症风险）、亚精胺（-60%~-30% ACM）、葡萄糖胺（-39% ACM）</li>
</ul>
</li>
<li>输出
<ul>
<li>运动：每周3次45分钟挥拍运动（-47% ACM）</li>
<li>日常：刷牙（-25% ACM）</li>
<li>睡眠：每天睡7小时全因死亡率最低；且22-24点间最好，<em>早睡+43% ACM，晚睡+15% ACM（存在争议）</em></li>
</ul>
</li>
<li>上下文
<ul>
<li>体重：减肥（-54% ACM）</li>
</ul>
</li>
</ul>
<h2>6. 证据</h2>
<h3>6.1. 输入</h3>
<h4>6.1.1. 固体</h4>
<ul>
<li>白肉
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/268401670" target="_blank" rel="noopener noreferrer">JAMA子刊：食用红肉和加工肉类会增加心脏病和死亡风险！鱼肉和家禽肉则不会</a>
<ul>
<li>出处：<a href="https://jamanetwork.com/journals/jamainternalmedicine/articlepdf/2759737/jamainternal_zhong_2020_oi_190112.pdf" target="_blank" rel="noopener noreferrer">Associations of Processed Meat, Unprocessed Red Meat, Poultry, or Fish Intake With Incident Cardiovascular Disease and All-Cause Mortality</a></li>
<li>增加红肉摄入与死亡风险相关。八年内平均每天增加至少半份红肉摄入（半份红肉相当于14g加工红肉或40g非加工红肉）的调查对象，在接下来八年内全因死亡风险增加10％（HR, 1.10; 95%CI, 1.04-1.17）；每周吃两份红肉或加工肉类（但不包括家禽或鱼类）会使全因死亡风险增加3%</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703960-6f321de5-4daa-4ea5-95b9-af9c96f1c1bc.jpg" alt="红肉" tabindex="0" loading="lazy"><figcaption>红肉</figcaption></li>
</ul>
</li>
<li><a href="https://www.zhihu.com/question/67223570/answer/809785380" target="_blank" rel="noopener noreferrer">红肉和白肉最大的区别是什么？为啥要这么分呢？</a></li>
</ul>
</li>
<li>蔬果
<ul>
<li><a href="https://www.sohu.com/a/322360740_164924" target="_blank" rel="noopener noreferrer">每年54万人死亡，竟是因为水果吃得少！？这已成十大死亡因素之一！</a>
<ul>
<li>出处：<a href="https://academic.oup.com/cdn/article-abstract/3/Supplement_1/nzz028.FS01-01-19/5516583" target="_blank" rel="noopener noreferrer">Estimated Global, Regional, and National Cardiovascular Disease Burdens Related to Fruit and Vegetable Consumption: An Analysis from the Global Dietary Database (FS01-01-19)</a></li>
<li>每天摄入200克新鲜水果可使死亡率降低17%，糖尿病大血管并发症（如中风、缺血性心脏病等）风险降低13%，及糖尿病小血管并发症（如糖尿病肾病、糖尿病眼病、糖尿病足病等）风险降低28%</li>
</ul>
</li>
<li><a href="https://mp.weixin.qq.com/s/E6BAi-Vnhr1jXBm0Pys2ZQ" target="_blank" rel="noopener noreferrer">《自然》子刊：每天二两西兰花，健康长寿都有啦！分析近6万人23年的数据发现，吃含黄酮类食物与死亡风险降低20%相关丨临床大发现</a>
<ul>
<li>出处：<a href="https://www.nature.com/articles/s41467-019-11622-x" target="_blank" rel="noopener noreferrer">Flavonoid intake is associated with lower mortality in the Danish Diet Cancer and Health Cohort</a></li>
<li>吃含黄酮类食物与死亡风险降低20%相关</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703969-42e64f88-e727-4e7d-85f2-07a92e29b613.jpg" alt="黄酮" tabindex="0" loading="lazy"><figcaption>黄酮</figcaption></li>
<li>Bondonno博士说道“吃不同蔬菜、水果补充，不同种类的黄酮类化合物是很重要的，这很容易通过饮食实现：一杯茶、一个苹果、一个橘子、100克蓝莓，或100克西兰花，就能提供各种黄酮类化合物，并且总含量超过500毫克。</li>
</ul>
</li>
</ul>
</li>
<li>辣椒
<ul>
<li><a href="https://3g.163.com/dy/article/F6Q7I1ME053228ZU.html" target="_blank" rel="noopener noreferrer">辣椒成死亡克星？据调研，常吃辣患病死亡风险可降低61%</a>
<ul>
<li>出处1：<a href="https://www.sciencedirect.com/science/article/pii/S0735109719382063" target="_blank" rel="noopener noreferrer">Chili pepper consumption and mortality in Italian adults</a></li>
<li>出处2：<a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0169876" target="_blank" rel="noopener noreferrer">The Association of Hot Red Chili Pepper Consumption and Mortality: A Large Population-Based Cohort Study</a></li>
<li>2017年Plos One 的另一项来自美国的研究以16179名，年龄在18岁以上的人群为对象，并对其进行了高达19年的随访，发现在4946例死亡患者中，食用辣椒的参与者的全因死亡率为21.6％，而未食用辣椒的参与者的全因死亡率为33.6％。相较于不吃辣或很少吃（少于每周两次）的人群，每周吃辣＞4次的人群总死亡风险降低23%，心血管死亡风险降低34%。</li>
</ul>
</li>
</ul>
</li>
<li>鸡蛋
<ul>
<li><a href="https://m.thepaper.cn/baijiahao_11540780" target="_blank" rel="noopener noreferrer">每天多吃半个蛋，增加7%的全因和心血管死亡风险？</a>
<ul>
<li>出处：<a href="https://dietandhealth.cancer.gov/" target="_blank" rel="noopener noreferrer">NIH-AARP工作主页</a>、<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7872242/" target="_blank" rel="noopener noreferrer">Egg and cholesterol consumption and mortality from cardiovascular and different causes in the United States: A population-based cohort study</a></li>
<li>每天多吃半个蛋，增加7%的全因和心血管死亡风险？在假设性替代分析中，研究者发现，用等量的蛋清/鸡蛋替代物、家禽、鱼、乳制品、坚果和豆类分别替代半只全蛋（25克/天）可以降低6%、8%、9%、7%、13%和10%的全因死亡率。
*<a href="https://raw.githubusercontent.com/qhy040404/Image-Resources-Repo/master/pmed.1003508.g002.jpg" target="_blank" rel="noopener noreferrer">鸡蛋</a></li>
</ul>
</li>
</ul>
</li>
<li>坚果
<ul>
<li><a href="https://www.163.com/dy/article/GKVOMMMF05148PF4.html" target="_blank" rel="noopener noreferrer">哈佛20年研究：吃核桃的人更长寿，显著减少全因死亡，延长寿命</a>
<ul>
<li>出处：<a href="https://www.mdpi.com/2072-6643/13/8/2699/pdf" target="_blank" rel="noopener noreferrer">Association of Walnut Consumption with Total and Cause-Specific Mortality and Life Expectancy in US Adults</a></li>
<li>通过分析发现，经常食用核桃可以延长寿命，降低心血管疾病死亡风险。比起不吃核桃，每周食用核桃5份以上（1份28克）的健康预期寿命延长1.3岁，全因死亡风险降低14%，心血管疾病死亡率降低25%。</li>
</ul>
</li>
<li><a href="https://zhuanlan.zhihu.com/p/44454030" target="_blank" rel="noopener noreferrer">研究：每日食生坚果，死亡率降20%</a>
<ul>
<li>出处1：<a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1307352" target="_blank" rel="noopener noreferrer">Association of nut consumption with total and cause-specific mortality</a></li>
<li>出处2：<a href="https://americanpistachios.cn/sites/china/files/inline-files/APG_Health-%26-Nutrition-Research-Brochure_DEC-19-18.pdf" target="_blank" rel="noopener noreferrer">APG_Health-&amp;-Nutrition-Research-Brochure_DEC-19-18</a></li>
<li>研究人员发现，每周吃树坚果低于1盎司份量的人，死亡率降低7％。而每周吃了1盎司份量的人，减少11％的死亡率；每周吃2份量的人，减低13％；每周5至6份量者，减少了15％；一周7份以上的人，死亡率则减少20％。</li>
<li>另外两篇发表在《公共科学图书馆在线期刊》(Public Library of Science Online Journal)和《生物医学中心》(BioMed Central)上的医学预科研究论文，展示了试验开始时的横断面数据。这两项研究都评估了7,216名对象，以及他们食用坚果的频率和数量之间的关系。那些每周食用三份以上坚果(包括开心果)的研究对象的死亡率降低39%。</li>
</ul>
</li>
</ul>
</li>
<li>钠（存有大量争议）
<ul>
<li><a href="https://nursing.medsci.cn/article/show_article.do;jsessionid=A34E8A33918A152CB55BDD2E5FB1798D?id=afe720486ee7" target="_blank" rel="noopener noreferrer">Eur Heart J：钠摄入量与预期寿命、全因死亡率的关系</a>
<ul>
<li>出处：<a href="https://europepmc.org/backend/ptpmcrender.fcgi?accid=PMC8169157&amp;blobtype=pdf" target="_blank" rel="noopener noreferrer">Messerli F H, Hofstetter L, Syrogiannouli L, et al. Sodium intake, life expectancy, and all-cause mortality[J]. European heart journal, 2021, 42(21): 2103-2112.</a></li>
<li><img src="https://user-images.githubusercontent.com/2707039/164894778-9710f18d-e055-4f62-bdcb-618687771d77.jpeg" alt="ehaa947f6" tabindex="0" loading="lazy"><figcaption>ehaa947f6</figcaption></li>
<li>在该分析所包含的181个国家中，研究人员发现钠摄入量与出生时的健康预期寿命（β=2.6年/克每日钠摄入量，R<sup>2</sup>=0.66，P&lt;0.001）和60岁时的健康预期寿命（β=0.3年/克每日钠摄入量，R<sup>2</sup>=0.60，P=0.048）之间存在正相关关系，但与非传染性疾病死亡（β=17次事件/克每日钠摄入量，R<sup>2</sup>=0.43，P=0.100）无关。相反，全因死亡率与钠摄入量成负相关（β=−131次事件/克每日钠摄入量，R<sup>2</sup>=0.60，P&lt;0.001）。在仅限于46个收入最高国家的敏感性分析中，钠摄入量与出生时的健康预期寿命呈正相关（β=3.4年/克每日钠摄入量，R<sup>2</sup>=0.53，P&lt;0.001），而与全因死亡率（β=−168次事件/克每日钠摄入量，R<sup>2</sup>=0.50，P&lt;0.001）呈负相关。</li>
<li>该（大范围）研究认为更多的钠摄入与显著更低的全因死亡率有关</li>
<li><a href="https://www.tctmd.com/news/fresh-foray-salt-wars-life-expectancy-higher-greater-sodium-intake" target="_blank" rel="noopener noreferrer">针对该论文的延伸解读和讨论：A Fresh Foray in the Salt Wars: Life Expectancy Higher With Greater Sodium Intake</a></li>
</ul>
</li>
<li><a href="https://ibook.antpedia.com/x/669028.html" target="_blank" rel="noopener noreferrer">NEJM/Lancet：不要吃太多盐，中国饮食所致心血管病和癌症死亡全球第一，吃低钠盐可降低全因死亡率</a>
<ul>
<li>但也有多项研究认为用低钠盐可以降低一系列疾病的发生概率，对全因死亡率的减少有积极影响</li>
</ul>
</li>
</ul>
</li>
<li>碳水（存有大量争议）
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/137815934" target="_blank" rel="noopener noreferrer">低碳生酮饮食（四）碳水化合物与长期死亡率</a>
<ul>
<li>出处：The Lancet Public Health - <a href="https://www.sciencedirect.com/science/article/pii/S246826671830135X" target="_blank" rel="noopener noreferrer">Dietary carbohydrate intake and mortality: a prospective cohort study and meta-analysis</a></li>
<li>碳水越低，寿命越短；碳水越高，寿命也轻微缩短；碳水50%左右（其实按照一般的说法，这也算高碳水）是最长寿命区间</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703985-a2e2f8ac-101a-4f3c-903b-6850507f144b.jpg" alt="碳水" tabindex="0" loading="lazy"><figcaption>碳水</figcaption></li>
</ul>
</li>
<li><a href="https://www.chinacdc.cn/gwxx/202003/t20200323_214639.html" target="_blank" rel="noopener noreferrer">最强营养搭配！BMJ：这么吃，心血管疾病和死亡风险更低</a></li>
</ul>
</li>
<li>槟榔
<ul>
<li><a href="https://www.zhihu.com/question/312784161/answer/603370131" target="_blank" rel="noopener noreferrer">如何看待槟榔嚼出来的癌症？槟榔致癌风险究竟有多大？ - 丁香医生的回答 - 知乎</a>
<ul>
<li>出处：Chewing Betel Quid and the Risk of Metabolic Disease, Cardiovascular Disease, and All-Cause Mortality: A Meta-Analysis(https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0070679)</li>
<li>嚼槟榔会增加21%的全因死亡率</li>
</ul>
</li>
</ul>
</li>
<li>热量限制
<ul>
<li><a href="https://www.zhihu.com/question/31395511" target="_blank" rel="noopener noreferrer">怎么看待BBC《进食、断食与长寿》？</a>
<ul>
<li>限制卡路里动物实验：CR（热量限制，即少吃）延迟了恒河猴的多种疾病发病和死亡率，与CR动物相比，正常喂养的猴子的各种疾病患病风险增加2.9倍，死亡风险增加3.0倍。</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703988-8767185b-326a-4783-b2e2-f190322bb7d6.jpg" alt="热量限制-恒河猴" tabindex="0" loading="lazy"><figcaption>热量限制-恒河猴</figcaption></li>
</ul>
</li>
</ul>
</li>
<li>综合
<ul>
<li><a href="https://www.chinacdc.cn/gwxx/202003/t20200323_214639.html" target="_blank" rel="noopener noreferrer">最强营养搭配！BMJ：这么吃，心血管疾病和死亡风险更低</a></li>
<li><a href="https://doi.org/10.1136/bmj.m688" target="_blank" rel="noopener noreferrer">Associations of fat and carbohydrate intake with cardiovascular disease and mortality: prospective cohort study of UK Biobank participants</a>
<ul>
<li>通过对这些参与者的数据进行分析，研究人员发现碳水化合物（糖、淀粉和纤维）和蛋白质的摄入与全因死亡率呈非线性关系，而脂肪则与全因死亡率呈线性相关。其中，较高的糖分摄入与全因死亡风险和患心血管疾病的风险较高均有关联，而较高的饱和脂肪酸摄入与全因死亡风险较高有关。</li>
<li>图1：各种营养元素与全因死亡之间的关系</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702022-8c2bfea9-ed5d-4fe0-8ead-e8740014b92b.jpg" alt="各种营养元素与全因死亡之间的关系" tabindex="0" loading="lazy"><figcaption>各种营养元素与全因死亡之间的关系</figcaption></li>
<li>图2：各种营养元素与心血管疾病之间的关系</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702084-97fb4a03-707c-475d-b88e-6fe2f8e87f92.jpg" alt="各种营养元素与心血管疾病之间的关系" tabindex="0" loading="lazy"><figcaption>各种营养元素与心血管疾病之间的关系</figcaption></li>
<li><strong>进一步研究表明，在所有的饮食模式中，全因死亡率风险最低的饮食方式为：10-30g高纤维、14-30%蛋白质、10-25%单不饱和脂肪酸、5%-7%多不饱和脂肪酸以及20%-30%淀粉摄入。</strong></li>
<li><strong>最优能量来源配比：&lt;24%淀粉，15%-17%蛋白质，&gt;15%单不饱和脂肪酸，&lt;15%糖，6%饱和脂肪酸，6%多不饱和脂肪酸，30g+高纤维</strong></li>
</ul>
</li>
<li><a href="https://med.ckcest.cn/details.html?id=5183272274855936&amp;classesEn=news" target="_blank" rel="noopener noreferrer">BMJ | 常吃薯片汉堡巧克力等食品，平均死亡年龄仅仅为58岁，死亡风险剧增</a>
<ul>
<li><a href="https://www.bmj.com/content/365/bmj.l1949.full" target="_blank" rel="noopener noreferrer">Rico-Campà A, Martínez-González M A, Alvarez-Alvarez I, et al. Association between consumption of ultra-processed foods and all cause mortality: SUN prospective cohort study[J]. bmj, 2019, 365.</a></li>
<li><a href="https://www.bmj.com/content/365/bmj.l1451" target="_blank" rel="noopener noreferrer">Srour B, Fezeu L K, Kesse-Guyot E, et al. Ultra-processed food intake and risk of cardiovascular disease: prospective cohort study (NutriNet-Santé)[J]. bmj, 2019, 365.</a></li>
<li><a href="https://www.researchgate.net/profile/Phillip-Baker-5/publication/333483796_Ultra-processed_food_and_adverse_health_outcomes/links/5f0c646ca6fdcc2f32336a95/Ultra-processed-food-and-adverse-health-outcomes.pdf" target="_blank" rel="noopener noreferrer">Lawrence M A, Baker P I. Ultra-processed food and adverse health outcomes[J]. bmj, 2019, 365.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>6.1.2. 液体</h4>
<ul>
<li>牛奶
<ul>
<li><a href="https://www.sohu.com/a/253940257_419768" target="_blank" rel="noopener noreferrer">《柳叶刀》调研21个国家13万人：每天1斤牛奶或酸奶，心血管死亡风险下降23%</a></li>
<li>出处：<a href="http://mdrf-eprints.in/1114/1/Association_of_dietary_patterns_and_dietary_diversity_with_cardiometabolic_disease_risk_factors.pdf" target="_blank" rel="noopener noreferrer">Association of dairy intake with cardiovascular disease and mortality in 21 countries from five continents (PURE): a prospective cohort study</a></li>
<li>与不食用乳制品的人相比，每天摄入两份乳制品（一份指244克牛奶/酸奶，15克奶酪或5克黄油）的人，<strong>全因死亡风险下降了17%</strong>，心血管死亡风险下降23%，中风风险下降33%</li>
</ul>
</li>
<li>茶
<ul>
<li><a href="https://www.jianshu.com/p/5461a205cf95?utm_campaign=hugo" target="_blank" rel="noopener noreferrer">10万中国人随访7年发现，每周喝三次茶与全因死亡风险降低15%，预期寿命增加1.26年相关</a></li>
<li>出处：<a href="https://www.researchgate.net/profile/Fangchao-Liu-4/publication/338483323_Tea_consumption_and_the_risk_of_atherosclerotic_cardiovascular_disease_and_all-cause_mortality_The_China-PAR_project/links/5e55e5e94585152ce8efe511/Tea-consumption-and-the-risk-of-atherosclerotic-cardiovascular-disease-and-all-cause-mortality-The-China-PAR-project.pdf" target="_blank" rel="noopener noreferrer">Tea consumption and the risk of atherosclerotic cardiovascular disease and all-cause mortality: The China-PAR project</a></li>
<li><a href="http://rs.yiigle.com/CN112338202202/1351516.htm" target="_blank" rel="noopener noreferrer">中国成年人饮茶与死亡风险的前瞻性关联研究</a></li>
<li>纳入分析的438 443例研究对象随访11.1年共发生死亡34 661例。与从不饮茶者相比，当前非每日饮茶者和每日饮茶者全因死亡HR值（95%CI）依次为0.89（0.86-0.91）和0.92（0.88-0.95）。分性别分析显示，饮茶对全因死亡风险的保护作用主要见于男性（交互P&lt;0.05）</li>
</ul>
</li>
<li>无糖（甜味）饮料
<ul>
<li><a href="https://www.zhihu.com/question/418598272/answer/1450648364" target="_blank" rel="noopener noreferrer">「无糖饮料使死亡风险增加 26 %」，是真的吗？</a>
<ul>
<li>相比于软饮料摄入量＜1杯/月的参与者，混合软饮料摄入≥1杯/天的参与者死亡风险增加18%，而<strong>摄入含糖软饮料或无糖软饮料会令死亡风险分别增加11%和27%。</strong></li>
<li><img src="https://user-images.githubusercontent.com/2707039/163704346-e7d92e7f-eba5-4673-8f15-3a96782c2e32.png" alt="饮料" tabindex="0" loading="lazy"><figcaption>饮料</figcaption></li>
</ul>
</li>
<li><a href="https://jamanetwork.com/journals/jamainternalmedicine/fullarticle/2749350" target="_blank" rel="noopener noreferrer">Association Between Soft Drink Consumption and Mortality in 10 European Countries</a></li>
</ul>
</li>
<li>有糖饮料
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/400746073" target="_blank" rel="noopener noreferrer">可乐和奶茶，增加全因死亡率高达62%！果汁降低免疫力，影响肝代谢！含糖饮料那些事</a>
<ul>
<li>每天1杯含糖饮料增加7%全因死亡率，2杯21%</li>
<li>在34年的随访中，研究人员发现，相比那些一个月喝1杯或者更少含糖饮料的人，每天喝2杯的人总体死亡风险升高了21%，心血管疾病死亡风险升高了31%，癌症死亡风险上升了16%。</li>
<li>只要每天多喝一杯含糖饮料，总体死亡风险将增加7%，心血管疾病的风险将增加10%，癌症相关的死亡风险将16%。</li>
<li>发表在国际顶级期刊《BMJ》上的一篇论文就证明了含糖饮料会在增加患癌风险，当然这篇文章验证的不仅仅是果汁，奶茶也有份——和含糖饮料相关的总体患癌风险要高出通常值18%，100%的鲜榨果汁也会使得整体的患癌风险上升12%。</li>
</ul>
</li>
</ul>
</li>
<li>果汁
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/66513350" target="_blank" rel="noopener noreferrer">JAMA子刊：100%纯果汁可能比含糖饮料更危险</a>
<ul>
<li>每天多摄入一份12盎司的含糖饮料，全因死亡率风险增加11%；</li>
<li>每天多摄入一份12盎司的果汁，全因死亡率风险增加24%。</li>
</ul>
</li>
</ul>
</li>
<li>咖啡
<ul>
<li><a href="https://news.bioon.com/article/6725420.html" target="_blank" rel="noopener noreferrer">重磅！多篇研究证实喝咖啡与人群全因死亡率降低直接相关</a></li>
<li><a href="https://www.sohu.com/a/439412995_100003595" target="_blank" rel="noopener noreferrer">科普 | 喝咖啡又多了一个新理由：降低死亡率！</a></li>
<li><a href="https://fanyi.pdf365.cn/help/249" target="_blank" rel="noopener noreferrer">地中海成年人咖啡消耗量及全因，心血管疾病和癌症的死亡率</a>
<ul>
<li>在最近的荟萃分析中，该研究包括来自不同国家的40项研究和3,852,651名受试者。在这项荟萃分析显示，咖啡摄入量与各种原因的死亡率，CVD和癌症死亡率之间存在非线性关系，每天摄入两杯咖啡的癌症死亡率最低(RR = 0.96)，CVD最低的死亡率，每天2.5杯(RR= 0.83)，全天最低死亡率为每天3.5杯(RR= 0.85)，并且随着咖啡消费量的增加，死亡率没有进一步降低或增加</li>
</ul>
</li>
</ul>
</li>
<li>亚精胺
<ul>
<li><a href="https://www.medsci.cn/article/show_article.do?id=420d12904103" target="_blank" rel="noopener noreferrer">Science：科学背书！从精液中发现的亚精胺，竟然有着抗衰老、抗癌、保护心血管和神经、改善肥胖和2型糖尿病等逆天神效</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/388942219" target="_blank" rel="noopener noreferrer">饮食中亚精胺摄入量高会降低死亡率</a></li>
</ul>
</li>
</ul>
<h4>6.1.3. 气体</h4>
<ul>
<li>吸烟
<ul>
<li><a href="https://www.medsci.cn/article/show_article.do?id=02ca2083319b" target="_blank" rel="noopener noreferrer">即使是低强度吸烟，也增加死亡风险！</a>
<ul>
<li>研究发现：在42 416名男性和86 735名女性（年龄在35-89岁之间，以前没有患病）中，18 985名男性（45%）和18 072名女性（21%）目前吸烟，其中33%的男性吸烟者和39%的女性吸烟者并不每天吸烟。8866名男性（21%）和53 912名女性（62%）从不吸烟。在随访期间，与从不吸烟相比，每天&lt;10支烟或每天≥10支烟的全因死亡率危险比分别为1.17（95%置信区间1.10-1.25）和1.54（1.42-1.67）。无论年龄或性别，危险比相似。与每日吸烟关系最密切的疾病是呼吸道癌症、慢性阻塞性肺病和胃肠道及血管疾病。在招募时已经戒烟的人的死亡率低于现在每天吸烟者。</li>
<li>吸烟者平均减少寿命11-12年</li>
</ul>
</li>
<li><a href="https://www.zhihu.com/question/24846224/answer/1719798177" target="_blank" rel="noopener noreferrer">吸烟让人过瘾是什么原理？有节制的吸烟依旧有害吗？</a></li>
</ul>
</li>
</ul>
<h4>6.1.4. 光照</h4>
<ul>
<li>晒太阳
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/76301306" target="_blank" rel="noopener noreferrer">晒太阳和死亡率的关系，如何科学，安全的晒太阳？
</a>
<ul>
<li>丹麦一项长达26年的研究发现，多晒太阳能显著延长寿命，即使是由于过度暴晒诱发皮肤癌的患者，平均寿命也比普通人长了6岁。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>6.1.5. 药物</h4>
<ul>
<li>NMN</li>
<li>二甲双胍
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/419202902" target="_blank" rel="noopener noreferrer">“胍”吹必看 丨我就是神药——二甲双胍</a>
<ul>
<li>二甲双胍不仅在多种肿瘤、心血管疾病及糖尿病中发挥保护作用，而且在肥胖、肝病、肾病及衰老方面也大放异彩。</li>
</ul>
</li>
<li><a href="https://zhuanlan.zhihu.com/p/357807109" target="_blank" rel="noopener noreferrer">二甲双胍2020最值得了解的“吃瓜”大新闻——护胃、健脑、抗衰、防癌还是致癌？</a></li>
<li><a href="https://baijiahao.baidu.com/s?id=1729999374705305768" target="_blank" rel="noopener noreferrer">二甲双胍真的那么神吗？美研究：父亲服用二甲双胍或致子女有缺陷</a></li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702325-5d427542-9ae5-4311-8979-d0d326a9832f.jpg" alt="二甲双胍" tabindex="0" loading="lazy"><figcaption>二甲双胍</figcaption></li>
<li>不良反应
<ul>
<li>作为一种使用近百年的药物，二甲双胍的不良反应已经非常明确，常见的有：维生素B12缺乏（7%-17.4%），胃肠道不良反应（最高53%），疲倦（9%），头痛（6%）；严重但不常见的不良反应包括乳酸酸中毒、肝损伤；也有研究表明可能对胎儿致畸</li>
</ul>
</li>
</ul>
</li>
<li>复合维生素
<ul>
<li><a href="https://health.qq.com/a/20121023/000026.htm" target="_blank" rel="noopener noreferrer">服用复合维生素可降低癌症危险8%，其他效果并不显著</a></li>
</ul>
</li>
<li>葡萄糖胺
<ul>
<li><a href="https://www.sohu.com/a/436372221_120873241" target="_blank" rel="noopener noreferrer">神奇！氨糖降低心血管死亡率65%，与定期运动效果相当</a></li>
<li>美国西弗吉尼亚大学最新研究发现 氨糖（软骨素） 可以降低心血管死亡率65%，降低总体死亡率39%，效果与坚持定期运动相对</li>
<li>该研究使用1999年至2010年，16,686名成年人的国家健康和营养检查(NHANES)数据，参与者的中位追踪时间为107个月，而其中有648位参与者定期且每服用日500-1000毫克的葡萄糖胺/软骨素一年以上。</li>
</ul>
</li>
<li>亚精胺
<ul>
<li><a href="https://www.medsci.cn/article/show_article.do?id=420d12904103" target="_blank" rel="noopener noreferrer">Science：科学背书！从精液中发现的亚精胺，竟然有着抗衰老、抗癌、保护心血管和神经、改善肥胖和2型糖尿病等逆天神效</a></li>
<li>亚精胺是最容易从人体肠道吸收的多胺。许多的食物中都含有大量的亚精胺，例如新鲜的青椒、小麦胚芽、花椰菜、西兰花、蘑菇和各种奶酪，尤其在纳豆等大豆制品、香菇和榴莲中含量更高。在本实验中，研究人员选择了829位年龄在45-84岁之间的参与者进行了为期20年的随访，分析了饮食中亚精胺摄入量与人类死亡率之间的潜在关联。</li>
<li>研究发现，女性的亚精胺摄入量高于男性，并且摄入量都会随着年龄的增长而下降。亚精胺的主要来源是全谷物（占13.4%）、苹果和梨（占13.3%）、沙拉（占9.8%）、芽菜（占7.3%）和马铃薯（占6.4%）。研究根据亚精胺摄入量将人群分为三组，低摄入量组（&lt;62.2 µmol / d）、中摄入量组（62.2–79.8 µmol / d）和高摄入量组（&gt; 79.8 µmol / d）。随访期间共记录了341例死亡，其中血管疾病137例，癌症94例，其他原因110例。经计算低中高三组的粗略死亡率分别为40.5%、23.7%和15.1%，这些数据表明亚精胺摄入量与全因死亡率之间的负相关关系显著。随着逐步对年龄、性别和热量的比例进行调整，这种相关关系依然显著。</li>
</ul>
</li>
<li>综合
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/145495570" target="_blank" rel="noopener noreferrer">《自然》子刊深度综述：如何开发抗衰老药</a></li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702474-205baeec-f0ce-4e8d-96a4-36efe47534de.jpg" alt="如何开发抗衰老药" tabindex="0" loading="lazy"><figcaption>如何开发抗衰老药</figcaption></li>
</ul>
</li>
</ul>
<h3>6.2. 输出</h3>
<h4>6.2.1. 挥拍运动</h4>
<ul>
<li><a href="https://www.sohu.com/a/535581770_121124216" target="_blank" rel="noopener noreferrer">哪种运动性价比最高？权威医学杂志“柳叶刀”给出答案了</a>
<ul>
<li>一周三次，每次45-60分钟，挥拍运动，降低~47%全因死亡率</li>
<li>羽毛球、乒乓球、网球等都算挥拍运动，但由于西化研究背景，可能指网球更多。这隐式的表达了全身锻炼更为重要</li>
</ul>
</li>
</ul>
<h4>6.2.2. 走路</h4>
<ul>
<li><a href="http://www.shcell.org/219/3571.html" target="_blank" rel="noopener noreferrer">走路降低全因死亡率超过50%！每天走多少步最合适？《JAMA》子刊超10年研究告诉你答案</a>
<ul>
<li><img src="https://user-images.githubusercontent.com/2707039/163704147-afec1c79-799b-4db8-b547-1a2431d504c9.jpg" alt="走路降低全因死亡率" tabindex="0" loading="lazy"><figcaption>走路降低全因死亡率</figcaption></li>
<li>注1：这项研究参与者的平均年龄为45.2岁</li>
<li>注2：平均步数的多少与职业有关，此项研究仅表明相关性，还没有更深度的因果分析</li>
</ul>
</li>
</ul>
<h4>6.2.3. 刷牙</h4>
<ul>
<li><a href="https://www.cn-healthcare.com/articlewm/20211209/content-1293760.html" target="_blank" rel="noopener noreferrer">50万国人研究证实：不好好刷牙，致癌！血管疾病也会增多！</a>
<ul>
<li>经常不刷牙的人：癌症、慢性阻塞性肺病及肝硬化风险分别增加了9%、12%和25%，过早死亡风险增加25%。</li>
</ul>
</li>
</ul>
<h4>6.2.4. 泡澡</h4>
<ul>
<li><a href="https://www.cn-healthcare.com/article/20200326/content-533379.html" target="_blank" rel="noopener noreferrer">定期洗澡降低心血管疾病发作风险</a>
<ul>
<li>与每周一至两次泡澡或根本不泡澡相比，每天洗热水澡可以降低28%的心血管疾病总风险，降低26%的中风总风险，脑出血风险下降46%。而浴缸浴的频率与心源性猝死的风险增加无关。</li>
</ul>
</li>
</ul>
<h4>6.2.5. 做家务（老年男性）</h4>
<ul>
<li><a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0061529" target="_blank" rel="noopener noreferrer">Housework Reduces All-Cause and Cancer Mortality in Chinese Men</a>
<ul>
<li>72岁之后男性每周做重型家务可以减少29%平均死亡率</li>
<li>重型家务：吸尘、擦地板、拖地、擦洗窗户、洗车、搬动家具、搬煤气罐等等。</li>
<li>轻型家务：掸灰尘、洗碗、手洗衣服、熨烫、晾衣服、做饭、买日用品等等。</li>
</ul>
</li>
</ul>
<h4>6.2.6. 睡眠</h4>
<ul>
<li><a href="https://med.sina.com/article_detail_103_1_105491.html" target="_blank" rel="noopener noreferrer">超30万亚洲人数据：每天睡几个小时最有益长寿？</a>
<ul>
<li>在男性中，与睡眠时长为7小时相比：睡眠持续时间≥10小时与全因死亡风险增加34%相关；</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163704166-226b7ebb-92ce-4753-a3e7-77a87652a104.jpg" alt="睡眠-男" tabindex="0" loading="lazy"><figcaption>睡眠-男</figcaption></li>
<li>在女性中，与睡眠持续时间7小时相比：睡眠持续时间≥10小时与全因死亡风险增加48%相关；</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163704169-c5c715aa-7130-403b-b0d1-ec34fab094d8.png" alt="睡眠-女" tabindex="0" loading="lazy"><figcaption>睡眠-女</figcaption></li>
</ul>
</li>
<li><a href="https://www.thepaper.cn/newsDetail_forward_14461799" target="_blank" rel="noopener noreferrer">颠覆认知！加拿大研究发现：早睡比熬夜或许更伤身，几点睡才好？</a>
<ul>
<li>其中一个结论为，就寝时间与全因死亡率的关联性强，过早睡觉和过晚睡觉都会影响健康，但是早睡增加的全因死亡率比晚睡增加的死亡率高，早睡增加了43%的死亡风险，而晚睡增加了15%的死亡风险。</li>
<li>这项调查研究，还存在很多局限性，比如没有直接证明就寝时间与死亡的关系，仅仅说明相关性，通过参与人群自我报告统计睡眠时间，数据不够客观</li>
</ul>
</li>
</ul>
<h3>6.3. 上下文</h3>
<h4>6.3.1. 情绪</h4>
<ul>
<li><a href="https://www.x-mol.com/paper/1288184397379059712/t?recommendPaper=1263704526086578176" target="_blank" rel="noopener noreferrer">悲观情绪与更高的全因死亡率和心血管疾病死亡率有关，但乐观情绪并不能起到保护作用</a></li>
<li><a href="https://www.nature.com/articles/s41598-020-69388-y?utm_source=xmol&amp;utm_medium=affiliate&amp;utm_content=meta&amp;utm_campaign=DDCN_1_GL01_metadata_scirep" target="_blank" rel="noopener noreferrer">Pessimism is associated with greater all-cause and cardiovascular mortality, but optimism is not protective</a>
<ul>
<li>在1993-1995年间，一项针对50岁以上澳大利亚人健康的双胞胎研究中包括了生活取向测试（LOT），其中包含乐观和悲观的项目。平均20年后，参与者与来自澳大利亚国家死亡指数的死亡信息相匹配。在2,978名具有很多可用分数的参与者中，有1,068人死亡。生存分析测试了各种乐观因素和悲观情绪分数与任何原因，癌症，心血管疾病或其他已知原因的死亡率之间的关联。年龄调整后的悲观量表上的核心与全因和心血管疾病死亡率相关（每1个标准差单位的危险比，95％置信区间和p值1.134、1.065–1.207、8.85×10 –5和1.196、1.045–1.368、0.0093 ），但不会因癌症死亡。乐观得分与悲观得分之间的相关性很弱（年龄调整后的等级相关系数= − 0.176），但与总死亡率或特定原因死亡率没有显着相关性。反向因果关系（引起悲观情绪的疾病）是不可能的，因为在那种情况下，心血管疾病和癌症都会导致悲观情绪。</li>
</ul>
</li>
</ul>
<h4>6.3.2. 贫富</h4>
<ul>
<li><a href="https://www.cn-healthcare.com/articlewm/20210727/content-1246348.html" target="_blank" rel="noopener noreferrer">JAMA子刊：贫富差距真能影响寿命？这可能是真的！</a>
<ul>
<li>该研究使用1994-1996年第一次收集的数据，并通过生存模型来分析净资产和长寿之间的关联。结果显示，共收纳5414 名参与者，平均年龄为 46.7岁，包括 2766 名女性。较高的净资产与较低的死亡风险相关。特别是在兄弟姐妹和双胞胎中（n = 2490），在较高的净资产和较低的死亡率之间观察到类似的关联，表明拥有更多财富的兄弟姐妹或双胞胎比拥有更少财富的兄弟姐妹/双胞胎活得更久。</li>
</ul>
</li>
</ul>
<h4>6.3.3. 体重</h4>
<ul>
<li><a href="https://www.chinacdc.cn/gwxx/202009/t20200904_218959.html" target="_blank" rel="noopener noreferrer">JAMA子刊：减肥要趁早，才能有效降低死亡率风险</a>
<ul>
<li>对体重减轻的死亡率风险评估发现，体重从肥胖减轻到超重的成年人与稳定肥胖人群相比，全因死亡率降低了54％（危险比为0.46），然而从成年初期的超重减轻到中年以前的正常体重的人群的死亡率风险并未降低（风险比为1.12）。</li>
<li><img src="https://raw.githubusercontent.com/qhy040404/Image-Resources-Repo/master/zoi200509t3_1596761185.02415.png" alt="Table3" tabindex="0" loading="lazy"><figcaption>Table3</figcaption></li>
</ul>
</li>
</ul>
<h4>6.3.4. 新冠</h4>
<ul>
<li><a href="https://www.nature.com/articles/s41591-020-1112-0.pdf" target="_blank" rel="noopener noreferrer">Magnitude, demographics and dynamics of the effect of the first wave of the COVID-19 pandemic on all-cause mortality in 21 industrialized countries</a>
<ul>
<li>目前来看，新冠死亡率（美国）在1.5%左右，人均预期寿命减少了2年</li>
</ul>
</li>
<li><a href="https://www.zhihu.com/question/510943670/answer/2308499719" target="_blank" rel="noopener noreferrer">如何看待美国CDC宣称新冠死亡人数被高估？</a></li>
<li><a href="https://www.cdc.gov/nchs/nvss/deaths.htm" target="_blank" rel="noopener noreferrer">NVSS deaths</a></li>
</ul>
]]></content>
    <category term="转载"/>
    <published>2023-03-03T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">vscode leetcode插件</title>
    <id>http://blog.cjhe.top/tools/vscode-leetcode.html</id>
    <link href="http://blog.cjhe.top/tools/vscode-leetcode.html"/>
    <updated>2023-08-14T13:05:37.000Z</updated>
    <summary type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>vscode这款插件太香了，终于可以沉浸式刷leetcode😄</p>
</div>
]]></summary>
    <content type="html"><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>vscode这款插件太香了，终于可以沉浸式刷leetcode😄</p>
</div>
<!-- more -->
<h2>环境搭建</h2>
<h3>安装</h3>
<p>在vscode扩展商店搜索<code>LeetCode</code>,一般是下载量最高的那个就完事了
</p>
<h3>登陆</h3>
<p>在登陆之前，记得要选择中国版，否则会遇见登陆不上问题

接下来选择账号登录，需要提前在LeetCode官网注册账号

这里我选择账户方式，按照提示填写邮箱、密码即可登录</p>
<h3>预览</h3>
<figure><figcaption>leetcode-preview</figcaption></figure>
<blockquote>
<p>在左侧，该插件按照五个分类将题目进行了分类，比如：按照难易程度(简单、中等、难)、按照标签(数据、二叉搜索等)、按照公司(Google、Facebook等)</p>
<p>且题目根据难易程度有不同的颜色进行区分，如果已经完成相关的练习，还会用✔️提示</p>
</blockquote>
<h3>个性化配置</h3>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"leetcode.endpoint"</span><span class="token operator">:</span> <span class="token string">"leetcode-cn"</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.workspaceFolder"</span><span class="token operator">:</span> <span class="token string">"/Users/hechangjie/code/hexiaopi/leetcode-go"</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.defaultLanguage"</span><span class="token operator">:</span> <span class="token string">"golang"</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.hint.configWebviewMarkdown"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.hint.commentDescription"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.hint.commandShortcut"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>沉浸式刷题</h2>
<h3>预览题目内容</h3>
<p>
点击Code Now，选择一种编程语言就可以开始了</p>
<h3>编写代码</h3>
<figure><figcaption>leetcode-code</figcaption></figure>
<h3>测试代码</h3>
<p>点击代码下方的<code>Test</code>标签即可进行测试代码（再也不用编写大量的单元测试用例了）
</p>
<h3>提交代码</h3>
<p>点击代码下方的<code>Submit</code>标签即可提交代码，完成之后就会看到提交后的代码性能等信息了
</p>
]]></content>
    <category term="工具"/>
    <published>2022-08-10T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">存储引擎</title>
    <id>http://blog.cjhe.top/database/mysql/engine.html</id>
    <link href="http://blog.cjhe.top/database/mysql/engine.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="text">MySQL是常用的关系型数据库

MySQL架构
MySQL架构MySQL架构
存储引擎

存储引擎是MySQL区别于其他数据库的一个重要特性，MySQL有诸多存储引擎，且存储引擎是基于表的，而不是数据(同一个数据库下面的各个表可以使用不同的引擎)
存储引擎是底层物理结构的实现，每个存储引擎开发者可以按照自己的意愿开发，具有各自的特点
对于MySQL使...</summary>
    <content type="html"><![CDATA[<!-- more -->
<blockquote>
<p>MySQL是常用的关系型数据库</p>
</blockquote>
<h2>MySQL架构</h2>
<figure><figcaption>MySQL架构</figcaption></figure>
<h2>存储引擎</h2>
<ul>
<li>存储引擎是MySQL区别于其他数据库的一个重要特性，MySQL有诸多存储引擎，且<strong>存储引擎是基于表的，而不是数据</strong>(同一个数据库下面的各个表可以使用不同的引擎)</li>
<li>存储引擎是底层物理结构的实现，每个存储引擎开发者可以按照自己的意愿开发，具有各自的特点</li>
<li>对于MySQL使用者来说，存储引擎对其实透明的</li>
</ul>
<h3>Innodb引擎</h3>
<blockquote>
<p>是一个支持ACID事务，行锁设计，支持MVCC功能，实现了SQL标准的4种隔离级别</p>
</blockquote>
<h4>特点</h4>
<ul>
<li>使用Table Space的方式仅限数据存储</li>
<li>支持事务、外键约束等数据库特性</li>
<li>Rows Level Lock，读写性能都非常优秀</li>
<li>拥有独立的缓冲池，能够缓存数据和索引</li>
<li>通过多版本控制，支持高并发业务</li>
</ul>
<h4>注意事项</h4>
<ul>
<li>主键尽可能小，否则二级索引会膨胀</li>
<li>避免全表扫描，导致锁升级</li>
<li>尽可能缓存所有的索引和数据，减少IO操作</li>
<li>避免主键更新，造成大量的数据移动</li>
</ul>
<h3>MyISAM存储引擎</h3>
<blockquote>
<p>MySQL 5.5之前默认是MyISAM存储引擎，之后默认都改为InnoDB</p>
</blockquote>
<h4>特点</h4>
<ul>
<li>数据存储方式简单，使用B-Tree进行索引，<strong>索引叶子节点存放数据的指针</strong></li>
<li><strong>不支持一些数据库特性，比如事务、外键约束等</strong></li>
<li><strong>Table Level Lock(表级别锁)</strong>，性能稍差，更适合读多的操作</li>
<li>使用三个文件定义一个表：
<ul>
<li><code>.MYi</code>：存储索引</li>
<li><code>.MYD</code>：存储数据</li>
<li><code>.frm</code>：存储表定义</li>
</ul>
</li>
<li>少碎片、支持大文件、能够进行索引压缩</li>
<li>二进制层次的文件可以移植（Linux-&gt;Windows）</li>
<li>访问速度快，适合只读查询场景</li>
</ul>
<h4>注意事项</h4>
<ul>
<li>设置合适索引</li>
<li>启用延迟写入，尽量一次大批量写入，而非频繁写入</li>
<li>降低并发数，高并发使用排队机制</li>
<li>由于存储了Count字段，因此Count操作比较高效，但仅限不带条件</li>
</ul>
<h2>引擎对比</h2>
<p>| 存储引擎  |                             特点                              |       应用场景       |
| :</p>
]]></content>
    <category term="数据存储"/>
    <published>2022-10-22T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">索引</title>
    <id>http://blog.cjhe.top/database/mysql/idx.html</id>
    <link href="http://blog.cjhe.top/database/mysql/idx.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="html"><![CDATA[<p>索引是一种数据结构，帮助SQL高效获取数据的。类似一本书的目录，可以快速对特定值进行定位和查找，从而大大加快数据查询的效率。</p>
]]></summary>
    <content type="html"><![CDATA[<p>索引是一种数据结构，帮助SQL高效获取数据的。类似一本书的目录，可以快速对特定值进行定位和查找，从而大大加快数据查询的效率。</p>
<!-- more -->
<h2>索引优缺点</h2>
<h3>索引优点</h3>
<ul>
<li>索引可以大大减少需要扫描的数据量</li>
<li>索引可以避免排序和临时表，索引已经有序</li>
<li>索引可以尽量将随机IO变成顺序IO，例如：聚簇索引包含数据，且索引是有序的，就可以快速获得批量数据，但如果回表，通过主键查询数据，则又变成随机IO</li>
<li>索引对于InnoDB（支持行级锁）非常重要，InnoDB对需要访问的元组加锁，而索引能够减少InnoDB访问的元组数，如果查询不能使用索引，MySQL会进行全表扫描，导致锁住全表。</li>
</ul>
<h3>索引缺点</h3>
<ul>
<li>降低了更新表的数据，因为不仅要更新原始数据，还要更新索引</li>
<li>索引占用磁盘空间</li>
<li>数据列如果包含了许多重复的内容，例如性别为：男、女，索引选择可能只筛选一半的数据量，效果不是很好</li>
<li>对于数据量非常小的表，索引意义不大，有时全表扫描更高效</li>
</ul>
<p>MySQL单张表最多只支持16个索引</p>
<h2>索引类型</h2>
<h3>按功能逻辑划分</h3>
<h4>普通索引</h4>
<p>普通索引仅仅加快对数据的访问速度，常用于查询条件（where field_name=value）或排序条件（order by field_name）这些场景中。</p>
<h4>唯一索引</h4>
<p>唯一索引相比较普通索引，要求索引列的值必须唯一，但允许有空值。</p>
<h4>主键索引</h4>
<p>主键索引是一种特殊的索引，不允许有空值，一张表只能有一个主键，一般在建表的时候通过primary key(field_name)指定</p>
<h4>全文索引</h4>
<p>mysql Like '%xxx'就会导致索引失效，为了模糊搜索需求，例如：like '%hello%'，就需要全文索引支持。InnoDB在5.6版本之后支持全文索引。</p>
<h3>按物理逻辑划分</h3>
<h4>聚簇索引</h4>
<p>聚簇索引的叶子节点直接存储数据，因此查询的时候只需要进行一次查询</p>
<h4>非聚簇索引</h4>
<p>非聚簇索引的叶子节点存储数据的主键，因此查询的时候需要进行两次查询：先查询聚簇索引获取到主键，再通过主键查询数据。</p>
<h3>按字段个数划分</h3>
<h4>单一索引</h4>
<p>索引只使用一个字段</p>
<h4>联合索引</h4>
<p>索引使用多个字段
例如：</p>
<div class="language-sql" data-ext="sql" data-title="sql"><pre class="language-sql"><code>alert <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> <span class="token keyword">index</span> index_name_city_age<span class="token punctuation">(</span>name<span class="token punctuation">,</span>city<span class="token punctuation">,</span>age<span class="token punctuation">)</span>
</code></pre></div><p>MySQL联合索引遵从：最左匹配原则</p>
<p>上面索引相当于建立下面三组索引：</p>
<ul>
<li>name,city,age</li>
<li>name,city</li>
<li>name</li>
</ul>
<p>因此：</p>
<ul>
<li>如果查询条件是：(city)、(city,age)、(age)都不会命中索引</li>
<li>如果查询条件是：(name,age)，则会命中name索引</li>
</ul>
<p>理论上最左匹配原则中索引对 where 中子句的顺序也是敏感的，但是由于MySQL的查询优化器会自动调整 where 子句的条件顺序以使用适合的索引，所以实际上 where 子句顺序不影响索引的效果。</p>
<p>如果联合索引有范围查询，就会停止匹配</p>
<p>如果分别在 x, y, z 上建立单列索引，让该表有3个单列索引，索引效率也会大不一样，在联合索引生效的情况下，单个索引的效率远远低于联合索引。这是由 MySQL 查询优化器的执行顺序决定的，在执行一条查询 sql 时，针对索引的选择大致有如下步骤：</p>
<p>MySQL 优化器根据搜索条件，找出所有可能使用的索引
计算全表扫描的代价
计算使用不同索引执行查询的代价
对比各种执行方案的代价，找出成本最低的那一个
因此，虽然有多个单列索引，但 MySQL 只能用到其中的那个系统认为似乎是最有效率的，其他的就会失效。</p>
<h2>总结</h2>
<h3>索引推荐使用情况</h3>
<ul>
<li>WHERE, GROUP BY, ORDER BY 子句中的字段</li>
<li>多个单列索引在多条件查询是只会有一个最优的索引生效，因此多条件查询中最好创建联合索引。</li>
<li>联合索引的时候必须满足最左匹配原则，并且最好考虑到 sql 语句的执行顺序，比如 WHERE a = 1 GROUP BY b ORDER BY c, 那么联合索引应该设计为 (a,b,c)，因为mysql 查询语句的执行顺序 WHERE &gt; GROUP BY &gt; ORDER BY。<a href="/database/mysql/sql-order.html" target="_blank">参见</a></li>
<li>多张表 JOIN 的时候，对表连接字段创建索引。</li>
<li>当 SELECT 中有不在索引中的字段时，会先通过索引查询出满足条件的主键值，然后通过主键回表查询出所有的 SELECT 中的字段，影响查询效率。因此如果 SELECT 中的内容很少，为了避免回表，可以把 SELECT 中的字段都加到联合索引中，这也就是宽索引的概念。但是需要注意，如果索引字段过多，存储和维护索引的成本也会增加。</li>
</ul>
<h3>不推荐使用或索引失效情况</h3>
<ul>
<li>数据量很小的表</li>
<li>有大量重复数据的字段</li>
<li>频繁更新的字段</li>
<li>如果对索引字段使用了函数或者表达式计算，索引失效</li>
<li>字段类型不一致也会失效，因为等价使用函数</li>
<li>innodb OR 条件没有对所有条件创建索引，索引失效</li>
<li>大于小于条件 &lt; &gt;，索引是否生效取决于命中的数量比例，如果命中数量很多，索引生效，命中数量很小，索引失效</li>
<li>不等于条件 !=、&lt;&gt;，索引失效</li>
<li>LIKE 值以 % 开头，索引失效</li>
</ul>
]]></content>
    <category term="数据存储"/>
    <published>2023-03-15T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">SQL查询顺序</title>
    <id>http://blog.cjhe.top/database/mysql/sql-order.html</id>
    <link href="http://blog.cjhe.top/database/mysql/sql-order.html"/>
    <updated>2024-05-27T02:38:52.000Z</updated>
    <summary type="text">sql-queriessql-queries
这张图与 SQL 查询的语义有关，让你知道一个查询会返回什么，并回答了以下这些问题：


可以在 GROUP BY 之后使用 WHERE 吗？（不行，WHERE 是在 GROUP BY 之前！）


可以对窗口函数返回的结果进行过滤吗？（不行，窗口函数是 SELECT 语句里，而 SELECT 是在 WHE...</summary>
    <content type="html"><![CDATA[<!-- more -->
<figure><img src="https://jvns.ca/images/sql-queries.jpeg" alt="sql-queries" tabindex="0" loading="lazy"><figcaption>sql-queries</figcaption></figure>
<p>这张图与 SQL 查询的语义有关，让你知道一个查询会返回什么，并回答了以下这些问题：</p>
<ul>
<li>
<p>可以在 GROUP BY 之后使用 WHERE 吗？（不行，WHERE 是在 GROUP BY 之前！）</p>
</li>
<li>
<p>可以对窗口函数返回的结果进行过滤吗？（不行，窗口函数是 SELECT 语句里，而 SELECT 是在 WHERE 和 GROUP BY 之后）</p>
</li>
<li>
<p>可以基于 GROUP BY 里的东西进行 ORDER BY 吗？（可以，ORDER BY 基本上是在最后执行的，所以可以基于任何东西进行 ORDER BY）</p>
</li>
<li>
<p>LIMIT 是在什么时候执行？（在最后！）</p>
</li>
</ul>
<p>但数据库引擎并不一定严格按照这个顺序执行 SQL 查询，因为为了更快地执行查询，它们会做出一些优化。</p>
<p>所以：</p>
<p>如果你想要知道一个查询语句是否合法，或者想要知道一个查询语句会返回什么，可以参考这张图；</p>
<p>需要注意的是，在实际实现中，MySQL会根据具体的查询条件和数据量进行一定的优化和调整。在涉及查询性能或者与索引有关的东西时，这张图就不适用了。</p>
<p>关于数据查询顺序和变化参考下图：</p>
<figure><figcaption>sql-order</figcaption></figure>
<h2>详细查询顺序</h2>
<p>1.FROM子句</p>
<blockquote>
<p>MySQL首先处理FROM子句，该步骤主要是确定需要查询的数据表，并建立数据表之间的连接关系。</p>
</blockquote>
<p>2.WHERE子句</p>
<blockquote>
<p>根据WHERE子句指定的查询条件，MySQL会进行筛选并过滤出符合条件的数据。</p>
</blockquote>
<p>3.GROUP BY子句</p>
<blockquote>
<p>如果查询需要对数据分组，则MySQL会按照GROUP BY子句中指定的分组条件对数据进行分组，然后对每个组进行汇总计算。</p>
</blockquote>
<p>4.HAVING子句</p>
<blockquote>
<p>HAVING子句用于过滤分组后的数据，和WHERE子句类似。只有满足HAVING子句指定的条件的组才会出现在结果集中。</p>
</blockquote>
<p>5.SELECT子句</p>
<blockquote>
<p>SELECT子句是MySQL查询语句最主要的部分，它用于指定需要查询的数据集合以及计算这个数据集合中的一些列值。</p>
</blockquote>
<p>6.DISTINCT</p>
<blockquote>
<p>如果使用了DISTINCT关键字，则MySQL会过滤掉查询结果中的重复记录。</p>
</blockquote>
<p>7.ORDER BY</p>
<blockquote>
<p>ORDER BY子句用于对查询结果进行排序。MySQL会按照指定的列或表达式的结果对查询结果进行排序，可以指定升序或降序。</p>
</blockquote>
<p>8.LIMIT</p>
<blockquote>
<p>LIMIT关键字用于限制查询结果的数量。MySQL只返回前N条符合条件的记录，其中N由LIMIT语句后面的数字指定。</p>
</blockquote>
<h2>参考文献</h2>
<p><a href="https://jvns.ca/blog/2019/10/03/sql-queries-don-t-start-with-select/" target="_blank" rel="noopener noreferrer">SQL查询不是以select开始</a>
<a href="https://blog.bytebytego.com/p/ep50-visualizing-a-sql-query" target="_blank" rel="noopener noreferrer">bytebytego</a></p>
]]></content>
    <category term="数据存储"/>
    <published>2023-03-09T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">事务</title>
    <id>http://blog.cjhe.top/database/mysql/transaction.html</id>
    <link href="http://blog.cjhe.top/database/mysql/transaction.html"/>
    <updated>2024-05-20T03:37:50.000Z</updated>
    <summary type="text">事务的特性

原子性(Atomicity): 事务中的所有操作要么全部完成，要么全部不完成（回滚），不会在事务中间遇到错误而中断。
一致性(Consistency): 事务开始和结束时，数据都必须保持一致状态，即符合约束、完整性、默认值以及其它定义的规则。事务执行的结果不能破坏数据库的完整性和一致性。
隔离性(Isolation): 各个事务互相隔离，...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>事务的特性</h2>
<ul>
<li>原子性(Atomicity): 事务中的所有操作要么全部完成，要么全部不完成（回滚），不会在事务中间遇到错误而中断。</li>
<li>一致性(Consistency): 事务开始和结束时，数据都必须保持一致状态，即符合约束、完整性、默认值以及其它定义的规则。事务执行的结果不能破坏数据库的完整性和一致性。</li>
<li>隔离性(Isolation): 各个事务互相隔离，每个事务的执行都不会影响其它事务的执行或者结果。</li>
<li>持久性(Durability): 一个事务一旦提交成功，它对数据库中的数据的改变就是永久性的，即使发生数据库故障也不应该对其产生影响。</li>
</ul>
<h2>事务的实现</h2>
<ul>
<li>Undo log：实现事务的原子性；</li>
<li>Redo log：实现事务的持久性；</li>
<li>锁/MVCC：实现事务的隔离性；锁机制来保证事务在执行时互相隔离，防止事务间相互干扰，即写-写问题。MVCC 机制是通过保存历史版本的方式来实现，事务可以读取数据在事务开始时的版本，而不受到事务期间其他事务所做的改变的影响，即写-读问题。</li>
<li>以上三者保证了事务的一致性；</li>
</ul>
<h2>并发事务带来的问题</h2>
<p>当数据库上有多个事务同时执行的时候，就可能出现<strong>脏读(dirty read)</strong>、<strong>不可重复读(non-repeatable read)</strong>、<strong>幻读(phantom read)</strong>，为了解决这些问题，就有了隔离级别的概念</p>
<h3>脏读问题</h3>
<blockquote>
<p>脏读是指：一个事务中访问到了另外一个事务未提交的数据</p>
</blockquote>
<figure><figcaption>dirty-read</figcaption></figure>
<h3>不可重复读问题</h3>
<blockquote>
<p>不可重复读是指：一个事务多次读取同一行数据，但是在多次读取中数据发生了改变。</p>
</blockquote>
<figure><figcaption>non-repeatable-read</figcaption></figure>
<h3>幻读问题</h3>
<blockquote>
<p>幻读是指：一个事务多次执行同一条 SQL 语句，但结果集却不同，导致无法支撑后续的业务操作</p>
</blockquote>
<figure><figcaption>phantom-read</figcaption></figure>
<h2>事务的隔离级别</h2>
<p>针对上面三种问题，分别有四种隔离级别：</p>
<h3>未提交读(read uncommitted，RU)</h3>
<blockquote>
<p>未提交读，是指一个事务还未提交时，它做的变更就能被别的事务看到。即<strong>没有提交却可以读</strong></p>
</blockquote>
<h3>提交读(read committed，RC)</h3>
<blockquote>
<p>提交读，是指一个事务提交之后，它做的变更才会被其他事务看到。即<strong>提交才可以读</strong></p>
</blockquote>
<p>👀 <strong>大多数数据库系统的默认隔离级别</strong></p>
<h3>可重复读(repeatable read，RR)</h3>
<blockquote>
<p>可重复度，是指同一个事务执行过程看到的数据，总是跟这个事务在启动时看到的数据是一致的。即同一个事务多次请求读取数据，会看到同样的数据行。</p>
</blockquote>
<p>👀 <strong>MySQL的默认隔离级别</strong></p>
<h3>串行化(serializable，S)</h3>
<blockquote>
<p>是最高的隔离级别，它通过强制事务排序，使之不可能相互冲突。</p>
<p>这个级别可能导致大量的超时现象和锁竞争。</p>
</blockquote>
<p>以上四种隔离级别解决问题如下：</p>
<p>| 隔离级别\解决问题 |        脏读        |     不可重复读     |        幻读        |                     实现原理                     |
| :</p>
]]></content>
    <category term="数据存储"/>
    <published>2022-10-23T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">基于Redis的分布式锁</title>
    <id>http://blog.cjhe.top/database/redis/distribute-lock.html</id>
    <link href="http://blog.cjhe.top/database/redis/distribute-lock.html"/>
    <updated>2024-05-29T08:27:34.000Z</updated>
    <summary type="text">分布式锁

分布式锁即在分布式环境下不同实例之间抢一把锁，相比较单一实例的锁，分布式环境下带来的问题更多，例如网络问题。
分布式锁可以通过多种途径实现，例如:Zookeeper等。由于Redis是经常使用的中间件，本篇内容基于Redis实现分布式锁。

特性：

互斥性：任意时刻，只有一个客户端能持有锁；
锁超时释放：持有锁超时，可以释放，防止不必要的...</summary>
    <content type="html"><![CDATA[<!-- more -->
<h2>分布式锁</h2>
<blockquote>
<p>分布式锁即在分布式环境下不同实例之间抢一把锁，相比较单一实例的锁，分布式环境下带来的问题更多，例如网络问题。
分布式锁可以通过多种途径实现，例如:Zookeeper等。由于Redis是经常使用的中间件，本篇内容基于Redis实现分布式锁。</p>
</blockquote>
<p>特性：</p>
<ul>
<li>互斥性：任意时刻，只有一个客户端能持有锁；</li>
<li>锁超时释放：持有锁超时，可以释放，防止不必要的资源浪费，也可以防止死锁；</li>
<li>可重入性：一个线程如果获取了锁之后，可以再次对其请求加锁；</li>
<li>高性能和高可用：加锁和解锁需要开销尽可能低，同时也要保证高可用，避免分布式锁失效；</li>
<li>安全性：锁只能被持有的客户端释放，不能被其他客户端释放</li>
</ul>
<h3>简单版本</h3>
<blockquote>
<p>锁的特性就是排他性，这里可以通过Redis的命令：<code>SETNX</code>，该命令：</p>
<ul>
<li>只在键key不存在的情况下，将键的值设置为value，返回1；</li>
<li>若键key已存在，则SETNX命令不做任何操作，返回0；</li>
</ul>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> redislock

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/go-redis/redis/v9"</span>
	<span class="token string">"github.com/google/uuid"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrObtainLockFail  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to obtain lock"</span><span class="token punctuation">)</span>
	ErrReleaseLockFail <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to release lock"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Lock <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
	key    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">ObtainLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">SetNX</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrObtainLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">newLock</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>client<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newLock</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Lock <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Lock<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
		key<span class="token punctuation">:</span>    key<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Lock<span class="token punctuation">)</span> <span class="token function">Release</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> res <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrReleaseLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是这里的释放其实是存在问题的：</p>
<ul>
<li>当redis存储的是别人的锁，直接删除key这就会导致删除别人的锁问题</li>
</ul>
<h3>解决锁释放问题</h3>
<blockquote>
<p>方法就是生产唯一的value，只有当前redis存储的value是自己的才可以删除</p>
<p>为了保证原子性，即查询redis的value和删除动作是一起进行操作，这里采用lua脚本去保证</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> redislock

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token boolean">_</span> <span class="token string">"embed"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/go-redis/redis/v9"</span>
	<span class="token string">"github.com/google/uuid"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrObtainLockFail  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to obtain lock"</span><span class="token punctuation">)</span>
	ErrReleaseLockFail <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to release lock"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	<span class="token comment">//go:embed release.lua</span>
	releaseLua <span class="token builtin">string</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> lock <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
	key    <span class="token builtin">string</span>
	value  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">ObtainLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">SetNX</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrObtainLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">newLock</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>client<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newLock</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>lock <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
		key<span class="token punctuation">:</span>    key<span class="token punctuation">,</span>
		value<span class="token punctuation">:</span>  value<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token function">Release</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> releaseLua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrReleaseLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrReleaseLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>release.lua脚本</p>
<div class="language-lua" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="token comment">-- 获得的value和期望的value是一致的说明是自己的锁</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div><h3>解决超时问题</h3>
<blockquote>
<p>极端场景下业务很可能执行超时，例如：分布式锁一分钟，但业务执行一小时，导致这一个小时之内，有60个业务拿到分布式锁，和我们期望1个业务执行不一致。</p>
<p>解决超时问题，那么我们可以通过续约的方式，不断延长分布式锁的有效期来解决业务超时问题，保证业务执行过程锁不会自动释放。</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token function">AutoRefresh</span><span class="token punctuation">(</span>interval<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> interval <span class="token operator">&gt;=</span> c<span class="token punctuation">.</span>expiration <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"interval should be less than expiration"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
			err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
			<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> context<span class="token punctuation">.</span>DeadlineExceeded <span class="token punctuation">{</span>
				<span class="token keyword">select</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
			ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
			err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
			<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> context<span class="token punctuation">.</span>DeadlineExceeded <span class="token punctuation">{</span>
				<span class="token keyword">select</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>c<span class="token punctuation">.</span>release<span class="token punctuation">:</span> <span class="token comment">//主动释放锁场景</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token function">Refresh</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> refreshLua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>value<span class="token punctuation">,</span> c<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrRefreshLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> res <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrRefreshLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>refresh.lua脚本</p>
<div class="language-lua" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="token comment">--续约分布式锁</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"pexpire"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">--返回1成功，返回0失败</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div><h3>解决无限续约问题</h3>
<blockquote>
<p>当续约遇见网络超时问题，总不能一直续约，须有合理的方式告知业务方错误</p>
<p>因此需增加策略去重试续约</p>
</blockquote>
<p>我们定义策略</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> redislock

<span class="token keyword">import</span> <span class="token string">"time"</span>

<span class="token keyword">type</span> RetryStrategy <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">//返回下一次是否需要重试以及重试间隔</span>
	<span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> limitedRetry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	interval time<span class="token punctuation">.</span>Duration
	max      <span class="token builtin">int64</span>
	cnt      <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>retry <span class="token operator">*</span>limitedRetry<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	retry<span class="token punctuation">.</span>cnt<span class="token operator">++</span>
	<span class="token keyword">return</span> retry<span class="token punctuation">.</span>cnt <span class="token operator">&lt;</span> retry<span class="token punctuation">.</span>max<span class="token punctuation">,</span> retry<span class="token punctuation">.</span>interval
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">LimitedRetry</span><span class="token punctuation">(</span>interval time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> max <span class="token builtin">int64</span><span class="token punctuation">)</span> RetryStrategy <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>limitedRetry<span class="token punctuation">{</span>interval<span class="token punctuation">:</span> interval<span class="token punctuation">,</span> max<span class="token punctuation">:</span> max<span class="token punctuation">,</span> cnt<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> noRetry <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>retry <span class="token operator">*</span>noRetry<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NoRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> RetryStrategy <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>noRetry<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用带策略的续约方式</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">TryLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> try RetryStrategy<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> ticker <span class="token operator">*</span>time<span class="token punctuation">.</span>Ticker
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ticker <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> lockLua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> context<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token string">"OK"</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">newLock</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>client<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		retry<span class="token punctuation">,</span> interval <span class="token operator">:=</span> try<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>retry <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrObtainLockFail
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> ticker <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			ticker <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>lock.lua脚本</p>
<div class="language-lua" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="token keyword">local</span> val <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">-- 在加锁的重试的时候，要判断自己上一次是不是加锁成功了</span>
<span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token keyword">false</span> <span class="token keyword">then</span> <span class="token comment">-- key 不存在</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'PX'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">-- px 毫秒</span>
<span class="token keyword">elseif</span> val <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>  <span class="token comment">-- 存在，刷新过期时间</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"OK"</span>
<span class="token keyword">else</span> <span class="token comment">-- 此时别人持有锁</span>
    <span class="token keyword">return</span> <span class="token string">""</span>
<span class="token keyword">end</span>
</code></pre></div><h3>进一步优化获取锁</h3>
<blockquote>
<p>当并发量很大场景时，为了减缓DB的压力，我们可以在单个实例上面，只允许一个协程获取分布式锁，即：单一实例先筛选一个协程，不同的实例再去竞争分布式锁</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
	s      singleflight<span class="token punctuation">.</span>Group
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">SingleFlightLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> try RetryStrategy<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		flag <span class="token operator">:=</span> <span class="token boolean">false</span>
		result <span class="token operator">:=</span> c<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">DoChan</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			flag <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">TryLock</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> expiration<span class="token punctuation">,</span> try<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>result<span class="token punctuation">:</span>
			<span class="token keyword">if</span> flag <span class="token punctuation">{</span>
				c<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
				<span class="token keyword">if</span> res<span class="token punctuation">.</span>Err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Err
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> res<span class="token punctuation">.</span>Val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content>
    <category term="数据存储"/>
    <published>2022-11-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">责任链</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/chain-of-responsibility.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/chain-of-responsibility.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/chain-of-responsibility/chain-of-responsibility-2x.png" alt="责任链" tabindex="0" loading="lazy"><figcaption>责任链</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/chain-of-responsibility/chain-of-responsibility-2x.png" alt="责任链" tabindex="0" loading="lazy"><figcaption>责任链</figcaption></figure>
<!-- more -->
<h2>什么是责任链模式</h2>
<p>责任链模式(Chain of Responsibility)：为了避免请求发送者与多个请求处理者耦合在一起，将所有请求的处理者通过前一对象记住其下一个对象的引用而连成一条链；当有请求发生时，可将请求沿着这条链传递，直到有对象处理它为止。</p>
<div class="language-ascii" data-ext="ascii" data-title="ascii"><pre class="language-ascii"><code>     ┌─────────┐
     │ Request │
     └─────────┘
          │
┌ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ┐
          ▼
│  ┌─────────────┐  │
   │ ProcessorA  │
│  └─────────────┘  │
          │
│         ▼         │
   ┌─────────────┐
│  │ ProcessorB  │  │
   └─────────────┘
│         │         │
          ▼
│  ┌─────────────┐  │
   │ ProcessorC  │
│  └─────────────┘  │
          │
└ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ┘
          │
          ▼
</code></pre></div><h3>包含哪些角色</h3>
<ul>
<li>
<p>Handler: 抽象处理者</p>
<p>包含一个处理请求的接口和一个设置后续处理者</p>
</li>
<li>
<p>Concrete Handler: 具体处理者</p>
<p>实现抽象处理者接口</p>
</li>
<li>
<p>Client: 客户端</p>
<p>创建处理链，并让链头开始执行处理</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> chainofresponsibility

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Handler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">SetNext</span><span class="token punctuation">(</span>Handler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteHandler1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next Handler
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler1<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete handler1"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler1<span class="token punctuation">)</span> <span class="token function">SetNext</span><span class="token punctuation">(</span>handler Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>next <span class="token operator">=</span> handler
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteHandler2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next Handler
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler2<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete handler2"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler2<span class="token punctuation">)</span> <span class="token function">SetNext</span><span class="token punctuation">(</span>handler Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>next <span class="token operator">=</span> handler
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> chainofresponsibility

<span class="token keyword">func</span> <span class="token function">ExampleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h1 <span class="token operator">:=</span> ConcreteHandler1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	h2 <span class="token operator">:=</span> ConcreteHandler2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	h1<span class="token punctuation">.</span><span class="token function">SetNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h2<span class="token punctuation">)</span>
	h1<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concrete handler1</span>
	<span class="token comment">// concrete handler2</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>使用场景</h3>
<ul>
<li>审批流程：经理、主管、Boss</li>
<li>医院流程：挂号处、医生、收银处、药房</li>
</ul>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>可以控制请求处理的顺序；</li>
<li>单一职责原则，具体的处理者只关心自己的业务；</li>
<li>开闭原则，可以不更改现有代码的情况下新增处理者；</li>
</ul>
<h3>缺点</h3>
<ul>
<li>各个处理者须有共同的处理函数</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2022-12-13T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">命令</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/command.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/command.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/command/command-zh-2x.png" alt="command" tabindex="0" loading="lazy"><figcaption>command</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/command/command-zh-2x.png" alt="command" tabindex="0" loading="lazy"><figcaption>command</figcaption></figure>
<!-- more -->
<h2>什么是行为型模式</h2>
<p>命令设计模式允许将请求封装成对象，从而将不同的请求发送者与接收者解耦。命令对象包含了请求的所有信息，包括调用的方法、参数和接收者等。这种方式使得请求的发送者与接收者无需知道彼此的存在，从而可以更灵活地进行交互。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>command</figcaption></figure>
<ul>
<li>
<p>Invoker: 调用者</p>
<p>创建和配置命命令对象，并将其传递给接收者</p>
</li>
<li>
<p>Command: 命令接口</p>
<p>定义命令的核心接口，通常包括一个执行方法</p>
</li>
<li>
<p>ConcreteCommand: 具体命令类</p>
<p>实现命令接口，并封装具体的操作。通常需要引用接收者，从而调用对应的方法</p>
</li>
<li>
<p>Receiver: 接收者</p>
<p>实现请求的实际操作，命令对象将请求传递给接收者，从而完成请求</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Command <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Receiver <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Receiver<span class="token punctuation">)</span> <span class="token function">operation1</span><span class="token punctuation">(</span>a <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"operation1:"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Receiver<span class="token punctuation">)</span> <span class="token function">operation2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"operation2:"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Invoker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	cmd Command
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Invoker<span class="token punctuation">)</span> <span class="token function">SetCommand</span><span class="token punctuation">(</span>cmd Command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>cmd <span class="token operator">=</span> cmd
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Invoker<span class="token punctuation">)</span> <span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreateCommand1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name     <span class="token builtin">string</span>
	receiver <span class="token operator">*</span>Receiver
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreateCommand1<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">operation1</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreateCommand2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name     <span class="token builtin">string</span>
	desc     <span class="token builtin">string</span>
	address  <span class="token builtin">string</span>
	receiver <span class="token operator">*</span>Receiver
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreateCommand2<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">operation2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>desc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">func</span> <span class="token function">ExampleCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">:=</span> Receiver<span class="token punctuation">{</span><span class="token punctuation">}</span>
	invoker <span class="token operator">:=</span> Invoker<span class="token punctuation">{</span><span class="token punctuation">}</span>

	cmd1 <span class="token operator">:=</span> ConcreateCommand1<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token operator">&amp;</span>receiver<span class="token punctuation">}</span>
	invoker<span class="token punctuation">.</span><span class="token function">SetCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd1<span class="token punctuation">)</span>
	invoker<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	cmd2 <span class="token operator">:=</span> ConcreateCommand2<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> desc<span class="token punctuation">:</span> <span class="token string">"描述"</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> <span class="token string">"地址"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token operator">&amp;</span>receiver<span class="token punctuation">}</span>
	invoker<span class="token punctuation">.</span><span class="token function">SetCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd2<span class="token punctuation">)</span>
	invoker<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Output:</span>
	<span class="token comment">// operation1: admin</span>
	<span class="token comment">// operation2: admin 描述 地址</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>适用场景</h2>
<ul>
<li>
<p>需要将请求和执行操作解耦的情况。命令模式可以将请求封装为对象并将其发送给接收者，从而使得发送者和接收者之间松耦合。</p>
</li>
<li>
<p>需要支持撤销或重做操作的情况。由于每个命令都封装了一组特定的操作，因此可以轻松进行撤销或重做。</p>
</li>
<li>
<p>需要支持事务操作的情况。将一组相关的命令组合在一起，可以实现事务操作，即一组操作要么全部成功执行，要么全部失败。</p>
</li>
<li>
<p>需要远程执行操作的情况。将命令对象序列化到网络上，可以实现远程执行操作的功能。</p>
</li>
<li>
<p>需要将命令队列中的请求延迟、调度或者执行的情况。可以将命令对象存储在队列中，然后按照特定的规则执行它们。</p>
</li>
<li>
<p>需要实现日志、审计或者事务记录的情况。可以在执行命令的同时，将其记录下来，并可以将其回放以重现历史操作。</p>
</li>
</ul>
<h3>请求与执行解耦</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">type</span> Commander <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AddCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AddCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> SubtractCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SubtractCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MultiplyCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiplyCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> DivideCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DivideCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Divide</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Origin <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	value <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">+=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Subtract</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">-=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Multiply</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">*=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Divide</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">/=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Computer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	commands <span class="token punctuation">[</span><span class="token punctuation">]</span>Commander
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">AddCommand</span><span class="token punctuation">(</span>command Commander<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>commands <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">ExecuteCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> command <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>commands <span class="token punctuation">{</span>
		command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>package command

import "fmt"

func ExampleComputer() {
	computer := Computer{}
	origin := Origin{10}
	addCmd := AddCommand{&amp;origin, 20}
	subCmd := SubtractCommand{&amp;origin, 15}
	mulCmd := MultiplyCommand{&amp;origin, 2}
	divCmd := DivideCommand{&amp;origin, 3}
	computer.AddCommand(&amp;addCmd)
	computer.AddCommand(&amp;subCmd)
	computer.AddCommand(&amp;mulCmd)
	computer.AddCommand(&amp;divCmd)
	computer.ExecuteCommands()
	fmt.Println(origin.value)
	// Output:
	// 10
}
</code></pre></div><p>我们将请求者Computer和接收者Origin，进行了解耦。请求者可以任意追加命令，执行：加、减、乘、除等运算。</p>
<h3>撤销操作</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">type</span> Commander <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AddCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AddCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AddCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> SubtractCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SubtractCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SubtractCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MultiplyCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiplyCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiplyCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Divide</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> DivideCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DivideCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Divide</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DivideCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Origin <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	value <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">+=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Subtract</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">-=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Multiply</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">*=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Divide</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">/=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Computer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	commands <span class="token punctuation">[</span><span class="token punctuation">]</span>Commander
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">AddCommand</span><span class="token punctuation">(</span>command Commander<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>commands <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">ExecuteCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> command <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>commands <span class="token punctuation">{</span>
		command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		cmd <span class="token operator">:=</span> i<span class="token punctuation">.</span>commands<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
		cmd<span class="token punctuation">.</span><span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		i<span class="token punctuation">.</span>commands <span class="token operator">=</span> i<span class="token punctuation">.</span>commands<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleComputerUndo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	computer <span class="token operator">:=</span> Computer<span class="token punctuation">{</span><span class="token punctuation">}</span>
	origin <span class="token operator">:=</span> Origin<span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span>
	addCmd <span class="token operator">:=</span> AddCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span>
	subCmd <span class="token operator">:=</span> SubtractCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">}</span>
	mulCmd <span class="token operator">:=</span> MultiplyCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
	divCmd <span class="token operator">:=</span> DivideCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>subCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mulCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>divCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">ExecuteCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 10</span>
	<span class="token comment">// 30</span>
  <span class="token comment">// 15</span>
	<span class="token comment">// 30</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们对Commonder接口增加Undo方法，即可以实现计算器的撤销操作。</p>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>命令模式可以降低代码的耦合度，并且将请求调用者与请求接收者进行解耦；</li>
<li>命令模式扩展性较高
<ul>
<li>如果是扩展新的命令，那么直接定义新的命令类即可；</li>
<li>如果是执行一组命令，那么</li>
</ul>
</li>
</ul>
<h3>缺点</h3>
<ul>
<li>可能会导致性能问题。使用命令模式可能会增加对象数量，并且每个命令都需要进行封装，可能会导致性能下降。</li>
<li>可能会使代码更加复杂。使用命令模式需要定义许多接口和类，可能会使代码过于复杂，难以维护。</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-04-26T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">迭代器</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/iterator.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/iterator.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/iterator/iterator-zh-2x.png" alt="iterator" tabindex="0" loading="lazy"><figcaption>iterator</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/iterator/iterator-zh-2x.png" alt="iterator" tabindex="0" loading="lazy"><figcaption>iterator</figcaption></figure>
<!-- more -->
<h2>什么是迭代器模式</h2>
<p>迭代器模式是一种行为设计模式，让你能在不暴露集合底层结构（列表、栈、树等）的情况下遍历集合中的所有元素。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>iterator</figcaption></figure>
<ul>
<li>
<p>Iterator: 迭代器接口</p>
<p>声明了遍历集合所需的操作</p>
</li>
<li>
<p>IterableCollection: 集合接口</p>
<p>声明一个方法或多个方法来获取与集合兼容的迭代器。</p>
</li>
<li>
<p>ConcreteIterator: 具体迭代器</p>
<p>实现遍历集合的一种特定算法，迭代器对象必须跟踪自身遍历进度。</p>
</li>
<li>
<p>ConcreteCollection: 具体集合</p>
<p>会在客户端请求迭代器时返回一个特定的具体迭代器类实体。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> iterator

<span class="token keyword">type</span> Aggregate <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Iterator
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Iterator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteIterator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	numbers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	next    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>ConcreteIterator<span class="token punctuation">)</span> <span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> i<span class="token punctuation">.</span>next <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>numbers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>ConcreteIterator<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> i<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		numer <span class="token operator">:=</span> i<span class="token punctuation">.</span>numbers<span class="token punctuation">[</span>i<span class="token punctuation">.</span>next<span class="token punctuation">]</span>
		i<span class="token punctuation">.</span>next <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token keyword">return</span> numer
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteAggregate <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Length <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>ConcreteAggregate<span class="token punctuation">)</span> <span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Iterator <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteIterator<span class="token punctuation">{</span>
		numbers<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">,</span>
		next<span class="token punctuation">:</span>    <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> iterator

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> aggregate Aggregate
	aggregate <span class="token operator">=</span> <span class="token operator">&amp;</span>ConcreteAggregate<span class="token punctuation">{</span>Length<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>
	iterator <span class="token operator">:=</span> aggregate<span class="token punctuation">.</span><span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> iterator<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 0</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// 3</span>
	<span class="token comment">// 4</span>
	<span class="token comment">// 5</span>
	<span class="token comment">// 6</span>
	<span class="token comment">// 7</span>
	<span class="token comment">// 8</span>
	<span class="token comment">// 9</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>访问一个聚合对象的内容而无须暴露它的内部表示。</li>
<li>遍历任务交由迭代器完成，这简化了聚合类。</li>
<li>它支持以不同方式遍历一个聚合，甚至可以自定义迭代器的子类以支持新的遍历。</li>
<li>增加新的聚合类和迭代器类都很方便，无须修改原有代码。</li>
<li>封装性良好，为遍历不同的聚合结构提供一个统一的接口。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>增加了类的个数，这在一定程度上增加了系统的复杂性。</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2022-12-12T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">中介者</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/mediator.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/mediator.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/mediator/mediator-2x.png" alt="mediator" tabindex="0" loading="lazy"><figcaption>mediator</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/mediator/mediator-2x.png" alt="mediator" tabindex="0" loading="lazy"><figcaption>mediator</figcaption></figure>
<!-- more -->
<h2>什么是中介者模式</h2>
<p>中介者模式(Mediator Pattern)又叫调停者模式，通过在中间引入中介对象来协调各个对象之间交互，使得对象之间不直接交互，而是通过中介者进行通信和协调，从而使得各个对象能够更加灵活地进行组合和拆分，增强系统的可维护性和扩展性。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>mediator</figcaption></figure>
<ul>
<li>
<p>Mediator：中介者</p>
<p>定义了中介者的接口，即通过该接口与其他组件交互</p>
</li>
<li>
<p>ConcreteMediator：具体中介者</p>
<p>实现了中介者的接口，维护其他组件之间的交互关系。</p>
</li>
<li>
<p>Colleague：同事</p>
<p>定义组件的接口，即通过该接口与中介者交互。</p>
</li>
<li>
<p>ConcreteColleague：具体同事</p>
<p>实现了组件的接口，维护自己与其他组件之间的交互关系。注意，同事之间不会直接交互，而是通过中介者来完成交互。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> mediator

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Mediator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Coordinate</span><span class="token punctuation">(</span>colleague Colleague<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Colleague <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">SendMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteColleague1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mediator Mediator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague1<span class="token punctuation">)</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague1 send message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>mediator<span class="token punctuation">.</span><span class="token function">Coordinate</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague1<span class="token punctuation">)</span> <span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague1 receive message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteColleague2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mediator Mediator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague2<span class="token punctuation">)</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague2 send message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>mediator<span class="token punctuation">.</span><span class="token function">Coordinate</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague2<span class="token punctuation">)</span> <span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague2 receive message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteMediator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ConcreteColleague1
	ConcreteColleague2
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteMediator<span class="token punctuation">)</span> <span class="token function">Coordinate</span><span class="token punctuation">(</span>colleague Colleague<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> colleague<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ConcreteColleague1<span class="token punctuation">:</span>
		c<span class="token punctuation">.</span>ConcreteColleague2<span class="token punctuation">.</span><span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ConcreteColleague2<span class="token punctuation">:</span>
		c<span class="token punctuation">.</span>ConcreteColleague1<span class="token punctuation">.</span><span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> mediator

<span class="token keyword">func</span> <span class="token function">ExampleMediator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mediator <span class="token operator">:=</span> ConcreteMediator<span class="token punctuation">{</span><span class="token punctuation">}</span>
	colleague1 <span class="token operator">:=</span> ConcreteColleague1<span class="token punctuation">{</span>mediator<span class="token punctuation">:</span> mediator<span class="token punctuation">}</span>
	colleague2 <span class="token operator">:=</span> ConcreteColleague2<span class="token punctuation">{</span>mediator<span class="token punctuation">:</span> mediator<span class="token punctuation">}</span>
	mediator<span class="token punctuation">.</span>ConcreteColleague1 <span class="token operator">=</span> colleague1
	mediator<span class="token punctuation">.</span>ConcreteColleague2 <span class="token operator">=</span> colleague2

	colleague1<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
	colleague2<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token string">"hi"</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// ConcreateColleague1 send message: hello</span>
	<span class="token comment">// ConcreateColleague2 receive message: hello</span>
	<span class="token comment">// ConcreateColleague2 send message: hi</span>
	<span class="token comment">// ConcreateColleague1 receive message: hi</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>
<p>降低系统复杂度：通过中介者对象，可以将系统中多个对象之间的直接交互关系转化为对中介者对象的请求调用，从而简化了系统的复杂度；</p>
</li>
<li>
<p>减低系统维护成本：通过减少对象之间的直接耦合度，提高了系统的灵活性和可维护性，降低了系统维护的成本；</p>
</li>
<li>
<p>提高系统扩展性：由于中介者对象独立负责对象之间的通信协调，因此增加、删除或修改一个对象都不会影响其他对象的交互关系，从而提高了系统的可扩展性。</p>
</li>
</ul>
<h3>缺点</h3>
<ul>
<li>
<p>中介者对象会引入系统的复杂度：虽然中介者对象可以简化系统的复杂度，但如果中介者对象本身过于复杂，可能会引入新的复杂度；</p>
</li>
<li>
<p>中介者对象可能成为系统的<strong>瓶颈</strong>：由于所有的交互都要经过中介者对象，当系统中对象数量较多或交互复杂时，中介者对象可能成为系统的瓶颈。</p>
</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-04-29T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">备忘录</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/memento.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/memento.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/memento/memento-zh-2x.png" alt="memento" tabindex="0" loading="lazy"><figcaption>memento</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/memento/memento-zh-2x.png" alt="memento" tabindex="0" loading="lazy"><figcaption>memento</figcaption></figure>
<!-- more -->
<h2>什么是备忘录模式</h2>
<p>备忘录模式(Memento Pattern)允许在不暴露对象实现细节的情况下保存和恢复对象之前的状态。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>memento</figcaption></figure>
<ul>
<li>
<p>Originator: 原发器</p>
<p>用于生成自身状态的快照，在需要时可以通过快照恢复自身状态</p>
</li>
<li>
<p>Memento: 备忘录</p>
<p>原发器状态快照，通常将备忘录设置为不可变的类，并且通过构造函数一次性传递数据</p>
</li>
<li>
<p>Caretaker: 负责人</p>
<p>存储备忘录的历史记录</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> memento

<span class="token keyword">type</span> Originator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewOriginator</span><span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Originator <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Originator<span class="token punctuation">{</span>state<span class="token punctuation">:</span> value<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Originator<span class="token punctuation">)</span> <span class="token function">ChangeState</span><span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	o<span class="token punctuation">.</span>state <span class="token operator">=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Originator<span class="token punctuation">)</span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Memento <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">NewMemento</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Originator<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>memento Memento<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	o<span class="token punctuation">.</span>state <span class="token operator">=</span> memento<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Memento <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMemento</span><span class="token punctuation">(</span>state <span class="token builtin">string</span><span class="token punctuation">)</span> Memento <span class="token punctuation">{</span>
	<span class="token keyword">return</span> Memento<span class="token punctuation">{</span>state<span class="token punctuation">:</span> state<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m Memento<span class="token punctuation">)</span> <span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>state
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Caretaker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	history <span class="token punctuation">[</span><span class="token punctuation">]</span>Memento
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Caretaker<span class="token punctuation">)</span> <span class="token function">AddMemento</span><span class="token punctuation">(</span>memento Memento<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>history<span class="token punctuation">,</span> memento<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Caretaker<span class="token punctuation">)</span> <span class="token function">GetMemento</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> Memento <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>history<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> memento

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	caretaker <span class="token operator">:=</span> Caretaker<span class="token punctuation">{</span>history<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Memento<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	originator <span class="token operator">:=</span> <span class="token function">NewOriginator</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span>
	caretaker<span class="token punctuation">.</span><span class="token function">AddMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	originator<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span>
	caretaker<span class="token punctuation">.</span><span class="token function">AddMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	originator<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span>
	caretaker<span class="token punctuation">.</span><span class="token function">AddMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	originator<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span>caretaker<span class="token punctuation">.</span><span class="token function">GetMemento</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// one</span>
	<span class="token comment">// two</span>
	<span class="token comment">// three</span>
	<span class="token comment">// two</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>可以在不破坏对象封装性的前提下捕获并存储对象的状态；</li>
<li>简化了对象在不同状态之间的切换过程，避免了大量的 if-else 语句；</li>
<li>原发器和负责人之间的解耦，原发器只需要知道如何创建备忘录和恢复备忘录即可，而负责人则负责保存备忘录。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>使用备忘录会占用一定的内存空间；</li>
<li>当原发器的状态改变很频繁时，备忘录对象的数量会很大，会占用较大的内存空间；</li>
<li>如果原发器需要保存的状态很多，那么备忘录对象的创建和恢复操作就会变得很慢。</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-05-01T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">观察者</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/observer.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/observer.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/observer/observer-2x.png" alt="observer" tabindex="0" loading="lazy"><figcaption>observer</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/observer/observer-2x.png" alt="observer" tabindex="0" loading="lazy"><figcaption>observer</figcaption></figure>
<!-- more -->
<h2>什么是观察者模式</h2>
<p>观察者模式(Observer Pattern)定义了对象之间的一对多依赖关系，当一个对象的状态发生变化时，所有依赖关系都会自动得到通知和更新。类似订阅机制，对象变化时通知多个<strong>观察</strong>该对象的其他对象。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>observer</figcaption></figure>
<ul>
<li>
<p>Observer: 观察者</p>
<p>声明了通知接口，在绝大数情况下，该接口仅包含一个<code>update</code>方法，该方法可以有多个参数</p>
</li>
<li>
<p>Subject: 主题</p>
<p>提供一个用于存储观察者对象的聚集类，该类通常包含<code>注册</code>和<code>取消注册</code>观察者的方法，以及通知所有观察者变化的方法。</p>
</li>
<li>
<p>ConcreteObserver: 具体的观察者</p>
<p>实现观察者接口定义的方法，根据自己的需要，实现对象变化时具体的行为。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> observer

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Id <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Observer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Update</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteObserver1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteObserver1<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete observer 1 update ctx:"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteObserver2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteObserver2<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete observer 2 update ctx:"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Subject <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ObserverCollection <span class="token punctuation">[</span><span class="token punctuation">]</span>Observer
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Subject<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>observer Observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>ObserverCollection <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">,</span> observer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Subject<span class="token punctuation">)</span> <span class="token function">UnRegister</span><span class="token punctuation">(</span>observer Observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> observer <span class="token punctuation">{</span>
			s<span class="token punctuation">.</span>ObserverCollection <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Subject<span class="token punctuation">)</span> <span class="token function">NotifyObservers</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> observer

<span class="token keyword">func</span> <span class="token function">ExampleObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> Context<span class="token punctuation">{</span><span class="token string">"test"</span><span class="token punctuation">}</span>
	co1 <span class="token operator">:=</span> ConcreteObserver1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	co2 <span class="token operator">:=</span> ConcreteObserver2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	subject <span class="token operator">:=</span> Subject<span class="token punctuation">{</span>
		ObserverCollection<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Observer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	subject<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>co1<span class="token punctuation">)</span>
	subject<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>co2<span class="token punctuation">)</span>
	subject<span class="token punctuation">.</span><span class="token function">NotifyObservers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span>Id <span class="token operator">=</span> <span class="token string">"other"</span>
	subject<span class="token punctuation">.</span><span class="token function">UnRegister</span><span class="token punctuation">(</span>co1<span class="token punctuation">)</span>
	subject<span class="token punctuation">.</span><span class="token function">NotifyObservers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concrete observer 1 update ctx: {test}</span>
	<span class="token comment">// concrete observer 2 update ctx: {test}</span>
	<span class="token comment">// concrete observer 2 update ctx: {other}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>松耦合：观察者模式使主题和观察者之间的依赖关系变得松散，让它们可以独立演化，这样就可以在不影响主题的情况下修改或扩展观察者。</li>
<li>可重用性：由于主题和观察者之间的关系被封装在抽象接口中，因此可以方便地添加新的观察者或主题，从而提高代码的可重用性和可维护性。</li>
<li>通知机制：一旦主题状态发生变化，观察者会自动被通知，并且可以及时更新自己的状态，从而保证了数据的一致性。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>性能问题：如果观察者过多，通知所有观察者会浪费很多资源，可能会导致系统运行缓慢。</li>
<li>难以理解：当涉及多个对象之间的交互时，观察者模式可能比较难以理解和调试</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-05-02T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">状态</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/state.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/state.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/state/state-zh-2x.png" alt="state" tabindex="0" loading="lazy"><figcaption>state</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/state/state-zh-2x.png" alt="state" tabindex="0" loading="lazy"><figcaption>state</figcaption></figure>
<!-- more -->
<h2>什么是状态模式</h2>
<p>状态模式(State Pattern) 允许对象在其内部状态发生变化时改变其行为。通过将状态转换代码从主逻辑中抽离并封装在状态对象中，使得对象能够在行为上进行更灵活的变化。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>state</figcaption></figure>
<ul>
<li>
<p>Context: 上下文</p>
<p>它是包含状态的主对象。它还包含一些用于在状态之间切换的方法。</p>
</li>
<li>
<p>State: 状态</p>
<p>它定义一个接口，用于封装与上下文的特定状态相关的行为。</p>
</li>
<li>
<p>ConcreteStates: 具体状态类</p>
<p>实现State接口，每个具体状态都提供各自的实现方式。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> state

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state State
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">ChangeState</span><span class="token punctuation">(</span>state State<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state <span class="token operator">=</span> state
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> State <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span>
	<span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span>
	<span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> StartState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StartState<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"already start"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StartState<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change start state to stop"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StopState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StartState<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change start state to run"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RunState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> StopState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StopState<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change stop state to start"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StartState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StopState<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"already stop"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StopState<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"can't change stop state to run"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RunState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RunState<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"can't change run state to start"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RunState<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change run state to stop"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StopState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RunState<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"already run"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> state

<span class="token keyword">func</span> <span class="token function">ExampleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	start <span class="token operator">:=</span> <span class="token operator">&amp;</span>StartState<span class="token punctuation">{</span><span class="token punctuation">}</span>
	context <span class="token operator">:=</span> Context<span class="token punctuation">{</span>state<span class="token punctuation">:</span> start<span class="token punctuation">}</span>
	context<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	context<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	context<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	context<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// already start</span>
	<span class="token comment">// change start state to run</span>
	<span class="token comment">// change run state to stop</span>
	<span class="token comment">// can't change stop state to run</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>将状态抽象成对象，使得状态之间的转换更加清晰明了。通过将每种状态封装成具体的类，可以使代码更加简单易懂，避免了状态转换时大量的条件判断。</li>
<li>状态之间的转换变得容易扩展。由于状态之间的转换是由状态对象自身完成的，因此只需要增加、修改或删除对应的状态类即可扩展或修改状态转换，而不影响其他部分。</li>
<li>提高代码的复用性和灵活性。由于每个状态都是一个独立的对象，因此可以在不同的上下文中重复使用。这样，就可以实现更多的组合方式，从而提高代码的复用性和灵活性。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>
<p>对于简单的状态机，引入状态模式会增加额外的复杂度。如果状态机只有几个状态，那么引入状态模式可能会让代码更加复杂，难以维护。</p>
</li>
<li>
<p>增加了系统的类和对象数量。引入状态模式会增加额外的类和对象，在一定程度上增加了系统的复杂度和开销。</p>
</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-05-04T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">策略</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/strategy.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/strategy.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/strategy/strategy-2x.png" alt="strategy" tabindex="0" loading="lazy"><figcaption>strategy</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/strategy/strategy-2x.png" alt="strategy" tabindex="0" loading="lazy"><figcaption>strategy</figcaption></figure>
<!-- more -->
<h2>什么是策略模式</h2>
<p>策略模式(Strategy Pattern)定义了算法族，分别封装起来，让他们之间可以互相替换，此模式让算法的变化独立于使用算法的客户。策略模式属于对象行为模式，它通过对算法进行封装，把使用算法的责任和算法的实现分割开来，并委派给不同的对象对这些算法进行管理。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>strategy</figcaption></figure>
<ul>
<li>
<p>Strategy: 策略接口</p>
<p>是所有具体策略的通用接口，它声明了一个上下文用于执行策略的方法</p>
</li>
<li>
<p>Concrete Strategies: 具体策略，实现了上下文所用算法的各种不同变体；</p>
</li>
<li>
<p>Context: 上下文，维护指向具体策略的引用，且仅通过策略接口与该对象进行交流；</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> strategy

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Strategy <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteStrategy1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s ConcreteStrategy1<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete strategy1 execute"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteStrategy2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s ConcreteStrategy2<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete strategy2 execute"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	strategy Strategy
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">SetStrategy</span><span class="token punctuation">(</span>strategy Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>strategy <span class="token operator">=</span> strategy
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"do something"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> strategy

<span class="token keyword">func</span> <span class="token function">ExampleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> Context<span class="token punctuation">{</span><span class="token punctuation">}</span>
	s1 <span class="token operator">:=</span> ConcreteStrategy1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">SetStrategy</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	s2 <span class="token operator">:=</span> ConcreteStrategy2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">SetStrategy</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// do something</span>
	<span class="token comment">// concrete strategy1 execute</span>
	<span class="token comment">// do something</span>
	<span class="token comment">// concrete strategy2 execute</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>可以在运行时切换对象内的算法。</li>
<li>可以将算法的实现和使用算法的代码隔离开来。</li>
<li>可以使用组合来代替继承。</li>
<li>开闭原则，无需对上下文进行修改就能够引入新的策略。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>如果你的算法极少发生改变， 那么没有任何理由引入新的类和接口。 使用该模式只会让程序过于复杂。</li>
<li>客户端必须知晓策略间的不同——它需要选择合适的策略。</li>
<li>许多现代编程语言支持函数类型功能， 允许你在一组匿名函数中实现不同版本的算法。 这样， 你使用这些函数的方式就和使用策略对象时完全相同， 无需借助额外的类和接口来保持代码简洁。</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2022-12-13T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">模版方法</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/template-method.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/template-method.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/template-method/template-method-2x.png" alt="template-method" tabindex="0" loading="lazy"><figcaption>template-method</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/template-method/template-method-2x.png" alt="template-method" tabindex="0" loading="lazy"><figcaption>template-method</figcaption></figure>
<!-- more -->
<h2>场景问题</h2>
<p>例如：假设开发一个文档的数据挖局程序，输入各种格式的文档（PDF、DOC、CSV、...），程序从这些文档中提取有意义的数据，进行处理和分析，并返回给用户。随着开发进行，实现三个类分别是：PDFDataMiner、DOCDataMiner、CSVDataMiner，它们都有相似的处理逻辑：打开文件、提取数据、转换数据、分析数据、发送报告。其中：分析数据和发送报告模块完全一致。
那么我们就可以使用模版方法模式将步骤进行抽象，并提供步骤的默认实现，支持重写。</p>
<h2>什么是模版方法模式</h2>
<p>模版方法模式（Template Method Pattern），将总结出来的规律沉淀为一种既定格式，并固化于模版中以供子类继承，对未确定下来的步骤方法进行抽象化，使其得以延续、多态化，最终架构起一个平台，使系统实现在不改变预设规则的前提下，对每个分步骤进行个性化定义的目的。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>template-method</figcaption></figure>
<ul>
<li>
<p>AbstractClass: 抽象类</p>
<p>负责给出一个算法的轮廓和骨架。它由一个模版方法和若干个基本方法构成</p>
</li>
<li>
<p>ConCreteClass: 具体实现类</p>
<p>复用抽象类的方法，或者重写相关方法。</p>
</li>
</ul>
<h3>代码示例</h3>
<p>由于Go语言没有抽象类这一概念，我们使用接口实现。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> templatemethod

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Templater <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Implement <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Abstract <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Implement
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newAbstract</span><span class="token punctuation">(</span>impl Implement<span class="token punctuation">)</span> <span class="token operator">*</span>Abstract <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Abstract<span class="token punctuation">{</span>Implement<span class="token punctuation">:</span> impl<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Abstract<span class="token punctuation">)</span> <span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span>Implement<span class="token punctuation">.</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>Implement<span class="token punctuation">.</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>Implement<span class="token punctuation">.</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Abstract<span class="token punctuation">)</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"default step2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Concreate1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>Abstract
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConcreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Templater <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Concreate1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> <span class="token function">newAbstract</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Abstract <span class="token operator">=</span> a
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate1<span class="token punctuation">)</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate1 step1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate1<span class="token punctuation">)</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate1 step2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate1<span class="token punctuation">)</span> <span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate1 step3"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Concreate2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>Abstract
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConcreate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Templater <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Concreate2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> <span class="token function">newAbstract</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Abstract <span class="token operator">=</span> a
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate2<span class="token punctuation">)</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate2 step1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate2<span class="token punctuation">)</span> <span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate2 step3"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> t Templater
	t <span class="token operator">=</span> <span class="token function">NewConcreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t <span class="token operator">=</span> <span class="token function">NewConcreate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concreate1 step1</span>
	<span class="token comment">// concreate1 step2</span>
	<span class="token comment">// concreate1 step3</span>
	<span class="token comment">// concreate2 step1</span>
	<span class="token comment">// default step2</span>
	<span class="token comment">// concreate2 step3</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中concreate2并未实现step2()，而是使用了默认的step2()</p>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>允许客户端重写一个大型算法中的特定部分，使得算法其他部分修改对其所造成的影响较小。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>部分客户端可能受到算法框架的限制</li>
<li>通过子类一直默认步骤实现可能会导致违反里氏替换原则</li>
<li>模版方法中的步骤越多，其维护工作就可能会越困难</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2022-12-11T00:00:00.000Z</published>
  </entry>
  <entry>
    <title type="text">访问者</title>
    <id>http://blog.cjhe.top/design-pattern/behavioral/visitor.html</id>
    <link href="http://blog.cjhe.top/design-pattern/behavioral/visitor.html"/>
    <updated>2023-07-31T14:52:38.000Z</updated>
    <summary type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/visitor/visitor-2x.png" alt="visitor" tabindex="0" loading="lazy"><figcaption>visitor</figcaption></figure>
]]></summary>
    <content type="html"><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/visitor/visitor-2x.png" alt="visitor" tabindex="0" loading="lazy"><figcaption>visitor</figcaption></figure>
<!-- more -->
<h2>什么是访问者模式</h2>
<p>访问者模式(Visitor Pattern)将算法与对象结构分离开来，并在结构中增加可操作元素的能力。其主要思想是在不改变已有类的前提下，通过增加访问者类，来给已有类增加新的操作方法。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>visitor</figcaption></figure>
<ul>
<li>
<p>Visitor: 访问者</p>
<p>声明了一些列以对象结构的具体元素为参数的访问者方法</p>
</li>
<li>
<p>ConCreteVistors: 具体访问者</p>
<p>不同的具体访问者实现访问元素对象各不相同</p>
</li>
<li>
<p>Element: 元素</p>
<p>声明了一个方法来接收访问者</p>
</li>
<li>
<p>ConcreteElement: 具体元素</p>
<p>具体元素实现接收方法，该方法根据当前访问者类调用相应访问者方法。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Visitor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">VisitConcreteElementA</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementA<span class="token punctuation">)</span>
	<span class="token function">VisitConcreteElementB</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementB<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteVisitor <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteVisitor<span class="token punctuation">)</span> <span class="token function">VisitConcreteElementA</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visit ConcreteElementA"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteVisitor<span class="token punctuation">)</span> <span class="token function">VisitConcreteElementB</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visit ConcreteElementB"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Element <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Accept</span><span class="token punctuation">(</span>visitor Visitor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteElementA <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteElementA<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor Visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitConcreteElementA</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteElementB <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteElementB<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor Visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitConcreteElementB</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">func</span> <span class="token function">ExampleVisitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConcreteVisitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
	elementA <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConcreteElementA<span class="token punctuation">{</span><span class="token punctuation">}</span>
	elementB <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConcreteElementB<span class="token punctuation">{</span><span class="token punctuation">}</span>
	elementA<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span>
	elementB<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Visit ConcreteElementA</span>
	<span class="token comment">// Visit ConcreteElementB</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>应用场景</h2>
<ul>
<li>当对象结构比较稳定，但需要经常定义新的操作时，访问者模式可以使用。</li>
<li>当一组对象中，需要执行不同的、复杂的操作时，可以使用访问者模式来封装这些操作，以简化代码逻辑。</li>
</ul>
<h3>在不修改已有代码的情况下，向已有类层次结构增加新的行为</h3>
<p>假如当前已有三种稳定图形类：正方形、圆形、三角形。当前需求是获取这三种图形的面积和周长，且未来可能有其他的行为操作。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">import</span> <span class="token string">"math"</span>

<span class="token keyword">type</span> Shape <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CalculateVisitor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">VisitSquare</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span>
	<span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span>
	<span class="token function">VisitCircle</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正方形</span>
<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	SideLength <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitSquare</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 长方形</span>
<span class="token keyword">type</span> Rectangle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Width  <span class="token builtin">float64</span>
	Height <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 圆形</span>
<span class="token keyword">type</span> Circle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Radius <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitCircle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 面积访问者</span>
<span class="token keyword">type</span> AreaVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Area <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>av <span class="token operator">*</span>AreaVisitor<span class="token punctuation">)</span> <span class="token function">VisitSquare</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	av<span class="token punctuation">.</span>Area <span class="token operator">=</span> s<span class="token punctuation">.</span>SideLength <span class="token operator">*</span> s<span class="token punctuation">.</span>SideLength
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>av <span class="token operator">*</span>AreaVisitor<span class="token punctuation">)</span> <span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	av<span class="token punctuation">.</span>Area <span class="token operator">=</span> r<span class="token punctuation">.</span>Width <span class="token operator">*</span> r<span class="token punctuation">.</span>Height
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>av <span class="token operator">*</span>AreaVisitor<span class="token punctuation">)</span> <span class="token function">VisitCircle</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	av<span class="token punctuation">.</span>Area <span class="token operator">=</span> math<span class="token punctuation">.</span>Pi <span class="token operator">*</span> c<span class="token punctuation">.</span>Radius <span class="token operator">*</span> c<span class="token punctuation">.</span>Radius
<span class="token punctuation">}</span>

<span class="token comment">// 周长访问者</span>
<span class="token keyword">type</span> PerimeterVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Perimeter <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pv <span class="token operator">*</span>PerimeterVisitor<span class="token punctuation">)</span> <span class="token function">VisitSquare</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pv<span class="token punctuation">.</span>Perimeter <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> s<span class="token punctuation">.</span>SideLength
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pv <span class="token operator">*</span>PerimeterVisitor<span class="token punctuation">)</span> <span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pv<span class="token punctuation">.</span>Perimeter <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>Width <span class="token operator">+</span> r<span class="token punctuation">.</span>Height<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pv <span class="token operator">*</span>PerimeterVisitor<span class="token punctuation">)</span> <span class="token function">VisitCircle</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pv<span class="token punctuation">.</span>Perimeter <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>Pi <span class="token operator">*</span> c<span class="token punctuation">.</span>Radius
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	square <span class="token operator">:=</span> <span class="token operator">&amp;</span>Square<span class="token punctuation">{</span>SideLength<span class="token punctuation">:</span> <span class="token number">4.0</span><span class="token punctuation">}</span>
	rectangle <span class="token operator">:=</span> <span class="token operator">&amp;</span>Rectangle<span class="token punctuation">{</span>Width<span class="token punctuation">:</span> <span class="token number">3.0</span><span class="token punctuation">,</span> Height<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">}</span>
	circle <span class="token operator">:=</span> <span class="token operator">&amp;</span>Circle<span class="token punctuation">{</span>Radius<span class="token punctuation">:</span> <span class="token number">2.0</span><span class="token punctuation">}</span>

	areaVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>AreaVisitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
	square<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>areaVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"square area:"</span><span class="token punctuation">,</span> areaVisitor<span class="token punctuation">.</span>Area<span class="token punctuation">)</span>
	rectangle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>areaVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rectangle area:"</span><span class="token punctuation">,</span> areaVisitor<span class="token punctuation">.</span>Area<span class="token punctuation">)</span>
	circle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>areaVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"circle area:"</span><span class="token punctuation">,</span> areaVisitor<span class="token punctuation">.</span>Area<span class="token punctuation">)</span>

	perimeterVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>PerimeterVisitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
	square<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>perimeterVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"square perimeter:"</span><span class="token punctuation">,</span> perimeterVisitor<span class="token punctuation">.</span>Perimeter<span class="token punctuation">)</span>
	rectangle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>perimeterVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rectangle perimeter:"</span><span class="token punctuation">,</span> perimeterVisitor<span class="token punctuation">.</span>Perimeter<span class="token punctuation">)</span>
	circle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>perimeterVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"circle perimeter:"</span><span class="token punctuation">,</span> perimeterVisitor<span class="token punctuation">.</span>Perimeter<span class="token punctuation">)</span>

	<span class="token comment">// Output:</span>
	<span class="token comment">// square area: 16</span>
	<span class="token comment">// rectangle area: 15</span>
	<span class="token comment">// circle area: 12.566370614359172</span>
	<span class="token comment">// square perimeter: 16</span>
	<span class="token comment">// rectangle perimeter: 16</span>
	<span class="token comment">// circle perimeter: 12.566370614359172</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里只需要实现面积访问者类和周长访问者类就可以不用动三个图形类。</p>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>增加新的操作时不需要改变现有的对象结构，只需要增加新的访问者即可。</li>
<li>结构和操作分离，符合<strong>单一职责原则</strong>和<strong>开闭原则</strong>，降低了系统的耦合度。</li>
<li>把数据结构和操作分离，可以使得代码更容易理解和维护。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>增加新的元素时比较困难，需要修改抽象访问者的接口以及所有的具体访问者的实现。</li>
<li>访问者模式将对象本身和操作分离开来，导致增加新的操作不够方便。</li>
</ul>
]]></content>
    <category term="设计模式"/>
    <published>2023-05-05T00:00:00.000Z</published>
  </entry>
</feed>