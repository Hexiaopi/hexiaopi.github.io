import{_ as i}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as c,c as l,b as u,e as n,f as s,d as a,a as t}from"./app-ac29efd4.js";const r="/assets/map-e4288780.png",d="/assets/map-memory-b4c2e1b6.png",k="/assets/map-expand-dead280d.png",m={},v=n("figure",null,[n("img",{src:"http://cdn.cjhe.top/blog/map.png",alt:"map",tabindex:"0",loading:"lazy"}),n("figcaption",null,"map")],-1),b=t(`<blockquote><p>mapæ˜¯Goè¯­è¨€æä¾›çš„ä¸€ç§æŠ½è±¡æ•°æ®ç±»å‹ï¼Œå®ƒè¡¨ç¤ºä¸€ç»„æ— åºçš„é”®å€¼å¯¹(key-value)</p></blockquote><h2 id="å£°æ˜" tabindex="-1"><a class="header-anchor" href="#å£°æ˜" aria-hidden="true">#</a> å£°æ˜</h2><p><strong>å…³é”®å­—å®šä¹‰</strong>ï¼š<code>map</code></p><p><strong>é›¶å€¼</strong>ï¼š<code>nil</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">æ³¨æ„</p><p>mapå¯¹äº<code>value</code>çš„ç±»å‹æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯å¯¹<code>key</code>çš„ç±»å‹æœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼š<strong>keyçš„ç±»å‹å¿…é¡»æ”¯æŒ&quot;==&quot;å’Œ&quot;!=&quot;ä¸¤ä¸ªæ“ä½œç¬¦çš„æ•°æ®ç±»å‹</strong>ï¼Œå› æ­¤ï¼šå‡½æ•°ã€mapã€åˆ‡ç‰‡ä¸èƒ½ä½œä¸ºkeyç±»å‹ã€‚</p></div>`,6),h={class:"hint-container warning"},g=n("p",{class:"hint-container-title"},"æ³¨æ„",-1),f=n("code",null,"nil",-1),y=n("code",null,"panic",-1),w=t(`<h2 id="åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–" aria-hidden="true">#</a> åˆå§‹åŒ–</h2><ul><li><p>å­—é¢é‡åˆå§‹åŒ–</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>m<span class="token operator">:=</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;banana&quot;</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å†…ç½®å‡½æ•°make()åˆå§‹åŒ–</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>m<span class="token operator">:=</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h2 id="æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#æ“ä½œ" aria-hidden="true">#</a> æ“ä½œ</h2><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>       <span class="token comment">//æ–°å¢</span>
	m<span class="token punctuation">[</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>       <span class="token comment">//ä¿®æ”¹</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">&quot;apple&quot;</span><span class="token punctuation">)</span>   <span class="token comment">//åˆ é™¤</span>
	v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token string">&quot;banana&quot;</span><span class="token punctuation">]</span> <span class="token comment">//comma ok æŸ¥è¯¢</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//è·å–keyçš„ä¸ªæ•°</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span> <span class="token comment">//éå†m</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ‘€</p><ul><li>åˆ é™¤ä¸å­˜åœ¨çš„keyä¸ä¼šå¯¼è‡´panicï¼›</li><li>æŸ¥è¯¢ä¸å­˜åœ¨çš„keyï¼Œå¦‚æœæœªä½¿ç”¨<strong>comma ok</strong>è¯­æ³•ï¼Œåˆ™ä¼šè¿”å›valueç±»å‹å¯¹åº”çš„é›¶å€¼</li></ul><h2 id="åº•å±‚åŸç†" tabindex="-1"><a class="header-anchor" href="#åº•å±‚åŸç†" aria-hidden="true">#</a> åº•å±‚åŸç†</h2><p>å‚è§<code>$GOROOT/src/runtime/map.go</code></p><h3 id="mapçš„æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#mapçš„æ•°æ®ç»“æ„" aria-hidden="true">#</a> mapçš„æ•°æ®ç»“æ„</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	count      <span class="token builtin">int</span>            <span class="token comment">//å½“å‰ä¿å­˜çš„å…ƒç´ ä¸ªæ•°</span>
	flags      <span class="token builtin">uint8</span>          <span class="token comment">//å½“å‰mapæ‰€å¤„çš„çŠ¶æ€æ ‡å¿—</span>
	B          <span class="token builtin">uint8</span>          <span class="token comment">//bucketæ•°ç»„çš„å¤§å°çš„å¯¹æ•°ï¼š2^B=bucketæ•°é‡</span>
	noverflow  <span class="token builtin">uint16</span>         <span class="token comment">//overflow bucketsçš„å¤§çº¦æ•°é‡</span>
	hash0      <span class="token builtin">uint32</span>         <span class="token comment">//hashå‡½æ•°çš„ç§å­å€¼</span>
	buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">//æŒ‡å‘bucketæ•°ç»„çš„æŒ‡é’ˆ</span>
	oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">//åœ¨mapæ‰©å®¹é˜¶æ®µæŒ‡å‘å‰ä¸€ä¸ªbucketæ•°ç»„çš„æŒ‡é’ˆ</span>
	nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">//mapæ‰©å®¹é˜¶æ®µå……å½“æ‰©å®¹è¿›åº¦è®¡æ•°å™¨,å°äºæ­¤bucketéƒ½å·²å®Œæˆäº†æ•°æ®æ’ç©ºå’Œè¿ç§»æ“ä½œ</span>
	extra      <span class="token operator">*</span>mapextra      <span class="token comment">//å¯é€‰å­—æ®µï¼Œä¸gcç›¸å…³</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="bucketçš„æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#bucketçš„æ•°æ®ç»“æ„" aria-hidden="true">#</a> bucketçš„æ•°æ®ç»“æ„</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// a bucket for a Go map</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>

<span class="token comment">// å®é™…ä¸Šç¼–è¾‘æœŸé—´ä¼šåŠ¨æ€ç”Ÿäº§ä¸€ä¸ªæ–°çš„ç»“æ„ä½“</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash  <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
	keys     <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>keytype
	values   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>valuetype
	overflow <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+r+'" alt="map" tabindex="0" loading="lazy"><figcaption>map</figcaption></figure><p>keyå’Œvalueåˆ†å¼€å­˜å‚¨ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜å¯¹é½å¸¦æ¥çš„å†…å­˜æµªè´¹ï¼Œä»¥map[int8]int64ä¸ºä¾‹ï¼š</p><figure><img src="'+d+'" alt="map-memory" tabindex="0" loading="lazy"><figcaption>map-memory</figcaption></figure><p>æ¯ä¸ªbucketå¯ä»¥å­˜å‚¨8ä¸ªé”®å€¼å¯¹ï¼Œè¶…è¿‡å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„bucketï¼Œé€šè¿‡overflowé“¾æ¥</p><p>å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«<code>Hash</code>åˆ°äº†åŒä¸€ä¸ªbucketæ—¶ï¼Œæˆ‘ä»¬ç§°è¿™äº›é”®å‘ç”Ÿäº†å†²çªï¼ŒGoè¯­è¨€ä½¿ç”¨é“¾è¡¨è§£å†³é”®å†²çªã€‚</p><p>hashå†²çªå¹¶ä¸æ˜¯å¥½äº‹æƒ…ï¼Œå®ƒé™ä½äº†å­˜å–æ•ˆç‡ï¼Œå¥½çš„Hashç®—æ³•å¯ä»¥ä¿è¯Hashå€¼å¾—éšæœºæ€§ï¼Œä½†æ— è®ºä½¿ç”¨å“ªç§Hashç®—æ³•ï¼Œå†²çªç»ˆç©¶ä¸å¯é¿å…ï¼Œå½“å†²çªè¾ƒå¤šçš„æ—¶å€™å°±éœ€è¦é‡‡å–ä¸€äº›æªæ–½æ¥å‡å°‘å†²çªã€‚</p><h3 id="è´Ÿè½½å› å­loadfactor" tabindex="-1"><a class="header-anchor" href="#è´Ÿè½½å› å­loadfactor" aria-hidden="true">#</a> è´Ÿè½½å› å­LoadFactor</h3><blockquote><p>è´Ÿè½½å› å­ç”¨äºè¡¡é‡ä¸€ä¸ªHashè¡¨çš„å†²çªæƒ…å†µï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><p>è´Ÿè½½å› å­ = é”®æ•°é‡ / bucketæ•°é‡</p></blockquote><ul><li>è´Ÿè½½å› å­è¿‡å°ï¼Œç©ºé—´åˆ©ç”¨ç‡ä½ï¼›</li><li>è´Ÿè½½å› å­è¿‡å¤§ï¼Œè¯´æ˜å†²çªä¸¥é‡ï¼Œå­˜å–æ•ˆç‡ä½ï¼›</li></ul><p>å½“Hashè¡¨çš„è´Ÿè½½å› å­è¿‡å¤§æ—¶éœ€è¦rehashï¼Œå³ç”³è¯·æ›´å¤šçš„bucketï¼Œå¹¶å¯¹æ‰€æœ‰çš„é”®å€¼å¯¹é‡æ–°ç»„ç»‡ï¼Œä½¿å…¶å‡åŒ€çš„åˆ†å¸ƒåœ¨è¿™äº›bucketä¸­ã€‚</p><ul><li>redisçš„è´Ÿè½½å› å­å¤§äº1æ—¶å°±ä¼šè§¦å‘rehashï¼Œå› ä¸ºredisçš„æ¯ä¸ªbucketåªèƒ½å­˜1ä¸ªé”®å€¼å¯¹ï¼›</li><li>goçš„è´Ÿè½½å› å­å¤§äº6.5æ—¶æ‰ä¼šè§¦å‘rehashï¼Œå› ä¸ºgoçš„æ¯ä¸ªbucketå¯ä»¥å­˜8ä¸ªé”®å€¼å¯¹ï¼›</li></ul><h3 id="æ‰©å®¹" tabindex="-1"><a class="header-anchor" href="#æ‰©å®¹" aria-hidden="true">#</a> æ‰©å®¹</h3><p>æ¡ä»¶ï¼š</p><ul><li>è´Ÿè½½å› å­å¤§äº6.5æ—¶</li><li>overflowçš„æ•°é‡å¤§äº2^15=32768</li></ul>',26),x=n("br",null,null,-1),_={href:"https://eddycjy.com/posts/go/map-reset/",target:"_blank",rel:"noopener noreferrer"},q=t('<h4 id="å¢é‡æ‰©å®¹" tabindex="-1"><a class="header-anchor" href="#å¢é‡æ‰©å®¹" aria-hidden="true">#</a> å¢é‡æ‰©å®¹</h4><blockquote><p>é€šè¿‡å°†bucketæ•°ç»„æ‰©å¤§ä¸€å€å®ç°ï¼Œå¹¶æ¬è¿é”®å€¼å¯¹</p></blockquote><ol><li>oldbucketsæŒ‡å‘ç°æœ‰bucketæ•°ç»„ï¼›</li><li>åˆ›å»ºä¸€ä¸ªä¸¤å€ç°æœ‰è§„æ¨¡çš„bucketæ•°ç»„ï¼›</li><li>bucketsæŒ‡å‘æ–°çš„bucketæ•°ç»„ï¼›</li><li>å°†oldbucketsçš„é”®å€¼å¯¹æ¬è¿åˆ°æ–°çš„bucketæ•°ç»„ï¼›</li><li>é‡Šæ”¾oldbucketsï¼›</li></ol><figure><img src="'+k+`" alt="map-expand" tabindex="0" loading="lazy"><figcaption>map-expand</figcaption></figure><h4 id="ç­‰é‡æ‰©å®¹" tabindex="-1"><a class="header-anchor" href="#ç­‰é‡æ‰©å®¹" aria-hidden="true">#</a> ç­‰é‡æ‰©å®¹</h4><blockquote><p>ç”¨äºè§£å†³ä¸€ä¸ªbucketé“¾æ¥å¾ˆå¤šbucketï¼Œoverflowæ•°é‡è¿‡é«˜</p><p>bucketæ•°ç»„å¤§å°ä¸å˜ï¼Œé‡æ–°æ’åˆ—é”®å€¼å¯¹ï¼Œåˆ†æ•£åˆ°ä¸åŒçš„bucketæ•°ç»„ä¸­</p><p>è¿™æ ·å°±æé«˜äº†è®¿é—®æ•ˆç‡</p></blockquote><h3 id="å¢åˆ æ”¹æŸ¥" tabindex="-1"><a class="header-anchor" href="#å¢åˆ æ”¹æŸ¥" aria-hidden="true">#</a> å¢åˆ æ”¹æŸ¥</h3><h4 id="æŸ¥æ‰¾è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾è¿‡ç¨‹" aria-hidden="true">#</a> æŸ¥æ‰¾è¿‡ç¨‹</h4><ul><li>æ ¹æ®keyè®¡ç®—hashå€¼ï¼›</li><li>å–hashå€¼ä½ä½ä¸hmap.Bå–æ¨¡æ¥ç¡®å®šbucketçš„ä½ç½®ï¼›</li><li>å–hashå€¼é«˜ä½ï¼Œåœ¨tophashæ•°ç»„ä¸­æŸ¥è¯¢ï¼›</li><li>å¦‚æœtophash[i]ä¸­å­˜å‚¨çš„hashå€¼ä¸å½“å‰keyçš„hashå€¼ç›¸ç­‰ï¼Œåˆ™è·å–tophash[i]çš„keyå€¼è¿›è¡Œæ¯”è¾ƒï¼›</li><li>å½“å‰bucketæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¾æ¬¡ä»æº¢å‡ºçš„bucketä¸­æŸ¥æ‰¾ï¼›</li></ul><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>å¦‚æœå½“å‰mapå¤„äºæ¬è¿è¿‡ç¨‹ä¸­ï¼Œé‚£ä¹ˆæŸ¥æ‰¾æ—¶ä»oldbucketsæ•°ç»„ä¸­æŸ¥æ‰¾ï¼Œä¸å†ä»æ–°çš„bucketsæ•°ç»„ä¸­æŸ¥æ‰¾</p></div><h4 id="æ·»åŠ è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ è¿‡ç¨‹" aria-hidden="true">#</a> æ·»åŠ è¿‡ç¨‹</h4><ul><li>æ ¹æ®keyè®¡ç®—hashå€¼ï¼›</li><li>å–hashå€¼ä½ä½ä¸hmap.Bå–æ¨¡æ¥ç¡®å®šbucketçš„ä½ç½®ï¼›</li><li>æŸ¥æ‰¾è¯¥keyæ˜¯å¦å­˜åœ¨ <ul><li>å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥æ›´æ–°ï¼›</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä»è¯¥bucketä¸­å¯»æ‰¾ç©ºä½™ä½ç½®å¹¶æ’å…¥ï¼›</li></ul></li></ul><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>å¦‚æœå½“å‰mapå¤„äºæ¬è¿è¿‡ç¨‹ä¸­ï¼Œé‚£ä¹ˆç›´æ¥æ·»åŠ åˆ°æ–°çš„bucketsæ•°ç»„ä¸­</p></div><h4 id="åˆ é™¤è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#åˆ é™¤è¿‡ç¨‹" aria-hidden="true">#</a> åˆ é™¤è¿‡ç¨‹</h4><ul><li>æŸ¥æ‰¾keyæ˜¯å¦å­˜åœ¨ <ul><li>å­˜åœ¨ï¼Œåˆ™åˆ é™¤ï¼›</li><li>ä¸å­˜åœ¨ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼›</li></ul></li></ul><h2 id="mapæ³¨æ„äº‹é¡¹" tabindex="-1"><a class="header-anchor" href="#mapæ³¨æ„äº‹é¡¹" aria-hidden="true">#</a> mapæ³¨æ„äº‹é¡¹</h2><h3 id="éå¹¶å‘è¯»å†™å®‰å…¨çš„" tabindex="-1"><a class="header-anchor" href="#éå¹¶å‘è¯»å†™å®‰å…¨çš„" aria-hidden="true">#</a> éå¹¶å‘è¯»å†™å®‰å…¨çš„</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">doIteration</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;[%d, %d] &quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">doWrite</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
		m<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span>
		<span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
		<span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
		<span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token function">doIteration</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token function">doWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡ŒæŠ¥é”™ï¼š<code>fatal error: concurrent map iteration and map write</code></p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>Go åœ¨ map çš„å®ç°ä¸­å¢åŠ äº†è¯»å†™æ£€æŸ¥æœºåˆ¶ï¼Œä¸€æ—¦å‘ç°è¯»å†™å†²çªç«‹å³è§¦å‘ panic</p><p>å¦‚æœæƒ³ä½¿ç”¨å¹¶å‘çš„mapï¼š</p><ul><li>å¯ä»¥ä½¿ç”¨Go 1.9ç‰ˆæœ¬ä¸­å¼•å…¥æ”¯æŒå¹¶å‘å†™å®‰å…¨çš„<code>sync.Map</code>ç±»å‹ï¼›</li><li>å¯ä»¥ä½¿ç”¨mapæ—¶å¢åŠ é”ï¼›</li></ul></div><h3 id="æ— æ³•é€šè¿‡ç´¢å¼•ç›´æ¥è·å–valueçš„åœ°å€" tabindex="-1"><a class="header-anchor" href="#æ— æ³•é€šè¿‡ç´¢å¼•ç›´æ¥è·å–valueçš„åœ°å€" aria-hidden="true">#</a> æ— æ³•é€šè¿‡ç´¢å¼•ç›´æ¥è·å–valueçš„åœ°å€</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> Num <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>Num<span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Num<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
	value <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">//invalid operation: cannot take address of m[0] (map index expression of type Num)</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>è¿™æ˜¯ç”±äºmapä¼šæ‰©å®¹ï¼Œmapä¸­çš„æ•°æ®å…ƒç´ çš„valueåœ°å€å¯èƒ½åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤è·å–è¿™ä¸ªåœ°å€æ²¡æœ‰æ„ä¹‰ï¼ŒGoè¯­è¨€ä¸ºäº†é˜²æ­¢å‡ºç°è¯¥é—®é¢˜ï¼Œåœ¨ç¼–è¯‘æœŸé—´å°±æ£€æµ‹æ˜¯å¦æœ‰è·å–åœ°å€è¡Œä¸ºï¼Œé¿å…å‡ºç°é—®é¢˜ã€‚</p></div><h3 id="å°½é‡ä½¿ç”¨capå‚æ•°åˆå§‹åŒ–map" tabindex="-1"><a class="header-anchor" href="#å°½é‡ä½¿ç”¨capå‚æ•°åˆå§‹åŒ–map" aria-hidden="true">#</a> å°½é‡ä½¿ç”¨capå‚æ•°åˆå§‹åŒ–map</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;testing&quot;</span>

<span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkMapInitWithoutCap</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkMapInitWithCap</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go test -benchmem -bench=. cap_benchmark_test.go           
goos: darwin
goarch: amd64
cpu: Intel(R) Core(TM) i5-8259U CPU @ 2.30GHz
BenchmarkMapInitWithoutCap-8        1226           1338887 ns/op          687175 B/op        276 allocs/op
BenchmarkMapInitWithCap-8           2534            425859 ns/op          322225 B/op         11 allocs/op
PASS
ok      command-line-arguments  5.939s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,27);function B(N,P){const e=p("Badge"),o=p("ExternalLinkIcon");return c(),l("div",null,[v,u(" more "),b,n("div",h,[g,n("p",null,[s("å‘"),f,s("ï¼ˆæœªåˆå§‹åŒ–ï¼‰çš„mapç±»å‹é‡Œæ·»åŠ æ•°æ®ä¼šå¯¼è‡´"),y,a(e,{text:"æ³¨æ„",type:"warning"})])]),w,n("p",null,[s("mapçš„æ‰©ç¼©å®¹çš„ä¸»è¦åŒºåˆ«åœ¨äºhmap.Bçš„å®¹é‡å¤§å°æ”¹å˜ï¼Œè€Œç¼©å®¹ç”±äºhmap.Bå‹æ ¹ä¸å˜ï¼Œå†…å­˜å ç”¨ä¾ç„¶å­˜åœ¨ã€‚è¿™å°±å¯¼è‡´åœ¨åˆ é™¤å…ƒç´ æ—¶ï¼Œå¹¶ä¸ä¼šé‡Šæ”¾å†…å­˜ï¼Œä½¿å¾—åˆ†é…çš„æ€»å†…å­˜ä¸æ–­å¢åŠ ï¼Œå¦‚æœä¸æ³¨æ„ï¼Œå†…å­˜å°±å¾ˆå®¹æ˜“çˆ†äº†ã€‚"),a(e,{text:"æ³¨æ„",type:"warning"}),x,n("a",_,[s("Go map å¦‚ä½•ç¼©å®¹ï¼Ÿ"),a(o)])]),q])}const G=i(m,[["render",B],["__file","map.html.vue"]]);export{G as default};
