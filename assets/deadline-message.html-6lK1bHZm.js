import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,a,e,b as l,o as n}from"./app-hO4--mKO.js";const s={},d=e("blockquote",null,[e("p",null,"业务上需求，希望实现一个消息到期提醒的功能，比如：提前两个小时发送预警信息、到期发送超期信息等。"),e("p",null,"实现该功能有很多技术方案，本文探讨：如何通过Redis实现消息到期提醒")],-1),c=l(`<h2 id="背景知识" tabindex="-1"><a class="header-anchor" href="#背景知识"><span>背景知识</span></a></h2><p>Redis键空间通知（Keyspace Notifications）是Redis 2.8.0版本引入的一种消息通知机制，用于订阅和发布Redis键空间事件。</p><p>本质上：Redis键空间通知通过发布/订阅（pub/sub）模式实现，当某些事件发生时，Redis会自动发布消息，如果有客户端订阅了这些消息，就会收到该消息。</p><p>键空间通知会发送两种不同类型的事件消息：</p><ul><li>keyspace：键空间通知，当键空间中的键被创建、删除、过期、修改等操作时触发。</li><li>keyevent：键事件通知，当键空间中的键被创建、删除、过期、修改等操作时触发。</li></ul><p>例如：对数据库<code>0</code>中名为<code>mykey</code>的键上执行删除操作，将触发两条消息通知，等同于：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>PUBLISH __keyspace@0__:mykey del
PUBLISH __keyevent@0__:del &quot;mykey&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>格式为：<code>__{keyspace|keyevent}@{db}__:{KeyPattern|OpsType}</code>, 其中：</p><ul><li><code>__keyspace@{db}__:{KeyPattern}</code>：键空间通知前缀，表示该消息是键空间通知消息。</li><li><code>__keyevent@{db}__:{OpsType}</code>：键事件通知前缀，表示该消息是键事件通知消息。</li><li><code>{db}</code>：数据库编号，表示该消息是哪个数据库的消息。</li><li><code>{KeyPattern}</code>：键模式，支持通配符*。</li><li><code>{OpsType}</code>:表示操作类型，比如：expired</li></ul><div class="hint-container warning"><p class="hint-container-title">注意</p><p>由于本质上基于消息订阅，因此，当有客户端未订阅该消息或者断开连接期间，消息会丢失。</p></div><h2 id="配置修改" tabindex="-1"><a class="header-anchor" href="#配置修改"><span>配置修改</span></a></h2><blockquote><p>对于键空间通知，需要修改Redis配置文件，启用键空间通知功能。</p></blockquote><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>notify-keyspace-events Kx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>配置含义：</p><ul><li>K：表示键空间通知，以<code>__keyspace@&lt;db&gt;__</code>前缀发布消息。</li><li>E：表示键事件通知，以<code>__keyevent@&lt;db&gt;__</code>前缀发布消息。</li><li>g：DEL、EXPIRE、RENAME等类型的事件发生时发布消息。</li><li>$：字符串类型键值对发生变化时发布消息。</li><li>l：列表类型键值对发生变化时发布消息。</li><li>s：集合类型键值对发生变化时发布消息。</li><li>h：哈希类型键值对发生变化时发布消息。</li><li>z：有序集合类型键值对发生变化时发布消息。</li><li>t: 流类型键值对发送变化时发布消息。</li><li>x：过期事件：每当有过期键被删除时发送。</li><li>e: 驱逐事件：每当有键因为maxmemory政策而被删除时发送。</li><li>m: 未命中事件，每当有键没有命中时发送。</li><li>A：等价于：g$lshztxed，相当于是all。</li></ul><p>例如：<code>Kx</code>表示当键过期时触发键空间事件通知。</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; config get notify-keyspace-events
1) &quot;notify-keyspace-events&quot;
2) &quot;&quot;
127.0.0.1:6379&gt; config set notify-keyspace-events Kx
OK
127.0.0.1:6379&gt; config get notify-keyspace-events
1) &quot;notify-keyspace-events&quot;
2) &quot;xK&quot;
127.0.0.1:6379&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="测试" tabindex="-1"><a class="header-anchor" href="#测试"><span>测试</span></a></h2><p>开启第一个cli，订阅db0的keyspace消息：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; psubscribe __keyspace@0__:myid#*
Reading messages... (press Ctrl-C to quit)
1) &quot;psubscribe&quot;
2) &quot;__keyspace@0__:myid#*&quot;
3) (integer) 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>开启第二个cli，触发键过期事件</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; setex myid#123 10 xxx
OK
127.0.0.1:6379&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再看第一个cli，10秒之后就收到消息：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>127.0.0.1:6379&gt; psubscribe __keyspace@0__:myid#*
Reading messages... (press Ctrl-C to quit)
1) &quot;psubscribe&quot;
2) &quot;__keyspace@0__:myid#*&quot;
3) (integer) 1
1) &quot;pmessage&quot;
2) &quot;__keyspace@0__:myid#*&quot;
3) &quot;__keyspace@0__:myid#123&quot;
4) &quot;expired&quot;
</code></pre><div class="highlight-lines"><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考文献" tabindex="-1"><a class="header-anchor" href="#参考文献"><span>参考文献</span></a></h2><ul><li><a href="https://redis.io/docs/latest/develop/use/keyspace-notifications/" target="_blank" rel="noopener noreferrer">官方文档</a></li><li><a href="https://blog.csdn.net/zhizhengguan/article/details/90575438" target="_blank" rel="noopener noreferrer">golang：redis订阅键空间过期消息</a></li></ul>`,26);function o(r,p){return n(),t("div",null,[d,a(" more "),c])}const m=i(s,[["render",o],["__file","deadline-message.html.vue"]]),g=JSON.parse('{"path":"/database/redis/deadline-message.html","title":"基于Redis实现消息到期提醒","lang":"zh-CN","frontmatter":{"title":"基于Redis实现消息到期提醒","icon":"envelope","date":"2024-05-07T00:00:00.000Z","tag":["Redis"],"category":["数据存储"],"description":"业务上需求，希望实现一个消息到期提醒的功能，比如：提前两个小时发送预警信息、到期发送超期信息等。 实现该功能有很多技术方案，本文探讨：如何通过Redis实现消息到期提醒","head":[["meta",{"property":"og:url","content":"http://blog.cjhe.top/database/redis/deadline-message.html"}],["meta",{"property":"og:site_name","content":"个人博客"}],["meta",{"property":"og:title","content":"基于Redis实现消息到期提醒"}],["meta",{"property":"og:description","content":"业务上需求，希望实现一个消息到期提醒的功能，比如：提前两个小时发送预警信息、到期发送超期信息等。 实现该功能有很多技术方案，本文探讨：如何通过Redis实现消息到期提醒"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-20T03:37:50.000Z"}],["meta",{"property":"article:author","content":"Hexiaopi"}],["meta",{"property":"article:tag","content":"Redis"}],["meta",{"property":"article:published_time","content":"2024-05-07T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-05-20T03:37:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"基于Redis实现消息到期提醒\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-05-07T00:00:00.000Z\\",\\"dateModified\\":\\"2024-05-20T03:37:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Hexiaopi\\",\\"url\\":\\"https://github.com/Hexiaopi\\"}]}"]]},"headers":[{"level":2,"title":"背景知识","slug":"背景知识","link":"#背景知识","children":[]},{"level":2,"title":"配置修改","slug":"配置修改","link":"#配置修改","children":[]},{"level":2,"title":"测试","slug":"测试","link":"#测试","children":[]},{"level":2,"title":"参考文献","slug":"参考文献","link":"#参考文献","children":[]}],"git":{"createdTime":1715075085000,"updatedTime":1716176270000,"contributors":[{"name":"HeXiaoPi","email":"hechangjie0619@icloud.com","commits":2}]},"readingTime":{"minutes":2.98,"words":893},"filePathRelative":"database/redis/deadline-message.md","localizedDate":"2024年5月7日","excerpt":"<blockquote>\\n<p>业务上需求，希望实现一个消息到期提醒的功能，比如：提前两个小时发送预警信息、到期发送超期信息等。</p>\\n<p>实现该功能有很多技术方案，本文探讨：如何通过Redis实现消息到期提醒</p>\\n</blockquote>\\n","autoDesc":true}');export{m as comp,g as data};
