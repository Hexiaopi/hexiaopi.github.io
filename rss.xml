<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="http://blog.cjhe.top/rss.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <atom:link href="http://blog.cjhe.top/rss.xml" rel="self" type="application/rss+xml"/>
    <title>个人博客</title>
    <link>http://blog.cjhe.top/</link>
    <description>何小进童鞋的个人博客</description>
    <language>zh-CN</language>
    <pubDate>Tue, 23 Apr 2024 03:02:08 GMT</pubDate>
    <lastBuildDate>Tue, 23 Apr 2024 03:02:08 GMT</lastBuildDate>
    <generator>@vuepress/plugin-feed</generator>
    <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
    <category>devops</category>
    <category>Go语言</category>
    <category>网络</category>
    <category>数据库</category>
    <category>项目规范</category>
    <category>转载</category>
    <category>设计模式</category>
    <category>系统设计</category>
    <category>工具</category>
    <item>
      <title>Minio监控</title>
      <link>http://blog.cjhe.top/devops/docker/minio-monitor.html</link>
      <guid>http://blog.cjhe.top/devops/docker/minio-monitor.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Minio监控</source>
      <description>Minio监控 运行Minio Client(mc)容器 设置别名 输出结果： 生成 Prometheus 抓取目标配置 输出结果： 我们可以看到是通过bearer_token的方式获取指标，将上面生成的抓取目标配置同步到Prometheus minio-dashboard minio-dashboardminio-dashboard minio常用监...</description>
      <category>devops</category>
      <pubDate>Thu, 18 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>Minio监控</h2>
<p>运行Minio Client(mc)容器</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--entrypoint</span><span class="token operator">=</span>/bin/sh minio/mc
</code></pre></div><p>设置别名</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mc</span> <span class="token builtin class-name">alias</span> <span class="token builtin class-name">set</span> minio http://172.100.2.65:9000 minioadmin minioadmin
</code></pre></div><p>输出结果：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>mc: Configuration written to `/root/.mc/config.json`. Please update your access credentials.
mc: Successfully created `/root/.mc/share`.
mc: Initialized share uploads `/root/.mc/share/uploads.json` file.
mc: Initialized share downloads `/root/.mc/share/downloads.json` file.
Added `minio` successfully.
</code></pre></div><p>生成 Prometheus 抓取目标配置</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mc</span> admin prometheus generate minio
</code></pre></div><p>输出结果：</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>scrape_configs:
- job_name: minio-job
  bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoibWluaW9hZG1pbiIsImV4cCI6NDg2NzAyNTgyOX0.QgEjjQvA1ieHhM8sxMxMhYGGOcmsN4dQT1lIcOHGe5Lo4ZTeTsgzKAq65HPBkFQ1RayMzolQ_R2J3aByVe_ZNw
  metrics_path: /minio/v2/metrics/cluster
  scheme: http
  static_configs:
  - targets: <span class="token punctuation">[</span><span class="token string">'172.100.2.65:9000'</span><span class="token punctuation">]</span>
</code></pre></div><p>我们可以看到是通过<code>bearer_token</code>的方式获取指标，将上面生成的抓取目标配置同步到Prometheus</p>
<h2>minio-dashboard</h2>
<figure><figcaption>minio-dashboard</figcaption></figure>
<h2>minio常用监控语句</h2>
<h3>minio集群节点离线</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>minio_cluster_nodes_offline_total &gt; 0
</code></pre></div><h3>minio集群磁盘离线</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>minio_cluster_drive_offline_total &gt; 0
</code></pre></div><h2>参考文献</h2>
<p><a href="https://min.io/docs/minio/linux/operations/monitoring/collect-minio-metrics-using-prometheus.html?ref=docs-redirect" target="_blank" rel="noopener noreferrer">Prometheus官方文档</a></p>
<p><a href="https://www.cnblogs.com/zmh520/p/17771438.html" target="_blank" rel="noopener noreferrer">minio部署及监控</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>Go语言推荐书籍</title>
      <link>http://blog.cjhe.top/go-language/recommend/book.html</link>
      <guid>http://blog.cjhe.top/go-language/recommend/book.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go语言推荐书籍</source>
      <description>在线书籍 Go高级编程 Go语言设计与实现 Go语言四十二章经 Mastering Go ApacheCN Golang 译文集 Go Patterns Go语言标准库 Go测试驱动开发 Go练习 Go语言原本 Go语言编程之旅 Go程序员面试 go语言190题</description>
      <category>Go语言</category>
      <pubDate>Tue, 16 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>在线书籍</h2>
<p>Go高级编程<a href="https://books.studygolang.com/advanced-go-programming-book/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言设计与实现<a href="https://draveness.me/golang/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言四十二章经<a href="https://github.com/ffhelicopter/Go42" target="_blank" rel="noopener noreferrer"></a></p>
<p>Mastering Go<a href="https://wskdsgcf.gitbook.io/mastering-go-zh-cn/" target="_blank" rel="noopener noreferrer"></a></p>
<p>ApacheCN Golang 译文集<a href="https://go.apachecn.org/#/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go Patterns<a href="https://hxangel.gitbooks.io/go-patterns/content/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言标准库<a href="https://books.studygolang.com/The-Golang-Standard-Library-by-Example/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go测试驱动开发<a href="https://studygolang.gitbook.io/learn-go-with-tests/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go练习<a href="https://www.practical-go-lessons.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言原本<a href="https://golang.design/under-the-hood/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go语言编程之旅<a href="https://golang2.eddycjy.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go程序员面试<a href="https://golang.design/go-questions/" target="_blank" rel="noopener noreferrer"></a></p>
<h3>go语言190题</h3>
]]></content:encoded>
    </item>
    <item>
      <title>MongoDB监控</title>
      <link>http://blog.cjhe.top/devops/docker/mongodb-exporter.html</link>
      <guid>http://blog.cjhe.top/devops/docker/mongodb-exporter.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">MongoDB监控</source>
      <description>MongoDB监控 我们通过mongodb-exporter监控mongodb状态 mongodb-exporter部署 注意： --collect-all，参数用于收集所有指标 --compatible-mode，用于兼容旧的指标，否则部分grafana的dashboard展示不兼容 mongodb-dashboard mongodb-dashboa...</description>
      <category>devops</category>
      <pubDate>Tue, 16 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>MongoDB监控</h2>
<p>我们通过mongodb-exporter监控mongodb状态</p>
<h2>mongodb-exporter部署</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9216</span>:9216 <span class="token parameter variable">-p</span> <span class="token number">17001</span>:17001 <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token parameter variable">--name</span><span class="token operator">=</span>mongodb_exporter percona/mongodb_exporter:0.40 <span class="token parameter variable">--mongodb.uri</span><span class="token operator">=</span>mongodb://172.87.7.247:27017/admin?ssl<span class="token operator">=</span>false --collect-all --compatible-mode
</code></pre></div><p>注意：</p>
<ul>
<li>--collect-all，参数用于收集所有指标</li>
<li>--compatible-mode，用于兼容旧的指标，否则部分grafana的dashboard展示不兼容</li>
</ul>
<h2>mongodb-dashboard</h2>
<figure><figcaption>mongodb-dashboard</figcaption></figure>
<h2>mongodb常用监控语句</h2>
<h3>监控数据库是否宕机</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>mongodb_up == 0
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>推荐</title>
      <link>http://blog.cjhe.top/go-language/recommend/</link>
      <guid>http://blog.cjhe.top/go-language/recommend/</guid>
      <source url="http://blog.cjhe.top/rss.xml">推荐</source>
      <category>Go语言</category>
      <pubDate>Mon, 15 Apr 2024 00:00:00 GMT</pubDate>
    </item>
    <item>
      <title>Redis监控</title>
      <link>http://blog.cjhe.top/devops/docker/redis-exporter.html</link>
      <guid>http://blog.cjhe.top/devops/docker/redis-exporter.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Redis监控</source>
      <description>Redis监控
我们通过redis-exporter监控redis状态
redis-exporter部署
redis-dashboard
redis-dashboardredis-dashboard
redis常见监控语句
监控Redis是否宕机
Redis连接数过多</description>
      <category>devops</category>
      <pubDate>Fri, 12 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<!-- more -->
<h2>Redis监控</h2>
<p>我们通过redis-exporter监控redis状态</p>
<h2>redis-exporter部署</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> redis_exporter <span class="token parameter variable">--restart</span> always <span class="token parameter variable">-p</span> <span class="token number">9121</span>:9121 oliver006/redis_exporter <span class="token parameter variable">--redis.addr</span> redis://172.87.7.247:6379
</code></pre></div><h2>redis-dashboard</h2>
<figure><figcaption>redis-dashboard</figcaption></figure>
<h2>redis常见监控语句</h2>
<h3>监控Redis是否宕机</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>redis_up == 0
</code></pre></div><h3>Redis连接数过多</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>redis_connected_clients / redis_config_maxclients * 100 &gt; 90
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>MySQL监控</title>
      <link>http://blog.cjhe.top/devops/docker/mysql-exporter.html</link>
      <guid>http://blog.cjhe.top/devops/docker/mysql-exporter.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">MySQL监控</source>
      <description>MySQL监控 我们通过mysqld-exporter去将MySQL相关状态转换成指标，从而进行监控 mysql-exporter部署 其中**.my.cnf**配置数据库连接信息，其内容如下： [client] host=your host port=your port user=your username password=your passwor...</description>
      <category>devops</category>
      <pubDate>Fri, 12 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>MySQL监控</h2>
<p>我们通过mysqld-exporter去将MySQL相关状态转换成指标，从而进行监控</p>
<h2>mysql-exporter部署</h2>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mysql_exporter <span class="token parameter variable">--restart</span> always <span class="token parameter variable">-p</span> <span class="token number">9104</span>:9104 <span class="token parameter variable">-v</span> ./.my.cnf:/.my.cnf prom/mysqld-exporter
</code></pre></div><p>其中**.my.cnf**配置数据库连接信息，其内容如下：
[client]
host=your host
port=your port
user=your username
password=your password</p>
<h2>mysql-grafana面板</h2>
<figure><figcaption>mysql-dashboard</figcaption></figure>
<h2>mysql常见监控语句</h2>
<h3>监控数据库是否宕机</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>mysql_up == 0
</code></pre></div><h3>监控数据库是否超过最大连接数80%</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>max_over_time(mysql_global_status_threads_connected[1m]) / mysql_global_variables_max_connections * 100 &gt; 80
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>如果超过最大连接数，会报<strong>Too many connections</strong>错误</p>
</div>
<h3>数据库慢查询</h3>
<div class="language-promQL" data-ext="promQL" data-title="promQL"><pre class="language-promQL"><code>increase(mysql_global_status_slow_queries[1m]) &gt; 0
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>HTTP协议</title>
      <link>http://blog.cjhe.top/network/application-layer/HTTP.html</link>
      <guid>http://blog.cjhe.top/network/application-layer/HTTP.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">HTTP协议</source>
      <description>HTTP协议是目前使用最为广泛的应用层协议

HTTP发展简史

1989 年：蒂姆·伯纳斯-李在 CERN 提出万维网的概念。
1991 年：蒂姆·伯纳斯-李发布 HTTP/0.9，HTTP 协议的第一个版本。
1996 年：HTTP/1.0 发布，引入了状态码、头字段和持久连接等新功能。
1997 年：HTTP/1.1 发布，对 HTTP/1.0 ...</description>
      <category>网络</category>
      <pubDate>Thu, 11 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<!-- more -->
<blockquote>
<p>HTTP协议是目前使用最为广泛的应用层协议</p>
</blockquote>
<h2>HTTP发展简史</h2>
<ul>
<li><strong>1989 年</strong>：蒂姆·伯纳斯-李在 CERN 提出万维网的概念。</li>
<li><strong>1991 年</strong>：蒂姆·伯纳斯-李发布 HTTP/0.9，HTTP 协议的第一个版本。</li>
<li><strong>1996 年</strong>：HTTP/1.0 发布，引入了状态码、头字段和持久连接等新功能。</li>
<li><strong>1997 年</strong>：HTTP/1.1 发布，对 HTTP/1.0 进行了重大更新，包括管道化请求、分块传输编码和主机头字段。</li>
<li><strong>2015 年</strong>：HTTP/2 发布，对 HTTP/1.1 进行了重大重新设计，重点是提高性能和效率。</li>
<li><strong>2022 年</strong>：HTTP/3 发布，HTTP/2 的最新版本，基于 QUIC 传输协议。</li>
</ul>
<p>HTTP/1.1 仍然是当今互联网上使用最广泛的 HTTP 版本，但 HTTP/2 和 HTTP/3 正在逐渐获得采用。随着时间的推移，预计 HTTP/3 将成为新的标准。</p>
<h2>HTTP方法</h2>
<figure><figcaption>http</figcaption></figure>
<p>HTTP 方法是客户端向服务器发送请求时所使用的动作。最常用的 HTTP 方法包括：</p>
<ul>
<li><strong>GET：</strong> 从服务器获取指定资源。这是最基本的 HTTP 方法，用于检索网页、图像或其他文件。</li>
<li><strong>POST：</strong> 向服务器提交数据以创建资源。通常用于提交表单数据或上传文件。</li>
<li><strong>PUT：</strong> 更新服务器上的现有资源。</li>
<li><strong>DELETE：</strong> 删除服务器上的资源。</li>
<li><strong>HEAD：</strong> 获取资源的元数据（如大小和内容类型），而不实际获取资源内容。</li>
<li><strong>OPTIONS：</strong> 获取服务器支持的 HTTP 方法和功能。</li>
<li><strong>PATCH：</strong> 部分更新服务器上的资源。</li>
</ul>
<p><strong>示例</strong></p>
<p>以下是一些 HTTP 方法的示例：</p>
<ul>
<li><code>GET /index.html HTTP/1.1</code>：从服务器获取 index.html 文件。</li>
<li><code>POST /submit-form HTTP/1.1</code>：向服务器提交表单数据。</li>
<li><code>PUT /users/1 HTTP/1.1</code>：更新服务器上 ID 为 1 的用户。</li>
<li><code>DELETE /files/image.png HTTP/1.1</code>：从服务器删除 image.png 文件。</li>
<li><code>HEAD /about-us HTTP/1.1</code>：获取关于我们页面的元数据。</li>
<li><code>OPTIONS /api/v1 HTTP/1.1</code>：获取 API 的功能信息。</li>
<li><code>PATCH /users/1 HTTP/1.1</code>：部分更新用户个人资料（例如，仅更新姓名）。</li>
</ul>
<h2>HTTP状态码</h2>
<p>TTP 状态码分为五类，每类表示一个不同的响应类别：</p>
<p><strong>1xx 信息响应</strong></p>
<ul>
<li>表示请求已收到并正在处理。</li>
<li>例如：
<ul>
<li>100 继续</li>
<li>101 切换协议</li>
</ul>
</li>
</ul>
<p><strong>2xx 成功响应</strong></p>
<ul>
<li>表示请求已成功处理。</li>
<li>例如：
<ul>
<li>200 OK</li>
<li>201 已创建</li>
<li>204 无内容</li>
</ul>
</li>
</ul>
<p><strong>3xx 重定向</strong></p>
<ul>
<li>表示需要进一步操作才能完成请求。</li>
<li>例如：
<ul>
<li>301 永久重定向</li>
<li>302 临时重定向</li>
<li>308 永久重定向</li>
</ul>
</li>
</ul>
<p><strong>4xx 客户端错误</strong></p>
<ul>
<li>表示客户端请求有误。</li>
<li>例如：
<ul>
<li>400 错误的请求</li>
<li>401 未经授权</li>
<li>404 未找到</li>
</ul>
</li>
</ul>
<p><strong>5xx 服务器错误</strong></p>
<ul>
<li>表示服务器在处理请求时遇到错误。</li>
<li>例如：
<ul>
<li>500 内部服务器错误</li>
<li>502 错误的网关</li>
<li>503 服务不可用</li>
</ul>
</li>
</ul>
<h2>参考链接</h2>
<p><a href="https://mp.weixin.qq.com/s/AuYEWkY9LN6TRrQvU-AaQA" target="_blank" rel="noopener noreferrer">HTTP发放和使用大全</a>
<a href="https://mp.weixin.qq.com/s/Q_BeNgqNWizwVkMkH39e7g" target="_blank" rel="noopener noreferrer">HTTP状态码完整指南</a>
<a href="https://mp.weixin.qq.com/s/VTFC8WEJTnoDzEtKsi48Aw" target="_blank" rel="noopener noreferrer">图解|什么是HTTP简史</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>应用层协议</title>
      <link>http://blog.cjhe.top/network/application-layer/</link>
      <guid>http://blog.cjhe.top/network/application-layer/</guid>
      <source url="http://blog.cjhe.top/rss.xml">应用层协议</source>
      <description>本篇介绍计算机网络应用层协议 常见的应用层协议： HTTP DNS Telnet SSH FTP POP3 IMAP</description>
      <category>网络</category>
      <pubDate>Thu, 11 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>本篇介绍计算机网络应用层协议</p>
</blockquote>
<p>常见的应用层协议：</p>
<ul>
<li>HTTP</li>
<li>DNS</li>
<li>Telnet</li>
<li>SSH</li>
<li>FTP</li>
<li>POP3</li>
<li>IMAP</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>ICMP协议</title>
      <link>http://blog.cjhe.top/network/internet-layer/ICMP.html</link>
      <guid>http://blog.cjhe.top/network/internet-layer/ICMP.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">ICMP协议</source>
      <description>ICMP(Internet Control Message Protocol,互联网控制协议)，属于网络层协议。主要用于在IP主机和路由器之间传递控制信息，例如：主机是否可达、路由是否可用等。 ICMP使用IP协议发送信息，它虽然属于网络层协议，但严格来说，它位于IP之上。</description>
      <category>网络</category>
      <pubDate>Mon, 13 Nov 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>ICMP(Internet Control Message Protocol,互联网控制协议)，属于网络层协议。主要用于在IP主机和路由器之间传递控制信息，例如：主机是否可达、路由是否可用等。</p>
<p>ICMP使用IP协议发送信息，它虽然属于网络层协议，但严格来说，它位于IP之上。</p>
]]></content:encoded>
    </item>
    <item>
      <title>网络层协议</title>
      <link>http://blog.cjhe.top/network/internet-layer/</link>
      <guid>http://blog.cjhe.top/network/internet-layer/</guid>
      <source url="http://blog.cjhe.top/rss.xml">网络层协议</source>
      <description>本篇介绍计算机网络网络层协议 常见的网络层协议： IP IPv6 ICMP ARP</description>
      <category>网络</category>
      <pubDate>Thu, 11 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>本篇介绍计算机网络网络层协议</p>
</blockquote>
<p>常见的网络层协议：</p>
<ul>
<li>IP</li>
<li>IPv6</li>
<li>ICMP</li>
<li>ARP</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>链路层协议</title>
      <link>http://blog.cjhe.top/network/link-layer/</link>
      <guid>http://blog.cjhe.top/network/link-layer/</guid>
      <source url="http://blog.cjhe.top/rss.xml">链路层协议</source>
      <description>链路层协议比较偏底层，有机会再介绍</description>
      <category>网络</category>
      <pubDate>Thu, 11 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>链路层协议比较偏底层，有机会再介绍</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>传输层协议</title>
      <link>http://blog.cjhe.top/network/transport-layer/</link>
      <guid>http://blog.cjhe.top/network/transport-layer/</guid>
      <source url="http://blog.cjhe.top/rss.xml">传输层协议</source>
      <description>本篇介绍计算机网络传输层协议 常见的传输层协议： TCP UDP</description>
      <category>网络</category>
      <pubDate>Thu, 11 Apr 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>本篇介绍计算机网络传输层协议</p>
</blockquote>
<p>常见的传输层协议：</p>
<ul>
<li>TCP</li>
<li>UDP</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>docker</title>
      <link>http://blog.cjhe.top/devops/docker/</link>
      <guid>http://blog.cjhe.top/devops/docker/</guid>
      <source url="http://blog.cjhe.top/rss.xml">docker</source>
      <description>这里记录工作中学习到的docker相关知识</description>
      <category>devops</category>
      <pubDate>Mon, 18 Mar 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>这里记录工作中学习到的docker相关知识</p>
]]></content:encoded>
    </item>
    <item>
      <title>容器执行报&amp;quot;no such file or directory&amp;quot;问题</title>
      <link>http://blog.cjhe.top/devops/docker/shell-line-break.html</link>
      <guid>http://blog.cjhe.top/devops/docker/shell-line-break.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">容器执行报&amp;quot;no such file or directory&amp;quot;问题</source>
      <description>同事运行docker镜像时，控制台报错&amp;quot;no such file or directory&amp;quot;，但是查看该文件确实存在，本文记录该问题的定位和解决。</description>
      <category>devops</category>
      <pubDate>Mon, 18 Mar 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>同事运行docker镜像时，控制台报错"no such file or directory"，但是查看该文件确实存在，本文记录该问题的定位和解决。</p>
<!-- more -->
<h3>查看镜像使用方式</h3>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>COPY xxx/run.sh /run.sh
<span class="token comment"># RUN命令</span>
RUN chmod 777 /run.sh
<span class="token comment"># 执行命令</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"/run.sh"</span><span class="token punctuation">]</span>
</code></pre></div><p>这里查看dockerfile，采用的是脚本方式启动服务进程，使用方式上并没有什么问题</p>
<h3>根据报错信息查看文件是否存在</h3>
<p>通过新增RUN命令:<code>RUN ls -al</code>,打印当前路径文件的方式确认是有<code>run.sh</code>脚本文件</p>
<h3>检查脚本文件</h3>
<p>对比了服务器的脚本文件和开发使用的脚本文件，仔细观察发现脚本文件唯一不同的是换行符不一样</p>
<ul>
<li>开发使用的是windows系统，换行符为<strong>CRLF</strong>,对应为:<code>\r\n</code></li>
<li>服务器使用的linux系统，换行符为<strong>LF</strong>，对应为:<code>\n</code></li>
</ul>
<h3>关键问题</h3>
<p>脚本第一行</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
</code></pre></div><p>表明使用<code>/bin/bash</code>来解释脚本，但如何后面有windows的换行符导致无法识别，因此会报错：“no such file or directory”</p>
<h3>问题结局</h3>
<p>通过修改<code>run.sh</code>的换行符为<strong>LF</strong>，问题得以解决。</p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>代码提交时，将文件换行符设置为LF格式。</p>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>k8s</title>
      <link>http://blog.cjhe.top/devops/k8s/</link>
      <guid>http://blog.cjhe.top/devops/k8s/</guid>
      <source url="http://blog.cjhe.top/rss.xml">k8s</source>
      <description>这里记录工作中学习到的k8s相关知识</description>
      <category>devops</category>
      <pubDate>Mon, 18 Mar 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>这里记录工作中学习到的k8s相关知识</p>
]]></content:encoded>
    </item>
    <item>
      <title>Helm Dashboard简介</title>
      <link>http://blog.cjhe.top/devops/k8s/helm-dashboard.html</link>
      <guid>http://blog.cjhe.top/devops/k8s/helm-dashboard.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Helm Dashboard简介</source>
      <description>helm-dashboard是helm的可视化界面，可以查看集群内通过helm部署的chart包。好处：不需要登录机器就可以升级、回滚chart包。</description>
      <category>devops</category>
      <pubDate>Tue, 12 Mar 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>helm-dashboard是helm的可视化界面，可以查看集群内通过helm部署的chart包。好处：不需要登录机器就可以升级、回滚chart包。</p>
<!-- more -->
<h2>Helm Dashboard简介</h2>
<h3>常用特性</h3>
<ul>
<li>查看、升级、回滚chart包及其内容</li>
<li>查看各个版本之间的区别</li>
</ul>
<h3>查看已安装的chart包</h3>
<figure><figcaption></figcaption></figure>
<h3>单个chart包的升级、回滚和修改配置</h3>
<figure><figcaption></figcaption></figure>
<h3>比较各个版本之前的区别</h3>
<figure><figcaption></figcaption></figure>
<h3>Helm Dadshboard 魔改</h3>
<p>helm-dashboard依赖的前端静态资源如：</p>
<ul>
<li>https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css</li>
<li>https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/lightfair.min.css</li>
<li>https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css</li>
</ul>
<p>由于国内网络原因，偶尔访问不到，导致页面加载不出来，影响使用。因此需要将这些cdn资源改为本地引用。<a href="https://github.com/Hexiaopi/helm-dashboard/commit/4eb18e1655606cd80ce1eb8001f03eaca6a55dc7" target="_blank" rel="noopener noreferrer">代码修改详见</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>kube-state-metrics k8s 部署</title>
      <link>http://blog.cjhe.top/devops/k8s/kube-state-metrics-k8s-deploy.html</link>
      <guid>http://blog.cjhe.top/devops/k8s/kube-state-metrics-k8s-deploy.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">kube-state-metrics k8s 部署</source>
      <description>kube-state-metrics用于监控k8s相关指标</description>
      <category>devops</category>
      <pubDate>Mon, 15 Jan 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>kube-state-metrics用于监控k8s相关指标</p>
<!-- more -->
<h2>k8s部署</h2>
<p>1、部署cluster-role</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> configmaps
  <span class="token punctuation">-</span> secrets
  <span class="token punctuation">-</span> nodes
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> services
  <span class="token punctuation">-</span> serviceaccounts
  <span class="token punctuation">-</span> resourcequotas
  <span class="token punctuation">-</span> replicationcontrollers
  <span class="token punctuation">-</span> limitranges
  <span class="token punctuation">-</span> persistentvolumeclaims
  <span class="token punctuation">-</span> persistentvolumes
  <span class="token punctuation">-</span> namespaces
  <span class="token punctuation">-</span> endpoints
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> statefulsets
  <span class="token punctuation">-</span> daemonsets
  <span class="token punctuation">-</span> deployments
  <span class="token punctuation">-</span> replicasets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> batch
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> cronjobs
  <span class="token punctuation">-</span> jobs
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> autoscaling
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> horizontalpodautoscalers
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> authentication.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tokenreviews
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> authorization.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> subjectaccessreviews
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> policy
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> poddisruptionbudgets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> certificates.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> certificatesigningrequests
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> discovery.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> endpointslices
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> storage.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> storageclasses
  <span class="token punctuation">-</span> volumeattachments
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> admissionregistration.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mutatingwebhookconfigurations
  <span class="token punctuation">-</span> validatingwebhookconfigurations
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networking.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> networkpolicies
  <span class="token punctuation">-</span> ingressclasses
  <span class="token punctuation">-</span> ingresses
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> coordination.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> leases
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> rbac.authorization.k8s.io
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> clusterrolebindings
  <span class="token punctuation">-</span> clusterroles
  <span class="token punctuation">-</span> rolebindings
  <span class="token punctuation">-</span> roles
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
</code></pre></div><p>2、部署cluster-role-binding</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div><p>3、部署deployment</p>
<p>👁️ 由于国外网络原因，注意需要修改镜像地址</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token comment">#- image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.10.0</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/bitnami/kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics<span class="token punctuation">:</span>latest
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> telemetry
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
            <span class="token key atrule">drop</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ALL
          <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">65534</span>
          <span class="token key atrule">seccompProfile</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> RuntimeDefault
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
</code></pre></div><p>4、部署service</p>
<p>注意，需要设置annotation，让Prometheus自动发现</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> telemetry
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> telemetry
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
</code></pre></div><p>5、部署service-account</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.10.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>cadvisor k8s 部署</title>
      <link>http://blog.cjhe.top/devops/k8s/cadvisor-k8s-deploy.html</link>
      <guid>http://blog.cjhe.top/devops/k8s/cadvisor-k8s-deploy.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">cadvisor k8s 部署</source>
      <description>cadvisor 是谷歌公司用来分析运行中的 Docker 容器的资源占用以及性能特性的工具，简单来说是用于监控 Docker 容器。</description>
      <category>devops</category>
      <pubDate>Mon, 15 Jan 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>cadvisor 是谷歌公司用来分析运行中的 Docker 容器的资源占用以及性能特性的工具，简单来说是用于监控 Docker 容器。</p>
<!-- more -->
<h2>k8s部署</h2>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cadvisor
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> cAdvisor
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> cAdvisor
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token comment">#污点容忍,忽略master的NoSchedule</span>
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
          <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cadvisor
        <span class="token key atrule">image</span><span class="token punctuation">:</span> google/cadvisor<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> root
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /rootfs
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /sys
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/containerd
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> root
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /sys
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/containerd
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>node-exporter k8s 部署</title>
      <link>http://blog.cjhe.top/devops/k8s/node-exporter-k8s-deploy.html</link>
      <guid>http://blog.cjhe.top/devops/k8s/node-exporter-k8s-deploy.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">node-exporter k8s 部署</source>
      <description>node-exporter用于暴露各个节点的指标，由于需要每个节点都部署node-exporter，因此kind选择DaemonSet，它会保障每个节点有一个相同的实例。</description>
      <category>devops</category>
      <pubDate>Mon, 15 Jan 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>node-exporter用于暴露各个节点的指标，由于需要每个节点都部署node-exporter，因此kind选择DaemonSet，它会保障每个节点有一个相同的实例。</p>
<!-- more -->
<h2>k8s部署</h2>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>exporter
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
          <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/node<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>node<span class="token punctuation">-</span>exporter
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>
          <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">9100</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/proc
          <span class="token key atrule">name</span><span class="token punctuation">:</span> proc
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/sys
          <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host
          <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.procfs=/host/proc
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.sysfs=/host/sys
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>path.rootfs=/host
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proc
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /proc
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sys
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /sys
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>devops</title>
      <link>http://blog.cjhe.top/devops/</link>
      <guid>http://blog.cjhe.top/devops/</guid>
      <source url="http://blog.cjhe.top/rss.xml">devops</source>
      <description>这里记录工作中学习到的devops基础知识</description>
      <category>devops</category>
      <pubDate>Mon, 15 Jan 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>这里记录工作中学习到的devops基础知识</p>
]]></content:encoded>
    </item>
    <item>
      <title>Prometheus k8s 部署</title>
      <link>http://blog.cjhe.top/devops/k8s/prometheus-k8s-deploy.html</link>
      <guid>http://blog.cjhe.top/devops/k8s/prometheus-k8s-deploy.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Prometheus k8s 部署</source>
      <description>Prometheus是个优秀的监控系统，基于时序数据库，这里记录k8s部署</description>
      <category>devops</category>
      <pubDate>Mon, 15 Jan 2024 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>Prometheus是个优秀的监控系统，基于时序数据库，这里记录k8s部署</p>
<!-- more -->
<h2>k8s部署</h2>
<p>步骤一、创建数据存储</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> /home/data/prometheus
<span class="token function">chmod</span> <span class="token number">777</span> /home/data/prometheus
</code></pre></div><p>步骤二、创建serviceaccount和clusterrolebinding</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>kubectl create serviceaccount monitor <span class="token parameter variable">-n</span> monitor
kubectl create clusterrolebinding monitor-clusterrolebinding <span class="token parameter variable">-n</span> monitor <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>monitor:monitor
</code></pre></div><p>步骤三、创建Prometheus configmap用于存储抓取配置</p>
<div class="language-yaml" data-ext="yml" data-title="yml"><pre class="language-yaml"><code></code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>网络</title>
      <link>http://blog.cjhe.top/network/</link>
      <guid>http://blog.cjhe.top/network/</guid>
      <source url="http://blog.cjhe.top/rss.xml">网络</source>
      <description>这里记录工作中学习到的网络基础知识</description>
      <category>网络</category>
      <pubDate>Sat, 23 Sep 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>这里记录工作中学习到的网络基础知识</p>
]]></content:encoded>
    </item>
    <item>
      <title>三方库</title>
      <link>http://blog.cjhe.top/go-language/third-party/</link>
      <guid>http://blog.cjhe.top/go-language/third-party/</guid>
      <source url="http://blog.cjhe.top/rss.xml">三方库</source>
      <category>Go语言</category>
      <pubDate>Wed, 20 Sep 2023 00:00:00 GMT</pubDate>
    </item>
    <item>
      <title>pflag</title>
      <link>http://blog.cjhe.top/go-language/third-party/pflag.html</link>
      <guid>http://blog.cjhe.top/go-language/third-party/pflag.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">pflag</source>
      <description>我在标准库中介绍了，对于小型的项目flag能够基本满足需求，但是在某些大型项目或者特殊场景下flag有些力不从心。主要在于： flag的子命令需要自己解析 flag的短命令需要定义两个变量 不支持一些参数废弃说明，这在更新的工具中对用户有更好的引导作用 因此业界开源的pflag受到广大爱好者的使用，在一些耳熟能详的开源项目里也都在使用pflag，例如：...</description>
      <category>Go语言</category>
      <pubDate>Wed, 20 Sep 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>我在标准库中介绍了<a href="/go-language/standard-library/flag.html" target="_blank">flag使用</a>，对于小型的项目flag能够基本满足需求，但是在某些大型项目或者特殊场景下flag有些力不从心。主要在于：</p>
<ul>
<li>flag的子命令需要自己解析</li>
<li>flag的短命令需要定义两个变量</li>
<li>不支持一些参数废弃说明，这在更新的工具中对用户有更好的引导作用</li>
</ul>
<p>因此业界开源的<a href="https://github.com/spf13/pflag" target="_blank" rel="noopener noreferrer">pflag</a>受到广大爱好者的使用，在一些耳熟能详的开源项目里也都在使用pflag，例如：Kubernetes、Istio、Helm、Docker、Etcd等。</p>
<h2>简单用法</h2>
<h3>支持标准库flag用法</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> flagStrA <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"flag test *string"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagLongStringPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--str-a"</span><span class="token punctuation">,</span> <span class="token string">"stra"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagStrA<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// stra</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>注意是长选项，即参数为<code>--xxx</code></p>
</div>
<h3>支持短选项</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> flagStrB <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"long and short flag test *string"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagShortStringPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-b"</span><span class="token punctuation">,</span> <span class="token string">"strb"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagStrB<span class="token punctuation">)</span>
	<span class="token comment">// OutPut:</span>
	<span class="token comment">// strb</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>支持绑定到已有变量</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> flagStrC <span class="token builtin">string</span>
<span class="token keyword">var</span> flagStrD <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagStrC<span class="token punctuation">,</span> <span class="token string">"str-c"</span><span class="token punctuation">,</span> <span class="token string">"str-c"</span><span class="token punctuation">,</span> <span class="token string">"long flag test string"</span><span class="token punctuation">)</span>
	pflag<span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagStrD<span class="token punctuation">,</span> <span class="token string">"str-d"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"str-d"</span><span class="token punctuation">,</span> <span class="token string">"long and short flag test string"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--str-c"</span><span class="token punctuation">,</span> <span class="token string">"strc"</span><span class="token punctuation">,</span> <span class="token string">"-d"</span><span class="token punctuation">,</span> <span class="token string">"strd"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flagStrC<span class="token punctuation">,</span> flagStrD<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// strc strd</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>标记命令行参数已废弃</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkDeprecated</span><span class="token punctuation">(</span><span class="token string">"badflag"</span><span class="token punctuation">,</span> <span class="token string">"please use --desc instead"</span><span class="token punctuation">)</span>
pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkShorthandDeprecated</span><span class="token punctuation">(</span><span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"please use --str-b instead"</span><span class="token punctuation">)</span>
</code></pre></div><p>打印Usage()</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>Flag --badflag has been deprecated, please use --desc instead
Flag shorthand -b has been deprecated, please use --str-b instead
</code></pre></div><h3>指定了参数却没有传值场景下的默认值改写</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> age <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">IntP</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"Input Your Age"</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pflag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NoOptDefVal <span class="token operator">=</span> <span class="token string">"25"</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestFlagDefault</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name      <span class="token builtin">string</span>
		arguments <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
		want      <span class="token builtin">int</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"没传入参数和值"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"传入参数和值"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--age=10"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"传入参数,没传值"</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"--age"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> test <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">*</span>age <span class="token operator">!=</span> test<span class="token punctuation">.</span>want <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"%s pflag parse want:%d,but got:%d"</span><span class="token punctuation">,</span> test<span class="token punctuation">.</span>name<span class="token punctuation">,</span> test<span class="token punctuation">.</span>want<span class="token punctuation">,</span> <span class="token operator">*</span>age<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>::: notice</p>
<ul>
<li>当输入--age 10，age变量值为：10；</li>
<li>当输入--age，age变量值为：25；</li>
<li>当没输入--age，age变量值为：30；</li>
</ul>
<p>:::</p>
<h3>支持隐藏参数</h3>
<blockquote>
<p>隐藏的参数不会显示在usage/help中</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkHidden</span><span class="token punctuation">(</span><span class="token string">"secretFlag"</span><span class="token punctuation">)</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>标准库</title>
      <link>http://blog.cjhe.top/go-language/standard-library/</link>
      <guid>http://blog.cjhe.top/go-language/standard-library/</guid>
      <source url="http://blog.cjhe.top/rss.xml">标准库</source>
      <category>Go语言</category>
      <pubDate>Tue, 19 Sep 2023 00:00:00 GMT</pubDate>
    </item>
    <item>
      <title>flag使用</title>
      <link>http://blog.cjhe.top/go-language/standard-library/flag.html</link>
      <guid>http://blog.cjhe.top/go-language/standard-library/flag.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">flag使用</source>
      <description>flag库实现命令行参数解析 简单用法 flag参数使用语法 -flag // 破折号，使用默认值 --flag // 双破折号 -flag=x // 指定参数值 -flag x // non-boolean flags only 字符串类型 使用示例 不过由于flag.String()返回的是指针类型的字符串，因此，也可以使用下面方式定义 使用示例 ...</description>
      <category>Go语言</category>
      <pubDate>Tue, 05 Sep 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>flag库实现命令行参数解析</p>
</blockquote>
<h2>简单用法</h2>
<div class="hint-container tip">
<p class="hint-container-title">flag参数使用语法</p>
<p>-flag    // 破折号，使用默认值
--flag   // 双破折号
-flag=x  // 指定参数值
-flag x  // non-boolean flags only</p>
</div>
<h3>字符串类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example1：flag.String 返回指针类型字符串</span>
<span class="token keyword">var</span> flagStrA <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"str-a"</span><span class="token punctuation">,</span> <span class="token string">"flag test *string"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagStringPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-str-a"</span><span class="token punctuation">,</span> <span class="token string">"stra"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagStrA<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// stra</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不过由于flag.String()返回的是指针类型的字符串，因此，也可以使用下面方式定义</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example2：如果期望定义字符串类型，可以通过init函数初始化</span>
<span class="token keyword">var</span> flagStrB <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// flag.StringVar可以绑定已有的变量</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagStrB<span class="token punctuation">,</span> <span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"str-b"</span><span class="token punctuation">,</span> <span class="token string">"flag test string"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagStringPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-str-b"</span><span class="token punctuation">,</span> <span class="token string">"strb"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flagStrB<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// strb</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>int类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example3：int类型变量</span>
<span class="token keyword">var</span> flagInt <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"flag test *int"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagIntPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-int"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagInt<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 10</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>Bool类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example3：int类型变量</span>
<span class="token keyword">var</span> flagInt <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"flag test *int"</span><span class="token punctuation">)</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">bool类型可以使用以下字面量</p>
<p>1, 0, t, f, T, F, true, false, TRUE, FALSE, True, False</p>
</div>
<p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleBoolPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-bool=True"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagBool<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意事项</p>
<h4>bool类型不可使用：-flag x形式</h4>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleBoolPointNoticPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-bool"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagBool<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>虽然显示的传入<code>false</code>，但是最终结果是<code>true</code></p>
</div>
<h4>bool类型：-flag形式，认为true</h4>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleBoolPointEmptyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-bool"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagBool<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div></div>
<h3>duration类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example5：duration类型变量</span>
<span class="token keyword">var</span> flagDuration <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Minute<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"flag test *duration"</span><span class="token punctuation">)</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleFlagDurationPointPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-duration"</span><span class="token punctuation">,</span> <span class="token string">"1m1s"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>flagDuration<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1m1s</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>高阶用法</h2>
<p>flag标准库提供了基础的数据类型参数，如下：</p>
<ul>
<li>bool</li>
<li>int</li>
<li>int64</li>
<li>uint</li>
<li>uint64</li>
<li>string</li>
<li>float64</li>
<li>duration</li>
</ul>
<h3>自定义类型</h3>
<p>如果需要自定义类型，需要实现<code>flag.Value</code>接口</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Set</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Example6: 自定义类型</span>
<span class="token keyword">type</span> URLValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	URL <span class="token operator">*</span>url<span class="token punctuation">.</span>URL
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v URLValue<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span>URL <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> v<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>URLValue<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> u<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span>URL <span class="token operator">=</span> u
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> u URLValue

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">,</span> <span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"flag test self struct"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleStructPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"-url"</span><span class="token punctuation">,</span> <span class="token string">"https://golang.org/pkg/flag/"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// https://golang.org/pkg/flag/</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>子命令</h3>
<p>这里参考网站示例：<a href="https://gobyexample.com/command-line-subcommands" target="_blank" rel="noopener noreferrer">gobyexample</a></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    fooCmd <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span>ExitOnError<span class="token punctuation">)</span>
    fooEnable <span class="token operator">:=</span> fooCmd<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">"enable"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"enable"</span><span class="token punctuation">)</span>
    fooName <span class="token operator">:=</span> fooCmd<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span>

    barCmd <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">"bar"</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span>ExitOnError<span class="token punctuation">)</span>
    barLevel <span class="token operator">:=</span> barCmd<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"level"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"expected 'foo' or 'bar' subcommands"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

    <span class="token keyword">case</span> <span class="token string">"foo"</span><span class="token punctuation">:</span>
        fooCmd<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subcommand 'foo'"</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  enable:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>fooEnable<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  name:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>fooName<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  tail:"</span><span class="token punctuation">,</span> fooCmd<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token string">"bar"</span><span class="token punctuation">:</span>
        barCmd<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subcommand 'bar'"</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  level:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>barLevel<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"  tail:"</span><span class="token punctuation">,</span> barCmd<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"expected 'foo' or 'bar' subcommands"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./command-line-subcommands foo <span class="token parameter variable">-enable</span> <span class="token parameter variable">-name</span><span class="token operator">=</span>joe a1 a2
</code></pre></div><div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>subcommand 'foo'
  enable: true
  name: joe
  tail: [a1 a2]
</code></pre></div><div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./command-line-subcommands bar <span class="token parameter variable">-level</span> <span class="token number">8</span> a1
</code></pre></div><div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>subcommand 'bar'
  level: 8
  tail: [a1]
</code></pre></div><h2>底层结构</h2>
<p>Flag代表一个标志，例如:<code>--version</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// A Flag represents the state of a flag.</span>
<span class="token keyword">type</span> Flag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name     <span class="token builtin">string</span> <span class="token comment">// name as it appears on command line</span>
	Usage    <span class="token builtin">string</span> <span class="token comment">// help message</span>
	Value    Value  <span class="token comment">// value as set</span>
	DefValue <span class="token builtin">string</span> <span class="token comment">// default value (as text); for usage message</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FlagSet 代表标志的集合，例如：<code>--name</code>、<code>--age</code>...</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> FlagSet <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Usage is the function called when an error occurs while parsing flags.</span>
	<span class="token comment">// The field is a function (not a method) that may be changed to point to</span>
	<span class="token comment">// a custom error handler. What happens after Usage is called depends</span>
	<span class="token comment">// on the ErrorHandling setting; for the command line, this defaults</span>
	<span class="token comment">// to ExitOnError, which exits the program after calling Usage.</span>
	Usage <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	name          <span class="token builtin">string</span>
	parsed        <span class="token builtin">bool</span>
	actual        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag
	formal        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag
	args          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// arguments after flags</span>
	errorHandling ErrorHandling
	output        io<span class="token punctuation">.</span>Writer <span class="token comment">// nil means stderr; use Output() accessor</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FlagSet包含一系列方法：</p>
<ul>
<li>BoolVar(p *bool,name string,value bool,usage string)</li>
<li>Bool(name string,value bool,usage string) *bool</li>
<li>IntVar(p *int,name string,value int,usage string)</li>
<li>Int(name string,value int,usage string) *int</li>
<li>Int64Var(p *int64,name string,value int64,usage string)</li>
<li>Int64(name string,value int64,usage string) *int64</li>
<li>UIntVar(p *uint,name string,value uint,usage string)</li>
<li>UInt(name string,value uint,usage string) *Uint</li>
<li>UInt64Var(p *uint64,name string,value uint64,usage string)</li>
<li>UInt64(name string,value uint64,usage string) *Uint64</li>
<li>StringVar(p *string,name string,value string,usage string)</li>
<li>String(name string,value string,usage string) *string</li>
<li>Float64Var(p *float64,name string,value float64,usage string)</li>
<li>Float64(name string,value float64,usage string) *float64</li>
<li>DurationVar(p *time.Duration,name string,value time.Duration,usage string)</li>
<li>Duration(name string,value time.Duration,usage string) *time.Duration</li>
<li>TextVar(p encoding.TextUnmarshaler,name string,value encoding.TextMarshaler,usage string)</li>
<li>Var(value Value, name string, usage string)</li>
</ul>
<p>而我们常常使用的是flag库中的以下方法，例如：<code>flag.StringVar()</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">StringVar</span><span class="token punctuation">(</span>p <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	CommandLine<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span><span class="token function">newStringValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其本质上是调用<code>CommandLine.Var</code>方法，而CommandLine是FlagSet的一个实例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> CommandLine <span class="token operator">=</span> <span class="token function">NewFlagSet</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ExitOnError<span class="token punctuation">)</span>
</code></pre></div><ul>
<li><code>os.Args[0]</code>：是程序运行时的名称。</li>
<li><code>ExitOnError</code>：是解析参数时遇到错误时退出</li>
</ul>
<p><code>flag.Parse</code>其本质上也是调用CommandLine的解析，如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Ignore errors; CommandLine is set for ExitOnError.</span>
	CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它将<code>os.Args[1:]</code>，即除了程序名称外，其余的参数传给CommandLine进行解析。</p>
<p>最为核心的代码莫过于参数的解析，如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">Parse</span><span class="token punctuation">(</span>arguments <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>parsed <span class="token operator">=</span> <span class="token boolean">true</span>
	f<span class="token punctuation">.</span>args <span class="token operator">=</span> arguments
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		seen<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">parseOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> seen <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> f<span class="token punctuation">.</span>errorHandling <span class="token punctuation">{</span>
		<span class="token keyword">case</span> ContinueOnError<span class="token punctuation">:</span>
			<span class="token keyword">return</span> err
		<span class="token keyword">case</span> ExitOnError<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> ErrHelp <span class="token punctuation">{</span>
				os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> PanicOnError<span class="token punctuation">:</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里循环解析每一个Flag，即：<code>f.parseOne()</code>。</p>
<p>最后总结其中的关系图:</p>
<figure><figcaption>flag</figcaption></figure>
]]></content:encoded>
    </item>
    <item>
      <title>recover注意事项</title>
      <link>http://blog.cjhe.top/go-language/base/recover.html</link>
      <guid>http://blog.cjhe.top/go-language/base/recover.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">recover注意事项</source>
      <description>defer结合recover通常用于捕获panic 正确使用示例 使用示例 错误用例：不使用defer 警告 不使用defer 方式，将无法捕获异常，程序陷入panic 错误用例：recover 在 defer 嵌套函数中 警告 defer recover和panic不在同一层级，导致无法捕获异常，程序陷入panic</description>
      <category>Go语言</category>
      <pubDate>Sun, 27 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>defer结合recover通常用于捕获panic</p>
</blockquote>
<h2>正确使用示例</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">PrintRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"some thing"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExamplePrintRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">PrintRecover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// a</span>
	<span class="token comment">// some thing</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>错误用例：不使用defer</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FailRecoverWithoutDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"some thing"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>不使用defer 方式，将无法捕获异常，程序陷入panic</p>
</div>
<h2>错误用例：recover 在 defer 嵌套函数中</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FailRecoverWithoutLevelDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//recover 在 defer 嵌套函数中</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"some thing"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>defer recover和panic不在同一层级，导致无法捕获异常，程序陷入panic</p>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>package</title>
      <link>http://blog.cjhe.top/go-language/base/package.html</link>
      <guid>http://blog.cjhe.top/go-language/base/package.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">package</source>
      <description>Go语言使用包（package）作为基本单元来组织源码。 package的优点 编译速度快 Go要求每个源文件在开头显示地列出所有依赖的包，如果引入了未使用的包，Go语言编译器会报错。 Go要求包之间不能存在循环依赖，这样包的依赖关系便形成了一张有向无环图，这样每个包可以单独编译也可并行编译 已编译的Go包不仅记录了该包的信息，还记录了依赖包的信息。只...</description>
      <category>Go语言</category>
      <pubDate>Sun, 27 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>Go语言使用包（package）作为基本单元来组织源码。</p>
<h2>package的优点</h2>
<h3>编译速度快</h3>
<ul>
<li>Go要求每个源文件在开头显示地列出所有依赖的包，如果引入了未使用的包，Go语言编译器会报错。</li>
<li>Go要求包之间不能存在循环依赖，这样包的依赖关系便形成了一张有向无环图，这样每个包可以单独编译也可并行编译</li>
<li>已编译的Go包不仅记录了该包的信息，还记录了依赖包的信息。只需读取缓存的编译产物即可。</li>
</ul>
<h2>初始化顺序</h2>
<p>Go语言内置函数<code>init()</code>，常用于包级数据初始化以及初始状态的检查工作。</p>
<ul>
<li>一个Go包可以有多个init()函数</li>
<li>init()函数不可显示的调用，否则会编译期间报错</li>
<li>init()只会执行一次</li>
</ul>
<p>Go包引入其他包，初始化时按照一定的次序逐一调用该包的init函数。</p>
<figure><figcaption>package-init</figcaption></figure>
<p>Go语言运行时按照常量-&gt;变量-&gt;init()顺序进行初始化。</p>
]]></content:encoded>
    </item>
    <item>
      <title>MQTT协议</title>
      <link>http://blog.cjhe.top/network/application-layer/MQTT.html</link>
      <guid>http://blog.cjhe.top/network/application-layer/MQTT.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">MQTT协议</source>
      <description>MQTT(Mesage Queuing Telemetry Transport，消息队列遥测传输协议)，是一种基于发布/订阅模式的轻量级通讯协议，该协议构建于TCP/IP协议上。 发展历史 1999年由IBM发明，起初用于原油管道数据采集监控系统，解决卫星与原油管道检测数据的传输问题。 2010 发布MQTT 3.1。 2014年在 OASIS 标准化...</description>
      <category>网络</category>
      <pubDate>Sat, 26 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>MQTT(Mesage Queuing Telemetry Transport，消息队列遥测传输协议)，是一种基于发布/订阅模式的轻量级通讯协议，该协议构建于TCP/IP协议上。</p>
</blockquote>
<h2>发展历史</h2>
<ul>
<li>1999年由IBM发明，起初用于原油管道数据采集监控系统，解决卫星与原油管道检测数据的传输问题。</li>
<li>2010 发布MQTT 3.1。</li>
<li>2014年在 <strong>OASIS</strong> 标准化组织的推动下于公布了 <a href="https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener noreferrer"><code>V3.1.1</code></a> 版本规范。</li>
<li>2019年3月发布了最新的 <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/cs02/mqtt-v5.0-cs02.html" target="_blank" rel="noopener noreferrer"><code>V5.0</code></a> 版本规范。</li>
</ul>
<h2>优点</h2>
<ul>
<li>支持QoS（设备网络环境复杂）</li>
<li>轻量且省带宽（MQTT报文紧凑，可在严重受限的硬件设备和低带宽、高延迟的网络上实现稳定传输）</li>
<li>发布订阅模式，将发布者与订阅者解耦</li>
<li>持续会话感知能力（时刻知道设备是否在线）</li>
</ul>
<h2>通信模式</h2>
<blockquote>
<p>发布/订阅模式(Publish/Subscribe)将发送消息的发布者(Publisher)与接收消息的订阅者(Subscriber)分离，之间的连接关系由代理者(Broker)进行处理。两者不直接进行通信，甚至彼此之前都不知道对方的存在。</p>
</blockquote>
<figure><figcaption>MQTT通信模式</figcaption></figure>
<h3>特点</h3>
<blockquote>
<p>发布/订阅模式的重要特性就是将消息的发布者与订阅者解耦，这种解耦体现在以下三个方面：</p>
<ul>
<li>空间解耦：发布者和订阅者不需要相互了解（例如无须交换IP地址与端口）；</li>
<li>时间解耦：发布者与订阅者的操作不需要同时运行（可下线）；</li>
<li>同步解耦：在发布或者订阅消息的过程当中，发布者和订阅者可以异步进行工作（C/S模式需要客户端或服务端等待）；</li>
</ul>
</blockquote>
<p>Broker通过某种<strong>过滤规则</strong>将Publisher的消息发送给Subscriber，该<strong>过滤规则</strong>就是<strong>Topic</strong></p>
<h2>核心概念</h2>
<h3>主题 Topic</h3>
<blockquote>
<p>MQTT 协议的<strong>主题</strong>（Topic）是指<strong>代理者</strong>用于为<strong>客户端</strong>过滤与路由消息的 <strong>UTF-8 编码字符串</strong></p>
<p>一个<strong>主题</strong>是由一个或者多个<strong>主题级别</strong>（Topic Level）构成，每个主题级别由正斜线 <code>/</code> 进行分隔。</p>
<p>例如：&lt;父级Topic名称&gt;/&lt;二级Topic名称&gt;/&lt;三级Topic名称&gt;</p>
<p>每个<strong>主题</strong>必须至少包含 1 个字符（一个单独的斜杆 <code>/</code> 也是一个有效的主题），并且主题字符串允许存在<strong>空格</strong>。</p>
<p>主题<strong>区分大小写</strong>，<code>home/temperature</code> 与 <code>Home/Temperature</code> 是 2 个不同的<strong>主题</strong>。</p>
<p>主题不需要提前创建，发布者发送消息到某个主题或订阅者订阅某个主题时，Broker就会自动创建</p>
</blockquote>
<h4>通配符</h4>
<ul>
<li>
<p>单级通配符：<code>+</code></p>
<blockquote>
<p>只能匹配一个主题级别</p>
</blockquote>
</li>
</ul>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>  例如：订阅myhome/groundfloor/+/temperature
  myhome/groundfloor/livingroom/temperature		//匹配
  myhome/groundfloor/kitchen/temperature			//匹配
  myhome/groundfloor/kitchen/brightness			//不匹配
  myhome/firstfloor/kitchen/temperature			//不匹配
  myhome/groundfloor/kitchen/fridge/temperature	//不匹配
</code></pre></div><ul>
<li>
<p>多级通配符：<code>#</code></p>
<blockquote>
<p>可以匹配多个主题级别</p>
</blockquote>
</li>
</ul>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>  例如：订阅myhome/groundfloor/#
  myhome/groundfloor/livingroom/temperature		//匹配
  myhome/groundfloor/kitchen/temperature			//匹配
  myhome/groundfloor/kitchen/brightness			//匹配
  myhome/firstfloor/kitchen/temperature			//不匹配
</code></pre></div><ul>
<li>
<p>系统保留主题：<code>$</code></p>
<blockquote>
<p>MQTT系统内部保留，用于代理者内部统计信息</p>
</blockquote>
</li>
</ul>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>  $SYS/broker/clients/disconnected
  $SYS/broker/clients/connected
  $SYS/broker/messages/sent
  $SYS/broker/clients/total
  $SYS/broker/uptime
</code></pre></div><h4>用例</h4>
<p>比如我们用传感器监视家里的卧室、客厅以及厨房的温度、湿度和空气质量，可以设计一下几个主题：</p>
<ul>
<li><code>myhome/bedroom/temperature</code></li>
<li><code>myhome/bedroom/humidity</code></li>
<li><code>myhome/bedroom/airquality</code></li>
<li><code>myhome/livingroom/temperature</code></li>
<li><code>myhome/livingroom/humidity</code></li>
<li><code>myhome/livingroom/airquality</code></li>
<li><code>myhome/kitchen/temperature</code></li>
<li><code>myhome/kitchen/humidity</code></li>
<li><code>myhome/kitchen/airquality</code></li>
</ul>
<p>当我们想获取卧室的所有数据时，可以订阅 <code>myhome/bedroom/+</code> 主题，当我们想获取三个房间的温度数据的时候，可以订阅 <code>myhome/+/temperature</code> 主题，当我们想获取所有的数据的时候，可以订阅 <code>myhome/#</code> 或者 <code>#</code>。</p>
<h4>最佳实践</h4>
<ul>
<li>切勿在主题开头使用正斜杠 <code>/</code>，避免引入一个<strong>零字符</strong>作为不必要的主题级别；</li>
<li>永远不要在主题中使用空格（包括 UTF-8 当中不同类型的空白），从而避免为阅读和调试带来不必要的困扰；</li>
<li>尽量保持主题简短，对于资源有限的物联网设备，每个字节占用的存储空间都非常重要；</li>
<li>仅使用 ASCII 字符，避免使用一些不可打印的字符；</li>
<li>将唯一标识符或者<strong>客户端</strong> ID 嵌入主题，从而方便的识别消息的发送者；</li>
<li>不要轻易直接订阅 <code>#</code>，即不要直接使用<strong>多级通配符</strong>订阅<strong>代理者</strong>上发布的全部消息，避免给<strong>订阅者</strong>带来过大的数据吞吐量；</li>
<li>优化主题层次结构，保持主题命名的长期扩展性；</li>
</ul>
<h3>服务质量 QoS</h3>
<ul>
<li>QoS-0(至多一次)：接收方不会确认收到消息，发送发也不会存储和重新传输消息，消息发布完全依赖底层TCP/IP网络，消息可能会丢失。</li>
<li>QoS-1(至少一次)：发送方会存储消息直至接收方获得确认消息的PUBACK数据包为止，确保消息到达，但可能会出现重复；</li>
<li>QoS-2(只有一次)：确保消息到达且没有重复。</li>
</ul>
<figure><figcaption>MQTT-QoS</figcaption></figure>
<p>http://www.steves-internet-guide.com/mqtt-publish-subscribe/</p>
<ul>
<li>当客户端 A 的发布 QoS 大于客户端 B 的订阅 QoS 时，服务端向客户端 B 转发消息时使用的 QoS 为客户端 B 的订阅 QoS。</li>
<li>当客户端 A 的发布 QoS 小于客户端 B 的订阅 QoS 时，服务端向客户端 B 转发消息时使用的 QoS 为客户端 A 的发布 QoS</li>
</ul>
<h3>消息类型</h3>
<ul>
<li>CONNECT/CONNACK 连接相关</li>
<li>PUBLISH/PUBACK 发布相关</li>
<li>SUBSCRIBE/SUBACK 订阅相关</li>
<li>UNSUBSCRIBE/UNSUBACK 取消订阅相关</li>
<li>PINGREQ/PINGRESP 心跳相关</li>
<li>DISCONNECT 关闭连接</li>
</ul>
<h4>CONNECT</h4>
<figure><img src="http://www.uinio.com/Embedded/MQTT/4.png" alt="MQTT-CONNECT" tabindex="0" loading="lazy"><figcaption>MQTT-CONNECT</figcaption></figure>
<ul>
<li><strong>客户端标识符</strong> <code>clientId</code>：用于标识连接到<strong>代理者</strong>的每个<strong>客户端</strong>，该标识符的取值对于<strong>代理者</strong>与<strong>客户端</strong>而言必须唯一；</li>
<li><strong>清理会话</strong> <code>cleanSession</code>：用于告知<strong>代理者</strong>，当前<strong>客户端</strong>是否需要建立持久会话；
<ul>
<li>当 <code>CleanSession = false</code> 时，<strong>代理者</strong>将存储<strong>客户端</strong>的所有订阅，以及客户端以<strong>服务质量</strong>（QoS）级别 <code>1</code> 或者 <code>2</code> 所订阅的全部遗漏消息；</li>
<li>当 <code>CleanSession = true</code> 时，<strong>代理者</strong>不但不会为<strong>客户端</strong>保存任何消息，还会清除掉来自于之前持久会话的所有消息；</li>
</ul>
</li>
<li><strong>用户名/密码</strong> <code>username</code>/<code>password</code>：用于对<strong>客户端</strong>进行认证与授权，默认为明文传输，实际应用当中应当进行加密处理；</li>
<li><strong>临终遗嘱</strong> <code>lastWill*</code>：属于 MQTT <strong>临终遗嘱</strong>（LWT，Last Will and Testament）特性的一部分，当<strong>客户端</strong>非正常断开连接时，用于发送遗嘱消息通知其它的<strong>客户端</strong>；</li>
<li><strong>保持连接</strong> <code>keepAlive</code>：用于指定<strong>客户端</strong>在连接建立时，与<strong>代理者</strong>通信的时间间隔（以<strong>秒</strong>为单位），即<strong>代理者</strong>与<strong>客户端</strong>在不发送消息的情况下，可以保持连接的最长时间；</li>
</ul>
<h4>CONNACK</h4>
<figure><img src="http://www.uinio.com/Embedded/MQTT/5.png" alt="MQTT-CONNACK" tabindex="0" loading="lazy"><figcaption>MQTT-CONNACK</figcaption></figure>
<ul>
<li>
<p><strong>会话出现标识</strong> <code>sessionPresent</code>：用于告知<strong>客户端</strong>，当前的<strong>代理者</strong>是否已经拥有了一个会话；当<strong>客户端</strong>连接消息的 <code>cleanSession = true</code> 时，由于当前没有可用的会话，所以该项总是为 <code>false</code>；而当<strong>客户端</strong>连接消息的 <code>cleanSession = false</code> 时，此时就会存在两种可能性：</p>
<ul>
<li>如果会话消息对于 <code>clientId</code> 可用，并且<strong>代理者</strong>服务已经缓存了这些会话信息，那么 <code>sessionPresent</code> 为 <code>true</code>；</li>
<li>反之，如果<strong>代理者</strong>没有任何这个 <code>clientId</code> 的会话信息，那么该项就为 <code>false</code>；</li>
</ul>
</li>
<li>
<p><strong>连接返回码</strong> <code>returnCode</code>：用于通知<strong>客户端</strong>当前连接是否成功，具体取值请参考下面表格：</p>
<p>| 返回代码 | 返回码响应                       |
| :</p>
</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>数据库</title>
      <link>http://blog.cjhe.top/database/</link>
      <guid>http://blog.cjhe.top/database/</guid>
      <source url="http://blog.cjhe.top/rss.xml">数据库</source>
      <description>记录学习数据库的过程 计划： MySQL MongoDB Redis Prometheus</description>
      <category>数据库</category>
      <pubDate>Thu, 24 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>记录学习数据库的过程</p>
</blockquote>
<p>计划：</p>
<ul class="task-list-container">
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-0" checked="checked" disabled="disabled"><label class="task-list-item-label" for="task-item-0"> MySQL</label></li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-1" disabled="disabled"><label class="task-list-item-label" for="task-item-1"> MongoDB</label></li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-2" disabled="disabled"><label class="task-list-item-label" for="task-item-2"> Redis</label></li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" id="task-item-3" disabled="disabled"><label class="task-list-item-label" for="task-item-3"> Prometheus</label></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>MySQL</title>
      <link>http://blog.cjhe.top/database/mysql/</link>
      <guid>http://blog.cjhe.top/database/mysql/</guid>
      <source url="http://blog.cjhe.top/rss.xml">MySQL</source>
      <description>MySQL是一种流行的关系型数据库管理系统，具有以下几个优点： 开源免费: MySQL采用开源许可证，可以免费获得和使用。这使得MySQL成为许多个人开发者、初创公司和中小型企业的首选数据库，可以降低成本并提高灵活性。 可靠性和稳定性: MySQL经过了广泛测试和市场验证，具有良好的稳定性和可靠性。它支持事务处理和ACID（原子性、一致性、隔离性和持久...</description>
      <category>数据库</category>
      <pubDate>Thu, 24 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>MySQL是一种流行的关系型数据库管理系统，具有以下几个优点：</p>
<ul>
<li>
<p>开源免费: MySQL采用开源许可证，可以免费获得和使用。这使得MySQL成为许多个人开发者、初创公司和中小型企业的首选数据库，可以降低成本并提高灵活性。</p>
</li>
<li>
<p>可靠性和稳定性: MySQL经过了广泛测试和市场验证，具有良好的稳定性和可靠性。它支持事务处理和ACID（原子性、一致性、隔离性和持久性）属性，保证数据的一致性和安全。</p>
</li>
<li>
<p>高性能: MySQL具有出色的性能特点，能够处理大规模的并发请求。它为多用户并发操作提供了有效的解决方案，并且优化了处理大量数据的能力。</p>
</li>
<li>
<p>可扩展性: MySQL支持水平和垂直扩展，可以根据需要增加更多的服务器、节点和存储，以应对不断增长的数据需求。它还提供了复制和分片等机制，以实现数据的复制和分布式存储。</p>
</li>
<li>
<p>灵活性: MySQL支持多种操作系统，包括Windows、Linux、macOS等，可以在各种环境中运行。它还支持多种编程语言的驱动程序和API，如Python、Java、PHP等，提供了广泛的开发和集成选项。</p>
</li>
<li>
<p>社区支持和生态系统: MySQL拥有庞大的开发者社区和活跃的生态系统，有许多开源工具、第三方库和插件可供选择。这意味着可以获得丰富的资源和支持，能够更快地解决问题和开发应用。</p>
</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>项目规范</title>
      <link>http://blog.cjhe.top/project-standard/</link>
      <guid>http://blog.cjhe.top/project-standard/</guid>
      <source url="http://blog.cjhe.top/rss.xml">项目规范</source>
      <description>这里记录平时开发过程中的项目规范，好的规范有助于： 一致性: 项目规范确保团队成员在工作中遵循相同的标准和做法，使得代码、文档、命名等保持一致。这有助于提高代码的可读性和可维护性，减少混乱和错误。 提高效率: 项目规范定义了已经验证过的最佳实践和指导原则，可以减少重复劳动和不必要的思考，提高团队成员的工作效率。规范化的流程和模板也能减少沟通成本，使得团...</description>
      <category>项目规范</category>
      <pubDate>Wed, 23 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>这里记录平时开发过程中的项目规范，好的规范有助于：</p>
<ul>
<li>
<p>一致性: 项目规范确保团队成员在工作中遵循相同的标准和做法，使得代码、文档、命名等保持一致。这有助于提高代码的可读性和可维护性，减少混乱和错误。</p>
</li>
<li>
<p>提高效率: 项目规范定义了已经验证过的最佳实践和指导原则，可以减少重复劳动和不必要的思考，提高团队成员的工作效率。规范化的流程和模板也能减少沟通成本，使得团队更高效地协同工作。</p>
</li>
<li>
<p>可维护性: 项目规范通常包括命名约定、代码结构、注释规范等，这些指导可以提高代码的可维护性。当新成员加入或者团队成员变动时，他们能够更快地理解项目的结构和代码，减轻维护负担。</p>
</li>
<li>
<p>质量控制: 项目规范可以确保项目符合良好的软件工程实践和行业标准，从而提高项目的质量。规范化的代码和流程可以减少潜在的 bug 和问题，并且提供了一致的评估标准，有助于提前发现和纠正问题。</p>
</li>
<li>
<p>可扩展性: 通过定义良好的规范并遵循它们，项目可以更容易地进行扩展和维护。合理的架构设计和规范化的开发实践可以使得项目更易于扩展，并且降低了引入新功能、改进和优化的风险。</p>
</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>进阶</title>
      <link>http://blog.cjhe.top/go-language/advance/</link>
      <guid>http://blog.cjhe.top/go-language/advance/</guid>
      <source url="http://blog.cjhe.top/rss.xml">进阶</source>
      <description>介绍Go语言进阶知识，包括遇到的一些坑和底层原理，进阶知识对于入门童鞋来说可以不用了解，并不会影响日常开发，属于深度探讨</description>
      <category>Go语言</category>
      <pubDate>Thu, 24 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>介绍Go语言进阶知识，包括遇到的一些坑和底层原理，进阶知识对于入门童鞋来说可以不用了解，并不会影响日常开发，属于深度探讨</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>基础</title>
      <link>http://blog.cjhe.top/go-language/base/</link>
      <guid>http://blog.cjhe.top/go-language/base/</guid>
      <source url="http://blog.cjhe.top/rss.xml">基础</source>
      <description>介绍Go语言基础知识，也会涉及到底层原理，这些是我认为要掌握的知识。</description>
      <category>Go语言</category>
      <pubDate>Thu, 24 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>介绍Go语言基础知识，也会涉及到底层原理，这些是我认为要掌握的知识。</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>转载</title>
      <link>http://blog.cjhe.top/go-language/reprint/</link>
      <guid>http://blog.cjhe.top/go-language/reprint/</guid>
      <source url="http://blog.cjhe.top/rss.xml">转载</source>
      <description>这里会转载我认为比较好的博文</description>
      <category>Go语言</category>
      <category>转载</category>
      <pubDate>Thu, 24 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>这里会转载我认为比较好的博文</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>退出模式</title>
      <link>http://blog.cjhe.top/design-pattern/concurrency/exit.html</link>
      <guid>http://blog.cjhe.top/design-pattern/concurrency/exit.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">退出模式</source>
      <description>退出模式 使用关键字go很容易启动goroutine，这样创建的协程和当前协程已经分离，我们并不知道 等待指定协程退出 提示 spawn函数创建的新goroutine与调用spawn函数的goroutine（main goroutine）之间通过channel建立了联系。 等待多个协程退出 提示 通过sync.WaitGroup，对于每一个协程处理前进...</description>
      <category>设计模式</category>
      <pubDate>Tue, 22 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>退出模式</h2>
<p>使用关键字<code>go</code>很容易启动goroutine，这样创建的协程和当前协程已经分离，我们并不知道</p>
<h3>等待指定协程退出</h3>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> signal <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"worker is working..."</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> signal <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> signal<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"worker start to work..."</span><span class="token punctuation">)</span>
		<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c <span class="token operator">&lt;-</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"start a worker..."</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>c
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker work done!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>spawn函数创建的新goroutine与调用spawn函数的goroutine（main goroutine）之间通过channel建立了联系。</p>
</div>
<h3>等待多个协程退出</h3>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> signal <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker %d: is working...\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker %d: works done\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> signal <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> signal<span class="token punctuation">)</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker %d: start to work...\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
			<span class="token function">f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c <span class="token operator">&lt;-</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"the group of workers start to work..."</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>c
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"the group of workers work done!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>通过sync.WaitGroup，对于每一个协程处理前进行wg.Add(1)，退出时执行wg.Done()，并等待所有的协程退出wg.Wait()。保障所有的协程都会结束。</p>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>扇入/扇出模型</title>
      <link>http://blog.cjhe.top/design-pattern/concurrency/fan-in-fan-out.html</link>
      <guid>http://blog.cjhe.top/design-pattern/concurrency/fan-in-fan-out.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">扇入/扇出模型</source>
      <description>扇出模式 即多个相同goroutine从同一个channel读取数据并处理 fan-outfan-out 输出结果 我们使用三个协程从一个channel中过滤2的倍数，分别放在三个channel输出。由于Go语言调度不确定性，因此测试结果可能不一致。 扇入模式 从多个channel读取数据并处理，将结果放入一个channel fan-infan-in ...</description>
      <category>设计模式</category>
      <pubDate>Tue, 22 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>扇出模式</h2>
<p>即多个相同goroutine从同一个channel读取数据并处理</p>
<figure><figcaption>fan-out</figcaption></figure>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestFanOut</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span>
	in <span class="token operator">:=</span> <span class="token function">echo</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span>
	c1 <span class="token operator">:=</span> <span class="token function">odd</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	c2 <span class="token operator">:=</span> <span class="token function">odd</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	c3 <span class="token operator">:=</span> <span class="token function">odd</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"c1"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> c1 <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"c2"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> c2 <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"c3"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> c3 <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>=== RUN   TestFanOut
    fan-in-fan-out_test.go:24: c1
    fan-in-fan-out_test.go:26: 1
    fan-in-fan-out_test.go:26: 7
    fan-in-fan-out_test.go:26: 9
    fan-in-fan-out_test.go:28: c2
    fan-in-fan-out_test.go:30: 3
    fan-in-fan-out_test.go:32: c3
    fan-in-fan-out_test.go:34: 5
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>管道模式</title>
      <link>http://blog.cjhe.top/design-pattern/concurrency/pipeline.html</link>
      <guid>http://blog.cjhe.top/design-pattern/concurrency/pipeline.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">管道模式</source>
      <description>管道是Unix/Linux上一种典型的并发程序设计模式，也是Unix崇尚组合设计哲学的具体体现，例如执行： 就可以利用管道机制过滤出当前路径下以&amp;quot;.go&amp;quot;结尾的文件列表。 ls -l的输出作为grep &amp;quot;\.go&amp;quot;的输入很容易将两个功能模块串在一起。 管道模式 pipelinepipeline Go通常使用channel原语构建管道模式 管道模式使用示...</description>
      <category>设计模式</category>
      <pubDate>Tue, 22 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>管道是Unix/Linux上一种典型的并发程序设计模式，也是Unix崇尚<strong>组合</strong>设计哲学的具体体现，例如执行：</p>
<div class="language-bash" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">ls</span> <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"\.go"</span>
</code></pre></div><p>就可以利用管道机制过滤出当前路径下以".go"结尾的文件列表。</p>
<p><code>ls -l</code>的输出作为<code>grep "\.go"</code>的输入很容易将两个功能模块串在一起。</p>
<h2>管道模式</h2>
<figure><figcaption>pipeline</figcaption></figure>
<p>Go通常使用channel原语构建管道模式</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> concurrency

<span class="token keyword">func</span> <span class="token function">echo</span><span class="token punctuation">(</span>nums <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> nums <span class="token punctuation">{</span>
			out <span class="token operator">&lt;-</span> n
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">square</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
			out <span class="token operator">&lt;-</span> n <span class="token operator">*</span> n
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">odd</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
			<span class="token keyword">if</span> n<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				out <span class="token operator">&lt;-</span> n
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>
</code></pre></div><p>管道模式使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> concurrency

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">func</span> <span class="token function">TestPipeline</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token function">odd</span><span class="token punctuation">(</span><span class="token function">echo</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>=== RUN   TestPipeline
    pipeline_test.go:8: 1
    pipeline_test.go:8: 9
    pipeline_test.go:8: 25
    pipeline_test.go:8: 49
    pipeline_test.go:8: 81
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>生产者/消费者模式</title>
      <link>http://blog.cjhe.top/design-pattern/concurrency/producer-consumer.html</link>
      <guid>http://blog.cjhe.top/design-pattern/concurrency/producer-consumer.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">生产者/消费者模式</source>
      <description>生产者/消费者模式是并发编程中常见的模型，该模型主要通过平衡生产者和消费者来提高程序的整体处理数据的能力 生产者/消费者模式 该模型中：生产者生产数据，放到队列中，消费者从队列中取数据。这样生产者和消费者变成异步的两个过程。 producer-consumerproducer-consumer 定义生产者 定义消费者 启动生产者和消费者模型 在这个例子...</description>
      <category>设计模式</category>
      <pubDate>Tue, 22 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p><strong>生产者/消费者</strong>模式是并发编程中常见的模型，该模型主要通过平衡生产者和消费者来提高程序的整体处理数据的能力</p>
<h2>生产者/消费者模式</h2>
<p>该模型中：生产者生产数据，放到队列中，消费者从队列中取数据。这样生产者和消费者变成异步的两个过程。</p>
<figure><figcaption>producer-consumer</figcaption></figure>
<p>定义生产者</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Producer: 生产factor倍数</span>
<span class="token keyword">func</span> <span class="token function">Producer</span><span class="token punctuation">(</span>factor <span class="token builtin">int</span><span class="token punctuation">,</span> out <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		out <span class="token operator">&lt;-</span> i <span class="token operator">*</span> factor
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义消费者</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Consumer: 消费打印队列</span>
<span class="token keyword">func</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启动生产者和消费者模型</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">Producer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">Producer</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</code></pre></div><p>在这个例子中，我们启动：</p>
<ul>
<li>两个生产者，分别生产3的倍数、5的倍数</li>
<li>一个消费者，打印队列中的数据</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>defer注意事项</title>
      <link>http://blog.cjhe.top/go-language/base/defer.html</link>
      <guid>http://blog.cjhe.top/go-language/base/defer.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">defer注意事项</source>
      <description>defer 语句能够帮助我们确保在函数结束时执行一些必要的操作，比如：关闭文件句柄、释放资源、解锁互斥锁等。defer 关键字只能作用函数或函数调用。 注意事项 执行顺序 注意 defer 语句的执行顺序是按照先进后出（FILO）的，即先进去 defer 语句将最后执行。 执行结果 43210 参数计算时机 注意 defer 语句中的函数参数会在 de...</description>
      <category>Go语言</category>
      <pubDate>Sun, 27 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>defer 语句能够帮助我们确保在函数结束时执行一些必要的操作，比如：<strong>关闭文件句柄</strong>、<strong>释放资源</strong>、<strong>解锁互斥锁</strong>等。defer 关键字只能作用函数或函数调用。</p>
<h2>注意事项</h2>
<h3>执行顺序</h3>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>defer 语句的执行顺序是按照先进后出（FILO）的，即先进去 defer 语句将最后执行。</p>
</div>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>43210</p>
</details>
<h3>参数计算时机</h3>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>defer 语句中的函数参数会在 defer 语句被声明时进行求值，而不是在实际执行时。</p>
</div>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>1</p>
</details>
<h3>遇见os.Exit</h3>
<p>主动调用os.Exit(int)退出进程时，defer将不再被执行</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"some thing..."</span><span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>some thing...
exit status 1</p>
</details>
<h3>延迟函数体</h3>
<h4>延迟函数体未传参</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>2</p>
</details>
<h4>延迟函数体传参</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>1</p>
</details>
<p>demo3和demo4的唯一区别是执行函数体是否传参，却得到完全不同的结果。</p>
<ul>
<li>demo3没有传参，无法直接计算，但是可以引用</li>
<li>demo4传入参数，可以直接计算</li>
</ul>
<h3>可能会操作并影响返回值</h3>
<h4>函数签名返回具名返回值</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<p>2</p>
</details>
<p>这是由于return并非原子操作，上面函数等价于</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  i <span class="token operator">:=</span> <span class="token number">1</span>
  result <span class="token operator">=</span> i
  result<span class="token operator">++</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>函数签名返回匿名返回值</h4>
<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>这种情况下defer语句可以引用返回值，但不会改变返回值</p>
</div>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleDeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">DeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里等价于返回了一个<code>anony</code>的匿名变量，如下所示：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>anony <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
  anony <span class="token operator">=</span> i
  i<span class="token operator">++</span>
	<span class="token keyword">return</span> anony
<span class="token punctuation">}</span>
</code></pre></div></details>
<h4>显示return常量也可能会影响返回值</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>执行结果</summary>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleDeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">DeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>虽然显示返回0，但由于return不是原子操作。等价于：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DeferDemo7</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result <span class="token operator">=</span> <span class="token number">0</span>
	result<span class="token operator">++</span>
	<span class="token keyword">return</span> 
<span class="token punctuation">}</span>
</code></pre></div></details>
]]></content:encoded>
    </item>
    <item>
      <title>Go之禅</title>
      <link>http://blog.cjhe.top/go-language/reprint/zen.html</link>
      <guid>http://blog.cjhe.top/go-language/reprint/zen.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go之禅</source>
      <description>Python的核心开发成员之一Tim Peter写下的《The Zen of Python》，成为Python编程和设计的指导原则。Go语言步道师Dave Cheney 2020年发表了名为《The Zen of Go》 译文 Each package fulfils a single purpose 每一个package实现单一目标 A well d...</description>
      <category>Go语言</category>
      <category>转载</category>
      <pubDate>Tue, 15 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<blockquote>
<p>Python的核心开发成员之一Tim Peter写下的《The Zen of Python》，成为Python编程和设计的指导原则。Go语言步道师Dave Cheney 2020年发表了名为《The Zen of Go》</p>
</blockquote>
<h2>译文</h2>
<h3>Each package fulfils a single purpose 每一个package实现单一目标</h3>
<p>A well designed Go package provides a single idea, a set of related behaviours. A good Go package starts by choosing a good name. Think of your package’s name as an elevator pitch to describe what it provides, using just one word.
精心设计的Go软件包只提供单一功能和一系列相关的行为。一个好的Go软件包从选择一个好的名字开始。把你的包的名字想象成一个电梯广告，仅用一个词来描述它所提供的功能。</p>
<h3>Handle errors explicitly 显式处理错误</h3>
<p>Robust programs are composed from pieces that handle the failure cases before they pat themselves on the back. The verbosity of if err != nil { return err } is outweighed by the value of deliberately handling each failure condition at the point at which they occur. Panic and recover are not exceptions, they aren’t intended to be used that way.
健壮的程序是由处理失败case的各个片段组成的。 冗长的<code>if err != nil { return err }</code> 比出了故障再一个个去处理更有价值。Panic和recover也一样。</p>
<h3>Return early rather than nesting deeply 尽早return，不要深陷</h3>
<p>Every time you indent you add another precondition to the programmer’s stack consuming one of the 7 ±2 slots in their short term memory. Avoid control flow that requires deep indentation. Rather than nesting deeply, keep the success path to the left using guard clauses.
每缩进一次，就会在程序员的堆栈中增加一个前提条件，占用其短时记忆中 7 ±2 个插槽中的一个。避免需要深度缩进的控制流。与其深度嵌套，不如使用保护子句将成功路径保持在左侧。</p>
<h3>Leave concurrency to the caller 并发权留给调用者</h3>
<p>Let the caller choose if they want to run your library or function asynchronously, don’t force it on them. If your library uses concurrency it should do so transparently.
让调用者自己选择是否要异步运行你的库或函数，不要强迫他们。如果您的程序库使用并发功能，则应透明地使用。</p>
<h3>Before you launch a goroutine, know when it will stop 在启动goroutine之前，要知道它什么时候会停止</h3>
<p>Goroutines own resources; locks, variables, memory, etc. The sure fire way to free those resources is to stop the owning goroutine.
goroutine 拥有锁、变量、内存等资源。释放这些资源的可靠方法是停止拥有资源的 goroutine。</p>
<h3>Avoid package level state 避免包级状态</h3>
<p>Seek to be explicit, reduce coupling, and spooky action at a distance by providing the dependencies a type needs as fields on that type rather than using package variables.
通过将类型所需的依赖关系作为该类型的字段而不是使用包变量来提供，力求显式化，减少耦合，并实现超距作用。</p>
<h3>Simplicity matters 简单很重要</h3>
<p>Simplicity is not a synonym for unsophisticated. Simple doesn’t mean crude, it means readable and maintainable. When it is possible to choose, defer to the simpler solution.
简单不是容易（不复杂）的同义词。简单并不意味着粗糙，它意味着可读性和可维护性。如果可以选择，请遵循较简单的解决方案。</p>
<h3>Write tests to lock in the behaviour of your package’s API 编写测试以确定包API的行为</h3>
<p>Test first or test later, if you shoot for 100% test coverage or are happy with less, regardless your package’s API is your contract with its users. Tests are the guarantees that those contracts are written in. Make sure you test for the behaviour that users can observe and rely on.
先测试还是后测试，是追求 100% 的测试覆盖率还是满足于较低的测试覆盖率，无论如何，软件包的应用程序接口都是您与用户之间的契约。测试是这些合约的保证。请确保您测试的是用户可以观察和依赖的行为。</p>
<h3>If you think it’s slow, first prove it with a benchmark 如果你觉得慢，先用基准来证明</h3>
<p>So many crimes against maintainability are committed in the name of performance. Optimisation tears down abstractions, exposes internals, and couples tightly. If you’re choosing to shoulder that cost, ensure it is done for good reason.
以性能为名，对可维护性犯下了许多罪行。优化会破坏抽象概念，暴露内部结构，并造成紧密耦合。如果你选择承担这种代价，请确保这样做是有充分理由的。</p>
<h3>Moderation is a virtue 节制是一种美德</h3>
<p>Use goroutines, channels, locks, interfaces, embedding, in moderation.
适度使用goroutines、channels、locks、interfaces、embedded。</p>
<h3>Maintainability counts 可维护性很重要</h3>
<p>Clarity, readability, simplicity, are all aspects of maintainability. Can the thing you worked hard to build be maintained after you’re gone? What can you do today to make it easier for those that come after you?
清晰度、可读性、简洁性都是可维护性的体现。你辛辛苦苦创建的东西在你离开后还能被维护吗？你今天能做些什么来让你的后人更容易地维护它？</p>
<h2>参考文献</h2>
<p><a href="https://the-zen-of-go.netlify.app" target="_blank" rel="noopener noreferrer">简洁版</a>
<a href="https://dave.cheney.net/2020/02/23/the-zen-of-go" target="_blank" rel="noopener noreferrer">完整版</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>Go箴言</title>
      <link>http://blog.cjhe.top/go-language/reprint/proverb.html</link>
      <guid>http://blog.cjhe.top/go-language/reprint/proverb.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go箴言</source>
      <description>【转】原文链接 Go 语言之父 Rob Pike 在 2015 年分享的主题《Go Proverbs》 核心理念是：简单、诗意、简洁（Simple, Poetic, Pithy）。 译文 Don&amp;apos;t communicate by sharing memory, share memory by communicating. 不要通过共享内存进行通信，通过...</description>
      <category>Go语言</category>
      <category>转载</category>
      <pubDate>Tue, 15 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>【转】<a href="http://go-proverbs.github.io/" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<blockquote>
<p>Go 语言之父 Rob Pike 在 2015 年分享的主题《Go Proverbs》</p>
<p>核心理念是：简单、诗意、简洁（Simple, Poetic, Pithy）。</p>
</blockquote>
<h2>译文</h2>
<p>Don't communicate by sharing memory, share memory by communicating.
不要通过共享内存进行通信，通过通信共享内存</p>
<p>Concurrency is not parallelism.
并发不是并行</p>
<p>Channels orchestrate; mutexes serialize.
管道用于协调；互斥锁用于同步</p>
<p>The bigger the interface, the weaker the abstraction.
接口越大，抽象就越弱</p>
<p>Make the zero value useful.
利用好零值</p>
<p>interface{} says nothing.
空接口 interface{} 没有任何类型约束</p>
<p>Gofmt's style is no one's favorite, yet gofmt is everyone's favorite.
Gofmt 的风格不是人们最喜欢的，但 gofmt 是每个人的最爱</p>
<p>A little copying is better than a little dependency.
允许一点点重复比引入一点点依赖更好</p>
<p>Syscall must always be guarded with build tags.
系统调用必须始终使用构建标记进行保护</p>
<p>Cgo must always be guarded with build tags.
必须始终使用构建标记保护 Cgo</p>
<p>Cgo is not Go.
Cgo 不是 Go。</p>
<p>With the unsafe package there are no guarantees.
使用标准库的 unsafe 包，不能保证能如期运行</p>
<p>Clear is better than clever.
清晰比聪明更好</p>
<p>Reflection is never clear.
反射永远不清晰</p>
<p>Errors are values.
错误是值</p>
<p>Don't just check errors, handle them gracefully.
不要只检查错误，还要优雅地处理它们</p>
<p>Design the architecture, name the components, document the details.
设计架构，命名组件，文档记录细节</p>
<p>Documentation is for users.
文档是供用户使用的</p>
<p>Don't panic.
不要使用 panic</p>
<h2>参考文献</h2>
<p><a href="http://go-proverbs.github.io/" target="_blank" rel="noopener noreferrer">原文链接</a>
<a href="https://zhuanlan.zhihu.com/p/514680942" target="_blank" rel="noopener noreferrer">中文译文</a></p>
]]></content:encoded>
    </item>
    <item>
      <title></title>
      <link>http://blog.cjhe.top/CHANGELOG.html</link>
      <guid>http://blog.cjhe.top/CHANGELOG.html</guid>
      <source url="http://blog.cjhe.top/rss.xml"></source>
      <description>v0.11.0 (2024-04-14) 🐛Bug Fixes 修改vuepress icon 修复bug devops: 修改helm-dashboard go-language: 修改map，增加一些注意事项 go-language: defer增加遇见os.Exit go-language: 修改数据类型 ♻️Code Refactoring ...</description>
      <pubDate>Thu, 03 Aug 2023 13:57:06 GMT</pubDate>
      <content:encoded><![CDATA[<p><a name="v0.11.0"></a></p>
<h2><a class="header-anchor" href="#v0-11-0-2024-04-14"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.10.1...v0.11.0" target="_blank" rel="noopener noreferrer">v0.11.0</a> (2024-04-14)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>修改vuepress icon</li>
<li>修复bug</li>
<li><strong>devops:</strong> 修改helm-dashboard</li>
<li><strong>go-language:</strong> 修改map，增加一些注意事项</li>
<li><strong>go-language:</strong> defer增加遇见os.Exit</li>
<li><strong>go-language:</strong> 修改数据类型</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整devops到k8s子类</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>devops:</strong> 增加redis监控</li>
<li><strong>devops:</strong> 增加mysql监控</li>
<li><strong>devops:</strong> 增加记录docker执行报错问题</li>
<li><strong>devops:</strong> 增加helm-dashboard简介</li>
<li><strong>devops:</strong> 增加kube-state-metrics k8s 部署</li>
<li><strong>devops:</strong> 增加cadvisor k8s部署</li>
<li><strong>devops:</strong> 增加node-exporter k8s部署</li>
<li><strong>devops:</strong> 增加Prometheus k8s部署</li>
<li><strong>go-language:</strong> 增加Go项目脚手架</li>
<li><strong>network:</strong> 增加HTTP协议介绍</li>
</ul>
<p><a name="v0.10.1"></a></p>
<h2><a class="header-anchor" href="#v0-10-1-2023-09-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.10.0...v0.10.1" target="_blank" rel="noopener noreferrer">v0.10.1</a> (2023-09-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> 修改flag标准库，增加底层原理</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整目录顺序</li>
</ul>
<p><a name="v0.10.0"></a></p>
<h2><a class="header-anchor" href="#v0-10-0-2023-09-20"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.9.2...v0.10.0" target="_blank" rel="noopener noreferrer">v0.10.0</a> (2023-09-20)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> 修改第三方库</li>
<li><strong>project-language:</strong> 提交规范增加参考文献</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>go-language:</strong> 增加三方库pflag介绍</li>
</ul>
<p><a name="v0.9.2"></a></p>
<h2><a class="header-anchor" href="#v0-9-2-2023-09-11"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.9.1...v0.9.2" target="_blank" rel="noopener noreferrer">v0.9.2</a> (2023-09-11)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> flag增加子命令</li>
<li><strong>go-language:</strong> 修改flag</li>
</ul>
<h3>✨Features</h3>
<ul>
<li>增加Go语言标准库</li>
</ul>
<p><a name="v0.9.1"></a></p>
<h2><a class="header-anchor" href="#v0-9-1-2023-09-05"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.9.0...v0.9.1" target="_blank" rel="noopener noreferrer">v0.9.1</a> (2023-09-05)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改创建型设计模式</li>
</ul>
<p><a name="v0.9.0"></a></p>
<h2><a class="header-anchor" href="#v0-9-0-2023-09-02"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.8.0...v0.9.0" target="_blank" rel="noopener noreferrer">v0.9.0</a> (2023-09-02)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>go-language:</strong> 修改Go语言简介</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>go-language:</strong> 增加defer和recover注意事项</li>
<li><strong>go-language:</strong> 增加package介绍</li>
<li><strong>network:</strong> 增加MQTT介绍</li>
</ul>
<p><a name="v0.8.0"></a></p>
<h2><a class="header-anchor" href="#v0-8-0-2023-08-22"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.7.1...v0.8.0" target="_blank" rel="noopener noreferrer">v0.8.0</a> (2023-08-22)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改并发模式</li>
<li><strong>go-language:</strong> 修改Go之禅中模糊的含义</li>
<li><strong>go-language:</strong> 修改slice</li>
<li><strong>middleware:</strong> 修改监控系统至中间件</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>markdown格式优化</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>go-language:</strong> 增加Go之禅</li>
<li><strong>go-language:</strong> 转载Go箴言</li>
</ul>
<p><a name="v0.7.1"></a></p>
<h2><a class="header-anchor" href="#v0-7-1-2023-08-13"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.7.0...v0.7.1" target="_blank" rel="noopener noreferrer">v0.7.1</a> (2023-08-13)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>design-pattern:</strong> 修改设计原则</li>
<li><strong>go-language:</strong> 修改Go语言基础</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整函数模式和并发模式</li>
</ul>
<p><a name="v0.7.0"></a></p>
<h2><a class="header-anchor" href="#v0-7-0-2023-08-07"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.6.0...v0.7.0" target="_blank" rel="noopener noreferrer">v0.7.0</a> (2023-08-07)</h2>
<h3>♻️Code Refactoring</h3>
<ul>
<li>侧边栏可折叠</li>
<li>调整目录结构</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>design-pattern:</strong> 增加选项模式</li>
</ul>
<p><a name="v0.6.0"></a></p>
<h2><a class="header-anchor" href="#v0-6-0-2023-08-03"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.5.0...v0.6.0" target="_blank" rel="noopener noreferrer">v0.6.0</a> (2023-08-03)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>修改设计模式</li>
<li>配置页面元数据</li>
<li>自动化部署问题修复</li>
<li>删除临时文件</li>
<li><strong>design-pattern:</strong> 修改设计模式问题</li>
<li><strong>project-stanard:</strong> 修改项目规范一些问题</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整侧边栏和导航栏</li>
<li>调整导航栏和侧边栏</li>
<li><strong>databae:</strong> 优化数据库查询</li>
</ul>
<h3>✨Features</h3>
<ul>
<li>增加变更日志</li>
<li>增加Go语言爱好者周刊友情链接</li>
<li>切换为vuepress-theme-hope</li>
</ul>
<p><a name="v0.5.0"></a></p>
<h2><a class="header-anchor" href="#v0-5-0-2022-05-24"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.4.0...v0.5.0" target="_blank" rel="noopener noreferrer">v0.5.0</a> (2022-05-24)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>database:</strong> 增加事务一致性视图</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>go-language:</strong> 修改操作符</li>
<li><strong>go-language:</strong> 调整数组与切片</li>
<li><strong>go-language:</strong> 字符串调整</li>
<li><strong>go-language:</strong> 数组与切片调整</li>
<li><strong>go-language:</strong> 调整变量、常量及命名规则</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>database:</strong> 增加mysql读过程、写过程和事务</li>
<li><strong>database:</strong> 增加redis大纲</li>
<li><strong>go-language:</strong> 增加break使用说明</li>
<li><strong>go-language:</strong> 增加for-range注意点</li>
<li><strong>go-language:</strong> 增加字符串底层结构</li>
<li><strong>go-language:</strong> 增加map介绍</li>
</ul>
<p><a name="v0.4.0"></a></p>
<h2><a class="header-anchor" href="#v0-4-0-2022-03-27"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.4...v0.4.0" target="_blank" rel="noopener noreferrer">v0.4.0</a> (2022-03-27)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>algorithm:</strong> 增加限流-令牌桶算法</li>
<li><strong>project-standard:</strong> 增加语义化版本工具</li>
<li><strong>project-standard:</strong> 增加语义化版本详细外链</li>
<li><strong>project-standard:</strong> 增加readme.so外链</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>database:</strong> 增加MySQL-表连接</li>
<li><strong>go-language:</strong> 增加一些环境变量说明</li>
<li><strong>tools:</strong> 增加CA证书</li>
</ul>
<p><a name="v0.3.4"></a></p>
<h2><a class="header-anchor" href="#v0-3-4-2022-03-20"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.3...v0.3.4" target="_blank" rel="noopener noreferrer">v0.3.4</a> (2022-03-20)</h2>
<h3>✨Features</h3>
<ul>
<li><strong>algorithm:</strong> 增加限流算法</li>
</ul>
<p><a name="v0.3.3"></a></p>
<h2><a class="header-anchor" href="#v0-3-3-2022-03-03"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.2...v0.3.3" target="_blank" rel="noopener noreferrer">v0.3.3</a> (2022-03-03)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>project-standard:</strong> 项目管理改为项目规范</li>
</ul>
<p><a name="v0.3.2"></a></p>
<h2><a class="header-anchor" href="#v0-3-2-2022-02-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.1...v0.3.2" target="_blank" rel="noopener noreferrer">v0.3.2</a> (2022-02-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>data-structure:</strong> 删除二叉搜索树迭代版本</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li>调整结构和描述</li>
</ul>
<p><a name="v0.3.1"></a></p>
<h2><a class="header-anchor" href="#v0-3-1-2022-02-23"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.3.0...v0.3.1" target="_blank" rel="noopener noreferrer">v0.3.1</a> (2022-02-23)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>data-structure:</strong> 修改二叉搜索树删除节点算法</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>data-structure:</strong> 修改删除最小节点命名</li>
</ul>
<p><a name="v0.3.0"></a></p>
<h2><a class="header-anchor" href="#v0-3-0-2022-02-20"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.2.0...v0.3.0" target="_blank" rel="noopener noreferrer">v0.3.0</a> (2022-02-20)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>data-structure:</strong> 侧边栏修复</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>data-structure:</strong> 增加二叉搜索树</li>
<li><strong>data-structure:</strong> 增加二叉树</li>
</ul>
<p><a name="v0.2.0"></a></p>
<h2><a class="header-anchor" href="#v0-2-0-2022-02-11"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.1.0...v0.2.0" target="_blank" rel="noopener noreferrer">v0.2.0</a> (2022-02-11)</h2>
<h3>✨Features</h3>
<ul>
<li><strong>project-manager:</strong> 增加分支规范</li>
</ul>
<p><a name="v0.1.0"></a></p>
<h2><a class="header-anchor" href="#v0-1-0-2022-02-09"><span></span></a><a href="https://github.com/Hexiaopi/hexiaopi.github.io/compare/v0.0.1...v0.1.0" target="_blank" rel="noopener noreferrer">v0.1.0</a> (2022-02-09)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li><strong>project-manager:</strong> 修正目录规范</li>
</ul>
<h3>✨Features</h3>
<ul>
<li><strong>commit:</strong> 增加语义化版本自动生成工具gsemver配置和介绍</li>
<li><strong>commit:</strong> 增加CHANGE LOG自动生产</li>
<li><strong>docs:</strong> 增加变更历史</li>
<li><strong>project-manager:</strong> 增加目录规范</li>
</ul>
<p><a name="v0.0.1"></a></p>
<h2>v0.0.1 (2022-02-03)</h2>
<h3>🐛Bug Fixes</h3>
<ul>
<li>更新侧边栏</li>
<li>update sidebar</li>
<li>project manager</li>
<li><strong>monitor-system:</strong> 统一图片文件夹命名</li>
<li><strong>project-manager:</strong> 更新提交规范</li>
<li><strong>project-manager:</strong> update version</li>
</ul>
<h3>♻️Code Refactoring</h3>
<ul>
<li><strong>go-language:</strong> 调整结构</li>
<li><strong>go-language:</strong> 调整结构</li>
</ul>
<h3>✨Features</h3>
<ul>
<li>增加CHANGE LOG</li>
<li>增加版本规范</li>
<li>项目文档规范</li>
<li>add project manager</li>
<li>add README.md</li>
<li><strong>design-pattern:</strong> add some design pattern</li>
<li><strong>project-manager:</strong> add api standard</li>
<li><strong>project-manager:</strong> add api standard</li>
<li><strong>project-manager:</strong> add commit standard</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>工厂模式的比较</title>
      <link>http://blog.cjhe.top/design-pattern/creational/factory-compare.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/factory-compare.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">工厂模式的比较</source>
      <description>简单工厂模式、工厂方法模式、抽象工厂模式都可以统称为工厂模式，其中： 简单工厂模式：适用于需要根据客户端的输入来创建对象的场景，但不符合开闭原则，随着产品的增加需要修改工厂类。 工厂方法模式：通过将具体产品的创建延迟到子类中实现，符合开闭原则，每个具体工厂类负责创建一个具体产品。 抽象工厂模式：适用于需要创建一组相关产品对象的场景，每个具体工厂类负责创...</description>
      <category>设计模式</category>
      <pubDate>Mon, 31 Jul 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>简单工厂模式、工厂方法模式、抽象工厂模式都可以统称为工厂模式，其中：</p>
<p>简单工厂模式：适用于需要根据客户端的输入来创建对象的场景，但不符合<code>开闭原则</code>，随着产品的增加需要修改工厂类。</p>
<p>工厂方法模式：通过将具体产品的创建延迟到子类中实现，符合<code>开闭原则</code>，每个具体工厂类负责创建一个具体产品。</p>
<p>抽象工厂模式：适用于需要创建一组相关产品对象的场景，每个具体工厂类负责创建一组相关产品。</p>
<p>选择适合的创建型设计模式取决于具体的项目需求和设计考虑，简单工厂模式简单易懂但可扩展性差，工厂方法模式更灵活但需要额外的子类，而抽象工厂模式适用于创建一组相关的产品对象。</p>
]]></content:encoded>
    </item>
    <item>
      <title>介绍页</title>
      <link>http://blog.cjhe.top/intro.html</link>
      <guid>http://blog.cjhe.top/intro.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">介绍页</source>
      <description>介绍页 profile-details profile-language commit-language stats time</description>
      <pubDate>Sun, 30 Jul 2023 09:20:01 GMT</pubDate>
      <content:encoded><![CDATA[
<p><img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/0-profile-details.svg" alt="profile-details" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/1-repos-per-language.svg" alt="profile-language" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/2-most-commit-language.svg" alt="commit-language" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/3-stats.svg" alt="stats" loading="lazy">
<img src="https://raw.githubusercontent.com/Hexiaopi/Hexiaopi/master/profile-summary-card-output/github/4-productive-time.svg" alt="time" loading="lazy"></p>
]]></content:encoded>
      <enclosure url="http://blog.cjhe.top/assets/images/cover3.jpg" type="image/jpeg"/>
    </item>
    <item>
      <title>幻灯片页</title>
      <link>http://blog.cjhe.top/slides.html</link>
      <guid>http://blog.cjhe.top/slides.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">幻灯片页</source>
      <pubDate>Sun, 30 Jul 2023 09:20:01 GMT</pubDate>
      <content:encoded><![CDATA[<!-- markdownlint-disable MD024 MD033 MD051 -->
]]></content:encoded>
      <enclosure url="http://blog.cjhe.top/logo.svg" type="image/svg+xml"/>
    </item>
    <item>
      <title>设计模式</title>
      <link>http://blog.cjhe.top/design-pattern/</link>
      <guid>http://blog.cjhe.top/design-pattern/</guid>
      <source url="http://blog.cjhe.top/rss.xml">设计模式</source>
      <description>提示 面向对象是武器 设计模式是招式 设计原则是心法 以心法为基础，以武器运用招式应对复杂的编程问题</description>
      <category>设计模式</category>
      <pubDate>Sat, 10 Sep 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>面向对象是<strong>武器</strong></p>
<p>设计模式是<strong>招式</strong></p>
<p>设计原则是<strong>心法</strong></p>
<p>以心法为基础，以武器运用招式应对复杂的编程问题</p>
</div>
<!-- more -->
<h2>什么是设计模式</h2>
<p>设计模式最早来源于建筑领域</p>
<blockquote>
<p>克里斯托弗.亚历山大在作品《建筑的永恒之道》中这样说："每个模式都描述了一个在我们的环境中不断出现的问题，然后描述了该问题的解决方案的核心，通过这种方式，我们可以无数次地重用那些已有的成功的解决方案，无须再重复相同的工作。"</p>
</blockquote>
<p>之后四人组（Gang of Four，简称GoF）将模式的概念应用在软件开发设计中，定义如下：</p>
<blockquote>
<p>它是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结。</p>
<p>它描述了在软件设计过程中的一些不断重复发生的问题，以及该问题的解决方案。</p>
</blockquote>
<p>简单来说，就是<strong>解决特定问题的一系列解决方案</strong>，是前辈们的代码设计经验的总结。</p>
<h2>有哪些优点</h2>
<ul>
<li><strong>提高代码复用性</strong>：设计模式的核心目标之一是提供可复用的解决方案。通过使用设计模式，可以将通用的解决方法应用于不同的情况，从而减少代码的冗余和重复编写。</li>
<li><strong>提高代码的可读性和可维护性</strong>：设计模式通过引入一定的结构和规范，使代码更有组织性和可读性。开发人员可以更轻松地理解和维护代码逻辑。</li>
<li><strong>降低代码耦合度</strong>：设计模式通过将系统分解为多个独立的部分，每个部分都有明确定义的职责和接口，从而降低了代码的耦合度。这使得系统更易于扩展、修改和维护。</li>
<li><strong>提高系统的可扩展性和灵活性</strong>：设计模式鼓励使用接口和抽象类进行编程，而不是具体的实现类。这种松耦合的设计使得系统更易于扩展，可以方便地引入新的功能和模块。</li>
<li><strong>提高系统的可测试性</strong>：设计模式将系统分解为多个独立的部分，每个部分都可以独立测试。这样可以更容易地编写和执行单元测试，提高代码的质量和可靠性。</li>
</ul>
<h2>有哪些要素</h2>
<ul>
<li><strong>问题</strong>：问题或称为上下文、场景，指在软件开发中需要解决的某个问题或需求。设计模式通常解决针对特定上下文或场景中出现的问题。</li>
<li><strong>解决方案</strong>：解决方案或称为模型、模式，是指用于解决上述问题的通用方法或最佳实践。设计模式描述了解决某问题的方法或模板，并提供了这些方法的实现细节，使得类似问题可以被解决且易于复用。</li>
<li><strong>效果</strong>：效果或称为结果、贡献，是指使用该模式带来的好处和优点。设计模式提供了可重用、灵活的解决方案，增加可维护性、可扩展性和可重用性。</li>
<li><strong>元素</strong>：元素或称为参与者、角色、类和对象，组成了设计模式的各个部分。这些元素可以是类、对象、接口、方法等等。元素描述了在特定上下文或场景中参与模式实现的各种组件。</li>
</ul>
<h2>具体分类</h2>
<figure><figcaption>分类</figcaption></figure>
]]></content:encoded>
    </item>
    <item>
      <title>设计原则</title>
      <link>http://blog.cjhe.top/design-pattern/principle.html</link>
      <guid>http://blog.cjhe.top/design-pattern/principle.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">设计原则</source>
      <description>设计原则是心法，对于构建高质量的软件系统提供指导和约束，它具有以下作用： 提高代码质量：设计原则强调代码的清晰性、可读性和可维护性。通过遵循设计原则，可以编写出更结构化、更模块化的代码，减少代码重复和冗余。 降低耦合度：设计原则鼓励松散耦合的设计，将系统划分为更小的、相互独立的模块。这样可以减少模块之间的依赖关系，提高系统的灵活性和可扩展性。 促进代码...</description>
      <category>设计模式</category>
      <pubDate>Sat, 15 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>设计原则是心法，对于构建高质量的软件系统提供<strong>指导</strong>和<strong>约束</strong>，它具有以下作用：</p>
<ul>
<li>提高代码质量：设计原则强调代码的清晰性、可读性和可维护性。通过遵循设计原则，可以编写出更结构化、更模块化的代码，减少代码重复和冗余。</li>
<li>降低耦合度：设计原则鼓励松散耦合的设计，将系统划分为更小的、相互独立的模块。这样可以减少模块之间的依赖关系，提高系统的灵活性和可扩展性。</li>
<li>促进代码重用：设计原则推崇封装、继承、多态等面向对象的特性，使得代码更易于重用。通过设计模式和设计原则，可以将通用的解决方案抽象出来，并在不同的场景中重复应用。</li>
<li>简化系统维护：良好的设计原则可以减少系统的耦合和复杂度，使系统更易于理解和维护。当需要对系统进行修改或扩展时，通过遵循设计原则，可以更快速、更安全地进行变更。</li>
<li>提高团队协作效率：设计原则提供了一种通用的设计思维和规范，使整个团队在设计和开发过程中能够更好地进行交流和协作。团队成员可以共同理解和遵循设计原则，降低沟通成本，提高开发效率。</li>
</ul>
<!-- more -->
<h2>SOLID原则</h2>
<p>SOLID原则是由罗伯特·C·马丁在21世纪早期引入，指代了面向对象编程和面向对象设计的五个基本原则。遵循SOLID原则可以确保我们设计的代码是易维护、易扩展、易阅读的。SOLID原则同样也适用于Go程序设计。具体SOLID编码原则见下表：</p>
<p>| 简写 | 全称                                | 中文描述     |
|</p>
]]></content:encoded>
    </item>
    <item>
      <title>高质量代码</title>
      <link>http://blog.cjhe.top/design-pattern/quantity-code.html</link>
      <guid>http://blog.cjhe.top/design-pattern/quantity-code.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">高质量代码</source>
      <description>提示 什么样的代码才是高质量的代码❓</description>
      <category>设计模式</category>
      <pubDate>Tue, 01 Nov 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>什么样的代码才是高质量的代码❓</p>
</div>
<!-- more -->
<h2>什么是高质量代码</h2>
<p>代码质量的评价有很强的主观性，描述代码质量的词汇也有很多，比如可读性、可维护性、灵活、优雅、简洁等，这些词汇是从不同的维度去评价代码质量的。它们之间有互相作用，并不是独立的，比如，代码的可读性好、可扩展性好就意味着代码的可维护性好。代码质量高低是一个综合各种因素得到的结论。我们并不能通过单一的维度去评价一段代码的好坏。</p>
<h3>可维护性（maintainability）</h3>
<blockquote>
<p>维护：无外乎就是修改bug、修改老的代码、添加新的代码之类的工作。</p>
</blockquote>
<p><strong>维护代码的时间远远大于编写代码的时间</strong>
其中：</p>
<ul>
<li>代码易维护：在不破坏原有代码设计、不引入新的bug的情况下，能够快速地修改或者添加代码。</li>
<li>代码不易维护：修改或者添加代码需要冒着极大的引入新bug的风险，并且需要花费很长的时间才能完成。</li>
</ul>
<h3>可读性（readability）</h3>
<blockquote>
<p>可读：代码易读易理解</p>
</blockquote>
<p><strong>代码被阅读的次数远远超过被编写的次数</strong>
我们可以从以下方面来评价：</p>
<ol>
<li>代码是否符合编码规范；</li>
<li>命名是否达意；</li>
<li>注释是否详尽；</li>
<li>函数是否长短合适；</li>
<li>模块划分是否清晰；</li>
<li>是否符合高内聚低耦合；</li>
</ol>
<h3>可扩展性（extensibility）</h3>
<blockquote>
<p>可扩展：代码应对未来需求变化的能力</p>
</blockquote>
<p><strong>开闭原则：对修改关闭，对扩展开放</strong>
评判标准：</p>
<ul>
<li>我们在不修改或少量修改原有代码的情况，通过扩展的方式添加新的功能代码；</li>
<li>代码预留了一些功能扩展点，不需要因为添加一个功能而大动干戈，改动大量的原始代码；</li>
</ul>
<h3>灵活性（flexibility）</h3>
<blockquote>
<p>灵活：代码易扩展、易复用或者易用</p>
</blockquote>
<p>举例如下：</p>
<ul>
<li>
<p>易扩展：当我们添加一个新的功能代码的时候，原有的代码已经预留好了扩展点，我们不需要修改原有的代码，只要在扩展点上添加新的代码即可。这个时候，我们除了可以说代码易扩展，还可以说代码写得好灵活。</p>
</li>
<li>
<p>易复用：当我们要实现一个功能的时候，发现原有代码中，已经抽象出了很多底层可以复用的模块、类等代码，我们可以拿来直接使用。这个时候，我们除了可以说代码易复用之外，还可以说代码写得好灵活。</p>
</li>
<li>
<p>易用：当我们使用某组接口的时候，如果这组接口可以应对各种使用场景，满足各种不同的需求，我们除了可以说接口易用之外，还可以说这个接口设计得好灵活或者代码写得好灵活。</p>
</li>
</ul>
<h3>简洁性（simplicity）</h3>
<blockquote>
<p>简洁：代码简单、逻辑清晰</p>
</blockquote>
<p><strong>KISS原则：“Keep it Simple,Stupid”</strong>
怎么评判呢？每个人的标准都不一样，我觉得能够快速理解业务逻辑就是简单的。"思从深而行从简，真正的高手能云淡风轻地用最简单的方法解决最复杂的问题。"</p>
<h3>可复用性（reusability）</h3>
<blockquote>
<p>可复用：尽量减少重复代码的编写，复用已有的代码。</p>
</blockquote>
<p><strong>DRY原则：“Don't Repeat Yourself”</strong>
使用技巧：</p>
<ul>
<li>面向对象特性：继承和多态就是为了提高可复用性；</li>
<li>解耦、高内聚、模块化等思想都能提高代码的可复用性；</li>
<li>单一职责原则与可复用性相关；</li>
</ul>
<h3>可测试性（testability）</h3>
<blockquote>
<p>可测试：能否方便地测试代码逻辑</p>
</blockquote>
<p>评判标准：</p>
<ul>
<li>即便有存储和第三方服务也能测试；</li>
<li>不依赖各个环境；</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>如何不靠运气变得富有</title>
      <link>http://blog.cjhe.top/other/how-to-get-rich-without-getting-lucky.html</link>
      <guid>http://blog.cjhe.top/other/how-to-get-rich-without-getting-lucky.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">如何不靠运气变得富有</source>
      <description>【转】原文链接</description>
      <category>转载</category>
      <pubDate>Tue, 11 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>【转】<a href="https://github.com/fat-garage/how-to-get-rich-without-getting-lucky" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<p>如何不靠运气变得富有</p>
<blockquote>
<p>Naval 是美国风险投资家，这是他的3小时长播客《如何不靠运气变得富有》的中文翻译，介绍了他的财富观，非常值得一读。</p>
</blockquote>
<h2>瞄一瞄这👇</h2>
<ol>
<li>本文搬运自【胖车库】公众号，译者<a href="https://www.notion.so/918aecdf7acc476f9cbba7836996c3fe" target="_blank" rel="noopener noreferrer">Jessie</a>&amp;<a href="https://github.com/wangmingyue123" target="_blank" rel="noopener noreferrer">明月</a>。胖车库是一个有意思人类的收集计划（开发者、创业者、自由职业者，还有你）和DAO去中心化协作实验室，看看大家都在不同领域做着什么样新的尝试，希望给你未来的可能性提供一些想象力。<strong>杰西和她的朋友们也会在胖车库第一时间更新<a href="https://mp.weixin.qq.com/s/c-yx-WfWcld1Z2tNpYJxlQ" target="_blank" rel="noopener noreferrer">“如何不靠运气变得富有”系列</a></strong>，欢迎大家一起来玩耍 🎤。</li>
</ol>
<figure><img src="https://i.imgur.com/WubW2ud.jpg" alt="胖车库" tabindex="0" loading="lazy"><figcaption>胖车库</figcaption></figure>
<ol start="2">
<li>哈哈哈，😏 其实我还整理出<a href="https://www.notion.so/taosu/Updating-faf1fa3dbcc34e60b443506e76a9c1ab" target="_blank" rel="noopener noreferrer">notion版</a>和<a href="https://cdn.jsdelivr.net/gh/taosue/how-to-get-rich-without-getting-lucky@master/%E5%A6%82%E4%BD%95%E4%B8%8D%E9%9D%A0%E8%BF%90%E6%B0%94%E5%8F%98%E5%BE%97%E5%AF%8C%E6%9C%89(%E4%B8%8A)_Naval%20%EF%BC%88%E8%91%97%EF%BC%89%26Jessie%EF%BC%88%E8%AF%91%EF%BC%89.pdf" target="_blank" rel="noopener noreferrer">PDF版</a>(我就把PDF导进去iPad，在iPad上看书📚)，大家戳戳链接就可以看到了。</li>
</ol>
<h2>第一条：追求财富，而不是金钱或地位</h2>
<p>Nivi：你可能听说过Naval在推特上进行的那一波主题为“如何在不只依靠运气的情况下致富”的推特风暴（tweetstorm）。我们借助这个播客回顾大部分的推文，给Naval一个机会详细聊聊这些话题。他可能会提出一些以前没有发表过的想法。</p>
<p>Naval是AngelList创始人和Epinions的联合创始人。他是一位眼光独到的科技投资人，投出了像Twitter、Uber这样的科技公司。</p>
<p>不只是科技行业的人，各行各业的人都想知道<strong>如何解决他们「钱的问题」</strong>。每个人都隐约地意识到自己想要变得富有，但是他们没有一套好的原则来遵守和践行。</p>
<h3>财富是你睡觉时还能产生收入的资产</h3>
<p>Nivi：财富、金钱和地位有什么区别?</p>
<p>Naval：财富是你渴望的东西，是你睡觉时还在产生收入的财产。举例来说，财富是在夜间还能运行的为其他客户服务的计算机程序。财富是你存在银行里的钱，用于再投资其他资产和业务。</p>
<p>房子是财富的一种形式，因为你可以把它租出去，收得租金，尽管这是一种比经营商业企业更低效的土地使用方式。</p>
<p>我对财富的定义是指那些可以在<strong>你睡觉时依然可以为你赚钱的企业和资产</strong>。</p>
<h3>财富的终极目标是自由</h3>
<p>你渴望财富，是因为它能给你带来自由。也就是说，你不必像白领那样一丝不苟的系领带；你不必早上6点就起床、996挤地铁上下班；你不必把时间浪费在一份没有灵魂，你不喜欢的工作上。</p>
<p><strong>我们创造财富就是为了自由，仅此而已</strong>。而不是去买毛皮大衣，不是去开法拉利，不是去驾驶游艇，也不是去乘坐湾流飞机环游世界。那些东西很快就会变得无聊和愚蠢。它（财富）是关于<strong>你如何成为你自己的事</strong>。</p>
<p>除非你真的想要财富，否则你不会得到它。全世界都想要它，全世界都在为此努力。在某种程度上，它是有竞争力的。这是一个正和博弈，但其中也有竞争因素，因为现在社会上的资源是有限的。为了获得资源去做你想做的，你必须脱颖而出。</p>
<h3>金钱是我们转移财富的方式</h3>
<p>金钱是社会信用，它是一种从别人的时间中获得信用和债务的能力。如果我做对了工作，为社会创造了价值，社会会说：“哦，谢谢你。我们欠你一些东西，将来会补偿你。这是我的借条，我们把它叫做钱吧。”</p>
<p>钱会贬值是因为,</p>
<ul>
<li>人们偷了借据</li>
<li>政府增发货币</li>
<li>人们违背IOU</li>
</ul>
<p>但是金钱试图成为社会的一个可靠的欠条，因为你在为自己的付出而被他人亏欠。我们把这些欠条到处传递，金钱是我们转移财富的方式。</p>
<h3>地位是你在社会等级中的地位</h3>
<p>人生基本上有两大游戏。一个是金钱游戏。钱并不能解决你所有的问题，但它会解决你所有的和钱相关的问题。我想大家都能意识到这一点，所以才想赚钱。同时，在内心深处，许多人认为他们做不到，所以他们不希望任何财富创造发生。他们攻击那些赚钱的企业和企业家们，说他们：“赚钱是罪恶的。你不应该这么做。”但他们实际上在玩另一个游戏，那就是地位游戏。他们试图传递一种信息“我不需要钱，我们不要钱。”</p>
<p>地位指的是你在社会等级中的地位。</p>
<p><strong>财富不是零和游戏</strong>。世界上每个人都可以拥有一所房子，你有房子并不会影响我有房子的能力。如果有什么区别的话，建造的房屋越多，建造房屋就越容易，我们对建造房屋的了解就越多，就会有更多的人拥有房屋。</p>
<p><strong>财富是一个正和游戏</strong>。我们一起创造，努力创造着寄托着我们美好期待的“艺术品”来解释我们正在做的事情。最终，一些全新的东西将被创造出来。这是一个正和游戏。</p>
<p>另一方面，<strong>地位是一个零和游戏</strong>。这是一个非常古老的游戏。我们从原始人部落开始就玩这个游戏了。也就是等级制度。老大是谁？老二是谁？老三是谁？老三打败了老二，老二就必须让位。所以，地位是一个零和游戏。</p>
<h2>第二条：为世界创造更多</h2>
<p><strong>财富不是从别人那里拿走什么，而是为这个世界创造更多</strong></p>
<h3>财富创造带来了世界的丰富</h3>
<p>Naval：有一种观点认为赚钱是邪恶的，这个说法好像起源于“金钱是万恶之源”。人们认为银行家偷走了我们的钱，这在某种程度上是正确的，在世界上的很多地方，有很多偷窃行为一直在发生。</p>
<p>从某种意义上说，世界的历史就是创造者和索取者之间的捕食者/被捕食者关系。有些人走出去创造东西，建造东西，努力创造机会。有些人带着剑、枪，或者经济上我们说税收、裙带资本主义，共产主义等等形式，进行着不同形式的偷窃。即使在自然界，寄生生物也比非寄生生物多。你身上有很多寄生虫，它们靠你生存。好的情况是共生，他们会回馈一些东西。但也有很多只是索取。这就是任何复杂系统的本质。</p>
<p>我关注的是真正的财富创造。这不是仅为了赚钱，不是单纯从别人那里拿东西。</p>
<p>显而易见的是，工作不是有限的，财富也不是有限的。否则，我们还会坐在洞穴里，琢磨着如何瓜分柴火，或者偶尔运气好时捕食到的一些死鹿。</p>
<p>人类文明中的大部分财富，事实上是全部财富，都是被创造出来的。它是从某处产生的。它是由人创造，由科技创造，由生产力创造的。它是通过努力创造出来的。这种被窃取的想法是一种可怕的零和游戏，人们试图获得地位的游戏。</p>
<h3>每个人都可以变得富有</h3>
<p>但现实是，每个人都可以变得富有。我们可以看到，在第一世界国家，基本上每个人都比200年前活着的人富有。200年前，没有人使用抗生素，没有人有汽车，没有人能用电，没有人有iPhone。所有这些都是使我们作为一个物种变得更富有的发明。今天，我宁愿在第一世界国家做一个穷人，也不愿在路易十四的法国做一个富人。这是因为财富的创造。</p>
<p>技术的引擎是科学，其目的是创造丰富性。所以，我认为从根本上来说，每个人都可以变得富有。</p>
<p>我想让你们想象这样一种情形。如果每个人都掌握一个好的软件工程师和一个好的硬件工程师的技能，你可以自己造机器人，开发程序，自己建桥，并为它们编程。假设每个人都知道怎么做。</p>
<p>那你认为20年后的社会会是什么样子？我的猜测是，我们会造出各种各样的机器人、机器、软件和硬件来做任何事情。我们都会生活得非常富足。我们基本上就退休了，因为我们都不用为任何基本的东西工作。我们甚至会有机器人护士，会有机器驱动的医院，会有自动驾驶汽车。我们会有100%自动化的农场，会有清洁能源。那时，我们可以利用技术上的突破来得到我们想要的一切。如果有人还在工作，那么他们是在用工作来表达他们的创造力。</p>
<p>我不认为资本主义是邪恶的。资本主义实际上是好的，它只是被劫持了，被不当的外部成本定价所劫持。它被不正当的收益所劫持，在那里有腐败，或者有垄断。</p>
<h2>第三条：自由市场是人类固有</h2>
<p><strong>我们是唯一跨越基因界限进行合作的动物，因为我们可以在自愿的交换中追踪信用(credit)和债务(debt)</strong></p>
<h3>自由市场是人类社会固有的</h3>
<p>Naval：全面的资本主义(意味着自由市场)是人类社会固有的。资本主义不是我们发明的，甚至不是我们发现的东西。它天然存在于我们的每一次交换中。当你和我交换信息时，你一定想从我这里得到一些信息。如果我们没有良好的信息交流，你会去找别人。所以，交换就是在记录信用和债务，这是我们作为灵活的社会动物与生俱来的本领。</p>
<p>我们是动物王国中唯一跨越种群进行合作（协作）的动物。大多数动物只会成群合作，共同进化，它们血液相连，所以它们有一些共同的兴趣。人类没有这种成群合作的能力，也不需要这么麻烦。就算你是塞尔维亚人，他是波斯人，我是印度人，没有任何血缘关系，但我们仍然可以合作。</p>
<p>什么让我们合作？因为我们可以记录借方和贷方。谁投入了多少工作？谁贡献了多少？这就是自由市场资本主义。因此，我坚信这是人类与生俱来的，我们将为每个人创造越来越多的财富。</p>
<p>每个人都可以变得富有，每个人都可以退休，每个人都可以成功。这只是一个<strong>教育和欲望</strong>的问题。前提是你必须想要它。如果你不想要，没关系，没人强迫你参与游戏。但是不要试图贬低那些积极参与游戏的人。他们没准儿就是那些能让你晚上睡在温暖舒适的床上，让你能更方便的买到全世界的东西，让你能拿着嗡嗡作响的iPhone开心刷抖音的人。因此，这是一场美妙的比赛，值得我们从伦理上、理性上、道德上去挑战一次。它将继续使我们所有人越来越富有，直到我们为任何想要的人创造大量财富。</p>
<h3>太多的索取者而没有足够的创造者将使一个社会陷入毁灭</h3>
<p>Nivi：不只是个人在暗地里鄙视财富，对吧？有些国家、团体和政党公然蔑视财富。至少看起来是这样。</p>
<p>Naval：没错。这些国家、政党和团体正在沦为一场零和博弈。在摧毁财富创造的过程中，他们把每个人都拉低到和他们一样的水平。</p>
<p>这就是为什么美国是一个非常受移民欢迎的国家，因为美国梦。显然，不同的人对财富的定义是不同的。第一世界公民对财富的定义可能是，“我一定要赚到数百万美元。而对于第三世界的贫穷移民来说，当刚进入这个国家的时候，我们只是贫穷的移民，对财富的预期值会更低。它可能只是，“我不需要在我的余生做我不想做的体力劳动。”</p>
<p>但是鄙视它的群体会把整个群体带到和他们一样的水平。如果有太多的索取者，而没有足够的创造者，社会就会分崩离析。你最终会变成一个共产主义国家。看看委内瑞拉就知道，他们不停的忙于获取、分割和重新分配，人们在街上挨饿，每年都因为饥饿而失去几公斤的体重。</p>
<p>另一种思考方式是想象一个有太多寄生虫的有机体。你需要少量的寄生虫来保持健康。你需要很多的共生体。所有细胞中帮助我们呼吸和燃烧氧气的线粒体。这些是帮助我们生存的共生体。没有他们我们无法生存。</p>
<p>但是，对我来说，他们（共生体）是一起创造财富的伙伴，共同创造了人类的身体。但是如果你体内充满了寄生虫，如果你感染了蠕虫，或者病毒，或者细菌，而这些都是单纯的寄生，你就会死亡。所以，任何生物都只能抵抗少量的寄生虫。当寄生元素失去控制时，你就死定了。</p>
<p>我说的还是道德财富创造，不是垄断，也不是裙带资本主义。我说的是自由思想，自由市场。人与人之间的小规模交流是自愿的，不会对他人产生太大的影响。我认为这种财富创造，如果一个社会不尊重它，如果一个群体不尊重它，那么这个社会就会陷入毁灭和黑暗。</p>
<h2>第四条：致富与运气无关</h2>
<h3>致富与运气无关，要掌握致富的技能</h3>
<p>Naval：很明显，我们想要在这一生中不只依靠运气变得富有。很多人认为赚钱是靠运气。它不是，关键是你要成为那种能赚钱的人。比如，假设我输光了所有的财产，你把我随便扔到任何一个说英语的国家的大街上，不出5到10年，我就会再次变得富有（笑）。因为这是一种技能，而且我认为每个人都可以拥有这种技能。在1000个平行宇宙中，你想在其中999个里变得富有。你不想只在靠运气成分的50个里面变得富有对吧？</p>
<p>我们在这讲的运气有四种。这个分类来于一本书，a16z的马克·安德森(Marc Andreessen)在Pmarca.com这个博客中曾经提到过。</p>
<ol>
<li>狗屎运</li>
</ol>
<p>第一种就是狗屎运。你完全无法控制这种走运，俗话说这就是命好。</p>
<ol start="2">
<li>坚持不懈的实干运</li>
</ol>
<p>这种幸运来自于坚持、努力、不停的尝试和行动。当你四处奔波创造了各种各样的机会，这期间你输出了很多能量，你做了很多事情，会有大量的能量交换。</p>
<p>你可能会说，人们只有志趣相投才能聚在一起。那我举另外一个例子，Nenad把他做的很棒的动画视频放到了网上，我在Twitter上看到了它们。从这个意义上说，他通过制作视频创造了自己的运气，直到像我这样的人源源不断找到他。</p>
<ol start="3">
<li>早有预备的运气</li>
</ol>
<p>第三种方法是你变得非常善于发现运气。如果你在某个领域非常精通，你会注意到在那个领域幸运的事件是如何发生的。当其他人没有注意到它的时候，你会变得对运气敏感，这是通过技能、知识和工作经验的积累达成的。</p>
<p>4.独特的人格给你带来的好运</p>
<p>最后一种运气是最奇怪、最艰难的一种，但这就是我们要讨论的。在这里，你建立了一个独特的人格，一个独特的品牌，一个独特的心态，然后好运会找到你。</p>
<p>例如，假设你是世界上最擅长深海潜水的人。大家都知道，你会进行别人都不敢尝试的深海潜水。然后，有人幸运的在海岸外发现了一艘沉没的宝藏船。他们没办法拿到，只能跑来找你求助。也就是说，他们的运气同时变成了你的运气，你会因此得到非常丰厚的报酬。这是一个比较极端的例子。那个找到宝藏的幸运儿们，走的是狗屎运。但他们不得不来找你帮忙把宝藏拿出来，最终你会得到一部分这里面的财富，这不是运气。也就是说，虽然这个好运的起始不是你，但是你能让那些发现好运的人在关键时刻想起你，很明显你可以在其中起到不可替代的作用。这种情况下你既成就了别人，又分享了他人的好运，这就是你为什么要打造自己独特的个性和品牌。</p>
<h3>在1000个平行宇宙中，你想在其中999个里变得富有</h3>
<p>Nivi：你刚刚提到，在1000个平行宇宙中，你可以在其中的999个变得富有？我想有些人看到后会说：“这听起来不太可能，太夸张了吧。”</p>
<p>Naval：不，我不认为这是不可能的。考虑到你的起步条件，我认为你可能得再努力一点。我在印度的时候是个穷孩子，所以如果我能成功，从这个意义上说，任何人都能。很明显，我四肢健全，智力正常，当然我也确实接受了教育。也许有一些前提条件不一样，但如果你在听这个视频或播客，说明你已经掌握了基本的技能，而且有一个功能健全的身体和会思考大脑。</p>
<p>事实上，一路上我其实遇到了很多倒霉事。我赚的第一笔钱，立刻就在股票市场上赔了个精光。我赚的第二笔钱，或者说我应该赚的第二笔钱，基本上都被我的商业伙伴骗走了。这次（成功）已经是第三次了。</p>
<p>即便如此，财富的积累仍处于缓慢而稳定的挣扎之中。我这辈子还没一次性赚过一大笔钱，总是一大堆小事堆积在一起。它更多的是通过持续的构建商业（做创业公司）、寻找投资机会来持续创造财富。这绝对不是一步登天的事。</p>
<h3>财富不是一步登天</h3>
<p>我的个人财富不是在某一年产生的，它是一点点堆积起来的，每一个阶段积累一点。更多的选择，更多的生意，更多的投资，才能撬开更多自己能做的事情。和Nenad的illacertus一样，他在油管上做了一系列视频，没有任何一个视频会在一夜之间让他一夜暴富，这绝对是一个漫长的过程，学习，阅读，创造，这期间会产生复利效应。</p>
<p>我们谈论的是变得富有，这样你就可以退休，你就有更多的自由。退休不是说什么都不做。而是说你不必去任何你不想去的地方，你不必做任何你不想做的事，你想什么时候醒来就什么时候醒来，你想什么时候睡觉就什么时候睡觉，没有老板对你指手画脚。这就是自由。我们谈论的是足够的财富来获得自由。特别是由于互联网的普及，机会到处都是。坦白讲，我有太多的方法来赚钱，我满脑子都是想法，唯一缺的就是时间。创造财富、创造产品、创造企业、创造机会，从社会获得报酬的方式太多了。</p>
<h2>第五条：你必须有点异乎寻常，才能独自走在前沿</h2>
<p>Naval在他的博客中还提到了一些关于第四种运气的有趣例子，但我想让读者了解的一点是，第四种运气其实是来自于你异乎寻常（这里用了eccentric这个词）的行为，所以有时候异乎寻常可能并不是一件坏事。</p>
<p>Naval：没错，因为这个世界非常讲求效率，每个人都在明显的地方挖掘着新奇的、未被发现的东西，这会帮助你建立优势。独自走在前沿可能需要你有点异乎寻常，而且愿意比一般人挖掘得更深，挖掘的更深仅仅因为你感兴趣。</p>
<p>Nivi：对，除了本杰明·迪斯雷利的那句话外，我看过的两句表达这种运气的话，一个是山姆·阿尔特曼（Samuel Altman）说的，“极端的人才能得到极端的结果。”“我认为这句话很好。还有另一个来自斯坦福大学教授杰弗里·普费弗（Jeffrey Pfeffer）的观点，“你不可能既正常又期待异常回报。”</p>
<p>Naval：是的。我喜欢的一句与之完全相反的话是，“玩愚蠢的游戏的人赢愚蠢的奖品。”“很多人花很多时间在社交媒体上，比如你试图在Twitter上提高你的社会地位，但你基本上赢得了愚蠢的、价值不大的社交奖项。</p>
<p>Nivi：我想我从这篇博客文章中得到的最后一个观点是，除了狗屎运，你应该去追求这几种运气（尤其是最后一个），这会让你变得越来越幸运。</p>
<p>Naval：是的，起码能回归均值（笑）。所以，你至少要中和运气，这样才能更好的发挥你自己的才能。</p>
<h2>第六条：出租时间不会让你变得富有</h2>
<h3>出租时间不会让你变得富有，因为你不能非线性地赚钱</h3>
<p>Nivi：接下来你会详细介绍如何致富，以及什么不会有助于致富。第一点是：“出租你的时间不会让你变得富有。<strong>你必须拥有公司的股权，才能获得财务自由。</strong>”</p>
<p>Naval：这可能是最重要的一点。人们似乎认为你可以创造财富，通过工作致富。这可能行不通，原因有很多。最根本的原因是，你的投入和产出相关性太强。几乎在任何有薪水的工作中，即使是像律师或医生这样每小时报酬很高的工作，你仍然在投入时间，你的报酬是按每小时或工作量计价。因此，这意味着当你睡觉的时候，在度假的时候，你没有在创造财富；一旦你退休了，你就没有收入了（退休金另当别论）。也就是说，你不可能得到非线性的收入。</p>
<p>如果你看到一些医生非常富有，那是因为他们成立了公司，开了私人诊所。他们通过私人诊所建立了一个品牌，为他们带来持续的口碑和客户。或者他们制造了某种医疗设备或一个程序，且拥有这些东西的知识产权。</p>
<p>因此，本质上你是在为别人工作，而那个人承担了风险和责任，掌握着知识产权，有品牌。所以，他们不会给你足够的工资，他们会付给你最低工资，让你做他们需要的工作。这可能是一个很高的最低限度，但仍然不是你想象的退休后真正的财富。</p>
<h3>出租时间赚钱意味着你很容易被替代</h3>
<p>最后，你甚至没有为社会创造出那么多原创的东西。正如我所说，这场推特风暴应该被称为“如何创造财富”，只不过“如何致富”是一个更吸引人的标题罢了。因为你现在扮演的是固定的角色，而大多数固定角色的任务是可以教会的。如果他们能像在学校那样被教授，那么最终你将会和一个更年轻的、拥有最新知识的人竞争，这个人注定是要取代你的。</p>
<p>更可能的是，你做的工作最终会被机器人或人工智能取代。它甚至不需要一夜之间取代，它可以一次替换一点。所以，基本上在出租时间的模式下（也就是打工），投入和产出是匹配的，但我不认为这是真正创造财富的方式。</p>
<h3>你必须拥有股权才能获得财务自由</h3>
<p>所以每个真正想要致富的人在某种程度上都拥有一个产品，一个企业，或者某种知识产权。它可以是股票或者期权，这也是为什么很多人选择在早期科技公司工作。这是一个很好的开始方式。</p>
<p>但通常真正的财富是通过创办自己的公司，甚至是通过投资来创造的。投资一家公司或者说入股，其实有很多通往财富的路径并不按照小时计数。</p>
<h3>追求一份投入与产出“不匹配”的工作</h3>
<p>为什么你真的需要追求一份投入和产出“不匹配”的工作或者职业，这将会在之后的推特风暴中提到。拥有高创造力和高影响力的企业往往是那些你可以工作一小时的企业，这一小时可能会产生巨大的影响；或者你做了1000个小时的工作，但是没有效果。</p>
<p>我们拿软件行业为例。一方面，一个伟大的工程师可以创造比特币，创造数十亿美元的价值。另一方面，如果一个工程师一直在错误的方向下功夫，或者做得不够好、不够有创意、深思熟虑等等。就算他辛勤工作整整一年，他们发布的每一段代码最终都不会被使用，他都不会有用户。这是一个投入和产出高度分离的行业的例子，它不是以你投入的时间多少来衡量产出的。</p>
<p>再举一个极端的例子，假设你是世界上最好的伐木工人，如果你不用工具，或用最简单的工具（比如一把斧子或者一把锯子）伐木，你也只会比最差的伐木工人强三倍，因为投入和产出是有很强的相关性的，不会有很大的区别。</p>
<p>因此，你要寻找投入和产出高度不相关的职业。这是另一种可以产生杠杆效应的方式。我说的杠杆并不是指华尔街讲的金融杠杆，这个“杠杆”名声不好。我说的杠杆是指工具，人类擅长使用的工具。计算机是软件工程师使用的工具。对于一个伐木工人，如果有推土机、自动机械轴和锯子，他就会使用这些工具，比那些徒手想要把树连根拔起的人更有影响力。</p>
<p>工具和杠杆是造成投入和产出之间不匹配的原因。一个职业的创造力成分越高，它就越有可能有不匹配的投入和产出。因此，我认为，如果你考虑从事投入和产出高度相关的职业，那在这个过程中，你很难给社会创造财富，也很难为自己创造财富。</p>
<h2>第七条：我们应该升级自己的自由，而不是生活方式</h2>
<p><strong>生活水平远低于其收入水平的人们享受着一种自由，这种自由是那些忙于改善生活方式的人们无法理解的</strong>
Nivi：除了把时间租出去之外，还有其他无助于致富的事情吗?</p>
<p>Naval：有，我之前提到过两条相关的推文。我说的第一个问题是，你的生活方式应该升级，但不应该升级得太快。这句话的大意是说，<strong>生活水平远远低于其收入水平的人享受着一种自由</strong>，而那些忙于提升生活方式的人根本无法体会这种自由。我认为这是非常重要的，不要总是忙于升级你的生活水平。事实上，如果你能在赚越来越多的钱时，保持稳定的生活水平和期望，就不会有太多烦恼。所以，不要总想着住更大的房子，过更奢侈的生活，以及所有类似的贪心。</p>
<h3>世界上最危险的东西是海洛因和月薪</h3>
<p>假设你现在的工资是每小时1000美元，你肯定不是从20美元每小时的月薪立马涨到1000美元，这一定是个漫长职业生涯的积累过程。这里面一个微妙的问题是，你的生活水平会随着你赚的钱越来越多而升级。你会想当然的认为自己赚了钱，就该马上去提升生活水平，但这会使你深陷在工资奴隶的陷阱里。我忘了是谁，可能是纳西姆·塔勒布说的，“<strong>世界上最危险的东西是海洛因和月薪。</strong>”没错，因为它们很容易上瘾。你想要变得富有的方式恰恰是你想要变穷，那时你能做（想做）的事情只有工作，工作，再工作。</p>
<h3>理想的情况是，你的赚钱路径是离散的</h3>
<p>这就是科技产业的运作方式。你十年没赚到钱，然后突然在第11年，你会赚得盆满钵盈。顺便说一下，这就是为什么这些所谓的富人的高边际税率是有缺陷的，因为风险最高，最具创造力的职业一定是，前十年都在赔钱。在冒着巨大的风险时，你会不停的流血，流血，再流血。然后在第11年，或第15年，你可能突然赚到一大笔钱。此时山姆大叔（这里指政府）出现了，说：“嘿，你知道吗，你今年赚了很多钱。因此，你是邪恶的，你必须把一切都交给我们。”因此，它只是摧毁了那些创造性的冒险职业。但理想的情况是，你的致富路径是离散的，循序渐进的。这样你不会期待你的生活水平更新的那么快。一旦你致富之后，你还会选择工作，但你只会在你想做的时候做你想做的事，这才是真正的自由。因此，你会做更多创造性的事情，而减少对钱，对奢侈生活的关注。</p>
<h2>第八条：给社会提供它不知道如何获得的东西</h2>
<p><strong>社会会因为你创造了它想要、却不知道如何大规模获取的东西，而给你丰厚的回报</strong></p>
<h3>给社会它需要的，但不知道如何规模化获取的东西</h3>
<p>Nivi：你不会因为出租时间而发财的。但你说，“你会通过给社会它想要，但不知道如何规模化获取的东西而致富。”</p>
<p>Naval：没错。所以本质上，就像我们之前说的，钱是社会给你的欠条，你在过去做了一些好事，社会会为你创造它想要的东西而付钱。但社会还不知道如何创造这些东西，因为如果已经被创造了，他们就不需要你了。
几乎所有在你家里、工作场所和街道上的东西曾经都是科技产品。有一段时间石油是一种科技产品，这让洛克菲勒很富有；有段时间汽车是科技产品，这使亨利·福特富有。因此，正如丹尼•希利斯(Danny Hillis)所说，技术只是一套还不太管用的东西。一旦某样东西成功了，它就不再是技术了。所以，社会总是想要新事物。</p>
<h3>想清楚你能提供的产品，然后考虑如何扩大规模</h3>
<p>如果你想要变得富有，弄清楚你可以为社会提供哪些它想要、但还不知道如何获取的东西。并且是你感兴趣、在你的能力范围内能提供的东西。想清楚之后，下一步你要考虑如何规模化。因为如果你只造一个，那是不够的。你必须建造成千上万个，上百万个，甚至数十亿个。最好的情况是，每个人都可以有一个。史蒂夫·乔布斯和他的团队当然知道社会需要智能手机。他们口袋里的电脑拥有所有电话功能的100倍，而且使用方便。所以，他们想出了如何建造它，然后他们想出了如何扩展它。他们想出了如何让每个第一世界国家的公民，最终也让每个第三世界国家的公民，都能拥有一个。正因为如此，他们获得了丰厚的回报，苹果是世界上最有价值的公司。</p>
<p>Nivi：我想说的是，企业家的工作是为大众市场带来高端产品。</p>
<p>Naval：它以高端开始。首先，这是一种创造性的行为，<strong>你创造它只是因为你想要它</strong>。你想要它，需要它，所以你知道如何建造它。其实一开始<strong>你是为自己建造它</strong>。然后你要想办法把它带给其他人。然后有一段时间，富人拥有它。比如，富人有私人司机，他们有黑色高档汽车。然后优步（Uber）出现了，它让每个人都有自己的私人司机。现在你甚至可以看到Uber pool正在取代穿梭巴士，因为它更方便。然后scooter共享电动滑板车出现了，市场进一步下沉。所以规模化需要考虑的是，<strong>如何把曾经只是富人拥有的东西给到给每个人</strong>。</p>
<h2>第九条：互联网极大地丰富了职业发展的可能性</h2>
<p><strong>互联网会给你的小众兴趣找到买单的人</strong></p>
<h3>互联网极大扩展了职业发展的可能性</h3>
<p>Nivi：让我们看看下一条推文，这也是我觉得对于你将从事什么工作或者职业非常隐秘和超级有趣的推文。你说：“互联网极大拓宽了职业发展的可能性，但是大多数人目前并没有察觉到。”</p>
<p>Naval：互联网最根本的颠覆性是，它使这个星球上的人们能彼此联系，任何一个人只要你想联系总有方法。不论是给他们发邮件，在Twitter上发送推文，还是在Facebook上发布一点他们能看到的动态，或者建立一个他们能来访问的网站。互联网将每一个人都联系在了一起。因此互联网是一个将各个网络连接起来的工具，这就是它的超能力。因此，工具给你了，你要思考怎么去更好的利用它。你要明白，借助互联网，你就总能为你的产品、你的才能、你的技艺找到观众，不论他们来自哪里。</p>
<p>举个例子，Nenad制作了IIIacertus，试想一下，如果你是在互联网出现之前看到的他的视频，那么他需要怎么做才能让你看到呢？他可能抱着电脑挨家挨户展示给他的邻居们看？或者跑到当地的电影院播放？这都是不可能的，他只有把视频放到互联网上才能达到这个效果。然后在这个世界上又有多少人对它真正的感兴趣呢？或者只是对我们正在讨论的东西感兴趣，真正的吸收？结果会发现只有很少一部分人，所以关键就在能触动<strong>这些人</strong>。</p>
<h3>互联网能让你的小众兴趣找到观众</h3>
<p>互联网最怪异的一点是，它允许各种小众兴趣存在。这就好像养蛇的人、喜欢坐热气球的人、喜欢一人独叶孤舟航游世界的人，亦或是痴迷于微型烹饪的人。就像整个日本的微型烹饪现象一样（哈哈今天刚刚看了一本日本烹饪书叫鸡蛋料理），或者像有一个节目是关于女人帮人收拾家务的节目，对吧？</p>
<p>因此，无论你拥有多么小众化的兴趣，互联网都能提供给你一个很好的平台去把它规模化。当然，这也不是说你所做的就是下一个Facebook，或者你能获得数以十亿计的用户，但是，如果你仅仅想找到5万个和你一样满怀热情的人，互联网中就有这样一群观众等待着你。</p>
<p>这个问题的绝妙之处就在于，我们生活的星球上有70亿的人。人类DNA的组合方式达到了难以想像的程度。每个人都是一个完全不同的个体，你不可能遇到另一个一模一样的你。</p>
<p>这不像你可以说，“恩...，Nivi，离开我的生活吧。这样我可以让Naval进入我的生命中，我就可以有和他同样的感受，得到同样的赞许，有同样的想法。”但事实不是这样的，任何人不是别人的替代品，人与人完全不同的。因此，正是因为每个人有不同的技能、兴趣，才可以在自己独特的事物上发挥创造力。</p>
<p>但是（在互联网）之前这些并不重要，在前互联网时代，如果你住在意大利的一个小渔村，你的渔村并不一定需要完全独特的技能，那么你就必须遵从现实，从事仅有的工作。但是今天，你可以变得完全独特和独立。</p>
<p>互联网可以让你低成本的「走出去」，找到属于自己的观众。然后你通过创建业务、创造产品、积累财富，你通过在互联网上展现独特的你让大众获得快乐。你事业的发展空间就会因互联网而扩大，电子竞技玩家，在Fortnite上赚了数百万美元。YouTube广播公司、 博客、播客，让人们能够创建内容和上传视频。我听说乔·罗根（Joe Rogan），他的播客有20亿次下载，这为他每年带来约1亿美元的收入。</p>
<p>再举一个PewDiePie的例子，前几天，我转发了一条有趣的推文。PewDiePie在新闻媒体中简直就是信任的代名词。这个来自瑞典的小孩，他的热门新闻频道的流量是主流有线网络流量的三倍。而且这仅仅是在他的新闻频道上， 还不算他的娱乐频道。</p>
<p>可以说互联网为各种小众兴趣提供了沃土，但前提是你要擅于将其壮大发展起来。当然，好消息就是每个人生而不同，每个人都有自己擅长的东西。所以要真实做自己。</p>
<h3>通过做自己来规避无意义的竞争</h3>
<p>还有一条值得一提的推文，它没有被收录到这个推文风暴中。那条是“通过做自己来规避无意义的竞争”。事实上，当你在与人竞争时，往往是因为你在复制别人，因为你在努力干着同样的事情。但是其实每个人生而不同，不要总是忙着复制别人。</p>
<p>很明显，人类喜欢模仿，René Girard有一套完整的模仿理论很有趣。大家都觉得模仿简单，但其实模仿远比你做自己要难。所以不要纯模仿，不要纯复制，专注于做自己的事情，当你真正在做自己时，你就会发现没有人能和你竞争，就是这么简单。</p>
<p>因此，你对你自己是谁和你喜欢做什么认识的越深入，你就会面临越少的竞争。也就是说，当你意识到真实做自己没人能和你竞争后，你就能够通过真实性逃离竞争陷阱。但是，这在前互联网时代是没用的建议，而后互联网时代你能将这些变成现实。</p>
<h2>第十条：寻找财富游戏中的长期战友</h2>
<p><em>选择一个你可以和长期伙伴玩长期游戏的行业，所有的回报都来自于多次游戏的复利。</em></p>
<h3>寻找财富游戏中的长期战友</h3>
<p>Nivi：我们来聊聊应该考虑在哪些行业工作？应该做什么样的工作？最好和什么样的人一起工作？这些话题。你说过，“你应该选择的行业是，在这里你有长期战友和你玩长期的游戏。”</p>
<p>Naval：是的，<strong>这是解释为什么硅谷会成功，也是对高信任度社会能够成功的深刻理解</strong>。事实上，生活中所有的收益都来自于复利。无论是在人际关系中，创造财富中，或是在学习中。因此，复利是一种神奇的力量，如果你以1倍的价格开始，然后如果每年增长20%，并且持续30年，你得到的不只是额外的30年乘以20%。它有复利效应，所以它会增长，增长，增长，最后你得到的回报将会不可思议。不管是善意、爱情、人际关系还是金钱。所以，我认为复利是一种非常重要的力量。</p>
<p>为什么致富是一场持久战？长期博弈不仅对复利有利，对信任也有利。如果你看一下囚徒困境类型的游戏，囚徒困境的一个解决方案是以牙还牙，也就是我将对你做你上次对我做过的事，如果你犯了错，我会原谅你。但这只适用于重复的囚徒困境的环境中，换句话说，如果我们重复玩一个游戏多次。</p>
<p>因此，如果你处在这样一种情况下，比如你在硅谷，人们在那里互相做生意。他们彼此了解，相互信任，互相帮助，因为他们知道这个人会在下一场比赛的回合中出现，你迟早会遇到这些人。</p>
<p>当然，这并不总是奏效。也有情况是，有的人在硅谷一举成名，赚到很多钱，但人们会背叛彼此，因为他们只是想，“我要靠这个发财，我不在乎。”所以，所有这些情况都有例外。</p>
<p>但本质上，如果你想成功，你必须与他人合作。你必须知道谁可以信任，谁可以长期信任，和你一起在游戏中走下去。所以「复利效应」和「高度信任的圈子」就是你在游戏中生存的武器，同时也是在游戏的周期结束时，让你获利的主要原因。例如，沃伦巴菲特作为美国股票市场的投资者做得非常好，但他能做到这一点的重要原因是因为美国股市一直保持稳定，并且没有碰到美国政府政局非常差的时期，或者是战争时期。总之底层基础设施没有被破坏。因此，对于他来说，他正在玩一场长期比赛。这种信任来自于美国股市的稳定。</p>
<h3>当你转行时，你是在从零开始</h3>
<p>在硅谷，信任来自于小范围内的人际网络，随着时间的推移，你会发现哪些人是你可以合作的，哪些人是你不能合作的。</p>
<p>如果你不停地更换地点，你就不停地更换团队……假设你从木工行业起步，并在那里建立了一个网络。你努力工作，你试图在木工行业制造产品。然后突然出现了另一个相邻但又不同的行业，但你真的并不了解其中的任何一个人，你想要投身其中，在那里赚钱。如果你持续在工业界跳来跳去——不，实际上我需要打开一系列电动汽车加油站。——这或许有道理。这可能是最好的机会。但是每次你重置时，每次你跳出原来的网络圈时，你都将从零开始。你不知道该相信谁，而且他们也不会很容易相信你。</p>
<p>当然也存在短暂的行业。他们总是进进出出。政治就是一个例子，对吧？在政治上，新人正在当选。你在政治上会看到，有很多老前辈的地方，比如参议院，这里有在这个行业中已经生存很长时间的人，他们都是职业政治家。对于职业政治家有很多不利因素比如腐败。但好处是他们实际上已经完成了彼此的交易，因为他们知道另一个人将在十年之后处于相同的位置，他们将不得不继续与这些老前辈打交道，所以他们最好学会如何合作。众议院每两年都要举行一次大型选举，选出一批新的众议员，由于一直在相互竞争，几乎任何事情都没法完成。“因为我刚来到这里，我不认识你，我不知道你是否会继续在身边，我为什么要和你合作，而不是只是尝试做我认为正确的事情？”</p>
<p>因此选择一个你能长期从事的行业、以及长期伙伴是非常重要的。这些人会表明他们会在你身边存在很久，他们是有道德的，他们的道德信条能从他们的行动上体现出来。</p>
<h3>长期游戏中，每个人都在让彼此更富有</h3>
<p><strong>Nivi：在长期游戏中，似乎每个人都在让彼此更富有。而在短期游戏中，似乎每个人都在让自己更富有</strong>。</p>
<p>Naval：我认为这是一个很棒的形容。在长期游戏中，这是一个正和现象。就好像大家在一起烤一个苹果派，大家都在努力尽可能将它做得越大越好。在短期游戏中，我们是在想方设法分这个派。</p>
<p>现在这不是在为社会主义者辩解，对吗？这些社会主义者不是参与烘焙派的人，他们最后出现，说”我想要一片，或者整个派。“他们出现时是带着枪的。但是我认为一个好的领导者并不能赢得荣誉。一个好的领导者基本上都在努力激励员工，这样团队才能将工作完成。然后，奖励将按照公平原则进行划分，谁贡献了多少（或尽可能接近）并承担了风险，而不是谁拥有最长的刀…谁有最锋利的刀。</p>
<h3>收益来自重复游戏的复利</h3>
<p>Nivi：因此，接下来的两个推文是，“玩迭代游戏。生活中的所有的回报，不论是财富上的，还是人际关系上的，或者是知识上的都来自复利效应。”</p>
<p>Naval：当你与一个相处了十年，二十年，三十年的老友做生意时，你根本不需要信任他，事情也可以做得越来越好。因为在相处过程中摩擦逐渐减弱，你们可以一起做越来越大的事情。</p>
<p>举个极端的例子，最简单的方法是与某人结婚，生孩子然后养孩子，这就是复利（笑）。投资于这些长期的关系，与更随意的关系相比，这些关系最终是无价的。</p>
<p>在健康和健身方面也是如此。 你的身体越健康，保持健康就越容易。 而你的身体恶化的越多，就越难回到正常的水平。</p>
<h2>第十一条： 选择智慧、精力充沛和正直的合作伙伴</h2>
<p><strong>选择高智商、精力充沛、为人正直的伙伴是你不能妥协的三要素</strong></p>
<h3>选择高智商、精力和正直的商业伙伴</h3>
<p>Naval：在挑选同事方面，选择那些高智商、精力充沛、正直的人，这是你不能妥协的三个要素。</p>
<p>你需要和聪明的人共事，至少他们不是在错误的方向上一路向西。你需要与精力充沛的人共事，因为世界上到处都是聪明却懒惰，光想不干的人。在生活中，我们都认识一些非常聪明的人，他们可以不起床，或者动一动手指就完成很多事情。我们也知道有些人精力很旺盛，但并不聪明，他们工作非常非常努力，但有时在朝着错误的方向埋头苦干。smart不是一个贬义词。这并不是说有人聪明，有人愚蠢。我想表达的意思是，每个人在不同的事情上会表现出很聪明的一面。因此，取决于你想做什么，你才可以找到在这方面很聪明的人来帮你。</p>
<p>然后关于精力，很多时候人们对特定的事情没有动力，但对其他事情有动力。例如，有人可能真的没有动力一天都坐在办公室里工作。但他们可能真的有动力去画画，对吧?</p>
<p>嗯，那样的话，他们应该是画家。他们应该把自己的艺术放到网上，试着探索如何以此为基础建立自己的事业，而不是认命了，戴着项圈，去做一份乏味的工作。这一定是一个长期的事情，很多人在兴致勃勃的发布第一个作品后，发现没有立马收获1w+粉丝的关注而对自己大失所望，然后以此为由失去动力就放弃了。我想说的是，<strong>做一件事情的动力终究来自于你自己到底想做什么，觉得什么有意义，而不是为了讨好别人</strong>。</p>
<p>最后一点是正直，正直是最重要的，如果只有另外两个品质，你就选择了一个聪明、勤奋的骗子，他最终会欺骗你。所以，你必须弄清楚这个人是否正直。</p>
<p>我之前说过，你要通过信号判断。信号是他们做什么，而不是他们说什么。当他们认为没有人在看他们时，他们会做一些非语言的事情。</p>
<h3>动机必须是内在的</h3>
<p>Nivi：Sam Altman之前有个有趣的观点，当谈到委任时，他说：“委任的关键在于，让人们做他们<strong>擅长同时是你想让他们做的事情</strong>。”这个道理显而易见，你会和那些自然会做你想让他们做的事情的人合作。</p>
<p>Naval：是的。如果我认为他们不喜欢我想让他们做的事情，我几乎不会创办公司，不会雇人，也不会和别人一起工作。</p>
<p>当我年轻的时候，我常常试着说服别人。但事实证明，你可以说服某人帮你做一件事，但是有时候你不能。你无法让他们保持动力。你可以在一开始就给他们灵感，但除非你是像亨利五世那样的国王，拥有那样的权力指使别人做事情。但如果你想让人们长期保持动力，这种动力必须是内在的。你不能只是创造它，如果他们没有内在的动力，你也不能成为他们的拐杖。所以，你必须确保员工精力充沛，愿意做你希望他们做的事，愿意和你一起工作，一起创造。</p>
<h3>诚信反映在一个人的行为，而不是他说了什么</h3>
<p>解读信号非常非常重要。信号不是人们说什么，而是他们做了什么。因此，注意细微的信号是很重要的。举个例子，比如在公众场合，如果有人对服务员态度非常不好，那么他们对你不好只是时间问题。如果有人压制了一个敌人，并对他们怀恨在心，那么他们把你从朋友重新定义为敌人只是时间问题，你会感受到他们的愤怒。所以，愤怒，愤怒，报复，短视的人在现实生活中的很多互动中都是这样的。人们奇怪地一致，至少身体很诚实。所以，你想找到长期合作的伙伴，你要找的是那些似乎没有理性道德的人。</p>
<p>举个例子，我有一个朋友，他的公司是我投资的，但是公司接近倒闭，他本可以把所有的投资者都鸽了。但他不断地投入越来越多的个人资金，直到公司最终又站起来。在这个过程中，他从未让投资者血本无归。为此我一直很感激他。我说，“哇，你对投资人这么好真是太棒了，你没有坑他们。他觉得被冒犯了。他说：“我这样做不是为了你（投资人），是为了我自己。这关乎我的自尊，是我真正关心的东西。”这种人才是你想要共事的人。</p>
<p>另一个我喜欢的引用，是我另一条相关的推特。我是在别的地方读到它，但是我稍微修改了一下。</p>
<p>“<strong>自尊是你对自己的评价</strong>”。</p>
<p>好人，有道德的人，容易共事的人，可靠的人，往往有很高的自尊，因为他们对自己的声誉非常在意，他们深刻的明白声誉的重要性。</p>
<h2>第十二条：与理性的乐观主义者合作</h2>
<p><strong>不要与愤世嫉俗者和悲观主义者为伴：他们总是以自我为中心</strong></p>
<h3>不要与悲观主义者为伍</h3>
<p>Nivi：最后一条推文。你说：“不要与愤世嫉俗者和悲观主义者为伍。他们总是自以为是。</p>
<p>Naval：是的。本质上，要创造事物，你必须是一个理性的乐观主义者。理性的意思是你必须看清世界的真相。<strong>但你必须对自己的能力保持乐观</strong>，对自己想要完成的使命保持乐观。</p>
<p>我们都知道有些人总是很悲观，他们会否定一切。每个人的生活中都有乐于助人的批判者，对吧？他认为他是在帮忙，但实际上他只是在批评（就像我所说的专业的评论家），而且他对每件事都很失望。这样的人不仅在他的生活中不会成就任何伟大的事情，他们还会阻止周围的人做一些伟大的事情或有大胆的想法。他们往往享受挑刺儿的快感，但从未想过提供更好的解决问题的方案，对，他们就是只说不做。有一句经典的军事台词：“要么当头儿，要么服从，要么滚。”这些人想要第四种选择，他们不想当领导，不想跟随，但又不想让路。他们就是想方设法告诉你为什么这事儿行不通。</p>
<p>我认识的所有真正成功的人都有很强的行动力，<strong>他们只是做事。判断一件事是否可行的最简单方法就是去做</strong>，至少做第一步，第二步，第三步，然后再决定下一步。</p>
<p>因此，如果你想在生活中取得成功，创造财富，或者拥有良好的人际关系，或者保持健康，甚至是快乐，你需要有一种超强的行动力，这样才能获得你想要的。</p>
<h3>与理性的乐观主义者合作</h3>
<p>你要对合理的东西保持乐观。众所周知，没有什么比一个鲁莽的人去追求不值得的东西更糟糕的了。这就是为什么我说“理性”的乐观主义者。你需要在了解所有的陷阱，知道事物不利的一面的情况下，依旧保持乐观。</p>
<p>每个人只在这个星球上活一次，为什么不试着做点大事呢？这就是埃隆·马斯克这种人的牛逼之处，我认为他之所以能激励这么多人，是因为他承担了非常、非常大胆的责任和使命。他为人们树立了一个树立远大理想的榜样。即使是做一些小东西也要花很多功夫。我不认为街角杂货店老板的工作强度比埃隆·马斯克(Elon Musk)低，也不认为他付出的汗水和辛劳比马斯克少，甚至更多。无论是教育水平还是所处环境，不管什么原因，他们没有机会去想那么多，所以影响力就不那么大。因此，最好还是想得远一点。当然还是要理性地，在你的能力范围内保持乐观。</p>
<p>愤世嫉俗者和悲观主义者，他们真正想说的是，这很不幸，但他们基本上是在说，“我放弃了。我想我什么都做不了。所以对我来说，这个世界就像一个没有人能做任何事的世界。”所以他们不理解别人为什么费劲儿地要去做一些事情。</p>
<h3>我们是悲观主义者的后代</h3>
<p>Nivi：也许做一个不理性的乐观主义者或做一个理性的愤世嫉俗者可能更好。</p>
<p>Naval：对于为什么你应该成为一个乐观主义者，有一个完全理性的框架。历史上，如果你回到2000年，5000年，10000年，两个人在丛林中漫步，他们听到了老虎的声音。一个是乐观主义者，说，“哦，它不是朝我们这边来的。另一个说：“我是个悲观主义者，我要离开这里。”悲观的人跑了，活了下来，乐观的人被吃掉了。</p>
<p>我们是悲观主义者的后代，我们天生就是悲观主义者。但现代社会要安全得多，没有老虎在街上游荡，虽然你应该避免彻底破产，但你最终不太可能一无所有。</p>
<p>我想分享的理念是，对于一个人来说，<strong>他的境遇是有下限的，但上限却很难说</strong>（白话说是你很难饿死，但是成功却不可限量）。因此，适应现代社会意味着要克服你的悲观情绪，做出稍微不理性的乐观押注，因为如果你创办下一个SpaceX、特斯拉(Tesla)或优步(Uber)，你可以为社会和自己创造数十亿美元的价值，并改变世界。</p>
<p>“<strong>如果你失败了，有什么大不了的？你损失了几百万美元的投资人（VC）的钱，而他们还有更多钱，这就是他们对你成功的赌注。</strong>”</p>
<p>对过去悲观是有道理的，对今天保持乐观是有意义的，尤其对于这么多受过高等教育且生活在第一世界国家的人，甚至是第三世界国家的人。我反而认为第三世界国家的经济机会要大得多。</p>
<p>当然，你必须注意的一件事就是，不要做任何违法的事情，远离可能会带来灾难性的损失的事。尽可能不做对身体有害的事情，注意你的健康。远离那些会让你失去所有资本和储蓄的事情。</p>
<p>因此，不要孤注一掷。但理性乐观的押注会带来巨大的好处。</p>
<h2>第十三条：用特殊技能（Specific knowledge）武装自己</h2>
<p>Naval：如果你想变得富有，你需要想办法获得“规模化”的收入，而不是仅仅期盼每个月的工资。责任感决定了你的客户为什么选择你，杠杆效应决定了它可以被规模化。为什么大家要付给你钱而不是给别人，这需要<strong>特殊的技能</strong>。这里提到的特殊技能可能是整个推特风暴中最难传达的东西，也是人们可能最困惑的部分。</p>
<p>人们普遍持有一种观点是，任何事情都可以从学校学来，都可以“被传授”，但事实上最有价值的事情不是教来的。但好在任何事情都可以学，大部分情况下你想学的东，要么来源于你的兴趣或DNA，要么是源于你从小养成的一些习惯，这些在之后非常难被“教”会；当然也可能是一些全新的东西，所以没有人知道怎么做；或者在工作培训中也是如此，你在高度复杂的环境中进行各种尝试，在一个特定的领域建立判断。典型的例子就是投资，但也可以是其他方面。可以是开拖拉机的技巧，也可以是预测天气的能力。</p>
<p>因此特殊技能就是你特别关注的技能，尤其是你已经到了20、21、22之后，你几乎就不用去选你需要什么样的特殊技能了。你需要做的就是回顾之前的人生经历中，你建立了什么样的技能是你觉得可以着重被发展的。</p>
<h3>特殊技能无法被训练出来</h3>
<p>特殊技能不是教出来的。如果学校可以教这些东西，那么其他人也可以接受培训，然后我们就可以大规模生产和大规模培训人员。我们甚至可以编程让电脑来做，让机器人来做。如果是这样的话，你就很容易被替代。当有无数的人可以经过培训做这件事的时候，雇主支付给你的只是最低工资，为的就是让你做“这件事”。<strong>你获得的收入=投资培训所产生的回报-培训你的成本</strong>。</p>
<h3>特殊技能与你的兴趣高度相关</h3>
<p>举个例子，一个人拿到了心理学学位后，成为了一名销售人员。如果他已经拥有比较好的销售技巧，那么心理学就可以作为一种杠杆，使他在销售上做得更好。但如果他一直是一个内向的人，从来都不擅长销售，他们试图用心理学来学习销售，他们不会做得很好。因此，你会发现更多的特殊技能是通过认识到你的天赋、你真正的好奇心和你的热情而建立起来的。不是为了最热门的工作去上学，也不是盲目进入投资人认为的最热门的领域创业。</p>
<h3>特殊技能往往处于知识的边缘</h3>
<p>它也是一些刚刚被发现或者很难被发现的东西。因此，如果你不是100%的投入，其他人会比你做得更好。他们不会比你好一点点，他们会比你好很多，因为现在我们正在运营创意领域，非常适用于复利，适用于杠杆。如果你的杠杆率为1000倍，有人在80％的时间都是正确的，而其他人在90％的时间都是正确的，那么90％的时间正确的人将因为市场的杠杆作用和复利获得数百倍的报酬。因此，如果你想确保自己在这方面具有优势，真正具有好奇心非常重要。</p>
<h3>建立特殊技能对你来说就像游戏</h3>
<p>很多时候，它不是你坐下来然后推理的东西，它更多的是通过观察发现的。你几乎不得不回顾自己的生活，看看自己到底擅长什么。例如，我想成为一名科学家，所以我所坚持的价值观都是围绕着「科学家」来建立的。我认为真正的科学家处于人类生产链条的顶端，他们做出了真正的突破和贡献，对人类社会的贡献可能比任何其他阶层的人都要大。当然，我并不是说艺术、政治、工程或商业等贡献小，但如果没有科学，我们仍然会在泥土中挣扎，用棍子打架，每天忙着生火。我的整个价值体系都是围绕着科学家建立的，我想成为一名伟大的科学家。</p>
<p>但当我真正回头看我擅长的东西，以及我最终把时间花在了什么事情上时，我发现更多的是围绕着赚钱，钻研技术，卖东西（思想），解释事情，和人们交谈。所以，我有一些销售技巧，这是一种形式的具体知识；我有一些关于如何赚钱的分析技巧；我对数据足够敏感，有收集数据，整理并分析数据的能力，这也是我的一个特殊技能。当然我也喜欢摆弄技术。所有这些对我来说都像是游戏，但对其他人来说却是工作。</p>
<p>有些人会觉得这些事情很难，他们会说，“好吧，我怎么才能变得善于表达和推销想法呢?”如果你不是很擅长，或者你不是很喜欢，也许这不是你的专长，专注于你真正喜欢的事情。</p>
<p>有点讽刺的是，第一个指出我真正擅长什么的人是我的母亲。她是在厨房里说这些话的，当时我大概15、16岁。当我在和一个朋友说我想成为一名天体物理学家，她说：“不，你更适合去经商。”</p>
<p>我一脸懵逼，“啥？我妈妈不知道她在说什么吧。”</p>
<p><strong>但事实上，妈妈当然知道她在说什么</strong>。她已经注意到，每次我们走在街上，我都会批评当地的披萨店，为什么他们要用特定的配料和特定的方式出售披萨，为什么他们点披萨的过程是这样的，而实际上应该是那样的。因此，她知道我对商业更有好奇心，到后来与我对科学的痴迷结合起来，创造了技术和科技企业，我才发现了真正的自己。因此，你的特殊技能可能是由那些了解你的人观察到的，而且经常是由那些了解你的人观察到的。</p>
<h2>第十四条：特殊技能（specific knowledge）极富创造性或技术性</h2>
<h3>特殊技能能通过课程传授获得</h3>
<p>Naval: 如果说特殊技能可以被传授，那就是在工作中，通过学徒制。这就是为什么最好的企业、最好的职业是学徒或自学的职业，因为这些都是社会还没有弄清楚如何培训以及使其批量自动生产的事情。这方面的经典例子是沃伦·巴菲特从学校毕业后去找了本杰明·格雷厄姆。本杰明·格雷厄姆（Benjamin Graham）是《聪明的投资者》（Intelligent Investor）一书的作者，可以说他将价值投资发展成了一套理论并将其发扬光大。巴菲特去找了本杰明·格雷厄姆，并主动提出<strong>免费</strong>为他工作。</p>
<p>但格雷厄姆说：“你开的价格太高了，免费恰恰是一种高价格。”格雷厄姆说得没错。就像后来1954年时格雷厄姆决定要与巴菲特共事时（给予他学徒机会），巴菲特给他多少钱都不为过。</p>
<h3>特殊的技能具有高度的创造性或者技术性</h3>
<p>特定的技能也往往具有技术性和创造性。它在技术的前沿，艺术的前沿，交流的前沿。再举个例子，在今天，互联网上有一些梗王能够创造出令人难以置信的梗，并将这一想法传播给数百万人。斯科特·亚当斯（Scott Adams）就是一个很好的例子，他通过有说服力的文字和视频做出准确的预测，基本上正在成为世界上最可信的人之一。</p>
<p>这是他多年来积累起来的特殊技能，因为他年轻时就沉迷于催眠，他通过漫画学会了如何沟通，并很早就开始用直播平台Periscope，所以他一直在练习和人对话，他读过所有关于这个话题的书，他将工作融入到生活的点点滴滴。</p>
<p>这是一个在职业生涯中积累了特殊技能的人的例子。它具有高度的创造性，它具有技术性的元素，而且它永远不会被机器自动化所取代。
没有人会把这一点从他身上夺走，因为斯科特·亚当斯（Scott Adams）为了发展自己的品牌也尽心尽力。他积极地创作Dilbert系列卡通画、写书，并懂得借助Periscope直播平台的媒体优势运作。他在这个品牌上拥有巨大的影响力，如果他想在现有的基础上创造更多的财富，他现在积累的东西就他的杠杆。</p>
<h3>特殊的技能特定于个体和情境</h3>
<p>Nivi：我们应该称之为独特的知识还是特殊的技能更贴切？</p>
<p>Naval： 我很小的时候就提出了这个框架，当时特殊的技能就一直伴随着我，我没有尝试改变它是因为我所发现的每一个术语都以不同的方式夸大其词。至少特殊的技能（specific knowledge）这个词没被过度消费，因此我可以赋予他新的含义。独特知识的问题是，是的，也许它是独一无二的，但是如果我从别人那里学到它，它就不再是独一无二的，那么就是我们都知道的东西了。所以，与其说它是独一无二的，不如说它是高度依附于现实的，根据个体的实际情况，根据具体问题存在的，它只能依赖于在这个领域中极度的痴迷、兴趣和所花在这个领域的时间来获得。它不能仅仅从一本书中直接读出，也不能在只在一门课程中获得，也不能被设计成一个算法。</p>
<h3>特殊技能不能刻意获得</h3>
<p>Nivi：说到斯科特·亚当斯，他在博客上发表过一篇文章叫做「努力在2个或以上的领域做到前25%」的文章。在此摘录一段：</p>
<blockquote>
<p>如果你想要一个普通的成功的生活，不需要太多的计划。只要远离麻烦，去上学，申请你可能喜欢的工作。但如果你想要与众不同的东西，你有两条路:</p>
<ol>
<li>成为某方面的最牛逼的人（世界第一梯队）</li>
<li>在两件或两件以上的事情上变得非常优秀(前25%)。</li>
</ol>
<p>第一种策略几乎是不可能的。很少有人能在NBA打球，也很少有人能出一张白金唱片。真的很难，我不建议任何人去尝试。</p>
<p>第二种策略相当简单。每个人都至少有几个领域是他们可以努力进入前25%的。就我而言，我比大多数人画得都好，但我算不上艺术家。我并不比一般的单口相声演员更幽默，虽然我从来没有成功过，但我比大多数人都更幽默。神奇的是，很少有人能画得很好，也很少有人能写笑话。正是这两者的结合，让我的作品变得如此罕见。当你再加上我的商业背景，我突然有了一个很少有漫画家不亲身经历就能理解的话题。</p>
<p>我总是建议年轻人成为优秀的演说家(前25%)。任何人都可以通过练习来做这件事。如果你把这种才能加到其他任何一种才能上，你就会突然成为那些只有一种才能的人的老板。或者在你的工程学位、法律学位、医学学位、科学学位或其他任何学位的基础上再获得一个商学学位。突然之间，你掌握了主动权，或者你正在利用自己的综合知识创办自己的公司。</p>
</blockquote>
<p>因此，不要试图在一件事情上做到最好，这太难了。你需要尝试在三件或更多的事情上做到非常优秀。这是一种获得特殊技能的方式吗？</p>
<p>Naval：我认为最好的方法就是追随自己的内心真正喜欢的事物。在你脑海的某个角落，你会意识到，事实上，这个方面我喜欢，我会留意它的商业方面的可能性。</p>
<p>但我认为，如果你单单为了获得「特殊技能」无病乱投医，或过于以目标为导向地关注钱，那么你不会选择做正确的事情，不会选择你喜欢做的事，所以你不会真正深入进去。根据统计数据，斯科特・亚当斯的观察结果很准。就知识而言，今天有 10,000 个对人类有价值的区域，这 10,000 个区域中排名第一那些位置已经被抢占了。除非你碰巧成为各种领域最痴迷的一万人之一，否则其他人可能会成为这万人中的第一人。</p>
<p>当你开始把3728种一流的销售技巧和很好的写作技巧以及一个非常了解会计和财务的人结合起来，当这个交叉点的需求到来时，你已经通过组合数学从10000扩展到了数百万或数千万。所以，它只是变得没有竞争力。此外，收益在递减。因此，在三四件事上成为前25%要比在某件事上成为世界第一容易得多。</p>
<h3>在你擅长得领域建立自己的特殊技能</h3>
<p>natural是天生的、本来的意思，这里翻译成擅长的。我认为这是一个非常务实的方法。但最重要的是，我认为一个人不要太刻意地开始积累，因为你内心其实是想挑选你最擅长的东西。每个人都有与生俱来的擅长的东西。</p>
<p>我们都很熟悉这句话，一个有天赋的人。“哦，这个人是天生的与人为善的人，这个人就是社交名媛的料，这个人是天生的程序员，这个人是天生的读者。”所以，不管是干什么的料，你都会想着在这方面加倍努力。</p>
<p>因为人类的个性非常复杂，你可能在很多方面都很有天赋。如果把你在这些方面的天赋结合起来，这样你就可以自动地，仅仅通过纯粹的兴趣和享受，在很多事情上，最终达到25%，10%甚至5%的最高水平。</p>
<h2>第十五条：学会销售，学会建造</h2>
<p><strong>如果你两者都能做到，你将势不可挡</strong></p>
<h3>学会销售，学会建造</h3>
<p>Nivi：谈到技能组合，你说过你应该“学会销售（Sale），学会建造（Build），如果你两者都能做到，你将势不可挡。”</p>
<p>Naval：这是一个非常广泛的范畴。其中之一是开发产品，即建造。这很难，而且定义很多元。它可以包括设计，开发，可以包括制造，物流，采购，甚至是设计和完成一整套服务。在每个行业，都有一个建造者的定义。在我们所处的科技行业，就是首席技术官CTO，程序员，软件工程师，硬件工程师。但即使在洗衣行业，也可能是创立洗衣服务的人，让物流准时到达的人，确保所有的衣服在正确的时间出现在正确的地方的人，等等。另一方面是销售。同样，销售也有一个非常宽泛的定义。销售不一定只意味着卖东西给个人，它可以意味着营销，意味着沟通，意味着招聘。它也可以意味着筹集资金，意味着鼓舞人心，意味着做公关，等等。</p>
<h3>硅谷模式：建造者+销售者=最佳拍档</h3>
<p>总的来说，硅谷的创业模式是最好的。最常见的形式是有两个创始人，其中一个擅长销售（Sale），另一个擅长搭建（Build）。举几个经典例子，比如苹果创始人史蒂夫·乔布斯和史蒂夫·沃兹尼亚克；微软的盖茨和艾伦在早期可能有类似的分工；谷歌的拉里和谢尔盖可能稍微有点不同，可能是因为谷歌早期交付的是一个非常技术性的产品——搜索，通过一个简单的UI直达终端用户。</p>
<p>在硅谷，你会看到这种模式反复出现。一个建造者和一个销售者的组合：CTO和CEO的组合。风险投资者和技术投资者几乎心照不宣的尽可能地寻找这种组合，这就是神奇的组合定律。</p>
<h3>如果你两者都能做到，你将势不可挡</h3>
<p>如果一个人可以同时做到这两者，这才是真正的超能力。那时你就是可以创造整个行业的人。马一龙(Elon Musk)就是一个活生生的例子。他不一定是自己造火箭，但他实际上做出了技术上的贡献。他使自己成为最了解这项技术的人，没人会对他说三道四，他也不会说一些自己做不到的事（意思是说到就会做到）。他视时间为朋友，并想尽办法运用它。即使是史蒂夫·乔布斯（Steve Jobs）也拥有足够的产品技能，并且对产品的参与度也很高，实际上他也同时具备这两种能力。拉里·埃里森（Larry Ellison）最初是一名程序员，他编写了Oracle的第一个版本，或者说他深度参与其中。马克·安德森（Marc Andreessen）也属于这一类。他可能对自己的销售技能没有足够的信心，但是他可是写出Netscape Navigator的程序员，或者至少是其中很大的一部分。因此，我认为在任何领域中真正的巨人就是可以「自产自销」的人。</p>
<h3>宁愿教工程师销售，也不愿教营销人员工程？</h3>
<p>我认为你可以从建造技能开始入手，并在你人生的早期尽量掌握一定的建造技能。或者你有足够的时间可以专心地学习销售，而且你正好有一定的天赋和亲和力促使你成为一个好的销售者。这样你做事的效果可以翻番。
现在我们谈到的销售技能可能不同于传统概念中的，卖东西。</p>
<p>举个例子，假设你是一个很棒的工程师，然后人们会说，你需要擅长销售。你可能不擅长上门推销东西，但你可能是一个很好的作家。写作是一种比面对面销售门槛更低的技能，所以你可以培养写作技能，直到你成为一个良好的在线交流者，然后将其运用在你的销售上。另一种情况，你可能是一个很好的建造者，但你不擅长写作，你不喜欢与大众沟通，但你擅长一对一说服，所以你可能会用你的销售技能来招聘或募资，这需要更多一对一方向的努力。</p>
<p>因此，如果你在这两个领域的十字路口，千万不要绝望。因为你不可能成为最好的技术，也不会是最好的销售人员。但神奇的是，我们再回到斯科特·亚当斯（Scott Adams）的技能组合理论，将两个技能是结合将是不可阻挡的。</p>
<p>从长远来看，那些了解潜在需求产品的人，知道如何建造和销售它的人，最能受到顶尖投资者的青睐。如果他们有足够的精力，他们可以突破任何障碍，做成任何事情。</p>
<p>Nivi：如果你只能选一个擅长的，你会选哪一个?</p>
<p>Naval：抛开噪音来说，建造的技能实际上是更好的，因为市场上充斥着太多的骗子和没有任何内核的销售人员。当你刚起步、想要被认可的时候，建造技能会更好。但是之后的建造会很累，因为这是一项专注的工作，很难保持与时俱进，因为总是会有新人出现，有新产品，有更新的工具。</p>
<p>因此，随着时间的推移，销售技巧实际上更容易产生规模效应。比如，如果你在构建产品上享有声誉，这是好的，但当你推出你的新产品时，我将去验证的是产品本身（意思是和建造的名声关系不大）。但是，如果你在大家的眼中是一个值得信赖的生意伙伴，并且你很有说服力，善于沟通，那么这个名声会让很多事变得容易很多。</p>
<p>因此，我认为如果你需要选一个，<strong>你可以从建造开始，然后过渡到销售</strong>。这是一个比较中庸的答案，但我觉得这奏是大实话。</p>
<h2>第十六条：阅读你所热爱的内容 直到你爱上阅读</h2>
<p><strong>你应该可以在图书馆中拿起任何一本书阅读</strong></p>
<h3>阅读你所热爱的内容 直到你爱上阅读</h3>
<p>Nivi：在我们讨论责任、影响力和判断之前，你已经有了一些相关的推特，我会把它们放在持续学习的范畴。这些推文本质上是在说，“没有所谓的商业技能。少读商业杂志和商业课程，学习微观经济学、博弈论、心理学、说服力、伦理学、数学和计算机”。你在Periscope上还发表了另一条评论“你应该可以从容的拿起图书馆里的任何一本书来读。”这一类的最后一条推特是，“阅读比听快，做比看快”。</p>
<p>Naval：是的，这是最重要的一条，因为学习的基础是阅读。我认识的聪明人，他们都经常读书。</p>
<p>问题是，<strong>我读什么？我怎么读</strong>？因为对大多数人来说，这是一场斗争，是一件家务活儿。但是，读书不是目的，重要的是学会如何教育自己，教育自己的方法就是培养对阅读的热爱。我想说的是，“<strong>读你喜欢的内容，直到你爱上阅读</strong>。”就这么简单。</p>
<p>我认识的每一个经常读书的人都“爱”阅读，他们爱读书是因为他们读自己喜欢的书。这有点像第二十二条，阅读是没有门槛的，你可以随时开始，然后不断积累，直到它成为一种习惯。接着，你开始不满足于只涉猎单一的领域。</p>
<p>也就是说，你可以从读小说开始，接着你可以读科幻小说，你可以读非小说，然后你可以读科学，哲学，数学甚至更多。但是重要的是，这个过程是顺其自然非强迫的，读你感兴趣的东西，直到你理解它们。然后你就会自然而然地进入下一步，再下一步。</p>
<h3>阅读某一领域的科学原著</h3>
<p>但是，你会发现在你真正想学的东西中，有太多东西要读。我要提醒的是，即使是阅读也充满了垃圾。实际上有些东西你可以阅读，特别是在早期，<strong>它会以某种方式对你的大脑进行编程</strong>，然后在你阅读的后期，你会根据之前的东西来分辨这些东西是真是假。因此，阅读基础性的东西是很重要的。基础性的东西，是在特定领域最原始（fundamental）书籍，在本质上是经过时间和历史的检验，科学的东西。</p>
<p>比如，与其读一本商业畅销书，不如读亚当·斯密的《国富论》。与其读今天谁写的一本关于生物学或进化论的书，我更愿意读达尔文《物种起源》。与其现在读一本可能非常先进的生物技术方面的书，我只想学习Horace F. Judson的《创世第八天》(The Eighth Day of Creation)。你不必死磕关于宇宙学和尼尔·德格拉斯·泰森和斯蒂芬·霍金一直在说什么的高级书籍，你需要的是拿起理查德·费曼的《费曼讲物理：入门》，从基础物理学开始。</p>
<h3>不要害怕任何书</h3>
<p>如果你基础打的好，特别是数学、物理和科学，那么你就不会害怕任何一本书。我们所有人都有那种坐在教室里学数学的记忆，这一切都是合乎逻辑的，而且都是有意义的，直到有一次，课程进度太快，我们跟不上了。
在那之后，我们被留下来背方程式，记忆概念，却无法从第一原理中推导出它们。在那一刻，我们迷失了，因为除非你是一个专业的数学家，否则你不会记得这些东西。你要记住的是技术，基础。</p>
<p>因此，你必须确保阅读是建立在一个理解的框架上，因为你正在为建摩天大楼打地基，而不只是在反复记忆你不断在丢失的东西。所以基础非常重要。</p>
<p>最后，阅读的终极是当你走进一个图书馆，你上下打量，你不害怕这里的任何一本书。因为你知道你可以把任何一本书从书架上拿下来，你就能阅读它，理解它，你可以接收什么是真的，拒绝什么是假的。你有一套自己的方法论，分辨哪些是逻辑和科学的，而不仅仅是基于大字报和意见（opinions）。</p>
<h3>学习的手段是丰富的，学习的欲望是稀缺的</h3>
<p>互联网的美丽是整个亚历山大图书馆的十倍，并且时刻在你的指尖，为你所用。不是教育手段或学习手段稀缺，相反稀缺的是学习的欲望。所以，你真的要培养欲望。</p>
<p>欲望意味着我不允许这种能力的丧失。孩子们天生就有好奇心。如果你去找一个第一次学语言的小孩，他们总是问：这是什么？那是什么？这是为什么？那是谁？他们总是问问题。</p>
<p>但问题之一是，学校和我们的教育系统，甚至我们培养孩子的方式，都用顺从取代了好奇。<strong>一旦你用顺从取代好奇心，你就会成为一个顺从的工厂工人，而不再是一个创造性的思考者。你需要创造力，你需要有激励自己的大脑去学习你想要的东西的能力</strong>。</p>
<h2>第十七条：数学和逻辑才是一切事物的基础</h2>
<p><strong>数学和逻辑是理解其他一切事物的基础</strong></p>
<h3>终极基础是数学和逻辑</h3>
<p>Naval：最基本的东西是原则性的，可以是算法，是根深蒂固的逻辑理解，你可以从任何角度保护它或攻击它。这就是为什么微观经济学很重要，而宏观经济学就是大量的记忆堆砌，大量的宏观废话。</p>
<p>正如纳西姆•塔勒布(Nassim Taleb)所说，<strong>宏观上的扯淡比微观上的扯淡更容易</strong>。因为宏观经济学是巫术—复杂—科学与政治的结合。如今，你找不到两个宏观经济学家在任何事情上达成一致，不同的政治家会用不同的宏观经济学家来兜售他们各自偏爱的理论。</p>
<p>现在甚至有宏观经济学家在兜售所谓的现代货币理论，大概意思就是，有个讨厌的东西叫做通货膨胀，我们可以印所有我们想要的钱。这就像说，有了无限的能量，我们可以发射火箭进入太空一整天。这简直是一派胡言。现实是，有些人打着“宏观经济学家”的旗号，兜售什么现代货币理论，这只能说明，宏观经济学作为一门“所谓的科学”已经腐败。它现在是政治的一个分支。</p>
<p>因此，你要把重点放在基础上。<strong>最终一切事物的基础是数学和逻辑</strong>。如果你懂逻辑和数学，那么你就有了理解科学方法的基础。一旦你理解了科学方法，你就能理解如何在其他领域和其他你正在阅读的东西中区分真理和谬误。</p>
<h3>速食一百本书毫无意义</h3>
<p>在阅读别人的观点（opinion）时要非常小心，甚至在阅读事实（facts）时也要小心，因为所谓的事实往往只是表面上的(伪科学)观点。你真正需要的是算法（algorithm），是理解（understanding）。最好是慢慢地啃完一本书，然后挣扎、绊倒、倒带，而不是快速地浏览一遍，然后貌似很有成就感：“我已经读了20本书，我已经读了30本书，我已经读了50本这个领域的书...”就像李小龙说的，“我不害怕那些知道一千种踢腿招式的人，我害怕那些练习了一万次出拳或一万踢腿的人。”通过不断重复和运用，不断深入理解逻辑和基础，你才能成为一个聪明的思考者。</p>
<h3>学习讲故事和编程</h3>
<p>Nivi：要为你以后的学习打下基础，我认为你需要两样东西，总结来说。第一，练习说服别人，不断实践怎么讲好一个故事。第二，深入了解一些技术范畴的东西，无论是学习抽象数学，还是读唐纳德·克努斯关于算法的书，或者听费曼关于物理学的讲座。如果你有实际的说服力，对一些复杂的话题有深刻的理解，我认为你的余生将有一个很好的学习基础。</p>
<p>Naval：是的。我把它展开一下。我认为五个最重要的技能是，阅读，写作，算术，然后加上说服的技巧，也就是会讲故事（storytelling）让别人信服。最后，我还要加上计算机编程，因为它是一种应用形式的运算它能让你在任何领域都能自由的建造。如果你擅长电脑，擅长基础数学，擅长写作，擅长说服，如果你喜欢阅读，你就已经为生活做好了准备。</p>
<h2>第十八条：没有被称为“商业”的技能</h2>
<p><strong>避开商学院和杂志</strong></p>
<h3>没有被称为“商业”的实际技能</h3>
<p>Naval：没有所谓商业的实际技能，它太普通了。这就像一种叫做“关联”的技能，定义为“与人相关”。这都不能称作一种技能，它太宽泛了。</p>
<p>我并不想完全贬低商学院传授的东西的价值，他们会传授非常聪明的东西—一些成功的案例/轶事，并称之为“案例分析”（case study）。但它们只是一些趣闻轶事，它们试图通过向你抛出大量数据点来帮助你进行模式匹配，但事实是，在你设身处地思考之前，你永远不能完全理解它们，就像你无法重复打造一个可口可乐一样。但是，你会发现博弈论、心理学、伦理学、数学、计算机和逻辑学中的这些基本概念才会更好地帮到你。这也是我为什么会更专注于基础科学、基础逻辑的原因。我会培养对阅读的热爱，包括阅读那些我们明知道不应该阅读的所谓垃圾。你不必（只）读经典。阅读是你进行自我教育的基础。</p>
<p>着手做比光想要快得多</p>
<p>Nivi：你之前所说的“做比看快”是什么意思呢？</p>
<p>Naval：这涉及到学习曲线的话题，人们总是想方设法的优化自己的学习曲线。尽管我也是一个播客博主，但我不喜欢播客的原因之一是，播客无法让我最快的获取知识和信息。我是一个很好的读者，或者说是一个很快的读者，我能读得很快，但我只能以一定的速度听。我知道人们听的时候都是二倍速，三倍速，但那时每个人听起来都像一只花栗鼠，很难再回头看，抓重点，很难精确定位片段并记笔记，等等。</p>
<p>同样地，很多人认为他们可以通过观察别人做的事情，甚至通过阅读别人做的事情，变得非常熟练。比如刚提到的商学院的案例研究，就是一个非常典型的例子。他们研究其他人的生意，但实际上，你开一个自己的柠檬汽水摊，甚至在街上开一家小杂货店，都会学到比书本上多得多的经营生意的知识。这就是你在工作中要学习的方法，<strong>因为很多微妙的东西在你真正进入这个行业之前是不会真正懂得的</strong>。</p>
<p>例如，现在人人都喜欢研究心理学。你去看看Farnam Street，读读Poor Charlie’s Almanack*，你可以学习所有不同的心理模式。但哪个更重要？你更常应用哪些？在什么情况下哪一个更重要？这其实是最难的部分。比如，我从心理学研究中最大的收获是，委托-代理问题在现实世界中的驱动力太强大了，这本质是一个激励问题。它让我明白，针锋相对的重复囚徒困境是最值得了解的博弈论。在那之后你几乎可以把博弈论理论书束之高阁了。</p>
<p>顺便说一下，<strong>学习博弈论的最好方法是自己设计游戏</strong>，自己亲身体验。虽然我从没读过博弈论的书，但我认为自己非常擅长博弈论实践。我从来没有打开过一本博弈论的书，从未尝试在里面发现任何一个我没想到的结果。原因是我从小玩各种游戏，和各种各样的朋友在游戏中碰到各种各样的实际情况，所以这对我来说只是第二天性。实践会告诉你一切你想知道的答案。</p>
<h3>“执行”迭代的次数决定着你的学习曲线</h3>
<p>执行本身是一件很微妙的事请，它包含着很多东西。比如说，我想学习如何经营一家企业。如果我在每天上班的地方重复做同样的事情，比如说我在街上开了一家零售店，每天的任务就是在货架上摆满食物和酒，我不会学到很多东西，因为我每天只是在不断重复。因此，即使我花了几千个小时，但我也只是花了几千个小时做同样的事情。而如果在这个过程中我进行了数千次迭代，那结果就会不一样了。因此，学习曲线是需要迭代的，而不是重复。</p>
<p>但如果我在商店里每天尝试新的营销实验，我不断地改变库存，不断地改善品牌策略，不断尝试新的讲故事的方法，不断地拓展增大客流量的在线渠道，我试着在不同的时间营业，并且经常有目的地四处走走，和其他店主交谈，拿到他们的书，弄清楚他们是如何经营自己的生意的。<strong>真正影响学习曲线的是迭代次数</strong>。迭代次数越多，收获的就越多，学习速度就越快。而不仅仅是投入的时间长短的问题。</p>
<h3>如果你愿意每天流一点血，你可能在未来的人生路上赢得很多</h3>
<p>虽然世界为我们提供着一次又一次做同样事情的机会，但事实上，如果我们能从零开始寻找新的方法，世界会呈现出不一样的精彩。</p>
<p>第一次尝试新事物是很痛苦的，因为你正徘徊在不确定的领域，很有可能你会失败。因此你只需要不断让自己<strong>适应频繁的小失败（bleed a little）</strong>。</p>
<p>Nassim Taleb也谈到了这一点。他靠做一个基本上依赖黑天鹅的商人的生意发家致富。Nassim Taleb通过每天损失一点点钱来赚钱，然后在一个偶然的时机，当一件被常识定义为不可能发生的事情发生在其他人身上时，他会赚很多钱。</p>
<p>虽然大多数人每天都想一夜暴富，但相应的，他们需要承担爆炸式的风险，做好破产的心理准备。</p>
<p>如果说你在自然界里割伤了，然后每天都在流血，你最终会因失血而死亡，你必须想办法及及时想办法挽救生命。但其实现实生活没那么夸张，我们并不是每天都在流血，流血在这里只是一个比喻，每天让自己损失一点点。</p>
<p>但现实是，大部分人都不这么做，相反他们每天都在追求着小的胜利，这最终会被证明是不合算的。我想说的是，如果你愿意每天都流一点点血，将来你会赢一笔大的。</p>
<p>其实，这就是创业精神，企业家们每天都在流血（bleed a little）。他们不是在赚钱，他们是在赔钱，而且他们总是亚历山大，因为所有的责任都在他们身上，但是当他们赢了，他们就会大赚一笔，所以总体上来看他们会赚得更多。</p>
<h2>第十九条：勇敢承担责任才能获得影响力</h2>
<p><strong>勇敢冒险你就会在社会上获得影响力</strong></p>
<h3>你需要通过责任获得影响力</h3>
<p>Nivi: 我们何不谈谈责任呢，我觉得这很有趣，我估计你对此有自己独特的看法。因此，你的关于责任的第一条推文是，“拥抱责任，以自己的名义承担商业风险。社会将以责任、公平和影响力来回报你。”</p>
<p>Naval: 是啊，所以要想发财，你需要杠杆。杠杆来自于劳动力、资本，也可能是通过代码和媒体。但其中的大多数，比如<strong>劳动力和资本，必须来自于他人的给予</strong>。对于劳动力，必须是有人愿意跟随你；对于资本，必须有人给你钱或资产来让你管理和使用。</p>
<p>所以要得到这些，你必须建立信誉，而且你必须尽可能以自己的名义去做，当然这也是有风险的。所以责任是一把双刃剑。它能让你在事情顺利的时候收获信誉，在事情糟糕的时候承受失败的冲击。</p>
<h3>以自己的名义承担商业风险</h3>
<p>从这个意义上说，那些在各种事物上贴上自己标签的人并不愚蠢，他们只是对自己有信心。也许最终结果是愚蠢的，但如果你看到一个坎耶、奥普拉、特朗普、马斯克或其他类似的人，这些人之所以可以凭借自己的名字致富，是因为他们的名字就是强大的敲门砖。</p>
<p>不管你如何看待特朗普，你必须意识到，这家伙的名字就是世界名片。你为什么要去特朗普赌场？只是因为是特朗普。你为什么要去特朗普大厦？也是因为特朗普。</p>
<p>到了投票的时候，我想很多选民只是进去说“特朗普”，他们认出了这个名字，所以这个名字得到了回报（获得选票）。</p>
<p>奥普拉也是同样的，她把某样东西打上自己的标签，当商品到达人们手中，她的名字就是这些商品的招牌。</p>
<p>这些人在坚持把自己的名字打造成招牌的同时当然也面临着一系列的风险。显然，特朗普现在可能被世界上的一大部分人憎恨着，也同样是因为特朗普式的风格。</p>
<p>把你的名字公之于众，你就会成为一个名人，而名声也有很多缺点。<strong>隐姓埋名、有钱总比穷出名好，但即便是名利双收，也有很多不利因素。你需要在公众的眼皮子底下生活</strong>。</p>
<h3>一个运作良好的团队对每个职位都有明确的责任分工</h3>
<p>责任感是非常重要的，当你正在开发一个产品，或者你在一个团队中工作，或者你在一个企业中工作时，我们就会不断地提醒自己成为一个团队的一员是多么的重要。这的确是非常重要的。</p>
<p>我们在社交方面的很多训练都告诉我们不要强出头。就像中国的一句俗语，枪打出头鸟，别紧张，但是我要说的是，一个真正运作良好的团队规模很小，对每一个不同的部分都有明确的责任分工。</p>
<p>你可以说，“好吧，这个人负责制造产品，这个人负责信息发布，这个人负责筹款，这个人负责定价策略，也可能负责在线广告。“所以如果有人搞砸了，你就知道到底是谁负责。同时，如果事情进展顺利，你也清楚地知道是谁做得很好。</p>
<p>如果你有一个很小的团队，并且你已经清楚地划分了责任，那么你仍然可以保持很高的责任感。问责制在面对结果时显得真的很重要，不然就会出现，如果失败了，每个人都会互相指责，如果成功了，每个人都会站出来争夺功劳。</p>
<p>我们在学校的时候都有过这样的经历，有一个小组作业要做，里面可能有几个人做了很多工作，然后有一些人只是做了很多哗众取宠的工作或者强行给自己做的工作加戏。我们从小就习以为常，但说出来难免会感到不舒服。</p>
<h3>能在公众面前坦然面对失败的人都有很大的能量</h3>
<p>明确责任很重要。没有责任感，你就没有动力；没有责任感，就无法建立信誉。但你要冒险，你冒着失败的风险冒着被羞辱的危险，你冒着以自己名义承受失败的风险。</p>
<p>幸运的是，在现代社会，不再有债务人的监狱，人们也不会因为失去别人的钱而坐牢或被处死，但与生俱来的，我们不会以自己的名义在公共场合失败。那些以自己的名义在公共场合面对失败的人，实际上拥有很大的能量。</p>
<p>例如，我讲一个个人轶事。直到2013年，2014年，我的公众形象完全围绕着创业和投资。直到2014年、2015年左右，我才开始谈论哲学、心理学等等。</p>
<p>这让我有点紧张，因为<strong>我是以自己的名义做的</strong>。肯定有业内人士通过背后悄悄戳我，比如“你在干什么？你要结束你的职业生涯了吗？这太愚蠢了。”</p>
<p>我有点同意了，的确，我冒险了。</p>
<p>当你把你的名字放在那里，你就要冒着某些风险。但同时你也会得到回报，你会得到好处的。</p>
<h2>第三十五条：冷静的头脑，健康的身体，充满爱的家庭</h2>
<p><strong>当你变得富有时，你会发现这些都不是你一直以来追求的</strong></p>
<p>Nivi：最后一条关于长期工作的推特是：“当你最终变得富有时，你会意识到这些并不是你最初想要的。”</p>
<p>Naval：这本身就是一个能谈论很久的话题。首先，我认为这是一个非常聪明的结论，它解放了那些说“致富有什么意义？”的人们的思想武装。有很多人喜欢以德服人，反对创造财富或赚钱的想法。这其实也没错。是的，钱能解决你所有能用钱解决的问题，但钱也不是万能的。</p>
<p><strong>当你赚了一大笔钱后，你首先意识到你仍然是同一个人</strong>。如果你本来快乐，你就还是快乐的。如果你本来不快乐，你就会不快乐。如果你平静、满足、平和，你还是那个人。我认识很多非常富有的人，他们身材非常不好。我也认识很多有钱人，他们的家庭生活很糟糕。我同时也知道很多有钱人，他们内心很混乱。</p>
<h3>平静的头脑，健康的身体和充满爱的家庭必须要经营</h3>
<p>我想到我之前发的另一条推特，也是我最喜欢的一条。它不一定是最有见地的，也不一定是最有用的，这甚至不是我想的最清楚的。但那里面有一个非常确定的事实，它引起了共鸣。</p>
<p>“健康的身体，平静的头脑，充满爱的家庭。这些东西是买不来的，必须要经营才能得到。”</p>
<p>即使你拥有世界上所有的钱，你也不会拥有这三样东西。Jeff Bezos（亚马逊董事长）还得健身，他也得为他的婚姻努力，他的内在精神状态仍然很难不被外部事件所影响。这将取决于他内心的平静与安宁。因此，我认为这三件事——你的身体健康，你的心理健康和你的亲密关系是你必须要培养的。他们能给你带来比任何金钱都多的安宁和幸福。</p>
<h3>关于平静内心状态的实用性建议</h3>
<p>如何才能保持内心平静，这个话题是我一直在研究的。我大概有100条这个方面的推特。在这个话题上，最近经常会遭到至少50种不同形式的攻击。所以我一直在犹豫要不要做，因为我想针对一种非常特殊的人群。</p>
<p>有很多人不相信研究内在状态是有用的，他们太注重外在。没关系，这样也的确没什么问题。这就是“如何致富”推特系列的目的。有很多人认为唯一值得努力的就是<strong>彻底解放(complete liberation)</strong>，就像，你成了佛。他们会怀疑过程中的任何东西，认为它们毫无用处。但事实是绝大多数人没法儿成佛不是吗？</p>
<p><strong>我想创建一个新的推特系列，来为那些想要一个更平静的内在的人们提供实用的建议</strong>。一套理解、分辨半真半假和真理的理论，如果你能正确地吸收它们，这些都是指向你已经拥有的想法和经验的指针；如果你把这些理论慢慢融会贯通，它将帮助你、引导你进入一个更平静的内在状态，这就是我想做的。</p>
<p>健身是另一个大问题，我不是这方面的专家，推特上有很多比我更擅长健身的专业人士。</p>
<h3>很多离婚案例是为了钱，很多争吵是因为内心恐惧</h3>
<p>我认为，一个充满爱的家庭和人际关系实际上是自然而然地从其他事情中脱颖而出的。如果你有一个冷静的头脑，你已经赚了钱，你应该有良好的关系。你没有理由不这样做，很多离婚都是为了钱，不幸的是，这就是现实，有了钱但是丢失了家庭这部分。</p>
<p>很多外在的纷争主要是因为你的内在状态不好。当你内心自然平静的时候，你会选择更少的争斗，你会变得更有爱心而不期待任何回报，这会让你应对外部关系更加得心应手。</p>
<p>Nivi：总结一下，钱能解决你的关于金钱的问题，金钱可以让你在物质世界中获得自由。金钱能给你不去做你不想做的事情的自由。</p>
<p>Naval：是啊。对我来说，金钱的最终目的是让你不必在某个特定的地方的某个特定的时间，做任何你不想做的事情。</p>
<h2>第三十六条：没有什么快速致富的方法</h2>
<p><strong>别相信能快速致富的鬼话，那些人只是想从你身上赚钱而已</strong></p>
<p>Nivi：我们跳过了一条推文，因为我想涵盖所有关于长期话题的推文。我们跳过的那条推特是，“世界上没有快速致富的捷径，如果谁告诉你有，那不过是他想从你这里发财罢了。”</p>
<p>Naval：我们说回有效率的世界。如果有一种简单的致富方式，那就是已经被开发了。有很多人会向你推销如何赚钱的产品，比如他们总是卖给你一些79-95美元的课程或一些有声读物，或研讨会门票。这没什么对错，人们总是需要谋生。他们可能真的有很好的建议，但如果他们给你可行的、高质量的建议，承认这（致富）是一个艰难的旅程，会花很多时间，那么我认为这是现实的。但是，如果他们卖给你一些快速致富的各种线上线下的产品，他们只是想从你身上赚钱，你要掂量一下它的价值。</p>
<h3>我们不放广告，因为我们知道那只会损害信誉</h3>
<p>关于整个推特风暴和这个播客，我想强调的一件事是我们这里没有广告，也不收任何费用。我们不卖任何东西。不是因为我不想赚更多的钱，赚更多的钱总是好的。但是，它会完全破坏企业的信誉。如果我说，“嘿，我知道如何致富，我要把它卖给你。“这就毁了它。</p>
<p>我年轻的时候就开始思考致富的话题，我最喜欢的书之一就是《如何致富》，作者是Felix Dennis，《Maxim》杂志的创始人，一位去世的亿万富翁。他写了很多疯狂的东西，但他对财富的理解真的好。</p>
<p>但每当我读到他或GoDaddy创始人鲍勃·帕森斯或安德鲁·卡内基的作品时，这些已经非常富有的人写的东西，他们显然是在其他领域发家致富的，而不是靠<strong>推销如何致富的方法</strong>。他们不是想从你身上赚钱。他们显然是想赢得一些地位和一些自尊，对吧，你总是要有做某事的动机。但是，至少这是他们没有撒谎的一个更清晰的理由。</p>
<h3>每个创始人都会对他的员工撒谎</h3>
<p>在某种程度上，每个创始人都要对公司的每个员工撒谎。他们必须让员工觉得，你为我工作比做你自己想做的事，为你自己工作（创业）要好。同样作为一个创始人，但对此我总是很难接受。</p>
<p>于是我开始尝试一些保持诚实的方法，我招募了一些有企业家精神的员工，然后告诉他们，“你们可以在这个公司成为企业家，当你们准备好开始自己的事业的那一天，我将支持你们。我永远不会妨碍你创业。但在你想开始一些新东西之前，这里可能是一个好地方，让你学习如何构建一个良好的团队，建立一个好的企业文化，通过打磨自己的技能找到适合的产品市场，见更多更加优秀的人、和他们交流碰撞，直到最终想通自己到底想做什么。因为定位、时机、以及必要的深思熟虑，在开始创业时很重要。”</p>
<p>但我从来不会做一些无谓的监督，告诉员工“你必须在早上8点之前到你的办公桌。”因为我自己就不会在早上8点之前坐在办公桌前，我想要自由。这就像告诉他们你今天很擅长做董事，明天你就会成为副总裁。这种话我自己都不相信。</p>
<h3>任何提供致富建议的人，去想想别的赚钱方式吧</h3>
<p>就好像，你不会想从一个胖子那里学到如何保持健康；也不会想从一个抑郁的人那里学到如何快乐。所以，你不会想从一个穷人那里学习如何致富，也一定不想从一个通过告诉别人如何致富来赚钱的人那里学习如何致富。想想都奇怪不是吗？</p>
<p>Nivi：任何时候，如果你看到有人按照大师的建议致富了，只要记住，在任何随机事件中，如果你持续足够长的时间，如果有足够多的人参与其中，你就会得到想要的结果。</p>
<p>Naval：这里面存在着幸存者偏差，这也是为什么当商业记者和经济学家谈论私营公司时，你可以完全忽视他们的原因。</p>
<p>我不会指名道姓，但当一位著名的经济学家对比特币大加抨击，或者当一名商业记者攻击最新一家即将上市的公司时，这完全是胡说八道。那些人什么都没做，他们只是「专业的评论家」。他们对赚钱一无所知。他们只知道如何通过吐槽和批评来博眼球。你要是不停的被他们洗脑可就太蠢了。</p>
<p>最后我想引用纳西姆·塔勒布*的一句话，我很喜欢他说的话，“如果你想成为一个哲学家，先当国王，再当哲学家。”不是先成为哲学家，再成为国王。”</p>
<p>Nivi：我很高兴你提到了塔勒布，我想请大家记住他成名作的书名《随机骗局》。</p>
<p>Naval：我们在这期播客中有些模糊的原因之一是，我们试图去讨论值得长期遵循的原则，而不仅仅是告诉你昨天中奖的彩票号。</p>
<h2>第三十七条：产品化你自己</h2>
<p><strong>找出你最擅长的，并尽可能多地运用杠杆</strong></p>
<p>Nivi：你用两个词概括了整个推特风暴。“产品化（Productize）你自己。”</p>
<p>Naval：产品化你自己这个概念的意思是：<strong>你自己</strong>是独特的、有责任心的，<strong>产品化</strong>需要独特的技能和杠杆。所以所有这些部分，你可以把它们合并成这两个词。</p>
<p>如果你想要长期致富，你应该问自己：“这是我的真实想法吗？”我在打造的是我自己吗？然后，“我在生产它吗？”我在规模化它吗？我是在用劳动力还是资本，代码还是媒体来衡量？所以这是一个非常方便、简单的记忆方法。</p>
<p>这是什么播客？这是一个叫做Naval的播客。我实际上是在用播客在产品化自己的一部分</p>
<p>Nivi：你要弄清楚你有什么特别擅长的，或者你有什么特别之处，然后尽可能地运用杠杆。在这种情况下你不是在刻意赚钱，赚钱甚至也不是一种技能。你就是在做你自己，探索成千上百种方式找到真正的你。</p>
<h2>找到让你富有、健康和有创造力的爱好</h2>
<p>Naval：赚钱应该取决于你是谁和你喜欢做什么。另一条我特别喜欢的推特是...这不是我说的，是别人发过的。他们说“找三个爱好”。一个能让你赚钱，一个能让你保持健康，一个能让你富有创造力。”</p>
<p>我会稍微改变一下。我会说，找到三个爱好，一个让你赚钱，一个让你健康，一个让你更聪明。就我而言，我的爱好是阅读，赚钱，因为我喜欢与初创公司合作。要么投资，要么集思广益，要么开始行动。我很喜欢创业初期的创意和创造阶段。</p>
<p>至于让你保持健康的爱好，我真的没有。我最喜欢的是瑜伽，但那是我崩溃的地方。我认为，那些早年发现冲浪、游泳、网球或某种他们一生中大部分时间都在做的运动的人是非常幸运的，因为他们发现了一种使他们健康的爱好。</p>
]]></content:encoded>
      <enclosure url="https://i.imgur.com/WubW2ud.jpg" type="image/jpeg"/>
    </item>
    <item>
      <title>程序员延寿指南</title>
      <link>http://blog.cjhe.top/other/how-to-live-longer.html</link>
      <guid>http://blog.cjhe.top/other/how-to-live-longer.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">程序员延寿指南</source>
      <description>【转】原文链接</description>
      <category>转载</category>
      <pubDate>Fri, 03 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>【转】<a href="https://github.com/geekan/HowToLiveLonger" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<h1>程序员延寿指南</h1>

<h2>1. 术语</h2>
<ul>
<li>ACM: All-Cause Mortality / 全因死亡率</li>
</ul>
<h2>2. 目标</h2>
<ul>
<li>稳健地活得更久</li>
</ul>
<h2>3. 关键结果</h2>
<ul>
<li>降低66.67%全因死亡率</li>
<li>增加~20年预期寿命</li>
<li><s>维持多巴胺于中轴</s></li>
</ul>
<h2>4. 分析</h2>
<ul>
<li>主要参考：对ACM的学术文献相对较多，可以作为主要参考</li>
<li>增加寿命与ACM关系非线性：显然增加寿命与ACM关系是非线性函数，这里假设 <code>DeltaLifeSpan=(1/(1+DeltaACM)-1)*10</code>（DeltaACM为ACM变化值；公式欢迎优化）</li>
<li>变量无法简单叠加：显然各个变量之间并不符合独立同分布假设，变量之间的实际影响也并不明确</li>
<li>存在矛盾观点：所有的证据都有文献/研究对应，但注意到：有些文献之间有显著矛盾的观点（如对于碳水摄入比例的矛盾）；有些文献存在较大争议（如认为22点前睡觉会提升43%全因死亡率）</li>
<li>研究仅表达相关：所有文献表明的更多是相关而非因果，在阅读时要考虑文献是否充分证明了因果 —— 如某文献表明了日均&gt;=7000步的人有显著低的全因死亡率。但步数少的人可能包含更多长期病患，如果没有合理的排除这块数据，那此文献调查失真</li>
</ul>
<h2>5. 行动</h2>
<ul>
<li>输入
<ul>
<li>固体：吃白肉（-11%~-3% ACM）、蔬果为主（-26%~-17% ACM），多吃辣（-23% ACM），多吃坚果（-27%~-4% ACM），<em>少吃蛋黄（否则+7% ACM/0.5颗/天）（存在争议）</em>，中量碳水、多吃植物蛋白（-10% ACM），少吃超加工食物（-62%~-18%）</li>
<li>液体：喝咖啡（-22%~-12% ACM），喝牛奶（-17%~-10% ACM），喝茶（-15%~-8% ACM），少喝或不喝甜味饮料（否则每天一杯+7% ACM，+多巴胺），戒酒或每周100g（纯酒精量(g)=饮酒量(ml)×酒精浓度(%)×酒精密度0.8g/ml）内（否则+~50% ACM，无上限）</li>
<li>气体：不吸烟（否则+~50% ACM，-12~-11年寿命）</li>
<li>光照：晒太阳（-~40% ACM）</li>
<li>药物：二甲双胍（糖尿病人相比正常人可以+3年）、复合维生素（-8%癌症风险）、亚精胺（-60%~-30% ACM）、葡萄糖胺（-39% ACM）</li>
</ul>
</li>
<li>输出
<ul>
<li>运动：每周3次45分钟挥拍运动（-47% ACM）</li>
<li>日常：刷牙（-25% ACM）</li>
<li>睡眠：每天睡7小时全因死亡率最低；且22-24点间最好，<em>早睡+43% ACM，晚睡+15% ACM（存在争议）</em></li>
</ul>
</li>
<li>上下文
<ul>
<li>体重：减肥（-54% ACM）</li>
</ul>
</li>
</ul>
<h2>6. 证据</h2>
<h3>6.1. 输入</h3>
<h4>6.1.1. 固体</h4>
<ul>
<li>白肉
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/268401670" target="_blank" rel="noopener noreferrer">JAMA子刊：食用红肉和加工肉类会增加心脏病和死亡风险！鱼肉和家禽肉则不会</a>
<ul>
<li>出处：<a href="https://jamanetwork.com/journals/jamainternalmedicine/articlepdf/2759737/jamainternal_zhong_2020_oi_190112.pdf" target="_blank" rel="noopener noreferrer">Associations of Processed Meat, Unprocessed Red Meat, Poultry, or Fish Intake With Incident Cardiovascular Disease and All-Cause Mortality</a></li>
<li>增加红肉摄入与死亡风险相关。八年内平均每天增加至少半份红肉摄入（半份红肉相当于14g加工红肉或40g非加工红肉）的调查对象，在接下来八年内全因死亡风险增加10％（HR, 1.10; 95%CI, 1.04-1.17）；每周吃两份红肉或加工肉类（但不包括家禽或鱼类）会使全因死亡风险增加3%</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703960-6f321de5-4daa-4ea5-95b9-af9c96f1c1bc.jpg" alt="红肉" tabindex="0" loading="lazy"><figcaption>红肉</figcaption></li>
</ul>
</li>
<li><a href="https://www.zhihu.com/question/67223570/answer/809785380" target="_blank" rel="noopener noreferrer">红肉和白肉最大的区别是什么？为啥要这么分呢？</a></li>
</ul>
</li>
<li>蔬果
<ul>
<li><a href="https://www.sohu.com/a/322360740_164924" target="_blank" rel="noopener noreferrer">每年54万人死亡，竟是因为水果吃得少！？这已成十大死亡因素之一！</a>
<ul>
<li>出处：<a href="https://academic.oup.com/cdn/article-abstract/3/Supplement_1/nzz028.FS01-01-19/5516583" target="_blank" rel="noopener noreferrer">Estimated Global, Regional, and National Cardiovascular Disease Burdens Related to Fruit and Vegetable Consumption: An Analysis from the Global Dietary Database (FS01-01-19)</a></li>
<li>每天摄入200克新鲜水果可使死亡率降低17%，糖尿病大血管并发症（如中风、缺血性心脏病等）风险降低13%，及糖尿病小血管并发症（如糖尿病肾病、糖尿病眼病、糖尿病足病等）风险降低28%</li>
</ul>
</li>
<li><a href="https://mp.weixin.qq.com/s/E6BAi-Vnhr1jXBm0Pys2ZQ" target="_blank" rel="noopener noreferrer">《自然》子刊：每天二两西兰花，健康长寿都有啦！分析近6万人23年的数据发现，吃含黄酮类食物与死亡风险降低20%相关丨临床大发现</a>
<ul>
<li>出处：<a href="https://www.nature.com/articles/s41467-019-11622-x" target="_blank" rel="noopener noreferrer">Flavonoid intake is associated with lower mortality in the Danish Diet Cancer and Health Cohort</a></li>
<li>吃含黄酮类食物与死亡风险降低20%相关</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703969-42e64f88-e727-4e7d-85f2-07a92e29b613.jpg" alt="黄酮" tabindex="0" loading="lazy"><figcaption>黄酮</figcaption></li>
<li>Bondonno博士说道“吃不同蔬菜、水果补充，不同种类的黄酮类化合物是很重要的，这很容易通过饮食实现：一杯茶、一个苹果、一个橘子、100克蓝莓，或100克西兰花，就能提供各种黄酮类化合物，并且总含量超过500毫克。</li>
</ul>
</li>
</ul>
</li>
<li>辣椒
<ul>
<li><a href="https://3g.163.com/dy/article/F6Q7I1ME053228ZU.html" target="_blank" rel="noopener noreferrer">辣椒成死亡克星？据调研，常吃辣患病死亡风险可降低61%</a>
<ul>
<li>出处1：<a href="https://www.sciencedirect.com/science/article/pii/S0735109719382063" target="_blank" rel="noopener noreferrer">Chili pepper consumption and mortality in Italian adults</a></li>
<li>出处2：<a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0169876" target="_blank" rel="noopener noreferrer">The Association of Hot Red Chili Pepper Consumption and Mortality: A Large Population-Based Cohort Study</a></li>
<li>2017年Plos One 的另一项来自美国的研究以16179名，年龄在18岁以上的人群为对象，并对其进行了高达19年的随访，发现在4946例死亡患者中，食用辣椒的参与者的全因死亡率为21.6％，而未食用辣椒的参与者的全因死亡率为33.6％。相较于不吃辣或很少吃（少于每周两次）的人群，每周吃辣＞4次的人群总死亡风险降低23%，心血管死亡风险降低34%。</li>
</ul>
</li>
</ul>
</li>
<li>鸡蛋
<ul>
<li><a href="https://m.thepaper.cn/baijiahao_11540780" target="_blank" rel="noopener noreferrer">每天多吃半个蛋，增加7%的全因和心血管死亡风险？</a>
<ul>
<li>出处：<a href="https://dietandhealth.cancer.gov/" target="_blank" rel="noopener noreferrer">NIH-AARP工作主页</a>、<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7872242/" target="_blank" rel="noopener noreferrer">Egg and cholesterol consumption and mortality from cardiovascular and different causes in the United States: A population-based cohort study</a></li>
<li>每天多吃半个蛋，增加7%的全因和心血管死亡风险？在假设性替代分析中，研究者发现，用等量的蛋清/鸡蛋替代物、家禽、鱼、乳制品、坚果和豆类分别替代半只全蛋（25克/天）可以降低6%、8%、9%、7%、13%和10%的全因死亡率。
*<a href="https://raw.githubusercontent.com/qhy040404/Image-Resources-Repo/master/pmed.1003508.g002.jpg" target="_blank" rel="noopener noreferrer">鸡蛋</a></li>
</ul>
</li>
</ul>
</li>
<li>坚果
<ul>
<li><a href="https://www.163.com/dy/article/GKVOMMMF05148PF4.html" target="_blank" rel="noopener noreferrer">哈佛20年研究：吃核桃的人更长寿，显著减少全因死亡，延长寿命</a>
<ul>
<li>出处：<a href="https://www.mdpi.com/2072-6643/13/8/2699/pdf" target="_blank" rel="noopener noreferrer">Association of Walnut Consumption with Total and Cause-Specific Mortality and Life Expectancy in US Adults</a></li>
<li>通过分析发现，经常食用核桃可以延长寿命，降低心血管疾病死亡风险。比起不吃核桃，每周食用核桃5份以上（1份28克）的健康预期寿命延长1.3岁，全因死亡风险降低14%，心血管疾病死亡率降低25%。</li>
</ul>
</li>
<li><a href="https://zhuanlan.zhihu.com/p/44454030" target="_blank" rel="noopener noreferrer">研究：每日食生坚果，死亡率降20%</a>
<ul>
<li>出处1：<a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1307352" target="_blank" rel="noopener noreferrer">Association of nut consumption with total and cause-specific mortality</a></li>
<li>出处2：<a href="https://americanpistachios.cn/sites/china/files/inline-files/APG_Health-%26-Nutrition-Research-Brochure_DEC-19-18.pdf" target="_blank" rel="noopener noreferrer">APG_Health-&amp;-Nutrition-Research-Brochure_DEC-19-18</a></li>
<li>研究人员发现，每周吃树坚果低于1盎司份量的人，死亡率降低7％。而每周吃了1盎司份量的人，减少11％的死亡率；每周吃2份量的人，减低13％；每周5至6份量者，减少了15％；一周7份以上的人，死亡率则减少20％。</li>
<li>另外两篇发表在《公共科学图书馆在线期刊》(Public Library of Science Online Journal)和《生物医学中心》(BioMed Central)上的医学预科研究论文，展示了试验开始时的横断面数据。这两项研究都评估了7,216名对象，以及他们食用坚果的频率和数量之间的关系。那些每周食用三份以上坚果(包括开心果)的研究对象的死亡率降低39%。</li>
</ul>
</li>
</ul>
</li>
<li>钠（存有大量争议）
<ul>
<li><a href="https://nursing.medsci.cn/article/show_article.do;jsessionid=A34E8A33918A152CB55BDD2E5FB1798D?id=afe720486ee7" target="_blank" rel="noopener noreferrer">Eur Heart J：钠摄入量与预期寿命、全因死亡率的关系</a>
<ul>
<li>出处：<a href="https://europepmc.org/backend/ptpmcrender.fcgi?accid=PMC8169157&amp;blobtype=pdf" target="_blank" rel="noopener noreferrer">Messerli F H, Hofstetter L, Syrogiannouli L, et al. Sodium intake, life expectancy, and all-cause mortality[J]. European heart journal, 2021, 42(21): 2103-2112.</a></li>
<li><img src="https://user-images.githubusercontent.com/2707039/164894778-9710f18d-e055-4f62-bdcb-618687771d77.jpeg" alt="ehaa947f6" tabindex="0" loading="lazy"><figcaption>ehaa947f6</figcaption></li>
<li>在该分析所包含的181个国家中，研究人员发现钠摄入量与出生时的健康预期寿命（β=2.6年/克每日钠摄入量，R<sup>2</sup>=0.66，P&lt;0.001）和60岁时的健康预期寿命（β=0.3年/克每日钠摄入量，R<sup>2</sup>=0.60，P=0.048）之间存在正相关关系，但与非传染性疾病死亡（β=17次事件/克每日钠摄入量，R<sup>2</sup>=0.43，P=0.100）无关。相反，全因死亡率与钠摄入量成负相关（β=−131次事件/克每日钠摄入量，R<sup>2</sup>=0.60，P&lt;0.001）。在仅限于46个收入最高国家的敏感性分析中，钠摄入量与出生时的健康预期寿命呈正相关（β=3.4年/克每日钠摄入量，R<sup>2</sup>=0.53，P&lt;0.001），而与全因死亡率（β=−168次事件/克每日钠摄入量，R<sup>2</sup>=0.50，P&lt;0.001）呈负相关。</li>
<li>该（大范围）研究认为更多的钠摄入与显著更低的全因死亡率有关</li>
<li><a href="https://www.tctmd.com/news/fresh-foray-salt-wars-life-expectancy-higher-greater-sodium-intake" target="_blank" rel="noopener noreferrer">针对该论文的延伸解读和讨论：A Fresh Foray in the Salt Wars: Life Expectancy Higher With Greater Sodium Intake</a></li>
</ul>
</li>
<li><a href="https://ibook.antpedia.com/x/669028.html" target="_blank" rel="noopener noreferrer">NEJM/Lancet：不要吃太多盐，中国饮食所致心血管病和癌症死亡全球第一，吃低钠盐可降低全因死亡率</a>
<ul>
<li>但也有多项研究认为用低钠盐可以降低一系列疾病的发生概率，对全因死亡率的减少有积极影响</li>
</ul>
</li>
</ul>
</li>
<li>碳水（存有大量争议）
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/137815934" target="_blank" rel="noopener noreferrer">低碳生酮饮食（四）碳水化合物与长期死亡率</a>
<ul>
<li>出处：The Lancet Public Health - <a href="https://www.sciencedirect.com/science/article/pii/S246826671830135X" target="_blank" rel="noopener noreferrer">Dietary carbohydrate intake and mortality: a prospective cohort study and meta-analysis</a></li>
<li>碳水越低，寿命越短；碳水越高，寿命也轻微缩短；碳水50%左右（其实按照一般的说法，这也算高碳水）是最长寿命区间</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703985-a2e2f8ac-101a-4f3c-903b-6850507f144b.jpg" alt="碳水" tabindex="0" loading="lazy"><figcaption>碳水</figcaption></li>
</ul>
</li>
<li><a href="https://www.chinacdc.cn/gwxx/202003/t20200323_214639.html" target="_blank" rel="noopener noreferrer">最强营养搭配！BMJ：这么吃，心血管疾病和死亡风险更低</a></li>
</ul>
</li>
<li>槟榔
<ul>
<li><a href="https://www.zhihu.com/question/312784161/answer/603370131" target="_blank" rel="noopener noreferrer">如何看待槟榔嚼出来的癌症？槟榔致癌风险究竟有多大？ - 丁香医生的回答 - 知乎</a>
<ul>
<li>出处：Chewing Betel Quid and the Risk of Metabolic Disease, Cardiovascular Disease, and All-Cause Mortality: A Meta-Analysis(https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0070679)</li>
<li>嚼槟榔会增加21%的全因死亡率</li>
</ul>
</li>
</ul>
</li>
<li>热量限制
<ul>
<li><a href="https://www.zhihu.com/question/31395511" target="_blank" rel="noopener noreferrer">怎么看待BBC《进食、断食与长寿》？</a>
<ul>
<li>限制卡路里动物实验：CR（热量限制，即少吃）延迟了恒河猴的多种疾病发病和死亡率，与CR动物相比，正常喂养的猴子的各种疾病患病风险增加2.9倍，死亡风险增加3.0倍。</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163703988-8767185b-326a-4783-b2e2-f190322bb7d6.jpg" alt="热量限制-恒河猴" tabindex="0" loading="lazy"><figcaption>热量限制-恒河猴</figcaption></li>
</ul>
</li>
</ul>
</li>
<li>综合
<ul>
<li><a href="https://www.chinacdc.cn/gwxx/202003/t20200323_214639.html" target="_blank" rel="noopener noreferrer">最强营养搭配！BMJ：这么吃，心血管疾病和死亡风险更低</a></li>
<li><a href="https://doi.org/10.1136/bmj.m688" target="_blank" rel="noopener noreferrer">Associations of fat and carbohydrate intake with cardiovascular disease and mortality: prospective cohort study of UK Biobank participants</a>
<ul>
<li>通过对这些参与者的数据进行分析，研究人员发现碳水化合物（糖、淀粉和纤维）和蛋白质的摄入与全因死亡率呈非线性关系，而脂肪则与全因死亡率呈线性相关。其中，较高的糖分摄入与全因死亡风险和患心血管疾病的风险较高均有关联，而较高的饱和脂肪酸摄入与全因死亡风险较高有关。</li>
<li>图1：各种营养元素与全因死亡之间的关系</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702022-8c2bfea9-ed5d-4fe0-8ead-e8740014b92b.jpg" alt="各种营养元素与全因死亡之间的关系" tabindex="0" loading="lazy"><figcaption>各种营养元素与全因死亡之间的关系</figcaption></li>
<li>图2：各种营养元素与心血管疾病之间的关系</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702084-97fb4a03-707c-475d-b88e-6fe2f8e87f92.jpg" alt="各种营养元素与心血管疾病之间的关系" tabindex="0" loading="lazy"><figcaption>各种营养元素与心血管疾病之间的关系</figcaption></li>
<li><strong>进一步研究表明，在所有的饮食模式中，全因死亡率风险最低的饮食方式为：10-30g高纤维、14-30%蛋白质、10-25%单不饱和脂肪酸、5%-7%多不饱和脂肪酸以及20%-30%淀粉摄入。</strong></li>
<li><strong>最优能量来源配比：&lt;24%淀粉，15%-17%蛋白质，&gt;15%单不饱和脂肪酸，&lt;15%糖，6%饱和脂肪酸，6%多不饱和脂肪酸，30g+高纤维</strong></li>
</ul>
</li>
<li><a href="https://med.ckcest.cn/details.html?id=5183272274855936&amp;classesEn=news" target="_blank" rel="noopener noreferrer">BMJ | 常吃薯片汉堡巧克力等食品，平均死亡年龄仅仅为58岁，死亡风险剧增</a>
<ul>
<li><a href="https://www.bmj.com/content/365/bmj.l1949.full" target="_blank" rel="noopener noreferrer">Rico-Campà A, Martínez-González M A, Alvarez-Alvarez I, et al. Association between consumption of ultra-processed foods and all cause mortality: SUN prospective cohort study[J]. bmj, 2019, 365.</a></li>
<li><a href="https://www.bmj.com/content/365/bmj.l1451" target="_blank" rel="noopener noreferrer">Srour B, Fezeu L K, Kesse-Guyot E, et al. Ultra-processed food intake and risk of cardiovascular disease: prospective cohort study (NutriNet-Santé)[J]. bmj, 2019, 365.</a></li>
<li><a href="https://www.researchgate.net/profile/Phillip-Baker-5/publication/333483796_Ultra-processed_food_and_adverse_health_outcomes/links/5f0c646ca6fdcc2f32336a95/Ultra-processed-food-and-adverse-health-outcomes.pdf" target="_blank" rel="noopener noreferrer">Lawrence M A, Baker P I. Ultra-processed food and adverse health outcomes[J]. bmj, 2019, 365.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>6.1.2. 液体</h4>
<ul>
<li>牛奶
<ul>
<li><a href="https://www.sohu.com/a/253940257_419768" target="_blank" rel="noopener noreferrer">《柳叶刀》调研21个国家13万人：每天1斤牛奶或酸奶，心血管死亡风险下降23%</a></li>
<li>出处：<a href="http://mdrf-eprints.in/1114/1/Association_of_dietary_patterns_and_dietary_diversity_with_cardiometabolic_disease_risk_factors.pdf" target="_blank" rel="noopener noreferrer">Association of dairy intake with cardiovascular disease and mortality in 21 countries from five continents (PURE): a prospective cohort study</a></li>
<li>与不食用乳制品的人相比，每天摄入两份乳制品（一份指244克牛奶/酸奶，15克奶酪或5克黄油）的人，<strong>全因死亡风险下降了17%</strong>，心血管死亡风险下降23%，中风风险下降33%</li>
</ul>
</li>
<li>茶
<ul>
<li><a href="https://www.jianshu.com/p/5461a205cf95?utm_campaign=hugo" target="_blank" rel="noopener noreferrer">10万中国人随访7年发现，每周喝三次茶与全因死亡风险降低15%，预期寿命增加1.26年相关</a></li>
<li>出处：<a href="https://www.researchgate.net/profile/Fangchao-Liu-4/publication/338483323_Tea_consumption_and_the_risk_of_atherosclerotic_cardiovascular_disease_and_all-cause_mortality_The_China-PAR_project/links/5e55e5e94585152ce8efe511/Tea-consumption-and-the-risk-of-atherosclerotic-cardiovascular-disease-and-all-cause-mortality-The-China-PAR-project.pdf" target="_blank" rel="noopener noreferrer">Tea consumption and the risk of atherosclerotic cardiovascular disease and all-cause mortality: The China-PAR project</a></li>
<li><a href="http://rs.yiigle.com/CN112338202202/1351516.htm" target="_blank" rel="noopener noreferrer">中国成年人饮茶与死亡风险的前瞻性关联研究</a></li>
<li>纳入分析的438 443例研究对象随访11.1年共发生死亡34 661例。与从不饮茶者相比，当前非每日饮茶者和每日饮茶者全因死亡HR值（95%CI）依次为0.89（0.86-0.91）和0.92（0.88-0.95）。分性别分析显示，饮茶对全因死亡风险的保护作用主要见于男性（交互P&lt;0.05）</li>
</ul>
</li>
<li>无糖（甜味）饮料
<ul>
<li><a href="https://www.zhihu.com/question/418598272/answer/1450648364" target="_blank" rel="noopener noreferrer">「无糖饮料使死亡风险增加 26 %」，是真的吗？</a>
<ul>
<li>相比于软饮料摄入量＜1杯/月的参与者，混合软饮料摄入≥1杯/天的参与者死亡风险增加18%，而<strong>摄入含糖软饮料或无糖软饮料会令死亡风险分别增加11%和27%。</strong></li>
<li><img src="https://user-images.githubusercontent.com/2707039/163704346-e7d92e7f-eba5-4673-8f15-3a96782c2e32.png" alt="饮料" tabindex="0" loading="lazy"><figcaption>饮料</figcaption></li>
</ul>
</li>
<li><a href="https://jamanetwork.com/journals/jamainternalmedicine/fullarticle/2749350" target="_blank" rel="noopener noreferrer">Association Between Soft Drink Consumption and Mortality in 10 European Countries</a></li>
</ul>
</li>
<li>有糖饮料
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/400746073" target="_blank" rel="noopener noreferrer">可乐和奶茶，增加全因死亡率高达62%！果汁降低免疫力，影响肝代谢！含糖饮料那些事</a>
<ul>
<li>每天1杯含糖饮料增加7%全因死亡率，2杯21%</li>
<li>在34年的随访中，研究人员发现，相比那些一个月喝1杯或者更少含糖饮料的人，每天喝2杯的人总体死亡风险升高了21%，心血管疾病死亡风险升高了31%，癌症死亡风险上升了16%。</li>
<li>只要每天多喝一杯含糖饮料，总体死亡风险将增加7%，心血管疾病的风险将增加10%，癌症相关的死亡风险将16%。</li>
<li>发表在国际顶级期刊《BMJ》上的一篇论文就证明了含糖饮料会在增加患癌风险，当然这篇文章验证的不仅仅是果汁，奶茶也有份——和含糖饮料相关的总体患癌风险要高出通常值18%，100%的鲜榨果汁也会使得整体的患癌风险上升12%。</li>
</ul>
</li>
</ul>
</li>
<li>果汁
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/66513350" target="_blank" rel="noopener noreferrer">JAMA子刊：100%纯果汁可能比含糖饮料更危险</a>
<ul>
<li>每天多摄入一份12盎司的含糖饮料，全因死亡率风险增加11%；</li>
<li>每天多摄入一份12盎司的果汁，全因死亡率风险增加24%。</li>
</ul>
</li>
</ul>
</li>
<li>咖啡
<ul>
<li><a href="https://news.bioon.com/article/6725420.html" target="_blank" rel="noopener noreferrer">重磅！多篇研究证实喝咖啡与人群全因死亡率降低直接相关</a></li>
<li><a href="https://www.sohu.com/a/439412995_100003595" target="_blank" rel="noopener noreferrer">科普 | 喝咖啡又多了一个新理由：降低死亡率！</a></li>
<li><a href="https://fanyi.pdf365.cn/help/249" target="_blank" rel="noopener noreferrer">地中海成年人咖啡消耗量及全因，心血管疾病和癌症的死亡率</a>
<ul>
<li>在最近的荟萃分析中，该研究包括来自不同国家的40项研究和3,852,651名受试者。在这项荟萃分析显示，咖啡摄入量与各种原因的死亡率，CVD和癌症死亡率之间存在非线性关系，每天摄入两杯咖啡的癌症死亡率最低(RR = 0.96)，CVD最低的死亡率，每天2.5杯(RR= 0.83)，全天最低死亡率为每天3.5杯(RR= 0.85)，并且随着咖啡消费量的增加，死亡率没有进一步降低或增加</li>
</ul>
</li>
</ul>
</li>
<li>亚精胺
<ul>
<li><a href="https://www.medsci.cn/article/show_article.do?id=420d12904103" target="_blank" rel="noopener noreferrer">Science：科学背书！从精液中发现的亚精胺，竟然有着抗衰老、抗癌、保护心血管和神经、改善肥胖和2型糖尿病等逆天神效</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/388942219" target="_blank" rel="noopener noreferrer">饮食中亚精胺摄入量高会降低死亡率</a></li>
</ul>
</li>
</ul>
<h4>6.1.3. 气体</h4>
<ul>
<li>吸烟
<ul>
<li><a href="https://www.medsci.cn/article/show_article.do?id=02ca2083319b" target="_blank" rel="noopener noreferrer">即使是低强度吸烟，也增加死亡风险！</a>
<ul>
<li>研究发现：在42 416名男性和86 735名女性（年龄在35-89岁之间，以前没有患病）中，18 985名男性（45%）和18 072名女性（21%）目前吸烟，其中33%的男性吸烟者和39%的女性吸烟者并不每天吸烟。8866名男性（21%）和53 912名女性（62%）从不吸烟。在随访期间，与从不吸烟相比，每天&lt;10支烟或每天≥10支烟的全因死亡率危险比分别为1.17（95%置信区间1.10-1.25）和1.54（1.42-1.67）。无论年龄或性别，危险比相似。与每日吸烟关系最密切的疾病是呼吸道癌症、慢性阻塞性肺病和胃肠道及血管疾病。在招募时已经戒烟的人的死亡率低于现在每天吸烟者。</li>
<li>吸烟者平均减少寿命11-12年</li>
</ul>
</li>
<li><a href="https://www.zhihu.com/question/24846224/answer/1719798177" target="_blank" rel="noopener noreferrer">吸烟让人过瘾是什么原理？有节制的吸烟依旧有害吗？</a></li>
</ul>
</li>
</ul>
<h4>6.1.4. 光照</h4>
<ul>
<li>晒太阳
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/76301306" target="_blank" rel="noopener noreferrer">晒太阳和死亡率的关系，如何科学，安全的晒太阳？
</a>
<ul>
<li>丹麦一项长达26年的研究发现，多晒太阳能显著延长寿命，即使是由于过度暴晒诱发皮肤癌的患者，平均寿命也比普通人长了6岁。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>6.1.5. 药物</h4>
<ul>
<li>NMN</li>
<li>二甲双胍
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/419202902" target="_blank" rel="noopener noreferrer">“胍”吹必看 丨我就是神药——二甲双胍</a>
<ul>
<li>二甲双胍不仅在多种肿瘤、心血管疾病及糖尿病中发挥保护作用，而且在肥胖、肝病、肾病及衰老方面也大放异彩。</li>
</ul>
</li>
<li><a href="https://zhuanlan.zhihu.com/p/357807109" target="_blank" rel="noopener noreferrer">二甲双胍2020最值得了解的“吃瓜”大新闻——护胃、健脑、抗衰、防癌还是致癌？</a></li>
<li><a href="https://baijiahao.baidu.com/s?id=1729999374705305768" target="_blank" rel="noopener noreferrer">二甲双胍真的那么神吗？美研究：父亲服用二甲双胍或致子女有缺陷</a></li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702325-5d427542-9ae5-4311-8979-d0d326a9832f.jpg" alt="二甲双胍" tabindex="0" loading="lazy"><figcaption>二甲双胍</figcaption></li>
<li>不良反应
<ul>
<li>作为一种使用近百年的药物，二甲双胍的不良反应已经非常明确，常见的有：维生素B12缺乏（7%-17.4%），胃肠道不良反应（最高53%），疲倦（9%），头痛（6%）；严重但不常见的不良反应包括乳酸酸中毒、肝损伤；也有研究表明可能对胎儿致畸</li>
</ul>
</li>
</ul>
</li>
<li>复合维生素
<ul>
<li><a href="https://health.qq.com/a/20121023/000026.htm" target="_blank" rel="noopener noreferrer">服用复合维生素可降低癌症危险8%，其他效果并不显著</a></li>
</ul>
</li>
<li>葡萄糖胺
<ul>
<li><a href="https://www.sohu.com/a/436372221_120873241" target="_blank" rel="noopener noreferrer">神奇！氨糖降低心血管死亡率65%，与定期运动效果相当</a></li>
<li>美国西弗吉尼亚大学最新研究发现 氨糖（软骨素） 可以降低心血管死亡率65%，降低总体死亡率39%，效果与坚持定期运动相对</li>
<li>该研究使用1999年至2010年，16,686名成年人的国家健康和营养检查(NHANES)数据，参与者的中位追踪时间为107个月，而其中有648位参与者定期且每服用日500-1000毫克的葡萄糖胺/软骨素一年以上。</li>
</ul>
</li>
<li>亚精胺
<ul>
<li><a href="https://www.medsci.cn/article/show_article.do?id=420d12904103" target="_blank" rel="noopener noreferrer">Science：科学背书！从精液中发现的亚精胺，竟然有着抗衰老、抗癌、保护心血管和神经、改善肥胖和2型糖尿病等逆天神效</a></li>
<li>亚精胺是最容易从人体肠道吸收的多胺。许多的食物中都含有大量的亚精胺，例如新鲜的青椒、小麦胚芽、花椰菜、西兰花、蘑菇和各种奶酪，尤其在纳豆等大豆制品、香菇和榴莲中含量更高。在本实验中，研究人员选择了829位年龄在45-84岁之间的参与者进行了为期20年的随访，分析了饮食中亚精胺摄入量与人类死亡率之间的潜在关联。</li>
<li>研究发现，女性的亚精胺摄入量高于男性，并且摄入量都会随着年龄的增长而下降。亚精胺的主要来源是全谷物（占13.4%）、苹果和梨（占13.3%）、沙拉（占9.8%）、芽菜（占7.3%）和马铃薯（占6.4%）。研究根据亚精胺摄入量将人群分为三组，低摄入量组（&lt;62.2 µmol / d）、中摄入量组（62.2–79.8 µmol / d）和高摄入量组（&gt; 79.8 µmol / d）。随访期间共记录了341例死亡，其中血管疾病137例，癌症94例，其他原因110例。经计算低中高三组的粗略死亡率分别为40.5%、23.7%和15.1%，这些数据表明亚精胺摄入量与全因死亡率之间的负相关关系显著。随着逐步对年龄、性别和热量的比例进行调整，这种相关关系依然显著。</li>
</ul>
</li>
<li>综合
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/145495570" target="_blank" rel="noopener noreferrer">《自然》子刊深度综述：如何开发抗衰老药</a></li>
<li><img src="https://user-images.githubusercontent.com/2707039/163702474-205baeec-f0ce-4e8d-96a4-36efe47534de.jpg" alt="如何开发抗衰老药" tabindex="0" loading="lazy"><figcaption>如何开发抗衰老药</figcaption></li>
</ul>
</li>
</ul>
<h3>6.2. 输出</h3>
<h4>6.2.1. 挥拍运动</h4>
<ul>
<li><a href="https://www.sohu.com/a/535581770_121124216" target="_blank" rel="noopener noreferrer">哪种运动性价比最高？权威医学杂志“柳叶刀”给出答案了</a>
<ul>
<li>一周三次，每次45-60分钟，挥拍运动，降低~47%全因死亡率</li>
<li>羽毛球、乒乓球、网球等都算挥拍运动，但由于西化研究背景，可能指网球更多。这隐式的表达了全身锻炼更为重要</li>
</ul>
</li>
</ul>
<h4>6.2.2. 走路</h4>
<ul>
<li><a href="http://www.shcell.org/219/3571.html" target="_blank" rel="noopener noreferrer">走路降低全因死亡率超过50%！每天走多少步最合适？《JAMA》子刊超10年研究告诉你答案</a>
<ul>
<li><img src="https://user-images.githubusercontent.com/2707039/163704147-afec1c79-799b-4db8-b547-1a2431d504c9.jpg" alt="走路降低全因死亡率" tabindex="0" loading="lazy"><figcaption>走路降低全因死亡率</figcaption></li>
<li>注1：这项研究参与者的平均年龄为45.2岁</li>
<li>注2：平均步数的多少与职业有关，此项研究仅表明相关性，还没有更深度的因果分析</li>
</ul>
</li>
</ul>
<h4>6.2.3. 刷牙</h4>
<ul>
<li><a href="https://www.cn-healthcare.com/articlewm/20211209/content-1293760.html" target="_blank" rel="noopener noreferrer">50万国人研究证实：不好好刷牙，致癌！血管疾病也会增多！</a>
<ul>
<li>经常不刷牙的人：癌症、慢性阻塞性肺病及肝硬化风险分别增加了9%、12%和25%，过早死亡风险增加25%。</li>
</ul>
</li>
</ul>
<h4>6.2.4. 泡澡</h4>
<ul>
<li><a href="https://www.cn-healthcare.com/article/20200326/content-533379.html" target="_blank" rel="noopener noreferrer">定期洗澡降低心血管疾病发作风险</a>
<ul>
<li>与每周一至两次泡澡或根本不泡澡相比，每天洗热水澡可以降低28%的心血管疾病总风险，降低26%的中风总风险，脑出血风险下降46%。而浴缸浴的频率与心源性猝死的风险增加无关。</li>
</ul>
</li>
</ul>
<h4>6.2.5. 做家务（老年男性）</h4>
<ul>
<li><a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0061529" target="_blank" rel="noopener noreferrer">Housework Reduces All-Cause and Cancer Mortality in Chinese Men</a>
<ul>
<li>72岁之后男性每周做重型家务可以减少29%平均死亡率</li>
<li>重型家务：吸尘、擦地板、拖地、擦洗窗户、洗车、搬动家具、搬煤气罐等等。</li>
<li>轻型家务：掸灰尘、洗碗、手洗衣服、熨烫、晾衣服、做饭、买日用品等等。</li>
</ul>
</li>
</ul>
<h4>6.2.6. 睡眠</h4>
<ul>
<li><a href="https://med.sina.com/article_detail_103_1_105491.html" target="_blank" rel="noopener noreferrer">超30万亚洲人数据：每天睡几个小时最有益长寿？</a>
<ul>
<li>在男性中，与睡眠时长为7小时相比：睡眠持续时间≥10小时与全因死亡风险增加34%相关；</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163704166-226b7ebb-92ce-4753-a3e7-77a87652a104.jpg" alt="睡眠-男" tabindex="0" loading="lazy"><figcaption>睡眠-男</figcaption></li>
<li>在女性中，与睡眠持续时间7小时相比：睡眠持续时间≥10小时与全因死亡风险增加48%相关；</li>
<li><img src="https://user-images.githubusercontent.com/2707039/163704169-c5c715aa-7130-403b-b0d1-ec34fab094d8.png" alt="睡眠-女" tabindex="0" loading="lazy"><figcaption>睡眠-女</figcaption></li>
</ul>
</li>
<li><a href="https://www.thepaper.cn/newsDetail_forward_14461799" target="_blank" rel="noopener noreferrer">颠覆认知！加拿大研究发现：早睡比熬夜或许更伤身，几点睡才好？</a>
<ul>
<li>其中一个结论为，就寝时间与全因死亡率的关联性强，过早睡觉和过晚睡觉都会影响健康，但是早睡增加的全因死亡率比晚睡增加的死亡率高，早睡增加了43%的死亡风险，而晚睡增加了15%的死亡风险。</li>
<li>这项调查研究，还存在很多局限性，比如没有直接证明就寝时间与死亡的关系，仅仅说明相关性，通过参与人群自我报告统计睡眠时间，数据不够客观</li>
</ul>
</li>
</ul>
<h3>6.3. 上下文</h3>
<h4>6.3.1. 情绪</h4>
<ul>
<li><a href="https://www.x-mol.com/paper/1288184397379059712/t?recommendPaper=1263704526086578176" target="_blank" rel="noopener noreferrer">悲观情绪与更高的全因死亡率和心血管疾病死亡率有关，但乐观情绪并不能起到保护作用</a></li>
<li><a href="https://www.nature.com/articles/s41598-020-69388-y?utm_source=xmol&amp;utm_medium=affiliate&amp;utm_content=meta&amp;utm_campaign=DDCN_1_GL01_metadata_scirep" target="_blank" rel="noopener noreferrer">Pessimism is associated with greater all-cause and cardiovascular mortality, but optimism is not protective</a>
<ul>
<li>在1993-1995年间，一项针对50岁以上澳大利亚人健康的双胞胎研究中包括了生活取向测试（LOT），其中包含乐观和悲观的项目。平均20年后，参与者与来自澳大利亚国家死亡指数的死亡信息相匹配。在2,978名具有很多可用分数的参与者中，有1,068人死亡。生存分析测试了各种乐观因素和悲观情绪分数与任何原因，癌症，心血管疾病或其他已知原因的死亡率之间的关联。年龄调整后的悲观量表上的核心与全因和心血管疾病死亡率相关（每1个标准差单位的危险比，95％置信区间和p值1.134、1.065–1.207、8.85×10 –5和1.196、1.045–1.368、0.0093 ），但不会因癌症死亡。乐观得分与悲观得分之间的相关性很弱（年龄调整后的等级相关系数= − 0.176），但与总死亡率或特定原因死亡率没有显着相关性。反向因果关系（引起悲观情绪的疾病）是不可能的，因为在那种情况下，心血管疾病和癌症都会导致悲观情绪。</li>
</ul>
</li>
</ul>
<h4>6.3.2. 贫富</h4>
<ul>
<li><a href="https://www.cn-healthcare.com/articlewm/20210727/content-1246348.html" target="_blank" rel="noopener noreferrer">JAMA子刊：贫富差距真能影响寿命？这可能是真的！</a>
<ul>
<li>该研究使用1994-1996年第一次收集的数据，并通过生存模型来分析净资产和长寿之间的关联。结果显示，共收纳5414 名参与者，平均年龄为 46.7岁，包括 2766 名女性。较高的净资产与较低的死亡风险相关。特别是在兄弟姐妹和双胞胎中（n = 2490），在较高的净资产和较低的死亡率之间观察到类似的关联，表明拥有更多财富的兄弟姐妹或双胞胎比拥有更少财富的兄弟姐妹/双胞胎活得更久。</li>
</ul>
</li>
</ul>
<h4>6.3.3. 体重</h4>
<ul>
<li><a href="https://www.chinacdc.cn/gwxx/202009/t20200904_218959.html" target="_blank" rel="noopener noreferrer">JAMA子刊：减肥要趁早，才能有效降低死亡率风险</a>
<ul>
<li>对体重减轻的死亡率风险评估发现，体重从肥胖减轻到超重的成年人与稳定肥胖人群相比，全因死亡率降低了54％（危险比为0.46），然而从成年初期的超重减轻到中年以前的正常体重的人群的死亡率风险并未降低（风险比为1.12）。</li>
<li><img src="https://raw.githubusercontent.com/qhy040404/Image-Resources-Repo/master/zoi200509t3_1596761185.02415.png" alt="Table3" tabindex="0" loading="lazy"><figcaption>Table3</figcaption></li>
</ul>
</li>
</ul>
<h4>6.3.4. 新冠</h4>
<ul>
<li><a href="https://www.nature.com/articles/s41591-020-1112-0.pdf" target="_blank" rel="noopener noreferrer">Magnitude, demographics and dynamics of the effect of the first wave of the COVID-19 pandemic on all-cause mortality in 21 industrialized countries</a>
<ul>
<li>目前来看，新冠死亡率（美国）在1.5%左右，人均预期寿命减少了2年</li>
</ul>
</li>
<li><a href="https://www.zhihu.com/question/510943670/answer/2308499719" target="_blank" rel="noopener noreferrer">如何看待美国CDC宣称新冠死亡人数被高估？</a></li>
<li><a href="https://www.cdc.gov/nchs/nvss/deaths.htm" target="_blank" rel="noopener noreferrer">NVSS deaths</a></li>
</ul>
]]></content:encoded>
      <enclosure url="https://user-images.githubusercontent.com/2707039/163703960-6f321de5-4daa-4ea5-95b9-af9c96f1c1bc.jpg" type="image/jpeg"/>
    </item>
    <item>
      <title>收集的一些网站</title>
      <link>http://blog.cjhe.top/other/website.html</link>
      <guid>http://blog.cjhe.top/other/website.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">收集的一些网站</source>
      <description>算法 数据结构和算法动态可视化 算法可视化 在线运行代码的算法可视化 数据结构可视化 算法实现 Linux 鸟哥的Linux私房菜 TLCL 精彩的Linux命令 命令行的艺术 CURL使用 设计模式 图说设计模式 Go设计模式 Go设计模式 设计模式 容器化 Docker-从入门到实践 Docker中文文档 从Docker到kubernetes进阶 ...</description>
      <category>转载</category>
      <pubDate>Sat, 04 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>算法</h2>
<p>数据结构和算法动态可视化<a href="https://visualgo.net/zh" target="_blank" rel="noopener noreferrer"></a></p>
<p>算法可视化<a href="https://www.chrislaux.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>在线运行代码的算法可视化<a href="https://algorithm-visualizer.org/" target="_blank" rel="noopener noreferrer"></a></p>
<p>数据结构可视化<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" target="_blank" rel="noopener noreferrer"></a></p>
<p>算法实现<a href="https://the-algorithms.com/" target="_blank" rel="noopener noreferrer"></a></p>
<h2>Linux</h2>
<p>鸟哥的Linux私房菜<a href="http://cn.linux.vbird.org/linux_basic/linux_basic.php" target="_blank" rel="noopener noreferrer"></a></p>
<p>TLCL<a href="http://billie66.github.io/TLCL/book/" target="_blank" rel="noopener noreferrer"></a></p>
<p>精彩的Linux命令<a href="https://www.cnblogs.com/nineep/p/6795650.html" target="_blank" rel="noopener noreferrer"></a></p>
<p>命令行的艺术<a href="https://github.com/jlevy/the-art-of-command-line/blob/master/README-zh.md" target="_blank" rel="noopener noreferrer"></a></p>
<p>CURL使用<a href="https://everything.curl.dev/" target="_blank" rel="noopener noreferrer"></a></p>
<h2>设计模式</h2>
<p>图说设计模式<a href="https://design-patterns.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go设计模式<a href="https://golangbyexample.com/all-design-patterns-golang/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go设计模式<a href="https://dev.to/gopher/go-all-design-patterns-code-with-workflow-ea1" target="_blank" rel="noopener noreferrer"></a></p>
<p>设计模式<a href="https://refactoringguru.cn/design-patterns" target="_blank" rel="noopener noreferrer"></a></p>
<h2>容器化</h2>
<p>Docker-从入门到实践<a href="https://www.cntofu.com/book/139/index.html" target="_blank" rel="noopener noreferrer"></a></p>
<p>Docker中文文档<a href="http://www.dockerinfo.net/document" target="_blank" rel="noopener noreferrer"></a></p>
<p>从Docker到kubernetes进阶<a href="https://www.qikqiak.com/k8s-book/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Kubernetes中文指南<a href="https://jimmysong.io/kubernetes-handbook/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Prometheus告警<a href="https://awesome-prometheus-alerts.grep.to/" target="_blank" rel="noopener noreferrer"></a></p>
<h2>设计</h2>
<p>Google API设计指南<a href="https://www.bookstack.cn/read/API-design-guide/API-design-guide-README.md" target="_blank" rel="noopener noreferrer"></a></p>
]]></content:encoded>
    </item>
    <item>
      <title>分支规范</title>
      <link>http://blog.cjhe.top/project-standard/branch.html</link>
      <guid>http://blog.cjhe.top/project-standard/branch.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">分支规范</source>
      <description>git-modelgit-model 提示 一个好的代码分支应该是怎样的❓</description>
      <category>项目规范</category>
      <pubDate>Tue, 11 Feb 2020 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015122301.png" alt="git-model" tabindex="0" loading="lazy"><figcaption>git-model</figcaption></figure>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>一个好的代码分支应该是怎样的❓</p>
</div>
<!-- more -->
<h2>分支模型</h2>
<p>我们经常使用Git用于管理版本，但如果没有清晰的流程和规范，会导致难以协调和维护。
Vincent Driessen 为了解决这个问题，提出<a href="https://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener noreferrer">A Successful Git Branching Model</a></p>
<figure><figcaption>git-model</figcaption></figure>
<h2>master分支</h2>
<p>这个分支保持最近发布到生产环境的代码。</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>不能在这个分支直接修改</li>
<li>生产环境运行的代码和该分支保持一致</li>
<li>master分支每合并一个hotfix/release分支，都会打一个版本标签</li>
</ul>
</div>
<h2>develop分支</h2>
<p>这个分支是我们的主开发分支</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>feature/release/hotfix都需要合并到该分支</p>
</div>
<h2>feature分支</h2>
<p>这个分支是用来开发新的功能，一旦开发完成，合并到develop分支并进入下一个release</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>分支命名建议：<code>feature/xxx-xxx</code></li>
<li>合并到develop分支需要删除该分支，如果有bug，在对应的release分支进行修复</li>
<li>feature分支合并到develop分支之前先pull一下develop分支，避免冲突</li>
</ul>
</div>
<h2>release分支</h2>
<p>当需要发布一个新的release的时候，基于develop分支创建一个release分支</p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<ul>
<li>分支名建议命名<code>release/xxx-xxx</code></li>
<li>测试人员基于release分支进行测试，如有bug，也在该分支修复，再测试。</li>
<li>完成release分支后需要合并到master和develop分支</li>
</ul>
</div>
<h2>hotfix分支</h2>
<p>当在现网发现bug时，需要创建一个hotfix分支进行修复，完成后合并到master和develop，hotfix的改动会进入下一个release</p>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<ul>
<li>建议命名：<code>hotfix/xxx-xxx</code></li>
<li>只能基于master分支创建hotfix分支</li>
</ul>
</div>
]]></content:encoded>
      <enclosure url="https://www.ruanyifeng.com/blogimg/asset/2015/bg2015122301.png" type="image/png"/>
    </item>
    <item>
      <title>目录规范</title>
      <link>http://blog.cjhe.top/project-standard/directory.html</link>
      <guid>http://blog.cjhe.top/project-standard/directory.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">目录规范</source>
      <description>提示 Go语言项目业界公认的目录结构是怎样的❓</description>
      <category>项目规范</category>
      <pubDate>Sun, 09 Feb 2020 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>Go语言项目业界公认的目录结构是怎样的❓</p>
</div>
<!-- more -->
<h2>目录结构</h2>
<blockquote>
<p>可以通过以下维度进行考量：</p>
<ul>
<li>
<p>命名清晰：目录命名需要简洁，清晰的表达出该目录实现的功能，做到一看到该目录名就知道是干嘛的；</p>
</li>
<li>
<p>功能明确：目录的功能必须明确，例如：api目录是接口服务、service目录是业务逻辑；</p>
</li>
<li>
<p>功能齐全：例如测试、构建、脚本、工具、文档等；</p>
</li>
</ul>
</blockquote>
<p>这里参考Go语言公认项目目录<a href="https://github.com/golang-standards/project-layout" target="_blank" rel="noopener noreferrer">project-layout</a>结构如下：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>.
├── api
├── assets
├── build
│   ├── ci
│   └── package
├── cmd
│   └── _your_app_
├── configs
├── deployments
├── docs
├── examples
├── githooks
├── init
├── internal
│   ├── app
│   │   └── _your_app_
│   └── pkg
│       └── _your_private_lib_
├── pkg
│   └── _your_public_lib_
├── scripts
├── test
├── third_party
├── tools
├── vendor
├── web
│   ├── app
│   ├── static
│   └── template
└── website
</code></pre></div><h2>应用目录</h2>
<h3>api目录</h3>
<blockquote>
<p>OpenAPI/Swagger规范、JSON模式文件、协议定义文件</p>
</blockquote>
<h3>cmd目录</h3>
<blockquote>
<p>该项目的主要应用，Go语言以main函数文件作为程序入口。每个应用程序的目录名称应与执行文件的名称相匹配，例如：<code>/cmd/myapp</code></p>
</blockquote>
<h3>examples目录</h3>
<blockquote>
<p>应用程序和公共库的示例</p>
</blockquote>
<h3>internal目录</h3>
<blockquote>
<p>存放私有应用和库代码，如果一些代码，你不希望在其他在其他应用和库中被导入，可以放在internal目录下。而对于私有应用共享的代码可以放在/internal/pkg目录下。
建议internal目录以各个组件的方式进行分层。</p>
</blockquote>
<h3>pkg目录</h3>
<blockquote>
<p>与internal相反，该目录存放可供其他外部应用程序使用的库代码。</p>
</blockquote>
<h3>vendor目录</h3>
<blockquote>
<p>该目录存放项目依赖，可通过<code>go mod vendor</code>创建。</p>
</blockquote>
<p>👀 注意</p>
<p>如果开发的是Go语言库，不要提交vendor依赖包</p>
<h3>test目录</h3>
<blockquote>
<p>其他外部测试应用程序和测试数据。对于更大的项目，有一个数据子目录是有意义的。例如：<code>/test/data</code>或者<code>/test/testdata</code></p>
</blockquote>
<p>👀 注意</p>
<p>Go 也会忽略以“.”开头的目录或文件。或“_”，因此您可以更灵活地命名测试数据目录。</p>
<h3>third_party目录</h3>
<blockquote>
<p>外部帮助工具，分支代码或其他第三方应用。</p>
</blockquote>
<h3>tools目录</h3>
<blockquote>
<p>该项目的支持工具</p>
</blockquote>
<p>👀 注意</p>
<p>这些工具可以从<code>pkg</code>和<code>internal</code>目录导入代码</p>
<h3>web目录</h3>
<blockquote>
<p>前端代码存放目录，用来存放Web静态资源，服务端模块和单页应用（SPAs）</p>
</blockquote>
<h3>assets</h3>
<blockquote>
<p>其他资产，例如：图像、徽标、CSS、JavaScript等</p>
</blockquote>
<h3>website</h3>
<blockquote>
<p>项目网站或者Github页面</p>
</blockquote>
<h2>项目管理目录与文件</h2>
<h3>build目录</h3>
<blockquote>
<p>打包和持续集成</p>
<p>将云 (AMI)、容器 (Docker)、操作系统（deb、rpm、pkg）包配置和脚本放在<code>/build/package</code>目录中。</p>
<p>将CI（travis、circle、drone）配置和脚本放在<code>/build/ci</code>目录中。</p>
</blockquote>
<p>👀 注意</p>
<p>一些 CI 工具（例如 Travis CI）对其配置文件的位置非常挑剔。尝试将配置文件放在/build/ci将它们链接到 CI 工具期望它们的位置的目录中（如果可能）。</p>
<h3>configs目录</h3>
<blockquote>
<p>配置文件，例如这里可以存放confd或consul-template模版文件。</p>
</blockquote>
<h3>deployments目录</h3>
<blockquote>
<p>IaaS、PaaS、系统和容器编排部署配置和模板（docker-compose、kubernetes/helm、mesos、terraform、bosh）。</p>
</blockquote>
<p>👀 注意</p>
<p>在某些存储库（尤其是使用 kubernetes 部署的应用程序）中，此目录称为<code>deploy</code>.</p>
<h3>init目录</h3>
<blockquote>
<p>系统初始化（systemd、upstart、sysv）和进程管理器(runit、supervisord)配置文件，在非容器化部署的项目中会使用到。</p>
</blockquote>
<p>例如：systemd的unit文件，用于管理程序，一般以.service结尾</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.target
Wants=sshd-keygen.target

[Service]
Type=notify
EnvironmentFile=-/etc/crypto-policies/back-ends/opensshserver.config
EnvironmentFile=-/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS $CRYPTO_POLICY
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
</code></pre></div><h3>scripts目录</h3>
<blockquote>
<p>执行各种构建、安装、分析等操作的脚本。这些脚本使根级 Makefile 小而简单</p>
</blockquote>
<p>例如: <a href="https://github.com/hashicorp/terraform/blob/master/Makefile" target="_blank" rel="noopener noreferrer">terraform-website</a>使用了很多scipts目录下的脚本，使得Makefile小但功能强大。</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>WEBSITE_REPO=github.com/hashicorp/terraform-website
VERSION?="0.3.44"
PWD=$$(pwd)
DOCKER_IMAGE="hashicorp/terraform-website:full"
DOCKER_IMAGE_LOCAL="hashicorp-terraform-website-local"
DOCKER_RUN_FLAGS=--interactive \
	--rm \
	--tty \
	--workdir "/website" \
	--volume "$(shell pwd):/website/ext/terraform" \
	--volume "$(shell pwd)/website:/website/preview" \
	--publish "3000:3000" \
	-e "IS_CONTENT_PREVIEW=true" \
	-e "PREVIEW_FROM_REPO=terraform" \
	-e "NAV_DATA_DIRNAME=./preview/data" \
	-e "CONTENT_DIRNAME=./preview/docs" \
	-e "CURRENT_GIT_BRANCH=$$(git rev-parse --abbrev-ref HEAD)"

# generate runs `go generate` to build the dynamically generated
# source files, except the protobuf stubs which are built instead with
# "make protobuf".
generate:
	go generate ./...

# We separate the protobuf generation because most development tasks on
# Terraform do not involve changing protobuf files and protoc is not a
# go-gettable dependency and so getting it installed can be inconvenient.
#
# If you are working on changes to protobuf interfaces, run this Makefile
# target to be sure to regenerate all of the protobuf stubs using the expected
# versions of protoc and the protoc Go plugins.
protobuf:
	go run ./tools/protobuf-compile .

fmtcheck:
	"$(CURDIR)/scripts/gofmtcheck.sh"

importscheck:
	"$(CURDIR)/scripts/goimportscheck.sh"

staticcheck:
	"$(CURDIR)/scripts/staticcheck.sh"

exhaustive:
	"$(CURDIR)/scripts/exhaustive.sh"

# Default: run this if working on the website locally to run in watch mode.
website:
	@echo "==&gt; Downloading latest Docker image..."
	@docker pull ${DOCKER_IMAGE}
	@echo "==&gt; Starting website in Docker..."
	@docker run ${DOCKER_RUN_FLAGS} ${DOCKER_IMAGE} npm start

website/local:
	@echo "==&gt; Starting website in Docker..."
	@docker run ${DOCKER_RUN_FLAGS} ${DOCKER_IMAGE_LOCAL} npm start

.PHONY: website/build-local
website/build-local:
	@echo "==&gt; Building local Docker image"
	@docker build https://github.com/hashicorp/terraform-website.git\#master \
		-t $(DOCKER_IMAGE_LOCAL)

# disallow any parallelism (-j) for Make. This is necessary since some
# commands during the build process create temporary files that collide
# under parallel conditions.
.NOTPARALLEL:

.PHONY: fmtcheck importscheck generate protobuf website website-test staticcheck website/local website/build-local
</code></pre></div><h3>githooks目录</h3>
<blockquote>
<p>Git钩子，比如可以将commit-msg存放在该目录</p>
</blockquote>
<h3>Makefile文件</h3>
<blockquote>
<p>Makefile是一个很优秀的项目管理工具，通常用来执行静态代码检查、单元测试、编译等功能</p>
</blockquote>
<ul>
<li>静态代码检查(lint)：推荐用 golangci-lint。</li>
<li>单元测试(test)：运行 go test ./...。</li>
<li>编译(build)：编译源码，支持不同的平台，不同的 CPU 架构。</li>
<li>镜像打包和发布(image/image.push)：现在的系统比较推荐用 Docker/Kubernetes 进行部署，所以一般也要有镜像构建功能。</li>
<li>清理（clean）:清理临时文件或者编译后的产物。</li>
<li>代码生成（gen）：比如要编译生成 protobuf pb.go 文件。</li>
<li>部署（deploy，可选）：一键部署功能，方便测试。</li>
<li>发布（release）：发布功能，比如：发布到 Docker Hub、github 等。</li>
<li>帮助（help）:告诉 Makefile 有哪些功能，如何执行这些功能。</li>
<li>版权声明（add-copyright）：如果是开源项目，可能需要在每个文件中添加版权头，这可以通过 Makefile 来添加。</li>
<li>API 文档（swagger）：如果使用 swagger 来生成 API 文档，这可以通过 Makefile 来生成。</li>
</ul>
<h2>文档目录与文件</h2>
<h3>docs目录</h3>
<blockquote>
<p>设计和用户文档，除了<code>godoc</code>生成的文档之外</p>
</blockquote>
<ul>
<li>/docs/devel/{en-US,zh-CN}: 存放开发文档、hack文档</li>
<li>/docs/guide/{en-US,zh-CN}: 存放用户手册，安装、quickstart、产品文档等</li>
<li>/docs/image: 存放图片文件</li>
</ul>
<h3>CHANGELOG目录</h3>
<blockquote>
<p>当项目有更新时，为了方便了解当前版本的更新内容或者历史更新内容，需要将更新记录存放到CHANGELOG目录。</p>
</blockquote>
<p>编写CHANGELOG是一个繁琐的工作，我们可以结合<a href="https://github.com/angular/angular/blob/22b96b9/CONTRIBUTING.md#-commit-message-guidelines" target="_blank" rel="noopener noreferrer">Angular规范</a>和<a href="https://github.com/git-chglog/git-chglog" target="_blank" rel="noopener noreferrer">git-chglog工具</a></p>
<h3>CONTRIBUTING.md文件</h3>
<blockquote>
<p>开源项目用于说明如何贡献代码，如何开源协同等。</p>
</blockquote>
<h3>LICENSE文件</h3>
<blockquote>
<p>版权文件，常用的开源协议有：Apache 2.0、MIT、GPL等</p>
</blockquote>
<p>为了声明版权，你可能会需要将LICENSE头添加到源代码文件或者其他文件中，可以尝试使用这个工具自动化实现：<a href="https://github.com/marmotedu/addlicense" target="_blank" rel="noopener noreferrer">addlicense</a></p>
<p>当代码中引用了其他开源代码时，需要在LICENSE中说明对其他源码的引用，可以借助工具来进行检查：<a href="https://github.com/ribice/glice" target="_blank" rel="noopener noreferrer">glice</a></p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>+</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>版本规范</title>
      <link>http://blog.cjhe.top/project-standard/version.html</link>
      <guid>http://blog.cjhe.top/project-standard/version.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">版本规范</source>
      <description>提示 随着系统功能越来越复杂，依赖的软件包越来越多，如何解决【依赖地狱】问题？</description>
      <category>项目规范</category>
      <pubDate>Sat, 25 Jan 2020 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>随着系统功能越来越复杂，依赖的软件包越来越多，如何解决【依赖地狱】问题？</p>
</div>
<!-- more -->
<h2>语义化版本规范</h2>
<blockquote>
<p>语义化版本规范（SemVer,Semantic Versioning）是Github起草的一个具有指导意义的、统一的版本号表示规范。
它规定了版本号的表示、增加和比较方式，以及不同版本号代表的含义。</p>
</blockquote>
<p>语义化版本格式为：<code>主版本号.次版本号.修订号（X.Y.Z）</code>，其中X、Y和Z为非负整数，且禁止在数字前方补零。
例如：v1.2.3</p>
<p>版本号增加的含义：</p>
<ul>
<li>主版本号（MAJOR）：当做了不兼容的API修改。一般用于大的功能变动(Breaking Change)，影响到之前的功能。</li>
<li>次版本号（MINOR）：当做了向下兼容的功能性新增及修改。一般用于不影响之前逻辑的功能优化，或者新的功能(New Feature)。</li>
<li>修订号（PATCH）：当做了向下兼容的问题修正，一般用于问题修复(Bug Fix)。</li>
</ul>
<figure><figcaption>server</figcaption></figure>
<p>一些经验：</p>
<ul>
<li>建议0.1.0作为第一个开发版本号；</li>
<li>当用于正式环境，它应该达到1.0.0版，0.y.z版本均可视为不稳定版本，仍在持续开发中；</li>
<li>v1.2.3并不是一个语义化的版本号，但是在语义化版本之前增加前缀”v"是用来表示版本号的常用做法；</li>
</ul>
<p>关于语义化版本规范详细内容参考：<a href="https://semver.org/lang/zh-CN/" target="_blank" rel="noopener noreferrer">semver.org</a></p>
<h2>先行版本</h2>
<p>此外我们还会经常遇见先行版本，例如：1.0.0-alpha.0、1.0.0-alpha.1、1.0.0-beta.0、1.0.0-rc.0、1.0.0-rc.1等</p>
<blockquote>
<p>当要发布大版本或者核心的feature时，但又不能保证这个版本的功能100%正常，这个时候就需要通过发布先行版本</p>
</blockquote>
<p>常见的先行版本包括：内测版 、灰度版和RC版本。Semver规范中使用alpha、beta、rc来修饰即将要发布的版本。</p>
<ul>
<li>snapshot:快照，也被称为开发版，处于开发阶段，这个版本的代码禁止用于生产环境；</li>
<li>alpha:内部版本，该版本表示软件在此阶段主要是以实现功能为主，用于软件开发内部交流，一般bug比较多；</li>
<li>beta:公测版本，该版本表示相对alpha版已经改进，但仍然存在一些缺陷，用于专业爱好者大规模使用；</li>
<li>gamma:比较成熟的测试版；</li>
<li>rc:即release candiate，正式版本的候选版本，该版本已经相当成熟，只会修复Bug，不会对软件做任何大的更改；</li>
<li>release:发行版本，适合一般用户使用，不开源的软件，release可能是带有免费使用时间限制的版本；</li>
<li>stable:稳定版，同release；</li>
</ul>
<h2>工具</h2>
<p>另外可以使用一些工具规范版本号：</p>
<ul>
<li><a href="https://github.com/arnaud-deprez/gsemver" target="_blank" rel="noopener noreferrer">gsemver</a>
<ul>
<li>使用<code>gsemver bump</code>命令就可以根据Git历史提交约定生成下一个版本</li>
</ul>
</li>
<li><a href="https://github.com/commitizen/cz-cli" target="_blank" rel="noopener noreferrer">cz-cli</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>基于Redis的分布式锁</title>
      <link>http://blog.cjhe.top/system-design/distribute-lock.html</link>
      <guid>http://blog.cjhe.top/system-design/distribute-lock.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">基于Redis的分布式锁</source>
      <description>分布式锁

分布式锁即在分布式环境下不同实例之间抢一把锁，相比较单一实例的锁，分布式环境下带来的问题更多，例如网络问题。
分布式锁可以通过多种途径实现，例如:Zookeeper等。由于Redis是经常使用的中间件，本篇内容基于Redis实现分布式锁。

特性：

互斥性：任意时刻，只有一个客户端能持有锁；
锁超时释放：持有锁超时，可以释放，防止不必要的...</description>
      <category>系统设计</category>
      <pubDate>Sat, 12 Nov 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<!-- more -->
<h2>分布式锁</h2>
<blockquote>
<p>分布式锁即在分布式环境下不同实例之间抢一把锁，相比较单一实例的锁，分布式环境下带来的问题更多，例如网络问题。
分布式锁可以通过多种途径实现，例如:Zookeeper等。由于Redis是经常使用的中间件，本篇内容基于Redis实现分布式锁。</p>
</blockquote>
<p>特性：</p>
<ul>
<li>互斥性：任意时刻，只有一个客户端能持有锁；</li>
<li>锁超时释放：持有锁超时，可以释放，防止不必要的资源浪费，也可以防止死锁；</li>
<li>可重入性：一个线程如果获取了锁之后，可以再次对其请求加锁；</li>
<li>高性能和高可用：加锁和解锁需要开销尽可能低，同时也要保证高可用，避免分布式锁失效；</li>
<li>安全性：锁只能被持有的客户端释放，不能被其他客户端释放</li>
</ul>
<h3>简单版本</h3>
<blockquote>
<p>锁的特性就是排他性，这里可以通过Redis的命令：<code>SETNX</code>，该命令：</p>
<ul>
<li>只在键key不存在的情况下，将键的值设置为value，返回1；</li>
<li>若键key已存在，则SETNX命令不做任何操作，返回0；</li>
</ul>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> redislock

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/go-redis/redis/v9"</span>
	<span class="token string">"github.com/google/uuid"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrObtainLockFail  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to obtain lock"</span><span class="token punctuation">)</span>
	ErrReleaseLockFail <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to release lock"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Lock <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
	key    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">ObtainLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">SetNX</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrObtainLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">newLock</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>client<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newLock</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Lock <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Lock<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
		key<span class="token punctuation">:</span>    key<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Lock<span class="token punctuation">)</span> <span class="token function">Release</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> res <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrReleaseLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是这里的释放其实是存在问题的：</p>
<ul>
<li>当redis存储的是别人的锁，直接删除key这就会导致删除别人的锁问题</li>
</ul>
<h3>解决锁释放问题</h3>
<blockquote>
<p>方法就是生产唯一的value，只有当前redis存储的value是自己的才可以删除</p>
<p>为了保证原子性，即查询redis的value和删除动作是一起进行操作，这里采用lua脚本去保证</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> redislock

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token boolean">_</span> <span class="token string">"embed"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/go-redis/redis/v9"</span>
	<span class="token string">"github.com/google/uuid"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrObtainLockFail  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to obtain lock"</span><span class="token punctuation">)</span>
	ErrReleaseLockFail <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"fail to release lock"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	<span class="token comment">//go:embed release.lua</span>
	releaseLua <span class="token builtin">string</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> lock <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
	key    <span class="token builtin">string</span>
	value  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">ObtainLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">SetNX</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrObtainLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">newLock</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>client<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newLock</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>lock <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span>
		key<span class="token punctuation">:</span>    key<span class="token punctuation">,</span>
		value<span class="token punctuation">:</span>  value<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token function">Release</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> releaseLua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrReleaseLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrReleaseLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>release.lua脚本</p>
<div class="language-lua" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="token comment">-- 获得的value和期望的value是一致的说明是自己的锁</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div><h3>解决超时问题</h3>
<blockquote>
<p>极端场景下业务很可能执行超时，例如：分布式锁一分钟，但业务执行一小时，导致这一个小时之内，有60个业务拿到分布式锁，和我们期望1个业务执行不一致。</p>
<p>解决超时问题，那么我们可以通过续约的方式，不断延长分布式锁的有效期来解决业务超时问题，保证业务执行过程锁不会自动释放。</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token function">AutoRefresh</span><span class="token punctuation">(</span>interval<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> interval <span class="token operator">&gt;=</span> c<span class="token punctuation">.</span>expiration <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"interval should be less than expiration"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
			err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
			<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> context<span class="token punctuation">.</span>DeadlineExceeded <span class="token punctuation">{</span>
				<span class="token keyword">select</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
			ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
			err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
			<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> context<span class="token punctuation">.</span>DeadlineExceeded <span class="token punctuation">{</span>
				<span class="token keyword">select</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>c<span class="token punctuation">.</span>release<span class="token punctuation">:</span> <span class="token comment">//主动释放锁场景</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token function">Refresh</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> refreshLua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>value<span class="token punctuation">,</span> c<span class="token punctuation">.</span>expiration<span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrRefreshLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> res <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrRefreshLockFail
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>refresh.lua脚本</p>
<div class="language-lua" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="token comment">--续约分布式锁</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"pexpire"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">--返回1成功，返回0失败</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div><h3>解决无限续约问题</h3>
<blockquote>
<p>当续约遇见网络超时问题，总不能一直续约，须有合理的方式告知业务方错误</p>
<p>因此需增加策略去重试续约</p>
</blockquote>
<p>我们定义策略</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> redislock

<span class="token keyword">import</span> <span class="token string">"time"</span>

<span class="token keyword">type</span> RetryStrategy <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">//返回下一次是否需要重试以及重试间隔</span>
	<span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> limitedRetry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	interval time<span class="token punctuation">.</span>Duration
	max      <span class="token builtin">int64</span>
	cnt      <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>retry <span class="token operator">*</span>limitedRetry<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	retry<span class="token punctuation">.</span>cnt<span class="token operator">++</span>
	<span class="token keyword">return</span> retry<span class="token punctuation">.</span>cnt <span class="token operator">&lt;</span> retry<span class="token punctuation">.</span>max<span class="token punctuation">,</span> retry<span class="token punctuation">.</span>interval
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">LimitedRetry</span><span class="token punctuation">(</span>interval time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> max <span class="token builtin">int64</span><span class="token punctuation">)</span> RetryStrategy <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>limitedRetry<span class="token punctuation">{</span>interval<span class="token punctuation">:</span> interval<span class="token punctuation">,</span> max<span class="token punctuation">:</span> max<span class="token punctuation">,</span> cnt<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> noRetry <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>retry <span class="token operator">*</span>noRetry<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NoRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> RetryStrategy <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>noRetry<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用带策略的续约方式</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">TryLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> try RetryStrategy<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> ticker <span class="token operator">*</span>time<span class="token punctuation">.</span>Ticker
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ticker <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> lockLua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> context<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token string">"OK"</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">newLock</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>client<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expiration<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		retry<span class="token punctuation">,</span> interval <span class="token operator">:=</span> try<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>retry <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrObtainLockFail
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> ticker <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			ticker <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>lock.lua脚本</p>
<div class="language-lua" data-ext="lua" data-title="lua"><pre class="language-lua"><code><span class="token keyword">local</span> val <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">-- 在加锁的重试的时候，要判断自己上一次是不是加锁成功了</span>
<span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token keyword">false</span> <span class="token keyword">then</span> <span class="token comment">-- key 不存在</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'PX'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">-- px 毫秒</span>
<span class="token keyword">elseif</span> val <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>  <span class="token comment">-- 存在，刷新过期时间</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"OK"</span>
<span class="token keyword">else</span> <span class="token comment">-- 此时别人持有锁</span>
    <span class="token keyword">return</span> <span class="token string">""</span>
<span class="token keyword">end</span>
</code></pre></div><h3>进一步优化获取锁</h3>
<blockquote>
<p>当并发量很大场景时，为了减缓DB的压力，我们可以在单个实例上面，只允许一个协程获取分布式锁，即：单一实例先筛选一个协程，不同的实例再去竞争分布式锁</p>
</blockquote>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client redis<span class="token punctuation">.</span>Cmdable
	s      singleflight<span class="token punctuation">.</span>Group
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">SingleFlightLock</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> try RetryStrategy<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		flag <span class="token operator">:=</span> <span class="token boolean">false</span>
		result <span class="token operator">:=</span> c<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">DoChan</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			flag <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">TryLock</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> expiration<span class="token punctuation">,</span> try<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>result<span class="token punctuation">:</span>
			<span class="token keyword">if</span> flag <span class="token punctuation">{</span>
				c<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
				<span class="token keyword">if</span> res<span class="token punctuation">.</span>Err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Err
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> res<span class="token punctuation">.</span>Val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>vscode leetcode插件</title>
      <link>http://blog.cjhe.top/tools/vscode-leetcode.html</link>
      <guid>http://blog.cjhe.top/tools/vscode-leetcode.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">vscode leetcode插件</source>
      <description>提示 vscode这款插件太香了，终于可以沉浸式刷leetcode😄</description>
      <category>工具</category>
      <pubDate>Wed, 10 Aug 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>vscode这款插件太香了，终于可以沉浸式刷leetcode😄</p>
</div>
<!-- more -->
<h2>环境搭建</h2>
<h3>安装</h3>
<p>在vscode扩展商店搜索<code>LeetCode</code>,一般是下载量最高的那个就完事了
</p>
<h3>登陆</h3>
<p>在登陆之前，记得要选择中国版，否则会遇见登陆不上问题

接下来选择账号登录，需要提前在LeetCode官网注册账号

这里我选择账户方式，按照提示填写邮箱、密码即可登录</p>
<h3>预览</h3>
<figure><figcaption>leetcode-preview</figcaption></figure>
<blockquote>
<p>在左侧，该插件按照五个分类将题目进行了分类，比如：按照难易程度(简单、中等、难)、按照标签(数据、二叉搜索等)、按照公司(Google、Facebook等)</p>
<p>且题目根据难易程度有不同的颜色进行区分，如果已经完成相关的练习，还会用✔️提示</p>
</blockquote>
<h3>个性化配置</h3>
<div class="language-json" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"leetcode.endpoint"</span><span class="token operator">:</span> <span class="token string">"leetcode-cn"</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.workspaceFolder"</span><span class="token operator">:</span> <span class="token string">"/Users/hechangjie/code/hexiaopi/leetcode-go"</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.defaultLanguage"</span><span class="token operator">:</span> <span class="token string">"golang"</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.hint.configWebviewMarkdown"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.hint.commentDescription"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"leetcode.hint.commandShortcut"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>沉浸式刷题</h2>
<h3>预览题目内容</h3>
<p>
点击Code Now，选择一种编程语言就可以开始了</p>
<h3>编写代码</h3>
<figure><figcaption>leetcode-code</figcaption></figure>
<h3>测试代码</h3>
<p>点击代码下方的<code>Test</code>标签即可进行测试代码（再也不用编写大量的单元测试用例了）
</p>
<h3>提交代码</h3>
<p>点击代码下方的<code>Submit</code>标签即可提交代码，完成之后就会看到提交后的代码性能等信息了
</p>
]]></content:encoded>
    </item>
    <item>
      <title>存储引擎</title>
      <link>http://blog.cjhe.top/database/mysql/engine.html</link>
      <guid>http://blog.cjhe.top/database/mysql/engine.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">存储引擎</source>
      <description>MySQL是常用的关系型数据库

MySQL架构
MySQL架构MySQL架构
存储引擎

存储引擎是MySQL区别于其他数据库的一个重要特性，MySQL有诸多存储引擎，且存储引擎是基于表的，而不是数据(同一个数据库下面的各个表可以使用不同的引擎)
存储引擎是底层物理结构的实现，每个存储引擎开发者可以按照自己的意愿开发，具有各自的特点
对于MySQL使...</description>
      <category>数据库</category>
      <pubDate>Sat, 22 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<!-- more -->
<blockquote>
<p>MySQL是常用的关系型数据库</p>
</blockquote>
<h2>MySQL架构</h2>
<figure><figcaption>MySQL架构</figcaption></figure>
<h2>存储引擎</h2>
<ul>
<li>存储引擎是MySQL区别于其他数据库的一个重要特性，MySQL有诸多存储引擎，且<strong>存储引擎是基于表的，而不是数据</strong>(同一个数据库下面的各个表可以使用不同的引擎)</li>
<li>存储引擎是底层物理结构的实现，每个存储引擎开发者可以按照自己的意愿开发，具有各自的特点</li>
<li>对于MySQL使用者来说，存储引擎对其实透明的</li>
</ul>
<h3>Innodb引擎</h3>
<blockquote>
<p>是一个支持ACID事务，行锁设计，支持MVCC功能，实现了SQL标准的4种隔离级别</p>
</blockquote>
<h4>特点</h4>
<ul>
<li>使用Table Space的方式仅限数据存储</li>
<li>支持事务、外键约束等数据库特性</li>
<li>Rows Level Lock，读写性能都非常优秀</li>
<li>拥有独立的缓冲池，能够缓存数据和索引</li>
<li>通过多版本控制，支持高并发业务</li>
</ul>
<h4>注意事项</h4>
<ul>
<li>主键尽可能小，否则二级索引会膨胀</li>
<li>避免全表扫描，导致锁升级</li>
<li>尽可能缓存所有的索引和数据，减少IO操作</li>
<li>避免主键更新，造成大量的数据移动</li>
</ul>
<h3>MyISAM存储引擎</h3>
<blockquote>
<p>MySQL 5.5之前默认是MyISAM存储引擎，之后默认都改为InnoDB</p>
</blockquote>
<h4>特点</h4>
<ul>
<li>数据存储方式简单，使用B-Tree进行索引，<strong>索引叶子节点存放数据的指针</strong></li>
<li><strong>不支持一些数据库特性，比如事务、外键约束等</strong></li>
<li><strong>Table Level Lock(表级别锁)</strong>，性能稍差，更适合读多的操作</li>
<li>使用三个文件定义一个表：
<ul>
<li><code>.MYi</code>：存储索引</li>
<li><code>.MYD</code>：存储数据</li>
<li><code>.frm</code>：存储表定义</li>
</ul>
</li>
<li>少碎片、支持大文件、能够进行索引压缩</li>
<li>二进制层次的文件可以移植（Linux-&gt;Windows）</li>
<li>访问速度快，适合只读查询场景</li>
</ul>
<h4>注意事项</h4>
<ul>
<li>设置合适索引</li>
<li>启用延迟写入，尽量一次大批量写入，而非频繁写入</li>
<li>降低并发数，高并发使用排队机制</li>
<li>由于存储了Count字段，因此Count操作比较高效，但仅限不带条件</li>
</ul>
<h2>引擎对比</h2>
<p>| 存储引擎  |                             特点                              |       应用场景       |
| :</p>
]]></content:encoded>
    </item>
    <item>
      <title>索引</title>
      <link>http://blog.cjhe.top/database/mysql/idx.html</link>
      <guid>http://blog.cjhe.top/database/mysql/idx.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">索引</source>
      <description>索引是一种数据结构，帮助SQL高效获取数据的。类似一本书的目录，可以快速对特定值进行定位和查找，从而大大加快数据查询的效率。</description>
      <category>数据库</category>
      <pubDate>Wed, 15 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>索引是一种数据结构，帮助SQL高效获取数据的。类似一本书的目录，可以快速对特定值进行定位和查找，从而大大加快数据查询的效率。</p>
<!-- more -->
<h2>索引优缺点</h2>
<h3>索引优点</h3>
<ul>
<li>索引可以大大减少需要扫描的数据量</li>
<li>索引可以避免排序和临时表，索引已经有序</li>
<li>索引可以尽量将随机IO变成顺序IO，例如：聚簇索引包含数据，且索引是有序的，就可以快速获得批量数据，但如果回表，通过主键查询数据，则又变成随机IO</li>
<li>索引对于InnoDB（支持行级锁）非常重要，InnoDB对需要访问的元组加锁，而索引能够减少InnoDB访问的元组数，如果查询不能使用索引，MySQL会进行全表扫描，导致锁住全表。</li>
</ul>
<h3>索引缺点</h3>
<ul>
<li>降低了更新表的数据，因为不仅要更新原始数据，还要更新索引</li>
<li>索引占用磁盘空间</li>
<li>数据列如果包含了许多重复的内容，例如性别为：男、女，索引选择可能只筛选一半的数据量，效果不是很好</li>
<li>对于数据量非常小的表，索引意义不大，有时全表扫描更高效</li>
</ul>
<p>MySQL单张表最多只支持16个索引</p>
<h2>索引类型</h2>
<h3>按功能逻辑划分</h3>
<h4>普通索引</h4>
<p>普通索引仅仅加快对数据的访问速度，常用于查询条件（where field_name=value）或排序条件（order by field_name）这些场景中。</p>
<h4>唯一索引</h4>
<p>唯一索引相比较普通索引，要求索引列的值必须唯一，但允许有空值。</p>
<h4>主键索引</h4>
<p>主键索引是一种特殊的索引，不允许有空值，一张表只能有一个主键，一般在建表的时候通过primary key(field_name)指定</p>
<h4>全文索引</h4>
<p>mysql Like '%xxx'就会导致索引失效，为了模糊搜索需求，例如：like '%hello%'，就需要全文索引支持。InnoDB在5.6版本之后支持全文索引。</p>
<h3>按物理逻辑划分</h3>
<h4>聚簇索引</h4>
<p>聚簇索引的叶子节点直接存储数据，因此查询的时候只需要进行一次查询</p>
<h4>非聚簇索引</h4>
<p>非聚簇索引的叶子节点存储数据的主键，因此查询的时候需要进行两次查询：先查询聚簇索引获取到主键，再通过主键查询数据。</p>
<h3>按字段个数划分</h3>
<h4>单一索引</h4>
<p>索引只使用一个字段</p>
<h4>联合索引</h4>
<p>索引使用多个字段
例如：</p>
<div class="language-sql" data-ext="sql" data-title="sql"><pre class="language-sql"><code>alert <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> <span class="token keyword">index</span> index_name_city_age<span class="token punctuation">(</span>name<span class="token punctuation">,</span>city<span class="token punctuation">,</span>age<span class="token punctuation">)</span>
</code></pre></div><p>MySQL联合索引遵从：最左匹配原则</p>
<p>上面索引相当于建立下面三组索引：</p>
<ul>
<li>name,city,age</li>
<li>name,city</li>
<li>name</li>
</ul>
<p>因此：</p>
<ul>
<li>如果查询条件是：(city)、(city,age)、(age)都不会命中索引</li>
<li>如果查询条件是：(name,age)，则会命中name索引</li>
</ul>
<p>理论上最左匹配原则中索引对 where 中子句的顺序也是敏感的，但是由于MySQL的查询优化器会自动调整 where 子句的条件顺序以使用适合的索引，所以实际上 where 子句顺序不影响索引的效果。</p>
<p>如果联合索引有范围查询，就会停止匹配</p>
<p>如果分别在 x, y, z 上建立单列索引，让该表有3个单列索引，索引效率也会大不一样，在联合索引生效的情况下，单个索引的效率远远低于联合索引。这是由 MySQL 查询优化器的执行顺序决定的，在执行一条查询 sql 时，针对索引的选择大致有如下步骤：</p>
<p>MySQL 优化器根据搜索条件，找出所有可能使用的索引
计算全表扫描的代价
计算使用不同索引执行查询的代价
对比各种执行方案的代价，找出成本最低的那一个
因此，虽然有多个单列索引，但 MySQL 只能用到其中的那个系统认为似乎是最有效率的，其他的就会失效。</p>
<h2>总结</h2>
<h3>索引推荐使用情况</h3>
<ul>
<li>WHERE, GROUP BY, ORDER BY 子句中的字段</li>
<li>多个单列索引在多条件查询是只会有一个最优的索引生效，因此多条件查询中最好创建联合索引。</li>
<li>联合索引的时候必须满足最左匹配原则，并且最好考虑到 sql 语句的执行顺序，比如 WHERE a = 1 GROUP BY b ORDER BY c, 那么联合索引应该设计为 (a,b,c)，因为mysql 查询语句的执行顺序 WHERE &gt; GROUP BY &gt; ORDER BY。<a href="/database/mysql/sql-order.html" target="_blank">参见</a></li>
<li>多张表 JOIN 的时候，对表连接字段创建索引。</li>
<li>当 SELECT 中有不在索引中的字段时，会先通过索引查询出满足条件的主键值，然后通过主键回表查询出所有的 SELECT 中的字段，影响查询效率。因此如果 SELECT 中的内容很少，为了避免回表，可以把 SELECT 中的字段都加到联合索引中，这也就是宽索引的概念。但是需要注意，如果索引字段过多，存储和维护索引的成本也会增加。</li>
</ul>
<h3>不推荐使用或索引失效情况</h3>
<ul>
<li>数据量很小的表</li>
<li>有大量重复数据的字段</li>
<li>频繁更新的字段</li>
<li>如果对索引字段使用了函数或者表达式计算，索引失效</li>
<li>字段类型不一致也会失效，因为等价使用函数</li>
<li>innodb OR 条件没有对所有条件创建索引，索引失效</li>
<li>大于小于条件 &lt; &gt;，索引是否生效取决于命中的数量比例，如果命中数量很多，索引生效，命中数量很小，索引失效</li>
<li>不等于条件 !=、&lt;&gt;，索引失效</li>
<li>LIKE 值以 % 开头，索引失效</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>SQL查询顺序</title>
      <link>http://blog.cjhe.top/database/mysql/sql-order.html</link>
      <guid>http://blog.cjhe.top/database/mysql/sql-order.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">SQL查询顺序</source>
      <description>sql-queriessql-queries</description>
      <category>数据库</category>
      <pubDate>Thu, 09 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://jvns.ca/images/sql-queries.jpeg" alt="sql-queries" tabindex="0" loading="lazy"><figcaption>sql-queries</figcaption></figure>
<!-- more -->
<p>这张图与 SQL 查询的语义有关，让你知道一个查询会返回什么，并回答了以下这些问题：</p>
<ul>
<li>
<p>可以在 GROUP BY 之后使用 WHERE 吗？（不行，WHERE 是在 GROUP BY 之前！）</p>
</li>
<li>
<p>可以对窗口函数返回的结果进行过滤吗？（不行，窗口函数是 SELECT 语句里，而 SELECT 是在 WHERE 和 GROUP BY 之后）</p>
</li>
<li>
<p>可以基于 GROUP BY 里的东西进行 ORDER BY 吗？（可以，ORDER BY 基本上是在最后执行的，所以可以基于任何东西进行 ORDER BY）</p>
</li>
<li>
<p>LIMIT 是在什么时候执行？（在最后！）</p>
</li>
</ul>
<p>但数据库引擎并不一定严格按照这个顺序执行 SQL 查询，因为为了更快地执行查询，它们会做出一些优化。</p>
<p>所以：</p>
<p>如果你想要知道一个查询语句是否合法，或者想要知道一个查询语句会返回什么，可以参考这张图；</p>
<p>需要注意的是，在实际实现中，MySQL会根据具体的查询条件和数据量进行一定的优化和调整。在涉及查询性能或者与索引有关的东西时，这张图就不适用了。</p>
<h2>详细查询顺序</h2>
<p>1.FROM子句
MySQL首先处理FROM子句，该步骤主要是确定需要查询的数据表，并建立数据表之间的连接关系。</p>
<p>2.WHERE子句
根据WHERE子句指定的查询条件，MySQL会进行筛选并过滤出符合条件的数据。</p>
<p>3.GROUP BY子句
如果查询需要对数据分组，则MySQL会按照GROUP BY子句中指定的分组条件对数据进行分组，然后对每个组进行汇总计算。</p>
<p>4.HAVING子句
HAVING子句用于过滤分组后的数据，和WHERE子句类似。只有满足HAVING子句指定的条件的组才会出现在结果集中。</p>
<p>5.SELECT子句
SELECT子句是MySQL查询语句最主要的部分，它用于指定需要查询的数据集合以及计算这个数据集合中的一些列值。</p>
<p>6.DISTINCT
如果使用了DISTINCT关键字，则MySQL会过滤掉查询结果中的重复记录。</p>
<p>7.ORDER BY
ORDER BY子句用于对查询结果进行排序。MySQL会按照指定的列或表达式的结果对查询结果进行排序，可以指定升序或降序。</p>
<p>8.LIMIT
LIMIT关键字用于限制查询结果的数量。MySQL只返回前N条符合条件的记录，其中N由LIMIT语句后面的数字指定。</p>
<h2>参考文献</h2>
<p><a href="https://jvns.ca/blog/2019/10/03/sql-queries-don-t-start-with-select/" target="_blank" rel="noopener noreferrer">SQL查询不是以select开始</a></p>
]]></content:encoded>
      <enclosure url="https://jvns.ca/images/sql-queries.jpeg" type="image/jpeg"/>
    </item>
    <item>
      <title>事务</title>
      <link>http://blog.cjhe.top/database/mysql/transaction.html</link>
      <guid>http://blog.cjhe.top/database/mysql/transaction.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">事务</source>
      <description>事务的特性 原子性(Atomicity): 事务中的所有操作要么全部完成，要么全部不完成（回滚），不会在事务中间遇到错误而中断。 一致性(Consistency): 事务开始和结束时，数据都必须保持一致状态，即符合约束、完整性、默认值以及其它定义的规则。事务执行的结果不能破坏数据库的完整性和一致性。 隔离性(Isolation): 各个事务互相隔离，每...</description>
      <category>数据库</category>
      <pubDate>Sun, 23 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>事务的特性</h2>
<ul>
<li>原子性(Atomicity): 事务中的所有操作要么全部完成，要么全部不完成（回滚），不会在事务中间遇到错误而中断。</li>
<li>一致性(Consistency): 事务开始和结束时，数据都必须保持一致状态，即符合约束、完整性、默认值以及其它定义的规则。事务执行的结果不能破坏数据库的完整性和一致性。</li>
<li>隔离性(Isolation): 各个事务互相隔离，每个事务的执行都不会影响其它事务的执行或者结果。</li>
<li>持久性(Durability): 一个事务一旦提交成功，它对数据库中的数据的改变就是永久性的，即使发生数据库故障也不应该对其产生影响。</li>
</ul>
<h2>事务的实现</h2>
<ul>
<li>Undo log：实现事务的原子性；</li>
<li>Redo log：实现事务的持久性；</li>
<li>锁/MVCC：实现事务的隔离性；锁机制来保证事务在执行时互相隔离，防止事务间相互干扰，即写-写问题。MVCC 机制是通过保存历史版本的方式来实现，事务可以读取数据在事务开始时的版本，而不受到事务期间其他事务所做的改变的影响，即写-读问题。</li>
<li>以上三者保证了事务的一致性；</li>
</ul>
<h2>并发事务带来的问题</h2>
<p>当数据库上有多个事务同时执行的时候，就可能出现<strong>脏读(dirty read)</strong>、<strong>不可重复读(non-repeatable read)</strong>、<strong>幻读(phantom read)</strong>，为了解决这些问题，就有了隔离级别的概念</p>
<h3>脏读问题</h3>
<blockquote>
<p>脏读是指：一个事务中访问到了另外一个事务未提交的数据</p>
</blockquote>
<figure><figcaption>dirty-read</figcaption></figure>
<h3>不可重复读问题</h3>
<blockquote>
<p>不可重复读是指：一个事务多次读取同一行数据，但是在多次读取中数据发生了改变。</p>
</blockquote>
<figure><figcaption>non-repeatable-read</figcaption></figure>
<h3>幻读问题</h3>
<blockquote>
<p>幻读是指：一个事务多次执行同一条 SQL 语句，但结果集却不同，导致无法支撑后续的业务操作</p>
</blockquote>
<figure><figcaption>phantom-read</figcaption></figure>
<h2>事务的隔离级别</h2>
<p>针对上面三种问题，分别有四种隔离级别：</p>
<h3>未提交读(read uncommitted，RU)</h3>
<blockquote>
<p>未提交读，是指一个事务还未提交时，它做的变更就能被别的事务看到。即<strong>没有提交却可以读</strong></p>
</blockquote>
<h3>提交读(read committed，RC)</h3>
<blockquote>
<p>提交读，是指一个事务提交之后，它做的变更才会被其他事务看到。即<strong>提交才可以读</strong></p>
</blockquote>
<p>👀 <strong>大多数数据库系统的默认隔离级别</strong></p>
<h3>可重复读(repeatable read，RR)</h3>
<blockquote>
<p>可重复度，是指同一个事务执行过程看到的数据，总是跟这个事务在启动时看到的数据是一致的。即同一个事务多次请求读取数据，会看到同样的数据行。</p>
</blockquote>
<p>👀 <strong>MySQL的默认隔离级别</strong></p>
<h3>串行化(serializable，S)</h3>
<blockquote>
<p>是最高的隔离级别，它通过强制事务排序，使之不可能相互冲突。</p>
<p>这个级别可能导致大量的超时现象和锁竞争。</p>
</blockquote>
<p>以上四种隔离级别解决问题如下：</p>
<p>| 隔离级别\解决问题 |        脏读        |     不可重复读     |        幻读        |                     实现原理                     |
| :</p>
]]></content:encoded>
    </item>
    <item>
      <title>责任链</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/chain-of-responsibility.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/chain-of-responsibility.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">责任链</source>
      <description>责任链责任链</description>
      <category>设计模式</category>
      <pubDate>Tue, 13 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/chain-of-responsibility/chain-of-responsibility-2x.png" alt="责任链" tabindex="0" loading="lazy"><figcaption>责任链</figcaption></figure>
<!-- more -->
<h2>什么是责任链模式</h2>
<p>责任链模式(Chain of Responsibility)：为了避免请求发送者与多个请求处理者耦合在一起，将所有请求的处理者通过前一对象记住其下一个对象的引用而连成一条链；当有请求发生时，可将请求沿着这条链传递，直到有对象处理它为止。</p>
<div class="language-ascii" data-ext="ascii" data-title="ascii"><pre class="language-ascii"><code>     ┌─────────┐
     │ Request │
     └─────────┘
          │
┌ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ┐
          ▼
│  ┌─────────────┐  │
   │ ProcessorA  │
│  └─────────────┘  │
          │
│         ▼         │
   ┌─────────────┐
│  │ ProcessorB  │  │
   └─────────────┘
│         │         │
          ▼
│  ┌─────────────┐  │
   │ ProcessorC  │
│  └─────────────┘  │
          │
└ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ┘
          │
          ▼
</code></pre></div><h3>包含哪些角色</h3>
<ul>
<li>
<p>Handler: 抽象处理者</p>
<p>包含一个处理请求的接口和一个设置后续处理者</p>
</li>
<li>
<p>Concrete Handler: 具体处理者</p>
<p>实现抽象处理者接口</p>
</li>
<li>
<p>Client: 客户端</p>
<p>创建处理链，并让链头开始执行处理</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> chainofresponsibility

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Handler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">SetNext</span><span class="token punctuation">(</span>Handler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteHandler1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next Handler
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler1<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete handler1"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler1<span class="token punctuation">)</span> <span class="token function">SetNext</span><span class="token punctuation">(</span>handler Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>next <span class="token operator">=</span> handler
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteHandler2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next Handler
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler2<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete handler2"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ConcreteHandler2<span class="token punctuation">)</span> <span class="token function">SetNext</span><span class="token punctuation">(</span>handler Handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h<span class="token punctuation">.</span>next <span class="token operator">=</span> handler
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> chainofresponsibility

<span class="token keyword">func</span> <span class="token function">ExampleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h1 <span class="token operator">:=</span> ConcreteHandler1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	h2 <span class="token operator">:=</span> ConcreteHandler2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	h1<span class="token punctuation">.</span><span class="token function">SetNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h2<span class="token punctuation">)</span>
	h1<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concrete handler1</span>
	<span class="token comment">// concrete handler2</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>使用场景</h3>
<ul>
<li>审批流程：经理、主管、Boss</li>
<li>医院流程：挂号处、医生、收银处、药房</li>
</ul>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>可以控制请求处理的顺序；</li>
<li>单一职责原则，具体的处理者只关心自己的业务；</li>
<li>开闭原则，可以不更改现有代码的情况下新增处理者；</li>
</ul>
<h3>缺点</h3>
<ul>
<li>各个处理者须有共同的处理函数</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/chain-of-responsibility/chain-of-responsibility-2x.png" type="image/png"/>
    </item>
    <item>
      <title>命令</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/command.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/command.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">命令</source>
      <description>commandcommand</description>
      <category>设计模式</category>
      <pubDate>Wed, 26 Apr 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/command/command-zh-2x.png" alt="command" tabindex="0" loading="lazy"><figcaption>command</figcaption></figure>
<!-- more -->
<h2>什么是行为型模式</h2>
<p>命令设计模式允许将请求封装成对象，从而将不同的请求发送者与接收者解耦。命令对象包含了请求的所有信息，包括调用的方法、参数和接收者等。这种方式使得请求的发送者与接收者无需知道彼此的存在，从而可以更灵活地进行交互。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>command</figcaption></figure>
<ul>
<li>
<p>Invoker: 调用者</p>
<p>创建和配置命命令对象，并将其传递给接收者</p>
</li>
<li>
<p>Command: 命令接口</p>
<p>定义命令的核心接口，通常包括一个执行方法</p>
</li>
<li>
<p>ConcreteCommand: 具体命令类</p>
<p>实现命令接口，并封装具体的操作。通常需要引用接收者，从而调用对应的方法</p>
</li>
<li>
<p>Receiver: 接收者</p>
<p>实现请求的实际操作，命令对象将请求传递给接收者，从而完成请求</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Command <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Receiver <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Receiver<span class="token punctuation">)</span> <span class="token function">operation1</span><span class="token punctuation">(</span>a <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"operation1:"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Receiver<span class="token punctuation">)</span> <span class="token function">operation2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"operation2:"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Invoker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	cmd Command
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Invoker<span class="token punctuation">)</span> <span class="token function">SetCommand</span><span class="token punctuation">(</span>cmd Command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>cmd <span class="token operator">=</span> cmd
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Invoker<span class="token punctuation">)</span> <span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreateCommand1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name     <span class="token builtin">string</span>
	receiver <span class="token operator">*</span>Receiver
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreateCommand1<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">operation1</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreateCommand2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name     <span class="token builtin">string</span>
	desc     <span class="token builtin">string</span>
	address  <span class="token builtin">string</span>
	receiver <span class="token operator">*</span>Receiver
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreateCommand2<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">operation2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>desc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">func</span> <span class="token function">ExampleCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">:=</span> Receiver<span class="token punctuation">{</span><span class="token punctuation">}</span>
	invoker <span class="token operator">:=</span> Invoker<span class="token punctuation">{</span><span class="token punctuation">}</span>

	cmd1 <span class="token operator">:=</span> ConcreateCommand1<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token operator">&amp;</span>receiver<span class="token punctuation">}</span>
	invoker<span class="token punctuation">.</span><span class="token function">SetCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd1<span class="token punctuation">)</span>
	invoker<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	cmd2 <span class="token operator">:=</span> ConcreateCommand2<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> desc<span class="token punctuation">:</span> <span class="token string">"描述"</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> <span class="token string">"地址"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token operator">&amp;</span>receiver<span class="token punctuation">}</span>
	invoker<span class="token punctuation">.</span><span class="token function">SetCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd2<span class="token punctuation">)</span>
	invoker<span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Output:</span>
	<span class="token comment">// operation1: admin</span>
	<span class="token comment">// operation2: admin 描述 地址</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>适用场景</h2>
<ul>
<li>
<p>需要将请求和执行操作解耦的情况。命令模式可以将请求封装为对象并将其发送给接收者，从而使得发送者和接收者之间松耦合。</p>
</li>
<li>
<p>需要支持撤销或重做操作的情况。由于每个命令都封装了一组特定的操作，因此可以轻松进行撤销或重做。</p>
</li>
<li>
<p>需要支持事务操作的情况。将一组相关的命令组合在一起，可以实现事务操作，即一组操作要么全部成功执行，要么全部失败。</p>
</li>
<li>
<p>需要远程执行操作的情况。将命令对象序列化到网络上，可以实现远程执行操作的功能。</p>
</li>
<li>
<p>需要将命令队列中的请求延迟、调度或者执行的情况。可以将命令对象存储在队列中，然后按照特定的规则执行它们。</p>
</li>
<li>
<p>需要实现日志、审计或者事务记录的情况。可以在执行命令的同时，将其记录下来，并可以将其回放以重现历史操作。</p>
</li>
</ul>
<h3>请求与执行解耦</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">type</span> Commander <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AddCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AddCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> SubtractCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SubtractCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MultiplyCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiplyCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> DivideCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DivideCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Divide</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Origin <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	value <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">+=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Subtract</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">-=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Multiply</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">*=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Divide</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">/=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Computer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	commands <span class="token punctuation">[</span><span class="token punctuation">]</span>Commander
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">AddCommand</span><span class="token punctuation">(</span>command Commander<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>commands <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">ExecuteCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> command <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>commands <span class="token punctuation">{</span>
		command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>package command

import "fmt"

func ExampleComputer() {
	computer := Computer{}
	origin := Origin{10}
	addCmd := AddCommand{&amp;origin, 20}
	subCmd := SubtractCommand{&amp;origin, 15}
	mulCmd := MultiplyCommand{&amp;origin, 2}
	divCmd := DivideCommand{&amp;origin, 3}
	computer.AddCommand(&amp;addCmd)
	computer.AddCommand(&amp;subCmd)
	computer.AddCommand(&amp;mulCmd)
	computer.AddCommand(&amp;divCmd)
	computer.ExecuteCommands()
	fmt.Println(origin.value)
	// Output:
	// 10
}
</code></pre></div><p>我们将请求者Computer和接收者Origin，进行了解耦。请求者可以任意追加命令，执行：加、减、乘、除等运算。</p>
<h3>撤销操作</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> command

<span class="token keyword">type</span> Commander <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AddCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AddCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AddCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> SubtractCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SubtractCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>SubtractCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MultiplyCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiplyCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiplyCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Divide</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> DivideCommand <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	receiver <span class="token operator">*</span>Origin
	value    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DivideCommand<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Divide</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DivideCommand<span class="token punctuation">)</span> <span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">Multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Origin <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	value <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">+=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Subtract</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">-=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Multiply</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">*=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Origin<span class="token punctuation">)</span> <span class="token function">Divide</span><span class="token punctuation">(</span>value <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>value <span class="token operator">/=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Computer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	commands <span class="token punctuation">[</span><span class="token punctuation">]</span>Commander
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">AddCommand</span><span class="token punctuation">(</span>command Commander<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">.</span>commands <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">ExecuteCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> command <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>commands <span class="token punctuation">{</span>
		command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Computer<span class="token punctuation">)</span> <span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		cmd <span class="token operator">:=</span> i<span class="token punctuation">.</span>commands<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
		cmd<span class="token punctuation">.</span><span class="token function">Undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		i<span class="token punctuation">.</span>commands <span class="token operator">=</span> i<span class="token punctuation">.</span>commands<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>commands<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleComputerUndo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	computer <span class="token operator">:=</span> Computer<span class="token punctuation">{</span><span class="token punctuation">}</span>
	origin <span class="token operator">:=</span> Origin<span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span>
	addCmd <span class="token operator">:=</span> AddCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span>
	subCmd <span class="token operator">:=</span> SubtractCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">}</span>
	mulCmd <span class="token operator">:=</span> MultiplyCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
	divCmd <span class="token operator">:=</span> DivideCommand<span class="token punctuation">{</span><span class="token operator">&amp;</span>origin<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>subCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mulCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>divCmd<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">ExecuteCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	computer<span class="token punctuation">.</span><span class="token function">UndoLastCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 10</span>
	<span class="token comment">// 30</span>
  <span class="token comment">// 15</span>
	<span class="token comment">// 30</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们对Commonder接口增加Undo方法，即可以实现计算器的撤销操作。</p>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>命令模式可以降低代码的耦合度，并且将请求调用者与请求接收者进行解耦；</li>
<li>命令模式扩展性较高
<ul>
<li>如果是扩展新的命令，那么直接定义新的命令类即可；</li>
<li>如果是执行一组命令，那么</li>
</ul>
</li>
</ul>
<h3>缺点</h3>
<ul>
<li>可能会导致性能问题。使用命令模式可能会增加对象数量，并且每个命令都需要进行封装，可能会导致性能下降。</li>
<li>可能会使代码更加复杂。使用命令模式需要定义许多接口和类，可能会使代码过于复杂，难以维护。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/command/command-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>迭代器</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/iterator.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/iterator.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">迭代器</source>
      <description>iteratoriterator</description>
      <category>设计模式</category>
      <pubDate>Mon, 12 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/iterator/iterator-zh-2x.png" alt="iterator" tabindex="0" loading="lazy"><figcaption>iterator</figcaption></figure>
<!-- more -->
<h2>什么是迭代器模式</h2>
<p>迭代器模式是一种行为设计模式，让你能在不暴露集合底层结构（列表、栈、树等）的情况下遍历集合中的所有元素。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>iterator</figcaption></figure>
<ul>
<li>
<p>Iterator: 迭代器接口</p>
<p>声明了遍历集合所需的操作</p>
</li>
<li>
<p>IterableCollection: 集合接口</p>
<p>声明一个方法或多个方法来获取与集合兼容的迭代器。</p>
</li>
<li>
<p>ConcreteIterator: 具体迭代器</p>
<p>实现遍历集合的一种特定算法，迭代器对象必须跟踪自身遍历进度。</p>
</li>
<li>
<p>ConcreteCollection: 具体集合</p>
<p>会在客户端请求迭代器时返回一个特定的具体迭代器类实体。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> iterator

<span class="token keyword">type</span> Aggregate <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Iterator
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Iterator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteIterator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	numbers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	next    <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>ConcreteIterator<span class="token punctuation">)</span> <span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> i<span class="token punctuation">.</span>next <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>numbers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>ConcreteIterator<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> i<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		numer <span class="token operator">:=</span> i<span class="token punctuation">.</span>numbers<span class="token punctuation">[</span>i<span class="token punctuation">.</span>next<span class="token punctuation">]</span>
		i<span class="token punctuation">.</span>next <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token keyword">return</span> numer
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteAggregate <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Length <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>ConcreteAggregate<span class="token punctuation">)</span> <span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Iterator <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteIterator<span class="token punctuation">{</span>
		numbers<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">,</span>
		next<span class="token punctuation">:</span>    <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> iterator

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> aggregate Aggregate
	aggregate <span class="token operator">=</span> <span class="token operator">&amp;</span>ConcreteAggregate<span class="token punctuation">{</span>Length<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>
	iterator <span class="token operator">:=</span> aggregate<span class="token punctuation">.</span><span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> iterator<span class="token punctuation">.</span><span class="token function">HasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 0</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// 3</span>
	<span class="token comment">// 4</span>
	<span class="token comment">// 5</span>
	<span class="token comment">// 6</span>
	<span class="token comment">// 7</span>
	<span class="token comment">// 8</span>
	<span class="token comment">// 9</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>访问一个聚合对象的内容而无须暴露它的内部表示。</li>
<li>遍历任务交由迭代器完成，这简化了聚合类。</li>
<li>它支持以不同方式遍历一个聚合，甚至可以自定义迭代器的子类以支持新的遍历。</li>
<li>增加新的聚合类和迭代器类都很方便，无须修改原有代码。</li>
<li>封装性良好，为遍历不同的聚合结构提供一个统一的接口。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>增加了类的个数，这在一定程度上增加了系统的复杂性。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/iterator/iterator-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>中介者</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/mediator.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/mediator.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">中介者</source>
      <description>mediatormediator</description>
      <category>设计模式</category>
      <pubDate>Sat, 29 Apr 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/mediator/mediator-2x.png" alt="mediator" tabindex="0" loading="lazy"><figcaption>mediator</figcaption></figure>
<!-- more -->
<h2>什么是中介者模式</h2>
<p>中介者模式(Mediator Pattern)又叫调停者模式，通过在中间引入中介对象来协调各个对象之间交互，使得对象之间不直接交互，而是通过中介者进行通信和协调，从而使得各个对象能够更加灵活地进行组合和拆分，增强系统的可维护性和扩展性。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>mediator</figcaption></figure>
<ul>
<li>
<p>Mediator：中介者</p>
<p>定义了中介者的接口，即通过该接口与其他组件交互</p>
</li>
<li>
<p>ConcreteMediator：具体中介者</p>
<p>实现了中介者的接口，维护其他组件之间的交互关系。</p>
</li>
<li>
<p>Colleague：同事</p>
<p>定义组件的接口，即通过该接口与中介者交互。</p>
</li>
<li>
<p>ConcreteColleague：具体同事</p>
<p>实现了组件的接口，维护自己与其他组件之间的交互关系。注意，同事之间不会直接交互，而是通过中介者来完成交互。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> mediator

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Mediator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Coordinate</span><span class="token punctuation">(</span>colleague Colleague<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Colleague <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">SendMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteColleague1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mediator Mediator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague1<span class="token punctuation">)</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague1 send message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>mediator<span class="token punctuation">.</span><span class="token function">Coordinate</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague1<span class="token punctuation">)</span> <span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague1 receive message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteColleague2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mediator Mediator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague2<span class="token punctuation">)</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague2 send message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>mediator<span class="token punctuation">.</span><span class="token function">Coordinate</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteColleague2<span class="token punctuation">)</span> <span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateColleague2 receive message:"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteMediator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ConcreteColleague1
	ConcreteColleague2
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteMediator<span class="token punctuation">)</span> <span class="token function">Coordinate</span><span class="token punctuation">(</span>colleague Colleague<span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> colleague<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ConcreteColleague1<span class="token punctuation">:</span>
		c<span class="token punctuation">.</span>ConcreteColleague2<span class="token punctuation">.</span><span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ConcreteColleague2<span class="token punctuation">:</span>
		c<span class="token punctuation">.</span>ConcreteColleague1<span class="token punctuation">.</span><span class="token function">ReceiveMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> mediator

<span class="token keyword">func</span> <span class="token function">ExampleMediator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mediator <span class="token operator">:=</span> ConcreteMediator<span class="token punctuation">{</span><span class="token punctuation">}</span>
	colleague1 <span class="token operator">:=</span> ConcreteColleague1<span class="token punctuation">{</span>mediator<span class="token punctuation">:</span> mediator<span class="token punctuation">}</span>
	colleague2 <span class="token operator">:=</span> ConcreteColleague2<span class="token punctuation">{</span>mediator<span class="token punctuation">:</span> mediator<span class="token punctuation">}</span>
	mediator<span class="token punctuation">.</span>ConcreteColleague1 <span class="token operator">=</span> colleague1
	mediator<span class="token punctuation">.</span>ConcreteColleague2 <span class="token operator">=</span> colleague2

	colleague1<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
	colleague2<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token string">"hi"</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// ConcreateColleague1 send message: hello</span>
	<span class="token comment">// ConcreateColleague2 receive message: hello</span>
	<span class="token comment">// ConcreateColleague2 send message: hi</span>
	<span class="token comment">// ConcreateColleague1 receive message: hi</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>
<p>降低系统复杂度：通过中介者对象，可以将系统中多个对象之间的直接交互关系转化为对中介者对象的请求调用，从而简化了系统的复杂度；</p>
</li>
<li>
<p>减低系统维护成本：通过减少对象之间的直接耦合度，提高了系统的灵活性和可维护性，降低了系统维护的成本；</p>
</li>
<li>
<p>提高系统扩展性：由于中介者对象独立负责对象之间的通信协调，因此增加、删除或修改一个对象都不会影响其他对象的交互关系，从而提高了系统的可扩展性。</p>
</li>
</ul>
<h3>缺点</h3>
<ul>
<li>
<p>中介者对象会引入系统的复杂度：虽然中介者对象可以简化系统的复杂度，但如果中介者对象本身过于复杂，可能会引入新的复杂度；</p>
</li>
<li>
<p>中介者对象可能成为系统的<strong>瓶颈</strong>：由于所有的交互都要经过中介者对象，当系统中对象数量较多或交互复杂时，中介者对象可能成为系统的瓶颈。</p>
</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/mediator/mediator-2x.png" type="image/png"/>
    </item>
    <item>
      <title>备忘录</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/memento.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/memento.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">备忘录</source>
      <description>mementomemento</description>
      <category>设计模式</category>
      <pubDate>Mon, 01 May 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/memento/memento-zh-2x.png" alt="memento" tabindex="0" loading="lazy"><figcaption>memento</figcaption></figure>
<!-- more -->
<h2>什么是备忘录模式</h2>
<p>备忘录模式(Memento Pattern)允许在不暴露对象实现细节的情况下保存和恢复对象之前的状态。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>memento</figcaption></figure>
<ul>
<li>
<p>Originator: 原发器</p>
<p>用于生成自身状态的快照，在需要时可以通过快照恢复自身状态</p>
</li>
<li>
<p>Memento: 备忘录</p>
<p>原发器状态快照，通常将备忘录设置为不可变的类，并且通过构造函数一次性传递数据</p>
</li>
<li>
<p>Caretaker: 负责人</p>
<p>存储备忘录的历史记录</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> memento

<span class="token keyword">type</span> Originator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewOriginator</span><span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Originator <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Originator<span class="token punctuation">{</span>state<span class="token punctuation">:</span> value<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Originator<span class="token punctuation">)</span> <span class="token function">ChangeState</span><span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	o<span class="token punctuation">.</span>state <span class="token operator">=</span> value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Originator<span class="token punctuation">)</span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Memento <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">NewMemento</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Originator<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>memento Memento<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	o<span class="token punctuation">.</span>state <span class="token operator">=</span> memento<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Memento <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMemento</span><span class="token punctuation">(</span>state <span class="token builtin">string</span><span class="token punctuation">)</span> Memento <span class="token punctuation">{</span>
	<span class="token keyword">return</span> Memento<span class="token punctuation">{</span>state<span class="token punctuation">:</span> state<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m Memento<span class="token punctuation">)</span> <span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>state
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Caretaker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	history <span class="token punctuation">[</span><span class="token punctuation">]</span>Memento
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Caretaker<span class="token punctuation">)</span> <span class="token function">AddMemento</span><span class="token punctuation">(</span>memento Memento<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>history<span class="token punctuation">,</span> memento<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Caretaker<span class="token punctuation">)</span> <span class="token function">GetMemento</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> Memento <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>history<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> memento

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	caretaker <span class="token operator">:=</span> Caretaker<span class="token punctuation">{</span>history<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Memento<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	originator <span class="token operator">:=</span> <span class="token function">NewOriginator</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span>
	caretaker<span class="token punctuation">.</span><span class="token function">AddMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	originator<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span>
	caretaker<span class="token punctuation">.</span><span class="token function">AddMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	originator<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span>
	caretaker<span class="token punctuation">.</span><span class="token function">AddMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	originator<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span>caretaker<span class="token punctuation">.</span><span class="token function">GetMemento</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// one</span>
	<span class="token comment">// two</span>
	<span class="token comment">// three</span>
	<span class="token comment">// two</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>可以在不破坏对象封装性的前提下捕获并存储对象的状态；</li>
<li>简化了对象在不同状态之间的切换过程，避免了大量的 if-else 语句；</li>
<li>原发器和负责人之间的解耦，原发器只需要知道如何创建备忘录和恢复备忘录即可，而负责人则负责保存备忘录。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>使用备忘录会占用一定的内存空间；</li>
<li>当原发器的状态改变很频繁时，备忘录对象的数量会很大，会占用较大的内存空间；</li>
<li>如果原发器需要保存的状态很多，那么备忘录对象的创建和恢复操作就会变得很慢。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/memento/memento-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>观察者</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/observer.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/observer.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">观察者</source>
      <description>observerobserver</description>
      <category>设计模式</category>
      <pubDate>Tue, 02 May 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/observer/observer-2x.png" alt="observer" tabindex="0" loading="lazy"><figcaption>observer</figcaption></figure>
<!-- more -->
<h2>什么是观察者模式</h2>
<p>观察者模式(Observer Pattern)定义了对象之间的一对多依赖关系，当一个对象的状态发生变化时，所有依赖关系都会自动得到通知和更新。类似订阅机制，对象变化时通知多个<strong>观察</strong>该对象的其他对象。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>observer</figcaption></figure>
<ul>
<li>
<p>Observer: 观察者</p>
<p>声明了通知接口，在绝大数情况下，该接口仅包含一个<code>update</code>方法，该方法可以有多个参数</p>
</li>
<li>
<p>Subject: 主题</p>
<p>提供一个用于存储观察者对象的聚集类，该类通常包含<code>注册</code>和<code>取消注册</code>观察者的方法，以及通知所有观察者变化的方法。</p>
</li>
<li>
<p>ConcreteObserver: 具体的观察者</p>
<p>实现观察者接口定义的方法，根据自己的需要，实现对象变化时具体的行为。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> observer

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Id <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Observer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Update</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteObserver1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteObserver1<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete observer 1 update ctx:"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteObserver2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteObserver2<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete observer 2 update ctx:"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Subject <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ObserverCollection <span class="token punctuation">[</span><span class="token punctuation">]</span>Observer
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Subject<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>observer Observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>ObserverCollection <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">,</span> observer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Subject<span class="token punctuation">)</span> <span class="token function">UnRegister</span><span class="token punctuation">(</span>observer Observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> observer <span class="token punctuation">{</span>
			s<span class="token punctuation">.</span>ObserverCollection <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Subject<span class="token punctuation">)</span> <span class="token function">NotifyObservers</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>ObserverCollection<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> observer

<span class="token keyword">func</span> <span class="token function">ExampleObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> Context<span class="token punctuation">{</span><span class="token string">"test"</span><span class="token punctuation">}</span>
	co1 <span class="token operator">:=</span> ConcreteObserver1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	co2 <span class="token operator">:=</span> ConcreteObserver2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	subject <span class="token operator">:=</span> Subject<span class="token punctuation">{</span>
		ObserverCollection<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Observer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	subject<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>co1<span class="token punctuation">)</span>
	subject<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>co2<span class="token punctuation">)</span>
	subject<span class="token punctuation">.</span><span class="token function">NotifyObservers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span>Id <span class="token operator">=</span> <span class="token string">"other"</span>
	subject<span class="token punctuation">.</span><span class="token function">UnRegister</span><span class="token punctuation">(</span>co1<span class="token punctuation">)</span>
	subject<span class="token punctuation">.</span><span class="token function">NotifyObservers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concrete observer 1 update ctx: {test}</span>
	<span class="token comment">// concrete observer 2 update ctx: {test}</span>
	<span class="token comment">// concrete observer 2 update ctx: {other}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>松耦合：观察者模式使主题和观察者之间的依赖关系变得松散，让它们可以独立演化，这样就可以在不影响主题的情况下修改或扩展观察者。</li>
<li>可重用性：由于主题和观察者之间的关系被封装在抽象接口中，因此可以方便地添加新的观察者或主题，从而提高代码的可重用性和可维护性。</li>
<li>通知机制：一旦主题状态发生变化，观察者会自动被通知，并且可以及时更新自己的状态，从而保证了数据的一致性。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>性能问题：如果观察者过多，通知所有观察者会浪费很多资源，可能会导致系统运行缓慢。</li>
<li>难以理解：当涉及多个对象之间的交互时，观察者模式可能比较难以理解和调试</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/observer/observer-2x.png" type="image/png"/>
    </item>
    <item>
      <title>状态</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/state.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/state.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">状态</source>
      <description>statestate</description>
      <category>设计模式</category>
      <pubDate>Thu, 04 May 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/state/state-zh-2x.png" alt="state" tabindex="0" loading="lazy"><figcaption>state</figcaption></figure>
<!-- more -->
<h2>什么是状态模式</h2>
<p>状态模式(State Pattern) 允许对象在其内部状态发生变化时改变其行为。通过将状态转换代码从主逻辑中抽离并封装在状态对象中，使得对象能够在行为上进行更灵活的变化。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>state</figcaption></figure>
<ul>
<li>
<p>Context: 上下文</p>
<p>它是包含状态的主对象。它还包含一些用于在状态之间切换的方法。</p>
</li>
<li>
<p>State: 状态</p>
<p>它定义一个接口，用于封装与上下文的特定状态相关的行为。</p>
</li>
<li>
<p>ConcreteStates: 具体状态类</p>
<p>实现State接口，每个具体状态都提供各自的实现方式。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> state

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state State
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">ChangeState</span><span class="token punctuation">(</span>state State<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state <span class="token operator">=</span> state
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> State <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span>
	<span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span>
	<span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> StartState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StartState<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"already start"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StartState<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change start state to stop"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StopState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StartState<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change start state to run"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RunState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> StopState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StopState<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change stop state to start"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StartState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StopState<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"already stop"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StopState<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"can't change stop state to run"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RunState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RunState<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"can't change run state to start"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RunState<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"change run state to stop"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">ChangeState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StopState<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RunState<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"already run"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> state

<span class="token keyword">func</span> <span class="token function">ExampleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	start <span class="token operator">:=</span> <span class="token operator">&amp;</span>StartState<span class="token punctuation">{</span><span class="token punctuation">}</span>
	context <span class="token operator">:=</span> Context<span class="token punctuation">{</span>state<span class="token punctuation">:</span> start<span class="token punctuation">}</span>
	context<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	context<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	context<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	context<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// already start</span>
	<span class="token comment">// change start state to run</span>
	<span class="token comment">// change run state to stop</span>
	<span class="token comment">// can't change stop state to run</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>将状态抽象成对象，使得状态之间的转换更加清晰明了。通过将每种状态封装成具体的类，可以使代码更加简单易懂，避免了状态转换时大量的条件判断。</li>
<li>状态之间的转换变得容易扩展。由于状态之间的转换是由状态对象自身完成的，因此只需要增加、修改或删除对应的状态类即可扩展或修改状态转换，而不影响其他部分。</li>
<li>提高代码的复用性和灵活性。由于每个状态都是一个独立的对象，因此可以在不同的上下文中重复使用。这样，就可以实现更多的组合方式，从而提高代码的复用性和灵活性。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>
<p>对于简单的状态机，引入状态模式会增加额外的复杂度。如果状态机只有几个状态，那么引入状态模式可能会让代码更加复杂，难以维护。</p>
</li>
<li>
<p>增加了系统的类和对象数量。引入状态模式会增加额外的类和对象，在一定程度上增加了系统的复杂度和开销。</p>
</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/state/state-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>策略</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/strategy.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/strategy.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">策略</source>
      <description>strategystrategy</description>
      <category>设计模式</category>
      <pubDate>Tue, 13 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/strategy/strategy-2x.png" alt="strategy" tabindex="0" loading="lazy"><figcaption>strategy</figcaption></figure>
<!-- more -->
<h2>什么是策略模式</h2>
<p>策略模式(Strategy Pattern)定义了算法族，分别封装起来，让他们之间可以互相替换，此模式让算法的变化独立于使用算法的客户。策略模式属于对象行为模式，它通过对算法进行封装，把使用算法的责任和算法的实现分割开来，并委派给不同的对象对这些算法进行管理。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>strategy</figcaption></figure>
<ul>
<li>
<p>Strategy: 策略接口</p>
<p>是所有具体策略的通用接口，它声明了一个上下文用于执行策略的方法</p>
</li>
<li>
<p>Concrete Strategies: 具体策略，实现了上下文所用算法的各种不同变体；</p>
</li>
<li>
<p>Context: 上下文，维护指向具体策略的引用，且仅通过策略接口与该对象进行交流；</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> strategy

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Strategy <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteStrategy1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s ConcreteStrategy1<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete strategy1 execute"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteStrategy2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s ConcreteStrategy2<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete strategy2 execute"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	strategy Strategy
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">SetStrategy</span><span class="token punctuation">(</span>strategy Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>strategy <span class="token operator">=</span> strategy
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"do something"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> strategy

<span class="token keyword">func</span> <span class="token function">ExampleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> Context<span class="token punctuation">{</span><span class="token punctuation">}</span>
	s1 <span class="token operator">:=</span> ConcreteStrategy1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">SetStrategy</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	s2 <span class="token operator">:=</span> ConcreteStrategy2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">SetStrategy</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// do something</span>
	<span class="token comment">// concrete strategy1 execute</span>
	<span class="token comment">// do something</span>
	<span class="token comment">// concrete strategy2 execute</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>可以在运行时切换对象内的算法。</li>
<li>可以将算法的实现和使用算法的代码隔离开来。</li>
<li>可以使用组合来代替继承。</li>
<li>开闭原则，无需对上下文进行修改就能够引入新的策略。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>如果你的算法极少发生改变， 那么没有任何理由引入新的类和接口。 使用该模式只会让程序过于复杂。</li>
<li>客户端必须知晓策略间的不同——它需要选择合适的策略。</li>
<li>许多现代编程语言支持函数类型功能， 允许你在一组匿名函数中实现不同版本的算法。 这样， 你使用这些函数的方式就和使用策略对象时完全相同， 无需借助额外的类和接口来保持代码简洁。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/strategy/strategy-2x.png" type="image/png"/>
    </item>
    <item>
      <title>模版方法</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/template-method.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/template-method.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">模版方法</source>
      <description>template-methodtemplate-method</description>
      <category>设计模式</category>
      <pubDate>Sun, 11 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/template-method/template-method-2x.png" alt="template-method" tabindex="0" loading="lazy"><figcaption>template-method</figcaption></figure>
<!-- more -->
<h2>场景问题</h2>
<p>例如：假设开发一个文档的数据挖局程序，输入各种格式的文档（PDF、DOC、CSV、...），程序从这些文档中提取有意义的数据，进行处理和分析，并返回给用户。随着开发进行，实现三个类分别是：PDFDataMiner、DOCDataMiner、CSVDataMiner，它们都有相似的处理逻辑：打开文件、提取数据、转换数据、分析数据、发送报告。其中：分析数据和发送报告模块完全一致。
那么我们就可以使用模版方法模式将步骤进行抽象，并提供步骤的默认实现，支持重写。</p>
<h2>什么是模版方法模式</h2>
<p>模版方法模式（Template Method Pattern），将总结出来的规律沉淀为一种既定格式，并固化于模版中以供子类继承，对未确定下来的步骤方法进行抽象化，使其得以延续、多态化，最终架构起一个平台，使系统实现在不改变预设规则的前提下，对每个分步骤进行个性化定义的目的。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>template-method</figcaption></figure>
<ul>
<li>
<p>AbstractClass: 抽象类</p>
<p>负责给出一个算法的轮廓和骨架。它由一个模版方法和若干个基本方法构成</p>
</li>
<li>
<p>ConCreteClass: 具体实现类</p>
<p>复用抽象类的方法，或者重写相关方法。</p>
</li>
</ul>
<h3>代码示例</h3>
<p>由于Go语言没有抽象类这一概念，我们使用接口实现。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> templatemethod

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Templater <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Implement <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Abstract <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Implement
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newAbstract</span><span class="token punctuation">(</span>impl Implement<span class="token punctuation">)</span> <span class="token operator">*</span>Abstract <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Abstract<span class="token punctuation">{</span>Implement<span class="token punctuation">:</span> impl<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Abstract<span class="token punctuation">)</span> <span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span>Implement<span class="token punctuation">.</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>Implement<span class="token punctuation">.</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>Implement<span class="token punctuation">.</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Abstract<span class="token punctuation">)</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"default step2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Concreate1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>Abstract
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConcreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Templater <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Concreate1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> <span class="token function">newAbstract</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Abstract <span class="token operator">=</span> a
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate1<span class="token punctuation">)</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate1 step1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate1<span class="token punctuation">)</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate1 step2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate1<span class="token punctuation">)</span> <span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate1 step3"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Concreate2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>Abstract
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewConcreate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Templater <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Concreate2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> <span class="token function">newAbstract</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Abstract <span class="token operator">=</span> a
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate2<span class="token punctuation">)</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate2 step1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>Concreate2<span class="token punctuation">)</span> <span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concreate2 step3"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> t Templater
	t <span class="token operator">=</span> <span class="token function">NewConcreate1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t <span class="token operator">=</span> <span class="token function">NewConcreate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concreate1 step1</span>
	<span class="token comment">// concreate1 step2</span>
	<span class="token comment">// concreate1 step3</span>
	<span class="token comment">// concreate2 step1</span>
	<span class="token comment">// default step2</span>
	<span class="token comment">// concreate2 step3</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中concreate2并未实现step2()，而是使用了默认的step2()</p>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>允许客户端重写一个大型算法中的特定部分，使得算法其他部分修改对其所造成的影响较小。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>部分客户端可能受到算法框架的限制</li>
<li>通过子类一直默认步骤实现可能会导致违反里氏替换原则</li>
<li>模版方法中的步骤越多，其维护工作就可能会越困难</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/template-method/template-method-2x.png" type="image/png"/>
    </item>
    <item>
      <title>访问者</title>
      <link>http://blog.cjhe.top/design-pattern/behavioral/visitor.html</link>
      <guid>http://blog.cjhe.top/design-pattern/behavioral/visitor.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">访问者</source>
      <description>visitorvisitor</description>
      <category>设计模式</category>
      <pubDate>Fri, 05 May 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/visitor/visitor-2x.png" alt="visitor" tabindex="0" loading="lazy"><figcaption>visitor</figcaption></figure>
<!-- more -->
<h2>什么是访问者模式</h2>
<p>访问者模式(Visitor Pattern)将算法与对象结构分离开来，并在结构中增加可操作元素的能力。其主要思想是在不改变已有类的前提下，通过增加访问者类，来给已有类增加新的操作方法。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>visitor</figcaption></figure>
<ul>
<li>
<p>Visitor: 访问者</p>
<p>声明了一些列以对象结构的具体元素为参数的访问者方法</p>
</li>
<li>
<p>ConCreteVistors: 具体访问者</p>
<p>不同的具体访问者实现访问元素对象各不相同</p>
</li>
<li>
<p>Element: 元素</p>
<p>声明了一个方法来接收访问者</p>
</li>
<li>
<p>ConcreteElement: 具体元素</p>
<p>具体元素实现接收方法，该方法根据当前访问者类调用相应访问者方法。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Visitor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">VisitConcreteElementA</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementA<span class="token punctuation">)</span>
	<span class="token function">VisitConcreteElementB</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementB<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteVisitor <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteVisitor<span class="token punctuation">)</span> <span class="token function">VisitConcreteElementA</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visit ConcreteElementA"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteVisitor<span class="token punctuation">)</span> <span class="token function">VisitConcreteElementB</span><span class="token punctuation">(</span>element <span class="token operator">*</span>ConcreteElementB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visit ConcreteElementB"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Element <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Accept</span><span class="token punctuation">(</span>visitor Visitor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteElementA <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteElementA<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor Visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitConcreteElementA</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteElementB <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ConcreteElementB<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor Visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitConcreteElementB</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">func</span> <span class="token function">ExampleVisitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConcreteVisitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
	elementA <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConcreteElementA<span class="token punctuation">{</span><span class="token punctuation">}</span>
	elementB <span class="token operator">:=</span> <span class="token operator">&amp;</span>ConcreteElementB<span class="token punctuation">{</span><span class="token punctuation">}</span>
	elementA<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span>
	elementB<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Visit ConcreteElementA</span>
	<span class="token comment">// Visit ConcreteElementB</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>应用场景</h2>
<ul>
<li>当对象结构比较稳定，但需要经常定义新的操作时，访问者模式可以使用。</li>
<li>当一组对象中，需要执行不同的、复杂的操作时，可以使用访问者模式来封装这些操作，以简化代码逻辑。</li>
</ul>
<h3>在不修改已有代码的情况下，向已有类层次结构增加新的行为</h3>
<p>假如当前已有三种稳定图形类：正方形、圆形、三角形。当前需求是获取这三种图形的面积和周长，且未来可能有其他的行为操作。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">import</span> <span class="token string">"math"</span>

<span class="token keyword">type</span> Shape <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CalculateVisitor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">VisitSquare</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span>
	<span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span>
	<span class="token function">VisitCircle</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正方形</span>
<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	SideLength <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitSquare</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 长方形</span>
<span class="token keyword">type</span> Rectangle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Width  <span class="token builtin">float64</span>
	Height <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 圆形</span>
<span class="token keyword">type</span> Circle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Radius <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span>visitor CalculateVisitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	visitor<span class="token punctuation">.</span><span class="token function">VisitCircle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 面积访问者</span>
<span class="token keyword">type</span> AreaVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Area <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>av <span class="token operator">*</span>AreaVisitor<span class="token punctuation">)</span> <span class="token function">VisitSquare</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	av<span class="token punctuation">.</span>Area <span class="token operator">=</span> s<span class="token punctuation">.</span>SideLength <span class="token operator">*</span> s<span class="token punctuation">.</span>SideLength
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>av <span class="token operator">*</span>AreaVisitor<span class="token punctuation">)</span> <span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	av<span class="token punctuation">.</span>Area <span class="token operator">=</span> r<span class="token punctuation">.</span>Width <span class="token operator">*</span> r<span class="token punctuation">.</span>Height
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>av <span class="token operator">*</span>AreaVisitor<span class="token punctuation">)</span> <span class="token function">VisitCircle</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	av<span class="token punctuation">.</span>Area <span class="token operator">=</span> math<span class="token punctuation">.</span>Pi <span class="token operator">*</span> c<span class="token punctuation">.</span>Radius <span class="token operator">*</span> c<span class="token punctuation">.</span>Radius
<span class="token punctuation">}</span>

<span class="token comment">// 周长访问者</span>
<span class="token keyword">type</span> PerimeterVisitor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Perimeter <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pv <span class="token operator">*</span>PerimeterVisitor<span class="token punctuation">)</span> <span class="token function">VisitSquare</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pv<span class="token punctuation">.</span>Perimeter <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> s<span class="token punctuation">.</span>SideLength
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pv <span class="token operator">*</span>PerimeterVisitor<span class="token punctuation">)</span> <span class="token function">VisitRectangle</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Rectangle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pv<span class="token punctuation">.</span>Perimeter <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>Width <span class="token operator">+</span> r<span class="token punctuation">.</span>Height<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pv <span class="token operator">*</span>PerimeterVisitor<span class="token punctuation">)</span> <span class="token function">VisitCircle</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pv<span class="token punctuation">.</span>Perimeter <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>Pi <span class="token operator">*</span> c<span class="token punctuation">.</span>Radius
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> visitor

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	square <span class="token operator">:=</span> <span class="token operator">&amp;</span>Square<span class="token punctuation">{</span>SideLength<span class="token punctuation">:</span> <span class="token number">4.0</span><span class="token punctuation">}</span>
	rectangle <span class="token operator">:=</span> <span class="token operator">&amp;</span>Rectangle<span class="token punctuation">{</span>Width<span class="token punctuation">:</span> <span class="token number">3.0</span><span class="token punctuation">,</span> Height<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">}</span>
	circle <span class="token operator">:=</span> <span class="token operator">&amp;</span>Circle<span class="token punctuation">{</span>Radius<span class="token punctuation">:</span> <span class="token number">2.0</span><span class="token punctuation">}</span>

	areaVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>AreaVisitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
	square<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>areaVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"square area:"</span><span class="token punctuation">,</span> areaVisitor<span class="token punctuation">.</span>Area<span class="token punctuation">)</span>
	rectangle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>areaVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rectangle area:"</span><span class="token punctuation">,</span> areaVisitor<span class="token punctuation">.</span>Area<span class="token punctuation">)</span>
	circle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>areaVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"circle area:"</span><span class="token punctuation">,</span> areaVisitor<span class="token punctuation">.</span>Area<span class="token punctuation">)</span>

	perimeterVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>PerimeterVisitor<span class="token punctuation">{</span><span class="token punctuation">}</span>
	square<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>perimeterVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"square perimeter:"</span><span class="token punctuation">,</span> perimeterVisitor<span class="token punctuation">.</span>Perimeter<span class="token punctuation">)</span>
	rectangle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>perimeterVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"rectangle perimeter:"</span><span class="token punctuation">,</span> perimeterVisitor<span class="token punctuation">.</span>Perimeter<span class="token punctuation">)</span>
	circle<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>perimeterVisitor<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"circle perimeter:"</span><span class="token punctuation">,</span> perimeterVisitor<span class="token punctuation">.</span>Perimeter<span class="token punctuation">)</span>

	<span class="token comment">// Output:</span>
	<span class="token comment">// square area: 16</span>
	<span class="token comment">// rectangle area: 15</span>
	<span class="token comment">// circle area: 12.566370614359172</span>
	<span class="token comment">// square perimeter: 16</span>
	<span class="token comment">// rectangle perimeter: 16</span>
	<span class="token comment">// circle perimeter: 12.566370614359172</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里只需要实现面积访问者类和周长访问者类就可以不用动三个图形类。</p>
<h2>总结</h2>
<h3>优点</h3>
<ul>
<li>增加新的操作时不需要改变现有的对象结构，只需要增加新的访问者即可。</li>
<li>结构和操作分离，符合<strong>单一职责原则</strong>和<strong>开闭原则</strong>，降低了系统的耦合度。</li>
<li>把数据结构和操作分离，可以使得代码更容易理解和维护。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>增加新的元素时比较困难，需要修改抽象访问者的接口以及所有的具体访问者的实现。</li>
<li>访问者模式将对象本身和操作分离开来，导致增加新的操作不够方便。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/visitor/visitor-2x.png" type="image/png"/>
    </item>
    <item>
      <title>并发模式</title>
      <link>http://blog.cjhe.top/design-pattern/concurrency/</link>
      <guid>http://blog.cjhe.top/design-pattern/concurrency/</guid>
      <source url="http://blog.cjhe.top/rss.xml">并发模式</source>
      <description>Go语言推荐CSP模型进行并发处理，而非通过共享内存。这里总结一些并发模式或者称作范式，去管理控制协程。</description>
      <category>设计模式</category>
      <pubDate>Sun, 26 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>Go语言推荐CSP模型进行并发处理，而非通过共享内存。这里总结一些并发模式或者称作范式，去管理控制协程。</p>
<!-- more -->
<h2>Go并发模式</h2>
<p>我们都知道Go语言开启协程只需要<code>go func(){ }</code>，有时候需要与goroutine之间建立联系，方便进一步控制与处理。
因此总结一些范式，优雅的管理goroutine。</p>
]]></content:encoded>
    </item>
    <item>
      <title>抽象工厂</title>
      <link>http://blog.cjhe.top/design-pattern/creational/abstract-factory.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/abstract-factory.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">抽象工厂</source>
      <description>abstract-factoryabstract-factory</description>
      <category>设计模式</category>
      <pubDate>Sat, 15 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/abstract-factory/abstract-factory-zh-2x.png" alt="abstract-factory" tabindex="0" loading="lazy"><figcaption>abstract-factory</figcaption></figure>
<!-- more -->
<h2>问题</h2>
<p>工厂方法模式只考虑生产同等级的产品，而抽象工厂模式(Abstract Factory Pattern)可生产多个等级的产品。抽象工厂模式用于生成<strong>产品族</strong>的工厂，所生成的对象是有关联的，同一个具体工厂所生产的位于不同等级的一组产品称为一个产品族，例如：</p>
<ul>
<li>桌子、椅子、沙发是一个产品族</li>
<li>欧洲牌、亚洲牌是一个产品等级</li>
</ul>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>抽象工厂模式</figcaption></figure>
<ul>
<li>
<p>Abstract Factory: 抽象工厂</p>
<p>它声明了一组用于创建一族产品的方法，每一个方法对应一种产品。</p>
</li>
<li>
<p>Concrete Factory: 具体工厂</p>
<p>它实现了在抽象工厂中声明的创建产品的方法，生成一组具体产品，这些产品构成了一个产品族，每一个产品都位于某个产品等级结构中。</p>
</li>
<li>
<p>Abstract Product: 抽象产品</p>
<p>它为每种产品声明接口，在抽象产品中声明了产品所具有的业务方法。</p>
</li>
<li>
<p>Product: 具体产品</p>
<p>它定义具体工厂生产的具体产品对象，实现抽象产品接口中声明的业务方法。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> abstract_factory

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token comment">// 抽象产品1</span>
<span class="token keyword">type</span> Product1 <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 抽象产品2</span>
<span class="token keyword">type</span> Product2 <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Use</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 抽象工厂</span>
<span class="token keyword">type</span> AbstractFactory <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">NewProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product1
	<span class="token function">NewProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product2
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品11</span>
<span class="token keyword">type</span> ConcreteProduct11 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct11<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product11 show"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品12</span>
<span class="token keyword">type</span> ConcreteProduct12 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct12<span class="token punctuation">)</span> <span class="token function">Use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product12 use"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体工厂1</span>
<span class="token keyword">type</span> ConcreteFactory1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreteFactory1<span class="token punctuation">)</span> <span class="token function">NewProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product1 <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct11<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreteFactory1<span class="token punctuation">)</span> <span class="token function">NewProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product2 <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct12<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品21</span>
<span class="token keyword">type</span> ConcreteProduct21 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct21<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product21 show"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteProduct22 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct22<span class="token punctuation">)</span> <span class="token function">Use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product22 use"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体工厂2</span>
<span class="token keyword">type</span> ConcreteFactory2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreteFactory2<span class="token punctuation">)</span> <span class="token function">NewProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product1 <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct21<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreteFactory2<span class="token punctuation">)</span> <span class="token function">NewProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product2 <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct22<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> abstract_factory

<span class="token keyword">func</span> <span class="token function">ExampleConcreteFactory1_NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> factory AbstractFactory
	factory <span class="token operator">=</span> ConcreteFactory1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	product1 <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	Product2 <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product1<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	Product2<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Product11 show</span>
	<span class="token comment">// Product12 use</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleConcreteFactory2_NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> factory AbstractFactory
	factory <span class="token operator">=</span> ConcreteFactory2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	product1 <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product2 <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product1<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product2<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Product21 show</span>
	<span class="token comment">// Product22 use</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>效果</h2>
<h3>应用场景</h3>
<p>在以下情况下可以使用抽象工厂模式：</p>
<ul>
<li>一个系统不应当依赖于产品类实例如何被创建、组合和表达的细节，这对于所有类型的工厂模式都是重要的。</li>
<li>系统中有多于一个的产品族，而每次只使用其中某一产品族。</li>
<li>属于同一个产品族的产品将在一起使用，这一约束必须在系统的设计中体现出来。</li>
<li>系统提供一个产品类的库，所有的产品以同样的接口出现，从而使客户端不依赖于具体实现。</li>
</ul>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>抽象工厂模式隔离了具体类的生产，使得客户并不需要知道什么被创建。</li>
<li>抽象工厂模式可以在类的内部对产品族进行约束，保证客户端始终只使用同一个产品族中的对象。</li>
<li>抽象工厂模式可以方便地切换产品系列，只需要更换具体工厂即可。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>产品族扩展非常困难，要增加一个系列的某一产品，既要在抽象的工厂里加代码，又要在具体的工厂里加代码。<strong>产品族难扩展，产品等级易扩展</strong></li>
<li>抽象工厂模式增加了系统的抽象性和理解难度。</li>
</ul>
<h2>总结</h2>
<p>抽象工厂模式通过引入抽象工厂接口和抽象产品接口，提供了一种统一的接口用于创建一组相关的产品对象。它可以将产品的创建过程封装起来，使得客户端代码可以与具体产品的实现细节解耦。抽象工厂模式的灵活性和可扩展性允许在运行时动态切换不同的具体工厂和产品族。</p>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/abstract-factory/abstract-factory-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>建造者</title>
      <link>http://blog.cjhe.top/design-pattern/creational/builder.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/builder.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">建造者</source>
      <description>builderbuilder</description>
      <category>设计模式</category>
      <pubDate>Sun, 16 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/builder/builder-zh-2x.png" alt="builder" tabindex="0" loading="lazy"><figcaption>builder</figcaption></figure>
<!-- more -->
<p>建造者模式(Builder Pattern)又叫生成器模式，它将一个复杂对象的构建与它的表示分离。使统一的构建过程可以创建不同的表示。</p>
<p>它将一个复杂的对象分解为多个简单的对象，然后一步一步构建而成，它将变与不变相分离，即产品的组成部分是不变的，但每一部分是可以灵活选择的。</p>
<h2>问题</h2>
<p>当对象非常复杂，且存在以下场景：</p>
<ul>
<li>对象的构建过程非常复杂，且有多个步骤时</li>
<li>对象构造时需要传入很多参数时</li>
<li>对象的组成部分有多种选择，构建需要考虑各个部分的组合时</li>
</ul>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>建造者模式</figcaption></figure>
<ul>
<li>
<p>Product：产品角色</p>
<p>包含多个组成部分的复杂对象，由具体建造者来创建各个零部件。</p>
</li>
<li>
<p>Builder：抽象建造者</p>
<p>为创建产品各个子部件指定抽象接口，一般是buildXXX()方法，通常还包含一个返回复杂产品的方法getResult()。</p>
</li>
<li>
<p>Concrete Builder：具体建造者</p>
<p>实现Builder接口，完成复杂产品的各个部件的具体创建方法。</p>
</li>
<li>
<p>Director：指挥者</p>
<p>调用建造者对象中的部件构建与装配方法完成复杂对象的创建，在指挥者中不涉及具体产品的信息。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> builder

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Product <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	partA <span class="token builtin">string</span>
	partB <span class="token builtin">string</span>
	partC <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Product<span class="token punctuation">)</span> <span class="token function">setPartA</span><span class="token punctuation">(</span>partA <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>partA <span class="token operator">=</span> partA
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Product<span class="token punctuation">)</span> <span class="token function">setPartB</span><span class="token punctuation">(</span>partB <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>partB <span class="token operator">=</span> partB
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Product<span class="token punctuation">)</span> <span class="token function">setPartC</span><span class="token punctuation">(</span>partC <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>partC <span class="token operator">=</span> partC
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p Product<span class="token punctuation">)</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"A:%s\tB:%s\tC:%s"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>partA<span class="token punctuation">,</span> p<span class="token punctuation">.</span>partB<span class="token punctuation">,</span> p<span class="token punctuation">.</span>partC<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Builder <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">buildPartC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Director <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	builder Builder
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Director<span class="token punctuation">)</span> <span class="token function">Director</span><span class="token punctuation">(</span>builder Builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d<span class="token punctuation">.</span>builder <span class="token operator">=</span> builder
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d Director<span class="token punctuation">)</span> <span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product <span class="token punctuation">{</span>
	d<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">buildPartC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteBuilder1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	product <span class="token operator">*</span>Product
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder1<span class="token punctuation">)</span> <span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>product<span class="token punctuation">.</span><span class="token function">setPartA</span><span class="token punctuation">(</span><span class="token string">"A1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder1<span class="token punctuation">)</span> <span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>product<span class="token punctuation">.</span><span class="token function">setPartB</span><span class="token punctuation">(</span><span class="token string">"B1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder1<span class="token punctuation">)</span> <span class="token function">buildPartC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>product<span class="token punctuation">.</span><span class="token function">setPartC</span><span class="token punctuation">(</span><span class="token string">"C1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder1<span class="token punctuation">)</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">*</span>c<span class="token punctuation">.</span>product
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteBuilder2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	product <span class="token operator">*</span>Product
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder2<span class="token punctuation">)</span> <span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>product<span class="token punctuation">.</span><span class="token function">setPartA</span><span class="token punctuation">(</span><span class="token string">"A2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder2<span class="token punctuation">)</span> <span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>product<span class="token punctuation">.</span><span class="token function">setPartB</span><span class="token punctuation">(</span><span class="token string">"B2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder2<span class="token punctuation">)</span> <span class="token function">buildPartC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>product<span class="token punctuation">.</span><span class="token function">setPartC</span><span class="token punctuation">(</span><span class="token string">"C2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteBuilder2<span class="token punctuation">)</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">*</span>c<span class="token punctuation">.</span>product
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> builder

<span class="token keyword">func</span> <span class="token function">ExampleDirector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	builder <span class="token operator">:=</span> ConcreteBuilder1<span class="token punctuation">{</span>product<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> director Director
	director<span class="token punctuation">.</span><span class="token function">Director</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span>
	product <span class="token operator">:=</span> director<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output: A:A1	B:B1	C:C1</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleDirector_second</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	builder <span class="token operator">:=</span> ConcreteBuilder2<span class="token punctuation">{</span>product<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> director Director
	director<span class="token punctuation">.</span><span class="token function">Director</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span>
	product <span class="token operator">:=</span> director<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output: A:A2	B:B2	C:C2</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>效果</h2>
<h3>应用场景</h3>
<ul>
<li>当要创建的对象是由多个部件组成，而且部件的组合方式可能有不同的变化时，可以使用建造者模式来封装复杂的创建逻辑，提高代码的复用性和可维护性。</li>
<li>当要创建的对象的构建过程需要分步进行，而且每一步都可能有不同的实现方式时，可以使用建造者模式来将构建过程和表示分离，提高代码的灵活性和扩展性。</li>
<li>当要创建的对象的表示和构建过程都需要根据不同的需求进行定制时，可以使用建造者模式来将客户端和具体建造者解耦，提高代码的可定制性和可配置性。</li>
</ul>
<p>例如：</p>
<p>房屋装修是一个复杂的过程，包含：地板的选择、墙体的装修颜色、天花板的设计、家具的布局等等。客户把装修要求告诉装修项目经理，项目经理指挥工人一步步装修，最后完成整个房屋的装修与布局。</p>
<p>汽车的建造通常包含：轮胎的选择、发动机的选择、车身设计、车内装潢等等，方案虽然不同，但步骤通常是一致的。</p>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>封装性好，创建和使用分离，调用者无需关注细节部分。</li>
<li>扩展性好，各个具体的建造者相互独立，有利于系统的解耦。</li>
<li>客户端不必知道产品内部组成的细节，建造者可以对创建过程逐步细化，而不对其他模块产生任何影响，便于控制细节风险。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>产品的组成部分必须相同，这限制了其使用范围。</li>
<li>如果产品内部发生变化，则建造者也要同步修改，后期维护成本较大。</li>
</ul>
<h2>总结</h2>
<p>建造者设计模式是一种创建型模式，它可以用于创建复杂的对象，将对象的构建过程和表示分离开来。它适用于以下情况：</p>
<ul>
<li>当要创建的对象是由多个部件组成，而且部件的组合方式可能有不同的变化时。</li>
<li>当要创建的对象的构建过程需要分步进行，而且每一步都可能有不同的实现方式时。</li>
<li>当要创建的对象的表示和构建过程都需要根据不同的需求进行定制时。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/builder/builder-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>工厂方法</title>
      <link>http://blog.cjhe.top/design-pattern/creational/factory-method.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/factory-method.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">工厂方法</source>
      <description>factory-methodfactory-method</description>
      <category>设计模式</category>
      <pubDate>Sat, 15 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/factory-method/factory-method-zh-2x.png" alt="factory-method" tabindex="0" loading="lazy"><figcaption>factory-method</figcaption></figure>
<!-- more -->
<p>工厂方法模式(Factory Method Pattern)也叫虚拟构造器(Virtual Constructor)模式</p>
<h2>问题</h2>
<p>由于简单工厂模式违背了<code>开闭原则</code>，而工厂方法模式对简单工厂模式进一步抽象，其好处是可以使系统在不修改原来代码的情况下引进新的产品，即满足开闭原则。</p>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>工厂方法模式</figcaption></figure>
<ul>
<li>
<p>Abstract Factory：抽象工厂</p>
<p>提供了创建产品的接口，调用者通过它访问具体工厂的工厂方法来创建产品。</p>
</li>
<li>
<p>Concrete Factory：具体工厂</p>
<p>实现了抽象工厂的方法，完成具体产品的创建。</p>
</li>
<li>
<p>Product：抽象产品</p>
<p>定义了产品的规范，描述了产品的主要特性和功能。</p>
</li>
<li>
<p>Concrete Product：具体产品</p>
<p>实现了抽象产品定义的接口，由具体工厂来创建，它同具体工厂之间一一对应。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> factory_method

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token comment">// 抽象产品</span>
<span class="token keyword">type</span> Product <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 抽象工厂</span>
<span class="token keyword">type</span> AbstractFactory <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品1</span>
<span class="token keyword">type</span> ConcreteProduct1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct1<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product1 show"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体工厂1</span>
<span class="token keyword">type</span> ConcreteFactory1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreteFactory1<span class="token punctuation">)</span> <span class="token function">NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct1<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品2</span>
<span class="token keyword">type</span> ConcreteProduct2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct2<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product2 show"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体工厂2</span>
<span class="token keyword">type</span> ConcreteFactory2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreteFactory2<span class="token punctuation">)</span> <span class="token function">NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Product <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct2<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用工厂创建产品示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> factory_method

<span class="token keyword">func</span> <span class="token function">ExampleConcreteFactory1_NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> factory AbstractFactory
	factory <span class="token operator">=</span> ConcreteFactory1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	product <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Product1 show</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleConcreteFactory2_NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> factory AbstractFactory
	factory <span class="token operator">=</span> ConcreteFactory2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	product <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	product<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Product2 show</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>效果</h2>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>遵循了<code>开闭原则</code>，扩展性极强。增加新的产品类时，只需增加对应的工厂类，不需要修改原有代码。</li>
<li>降低了系统的耦合性，将对象的创建和使用分离，使得各个模块各司其职。</li>
<li>利用了面向接口编程的思路，创建的对象是一个符合通用接口的通用对象，这个对象的具体实现可以随意替换。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>增加了系统的复杂度，类的个数容易过多，增加了系统抽象性和理解难度。</li>
<li>增加了系统的开销，每次创建对象时都要创建一个工厂对象，消耗资源和时间。</li>
<li><strong>抽象产品只能是一种产品</strong>。此弊端可使用抽象工厂模式解决。</li>
</ul>
<h3>应用场景</h3>
<ul>
<li>当创建对象需要使用大量重复的代码时，可以使用工厂方法模式来简化代码和提高可读性。</li>
<li>当客户端不关心对象的创建过程和实现细节时，可以使用工厂方法模式来隐藏对象的创建逻辑，只需要知道工厂类和产品接口即可。</li>
<li>当一个类通过其子类来指定创建哪个对象时，可以使用工厂方法模式来实现多态和动态绑定，让子类决定具体的产品类。</li>
<li>当需要根据不同的环境或条件来创建不同的对象时，可以使用工厂方法模式来根据不同的工厂类来创建对应的产品类。</li>
</ul>
<p>举例：</p>
<ul>
<li>换灯泡：假设你有一个灯泡接口，它有一个方法是发光，你有不同的灯泡实现类，比如白炽灯、节能灯、LED灯等，每种灯泡都有自己的工厂类，负责创建对应的灯泡对象。这样你就可以根据需要选择不同的工厂来创建不同的灯泡，而不用直接使用new关键字。</li>
<li>日志记录器：假设你有一个日志记录器接口，它有一个方法是记录日志，你有不同的日志记录器实现类，比如文件日志记录器、数据库日志记录器、网络日志记录器等，每种日志记录器都有自己的工厂类，负责创建对应的日志记录器对象。这样你就可以根据需要选择不同的工厂来创建不同的日志记录器，而不用直接使用new关键字。</li>
<li>电脑商店：假设你有一个电脑接口，它有一些方法是显示配置、运行程序等，你有不同的电脑实现类，比如联想电脑、华为电脑、苹果电脑等，每种电脑都有自己的工厂类，负责创建对应的电脑对象。这样你就可以根据需要选择不同的工厂来创建不同的电脑，而不用直接使用new关键字。</li>
</ul>
<h2>总结</h2>
<p>工厂方法模式通过定义工厂接口和产品接口，并由具体的工厂类和产品类来实现，实现了对象的创建和使用的分离，提高了代码的可扩展性和可维护性。</p>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/factory-method/factory-method-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>对象池</title>
      <link>http://blog.cjhe.top/design-pattern/creational/object-pool.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/object-pool.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">对象池</source>
      <description>对象池模式(Object Pool Pattern)：它通过预先创建和初始化一组对象，然后将它们存放在一个池中，以便在需要时重复使用。这样可以减少频繁创建和销毁对象的开销，提高应用程序的性能和效率。
问题
在某些性能场景，频繁的创建和销毁对象或对GC压力较大，影响程序的性能
解决方案
角色
object-poolobject-pool


Pool：对...</description>
      <category>设计模式</category>
      <pubDate>Sun, 16 Apr 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<!-- more -->
<p>对象池模式(Object Pool Pattern)：它通过预先创建和初始化一组对象，然后将它们存放在一个池中，以便在需要时重复使用。这样可以减少频繁创建和销毁对象的开销，提高应用程序的性能和效率。</p>
<h2>问题</h2>
<p>在某些性能场景，频繁的创建和销毁对象或对GC压力较大，影响程序的性能</p>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>object-pool</figcaption></figure>
<ul>
<li>
<p>Pool：对象池</p>
<p>对象池维护活动对象列表和空闲对象列表</p>
</li>
<li>
<p>Object：对象</p>
<p>对象被客户端使用</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> object_pool

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> pool <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mutex     <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex
	idle      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	active    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	newObject <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewPool</span><span class="token punctuation">(</span>newFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">*</span>pool <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pool<span class="token punctuation">{</span>
		mutex<span class="token punctuation">:</span>     <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		idle<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		active<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		newObject<span class="token punctuation">:</span> newFunc<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>pool<span class="token punctuation">)</span> <span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> object <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		object <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		object <span class="token operator">=</span> p<span class="token punctuation">.</span>idle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		p<span class="token punctuation">.</span>idle <span class="token operator">=</span> p<span class="token punctuation">.</span>idle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	p<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>active<span class="token punctuation">,</span> object<span class="token punctuation">)</span>
	<span class="token keyword">return</span> object
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>pool<span class="token punctuation">)</span> <span class="token function">Release</span><span class="token punctuation">(</span>target <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	p<span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>idle<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>active <span class="token punctuation">{</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>active<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> target <span class="token punctuation">{</span>
			p<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>active<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>active<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> object_pool

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">ExamplePool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	newConnDB <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">"conn-db"</span>
	<span class="token punctuation">}</span>
	pool <span class="token operator">:=</span> <span class="token function">NewPool</span><span class="token punctuation">(</span>newConnDB<span class="token punctuation">)</span>
	object1 <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>idle<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">)</span>

	object2 <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>idle<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">)</span>

	pool<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>object1<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>idle<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">)</span>

	pool3 <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>idle<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">)</span>

	pool<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>object2<span class="token punctuation">)</span>
	pool<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>pool3<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>idle<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 0</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 0</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 0</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// 0</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>效果</h2>
<h3>使用场景</h3>
<ul>
<li>资源受限的场景，比如不需要可伸缩性的环境（CPU、内存等物理资源有限），CPU性能不够强劲，内存比较紧张，垃圾收集，内存抖动会造成比较大的影响，需要提高内存管理效率，响应性比吞吐量更为重要。</li>
<li>在内存中数量受限的对象，比如数据库连接、网络连接、线程等。</li>
<li>创建成本高的对象，比如初始化时间长、占用资源多、需要复杂的配置等。</li>
</ul>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>提升性能：减少创建和销毁对象的开销，节省内存和CPU资源，提高响应速度。</li>
<li>减少GC压力：复用对象池中的对象，避免频繁的垃圾回收，降低内存抖动和暂停时间。</li>
<li>易于实现：对象池模式相对容易实现，可用于多种情况。它是一种经过验证的设计模式，已在许多应用程序和编程语言中成功使用。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>增加依赖性：将对象返回对象池中的操作依赖于客户端，如果客户端忘记将对象返回对象池中，将导致该对象无法被其他组件使用。</li>
<li>增加复杂性：对象池模式可以通过添加额外的抽象层来增加应用程序的复杂性。这会使代码更难理解和维护，尤其是涉及到多线程和并发的场景。</li>
<li>存在脏对象问题：所谓的脏对象就是指的是当对象被放回对象池后，还保留着刚刚被客户端调用时生成的数据。脏对象可能带来两个问题：
<ul>
<li>脏对象持有上次使用的引用，导致内存泄露等问题。</li>
<li>脏对象如果下一次使用时没有做清理，可能影响程序的处理数据。</li>
</ul>
</li>
<li>生命周期问题：处于对象池中的对象生命周期要比普通的对象要长久。这可能导致一些难以预料的问题，比如对象状态不一致、资源占用过多等。</li>
</ul>
<h2>总结</h2>
<p>对象池模式是一种创建型设计模式，它通过预先创建和初始化一组对象，然后将它们存放在一个池中，以便在需要时重复使用。这样可以减少频繁创建和销毁对象的开销，提高应用程序的性能和效率。在使用对象池设计模式时，需要注意：</p>
<ul>
<li>对象池的大小应该根据实际需求和资源情况来确定，不要过大或过小。</li>
<li>对象池中的对象应该是无状态或者可重置状态的，以避免状态污染和数据不一致。</li>
<li>对象池中的对象应该是线程安全或者线程隔离的，以避免并发问题和竞争条件。</li>
<li>对象池中的对象应该在使用完毕后及时归还，以避免资源泄露和浪费。</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>原型</title>
      <link>http://blog.cjhe.top/design-pattern/creational/prototype.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/prototype.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">原型</source>
      <description>prototypeprototype</description>
      <category>设计模式</category>
      <pubDate>Sun, 16 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/prototype/prototype-2x.png" alt="prototype" tabindex="0" loading="lazy"><figcaption>prototype</figcaption></figure>
<!-- more -->
<p>原型模式(Prototype Pattern)用一个已经创建的实例作为原型，通过复制该原型对象来创建一个和原型相同或相似的新对象。它的核心思想是通过复制一个已经存在的<strong>对象</strong>来创建新的<strong>对象</strong>，而不是通过调用构造函数或者其他初始化方法。这样可以避免一些复杂的或者耗时的对象创建过程，提高程序的效率和灵活性。</p>
<h2>问题</h2>
<p>当程序中需要大量对象，创建这些对象将导致占用大量的内存，非常耗时。</p>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>prototype</figcaption></figure>
<ul>
<li>
<p>Prototype：抽象原型</p>
<p>抽象原型规定了clone()接口来复制新的对象</p>
</li>
<li>
<p>ConcretePrototype：具体原型</p>
<p>具体原型实现抽象原型的clone()方法，是可被复制的对象</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> prototype

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> inode <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> inode
<span class="token punctuation">}</span>

<span class="token keyword">type</span> file <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>file<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span>indentation <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>indentation <span class="token operator">+</span> f<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>file<span class="token punctuation">)</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> inode <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>file<span class="token punctuation">{</span>name<span class="token punctuation">:</span> f<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"_clone"</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> folder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	children <span class="token punctuation">[</span><span class="token punctuation">]</span>inode
	name     <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>folder<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span>indentation <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>indentation <span class="token operator">+</span> f<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>children <span class="token punctuation">{</span>
		i<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>indentation <span class="token operator">+</span> indentation<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>folder<span class="token punctuation">)</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> inode <span class="token punctuation">{</span>
	cloneFolder <span class="token operator">:=</span> <span class="token operator">&amp;</span>folder<span class="token punctuation">{</span>name<span class="token punctuation">:</span> f<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"_clone"</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> tempChildren <span class="token punctuation">[</span><span class="token punctuation">]</span>inode
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>children <span class="token punctuation">{</span>
		<span class="token builtin">copy</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		tempChildren <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>tempChildren<span class="token punctuation">,</span> <span class="token builtin">copy</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	cloneFolder<span class="token punctuation">.</span>children <span class="token operator">=</span> tempChildren
	<span class="token keyword">return</span> cloneFolder
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> prototype

<span class="token keyword">func</span> <span class="token function">ExampleFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	file1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>file<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"file1"</span><span class="token punctuation">}</span>
	cloneFile <span class="token operator">:=</span> file1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cloneFile<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"example_"</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// example_file1_clone</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleFolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	file1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>file<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"file1"</span><span class="token punctuation">}</span>
	file2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>file<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"file2"</span><span class="token punctuation">}</span>
	file3 <span class="token operator">:=</span> <span class="token operator">&amp;</span>file<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">"file3"</span><span class="token punctuation">}</span>
	folder1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>folder<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span>     <span class="token string">"folder1"</span><span class="token punctuation">,</span>
		children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>inode<span class="token punctuation">{</span>file1<span class="token punctuation">,</span> file2<span class="token punctuation">,</span> file3<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	cloneFolder <span class="token operator">:=</span> folder1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cloneFolder<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"example_"</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// example_folder1_clone</span>
	<span class="token comment">// example_example_file1_clone</span>
	<span class="token comment">// example_example_file2_clone</span>
	<span class="token comment">// example_example_file3_clone</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>效果</h2>
<h3>应用场景</h3>
<ul>
<li>当对象创建过程很复杂或者很耗时时，可以通过复制一个已经存在的对象来简化和加快对象创建过程。</li>
<li>当需要生成大量相同或者相似的对象时，可以通过复制一个原型对象来减少内存消耗和提高性能。</li>
<li>当需要根据不同的需求和环境来动态地生成对象时，可以通过选择不同的原型对象来实现多态性和灵活性。</li>
</ul>
<p>例如：</p>
<p>游戏中的子弹，通常数量规模很大，通过原型设计模式可以复制已经创建好的字段对象，这样可以节省内存和性能。</p>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>可以避免重复的对象创建过程，节省时间和资源。</li>
<li>可以动态地生成对象，根据不同的需求和环境来选择合适的原型。</li>
<li>可以隐藏对象创建的细节，降低代码的耦合度和依赖性。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>需要实现克隆方法，可能会增加代码的复杂度和维护成本。</li>
<li>需要注意深拷贝和浅拷贝的区别，避免出现意外的副作用和错误。</li>
<li>需要保证原型对象的稳定性和安全性，避免被修改或者破坏。</li>
</ul>
<h2>总结</h2>
<p>原型设计模式是一种创建型设计模式，它通过复制一个已经存在的对象来创建新的对象，而不是通过调用构造函数或者其他初始化方法。
在Go语言中，我们还需要注意深拷贝和浅拷贝的区别：
深拷贝是指完全复制一个对象及其所有关联的对象，使得新对象和旧对象完全独立。
浅拷贝是指只复制一个对象本身，而不复制其关联的对象，使得新对象和旧对象共享部分数据。</p>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/prototype/prototype-2x.png" type="image/png"/>
    </item>
    <item>
      <title>简单工厂</title>
      <link>http://blog.cjhe.top/design-pattern/creational/simple-factory.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/simple-factory.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">简单工厂</source>
      <description>简单工厂模式(Simple Factory Pattern)又称为静态工厂方法(Static Factory Method)模式 提示 它可以根据参数的不同，返回不同类的实例，而无需让客户端知道具体的创建细节。</description>
      <category>设计模式</category>
      <pubDate>Sat, 15 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>简单工厂模式(Simple Factory Pattern)又称为静态工厂方法(Static Factory Method)模式</p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>它可以根据参数的不同，返回不同类的实例，而无需让客户端知道具体的创建细节。</p>
</div>
<!-- more -->
<h2>问题</h2>
<p>假设，现在工厂生产：木门、铁门、玻璃门这三种门，在订购时我们期望只需要告诉工厂材料名称，工厂就给我们生产相应的门。</p>
<p>简单设计模式解决的问题就是：客户端期望根据请求的类型创建相应的对象，客户端不关注对象常见的细节，由工厂负责类型匹配和对象创建逻辑。</p>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>simple-factory</figcaption></figure>
<ul>
<li>
<p>SimpleFactory：简单工厂</p>
<p>简单工厂根据参数的不同创建并返回不同的产品实例。</p>
</li>
<li>
<p>Product：抽象产品</p>
<p>抽象产品负责描述所有实例所共有的公共接口。</p>
</li>
<li>
<p>ConcreteProduct：具体产品</p>
<p>具体产品实现产品的具体行为。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> simple_factory

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token comment">// 抽象产品</span>
<span class="token keyword">type</span> Product <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Product1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token boolean">iota</span>
	Product2
<span class="token punctuation">)</span>

<span class="token comment">// 工厂</span>
<span class="token keyword">type</span> SimpleFactory <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>SimpleFactory<span class="token punctuation">)</span> <span class="token function">NewProduct</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> Product <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> i <span class="token punctuation">{</span>
	<span class="token keyword">case</span> Product1<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct1<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">case</span> Product2<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcreteProduct2<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品1</span>
<span class="token keyword">type</span> ConcreteProduct1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct1<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product1 show"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体产品2</span>
<span class="token keyword">type</span> ConcreteProduct2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>ConcreteProduct2<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Product2 show"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例：只需要传入产品的参数，就可以获得该产品</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> simple_factory

<span class="token keyword">func</span> <span class="token function">ExampleSimpleFactory_NewProduct1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	factory <span class="token operator">:=</span> SimpleFactory<span class="token punctuation">{</span><span class="token punctuation">}</span>
	product <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct</span><span class="token punctuation">(</span>Product1<span class="token punctuation">)</span>
	product<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Product1 show</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleSimpleFactory_NewProduct2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	factory <span class="token operator">:=</span> SimpleFactory<span class="token punctuation">{</span><span class="token punctuation">}</span>
	product <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">NewProduct</span><span class="token punctuation">(</span>Product2<span class="token punctuation">)</span>
	product<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// Product2 show</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>效果</h2>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>实现了对象的创建和使用分离，降低了系统的耦合性。</li>
<li>通过该模式，实现了对责任的分配，提高了系统的灵活性和可维护性。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>扩展性差，如果要增加新的产品类，就需要修改工厂类的代码，违背了<strong>开闭</strong>原则</li>
<li>由于使用了静态工厂方法，造成工厂角色无法形成基于继承的结构</li>
<li>如果产品种类较多，工厂方法的代码将会非常复杂</li>
</ul>
<h3>应用场景</h3>
<ul>
<li>创建对象少：工厂类负责创建的对象比较少。</li>
<li>不关心创建过程：客户端只知道传入工厂类的参数，对于如何创建对象不关心。</li>
</ul>
<p>例如：</p>
<ul>
<li>对于<strong>门</strong>这个产品，我们只需要给定的<strong>材料</strong>参数，工厂就会给我们创建<code>木门</code>、<code>铁门</code>、<code>玻璃门</code>等等。</li>
</ul>
<h2>总结</h2>
<p>简单工厂设计模式是一种创建型设计模式，它可以根据参数的不同，返回不同类的实例，而无需让客户端知道具体的创建细节。简单工厂设计模式有利于实现对象的创建和使用分离，降低了系统的耦合性，提高了系统的灵活性和可维护性。
但是简单工厂设计模式也有缺点，首先，它扩展性差，如果要增加新的产品类，就需要修改工厂类的代码，违背了<code>开闭原则</code>。其次，工厂类的职责过重，如果产品种类较多，工厂方法的代码将会非常复杂。因此，简单工厂设计模式适用于创建对象少且不关心创建过程的场景。</p>
]]></content:encoded>
    </item>
    <item>
      <title>单例</title>
      <link>http://blog.cjhe.top/design-pattern/creational/singleton.html</link>
      <guid>http://blog.cjhe.top/design-pattern/creational/singleton.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">单例</source>
      <description>singletonsingleton</description>
      <category>设计模式</category>
      <pubDate>Mon, 17 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/singleton/singleton-2x.png" alt="singleton" tabindex="0" loading="lazy"><figcaption>singleton</figcaption></figure>
<!-- more -->
<p>单例模式(Singleton Pattern)指一个类只允许创建一个对象或者实例，那这个类就是一个单例类，这种设计模式就叫做单例设计模式。</p>
<h2>问题</h2>
<p>开发过程中常常遇见需要一个对象实例，统一处理相关事宜，多个实例可能会导致不一致问题。例如：日志客户端，多个日志客户端可能会导致文件日志内容被覆盖、被插入问题。</p>
<h2>解决方案</h2>
<h3>角色</h3>
<figure><figcaption>singleton</figcaption></figure>
<ul>
<li>
<p>Singleton：单例类</p>
<p>单例类提供getInstance方法获取实例</p>
</li>
</ul>
<h3>类别</h3>
<p>单例模式从实现上分为两种：饿汉模式和懒汉模式</p>
<h4>饿汉模式</h4>
<p>类加载时，instance静态实例就已经创建并初始化好了
好处在于：对于耗时较高的初始化操作，提前到程序启动的时候完成，这样就能避免在程序运行的时候，再去初始化导致的性能问题。如果初始化有问题，基于fail-fast的设计原则（有问题及早暴露），而不是等待使用的时候才反馈问题会更好。</p>
<h4>懒汉模式</h4>
<p>程序需要某个变量的时候才会去初始化
缺点在于：需要增加一把锁，导致并发度低。频繁的使用，也会频繁的加锁、释放锁，可能导致性能瓶颈。通常我们会采用双重检测，一旦instance创建之后就不再加锁。</p>
<h3>特点</h3>
<ul>
<li>单例类只有一个实例对象；</li>
<li>该单例对象必须由单例类自行创建；</li>
<li>单例类对外提供一个访问该单例的全局访问点；</li>
</ul>
<h2>效果</h2>
<h3>应用场景</h3>
<ul>
<li>配置文件实例--通常我们在应用运行期间，只使用一个配置文件实例；</li>
<li>DB实例--我们只想创建DB对象的一个实例，并且该实例将在整个应用程序中使用；</li>
<li>日志实例--同样，只应创建一个日志实例，并应在整个应用程序中使用它；</li>
</ul>
<h3>优缺点</h3>
<h4>优点</h4>
<ul>
<li>可以减少内存开销，提高程序的运行效率，避免对资源的过多占用，方便定位问题</li>
</ul>
<h4>缺点</h4>
<ul>
<li>不能被继承，很难进行类的扩展，违背了<code>单一职责</code>原则，忽略了外部关系，不适用于变化对象，可能存在线程安全问题</li>
</ul>
<h2>代码示例</h2>
<p>Go语言创建单例的办法</p>
<ul>
<li>Sync.Mutex方式，在GetInstance方法中加锁（懒汉方式）</li>
<li>init()函数方式，引入singleton包时进行初始化（饿汉方式）</li>
<li>sync.Once方式，在GetInstance方法中调用once.Do方法</li>
</ul>
<h3>Sync.Mutex 方式</h3>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> lock <span class="token operator">=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>RWMutex<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> single1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> singleInstance1 <span class="token operator">*</span>single1

<span class="token keyword">func</span> <span class="token function">GetInstance1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>single1 <span class="token punctuation">{</span>
	<span class="token keyword">if</span> singleInstance1 <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> singleInstance1 <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Creating Single Instance Now"</span><span class="token punctuation">)</span>
			singleInstance1 <span class="token operator">=</span> <span class="token operator">&amp;</span>single1<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Single Instance already created-1"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Single Instance already created-2"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> singleInstance1
<span class="token punctuation">}</span>
</code></pre></div><p>其中：</p>
<ul>
<li>18行再次判断的原因是：如果多个goroutine通过第一次检查（15行），其中一个goroutine获得锁并初始化了instance示例，那么剩余的goroutine就不必在获得锁之后再去初始化实例了。</li>
</ul>
<p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"sync"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestGetInstance1</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">GetInstance1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过atomic保证原子性也是可行的方案</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"sync/atomic"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> single4 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> rwlock <span class="token operator">=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> singleInstance4 <span class="token operator">*</span>single4
<span class="token keyword">var</span> flag <span class="token builtin">uint32</span>

<span class="token keyword">func</span> <span class="token function">GetInstance4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>single4 <span class="token punctuation">{</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		rwlock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> rwlock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Creating Single Instance Now"</span><span class="token punctuation">)</span>
			singleInstance4 <span class="token operator">=</span> <span class="token operator">&amp;</span>single4<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">StoreUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Single Instance already created-1"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Single Instance already created-2"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> singleInstance4
<span class="token punctuation">}</span>
</code></pre></div><h3>init() 函数方式</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">type</span> single2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> singleInstance2 <span class="token operator">*</span>single2

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	singleInstance2 <span class="token operator">=</span> <span class="token operator">&amp;</span>single2<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetInstance2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>single2 <span class="token punctuation">{</span>
	<span class="token keyword">return</span> singleInstance2
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestGetInstance2</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			instance2 <span class="token operator">:=</span> <span class="token function">GetInstance2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"get single instance address %p and is nil? %t\n"</span><span class="token punctuation">,</span> instance2<span class="token punctuation">,</span> instance2 <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>sync.Once 方式</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once

<span class="token keyword">type</span> single3 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> singleInstance3 <span class="token operator">*</span>single3

<span class="token keyword">func</span> <span class="token function">GetInstance3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>single3 <span class="token punctuation">{</span>
	<span class="token keyword">if</span> singleInstance3 <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>
			<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Creating Single Instance Now"</span><span class="token punctuation">)</span>
				singleInstance3 <span class="token operator">=</span> <span class="token operator">&amp;</span>single3<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Single Instance already created-2"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> singleInstance3
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> singleton

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"sync"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestGetInstance3</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">GetInstance3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/singleton/singleton-2x.png" type="image/png"/>
    </item>
    <item>
      <title>选项模式</title>
      <link>http://blog.cjhe.top/design-pattern/function/option.html</link>
      <guid>http://blog.cjhe.top/design-pattern/function/option.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">选项模式</source>
      <description>提示 由于Go语言不支持重载函数，当我们需要使用不同的方式构建对象时，不得不使用多个构造函数进行初始化。 对于多参数的类的初始化遇到哪些困境？ 例如：HTTP Server的初始化 为了支持不同功能的Server，我们不得不通过不同的函数命名和参数，构造初始化函数。 一圈写下来，发现这仅不禁无法列举所有的功能场景，而且代码冗余非常多。 那么Option...</description>
      <category>设计模式</category>
      <pubDate>Sun, 06 Aug 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>由于Go语言不支持重载函数，当我们需要使用不同的方式构建对象时，不得不使用多个构造函数进行初始化。</p>
</div>
<h2>对于多参数的类的初始化遇到哪些困境？</h2>
<p>例如：HTTP Server的初始化</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Server <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Addr     <span class="token builtin">string</span>
	Port     <span class="token builtin">int</span>
	Protocol <span class="token builtin">string</span>
	Timeout  time<span class="token punctuation">.</span>Duration
	MaxConns <span class="token builtin">int</span>
	TLS      <span class="token operator">*</span>tls<span class="token punctuation">.</span>Config
<span class="token punctuation">}</span>
</code></pre></div><p>为了支持不同功能的Server，我们不得不通过不同的函数命名和参数，构造初始化函数。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// NewTLSServer 带TLS的初始化函数</span>
<span class="token keyword">func</span> <span class="token function">NewTLSServer</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> port <span class="token builtin">int</span><span class="token punctuation">,</span> tls <span class="token operator">*</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>     addr<span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span>     port<span class="token punctuation">,</span>
		Protocol<span class="token punctuation">:</span> <span class="token string">"tcp"</span><span class="token punctuation">,</span>
		Timeout<span class="token punctuation">:</span>  time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
		MaxConns<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
		TLS<span class="token punctuation">:</span>      tls<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewServerWithTimeout 带超时时间的初始化函数</span>
<span class="token keyword">func</span> <span class="token function">NewServerWithTimeout</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> port <span class="token builtin">int</span><span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>     addr<span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span>     port<span class="token punctuation">,</span>
		Protocol<span class="token punctuation">:</span> <span class="token string">"tcp"</span><span class="token punctuation">,</span>
		Timeout<span class="token punctuation">:</span>  timeout<span class="token punctuation">,</span>
		MaxConns<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
		TLS<span class="token punctuation">:</span>      <span class="token boolean">nil</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewTLSServerWithMaxConnAndTimeout 支持TLS和最大连接数和超时时间的初始化函数</span>
<span class="token keyword">func</span> <span class="token function">NewTLSServerWithMaxConnAndTimeout</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> port <span class="token builtin">int</span><span class="token punctuation">,</span> maxconns <span class="token builtin">int</span><span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> tls <span class="token operator">*</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>     addr<span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span>     port<span class="token punctuation">,</span>
		Protocol<span class="token punctuation">:</span> <span class="token string">"tcp"</span><span class="token punctuation">,</span>
		Timeout<span class="token punctuation">:</span>  timeout<span class="token punctuation">,</span>
		MaxConns<span class="token punctuation">:</span> maxconns<span class="token punctuation">,</span>
		TLS<span class="token punctuation">:</span>      tls<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一圈写下来，发现这仅不禁无法列举所有的功能场景，而且代码冗余非常多。</p>
<h2>那么Option(选项模式)是如何解决这个问题的呢？</h2>
<h3>首先：定义一个Option函数，参数为Server指针</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">)</span>
</code></pre></div><p>如果关注错误的话，可以定义如下</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre></div><h3>其次：定义各种初始化选项函数，通常返回上文定义的Option</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">WithProtocol</span><span class="token punctuation">(</span>protocol <span class="token builtin">string</span><span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>Protocol <span class="token operator">=</span> protocol
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> timeout
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithMaxConns</span><span class="token punctuation">(</span>maxconns <span class="token builtin">int</span><span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>MaxConns <span class="token operator">=</span> maxconns
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WihtTLS</span><span class="token punctuation">(</span>tls <span class="token operator">*</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>TLS <span class="token operator">=</span> tls
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>通常：我们定义一个全局的初始化函数，使用Go语言可变参数Option</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> port <span class="token builtin">int</span><span class="token punctuation">,</span> options <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	srv <span class="token operator">:=</span> Server<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>     addr<span class="token punctuation">,</span>
		Port<span class="token punctuation">:</span>     port<span class="token punctuation">,</span>
		Protocol<span class="token punctuation">:</span> <span class="token string">"tcp"</span><span class="token punctuation">,</span>
		Timeout<span class="token punctuation">:</span>  time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
		MaxConns<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
		TLS<span class="token punctuation">:</span>      <span class="token boolean">nil</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> option <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span>
		<span class="token function">option</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srv<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//...</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>srv<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>最后，我们看看最终效果</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>s1<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment">//默认的Server</span>
s2<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token function">WithProtocol</span><span class="token punctuation">(</span><span class="token string">"udp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//协议为udp的Server</span>
s3<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">WithMaxConns</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//支持超时时间和最大连接的Server</span>
</code></pre></div><h2>总结</h2>
<p>由于Go语言函数不支持重载，因此在多参数的类的初始化中，我们遇到初始化函数冗余问题，
我们可以通过Option(选项模式)，可以很自由的定义类的初始化，解决前面遇到的问题。</p>
<p>这里本质上使用了Go语言以下特点：</p>
<ul>
<li>闭包，<code>With...</code>等Option的定义，通过闭包的方式，扩展了Option的场景;</li>
<li>可变参数，<code>(options ...option)</code>，通过可变参数，我们可以自由选择Option;</li>
</ul>
<h2>参考链接</h2>
<p><a href="https://coolshell.cn/articles/21146.html" target="_blank" rel="noopener noreferrer">GO 编程模式：FUNCTIONAL OPTIONS</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>适配器</title>
      <link>http://blog.cjhe.top/design-pattern/structural/adapter.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/adapter.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">适配器</source>
      <description>adapteradapter</description>
      <category>设计模式</category>
      <pubDate>Tue, 18 Oct 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/adapter/adapter-zh-2x.png" alt="adapter" tabindex="0" loading="lazy"><figcaption>adapter</figcaption></figure>
<!-- more -->
<h2>什么是适配器模式</h2>
<p>适配器模式(Adapter Pattern)：它将一个接口转换成用户期望的另一个接口，使的接口不兼容的那些类可以相互合作。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>适配器</figcaption></figure>
<ul>
<li>
<p>Target: 目标角色</p>
<p>该角色定义是用户期望的接口</p>
</li>
<li>
<p>Adapter: 适配器角色</p>
<p>将适配者的接口转换为目标接口的类，它是适配器模式的核心</p>
</li>
<li>
<p>Adaptee: 适配者</p>
<p>需要被适配的接口，它与目标角色接口不一致</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> adapter

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token comment">// Target是适配的目标接口</span>
<span class="token keyword">type</span> Target <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Adaptee是被适配的目标接口</span>
<span class="token keyword">type</span> Adaptee <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">SpecificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// AdapteeImpl是被适配的目标类</span>
<span class="token keyword">type</span> AdapteeImpl <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>impl <span class="token operator">*</span>AdapteeImpl<span class="token punctuation">)</span> <span class="token function">SpecificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"adapteeImpl SpecificRequest"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewAdaptee是被适配接口的工厂函数</span>
<span class="token keyword">func</span> <span class="token function">NewAdaptee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Adaptee <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AdapteeImpl<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Adapter是转换Adaptee为Target接口的适配器</span>
<span class="token keyword">type</span> Adapter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Adaptee
<span class="token punctuation">}</span>

<span class="token comment">// Adapter适配器实现目标接口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a Adapter<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">.</span><span class="token function">SpecificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewAdapter是Adapter的工厂函数，将Adaptee转化为Target</span>
<span class="token keyword">func</span> <span class="token function">NewAdapter</span><span class="token punctuation">(</span>adaptee Adaptee<span class="token punctuation">)</span> Target <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Adapter<span class="token punctuation">{</span>Adaptee<span class="token punctuation">:</span> adaptee<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> adapter

<span class="token keyword">func</span> <span class="token function">ExampleRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	adaptee <span class="token operator">:=</span> <span class="token function">NewAdaptee</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	target <span class="token operator">:=</span> <span class="token function">NewAdapter</span><span class="token punctuation">(</span>adaptee<span class="token punctuation">)</span>
	target<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// adapteeImpl SpecificRequest</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>应用场景</h3>
<ul>
<li>当我们想要使用一个已经存在的类，但是它的接口不符合我们的需求时，我们可以使用适配器来转换接口，而不需要修改原来的类。</li>
<li>当我们想要复用一些已有的功能，但是这些功能来自于不同的系统或者库时，我们可以使用适配器来统一接口，而不需要修改原来的系统或者库。</li>
<li>当我们想要在不同的环境中使用同一个类时，我们可以使用适配器来适应不同的环境，而不需要修改原来的类。</li>
</ul>
<h3>有哪些优缺点</h3>
<h4>优点</h4>
<ul>
<li>提高代码的重用性：适配器设计模式可以将已经存在的代码与新的代码进行整合，提高了现有代码的重用率。</li>
<li>可以让不兼容的代码协同工作：适配器设计模式可以将一个类的接口转换成另一个类的接口，让其它不兼容的代码可以一起工作。</li>
<li>保证系统的稳定性：适配器设计模式可以让已有的系统保持稳定，不必对其进行修改，只是增加新的功能，满足<code>开闭原则</code>。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>增加代码复杂性：适配器设计模式需要在原有的类和适配器类中定义大量的代码，会增加系统的复杂度。</li>
<li>降低代码的可读性：适配器设计模式在现有类的基础上增加了适配器类，使得代码的可读性下降。</li>
<li>新增了一个中间层，可能会影响系统的性能：适配器设计模式新增了适配器类，可能会影响系统的性能，增加系统的运行开销。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/adapter/adapter-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>桥接</title>
      <link>http://blog.cjhe.top/design-pattern/structural/bridge.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/bridge.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">桥接</source>
      <description>bridgebridge</description>
      <category>设计模式</category>
      <pubDate>Sat, 10 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/bridge/bridge-2x.png" alt="bridge" tabindex="0" loading="lazy"><figcaption>bridge</figcaption></figure>
<!-- more -->
<h2>场景问题</h2>
<p>假设你有一个几何形状类Shape，从它扩展出两个子类：圆形Cicle和方形Square，你希望对这样的类进行扩展使其包含两种颜色：Blue、Red。</p>
<figure><figcaption>bridge-question</figcaption></figure>
<p>很快你会发现，如果新增形状类，例如: 三角形，椭圆形。或者新增颜色，子类的数量将会暴躁式增长。</p>
<p>为了解决这些问题，我们可以用桥接模式来将图形的形状和颜色分离为两个层次结构，让它们可以独立地变化。</p>
<h2>什么是桥接模式</h2>
<p>桥接模式(Bridge Pattern)：是一种结构型设计模式，能将抽象与实现分离，使二者可以各自单独变化而不受对方约束，使用时再将它们组合起来，就像架设桥梁一样链接它们的功能，如此降低了抽象与实现这两个可变维度的耦合度，以保证系统的可扩展性。</p>
<p>桥接模式通过将继承改为组合的方式来解决这个问题，具体来说，就是抽取其中一个维度并使之成为独立的类层次，这样就可以在初始类中引用这个新层次的对象，从而使得一个类不必拥有所有的状态和行为。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>bridge</figcaption></figure>
<ul>
<li>
<p>Abstraction: 抽象角色</p>
<p>定义抽象类，并包含一个对实现对象的引用</p>
</li>
<li>
<p>RefinedAbstraction: 扩展抽象角色</p>
<p>抽象角色的子类，实现父类中的业务方法，并通过组合关系调用实现角色中的业务方法。</p>
</li>
<li>
<p>Implementor: 实现角色</p>
<p>定义实现类的接口，该接口不一定要与抽象角色的接口完全一致，而是根据实际情况来设计</p>
</li>
<li>
<p>ConCreteImplementor: 具体实现角色</p>
<p>实现角色接口的具体实现</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> bridge

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Implementor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">OperationImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreateImplA <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreateImplA<span class="token punctuation">)</span> <span class="token function">OperationImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateImplA"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreateImplB <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ConcreateImplB<span class="token punctuation">)</span> <span class="token function">OperationImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ConcreateImplB"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Abstraction <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RefineAbstractionA <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Impl Implementor
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ra RefineAbstractionA<span class="token punctuation">)</span> <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"RefineAbstractionA"</span><span class="token punctuation">)</span>
	ra<span class="token punctuation">.</span>Impl<span class="token punctuation">.</span><span class="token function">OperationImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RefineAbstractionB <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Impl Implementor
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ra RefineAbstractionB<span class="token punctuation">)</span> <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"RefineAbstractionB"</span><span class="token punctuation">)</span>
	ra<span class="token punctuation">.</span>Impl<span class="token punctuation">.</span><span class="token function">OperationImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> bridge

<span class="token keyword">func</span> <span class="token function">ExampleOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">:=</span> ConcreateImplA<span class="token punctuation">{</span><span class="token punctuation">}</span>
	b <span class="token operator">:=</span> ConcreateImplB<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> abstract Abstraction
	abstract <span class="token operator">=</span> RefineAbstractionA<span class="token punctuation">{</span>Impl<span class="token punctuation">:</span> a<span class="token punctuation">}</span>
	abstract<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	abstract <span class="token operator">=</span> RefineAbstractionA<span class="token punctuation">{</span>Impl<span class="token punctuation">:</span> b<span class="token punctuation">}</span>
	abstract<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	abstract <span class="token operator">=</span> RefineAbstractionB<span class="token punctuation">{</span>Impl<span class="token punctuation">:</span> a<span class="token punctuation">}</span>
	abstract<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	abstract <span class="token operator">=</span> RefineAbstractionB<span class="token punctuation">{</span>Impl<span class="token punctuation">:</span> b<span class="token punctuation">}</span>
	abstract<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// RefineAbstractionA</span>
	<span class="token comment">// ConcreateImplA</span>
	<span class="token comment">// RefineAbstractionA</span>
	<span class="token comment">// ConcreateImplB</span>
	<span class="token comment">// RefineAbstractionB</span>
	<span class="token comment">// ConcreateImplA</span>
	<span class="token comment">// RefineAbstractionB</span>
	<span class="token comment">// ConcreateImplB</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>解决场景问题</h3>
<p>回到本文前面的问题，那么我们如何使用桥接模式解决该问题呢</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> shape

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token comment">// Implementor</span>
<span class="token keyword">type</span> Color <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">GetColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Concrete Implementor</span>
<span class="token keyword">type</span> Red <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Red<span class="token punctuation">)</span> <span class="token function">GetColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">"red"</span>
<span class="token punctuation">}</span>

<span class="token comment">// Concrete Implementor</span>
<span class="token keyword">type</span> Blue <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b Blue<span class="token punctuation">)</span> <span class="token function">GetColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">"blue"</span>
<span class="token punctuation">}</span>

<span class="token comment">// Abstraction</span>
<span class="token keyword">type</span> Shape <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Refined Abstraction</span>
<span class="token keyword">type</span> Circle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	color Color <span class="token comment">//组合关系</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c Circle<span class="token punctuation">)</span> <span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">GetColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" circle"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Refined Abstraction</span>
<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	color Color <span class="token comment">//组合关系</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Square<span class="token punctuation">)</span> <span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">GetColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" square"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> shape

<span class="token keyword">func</span> <span class="token function">ExampleBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	red <span class="token operator">:=</span> Red<span class="token punctuation">{</span><span class="token punctuation">}</span>
	blue <span class="token operator">:=</span> Blue<span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token keyword">var</span> shape Shape
	shape <span class="token operator">=</span> Circle<span class="token punctuation">{</span>red<span class="token punctuation">}</span>
	shape<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	shape <span class="token operator">=</span> Circle<span class="token punctuation">{</span>blue<span class="token punctuation">}</span>
	shape<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	shape <span class="token operator">=</span> Square<span class="token punctuation">{</span>red<span class="token punctuation">}</span>
	shape<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	shape <span class="token operator">=</span> Square<span class="token punctuation">{</span>blue<span class="token punctuation">}</span>
	shape<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// red circle</span>
	<span class="token comment">// blue circle</span>
	<span class="token comment">// red square</span>
	<span class="token comment">// blue square</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>有哪些优缺点</h3>
<h4>优点</h4>
<ul>
<li>实现了抽象和实现部分的分离，从而极大地提高了系统的灵活性，让抽象部分和实现部分独立开来，这有助于系统进行分层设计，从而产生更好的结构化系统。</li>
<li>符合开闭原则，抽象部分和实现部分可以分别独立地扩展，而不会相互影响，对系统的修改是通过增加代码进行的，而不是修改原有代码。</li>
<li>符合合成复用原则，可以使用不同的实现部分来组合不同的抽象部分，实现更多的功能组合。</li>
<li>其实现细节对客户透明，客户只需要关心抽象部分的接口，不用了解具体的实现细节。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>增加了系统的理解和设计难度，由于关联关系建立在抽象层，要求开发者一开始就针对抽象层进行设计和编程，能正确地识别出系统中两个独立变化的维度，这增加了系统的复杂性和学习成本。</li>
<li>要求正确识别出系统中两个独立变化的维度，因此其使用范围有一定的局限性，如果系统中只有一个变化维度或者两个变化维度之间有很强的耦合关系，那么桥接模式就不适用了。</li>
</ul>
<h2>总结</h2>
<h3>桥接设计模式和适配器设计模式的区别</h3>
<p>适配器模式是为了复用已有接口的功能，而通过适配将已有接口功能引入到所需接口的一种模式，目的是能够结合。适配器是先定义了新接口，然后才与旧接口进行适配，即先接口后关系。</p>
<p>桥接模式是在一个系统中解决多个维度独立变化的类之间的耦合度问题，先定义了一个桥（即实现和抽象的关系），通过多个实现的不同组合达到其灵活性的目的，即先关系后组合。</p>
<ul>
<li>
<p>适配器模式中适配器角色只需要一个，解决两个接口适配问题。</p>
</li>
<li>
<p>桥接模式中扩展抽象角色通常有多个，解决抽象和实现组合爆炸问题。</p>
</li>
<li>
<p>适配器模式中适配者通常只有一个。</p>
</li>
<li>
<p>桥接模式中具体抽象和实现的关系可以有多个，使得多个维度独立变化。</p>
</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/bridge/bridge-2x.png" type="image/png"/>
    </item>
    <item>
      <title>组合</title>
      <link>http://blog.cjhe.top/design-pattern/structural/composite.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/composite.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">组合</source>
      <description>compositecomposite</description>
      <category>设计模式</category>
      <pubDate>Sat, 03 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/composite/composite-2x.png" alt="composite" tabindex="0" loading="lazy"><figcaption>composite</figcaption></figure>
<!-- more -->
<h2>某一场景问题</h2>
<p>例如：有两类对象：<code>产品</code>和<code>盒子</code>，<code>盒子</code>中可以包含多个<code>产品</code>或者小<code>盒子</code>，在此基础需要知道这个盒子的总价格，如果直接打开所有的盒子，累加产品的价值，虽然可行。但对计算机会增加许多繁杂的细节。</p>
<p>那么使用组合模式，就可以很好的简化这个细节，如果是<code>产品</code>就直接返回价格，如果是<code>盒子</code>，则遍历盒子中的所有项目，累加价格。最大的优点，<code>产品</code>和<code>盒子</code>提供一致的接口，你无需了解内部结构，只需要调用这一个接口即可。</p>
<h2>什么是组合模式</h2>
<p>组合模式（Composite Pattern）：是针对由多个节点对象（部分）组成的树形结构的对象（整体）而发展出的一种结构型设计模式，它能够使客户端在操作整体对象或者其下的每个节点对象时做出统一的响应，保证树形结构对象使用方法的一致性。使客户端不必关注对象的整体或部分，最终达到对象复杂的层次结构与客户端解耦的目的。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>composite</figcaption></figure>
<ul>
<li>
<p>Component: 抽象构件角色</p>
<p>它的主要作用是为树叶构件和树枝构件声明公共接口</p>
</li>
<li>
<p>Leaf: 树叶构件角色</p>
<p>组合模式中的叶节点对象，它没有子节点</p>
</li>
<li>
<p>Composite: 树枝构件角色</p>
<p>是组合模式中的分支节点对象，它与子节点。</p>
</li>
</ul>
<h3>有哪些分类</h3>
<p>(1) 透明方式：在该方式中，由于抽象构件声明了所有子类中的全部方法，所以客户端无须区别树叶对象和树枝对象，对客户端来说是透明的。但其缺点是：树叶构件本来没有 Add()、Remove() 及 GetChild() 方法，却要实现它们（空实现或抛异常），这样会带来一些安全性问题。</p>
<p>(2) 安全方式：在该方式中，将管理子构件的方法移到树枝构件中，抽象构件和树叶构件没有对子对象的管理方法，这样就避免了上一种方式的安全性问题，但由于叶子和分支有不同的接口，客户端在调用时要知道树叶对象和树枝对象的存在，所以失去了透明性。</p>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> composite

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Component <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Leaf <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Leaf<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"leaf execute"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Composite <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	children <span class="token punctuation">[</span><span class="token punctuation">]</span>Component
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>composite <span class="token operator">*</span>Composite<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> composite<span class="token punctuation">.</span>children <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>composite <span class="token operator">*</span>Composite<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>c Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	composite<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>composite<span class="token punctuation">.</span>children<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>composite <span class="token operator">*</span>Composite<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>c Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">switch</span> c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>Leaf<span class="token punctuation">:</span>
		children <span class="token operator">:=</span> composite<span class="token punctuation">.</span>children
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> children <span class="token punctuation">{</span>
			<span class="token keyword">if</span> value<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Leaf<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">if</span> value <span class="token operator">==</span> c <span class="token punctuation">{</span>
					flag <span class="token operator">=</span> <span class="token boolean">true</span>
					<span class="token keyword">switch</span> i <span class="token punctuation">{</span>
					<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>
						composite<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
					<span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
						composite<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
					<span class="token keyword">default</span><span class="token punctuation">:</span>
						composite<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>Composite<span class="token punctuation">:</span>
		children <span class="token operator">:=</span> composite<span class="token punctuation">.</span>children
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> children <span class="token punctuation">{</span>
			<span class="token keyword">if</span> value<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Composite<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">if</span> value <span class="token operator">==</span> c <span class="token punctuation">{</span>
					flag <span class="token operator">=</span> <span class="token boolean">true</span>
					<span class="token keyword">switch</span> i <span class="token punctuation">{</span>
					<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>
						composite<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
					<span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
						composite<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
					<span class="token keyword">default</span><span class="token punctuation">:</span>
						composite<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>flag <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"not found"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>composite <span class="token operator">*</span>Composite<span class="token punctuation">)</span> <span class="token function">GetChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Component <span class="token punctuation">{</span>
	<span class="token keyword">return</span> composite<span class="token punctuation">.</span>children
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> composite

<span class="token keyword">func</span> <span class="token function">ExampleLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> c Component
	l <span class="token operator">:=</span> Leaf<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c <span class="token operator">=</span> <span class="token operator">&amp;</span>l
	c<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// leaf execute</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleComposite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> c Component
	composite <span class="token operator">:=</span> <span class="token operator">&amp;</span>Composite<span class="token punctuation">{</span>
		children<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Component<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	composite<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Leaf<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	composite<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Leaf<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	c <span class="token operator">=</span> composite
	c<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// leaf execute</span>
	<span class="token comment">// leaf execute</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>组合模式使得客户端代码可以一致地处理单个对象和组合对象，无须关心自己处理的是单个对象，还是组合对象，这简化了客户端代码；</li>
<li>更容易在组合体内加入新的对象，客户端不会因为加入了新的对象而更改源代码，满足<strong>开闭原则</strong>；</li>
<li>组合模式适用于递归结构，使得代码的实现变得更加简单；</li>
</ul>
<h3>缺点</h3>
<ul>
<li>递归结构限制：递归结构对于计算机的性能来说是一种挑战，如果组合对象的结构过于复杂，这将会影响程序的性能和可维护性；</li>
<li>接口实现复杂：组合对象必须实现单个对象的所有方法。在组合对象中实现与单个对象相同的方法可能会导致代码冗余；</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/composite/composite-2x.png" type="image/png"/>
    </item>
    <item>
      <title>装饰器</title>
      <link>http://blog.cjhe.top/design-pattern/structural/decorator.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/decorator.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">装饰器</source>
      <description>decoratordecorator</description>
      <category>设计模式</category>
      <pubDate>Sun, 04 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/decorator/decorator-2x.png" alt="decorator" tabindex="0" loading="lazy"><figcaption>decorator</figcaption></figure>
<!-- more -->
<h2>什么是装饰器模式</h2>
<p>装饰器模式(Decorator Pattern)：它可以在不改变原有对象的结构和功能的情况下，动态地给对象添加新的功能或者增强原有功能。装饰器设计模式的核心思想是使用一个装饰器对象来包装原有对象，从而实现对原有对象的功能扩展或修改。</p>
<p>装饰器非常类似于<strong>继承</strong>，它们都是为了增强原始对象的功能，区别在于方式的不同，后者是在编译时(compile-time)静态地通过对原始类的继承完成，而前者则是在程序运行时(run-time)通过对原始对象地<strong>包装</strong>完成。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>decorator</figcaption></figure>
<ul>
<li>
<p>Component: 组件接口</p>
<p>所有被装饰组件及装饰器对应的接口标准</p>
</li>
<li>
<p>ConcreteComponent: 具体组件</p>
<p>需要被装饰的组件，实现组件接口标准</p>
</li>
<li>
<p>Decorator: 装饰器</p>
<p>持有一个组件（Component）对象的实例，并定义一个与组件接口一致的接口。</p>
</li>
<li>
<p>ConcreteDecorator: 装饰器实现</p>
<p>继承自装饰器抽象类的具体子类装饰器，可以有多种实现，在被装饰组件对象的基础上为其添加新的特性。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> decorator

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Component <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteComponent <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteComponent<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete component execute"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Decorator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	component Component
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Decorator<span class="token punctuation">)</span> <span class="token function">Decorator</span><span class="token punctuation">(</span>c Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d<span class="token punctuation">.</span>component <span class="token operator">=</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d Decorator<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d<span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteDecortor1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Decorator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteDecortor1<span class="token punctuation">)</span> <span class="token function">addedFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete decortor1 add function"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteDecortor1<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span><span class="token function">addedFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Decorator<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteDecortor2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Decorator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteDecortor2<span class="token punctuation">)</span> <span class="token function">addedFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"concrete decortor2 add function"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c ConcreteDecortor2<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span><span class="token function">addedFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Decorator<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExampleComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> ConcreteComponent<span class="token punctuation">{</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//c1扩展c的功能</span>
	<span class="token keyword">var</span> c1 ConcreteDecortor1
	c1<span class="token punctuation">.</span>Decorator<span class="token punctuation">.</span><span class="token function">Decorator</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	c1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//c2又扩展c1的功能</span>
	<span class="token keyword">var</span> c2 ConcreteDecortor2
	c2<span class="token punctuation">.</span>Decorator<span class="token punctuation">.</span><span class="token function">Decorator</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
	c2<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// concrete component execute</span>
	<span class="token comment">// concrete decortor1 add function</span>
	<span class="token comment">// concrete component execute</span>
	<span class="token comment">// concrete decortor2 add function</span>
	<span class="token comment">// concrete decortor1 add function</span>
	<span class="token comment">// concrete component execute</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>应用场景</h3>
<ul>
<li>当需要在不改变原有对象的结构和功能的情况下，给对象添加新的功能或者增强原有功能时。</li>
<li>当需要根据不同的需求，灵活地组合不同的功能扩展或修改时。</li>
<li>当需要保持原有对象的接口不变，保证了装饰后的对象和原有对象的兼容性时。</li>
</ul>
<h3>有哪些优缺点</h3>
<h4>优点</h4>
<ul>
<li>可以在不修改原有对象的代码的情况下，给对象添加新的功能或者增强原有功能，符合开闭原则。</li>
<li>可以保持原有对象的接口不变，保证了装饰后的对象和原有对象的兼容性。</li>
<li>可以根据需要灵活地组合不同的装饰器对象，实现多种功能扩展或修改。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>会增加系统的复杂度，因为需要创建多个装饰器对象和管理它们之间的关系。</li>
<li>会增加系统的运行时开销，因为每次调用原有对象的方法时，都需要经过装饰器对象的转发和处理。</li>
</ul>
<h2>总结</h2>
<h3>装饰器设计模式和适配器设计模式</h3>
<p>装饰器模式和适配器模式的区别在于它们的应用场景和目的不同。装饰器模式可以应用于任何需要对对象进行功能扩展或修改的场景，例如日志记录、缓存、验证等。适配器模式主要应用于两个不兼容的接口之间的转换，例如不同类型的电源插头、不同格式的数据源等。</p>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/decorator/decorator-2x.png" type="image/png"/>
    </item>
    <item>
      <title>外观</title>
      <link>http://blog.cjhe.top/design-pattern/structural/facade.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/facade.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">外观</source>
      <description>facadefacade</description>
      <category>设计模式</category>
      <pubDate>Fri, 02 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/facade/facade-2x.png" alt="facade" tabindex="0" loading="lazy"><figcaption>facade</figcaption></figure>
<!-- more -->
<h2>什么是外观模式</h2>
<p>外观模式（Facade Pattern）：又叫作门面模式，是一种通过为多个复杂的子系统提供一个一致的接口，而使这些子系统更加容易被访问的模式。该模式对外有一个统一接口，外部应用程序不用关心内部子系统的具体细节，这样会大大降低应用程序的复杂度，提高了程序的可维护性。</p>
<figure><figcaption>外观</figcaption></figure>
<p>外观模式经常在我们不知不觉中使用，例如：MVC架构中，Controller层对外提供简单的接口，Controller层包含多个Service层进行功能划分，每个Service层也可能包含多个Dao层进行数据操作。</p>
<figure><figcaption>mvc</figcaption></figure>
<h3>包含哪些角色</h3>
<ul>
<li>
<p>Facade: 外观角色</p>
<p>定义一个简单的接口</p>
</li>
<li>
<p>Subsystem：子系统角色</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> facade

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Facade <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	system1 Subsystem1
	system2 Subsystem2
	system3 Subsystem3
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f Facade<span class="token punctuation">)</span> <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>system1<span class="token punctuation">.</span><span class="token function">Operation1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>system2<span class="token punctuation">.</span><span class="token function">Operation2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>system3<span class="token punctuation">.</span><span class="token function">Operation3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Subsystem1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Subsystem1<span class="token punctuation">)</span> <span class="token function">Operation1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subsystem1 operation"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Subsystem2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Subsystem2<span class="token punctuation">)</span> <span class="token function">Operation2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subsystem2 operation"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Subsystem3 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Subsystem3<span class="token punctuation">)</span> <span class="token function">Operation3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"subsystem3 operation"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> facade

<span class="token keyword">func</span> <span class="token function">ExampleOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f <span class="token operator">:=</span> Facade<span class="token punctuation">{</span>
		system1<span class="token punctuation">:</span> Subsystem1<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		system2<span class="token punctuation">:</span> Subsystem2<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		system3<span class="token punctuation">:</span> Subsystem3<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// subsystem1 operation</span>
	<span class="token comment">// subsystem2 operation</span>
	<span class="token comment">// subsystem3 operation</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<h3>优点</h3>
<ul>
<li>降低了子系统与客户端之间的耦合度，使得子系统的变化不会影响调用它的客户类。</li>
<li>对客户屏蔽了子系统组件，减少了客户处理的对象数目，并使得子系统使用起来更加容易。</li>
<li>降低了大型软件系统中的编译依赖性，简化了系统在不同平台之间的移植过程，因为编译一个子系统不会影响其他的子系统，也不会影响外观对象。</li>
<li>只是提供了一个访问子系统的统一入口，并不影响用户直接使用子系统类。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>不能很好地限制客户使用子系统类，如果对客户访问子系统类做太多的限制则减少了可变性和灵活性。</li>
<li>在不引入抽象外观类的情况下，增加新的子系统可能需要修改外观类或客户端的源代码，违背了<strong>开闭原则</strong>。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/facade/facade-2x.png" type="image/png"/>
    </item>
    <item>
      <title>享元</title>
      <link>http://blog.cjhe.top/design-pattern/structural/flyweight.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/flyweight.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">享元</source>
      <description>flyweightflyweight</description>
      <category>设计模式</category>
      <pubDate>Tue, 06 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/flyweight/flyweight-zh-2x.png" alt="flyweight" tabindex="0" loading="lazy"><figcaption>flyweight</figcaption></figure>
<!-- more -->
<h2>什么是享元模式</h2>
<p>享元模式（Flyweight Pattern）：有效地支持大量细粒度对象的复用,通过共享已经存在的对象来大幅度减少需要创建的对象数量、避免大量相似类的开销，从而提高系统资源的利用率。</p>
<p>享元对象能做到共享的关键是区分：内蕴状态（Internal State）和外蕴状态（External State），内蕴状态是存储在享元对象内部，并且不会随环境改变而改变，因此可以共享，外蕴状态是随着环境改变而改变，因此不可以共享。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>flyweight</figcaption></figure>
<ul>
<li>
<p>Flyweight: 享元接口</p>
<p>所有元件的高层规范，声明与外蕴状态互动的接口标准</p>
</li>
<li>
<p>ConcreteFlyweight: 享元实现类</p>
<p>自身维护着内蕴状态，且能接受并相应外蕴状态，可以有多个实现。一个享元对象可以被称作一个<strong>元</strong>。</p>
</li>
<li>
<p>UnsharedFlyweight: 非享元角色</p>
<p>是不可以共享的外部状态，它以参数的形式注入具体享元的相关方法中</p>
</li>
<li>
<p>FlyweightFactory: 享元工厂</p>
<p>用来维护享元对象的工厂，负责对享元对象实例进行创建于管理，并对外提供获取享元对象的服务。</p>
</li>
<li>
<p>Client: 客户端</p>
<p>享元的使用者，负责维护外蕴状态。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> flyweight

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> UnsharedFlyweight <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ExternalState <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcreteFlyweight <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	InternalState <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>concrete ConcreteFlyweight<span class="token punctuation">)</span> <span class="token function">execute</span><span class="token punctuation">(</span>unshared UnsharedFlyweight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>concrete<span class="token punctuation">.</span>InternalState<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unshared<span class="token punctuation">.</span>ExternalState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Flyweight <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>unshared UnsharedFlyweight<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> FlyweightFactory <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	flyweights <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Flyweight
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>factory FlyweightFactory<span class="token punctuation">)</span> <span class="token function">GetFlyweight</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> Flyweight <span class="token punctuation">{</span>
	<span class="token keyword">if</span> flyweight<span class="token punctuation">,</span> ok <span class="token operator">:=</span> factory<span class="token punctuation">.</span>flyweights<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> flyweight
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> flyweight

<span class="token keyword">func</span> <span class="token function">ExampleFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	factory <span class="token operator">:=</span> FlyweightFactory<span class="token punctuation">{</span>flyweights<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Flyweight<span class="token punctuation">{</span>
		<span class="token string">"a"</span><span class="token punctuation">:</span> ConcreteFlyweight<span class="token punctuation">{</span>InternalState<span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">"b"</span><span class="token punctuation">:</span> ConcreteFlyweight<span class="token punctuation">{</span>InternalState<span class="token punctuation">:</span> <span class="token string">"bb"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">"c"</span><span class="token punctuation">:</span> ConcreteFlyweight<span class="token punctuation">{</span>InternalState<span class="token punctuation">:</span> <span class="token string">"ccc"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">GetFlyweight</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
	a<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>UnsharedFlyweight<span class="token punctuation">{</span>ExternalState<span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">GetFlyweight</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>UnsharedFlyweight<span class="token punctuation">{</span>ExternalState<span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">GetFlyweight</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>UnsharedFlyweight<span class="token punctuation">{</span>ExternalState<span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// a</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// bb</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// ccc</span>
	<span class="token comment">// 3</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>总结</h2>
<p>享元模式只是一种优化。在应用该模式之前，你要确定程序中存在与大量类似对象同时占用内存相关的内存消耗问题，并且确保该问题无法使用其他更好的方式来解决。</p>
<h3>优点</h3>
<ul>
<li>享元模式的优点在于它可以极大减少内存中对象的数量，使得相同对象或相似对象在内存中只保存一份。</li>
<li>享元模式的外部状态相对独立，而且不会影响其内部状态，从而使得享元对象可以在不同的环境中被共享。</li>
</ul>
<h3>缺点</h3>
<ul>
<li>增加系统复杂性。享元模式需要维护共享对象的状态，增加了代码的复杂度，同时也增加了系统的维护难度。</li>
<li>内部状态和外部状态的区分。享元模式需要区分内部状态和外部状态，内部状态可以被共享，但外部状态必须通过参数传递，增加了对象的可定制性，但也增加了系统的复杂度。</li>
</ul>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/flyweight/flyweight-zh-2x.png" type="image/png"/>
    </item>
    <item>
      <title>代理</title>
      <link>http://blog.cjhe.top/design-pattern/structural/proxy.html</link>
      <guid>http://blog.cjhe.top/design-pattern/structural/proxy.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">代理</source>
      <description>proxyproxy</description>
      <category>设计模式</category>
      <pubDate>Sat, 10 Dec 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="https://refactoringguru.cn/images/patterns/content/proxy/proxy-2x.png" alt="proxy" tabindex="0" loading="lazy"><figcaption>proxy</figcaption></figure>
<!-- more -->
<h2>什么是代理模式</h2>
<p>代理模式(Proxy Pattern)：它的主要思想是通过一个代理对象来代替真实对象的访问，从而在不修改原目标对象的前提下，提供额外的功能操作，扩展目标对象的功能。</p>
<h3>包含哪些角色</h3>
<figure><figcaption>代理模式</figcaption></figure>
<ul>
<li>
<p>Subject: 抽象主题</p>
<p>通过接口或抽象类声明真实主题和代理对象实现的业务方法</p>
</li>
<li>
<p>RealSubject: 真实主题</p>
<p>实现了抽象主题中的具体业务，是代理对象所代表的真实对象，是最终要引用的对象</p>
</li>
<li>
<p>Proxy: 代理类</p>
<p>提供了与真实主题相同的接口，其内部包含有对真实主题的引用，它可以访问、控制或扩展真实主题的功能。</p>
</li>
</ul>
<h3>代码示例</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> proxy

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Subject <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RealSubject <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r RealSubject<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"do request"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Proxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	realSubject Subject
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">preRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"pre request"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">postRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"post request"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span><span class="token function">preRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	p<span class="token punctuation">.</span>realSubject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	p<span class="token punctuation">.</span><span class="token function">postRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用示例如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> proxy

<span class="token keyword">func</span> <span class="token function">ExampleRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> subject Subject
	subject <span class="token operator">=</span> Proxy<span class="token punctuation">{</span>realSubject<span class="token punctuation">:</span> RealSubject<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// pre request</span>
	<span class="token comment">// do request</span>
	<span class="token comment">// post request</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>使用场景</h2>
<ul>
<li>
<p>静态代理：代理对象和目标对象在编译期就已经确定，代理对象需要实现和目标对象相同的接口，并持有目标对象的引用。静态代理的优点是简单易实现，缺点是代码冗余，每个代理类都需要重新编写。</p>
</li>
<li>
<p>远程代理：为一个位于不同地址空间的对象提供一个本地的代理对象，使客户端可以通过本地代理对象来访问远程对象，屏蔽了网络通信的细节。</p>
</li>
<li>
<p>虚拟代理：当一个对象的创建或者加载时需要很长时间，可以使用虚拟代理来延迟对象的加载或者创建，直到真正需要使用该对象时再进行加载或者创建。</p>
</li>
<li>
<p>保护代理：当对一个对象的访问需要进行安全控制时，可以使用安全代理来控制对象的访问权限，例如在对象被访问时需要进行认证或授权等。</p>
</li>
<li>
<p>缓存代理：当需要缓存一些计算结果时，可以使用缓存代理，以便在后续的访问中直接返回缓存的结果，避免重复计算。</p>
</li>
<li>
<p>日志记录代理：在访问被代理对象的过程中，使用日志记录代理可以记录所有访问记录，以便于问题排查和系统优化等。</p>
</li>
</ul>
<h3>远程代理</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Subject 接口定义</span>
<span class="token keyword">type</span> Subject <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// RemoteSubject 结构体实现 Subject 接口</span>
<span class="token keyword">type</span> RemoteSubject <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    URL <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rs <span class="token operator">*</span>RemoteSubject<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token comment">// 远程调用</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Error: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    body<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Error: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Proxy 结构体实现 Subject 接口，并在内部包含了一个 RemoteSubject 对象</span>
<span class="token keyword">type</span> Proxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    subject <span class="token operator">*</span>RemoteSubject
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在此处执行一些身份验证、日志记录等操作</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>subject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>subject <span class="token operator">=</span> <span class="token operator">&amp;</span>RemoteSubject<span class="token punctuation">{</span>
            URL<span class="token punctuation">:</span> <span class="token string">"http://www.example.com"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">"Proxy -&gt; "</span> <span class="token operator">+</span> p<span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// client 代码</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> subject Subject <span class="token operator">=</span> <span class="token operator">&amp;</span>Proxy<span class="token punctuation">{</span><span class="token punctuation">}</span>
    result <span class="token operator">:=</span> subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这种方式，我们可以将客户端和远程对象之间的耦合度降低，增加了系统的可维护性和可扩展性。</p>
<h3>虚拟代理</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Image 接口定义</span>
<span class="token keyword">type</span> Image <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// RealImage 结构体实现 Image 接口</span>
<span class="token keyword">type</span> RealImage <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    filename <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ri <span class="token operator">*</span>RealImage<span class="token punctuation">)</span> <span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Displaying Real Image: "</span><span class="token punctuation">,</span> ri<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Proxy 结构体实现 Image 接口，并在内部包含了一个 RealImage 对象</span>
<span class="token keyword">type</span> Proxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    image <span class="token operator">*</span>RealImage
    filename <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用虚拟代理，在真正需要使用 RealImage 对象时才进行创建和加载</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>image <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Creating Real Image: "</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>image <span class="token operator">=</span> <span class="token operator">&amp;</span>RealImage<span class="token punctuation">{</span>
            filename<span class="token punctuation">:</span> p<span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    p<span class="token punctuation">.</span>image<span class="token punctuation">.</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// client 代码</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> image Image <span class="token operator">=</span> <span class="token operator">&amp;</span>Proxy<span class="token punctuation">{</span>
        filename<span class="token punctuation">:</span> <span class="token string">"example.jpg"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 第一次调用 Display() 方法会创建和加载 RealImage 对象</span>
    image<span class="token punctuation">.</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 第二次调用 Display() 方法直接使用已创建的 RealImage 对象</span>
    image<span class="token punctuation">.</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这种方式，我们可以延迟 RealImage 对象的加载或者创建，直到客户端真正需要访问该对象时才进行加载或者创建，从而减少了系统的资源消耗，优化了系统的性能。</p>
<h3>保护代理</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Subject 接口定义</span>
<span class="token keyword">type</span> Subject <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// RealSubject 结构体实现 Subject 接口</span>
<span class="token keyword">type</span> RealSubject <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// RealSubject 对象需要进行身份认证或者授权等安全处理</span>
    Username <span class="token builtin">string</span>
    Password <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rs <span class="token operator">*</span>RealSubject<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Request processed by Real Subject"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Proxy 结构体实现 Subject 接口，并在内部包含了一个 RealSubject 对象</span>
<span class="token keyword">type</span> Proxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    subject <span class="token operator">*</span>RealSubject
    username <span class="token builtin">string</span>
    password <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在此处执行身份认证等操作</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>password <span class="token operator">==</span> <span class="token string">"admin123"</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>subject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>subject <span class="token operator">=</span> <span class="token operator">&amp;</span>RealSubject<span class="token punctuation">{</span>
            Username<span class="token punctuation">:</span> p<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            Password<span class="token punctuation">:</span> p<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在此处执行授权等操作</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">Authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Authorization failed!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// client 代码</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> subject Subject <span class="token operator">=</span> <span class="token operator">&amp;</span>Proxy<span class="token punctuation">{</span>
        username<span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token string">"admin123"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们通过认证和授权等操作来控制对 RealSubject 对象的访问权限，只有认证和授权成功之后才能访问 RealSubject 对象，否则返回授权失败的提示消息。通过这种方式，我们可以对系统中的访问进行更加细粒度的控制，增加了系统的安全性和鲁棒性。</p>
<h3>缓存代理</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Subject 接口定义</span>
<span class="token keyword">type</span> Subject <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Request</span><span class="token punctuation">(</span>arg <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token comment">// RealSubject 结构体实现 Subject 接口</span>
<span class="token keyword">type</span> RealSubject <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rs <span class="token operator">*</span>RealSubject<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span>arg <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Processing request with argument:"</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> arg <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token comment">// Proxy 结构体实现 Subject 接口，并在内部包含了一个 RealSubject 对象和一个缓存 map</span>
<span class="token keyword">type</span> Proxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    subject <span class="token operator">*</span>RealSubject
    cache <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span>arg <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token comment">// 尝试从缓存中获取结果</span>
    res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>arg<span class="token punctuation">]</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Return cached result:"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果缓存中没有结果，则使用 RealSubject 对象进行计算</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>subject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>subject <span class="token operator">=</span> <span class="token operator">&amp;</span>RealSubject<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">=</span> p<span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
    <span class="token comment">// 将计算结果添加到缓存中，并返回结果</span>
    p<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>arg<span class="token punctuation">]</span> <span class="token operator">=</span> res
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token comment">// client 代码</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> subject Subject <span class="token operator">=</span> <span class="token operator">&amp;</span>Proxy<span class="token punctuation">{</span>
        cache<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 缓存中没有结果，RealSubject 进行计算并添加到缓存中</span>
    subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 缓存中存在结果，直接返回缓存结果</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这种方式，我们可以减少一些需要重复计算的操作，优化了系统的性能，并且可以快速响应客户端的请求。</p>
<h3>日志记录代理</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Subject 接口定义</span>
<span class="token keyword">type</span> Subject <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// RealSubject 结构体实现 Subject 接口</span>
<span class="token keyword">type</span> RealSubject <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rs <span class="token operator">*</span>RealSubject<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Processing request..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Proxy 结构体实现 Subject 接口，并在内部包含了一个 RealSubject 对象和一个日志记录器</span>
<span class="token keyword">type</span> Proxy <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    subject <span class="token operator">*</span>RealSubject
    logger <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Proxy<span class="token punctuation">)</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"Calling Request method..."</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>subject <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>subject <span class="token operator">=</span> <span class="token operator">&amp;</span>RealSubject<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    p<span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"Request method finished."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// client 代码</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> subject Subject <span class="token operator">=</span> <span class="token operator">&amp;</span>Proxy<span class="token punctuation">{</span>
        logger<span class="token punctuation">:</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>Ldate<span class="token operator">|</span>log<span class="token punctuation">.</span>Ltime<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    subject<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 记录 Request 方法的调用信息和结果信息</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这种方式，我们可以在系统中记录每一次对特定对象或方法的调用，以便后续系统调试或问题排查。</p>
<h3>有哪些优缺点</h3>
<h4>优点</h4>
<ul>
<li>代理模式能够协调调用者和被调用者，在一定程度上降低了系统的耦合度。</li>
<li>远程代理使得客户端可以访问在远程机器上的对象，远程机器坑具有更好的计算性能与处理速度，可以加快相应并处理客户端请求。</li>
<li>虚拟代理通过使用一个小对象来代表一个大对象，可以减少系统资源的消耗，对系统进行优化并提高运行速度。</li>
<li>保护代理可以控制对真实对象的使用权限。</li>
</ul>
<h4>缺点</h4>
<ul>
<li>由于客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢。</li>
<li>实现代理模式需要额外的工作，有些代理模式的实现非常复杂。</li>
</ul>
<h2>总结</h2>
<h3>代理模式和装饰器模式</h3>
<ul>
<li>语义上：代理模式是为了控制对被代理对象的访问，而装饰器模式是为了增加被装饰对象的功能。</li>
<li>使用方式上：装饰器模式需要将被装饰者作为参数传给装饰者的构造器，而被代理对象由代理对象创建，客户端不需要知道被代理类的存在。</li>
<li>使用者角度上：被代理对象是已经确定的，而被装饰者则在使用时根据需求进行组合。</li>
</ul>
<h3>代理模式和 Middleware</h3>
<p>代理设计模式和 Middleware 之间存在相似之处，这两个模式都是为了实现对象间松耦合，增强维护性和扩展性。例如：日志记录、访问控制、速率限制等。唯一不同的地方是：代理模式是通过引入被代理类扩展其功能，而Go语言middleware是通过函数和闭包实现扩展函数功能，这归功于Go语言中函数是一等公民。</p>
]]></content:encoded>
      <enclosure url="https://refactoringguru.cn/images/patterns/content/proxy/proxy-2x.png" type="image/png"/>
    </item>
    <item>
      <title>小心break🤦‍♂️</title>
      <link>http://blog.cjhe.top/go-language/advance/break.html</link>
      <guid>http://blog.cjhe.top/go-language/advance/break.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">小心break🤦‍♂️</source>
      <description>这里展示break的一个例子 查看执行结果 警告 按道理当收到exit信号时，协程应该退出，但此时协程仍旧在打印tick 其实break语句只是跳出最内部的for、swich或select的执行。例子中只是跳出了select语句，并未跳出for循环 那么我们该怎么跳到最外层呢？ 1、通过break [label] 查看执行结果 提示 代码执行到brea...</description>
      <category>Go语言</category>
      <pubDate>Sat, 11 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>这里展示break的一个例子</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	exit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"tick"</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>exit<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exiting..."</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	exit <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">// wait child goroutine exit</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>tick
tick
exiting...
tick
tick
</code></pre></div></details>
<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>按道理当收到exit信号时，协程应该退出，但此时协程仍旧在打印tick</p>
<p>其实break语句只是跳出最内部的for、swich或select的执行。例子中只是跳出了select语句，并未跳出for循环</p>
</div>
<p>那么我们该怎么跳到最外层呢？</p>
<p>1、通过break [label]</p>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	exit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	loop<span class="token punctuation">:</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"tick"</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>exit<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exiting..."</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span> loop
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	exit <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">// wait child goroutine exit</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>tick
tick
exiting...
exit!
</code></pre></div></details>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>代码执行到<code>break loop</code>时，程序将结束loop所指代的for循环的执行</p>
</div>
<p>2、通过goto [label]</p>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	exit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"tick"</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>exit<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exiting..."</span><span class="token punctuation">)</span>
				<span class="token keyword">goto</span> loop
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	loop<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	exit <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">// wait child goroutine exit</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>tick
tick
exiting...
exit!
</code></pre></div></details>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>代码执行到<code>goto loop</code>时，程序将跳转到loop所指的位置继续执行</p>
</div>
]]></content:encoded>
    </item>
    <item>
      <title>for-range避坑指南</title>
      <link>http://blog.cjhe.top/go-language/advance/for-range.html</link>
      <guid>http://blog.cjhe.top/go-language/advance/for-range.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">for-range避坑指南</source>
      <description>警告 for range同常使用在遍历：数组、指向数组的指针、切片、字符串、map和channel等表达式 其中有不少坑需要小心！！！</description>
      <category>Go语言</category>
      <pubDate>Thu, 09 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p><code>for range</code>同常使用在遍历：数组、指向数组的指针、切片、字符串、map和channel等表达式</p>
<p>其中有不少坑需要小心！！！</p>
</div>
<!-- more -->
<h2>for range</h2>
<p>for range使用短变量声明方式(:=)进行遍历时声明了变量
例如</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	slice <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token comment">//获取索引和值</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">//获取索引和值</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>小心短变量声明</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> slice <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token punctuation">{</span> <span class="token comment">//遍历1</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">{</span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"====="</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span> <span class="token comment">//遍历2</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">{</span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>遍历1和遍历2仅在传递go func()参数有差别，结果却完全不一样</p>
<details class="hint-container details"><summary>查看运行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>4 5
4 5
4 5
4 5
4 5
=====
4 5
0 1
1 2
2 3
3 4
</code></pre></div><p>其原因在于这些迭代变量在每次循环中都会被重用，而不是重新声明</p>
<ul>
<li>遍历1中，遍历结束后，开启的5个协程打印共用的变量<code>i</code>和<code>v</code>,此时<code>i=4</code>,<code>v=5</code>;</li>
<li>遍历2中，由于在各个协程中，重新声明了<code>i</code>和<code>v</code>变量，及时的将值传入各个协程，因此打印的是期望的结果，但因为各个协程调度时间不同，因此结果是乱序的。</li>
</ul>
</details>
<h2>小心遍历过程中的修改</h2>
<p>for range在遍历表达式时如果对其修改不同的类型影响是不一样的</p>
<h3>数组遍历</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> r <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12</span>
			a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">13</span>
		<span class="token punctuation">}</span>
		r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>[1 2 3 4 5]
[1 2 3 4 5]
[1 12 13 4 5]
</code></pre></div><p>在i=0时，我们修改了a[1]=12、a[2]=13，但v还是原来的值，这是因为遍历时使用的是数组a的副本，也就没有真实的反应到数组a本身，因此r拿到的数据时a副本的数据，数组a本身并未发生变化。</p>
</details>
<h3>数组指针遍历</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> r <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">&amp;</span>a <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12</span>
			a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">13</span>
		<span class="token punctuation">}</span>
		r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>[1 2 3 4 5]
[1 12 13 4 5]
[1 12 13 4 5]
</code></pre></div><p>此次遍历的是*[5]int作为range的表达式，虽然也是副本，但副本所指向的内存空间是同样的。因此r的值可以改变</p>
</details>
<h3>切片遍历</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> r <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12</span>
			a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">13</span>
		<span class="token punctuation">}</span>
		r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>[1 2 3 4 5]
[1 12 13 4 5]
[1 12 13 4 5]
</code></pre></div><p>有切片的底层结构，我们知道切片由（<code>array</code>，<code>len</code>，<code>cap</code>）三元组组成，其中<code>array</code>指向底层数组。在range遍历时，它实际上复制的是一个切片，且切片的<code>array</code>指向的是同一个底层数组，因此会修改相同的底层数据。</p>
</details>
<p>👀<strong>但如果切片发生了扩容，导致长度发生了改变，for range遍历的仍是原来的长度</strong></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12</span>
			a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">13</span>
			a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		r <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>[1 2 3 4 5]
[1 12 13 4 5 6 7]
[1 12 13 4 5]
</code></pre></div><p>切片a在遍历时附加了两个元素，len由5加到7，但由于for range使用的是切片a的副本，仍是长度5。</p>
</details>
<h3>字符串遍历</h3>
<p><code>string</code>类型是不可变的，每次循环的单位是一个<code>rune</code>,而不是<code>byte</code>，虽然底层结构是<code>byte</code>。如果遍历过程中存在非法UTF8字节序列，那么将返回<code>0xfffd</code>这个特殊值，且下次遍历从下一个<code>byte</code>开始，而不是<code>rune</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">"中国人"</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d %s 0x%x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

	<span class="token comment">//byte sequence of s: 0xe4 0xb8 0xad 0xe5 0x9b 0xbd 0xe4 0xba 0xba</span>
	<span class="token keyword">var</span> sl <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xe4</span><span class="token punctuation">,</span> <span class="token number">0xb8</span><span class="token punctuation">,</span> <span class="token number">0xad</span><span class="token punctuation">,</span> <span class="token number">0xe5</span><span class="token punctuation">,</span> <span class="token number">0x9b</span><span class="token punctuation">,</span> <span class="token number">0xbd</span><span class="token punctuation">,</span> <span class="token number">0xe4</span><span class="token punctuation">,</span> <span class="token number">0xba</span><span class="token punctuation">,</span> <span class="token number">0xba</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"0x%x "</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">string</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d %v 0x%x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>

  <span class="token comment">//修改为非法字符</span>
	sl<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xd0</span>
	sl<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xd6</span>
	sl<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xb9</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">string</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d %v 0x%x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看运行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>0 中 0x4e2d
3 国 0x56fd
6 人 0x4eba

0xe4 0xb8 0xad 0xe5 0x9b 0xbd 0xe4 0xba 0xba 

0 中 0x4e2d
3 国 0x56fd
6 人 0x4eba


0 中 0x4e2d
3 � 0xfffd
4 ֹ 0x5b9
6 人 0x4eba
</code></pre></div><p>在遍历第4个字节时，发现时非法UTF8字符，则返回的是特殊值，且下标i从4开始。</p>
</details>
<h3>字典遍历</h3>
<p>字典遍历过程中，如果对其新增和删除，那么会有怎样的结果呢？</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span>
		<span class="token string">"tony"</span><span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
		<span class="token string">"tom"</span><span class="token punctuation">:</span>  <span class="token number">22</span><span class="token punctuation">,</span>
		<span class="token string">"jim"</span><span class="token punctuation">:</span>  <span class="token number">23</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span> <span class="token comment">//原始</span>
		counter <span class="token operator">:=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
			counter<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"counter is "</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"==="</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span> <span class="token comment">//测试删除</span>
		counter <span class="token operator">:=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
			<span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"tony"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			counter<span class="token operator">++</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"counter is "</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"==="</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span> <span class="token comment">//测试增加</span>
		m<span class="token punctuation">[</span><span class="token string">"tony"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">21</span>
		counter <span class="token operator">:=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
			<span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				m<span class="token punctuation">[</span><span class="token string">"lucy"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">24</span>
			<span class="token punctuation">}</span>
			counter<span class="token operator">++</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"counter is "</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看运行结果</summary>
<blockquote>
<p>其输出结果是未知的</p>
<ul>
<li>3、3、4</li>
<li>3、2、4</li>
<li>3、3、3</li>
<li>3、2、3</li>
</ul>
<p>这是因为map的遍历是无序的</p>
</blockquote>
</details>
]]></content:encoded>
    </item>
    <item>
      <title>goroutine和调度原理</title>
      <link>http://blog.cjhe.top/go-language/advance/goroutine.html</link>
      <guid>http://blog.cjhe.top/go-language/advance/goroutine.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">goroutine和调度原理</source>
      <description>Go语言原生支持并发能力，而goroutine是Go语言原生支持并发的具体实现，本篇将为你揭开goroutine的面纱。 goroutinegoroutine</description>
      <category>Go语言</category>
      <pubDate>Mon, 13 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>Go语言原生支持并发能力，而goroutine是Go语言原生支持并发的具体实现，本篇将为你揭开goroutine的面纱。</p>
<figure><img src="http://cdn.cjhe.top/blog/goroutine.png" alt="goroutine" tabindex="0" loading="lazy"><figcaption>goroutine</figcaption></figure>
<!-- more -->
<h2>goroutine</h2>
<p>goroutine是由Go运行时管理的用户层轻量级线程，相比较操作系统线程，goroutine的资源占用和使用代价都要小的多，一个goroutine初始只需要2KB的内存，而线程需要MB级别的空间，这样在有限的内存空间里，可以创建的goroutine的数量相比较线程数量多的多。其次由于线程切换需要拷贝大量的上下文，这就导致线程切换耗时较高。</p>
<h2>GPM模型</h2>
<figure><figcaption>goroutine</figcaption></figure>
<p>GPM模型中：</p>
<ul>
<li>G代表<code>goroutine</code>，存储了<code>goroutine</code>的执行栈信息、<code>goroutine</code>状态及<code>goroutine</code>的任务函数等</li>
<li>P代表<code>processor</code>，逻辑处理器，所有的P都在程序启动时创建，P的数量决定了系统内最大可并行的G的数量，最多有<code>GOMAXPROCS</code>(可配置)个</li>
<li>M代表<code>thread</code>即用户态线程，M在绑定有效的P后，进入到一个调度循环：从各种队列、P的本地队列获取G，切换到G的执行栈上并执行G的函数，调用<code>goexit</code>做清理工作并回到M，如此反复。</li>
</ul>
<p>此外还有：</p>
<ul>
<li>全局队列(Global Queue)：存放等待运行的G</li>
<li>P的本地队列(Local Queue)：存放的也是等待运行的G，数量不超过256个。
<ul>
<li>当G新建goroutine G'时，G'优先加入到P的本地队列(局部性，G和G'相关)</li>
<li>如果本地队列满了，则会把本地队列中的一半G移动到全局队列</li>
</ul>
</li>
</ul>
<h2>调度策略</h2>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>其思想：复用线程M，避免频繁的创建、销毁</p>
</div>
<h3>work stealing机制</h3>
<p>当本地队列无可运行的G时，会尝试从其他P队列中偷取G，而不是销毁M</p>
<h3>hand off机制</h3>
<p>当M因为G进行系统调用阻塞时，M会释放绑定的P，此时的M和G都进入阻塞状态</p>
<ul>
<li>如果此时有空闲的M，P会与其绑定并执行剩余的G，</li>
<li>如果没有空闲的M，则会创建新的M</li>
</ul>
<p>当系统调用返回后，阻塞在该系统调用的G会尝试获取一个可用的P</p>
<ul>
<li>如果有可用的P，之前运行该G的M将绑定P继续运行G</li>
<li>如果没有可用的P，那么G于M之间的关联将解除，同时G会标记为runable，放入全局队列等待调度</li>
</ul>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<ul>
<li>网络I/O不会阻塞M，仅阻塞G</li>
<li>文件I/O会阻塞M，这就是为什么大量文件I/O操作会导致大量线程被创建的原因。</li>
</ul>
</div>
<h3>抢占调度</h3>
<p>与操作系统按<strong>时间片</strong>调度线程不同，Go中没有<strong>时间片</strong>的概念。如果某个G没有进行系统调用，没有进行I/O操作、没有阻塞在一个channel操作上，那么<strong>M是如何让G停下来并调度下一个可运行的G呢</strong>？</p>
<ul>
<li>Go1.2版本在每个函数或方法的入口增加一段额外的代码，让运行时有机会检查是否需要执行抢占调度；（对没有函数调用的G无效）</li>
<li>Go程序运行时会启动一个名为<code>sysmon</code>的M（称为监控线程），该M无须绑定P即可运行（以g0这个G的形式），该M对于长时间运行（超过10ms）的G发出抢占式调度。</li>
</ul>
<h2>参考文献</h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s/rfjysi-LB-uFiGiZjh-XNw" target="_blank" rel="noopener noreferrer">文章-Golang调度器GMP原理与调度全分析</a></li>
<li><a href="https://book.douban.com/subject/35720729/" target="_blank" rel="noopener noreferrer">书籍-Go语言精进之路</a></li>
</ul>
]]></content:encoded>
      <enclosure url="http://cdn.cjhe.top/blog/goroutine.png" type="image/png"/>
    </item>
    <item>
      <title>interface底层原理</title>
      <link>http://blog.cjhe.top/go-language/advance/interface.html</link>
      <guid>http://blog.cjhe.top/go-language/advance/interface.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">interface底层原理</source>
      <description>interfaceinterface</description>
      <category>Go语言</category>
      <pubDate>Sun, 12 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="http://cdn.cjhe.top/blog/interface.png" alt="interface" tabindex="0" loading="lazy"><figcaption>interface</figcaption></figure>
<!-- more -->
<h2>接口不为nil的误区</h2>
<p>我们看一个demo</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"errors"</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> MyError <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ErrBad <span class="token operator">=</span> MyError<span class="token punctuation">{</span>
	<span class="token builtin">error</span><span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"bad error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">bad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">returnsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> p <span class="token operator">*</span>MyError <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token keyword">if</span> <span class="token function">bad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		p <span class="token operator">=</span> <span class="token operator">&amp;</span>ErrBad
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> p
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	e <span class="token operator">:=</span> <span class="token function">returnsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"error: %+v\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看运行结果</summary>
<p><code>error: &lt;nil&gt;</code></p>
</details>
<p>这里大家很疑惑：明明<code>returnsError</code>函数返回的p值为nil，为何却满足了第30行的条件分支？我们先来看看接口类型的底层结构再来回答这个问题。</p>
<h2>接口类型底层结构</h2>
<p>参见<code>$GOROOT/src/runtime/runtime2.go</code></p>
<figure><figcaption>interface</figcaption></figure>
<p>接口类型变量有两种内部表示：</p>
<ul>
<li><code>eface</code>：用于表示没有方法的空接口(<code>empty interface</code>)类型变量，即<code>interface{}</code>类型的变量</li>
<li><code>iface</code>：用于表示其拥有方法的接口(<code>interface</code>)类型变量</li>
</ul>
<p><code>data</code>都指向当前赋值给接口类型变量的动态类型变量的值，但<code>iface</code>相比较<code>eface</code>多了<code>itab</code>这个类型，其中:</p>
<ul>
<li><code>inter</code>存储该接口类型自身的信息</li>
<li><code>_type</code>存储该接口类型变量</li>
<li><code>fun</code>存储动态类型已实现的接口方法的调用地址数组</li>
</ul>
<p>Go运行时会为程序内的全部类型建立只读的共享<code>_type</code>信息表，因此如果我们要判断接口类型变量是否相同，只需：</p>
<ul>
<li>判断<code>_type/tab</code>是否相同</li>
<li><code>data</code>指针所指向的内存空间所存储的数据值是否相同</li>
</ul>
<p>这里需要区分不同的类型之间的等值比较，参见下文</p>
<h3>nil接口变量</h3>
<p>未初始化的接口类型变量默认零值为nil</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">printNilInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// nil接口变量</span>
	<span class="token keyword">var</span> i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 空接口类型</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>     <span class="token comment">// 非空接口类型</span>
	<span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i = nil:"</span><span class="token punctuation">,</span> i <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err = nil:"</span><span class="token punctuation">,</span> err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i = err:"</span><span class="token punctuation">,</span> i <span class="token operator">==</span> err<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>(0x0,0x0)
(0x0,0x0)
i = nil: true
err = nil: true
i = err: true
</code></pre></div></details>
<p>值为nil的接口类型变量内部表示均为<code>(0x0,0x0)</code>，即类型信息和数据信息均为空，因此和nil相等</p>
<h3>空接口类型变量</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">printEmptyInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// empty接口变量</span>
	<span class="token keyword">var</span> eif1 <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 空接口类型</span>
	<span class="token keyword">var</span> eif2 <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 空接口类型</span>
	<span class="token keyword">var</span> n<span class="token punctuation">,</span> m <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span>

	eif1 <span class="token operator">=</span> n
	eif2 <span class="token operator">=</span> m

	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif1:"</span><span class="token punctuation">,</span> eif1<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif2:"</span><span class="token punctuation">,</span> eif2<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif1 = eif2:"</span><span class="token punctuation">,</span> eif1 <span class="token operator">==</span> eif2<span class="token punctuation">)</span>

	eif2 <span class="token operator">=</span> <span class="token number">17</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif1:"</span><span class="token punctuation">,</span> eif1<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif2:"</span><span class="token punctuation">,</span> eif2<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif1 = eif2:"</span><span class="token punctuation">,</span> eif1 <span class="token operator">==</span> eif2<span class="token punctuation">)</span>

	eif2 <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif1:"</span><span class="token punctuation">,</span> eif1<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif2:"</span><span class="token punctuation">,</span> eif2<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif1 = eif2:"</span><span class="token punctuation">,</span> eif1 <span class="token operator">==</span> eif2<span class="token punctuation">)</span>

	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>eif1: (0x10951e0,0xc000092f68)
eif2: (0x10951e0,0xc000092f60)
eif1 = eif2: false
eif1: (0x10951e0,0xc000092f68)
eif2: (0x10951e0,0x10c64e8)
eif1 = eif2: true
eif1: (0x10951e0,0xc000092f68)
eif2: (0x10952a0,0x10c64e8)
eif1 = eif2: false
</code></pre></div></details>
<p>对于空接口类型变量，只有在<code>_type</code>和<code>data</code>所指数据内容一致（注意：不是数据指针的值一致）的情况下，两个空接口类型变量之间才能画等号。</p>
<h3>非空接口类型</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> T <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t T<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">"bad error"</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">printNonEmptyInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> err1 <span class="token builtin">error</span> <span class="token comment">// 非空接口类型</span>
	<span class="token keyword">var</span> err2 <span class="token builtin">error</span> <span class="token comment">// 非空接口类型</span>
	err1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err1:"</span><span class="token punctuation">,</span> err1<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err1 = nil:"</span><span class="token punctuation">,</span> err1 <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

	err1 <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
	err2 <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err1:"</span><span class="token punctuation">,</span> err1<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err2:"</span><span class="token punctuation">,</span> err2<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err1 = err2:"</span><span class="token punctuation">,</span> err1 <span class="token operator">==</span> err2<span class="token punctuation">)</span>

	err2 <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err1:"</span><span class="token punctuation">,</span> err1<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err2:"</span><span class="token punctuation">,</span> err2<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err1 = err2:"</span><span class="token punctuation">,</span> err1 <span class="token operator">==</span> err2<span class="token punctuation">)</span>

	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>err1: (0x10c6a58,0x0)
err1 = nil: false
err1: (0x10c6ab8,0x10c64f0)
err2: (0x10c6ab8,0x10c64f8)
err1 = err2: false
err1: (0x10c6ab8,0x10c64f0)
err2: (0x10c69d8,0xc000096210)
err1 = err2: false
</code></pre></div></details>
<p>针对<code>err1 = (*T)(nil)</code>这种赋值，非空接口类型变量的类型信息并不为空，数据指针为空，因此与<code>nil(0x0,0x0)</code>不能画等号</p>
<h3>空接口类型和非空接口类型的等值比较</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">printEmptyInterfaceAndNonEmptyInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> eif <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span> <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif:"</span><span class="token punctuation">,</span> eif<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif = err:"</span><span class="token punctuation">,</span> eif <span class="token operator">==</span> err<span class="token punctuation">)</span>

	err <span class="token operator">=</span> <span class="token function">T</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif:"</span><span class="token punctuation">,</span> eif<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eif = err:"</span><span class="token punctuation">,</span> eif <span class="token operator">==</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结构</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>eif: (0x10974c0,0x10c64f0)
err: (0x10c6ab8,0x10c64f0)
eif = err: true
eif: (0x10974c0,0x10c64f0)
err: (0x10c6ab8,0x10c64f8)
eif = err: false
</code></pre></div></details>
<p>空接口类型变量和非空接口类型变量内部表示的结构不同，但Go进行等值比较时，类型比较使用的是<code>eface</code>的<code>_type</code>和<code>iface</code>的<code>tab._type</code></p>
]]></content:encoded>
      <enclosure url="http://cdn.cjhe.top/blog/interface.png" type="image/png"/>
    </item>
    <item>
      <title>深入了解Go锁原理</title>
      <link>http://blog.cjhe.top/go-language/advance/mutex.html</link>
      <guid>http://blog.cjhe.top/go-language/advance/mutex.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">深入了解Go锁原理</source>
      <description>Go语言sync包提供了两种锁： 互斥锁 Mutex: 加锁时，其他加锁协程均阻塞 读写锁 RWMutex: 加读锁时，加写锁协程阻塞，加读锁协程不阻塞 加写锁时，其他加读写协程均阻塞</description>
      <category>Go语言</category>
      <pubDate>Sat, 11 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>Go语言sync包提供了两种锁：</p>
<ul>
<li>互斥锁 Mutex:
<ul>
<li>加锁时，其他加锁协程均阻塞</li>
</ul>
</li>
<li>读写锁 RWMutex:
<ul>
<li>加读锁时，加写锁协程阻塞，加读锁协程不阻塞</li>
<li>加写锁时，其他加读写协程均阻塞</li>
</ul>
</li>
</ul>
<!-- more -->
<h2>互斥锁 Mutex</h2>
<h3>Mutex数据结构</h3>
<p>参见<code>$GOROOT/src/sync/mutex.go</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Mutex <span class="token keyword">struct</span><span class="token punctuation">{</span>
  state <span class="token builtin">int32</span>
  sema  <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中：</p>
<ul>
<li>state: 表示互斥锁的状态，比如是否被锁定等；</li>
<li>sema: 表示信号量，协程阻塞等待该信号量，解锁的协程释放信号量从而唤醒等待信号量的协程；</li>
</ul>
<p>Mutex.state虽然是<code>int32</code>数据类型，内部实现时把该变量分成四份，用于记录Mutex的四种状态</p>
<figure><figcaption>mutex</figcaption></figure>
<ul>
<li>Locked: 表示该Mutex是否已被锁定，0表示没有锁定，1表示已锁定</li>
<li>Woken: 表示是否协程已被唤醒，0表示没有协程唤醒，1表示已有协程唤醒</li>
<li>Starving: 表示该Mutex是否处于饥饿状态，0表示没有饥饿，1表示饥饿状态（说明已有协程阻塞时间超过1ms）</li>
<li>Waiter: 表示阻塞等待协程的个数，协程解锁时根据此值来判断是否需要释放信号量</li>
</ul>
<h3>Mutex的方法</h3>
<p>Mutex对外提供两个方法：</p>
<ul>
<li>Lock(): 加锁方法</li>
<li>Unlock(): 解锁方法</li>
</ul>
<h4>单个协程的加锁释放过程</h4>
<p>Mutex内部<code>state</code>表示如下：</p>
<figure><figcaption>mutex-simple</figcaption></figure>
<h4>两个协程的加锁释放过程</h4>
<p>Mutex内部<code>state</code>表示如下：</p>
<figure><figcaption>mutex-comple</figcaption></figure>
<p>上面介绍Mutex加锁和解锁只使用内部<code>state</code>标记：<code>Waiter</code>和<code>Locked</code>两个，另外两个标记就不得不提自旋过程了。</p>
<h3>自旋过程</h3>
<blockquote>
<p>自旋过程是：加锁时，如果当前<code>Locked</code>为1，则说明当前该锁由其他协程持有，尝试加锁的协程并不是马上转入阻塞，而是会持续地探测<code>Locked</code>是否变为0，这个过程就是自旋过程。</p>
</blockquote>
<details class="hint-container details"><summary>自旋的条件</summary>
<ul>
<li>自旋次数要足够少，通常为4；</li>
<li>CPU核数要大于1，否则自旋没有意义，因为此时不可能有其他协程释放锁；</li>
<li>协程调度GMP中的P的数量要大于1；</li>
<li>协程调度运行队列必须为空，否则会延迟协程调度；</li>
</ul>
</details>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>自旋的好处：当加锁失败时不必立即转入阻塞，有一定机会获得锁，避免协程的切换。</p>
</div>
<p>自旋的时间很短，如果自旋过程中发现锁已被释放，那么协程可以立即获取锁，此时即便有其他协程被唤醒也无法获取锁，只能再次阻塞。</p>
<p>如果自旋过程中获得锁，那么之前被阻塞的协程将无法获得锁，之前阻塞的协程一直获取不到锁（超过1ms）将进入<strong>饥饿</strong>状态</p>
<p>如果此时有两个协程，一个在加锁，另一个在解锁，在加锁的过程中可能处于自旋，此时会把<code>Woken</code>标记为1，用于告知解锁协程，不必释放信号量，它很快会拿到锁。</p>
<h3>Mutex注意事项</h3>
<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>Mutex等sync中定义的结构类型首次使用后不应对其进行复制操作</p>
</div>
<p>我们看一个示例：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"log"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> foo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	n <span class="token builtin">int</span>
	sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f <span class="token operator">:=</span> foo<span class="token punctuation">{</span>n<span class="token punctuation">:</span> <span class="token number">17</span><span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>f foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g2: try to lock foo..."</span><span class="token punctuation">)</span>
			f<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g2: lock foo ok"</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			f<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g2: unlock foo ok"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>

	f<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g1: lock foo ok"</span><span class="token punctuation">)</span>

	<span class="token comment">// 在mutex首次使用后复制其值</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>f foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g3: try to lock foo..."</span><span class="token punctuation">)</span>
			f<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g3: lock foo ok"</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			f<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g3: unlock foo ok"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"g1: unlock foo ok"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="hint-container details"><summary>查看执行结果</summary>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>2023/03/12 19:23:45 g1: lock foo ok
2023/03/12 19:23:45 g2: try to lock foo...
2023/03/12 19:23:45 g3: try to lock foo...
2023/03/12 19:23:45 g2: lock foo ok
2023/03/12 19:23:48 g2: unlock foo ok
2023/03/12 19:23:48 g2: try to lock foo...
2023/03/12 19:23:48 g2: lock foo ok
2023/03/12 19:23:51 g2: unlock foo ok
...
</code></pre></div><p>我们看到g3在加锁操作之后阻塞，而g2按照预期正常运行</p>
<p>g2和g3的区别在于：</p>
<ul>
<li>g2是在互斥锁首次使用之前创建</li>
<li>g3是在互斥锁执行完加锁操作之后创建，并且在创建g3的时候复制了foo实例</li>
</ul>
</details>
<p>sync包中类型的实例在被复制得到的副本后将脱离原实例的控制范围，因此推荐传指针的方式</p>
<h2>读写锁 RWMutex</h2>
<h3>RWMutex数据结构</h3>
<p>参见<code>$GOROOT/src/sync/mutex.go</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> RWMutex <span class="token keyword">struct</span><span class="token punctuation">{</span>
  w           Mutex
  writerSem   <span class="token builtin">uint32</span>
  readerSem   <span class="token builtin">uint32</span>
  readerCount <span class="token builtin">int32</span>
  readerWait  <span class="token builtin">int32</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中：</p>
<ul>
<li>w: 用于控制多个写锁，获得写锁首先要获取该锁</li>
<li>writerSem: 写阻塞的协程等待的信号量，最后一个读协程释放锁时会释放信号量</li>
<li>readerSem: 读阻塞的协程等待的信号量，持有写锁的协程释放锁后会释放信号量</li>
<li>readerCount: 记录读协程的个数</li>
<li>readerWait: 记录写阻塞时的读协程个数</li>
</ul>
<h3>RWMutex的方法</h3>
<ul>
<li>RLock(): 加读锁
<ul>
<li>增加读操作计数，即readerCount++</li>
<li>如果已经有持有写锁协程，则阻塞自己</li>
</ul>
</li>
<li>RUnlock(): 释放读锁
<ul>
<li>减少读操作计数，即readerCount--</li>
<li>如果有阻塞的写锁协程，则唤醒它</li>
</ul>
</li>
<li>Lock(): 加写锁
<ul>
<li>获取互斥锁</li>
<li>如果持有读锁协程，则阻塞自己，等待所有的读操作结束</li>
</ul>
</li>
<li>Unlock(): 释放写锁
<ul>
<li>释放互斥锁</li>
<li>如果其他阻塞的读锁协程，则唤醒它</li>
</ul>
</li>
</ul>
<figure><figcaption>rwmutex</figcaption></figure>
<h3>RWMutex的细节分析</h3>
<h4>写操作是如何阻止写操作的？</h4>
<p>读写锁RWMutex包含一个互斥锁w，获取写锁必须先获取该互斥锁，如果互斥锁已被其他协程持有，则只能阻塞等待。</p>
<h4>写操作是如何阻止读操作的？</h4>
<p>读写锁RWMutex包含当前读协程数量readerCount，每次获取读锁则加1，每次释放读锁则减1，因此取值为[0,N],N最大为2e30。
当获取写锁时，会将readerCount减去2e30，变成了负值。获取读锁协程检测到readerCount为负值，便知道正在加写锁，只好阻塞自己。
真实的readerCount不会丢失，只需要加2e30即可。</p>
<h4>读操作是如何阻止写操作的？</h4>
<p>读锁会先将RWMutex.readerCount加1，写锁协程检测到readerCount不为0，则会阻塞自己。</p>
<h4>写锁为什么不会被<strong>饿死</strong>？</h4>
<p>获取写锁期间，可能还有其他协程获取读锁，如果写锁一直等待所有的读操作结束，则很可能被<strong>饿死</strong>，RWMutex通过readerWait解决这个问题，当获取写锁时，会把readerCount复制到readerWait，用于标记排在写操作前面的读操作个数，读操作结束会递减readerCount的值，同时也会递减readerWait的值，当readerWait值为0时唤醒写操作。写操作结束后才会唤醒其他的读操作。</p>
<h2>参考资料</h2>
<p><a href="https://book.douban.com/subject/35144587/" target="_blank" rel="noopener noreferrer">Go专家编程</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>魔幻的iota枚举</title>
      <link>http://blog.cjhe.top/go-language/base/iota.html</link>
      <guid>http://blog.cjhe.top/go-language/base/iota.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">魔幻的iota枚举</source>
      <description>提示 iota的出现使得枚举值更加方便，但注意哦，并不简单。主要是对iota定义不理解，我整理了一些iota的使用注意事项</description>
      <category>Go语言</category>
      <pubDate>Fri, 03 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>iota的出现使得枚举值更加方便，但注意哦，并不简单。主要是对iota定义不理解，我整理了一些iota的使用注意事项</p>
</div>
<!-- more -->
<h2>iota</h2>
<blockquote>
<p>iota是Go语言的一个预定义标识符，它表示的是const声明块或声明行中每个常量所处位置的<strong>偏移值</strong>（从0开始）。</p>
</blockquote>
<h3>规则：如果按行递增，可省略后续的iota关键字</h3>
<p>例如：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	Sunday    <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//0</span>
	Monday           <span class="token comment">//1</span>
	Tuesday          <span class="token comment">//2</span>
	Wednesday        <span class="token comment">//3</span>
	Thursday         <span class="token comment">//4</span>
	Friday           <span class="token comment">//5</span>
	Saturday         <span class="token comment">//6</span>
<span class="token punctuation">)</span>
</code></pre></div><p>这与常量的规则：<strong>如果不指定类型和初始化值，则默认表示使用上行的赋值表达式</strong>一致</p>
<p>上面等价于</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	Sunday    <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//0</span>
	Monday    <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//1</span>
	Tuesday   <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//2</span>
	Wednesday <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//3</span>
	Thursday  <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//4</span>
	Friday    <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//5</span>
	Saturday  <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//6</span>
<span class="token punctuation">)</span>
</code></pre></div><h3>规则：iota只跟常量组的偏移位置有关</h3>
<p>‼️</p>
<p>例如：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	a <span class="token operator">=</span> <span class="token char">'A'</span>
	b
	c <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//iota=2</span>
	d        <span class="token comment">//iota=3</span>

	e <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//iota=4</span>
	f        <span class="token comment">//iota=5</span>
<span class="token punctuation">)</span>
</code></pre></div><p>虽然c是第一次使用iota标识符定义，但在const块中位置属于第3，此时iota为2；</p>
<p>d与e之间虽然有空行，但e的偏移位置属于第5，因此iota为4；</p>
<h3>规则：每遇到一个const关键字，iota就会重置为0</h3>
<p>例如：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//iota=0</span>
<span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">//iota=0</span>
</code></pre></div><h3>规则：iota跟个数无关，即便是同一行，值也都一样</h3>
<p>‼️</p>
<p>例如：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	g<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token boolean">iota</span><span class="token punctuation">,</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">10</span> <span class="token comment">//0,10 (iota=0)</span>
	i<span class="token punctuation">,</span> j                   <span class="token comment">//1,11 (iota=1)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>虽然g,h是两个常量，但由于在同一行，iota的值一样</p>
<h3>规则：如果想从1开始，则可以通过<code>_</code>忽略第一个iota</h3>
<p>例如：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span>          <span class="token operator">=</span> <span class="token boolean">iota</span>
	KB <span class="token builtin">float64</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token boolean">iota</span><span class="token punctuation">)</span> <span class="token comment">//2^10</span>
	MB                            <span class="token comment">//2^20</span>
	GB                            <span class="token comment">//...</span>
	TB
	PB
	EB
	ZB
	YB
<span class="token punctuation">)</span>
</code></pre></div>]]></content:encoded>
    </item>
    <item>
      <title>散列map</title>
      <link>http://blog.cjhe.top/go-language/base/map.html</link>
      <guid>http://blog.cjhe.top/go-language/base/map.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">散列map</source>
      <description>mapmap</description>
      <category>Go语言</category>
      <pubDate>Mon, 06 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="http://cdn.cjhe.top/blog/map.png" alt="map" tabindex="0" loading="lazy"><figcaption>map</figcaption></figure>
<!-- more -->
<blockquote>
<p>map是Go语言提供的一种抽象数据类型，它表示一组无序的键值对(key-value)</p>
</blockquote>
<h2>声明</h2>
<p><strong>关键字定义</strong>：<code>map</code></p>
<p><strong>零值</strong>：<code>nil</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>map对于<code>value</code>的类型没有限制，但是对<code>key</code>的类型有严格的要求：
<code>key</code>的类型必须支持<code>==</code>和<code>!=</code>两个操作符的数据类型
因此，函数、map、切片等不能作为<code>key</code>类型。</p>
</div>
<h2>初始化</h2>
<p>字面量初始化</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>m<span class="token operator">:=</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">"apple"</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"banana"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span>
</code></pre></div><p>内置函数make()初始化</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>m<span class="token operator">:=</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><h2>操作</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token string">"apple"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>       <span class="token comment">//新增</span>
	m<span class="token punctuation">[</span><span class="token string">"apple"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>       <span class="token comment">//修改</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">)</span>   <span class="token comment">//删除</span>
	v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token string">"banana"</span><span class="token punctuation">]</span> <span class="token comment">//comma ok 查询</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//获取key的个数</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span> <span class="token comment">//遍历m</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>向<code>nil</code>（未初始化）的map类型里添加数据会导致<code>panic</code></p>
</div>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<ul>
<li>删除不存在的key不会导致panic；</li>
<li>查询不存在的key，如果未使用<strong>comma ok</strong>语法，则会返回value类型对应的<strong>零值</strong></li>
</ul>
</div>
<h2>底层原理</h2>
<p>参见<code>$GOROOT/src/runtime/map.go</code></p>
<h3>map的数据结构</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	count      <span class="token builtin">int</span>            <span class="token comment">//当前保存的元素个数</span>
	flags      <span class="token builtin">uint8</span>          <span class="token comment">//当前map所处的状态标志</span>
	B          <span class="token builtin">uint8</span>          <span class="token comment">//bucket数组的大小的对数：2^B=bucket数量</span>
	noverflow  <span class="token builtin">uint16</span>         <span class="token comment">//overflow buckets的大约数量</span>
	hash0      <span class="token builtin">uint32</span>         <span class="token comment">//hash函数的种子值</span>
	buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">//指向bucket数组的指针</span>
	oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">//在map扩容阶段指向前一个bucket数组的指针</span>
	nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">//map扩容阶段充当扩容进度计数器,小于此bucket都已完成了数据排空和迁移操作</span>
	extra      <span class="token operator">*</span>mapextra      <span class="token comment">//可选字段，与gc相关</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>bucket的数据结构</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// a bucket for a Go map</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实际上编辑期间会动态生产一个新的结构体</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	tophash  <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span>
	keys     <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>keytype
	values   <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>valuetype
	overflow <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre></div><figure><figcaption>map</figcaption></figure>
<p>key和value分开存储，目的是为了减少内存对齐带来的内存浪费，以map[int8]int64为例：</p>
<figure><figcaption>map-memory</figcaption></figure>
<p>每个bucket可以存储8个键值对，超过就会创建一个新的bucket，通过overflow链接</p>
<p>当有两个或以上数量的键被<code>Hash</code>到了同一个bucket时，我们称这些键发生了冲突，Go语言使用链表解决键冲突。</p>
<p>hash冲突并不是好事情，它降低了存取效率，好的Hash算法可以保证Hash值得随机性，但无论使用哪种Hash算法，冲突终究不可避免，当冲突较多的时候就需要采取一些措施来减少冲突。</p>
<h3>负载因子LoadFactor</h3>
<blockquote>
<p>负载因子用于衡量一个Hash表的冲突情况，计算公式如下：</p>
<p>负载因子 = 键数量 / bucket数量</p>
</blockquote>
<ul>
<li>负载因子过小，空间利用率低；</li>
<li>负载因子过大，说明冲突严重，存取效率低；</li>
</ul>
<p>当Hash表的负载因子过大时需要rehash，即申请更多的bucket，并对所有的键值对重新组织，使其均匀的分布在这些bucket中。</p>
<ul>
<li>redis的负载因子大于1时就会触发rehash，因为redis的每个bucket只能存1个键值对；</li>
<li>go的负载因子大于6.5时才会触发rehash，因为go的每个bucket可以存8个键值对；</li>
</ul>
<h3>扩容</h3>
<p>条件：</p>
<ul>
<li>负载因子大于6.5时</li>
<li>overflow的数量大于2^15=32768</li>
</ul>
<p>map的扩缩容的主要区别在于hmap.B的容量大小改变，而缩容由于hmap.B压根不变，内存占用依然存在。这就导致在删除元素时，并不会释放内存，使得分配的总内存不断增加，如果不注意，内存就很容易爆了。</p>
<h4>增量扩容</h4>
<blockquote>
<p>通过将bucket数组扩大一倍实现，并搬迁键值对</p>
</blockquote>
<ol>
<li>oldbuckets指向现有bucket数组；</li>
<li>创建一个两倍现有规模的bucket数组；</li>
<li>buckets指向新的bucket数组；</li>
<li>将oldbuckets的键值对搬迁到新的bucket数组；</li>
<li>释放oldbuckets；</li>
</ol>
<figure><figcaption>map-expand</figcaption></figure>
<h4>等量扩容</h4>
<blockquote>
<p>用于解决一个bucket链接很多bucket，overflow数量过高</p>
<p>bucket数组大小不变，重新排列键值对，分散到不同的bucket数组中</p>
<p>这样就提高了访问效率</p>
</blockquote>
<h3>增删改查</h3>
<h4>查找过程</h4>
<ul>
<li>根据key计算hash值；</li>
<li>取hash值低位与hmap.B取模来确定bucket的位置；</li>
<li>取hash值高位，在tophash数组中查询；</li>
<li>如果tophash[i]中存储的hash值与当前key的hash值相等，则获取tophash[i]的key值进行比较；</li>
<li>当前bucket没有找到，则依次从溢出的bucket中查找；</li>
</ul>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>如果当前map处于搬迁过程中，那么查找时从oldbuckets数组中查找，不再从新的buckets数组中查找</p>
</div>
<h4>添加过程</h4>
<ul>
<li>根据key计算hash值；</li>
<li>取hash值低位与hmap.B取模来确定bucket的位置；</li>
<li>查找该key是否存在
<ul>
<li>如果存在，则直接更新；</li>
<li>如果不存在，则从该bucket中寻找空余位置并插入；</li>
</ul>
</li>
</ul>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>如果当前map处于搬迁过程中，那么直接添加到新的buckets数组中</p>
</div>
<h4>删除过程</h4>
<ul>
<li>查找key是否存在
<ul>
<li>存在，则删除；</li>
<li>不存在，则什么也不做；</li>
</ul>
</li>
</ul>
<h2>map注意事项</h2>
<h3>map的value是struct自定义类型，无法通过索引的方式直接修改</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">MapDemo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name <span class="token builtin">string</span>
		age  <span class="token builtin">int</span>
	<span class="token punctuation">}</span>
	ma <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>User<span class="token punctuation">)</span>
	andes <span class="token operator">:=</span> User<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string">"andes"</span><span class="token punctuation">,</span>
		age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	ma<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> andes
	<span class="token comment">//ma[1].age = 19</span>
	andes<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">19</span>
	ma<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> andes
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>12行，如果通过索引的方式直接修改，编辑器会报错：<a href="https://pkg.go.dev/golang.org/x/tools/internal/typesinternal#UnaddressableFieldAssign" target="_blank" rel="noopener noreferrer">UnaddressableFieldAssign</a>，并且官网也给了详细的说明：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>	// UnaddressableFieldAssign occurs when trying to assign to a struct field
	// in a map value.
	//
	// Example:
	//  func f() {
	//  	m := make(map[string]struct{i int})
	//  	m["foo"].i = 42
	//  }
	UnaddressableFieldAssign
</code></pre></div></div>
<h3>非并发读写安全的</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">doIteration</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"[%d, %d] "</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">doWrite</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
		m<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span>
		<span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
		<span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
		<span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token function">doIteration</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token function">doWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行报错：<code>fatal error: concurrent map iteration and map write</code></p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>Go 在 map 的实现中增加了读写检查机制，一旦发现读写冲突立即触发 panic</p>
<p>如果想使用并发的map：</p>
<ul>
<li>可以使用Go 1.9版本中引入支持并发写安全的<code>sync.Map</code>类型；</li>
<li>可以使用map时增加锁；</li>
</ul>
</div>
<h3>无法通过索引直接获取value的地址</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Num <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>Num<span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Num<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
	value <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">//invalid operation: cannot take address of m[0] (map index expression of type Num)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>这是由于map会扩容，map中的数据元素的value地址可能在扩容过程中发生变化，因此获取这个地址没有意义，Go语言为了防止出现该问题，在编译期间就检测是否有获取地址行为，避免出现问题。</p>
</div>
<h3>尽量使用cap参数初始化map</h3>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkMapInitWithoutCap</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkMapInitWithCap</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>性能基准测试结果如下：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>go test -benchmem -bench=. cap_benchmark_test.go           
goos: darwin
goarch: amd64
cpu: Intel(R) Core(TM) i5-8259U CPU @ 2.30GHz
BenchmarkMapInitWithoutCap-8        1226           1338887 ns/op          687175 B/op        276 allocs/op
BenchmarkMapInitWithCap-8           2534            425859 ns/op          322225 B/op         11 allocs/op
PASS
ok      command-line-arguments  5.939s
</code></pre></div>]]></content:encoded>
      <enclosure url="http://cdn.cjhe.top/blog/map.png" type="image/png"/>
    </item>
    <item>
      <title>切片slice</title>
      <link>http://blog.cjhe.top/go-language/base/slice.html</link>
      <guid>http://blog.cjhe.top/go-language/base/slice.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">切片slice</source>
      <description>sliceslice</description>
      <category>Go语言</category>
      <pubDate>Fri, 03 Feb 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<figure><img src="http://cdn.cjhe.top/blog/slice-1.png" alt="slice" tabindex="0" loading="lazy"><figcaption>slice</figcaption></figure>
<!-- more -->
<blockquote>
<p>切片（slice）简称动态数组，既然是动态，切片的长度可以动态伸缩。</p>
</blockquote>
<p>在Go语言编程过程中，我经常使用切片而非数组，因为切片相比较数组更加<strong>灵活</strong>和<strong>高效</strong>。</p>
<h2>声明</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
		a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>               <span class="token comment">// 指针为nil，len和cap为0</span>
		b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span>           <span class="token comment">// 空切片，不等于nil，表示空的集合</span>
		c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>    <span class="token comment">// 指向包含三个元素的数组：[1，2，3]。len和cap为3</span>
		d <span class="token operator">=</span> c<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>             <span class="token comment">// 与c指向同一个数组，但是len为2，cap为3</span>
		e <span class="token operator">=</span> c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token function">cap</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">]</span>     <span class="token comment">// 与c指向同一个数组，但是len为2，cap为cap(c)的大小，即3</span>
		f <span class="token operator">=</span> c<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>             <span class="token comment">// 与c指向同一个数组，但是len为0，cap为3</span>
		g <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    <span class="token comment">// 指向新的数组，包含三个元素：[0,0,0]。len和cap为3</span>
		h <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 指向新的数组，包含三个元素：[0,0,0]。len为2，cap为3</span>
		i <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 指向新的数组，包含三个元素：[0,0,0]。len为0，cap为3</span>
	<span class="token punctuation">)</span>
</code></pre></div><div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>切片声明时未初始化，此时不能对切片进行索引操作!</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">//panic: runtime error: index out of range [0] with length 0</span>
</code></pre></div></div>
<p>但是</p>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>append可以对未初始化的切片进行操作，因为append操作会对底层数据进行扩容。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//正常</span>
</code></pre></div></div>
<h2>底层结构</h2>
<p>切片的结构定义：<code>$GOROOT/src/runtime/slice.go</code></p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> slice <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	array unsafe<span class="token punctuation">.</span>Pointer
	<span class="token builtin">len</span>   <span class="token builtin">int</span>
	<span class="token builtin">cap</span>   <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre></div><p>切片的定义包含三个字段：</p>
<ul>
<li><strong>array</strong>：指向数组某元素的指针（该元素也是切片的起始元素）；</li>
<li><strong>len</strong>：表示切片的长度，即切片当前元素的个数；</li>
<li><strong>cap</strong>：表示切片的最大容量；</li>
</ul>
<div class="hint-container tip">
<p class="hint-container-title">切片与数组在函数参数传递中比较</p>
<ul>
<li>切片作为函数参数传递给函数时，实际传递的是runtime.slice结构体实例，无论其底层数据有多大，参数传递带来的性能损耗都是很小且恒定的。</li>
<li>数组作为函数参数传递给函数时就不一样了，会重新拷贝整个数组，性能损耗就很大。</li>
</ul>
</div>
<p>既然我们已经知道切片的底层结构是数组，那么我们就可以基于数组创建切片</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>u <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span>
s <span class="token operator">:=</span> u<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//[14 15 16 17] 4 7</span>
</code></pre></div><figure><figcaption>slice底层结构</figcaption></figure>
<h2>append扩容原理</h2>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0 0</span>
s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1 1</span>
s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">// 2 2</span>
s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3 4</span>
s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 4 4</span>
s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 5 8</span>
</code></pre></div><p>其执行逻辑如下图所示：</p>
<figure><figcaption>slice扩容</figcaption></figure>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p><code>append</code>函数在当前数组容量无法满足时，会分配新的数组，新的数组容量会按一定的算法扩展（参见<code>$GOROOT/src/runtime/slice.go</code>的<code>growslice</code>函数），将旧数组中的数据复制到新数组之后，切片array指针指向新的数组，之后旧的数组就如果未被使用或其他切片引用会被垃圾回收掉。</p>
</div>
<h2>append的注意事项</h2>
<div class="language-go" data-ext="go" data-title="go"><pre go="" class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">SliceRise</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">{</span>
		s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">++</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s1 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
	s2 <span class="token operator">:=</span> s1
	s2 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token function">SliceRise</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
	<span class="token function">SliceRise</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[1 2] 2 2</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[2 3 4] 3 4</span>
<span class="token punctuation">}</span>
</code></pre></div><ul>
<li>第15行，由于s2需要的存储空间超过s1的存储空间，因此重新申请了一块空间，至此s1和s2不再共享同一底层数组；</li>
<li><code>SliceRise</code>函数第一步，进行扩容，由于s1传参的底层数组不满足存储空间，因此s切片和s1将不再共享同一空间，然而s2传参的底层数组满足存储空间，因此s切片和s2共享底层数据，因此对s切片的操作会影响到底层数据，进行影响s2；</li>
</ul>
<div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>一旦底层数组容量无法满足某个切片的容量需求，该切片与底层数组关系就会<strong>解除绑定</strong>，例如：</p>
<ul>
<li>15行的s2和s1的底层数组解除绑定</li>
<li>16行调用SliceRise(s1)，其中s和s1的底层数组解除绑定</li>
</ul>
</div>
<div class="hint-container caution">
<p class="hint-container-title">警告</p>
<p>如果多个切片共用同一个底层数组,某个切片的操作对其他切片都是<strong>可见的</strong>，例如：</p>
<ul>
<li>17行调用SliceRise(s2)，s2和s共用底层数组，因此s的修改，s2是可见的。</li>
</ul>
</div>
<p>再举一个影响是<strong>可见的</strong>例子</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>  a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
	b <span class="token operator">:=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
	b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [2 3 0] 3 4</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [1 2 3 0 5] 5 5</span>
</code></pre></div><p>b切片共用a切片的底层数组，且append操作并未超过b切片的容量，因此会影响到a切片：<code>a[3]</code>由原来的4变为0。</p>
<h2>append的性能</h2>
<p>append扩容会重新分配底层数组并复制元素，当元素较多时，操作代价还是很大的。避免这种场景的方法是对切片的容量规模进行预估，并以cap参数的形式进行创建：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>s<span class="token operator">:=</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>T<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span>
</code></pre></div><p>我们将未预估容量的append操作与预估容量的append操作进行压测如下：</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkSliceInitWithoutCap</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		s1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			s1 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkSliceInitWithCap</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		s1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			s1 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其结果如下：</p>
<div class="language-text" data-ext="text" data-title="text"><pre class="language-text"><code>go test -benchmem -bench=. cap_benchmark_test.go 
goos: darwin
goarch: amd64
cpu: Intel(R) Core(TM) i5-8259U CPU @ 2.30GHz
BenchmarkSliceInitWithoutCap-8             18600             62965 ns/op          357625 B/op         19 allocs/op
BenchmarkSliceInitWithCap-8                71695             15997 ns/op           81920 B/op          1 allocs/op
PASS
ok      command-line-arguments  3.630s
</code></pre></div><ul>
<li>不带cap的append操作的平均性能是62965 ns/op，是带cap的append操作的<code>4</code>倍左右；</li>
<li>不带cap的append操作每次操作分配357625B内存，而带cap的append操作仅分配81920B；</li>
<li>不带cap的append操作平均每次分配19次内存，而带cap的append操作仅需一次内存分配；</li>
</ul>
<h2>append的非常规操作</h2>
<p>和数组类似，可以使用<code>len()</code>和<code>cap()</code>函数获取切片的长度和容量。此外可以使用<code>append()</code>对切片追加元素，但<code>append()</code>远不止这个功能。</p>
<h3>添加切片元素</h3>
<h4>在切片尾部追加元素</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>                      <span class="token comment">//指针为nil，len和cap为0</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>                 <span class="token comment">//追加一个元素，len和cap都为1</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>           <span class="token comment">//追加三个元素，len和cap都为4</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">//追加一个切片，len为7，cap为8</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                   <span class="token comment">//[1 2 3 4 5 6 7]</span>
</code></pre></div><h4>在切片头部追加元素</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>              <span class="token comment">//len和cap都为3</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token operator">...</span><span class="token punctuation">)</span>          <span class="token comment">//在开头添加一个元素，len和cap都为4</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">//在开头添加一个切片，len为7，cap为8</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                      <span class="token comment">//[-3 -2 -1 0 1 2 3]</span>
</code></pre></div><div class="hint-container warning">
<p class="hint-container-title">注意</p>
<p>在切片开头追加元素会导致内存的重新分配，已有的元素会复制一份。因此从切片的头部追加元素的性能很差，也很少使用到。</p>
</div>
<h4>在切片中间追加元素</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>       <span class="token comment">//追加一个元素，现在包含元素[1,2,3,7]</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">//追加一个切片，现在包含元素[1,2,3,4,5,6,7]</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                                         <span class="token comment">//[1 2 3 4 5 6 7]</span>
</code></pre></div><p>同样，在切片中间追加元素，会创建许多临时切片，性能比较差。可以使用<code>copy()</code>函数完成类似的功能：</p>
<p>在i的位置上插入一个元素</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>     <span class="token comment">//扩展一个空间</span>
<span class="token function">copy</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//a[i:]向后移动</span>
a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span> x             <span class="token comment">//设置新添加的元素</span>
</code></pre></div><div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>         <span class="token comment">//[1,2,4],cap=3</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>               <span class="token comment">//[1,2,4,0],cap=6</span>
<span class="token function">copy</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment">//[1,2,0,4],cap=6</span>
a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>                       <span class="token comment">//[1,2,3,4],cap=6</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[1 2 3 4] 4 6</span>
</code></pre></div><p><code>copy(target,source)</code>函数，将source的内容复制到target，相比较append，节省了临时切片的创建。</p>
<p>在i的位置上插入多个元素: x</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>x<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token function">copy</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">copy</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span>
</code></pre></div><h3>删除切片元素</h3>
<h4>在切片头部删除元素</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">//删除开头1个元素</span>
a <span class="token operator">=</span> a<span class="token punctuation">[</span>N<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">//删除开头N个元素</span>
</code></pre></div><p>或者</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">//删除开头1个元素</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">//删除开头N个元素</span>
</code></pre></div><p>这里的len和cap都为2，是因为重新分配了内存空间</p>
<h4>在切片中部删除元素</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// 删除中间1个元素</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token operator">+</span>N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// 删除中间N个元素</span>
</code></pre></div><div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>      <span class="token comment">//[1,2,3,4],len=4,cap=4</span>
a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment">//[1,3,4],len=3,cap=4</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[1 3 4] 3 4</span>
</code></pre></div><h4>在切片尾部删除元素</h4>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">//删除尾部1个元素</span>
a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span>N<span class="token punctuation">]</span> <span class="token comment">//删除尾部N个元素</span>
</code></pre></div><div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>         <span class="token comment">//[1,2,3],len=3,cap=3</span>
a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                      <span class="token comment">//[1,2],len=2,cap=3</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[1 2] 2 3</span>
</code></pre></div>]]></content:encoded>
      <enclosure url="http://cdn.cjhe.top/blog/slice-1.png" type="image/png"/>
    </item>
    <item>
      <title>字符串</title>
      <link>http://blog.cjhe.top/go-language/base/string.html</link>
      <guid>http://blog.cjhe.top/go-language/base/string.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">字符串</source>
      <description>声明 关键字定义： string 零值： &amp;quot;&amp;quot; 操作 字符串支持一些简单的运算或操作，如下： 比较 支持各种比较关系运算符: ==、!=、&amp;gt;=、&amp;lt;=、&amp;gt;、&amp;lt; 遍历 提示 Go语言支持UTF-8格式编码，因此字符串中字符可以是ASCII字符，也可以是Unicode字符，其中： byte类型来表示ASCII字符 rune类型来表示Unicode字符 byt...</description>
      <category>Go语言</category>
      <pubDate>Sun, 23 Jan 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<h2>声明</h2>
<p><strong>关键字定义：</strong> string</p>
<p><strong>零值：</strong> ""</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> str <span class="token builtin">string</span>
</code></pre></div><h2>操作</h2>
<p>字符串支持一些简单的运算或操作，如下：</p>
<p>|  操作  |      含义      |     示例      |   结果   |
| :</p>
]]></content:encoded>
    </item>
    <item>
      <title>Go语言推荐博客</title>
      <link>http://blog.cjhe.top/go-language/recommend/blog.html</link>
      <guid>http://blog.cjhe.top/go-language/recommend/blog.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go语言推荐博客</source>
      <description>提示 收集的一些关于Go语言的博客文章，前行不再迷茫</description>
      <category>Go语言</category>
      <pubDate>Sat, 04 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>收集的一些关于Go语言的博客文章，前行不再迷茫</p>
</div>
<!-- more -->
<h2>Go社区</h2>
<p>Go语言官方网站<a href="https://golang.google.cn/" target="_blank" rel="noopener noreferrer">Go官方</a></p>
<p>GoCN社区会分享一些文章和招聘<a href="https://gocn.vip/" target="_blank" rel="noopener noreferrer">GoCN社区</a></p>
<p>Go语言中文网分享一些文章<a href="https://studygolang.com/" target="_blank" rel="noopener noreferrer">Go语言中文网</a></p>
<p>Go夜读会定期的组织阅读Go项目源码<a href="https://talkgo.org/" target="_blank" rel="noopener noreferrer">Go夜读</a></p>
<p>Go的一些书籍<a href="https://topgoer.cn/" target="_blank" rel="noopener noreferrer">地鼠文档</a></p>
<p>腾讯云开发者社区Go教程<a href="https://cloud.tencent.com/developer/doc/1101" target="_blank" rel="noopener noreferrer">腾讯云</a></p>
<p>Go Blog中文翻译<a href="https://learnku.com/docs/go-blog" target="_blank" rel="noopener noreferrer"></a></p>
<p>learnku<a href="https://learnku.com/" target="_blank" rel="noopener noreferrer"></a></p>
<h2>Go语言规范</h2>
<p><a href="https://github.com/xxjwxc/uber_go_guide_cn" target="_blank" rel="noopener noreferrer">Uber公司Go语言编码规范</a></p>
<p><a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener noreferrer">Go代码评审常见错误清单</a></p>
<p><a href="https://rakyll.org/style-packages/" target="_blank" rel="noopener noreferrer">Go包规范</a></p>
<p>稀土掘进-如何写出优雅的Golang代码<a href="https://juejin.cn/post/6844903976509390856" target="_blank" rel="noopener noreferrer"></a></p>
<p>稀土掘进-Go语言实践：编写可维护的程序的建议<a href="https://juejin.cn/post/6844904035611328520" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go官方代码审查<a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener noreferrer"></a></p>
<h2>Go博客</h2>
<p>threedots<a href="https://threedots.tech/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Dave Cheney<a href="https://dave.cheney.net/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Go数据结构<a href="https://www.interviewcake.com/data-structures-reference" target="_blank" rel="noopener noreferrer">data-structures-reference</a></p>
<p>煎鱼，文章质量很高<a href="https://eddycjy.com/" target="_blank" rel="noopener noreferrer">eddycjy</a></p>
<p>峰云就她了，专注Go、Kubernetes、NoSQL、Istio<a href="https://xiaorui.cc/" target="_blank" rel="noopener noreferrer"></a></p>
<p>鸟窝<a href="https://colobu.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>EricZhou，有系列的Go文章<a href="https://mojotv.cn/" target="_blank" rel="noopener noreferrer"></a></p>
<p>傅小黑<a href="https://fuxiaohei.me/" target="_blank" rel="noopener noreferrer"></a></p>
<p>polarisxu<a href="https://polarisxu.studygolang.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>mohuishou<a href="https://lailin.xyz/" target="_blank" rel="noopener noreferrer"></a></p>
<p>一支人<a href="https://yizhi.ren/" target="_blank" rel="noopener noreferrer"></a></p>
<p>可汗学院<a href="https://blog.khanacademy.org/engineering/" target="_blank" rel="noopener noreferrer"></a></p>
<p>Mark<a href="https://www.integralist.co.uk/" target="_blank" rel="noopener noreferrer"></a></p>
<p>qcrao<a href="https://qcrao.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>冰霜之地<a href="https://halfrost.com/" target="_blank" rel="noopener noreferrer"></a></p>
<p>chai2010<a href="https://chai2010.cn/" target="_blank" rel="noopener noreferrer"></a></p>
<h2>Go练习</h2>
<p>Go的一些练习项目<a href="https://gophercises.com/" target="_blank" rel="noopener noreferrer">gophercises</a></p>
<p>Go的示例，有上千个示例<a href="https://golangexample.com/" target="_blank" rel="noopener noreferrer">golangexample</a></p>
<p>Go语言一些示例<a href="https://gobyexample.com/" target="_blank" rel="noopener noreferrer">gobyexample</a></p>
<p>Go Web开发示例<a href="https://gowebexamples.com/" target="_blank" rel="noopener noreferrer">gowebexamples</a></p>
<p>ReposHub网站的Go练习<a href="https://reposhub.com/go" target="_blank" rel="noopener noreferrer"></a></p>
<p>英文的Go练习<a href="https://www.golangprograms.com/" target="_blank" rel="noopener noreferrer"></a></p>
<h2>Go项目脚手架</h2>
<p>eagle可以帮助我们在几个小时内搭建应用，基于eagle-layout模版生成一个包含：CLI、Config、日志、ORM、缓存等的项目<a href="https://github.com/go-eagle/eagle" target="_blank" rel="noopener noreferrer">eagle</a></p>
<p>nunu也是一个基于模版生成项目的工具，集成了主流的框架<a href="https://github.com/go-nunu/nunu" target="_blank" rel="noopener noreferrer">nunu</a></p>
<p>sponge基于页面方式生成项目<a href="https://github.com/zhufuyi/sponge" target="_blank" rel="noopener noreferrer">sponge</a></p>
<h2>知识图谱</h2>
<p>processon<a href="https://www.processon.com/view/link/5a9ba4c8e4b0a9d22eb3bdf0#map" target="_blank" rel="noopener noreferrer"></a></p>
<h2>资料收集</h2>
<p>简书<a href="https://www.jianshu.com/p/9895e6434819" target="_blank" rel="noopener noreferrer"></a></p>
<p>英文Go博客收集<a href="https://draft.dev/learn/golang-blogs" target="_blank" rel="noopener noreferrer"></a></p>
]]></content:encoded>
    </item>
    <item>
      <title>Go语言推荐工具</title>
      <link>http://blog.cjhe.top/go-language/recommend/tool.html</link>
      <guid>http://blog.cjhe.top/go-language/recommend/tool.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go语言推荐工具</source>
      <description>提示 好的工具将解放我们的生产力！</description>
      <category>Go语言</category>
      <pubDate>Thu, 08 Sep 2022 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>好的工具将解放我们的生产力！</p>
</div>
<!-- more -->
<h2>工具</h2>
<p>|                             工具                             |                             功能                             |
| :</p>
]]></content:encoded>
    </item>
    <item>
      <title>Go安全指南</title>
      <link>http://blog.cjhe.top/go-language/reprint/tencent-secguide.html</link>
      <guid>http://blog.cjhe.top/go-language/reprint/tencent-secguide.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go安全指南</source>
      <description>【转】原文链接</description>
      <category>Go语言</category>
      <category>转载</category>
      <pubDate>Fri, 03 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>【转】<a href="https://github.com/Tencent/secguide" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->

<p>Go安全指南</p>
<h2>通用类</h2>
<h3>1.1 内存管理</h3>
<h4>1.1.1【必须】切片长度校验</h4>
<ul>
<li>在对slice进行操作时，必须判断长度是否合法，防止程序panic</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad: 未判断data的长度，可导致 index out of range</span>
<span class="token keyword">func</span> <span class="token function">decode</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'F'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'U'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'Z'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'Z'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'E'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'R'</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Bad"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token comment">// bad: slice bounds out of range</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> slice <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>slice<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// good: 使用data前应判断长度是否合法</span>
<span class="token keyword">func</span> <span class="token function">decode</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'F'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'U'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'Z'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'Z'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'E'</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'R'</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Good"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.1.2【必须】nil指针判断</h4>
<ul>
<li>进行指针操作时，必须判断该指针是否为nil，防止程序panic，尤其在进行结构体Unmarshal时</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Packet <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	PackeyType    <span class="token builtin">uint8</span>
	PackeyVersion <span class="token builtin">uint8</span>
	Data          <span class="token operator">*</span>Data
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Data <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Stat <span class="token builtin">uint8</span>
	Len  <span class="token builtin">uint8</span>
	Buf  <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Packet<span class="token punctuation">)</span> <span class="token function">UnmarshalBinary</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> io<span class="token punctuation">.</span>EOF
	<span class="token punctuation">}</span>

	p<span class="token punctuation">.</span>PackeyType <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	p<span class="token punctuation">.</span>PackeyVersion <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

	<span class="token comment">// 若长度等于2，那么不会new Data</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		p<span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// bad: 未判断指针是否为nil</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	packet <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Packet<span class="token punctuation">)</span>
	data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> packet<span class="token punctuation">.</span><span class="token function">UnmarshalBinary</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Failed to unmarshal packet"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Stat: %v\n"</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Stat<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// good: 判断Data指针是否为nil</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	packet <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Packet<span class="token punctuation">)</span>
	data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> packet<span class="token punctuation">.</span><span class="token function">UnmarshalBinary</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Failed to unmarshal packet"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> packet<span class="token punctuation">.</span>Data <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Stat: %v\n"</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Stat<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.1.3【必须】整数安全</h4>
<ul>
<li>
<p>在进行数字运算操作时，需要做好长度限制，防止外部输入运算导致异常：</p>
<ul>
<li>确保无符号整数运算时不会反转</li>
<li>确保有符号整数运算时不会出现溢出</li>
<li>确保整型转换时不会出现截断错误</li>
<li>确保整型转换时不会出现符号错误</li>
</ul>
</li>
<li>
<p>以下场景必须严格进行长度限制：</p>
<ul>
<li>作为数组索引</li>
<li>作为对象的长度或者大小</li>
<li>作为数组的边界（如作为循环计数器）</li>
</ul>
</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad: 未限制长度，导致整数溢出</span>
<span class="token keyword">func</span> <span class="token function">overflow</span><span class="token punctuation">(</span>numControlByUser <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> numInt <span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token number">0</span>
	numInt <span class="token operator">=</span> numControlByUser <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token comment">// 对长度限制不当，导致整数溢出</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> numInt<span class="token punctuation">)</span>
	<span class="token comment">// 使用numInt，可能导致其他错误</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">overflow</span><span class="token punctuation">(</span><span class="token number">2147483647</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// good</span>
<span class="token keyword">func</span> <span class="token function">overflow</span><span class="token punctuation">(</span>numControlByUser <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> numInt <span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token number">0</span>
	numInt <span class="token operator">=</span> numControlByUser <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">if</span> numInt <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"integer overflow"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"integer ok"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">overflow</span><span class="token punctuation">(</span><span class="token number">2147483647</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.1.4【必须】make分配长度验证</h4>
<ul>
<li>在进行make分配内存时，需要对外部可控的长度进行校验，防止程序panic。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad</span>
<span class="token keyword">func</span> <span class="token function">parse</span><span class="token punctuation">(</span>lenControlByUser <span class="token builtin">int</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	size <span class="token operator">:=</span> lenControlByUser
	<span class="token comment">// 对外部传入的size，进行长度判断以免导致panic</span>
	buffer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// good</span>
<span class="token keyword">func</span> <span class="token function">parse</span><span class="token punctuation">(</span>lenControlByUser <span class="token builtin">int</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	size <span class="token operator">:=</span> lenControlByUser
	<span class="token comment">// 限制外部可控的长度大小范围</span>
	<span class="token keyword">if</span> size <span class="token operator">&gt;</span> <span class="token number">64</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"value too large"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	buffer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
	<span class="token keyword">return</span> buffer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.1.5【必须】禁止SetFinalizer和指针循环引用同时使用</h4>
<ul>
<li>当一个对象从被GC选中到移除内存之前，runtime.SetFinalizer()都不会执行，即使程序正常结束或者发生错误。由指针构成的“循环引用”虽然能被GC正确处理，但由于无法确定Finalizer依赖顺序，从而无法调用runtime.SetFinalizer()，导致目标对象无法变成可达状态，从而造成内存无法被回收。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b Data
	a<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token operator">&amp;</span>b
	b<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token operator">&amp;</span>a

	<span class="token comment">// 指针循环引用，SetFinalizer()无法正常调用</span>
	runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>d <span class="token operator">*</span>Data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"a %p final.\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>d <span class="token operator">*</span>Data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"b %p final.\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4>1.1.6【必须】禁止重复释放channel</h4>
<ul>
<li>重复释放一般存在于异常流程判断中，如果恶意攻击者构造出异常条件使程序重复释放channel，则会触发运行时panic，从而造成DoS攻击。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>c <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> <span class="token function">processBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c <span class="token operator">&lt;-</span> <span class="token number">0</span>
		<span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// 重复释放channel</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c <span class="token operator">&lt;-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// good</span>
<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>c <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// 使用defer延迟关闭channel</span>
	err <span class="token operator">:=</span> <span class="token function">processBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c <span class="token operator">&lt;-</span> <span class="token number">0</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c <span class="token operator">&lt;-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.1.7【必须】确保每个协程都能退出</h4>
<ul>
<li>启动一个协程就会做一个入栈操作，在系统不退出的情况下，协程也没有设置退出条件，则相当于协程失去了控制，它占用的资源无法回收，可能会导致内存泄露。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad: 协程没有设置退出条件</span>
<span class="token keyword">func</span> <span class="token function">doWaiter</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> second <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">" is ready!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.1.8【推荐】不使用unsafe包</h4>
<ul>
<li>由于unsafe包绕过了 Golang 的内存安全原则，一般来说使用该库是不安全的，可导致内存破坏，尽量避免使用该包。若必须要使用unsafe操作指针，必须做好安全校验。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad: 通过unsafe操作原始指针</span>
<span class="token keyword">func</span> <span class="token function">unsafePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	foo <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0xfffffffe</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token operator">*</span>foo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// [signal SIGSEGV: segmentation violation code=0x1 addr=0xc100068f55 pc=0x49142b]</span>

</code></pre></div><h4>1.1.9【推荐】不使用slice作为函数入参</h4>
<ul>
<li>slice在作为函数入参时，函数内对slice的修改可能会影响原始数据</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>  <span class="token comment">// bad</span>
  <span class="token comment">// slice作为函数入参时包含原始数组指针</span>
  <span class="token keyword">func</span> <span class="token function">modify</span><span class="token punctuation">(</span>array <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">// 对入参slice的元素修改会影响原始数据</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      array <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
  
      <span class="token function">modify</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span> <span class="token comment">// output：[10 2 3 4 5]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// good</span>
  <span class="token comment">// 数组作为函数入参，而不是slice</span>
  <span class="token keyword">func</span> <span class="token function">modify</span><span class="token punctuation">(</span>array <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 传入数组，注意数组与slice的区别</span>
      array <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
  
      <span class="token function">modify</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
</code></pre></div><h3>1.2 文件操作</h3>
<h4>1.2.1【必须】 路径穿越检查</h4>
<ul>
<li>在进行文件操作时，如果对外部传入的文件名未做限制，可能导致任意文件读取或者任意文件写入，严重可能导致代码执行。</li>
</ul>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// bad: 任意文件读取</span>
<span class="token keyword">func</span> <span class="token function">handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	path <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

	<span class="token comment">// 未过滤文件路径，可能导致任意文件读取</span>
	data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

	<span class="token comment">// 对外部传入的文件名变量，还需要验证是否存在../等路径穿越的文件名</span>
	data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"/home/user/"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// bad: 任意文件写入</span>
<span class="token keyword">func</span> <span class="token function">unzip</span><span class="token punctuation">(</span>f <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zip<span class="token punctuation">.</span><span class="token function">OpenReader</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>File <span class="token punctuation">{</span>
		p<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token comment">// 未验证压缩文件名，可能导致../等路径穿越，任意文件路径写入</span>
		ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"present"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0640</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// good: 检查压缩的文件名是否包含..路径穿越特征字符，防止任意写入</span>
<span class="token keyword">func</span> <span class="token function">unzipGood</span><span class="token punctuation">(</span>f <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">,</span> err <span class="token operator">:=</span> zip<span class="token punctuation">.</span><span class="token function">OpenReader</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read zip file fail"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>File <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			p<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
			ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"present"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0640</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>1.2.2【必须】 文件访问权限</h4>
<ul>
<li>根据创建文件的敏感性设置不同级别的访问权限，以防止敏感数据被任意权限用户读取。例如，设置文件权限为：`-rw-r</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>Go语言编码规范</title>
      <link>http://blog.cjhe.top/go-language/reprint/uber-guide.html</link>
      <guid>http://blog.cjhe.top/go-language/reprint/uber-guide.html</guid>
      <source url="http://blog.cjhe.top/rss.xml">Go语言编码规范</source>
      <description>【转】原文链接</description>
      <category>Go语言</category>
      <category>转载</category>
      <pubDate>Sat, 04 Mar 2023 00:00:00 GMT</pubDate>
      <content:encoded><![CDATA[<p>【转】<a href="https://github.com/xxjwxc/uber_go_guide_cn" target="_blank" rel="noopener noreferrer">原文链接</a></p>
<!-- more -->
<p>Uber Go 语言编码规范</p>
<p><a href="https://www.uber.com/" target="_blank" rel="noopener noreferrer">Uber</a> 是一家美国硅谷的科技公司，也是 Go 语言的早期 adopter。其开源了很多 golang 项目，诸如被 Gopher 圈熟知的 <a href="https://github.com/uber-go/zap" target="_blank" rel="noopener noreferrer">zap</a>、<a href="https://github.com/jaegertracing/jaeger" target="_blank" rel="noopener noreferrer">jaeger</a> 等。2018 年年末 Uber 将内部的 <a href="https://github.com/uber-go/guide" target="_blank" rel="noopener noreferrer">Go 风格规范</a> 开源到 GitHub，经过一年的积累和更新，该规范已经初具规模，并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。</p>
<h2>版本</h2>
<ul>
<li>当前更新版本：2022-10-19 版本地址：<a href="https://github.com/uber-go/guide/commit/4478e672bddf9d4f7ca4a561ab0779e08e469577" target="_blank" rel="noopener noreferrer">commit:#158</a></li>
<li>如果您发现任何更新、问题或改进，请随时 fork 和 PR</li>
<li>Please feel free to fork and PR if you find any updates, issues or improvement.</li>
</ul>
<h2>目录</h2>
<ul>
<li><a href="#%E7%89%88%E6%9C%AC">版本</a></li>
<li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E4%BB%8B%E7%BB%8D">介绍</a></li>
<li><a href="#%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%99">指导原则</a>
<ul>
<li><a href="#%E6%8C%87%E5%90%91-interface-%E7%9A%84%E6%8C%87%E9%92%88">指向 interface 的指针</a></li>
<li><a href="#interface-%E5%90%88%E7%90%86%E6%80%A7%E9%AA%8C%E8%AF%81">Interface 合理性验证</a></li>
<li><a href="#%E6%8E%A5%E6%94%B6%E5%99%A8-receiver-%E4%B8%8E%E6%8E%A5%E5%8F%A3">接收器 (receiver) 与接口</a></li>
<li><a href="#%E9%9B%B6%E5%80%BC-mutex-%E6%98%AF%E6%9C%89%E6%95%88%E7%9A%84">零值 Mutex 是有效的</a></li>
<li><a href="#%E5%9C%A8%E8%BE%B9%E7%95%8C%E5%A4%84%E6%8B%B7%E8%B4%9D-slices-%E5%92%8C-maps">在边界处拷贝 Slices 和 Maps</a>
<ul>
<li><a href="#%E6%8E%A5%E6%94%B6-slices-%E5%92%8C-maps">接收 Slices 和 Maps</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E-slices-%E6%88%96-maps">返回 slices 或 maps</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8-defer-%E9%87%8A%E6%94%BE%E8%B5%84%E6%BA%90">使用 defer 释放资源</a></li>
<li><a href="#channel-%E7%9A%84-size-%E8%A6%81%E4%B9%88%E6%98%AF-1%E8%A6%81%E4%B9%88%E6%98%AF%E6%97%A0%E7%BC%93%E5%86%B2%E7%9A%84">Channel 的 size 要么是 1，要么是无缓冲的</a></li>
<li><a href="#%E6%9E%9A%E4%B8%BE%E4%BB%8E-1-%E5%BC%80%E5%A7%8B">枚举从 1 开始</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-time-%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4">使用 time 处理时间</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-timetime-%E8%A1%A8%E8%BE%BE%E7%9E%AC%E6%97%B6%E6%97%B6%E9%97%B4">使用 <code>time.Time</code> 表达瞬时时间</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-timeduration-%E8%A1%A8%E8%BE%BE%E6%97%B6%E9%97%B4%E6%AE%B5">使用 <code>time.Duration</code> 表达时间段</a></li>
<li><a href="#%E5%AF%B9%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8-timetime-%E5%92%8C-timeduration">对外部系统使用 <code>time.Time</code> 和 <code>time.Duration</code></a></li>
</ul>
</li>
<li><a href="#errors">Errors</a>
<ul>
<li><a href="#%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B">错误类型</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85">错误包装</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E5%91%BD%E5%90%8D">错误命名</a></li>
</ul>
</li>
<li><a href="#%E5%A4%84%E7%90%86%E6%96%AD%E8%A8%80%E5%A4%B1%E8%B4%A5">处理断言失败</a></li>
<li><a href="#%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8-panic">不要使用 panic</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-gouberorgatomic">使用 go.uber.org/atomic</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%8F%AF%E5%8F%98%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">避免可变全局变量</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%9C%A8%E5%85%AC%E5%85%B1%E7%BB%93%E6%9E%84%E4%B8%AD%E5%B5%8C%E5%85%A5%E7%B1%BB%E5%9E%8B">避免在公共结构中嵌入类型</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E5%86%85%E7%BD%AE%E5%90%8D%E7%A7%B0">避免使用内置名称</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-init">避免使用 <code>init()</code></a></li>
<li><a href="#%E8%BF%BD%E5%8A%A0%E6%97%B6%E4%BC%98%E5%85%88%E6%8C%87%E5%AE%9A%E5%88%87%E7%89%87%E5%AE%B9%E9%87%8F">追加时优先指定切片容量</a></li>
<li><a href="#%E4%B8%BB%E5%87%BD%E6%95%B0%E9%80%80%E5%87%BA%E6%96%B9%E5%BC%8F-exit">主函数退出方式 (Exit)</a>
<ul>
<li><a href="#%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%80%E5%87%BA">一次性退出</a></li>
</ul>
</li>
<li><a href="#%E5%9C%A8%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%93%E6%9E%84%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A0%87%E8%AE%B0">在序列化结构中使用字段标记</a></li>
<li><a href="#%E4%B8%8D%E8%A6%81%E4%B8%80%E5%8A%B3%E6%B0%B8%E9%80%B8%E5%9C%B0%E4%BD%BF%E7%94%A8-goroutine">不要一劳永逸地使用 goroutine</a>
<ul>
<li><a href="#%E7%AD%89%E5%BE%85-goroutines-%E9%80%80%E5%87%BA">等待 goroutines 退出</a></li>
<li><a href="#%E4%B8%8D%E8%A6%81%E5%9C%A8-init-%E4%BD%BF%E7%94%A8-goroutines">不要在 <code>init()</code> 使用 goroutines</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%80%A7%E8%83%BD">性能</a>
<ul>
<li><a href="#%E4%BC%98%E5%85%88%E4%BD%BF%E7%94%A8-strconv-%E8%80%8C%E4%B8%8D%E6%98%AF-fmt">优先使用 strconv 而不是 fmt</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%B0%E5%AD%97%E8%8A%82%E7%9A%84%E8%BD%AC%E6%8D%A2">避免字符串到字节的转换</a></li>
<li><a href="#%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8%E5%AE%B9%E9%87%8F">指定容器容量</a>
<ul>
<li><a href="#%E6%8C%87%E5%AE%9Amap%E5%AE%B9%E9%87%8F%E6%8F%90%E7%A4%BA">指定Map容量提示</a></li>
<li><a href="#%E6%8C%87%E5%AE%9A%E5%88%87%E7%89%87%E5%AE%B9%E9%87%8F">指定切片容量</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%A7%84%E8%8C%83">规范</a>
<ul>
<li><a href="#%E9%81%BF%E5%85%8D%E8%BF%87%E9%95%BF%E7%9A%84%E8%A1%8C">避免过长的行</a></li>
<li><a href="#%E4%B8%80%E8%87%B4%E6%80%A7">一致性</a></li>
<li><a href="#%E7%9B%B8%E4%BC%BC%E7%9A%84%E5%A3%B0%E6%98%8E%E6%94%BE%E5%9C%A8%E4%B8%80%E7%BB%84">相似的声明放在一组</a></li>
<li><a href="#import-%E5%88%86%E7%BB%84">import 分组</a></li>
<li><a href="#%E5%8C%85%E5%90%8D">包名</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E5%90%8D">函数名</a></li>
<li><a href="#%E5%AF%BC%E5%85%A5%E5%88%AB%E5%90%8D">导入别名</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E5%88%86%E7%BB%84%E4%B8%8E%E9%A1%BA%E5%BA%8F">函数分组与顺序</a></li>
<li><a href="#%E5%87%8F%E5%B0%91%E5%B5%8C%E5%A5%97">减少嵌套</a></li>
<li><a href="#%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84-else">不必要的 else</a></li>
<li><a href="#%E9%A1%B6%E5%B1%82%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">顶层变量声明</a></li>
<li><a href="#%E5%AF%B9%E4%BA%8E%E6%9C%AA%E5%AF%BC%E5%87%BA%E7%9A%84%E9%A1%B6%E5%B1%82%E5%B8%B8%E9%87%8F%E5%92%8C%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8_%E4%BD%9C%E4%B8%BA%E5%89%8D%E7%BC%80">对于未导出的顶层常量和变量，使用_作为前缀</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E7%9A%84%E5%B5%8C%E5%85%A5">结构体中的嵌入</a></li>
<li><a href="#%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">本地变量声明</a></li>
<li><a href="#nil-%E6%98%AF%E4%B8%80%E4%B8%AA%E6%9C%89%E6%95%88%E7%9A%84-slice">nil 是一个有效的 slice</a></li>
<li><a href="#%E7%BC%A9%E5%B0%8F%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F">缩小变量作用域</a></li>
<li><a href="#%E9%81%BF%E5%85%8D%E5%8F%82%E6%95%B0%E8%AF%AD%E4%B9%89%E4%B8%8D%E6%98%8E%E7%A1%AE-avoid-naked-parameters">避免参数语义不明确 (Avoid Naked Parameters)</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%A7%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E5%80%BC%E9%81%BF%E5%85%8D%E8%BD%AC%E4%B9%89">使用原始字符串字面值，避免转义</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%84%E4%BD%93">初始化结构体</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E5%90%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%84">使用字段名初始化结构</a></li>
<li><a href="#%E7%9C%81%E7%95%A5%E7%BB%93%E6%9E%84%E4%B8%AD%E7%9A%84%E9%9B%B6%E5%80%BC%E5%AD%97%E6%AE%B5">省略结构中的零值字段</a></li>
<li><a href="#%E5%AF%B9%E9%9B%B6%E5%80%BC%E7%BB%93%E6%9E%84%E4%BD%BF%E7%94%A8-var">对零值结构使用 <code>var</code></a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-struct-%E5%BC%95%E7%94%A8">初始化 Struct 引用</a></li>
</ul>
</li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-maps">初始化 Maps</a></li>
<li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2-string-format">字符串 string format</a></li>
<li><a href="#%E5%91%BD%E5%90%8D-printf-%E6%A0%B7%E5%BC%8F%E7%9A%84%E5%87%BD%E6%95%B0">命名 Printf 样式的函数</a></li>
</ul>
</li>
<li><a href="#%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F">编程模式</a>
<ul>
<li><a href="#%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95">表驱动测试</a></li>
<li><a href="#%E5%8A%9F%E8%83%BD%E9%80%89%E9%A1%B9">功能选项</a></li>
</ul>
</li>
<li><a href="#linting">Linting</a>
<ul>
<li><a href="#lint-runners">Lint Runners</a></li>
</ul>
</li>
<li><a href="#stargazers-over-time">Stargazers over time</a></li>
</ul>
<h2>介绍</h2>
<p>样式 (style) 是支配我们代码的惯例。术语<code>样式</code>有点用词不当，因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。</p>
<p>本指南的目的是通过详细描述在 Uber 编写 Go 代码的注意事项来管理这种复杂性。这些规则的存在是为了使代码库易于管理，同时仍然允许工程师更有效地使用 Go 语言功能。</p>
<p>该指南最初由 <a href="https://github.com/prashantv" target="_blank" rel="noopener noreferrer">Prashant Varanasi</a> 和 <a href="https://github.com/nomis52" target="_blank" rel="noopener noreferrer">Simon Newton</a> 编写，目的是使一些同事能快速使用 Go。多年来，该指南已根据其他人的反馈进行了修改。</p>
<p>本文档记录了我们在 Uber 遵循的 Go 代码中的惯用约定。其中许多是 Go 的通用准则，而其他扩展准则依赖于下面外部的指南：</p>
<ol>
<li><a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener noreferrer">Effective Go</a></li>
<li><a href="https://github.com/golang/go/wiki/CommonMistakes" target="_blank" rel="noopener noreferrer">Go Common Mistakes</a></li>
<li><a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener noreferrer">Go Code Review Comments</a></li>
</ol>
<p>我们的目标是使代码示例能够准确地用于Go的两个发布版本 <a href="https://go.dev/doc/devel/release" target="_blank" rel="noopener noreferrer">releases</a>.</p>
<p>所有代码都应该通过<code>golint</code>和<code>go vet</code>的检查并无错误。我们建议您将编辑器设置为：</p>
<ul>
<li>保存时运行 <code>goimports</code></li>
<li>运行 <code>golint</code> 和 <code>go vet</code> 检查错误</li>
</ul>
<p>您可以在以下 Go 编辑器工具支持页面中找到更为详细的信息：
<a href="https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins" target="_blank" rel="noopener noreferrer">https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins</a></p>
<h2>指导原则</h2>
<h3>指向 interface 的指针</h3>
<p>您几乎不需要指向接口类型的指针。您应该将接口作为值进行传递，在这样的传递过程中，实质上传递的底层数据仍然可以是指针。</p>
<p>接口实质上在底层用两个字段表示：</p>
<ol>
<li>一个指向某些特定类型信息的指针。您可以将其视为"type"。</li>
<li>数据指针。如果存储的数据是指针，则直接存储。如果存储的数据是一个值，则存储指向该值的指针。</li>
</ol>
<p>如果希望接口方法修改基础数据，则必须使用指针传递 (将对象指针赋值给接口变量)。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> F <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> S1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s S1<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> S2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>S2<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// f1.f() 无法修改底层数据</span>
<span class="token comment">// f2.f() 可以修改底层数据，给接口变量 f2 赋值时使用的是对象指针</span>
<span class="token keyword">var</span> f1 F <span class="token operator">=</span> S1<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> f2 F <span class="token operator">=</span> <span class="token operator">&amp;</span>S2<span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3>Interface 合理性验证</h3>
<p>在编译时验证接口的符合性。这包括：</p>
<ul>
<li>将实现特定接口的导出类型作为接口 API 的一部分进行检查</li>
<li>实现同一接口的 (导出和非导出) 类型属于实现类型的集合</li>
<li>任何违反接口合理性检查的场景，都会终止编译，并通知给用户</li>
</ul>
<p>补充：上面 3 条是编译器对接口的检查机制，
大体意思是错误使用接口会在编译期报错。
所以可以利用这个机制让部分问题在编译期暴露。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// 如果 Handler 没有实现 http.Handler，会在运行时报错</span>
<span class="token keyword">type</span> Handler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>Handler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>
  w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span>
  r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Handler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 用于触发编译期的接口的合理性检查机制</span>
<span class="token comment">// 如果 Handler 没有实现 http.Handler，会在编译期报错</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> http<span class="token punctuation">.</span>Handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>Handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>Handler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>
  w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span>
  r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div></td></tr>
</tbody></table>
<p>如果 <code>*Handler</code> 与 <code>http.Handler</code> 的接口不匹配，
那么语句 <code>var _ http.Handler = (*Handler)(nil)</code> 将无法编译通过。</p>
<p>赋值的右边应该是断言类型的零值。
对于指针类型（如 <code>*Handler</code>）、切片和映射，这是 <code>nil</code>；
对于结构类型，这是空结构。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> LogHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  h   http<span class="token punctuation">.</span>Handler
  log <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> http<span class="token punctuation">.</span>Handler <span class="token operator">=</span> LogHandler<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h LogHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>
  w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span>
  r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>接收器 (receiver) 与接口</h3>
<p>使用值接收器的方法既可以通过值调用，也可以通过指针调用。</p>
<p>带指针接收器的方法只能通过指针或 <a href="https://golang.org/ref/spec#Method_values" target="_blank" rel="noopener noreferrer">addressable values</a> 调用。</p>
<p>例如，</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  data <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s S<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> s<span class="token punctuation">.</span>data
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>S<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  s<span class="token punctuation">.</span>data <span class="token operator">=</span> str
<span class="token punctuation">}</span>

sVals <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>S<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"A"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">// 你通过值只能调用 Read</span>
sVals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 这不能编译通过：</span>
<span class="token comment">//  sVals[1].Write("test")</span>

sPtrs <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span>S<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"A"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">// 通过指针既可以调用 Read，也可以调用 Write 方法</span>
sPtrs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sPtrs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
</code></pre></div><p>类似的，即使方法有了值接收器，也同样可以用指针接收器来满足接口。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> F <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> S1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s S1<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> S2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>S2<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

s1Val <span class="token operator">:=</span> S1<span class="token punctuation">{</span><span class="token punctuation">}</span>
s1Ptr <span class="token operator">:=</span> <span class="token operator">&amp;</span>S1<span class="token punctuation">{</span><span class="token punctuation">}</span>
s2Val <span class="token operator">:=</span> S2<span class="token punctuation">{</span><span class="token punctuation">}</span>
s2Ptr <span class="token operator">:=</span> <span class="token operator">&amp;</span>S2<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> i F
i <span class="token operator">=</span> s1Val
i <span class="token operator">=</span> s1Ptr
i <span class="token operator">=</span> s2Ptr

<span class="token comment">//  下面代码无法通过编译。因为 s2Val 是一个值，而 S2 的 f 方法中没有使用值接收器</span>
<span class="token comment">//   i = s2Val</span>
</code></pre></div><p><a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener noreferrer">Effective Go</a> 中有一段关于 <a href="https://golang.org/doc/effective_go.html#pointers_vs_values" target="_blank" rel="noopener noreferrer">pointers vs. values</a> 的精彩讲解。</p>
<p>补充：</p>
<ul>
<li>一个类型可以有值接收器方法集和指针接收器方法集
<ul>
<li>值接收器方法集是指针接收器方法集的子集，反之不是</li>
</ul>
</li>
<li>规则
<ul>
<li>值对象只可以使用值接收器方法集</li>
<li>指针对象可以使用 值接收器方法集 + 指针接收器方法集</li>
</ul>
</li>
<li>接口的匹配 (或者叫实现)
<ul>
<li>类型实现了接口的所有方法，叫匹配</li>
<li>具体的讲，要么是类型的值方法集匹配接口，要么是指针方法集匹配接口</li>
</ul>
</li>
</ul>
<p>具体的匹配分两种：</p>
<ul>
<li>值方法集和接口匹配
<ul>
<li>给接口变量赋值的不管是值还是指针对象，都 ok，因为都包含值方法集</li>
</ul>
</li>
<li>指针方法集和接口匹配
<ul>
<li>只能将指针对象赋值给接口变量，因为只有指针方法集和接口匹配</li>
<li>如果将值对象赋值给接口变量，会在编译期报错 (会触发接口合理性检查机制)</li>
</ul>
</li>
</ul>
<p>为啥 i = s2Val 会报错，因为值方法集和接口不匹配。</p>
<h3>零值 Mutex 是有效的</h3>
<p>零值 <code>sync.Mutex</code> 和 <code>sync.RWMutex</code> 是有效的。所以指向 mutex 的指针基本是不必要的。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>mu <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span>
mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex
mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></td></tr>
</tbody></table>
<p>如果你使用结构体指针，mutex 应该作为结构体的非指针字段。即使该结构体不被导出，也不要直接把 mutex 嵌入到结构体中。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> SMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  sync<span class="token punctuation">.</span>Mutex

  data <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>SMap <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>SMap<span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SMap<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> m<span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> SMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  mu sync<span class="token punctuation">.</span>Mutex

  data <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>SMap <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&amp;</span>SMap<span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SMap<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> m<span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></td></tr>
<tr><td>
<p><code>Mutex</code> 字段， <code>Lock</code> 和 <code>Unlock</code> 方法是 <code>SMap</code> 导出的 API 中不刻意说明的一部分。</p>
 </td><td>
<p>mutex 及其方法是 <code>SMap</code> 的实现细节，对其调用者不可见。</p>
 </td></tr>
 </tbody></table>
<h3>在边界处拷贝 Slices 和 Maps</h3>
<p>slices 和 maps 包含了指向底层数据的指针，因此在需要复制它们时要特别注意。</p>
<h4>接收 Slices 和 Maps</h4>
<p>请记住，当 map 或 slice 作为函数参数传入时，如果您存储了对它们的引用，则用户可以对其进行修改。</p>
<table>
<thead><tr><th>Bad</th> <th>Good</th></tr></thead>
<tbody>
<tr>
<td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Driver<span class="token punctuation">)</span> <span class="token function">SetTrips</span><span class="token punctuation">(</span>trips <span class="token punctuation">[</span><span class="token punctuation">]</span>Trip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  d<span class="token punctuation">.</span>trips <span class="token operator">=</span> trips
<span class="token punctuation">}</span>

trips <span class="token operator">:=</span> <span class="token operator">...</span>
d1<span class="token punctuation">.</span><span class="token function">SetTrips</span><span class="token punctuation">(</span>trips<span class="token punctuation">)</span>

<span class="token comment">// 你是要修改 d1.trips 吗？</span>
trips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">...</span>
</code></pre></div></td>
<td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Driver<span class="token punctuation">)</span> <span class="token function">SetTrips</span><span class="token punctuation">(</span>trips <span class="token punctuation">[</span><span class="token punctuation">]</span>Trip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  d<span class="token punctuation">.</span>trips <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Trip<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>trips<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">copy</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>trips<span class="token punctuation">,</span> trips<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

trips <span class="token operator">:=</span> <span class="token operator">...</span>
d1<span class="token punctuation">.</span><span class="token function">SetTrips</span><span class="token punctuation">(</span>trips<span class="token punctuation">)</span>

<span class="token comment">// 这里我们修改 trips[0]，但不会影响到 d1.trips</span>
trips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">...</span>
</code></pre></div></td>
</tr>
</tbody>
</table>
<h4>返回 slices 或 maps</h4>
<p>同样，请注意用户对暴露内部状态的 map 或 slice 的修改。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Stats <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  mu sync<span class="token punctuation">.</span>Mutex

  counters <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token comment">// Snapshot 返回当前状态。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Stats<span class="token punctuation">)</span> <span class="token function">Snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
  s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> s<span class="token punctuation">.</span>counters
<span class="token punctuation">}</span>

<span class="token comment">// snapshot 不再受互斥锁保护</span>
<span class="token comment">// 因此对 snapshot 的任何访问都将受到数据竞争的影响</span>
<span class="token comment">// 影响 stats.counters</span>
snapshot <span class="token operator">:=</span> stats<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Stats <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  mu sync<span class="token punctuation">.</span>Mutex

  counters <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Stats<span class="token punctuation">)</span> <span class="token function">Snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
  s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>counters<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>counters <span class="token punctuation">{</span>
    result<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// snapshot 现在是一个拷贝</span>
snapshot <span class="token operator">:=</span> stats<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></td></tr>
</tbody></table>
<h3>使用 defer 释放资源</h3>
<p>使用 defer 释放资源，诸如文件和锁。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>p<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> p<span class="token punctuation">.</span>count <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
  p<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> p<span class="token punctuation">.</span>count
<span class="token punctuation">}</span>

p<span class="token punctuation">.</span>count<span class="token operator">++</span>
newCount <span class="token operator">:=</span> p<span class="token punctuation">.</span>count
p<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">return</span> newCount

<span class="token comment">// 当有多个 return 分支时，很容易遗忘 unlock</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>p<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">defer</span> p<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> p<span class="token punctuation">.</span>count <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> p<span class="token punctuation">.</span>count
<span class="token punctuation">}</span>

p<span class="token punctuation">.</span>count<span class="token operator">++</span>
<span class="token keyword">return</span> p<span class="token punctuation">.</span>count

<span class="token comment">// 更可读</span>
</code></pre></div></td></tr>
</tbody></table>
<p>Defer 的开销非常小，只有在您可以证明函数执行时间处于纳秒级的程度时，才应避免这样做。使用 defer 提升可读性是值得的，因为使用它们的成本微不足道。尤其适用于那些不仅仅是简单内存访问的较大的方法，在这些方法中其他计算的资源消耗远超过 <code>defer</code>。</p>
<h3>Channel 的 size 要么是 1，要么是无缓冲的</h3>
<p>channel 通常 size 应为 1 或是无缓冲的。默认情况下，channel 是无缓冲的，其 size 为零。任何其他尺寸都必须经过严格的审查。我们需要考虑如何确定大小，考虑是什么阻止了 channel 在高负载下和阻塞写时的写入，以及当这种情况发生时系统逻辑有哪些变化。(翻译解释：按照原文意思是需要界定通道边界，竞态条件，以及逻辑上下文梳理)</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// 应该足以满足任何情况！</span>
c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// 大小：1</span>
c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 或者</span>
<span class="token comment">// 无缓冲 channel，大小为 0</span>
c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre></div></td></tr>
</tbody></table>
<h3>枚举从 1 开始</h3>
<p>在 Go 中引入枚举的标准方法是声明一个自定义类型和一个使用了 iota 的 const 组。由于变量的默认值为 0，因此通常应以非零值开头枚举。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Operation <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  Add Operation <span class="token operator">=</span> <span class="token boolean">iota</span>
  Subtract
  Multiply
<span class="token punctuation">)</span>

<span class="token comment">// Add=0, Subtract=1, Multiply=2</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> Operation <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  Add Operation <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span>
  Subtract
  Multiply
<span class="token punctuation">)</span>

<span class="token comment">// Add=1, Subtract=2, Multiply=3</span>
</code></pre></div></td></tr>
</tbody></table>
<p>在某些情况下，使用零值是有意义的（枚举从零开始），例如，当零值是理想的默认行为时。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">type</span> LogOutput <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  LogToStdout LogOutput <span class="token operator">=</span> <span class="token boolean">iota</span>
  LogToFile
  LogToRemote
<span class="token punctuation">)</span>

<span class="token comment">// LogToStdout=0, LogToFile=1, LogToRemote=2</span>
</code></pre></div><h3>使用 time 处理时间</h3>
<p>时间处理很复杂。关于时间的错误假设通常包括以下几点。</p>
<ol>
<li>一天有 24 小时</li>
<li>一小时有 60 分钟</li>
<li>一周有七天</li>
<li>一年 365 天</li>
<li><a href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time" target="_blank" rel="noopener noreferrer">还有更多</a></li>
</ol>
<p>例如，<em>1</em> 表示在一个时间点上加上 24 小时并不总是产生一个新的日历日。</p>
<p>因此，在处理时间时始终使用 <a href="https://golang.org/pkg/time/" target="_blank" rel="noopener noreferrer"><code>"time"</code></a> 包，因为它有助于以更安全、更准确的方式处理这些不正确的假设。</p>
<h4>使用 <code>time.Time</code> 表达瞬时时间</h4>
<p>在处理时间的瞬间时使用 <a href="https://golang.org/pkg/time/#Time" target="_blank" rel="noopener noreferrer"><code>time.Time</code></a>，在比较、添加或减去时间时使用 <code>time.Time</code> 中的方法。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">isActive</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> start<span class="token punctuation">,</span> stop <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> start <span class="token operator">&lt;=</span> now <span class="token operator">&amp;&amp;</span> now <span class="token operator">&lt;</span> stop
<span class="token punctuation">}</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">isActive</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> start<span class="token punctuation">,</span> stop time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>start<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">||</span> start<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> now<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></td></tr>
</tbody></table>
<h4>使用 <code>time.Duration</code> 表达时间段</h4>
<p>在处理时间段时使用 <a href="https://golang.org/pkg/time/#Duration" target="_blank" rel="noopener noreferrer"><code>time.Duration</code></a> .</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">poll</span><span class="token punctuation">(</span>delay <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 是几秒钟还是几毫秒？</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">poll</span><span class="token punctuation">(</span>delay time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</code></pre></div></td></tr>
</tbody></table>
<p>回到第一个例子，在一个时间瞬间加上 24 小时，我们用于添加时间的方法取决于意图。如果我们想要下一个日历日 (当前天的下一天) 的同一个时间点，我们应该使用 <a href="https://golang.org/pkg/time/#Time.AddDate" target="_blank" rel="noopener noreferrer"><code>Time.AddDate</code></a>。但是，如果我们想保证某一时刻比前一时刻晚 24 小时，我们应该使用 <a href="https://golang.org/pkg/time/#Time.Add" target="_blank" rel="noopener noreferrer"><code>Time.Add</code></a>。</p>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code>newDay <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">AddDate</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token comment">/* years */</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* months */</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* days */</span><span class="token punctuation">)</span>
maybeNewDay <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
</code></pre></div><h4>对外部系统使用 <code>time.Time</code> 和 <code>time.Duration</code></h4>
<p>尽可能在与外部系统的交互中使用 <code>time.Duration</code> 和 <code>time.Time</code> 例如 :</p>
<ul>
<li>
<p>Command-line 标志: <a href="https://golang.org/pkg/flag/" target="_blank" rel="noopener noreferrer"><code>flag</code></a> 通过 <a href="https://golang.org/pkg/time/#ParseDuration" target="_blank" rel="noopener noreferrer"><code>time.ParseDuration</code></a> 支持 <code>time.Duration</code></p>
</li>
<li>
<p>JSON: <a href="https://golang.org/pkg/encoding/json/" target="_blank" rel="noopener noreferrer"><code>encoding/json</code></a> 通过其 <a href="https://golang.org/pkg/time/#Time.UnmarshalJSON" target="_blank" rel="noopener noreferrer"><code>UnmarshalJSON</code> method</a> 方法支持将 <code>time.Time</code> 编码为 <a href="https://tools.ietf.org/html/rfc3339" target="_blank" rel="noopener noreferrer">RFC 3339</a> 字符串</p>
</li>
<li>
<p>SQL: <a href="https://golang.org/pkg/database/sql/" target="_blank" rel="noopener noreferrer"><code>database/sql</code></a> 支持将 <code>DATETIME</code> 或 <code>TIMESTAMP</code> 列转换为 <code>time.Time</code>，如果底层驱动程序支持则返回</p>
</li>
<li>
<p>YAML: <a href="https://godoc.org/gopkg.in/yaml.v2" target="_blank" rel="noopener noreferrer"><code>gopkg.in/yaml.v2</code></a> 支持将 <code>time.Time</code> 作为 <a href="https://tools.ietf.org/html/rfc3339" target="_blank" rel="noopener noreferrer">RFC 3339</a> 字符串，并通过 <a href="https://golang.org/pkg/time/#ParseDuration" target="_blank" rel="noopener noreferrer"><code>time.ParseDuration</code></a> 支持 <code>time.Duration</code>。</p>
</li>
</ul>
<p>当不能在这些交互中使用 <code>time.Duration</code> 时，请使用 <code>int</code> 或 <code>float64</code>，并在字段名称中包含单位。</p>
<p>例如，由于 <code>encoding/json</code> 不支持 <code>time.Duration</code>，因此该单位包含在字段的名称中。</p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// {"interval": 2}</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Interval <span class="token builtin">int</span> <span class="token string">`json:"interval"`</span>
<span class="token punctuation">}</span>
</code></pre></div></td><td>
<div class="language-go" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// {"intervalMillis": 2000}</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  IntervalMillis <span class="token builtin">int</span> <span class="token string">`json:"intervalMillis"`</span>
<span class="token punctuation">}</span>
</code></pre></div></td></tr>
</tbody></table>
<p>当在这些交互中不能使用 <code>time.Time</code> 时，除非达成一致，否则使用 <code>string</code> 和 <a href="https://tools.ietf.org/html/rfc3339" target="_blank" rel="noopener noreferrer">RFC 3339</a> 中定义的格式时间戳。默认情况下，<a href="https://golang.org/pkg/time/#Time.UnmarshalText" target="_blank" rel="noopener noreferrer"><code>Time.UnmarshalText</code></a> 使用此格式，并可通过 <a href="https://golang.org/pkg/time/#RFC3339" target="_blank" rel="noopener noreferrer"><code>time.RFC3339</code></a> 在 <code>Time.Format</code> 和 <code>time.Parse</code> 中使用。</p>
<p>尽管这在实践中并不成问题，但请记住，<code>"time"</code> 包不支持解析闰秒时间戳（<a href="https://github.com/golang/go/issues/8728" target="_blank" rel="noopener noreferrer">8728</a>），也不在计算中考虑闰秒（<a href="https://github.com/golang/go/issues/15190" target="_blank" rel="noopener noreferrer">15190</a>）。如果您比较两个时间瞬间，则差异将不包括这两个瞬间之间可能发生的闰秒。</p>
<!-- TODO: section on String methods for enums -->
<h3>Errors</h3>
<h4>错误类型</h4>
<p>声明错误的选项很少。
在选择最适合您的用例的选项之前，请考虑以下事项。</p>
<ul>
<li>调用者是否需要匹配错误以便他们可以处理它？
如果是，我们必须通过声明顶级错误变量或自定义类型来支持 <a href="https://golang.org/pkg/errors/#Is" target="_blank" rel="noopener noreferrer"><code>errors.Is</code></a> 或 <a href="https://golang.org/pkg/errors/#As" target="_blank" rel="noopener noreferrer"><code>errors.As</code></a> 函数。</li>
<li>错误消息是否为静态字符串，还是需要上下文信息的动态字符串？
如果是静态字符串，我们可以使用 [<code>errors.New</code>]，但对于后者，我们必须使用 [<code>fmt.Errorf</code>] 或自定义错误类型。</li>
<li>我们是否正在传递由下游函数返回的新错误？
如果是这样，请参阅<a href="#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85">错误包装部分</a>。</li>
</ul>
<p>| 错误匹配？ | 错误消息 | 指导                                |
|</p>
]]></content:encoded>
      <enclosure url="https://starchart.cc/xxjwxc/uber_go_guide_cn.svg" type="image/svg+xml"/>
    </item>
  </channel>
</rss>